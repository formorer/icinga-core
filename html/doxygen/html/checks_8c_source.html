<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Icinga-core: base/checks.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="icinga_logo4-300x109.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Icinga-core&#160;<span id="projectnumber">1.4.0</span></div>
   <div id="projectbrief">next gen monitoring</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('checks_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">base/checks.c</div>  </div>
</div>
<div class="contents">
<a href="checks_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*****************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> *</span>
<a name="l00003"></a>00003 <span class="comment"> * CHECKS.C - Service and host check functions for Icinga</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * Copyright (c) 1999-2010 Ethan Galstad (egalstad@nagios.org)</span>
<a name="l00006"></a>00006 <span class="comment"> * Copyright (c) 2009-2011 Nagios Core Development Team and Community Contributors</span>
<a name="l00007"></a>00007 <span class="comment"> * Copyright (c) 2009-2011 Icinga Development Team (http://www.icinga.org)</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * License:</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00012"></a>00012 <span class="comment"> * it under the terms of the GNU General Public License version 2 as</span>
<a name="l00013"></a>00013 <span class="comment"> * published by the Free Software Foundation.</span>
<a name="l00014"></a>00014 <span class="comment"> *</span>
<a name="l00015"></a>00015 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00016"></a>00016 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00017"></a>00017 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00018"></a>00018 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00021"></a>00021 <span class="comment"> * along with this program; if not, write to the Free Software</span>
<a name="l00022"></a>00022 <span class="comment"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> *****************************************************************************/</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;../include/config.h&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;../include/comments.h&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;../include/common.h&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;../include/statusdata.h&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;../include/downtime.h&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;../include/macros.h&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;../include/icinga.h&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;../include/broker.h&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;../include/perfdata.h&quot;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="comment">/*#define DEBUG_CHECKS*/</span>
<a name="l00037"></a>00037 <span class="comment">/*#define DEBUG_HOST_CHECKS 1*/</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#ifdef EMBEDDEDPERL</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span><span class="preprocessor">#include &quot;../include/epn_icinga.h&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#endif</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span>
<a name="l00044"></a>00044 <span class="preprocessor">#ifdef USE_EVENT_BROKER</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span><span class="preprocessor">#include &quot;../include/neberrors.h&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#endif</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span>
<a name="l00048"></a>00048 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a2b5f7762caad7a548645f2d9c4cdee47">sigshutdown</a>;
<a name="l00049"></a>00049 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#aadf2eea990498582cc7dac355c3d7e71">sigrestart</a>;
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="checks_8c.html#af9f03269d81f06c6a86926e77620eed4">temp_file</a>;
<a name="l00052"></a>00052 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="checks_8c.html#ac633a7a52422f2b1d56ed02a56dc8fcf">temp_path</a>;
<a name="l00053"></a>00053 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="checks_8c.html#a3964b0cff6f7740b1f35a62ba0ef0d6a">check_result_path</a>;
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>;
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a7efed83b6f6698f73e4ede444065917c">command_check_interval</a>;
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a978adb7bd99819db24cb71610e211201">log_initial_states</a>;
<a name="l00060"></a>00060 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a5e7d59bfd5de9be3ca0ab421999029ef">log_passive_checks</a>;
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#aae037924192ae115d84c3aa5c42502db">service_check_timeout</a>;
<a name="l00063"></a>00063 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a57a8709265e39d9953db6dd65bfc0796">host_check_timeout</a>;
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#af5316c1b7ca4d4261fb4edc45cafcca2">check_reaper_interval</a>;
<a name="l00066"></a>00066 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#aec4c41d4a0f2abb5ccb88695fa1a7afd">max_check_reaper_time</a>;
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a8f8fcb1a4bb32b1c5fa753ac9cb48578">use_aggressive_host_checking</a>;
<a name="l00069"></a>00069 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="checks_8c.html#a55fd26f1da3fea26b41e92a035472ea2">cached_host_check_horizon</a>;
<a name="l00070"></a>00070 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="checks_8c.html#a63020ec01859a9c631414e69dd951b5d">cached_service_check_horizon</a>;
<a name="l00071"></a>00071 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#ad658f0152df44d67fd5fe012fc1faf3f">enable_predictive_host_dependency_checks</a>;
<a name="l00072"></a>00072 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#afb630146760296e213a019a7f14f48f3">enable_predictive_service_dependency_checks</a>;
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a7c9ecd6259817de56ca91f1adaaea842">soft_state_dependencies</a>;
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a01f1a65871aff67ece2c26f543691083">currently_running_service_checks</a>;
<a name="l00077"></a>00077 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a546436c5e70468c98d7b4a7f335a170b">currently_running_host_checks</a>;
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="broker_8c.html#ac2cfe61062d4e6db6236a829ee16864a">accept_passive_service_checks</a>;
<a name="l00080"></a>00080 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="broker_8c.html#ab7c771c65ac24bc0d04ddae988128f8a">execute_service_checks</a>;
<a name="l00081"></a>00081 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="broker_8c.html#a1f08a9399cbf8d1781f7921cb39ad461">accept_passive_host_checks</a>;
<a name="l00082"></a>00082 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="broker_8c.html#af4ed1772a5decb43a2711b6d560a0737">execute_host_checks</a>;
<a name="l00083"></a>00083 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="broker_8c.html#a03e994eebc8f1e065991e7f8994a7059">obsess_over_services</a>;
<a name="l00084"></a>00084 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="broker_8c.html#a879982dc6cb9e3e1e23c49eba4f7bc12">obsess_over_hosts</a>;
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#aeef0f20f58de2ac8a2db469fdc767b6f">translate_passive_host_checks</a>;
<a name="l00087"></a>00087 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a90011bddac350082a4ab3b13758afcbe">passive_host_checks_are_soft</a>;
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a2361e9b42a0ea220db317dff75dc9dc0">check_service_freshness</a>;
<a name="l00090"></a>00090 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a4f92c0b0b8d9f56191bcdf5dc5a706b2">check_host_freshness</a>;
<a name="l00091"></a>00091 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#ab5dcf3b2f001760548fd0d0fab5c2cd7">additional_freshness_latency</a>;
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a6c91e39bfb52d983e8a77a70698f147e">max_host_check_spread</a>;
<a name="l00094"></a>00094 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a13c7e7d13d812c96e312c5f7ee893a66">max_service_check_spread</a>;
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#af7ebc1e3e652fbcaed250840df2ccba2">use_large_installation_tweaks</a>;
<a name="l00097"></a>00097 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a73881c51ba02b6ea241ab71a8e2c354c">free_child_process_memory</a>;
<a name="l00098"></a>00098 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a2976ddc6ad4325c074912d0f61bb0184">child_processes_fork_twice</a>;
<a name="l00099"></a>00099 
<a name="l00100"></a>00100 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#ae96ccc43c200c07e833891d2b6ca8bba">stalking_event_handlers_for_hosts</a>;
<a name="l00101"></a>00101 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a4113366f27b640f3e76ecef1b7ba9809">stalking_event_handlers_for_services</a>;
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 <span class="keyword">extern</span> time_t   <a class="code" href="broker_8c.html#a2b5a4f2875a1a545f44ac2faad7a6b67">program_start</a>;
<a name="l00104"></a>00104 <span class="keyword">extern</span> time_t   <a class="code" href="checks_8c.html#aa9869971067b17a06b557d85afa4d8cd">event_start</a>;
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 <span class="keyword">extern</span> <a class="code" href="structtimed__event__struct.html">timed_event</a>       *<a class="code" href="checks_8c.html#a5fc3341e76625e95ab611a9f9237b839">event_list_low</a>;
<a name="l00107"></a>00107 <span class="keyword">extern</span> <a class="code" href="structtimed__event__struct.html">timed_event</a>       *<a class="code" href="checks_8c.html#aef1b09ea5f55dbb0015d8094bab1f1ec">event_list_low_tail</a>;
<a name="l00108"></a>00108 
<a name="l00109"></a>00109 <span class="keyword">extern</span> <a class="code" href="structhost__struct.html">host</a>              *<a class="code" href="checks_8c.html#a7efb54fbdc5a556ffdbe25c56e6e7469">host_list</a>;
<a name="l00110"></a>00110 <span class="keyword">extern</span> <a class="code" href="structservice__struct.html">service</a>           *<a class="code" href="checks_8c.html#aa680c491c2d6c99868a3789592868c15">service_list</a>;
<a name="l00111"></a>00111 <span class="keyword">extern</span> <a class="code" href="structservicedependency__struct.html">servicedependency</a> *<a class="code" href="checks_8c.html#a42367b9675e5559520ccd1997e4e4bad">servicedependency_list</a>;
<a name="l00112"></a>00112 <span class="keyword">extern</span> <a class="code" href="structhostdependency__struct.html">hostdependency</a>    *<a class="code" href="checks_8c.html#ad605bbee38fc009d01d4e245fe74e85d">hostdependency_list</a>;
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   <a class="code" href="checks_8c.html#a75ecfdc2a9af9431daf6d862bc9ab9cc">next_event_id</a>;
<a name="l00115"></a>00115 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   <a class="code" href="checks_8c.html#a9932153d944780dd9f1156d4c7788c0d">next_problem_id</a>;
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 <span class="keyword">extern</span> <a class="code" href="structcheck__result__struct.html">check_result</a>    <a class="code" href="checks_8c.html#a3c4ba85a60252149f09be4923bc98b4a">check_result_info</a>;
<a name="l00118"></a>00118 <span class="keyword">extern</span> <a class="code" href="structcheck__result__struct.html">check_result</a>    *<a class="code" href="checks_8c.html#a9a65c5bcf2a37699d3438209379f79c2">check_result_list</a>;
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 <span class="keyword">extern</span> pthread_t       <a class="code" href="checks_8c.html#a5c1a9b9ccaf872452bec541a26ab586b">worker_threads</a>[<a class="code" href="icinga_8h.html#a39f497fe500265af5f37b35c16224047">TOTAL_WORKER_THREADS</a>];
<a name="l00121"></a>00121 
<a name="l00122"></a>00122 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="checks_8c.html#ac919486c0bf77cab5e1ec2f0aba1803f">max_debug_file_size</a>;
<a name="l00123"></a>00123 
<a name="l00124"></a>00124 <span class="preprocessor">#ifdef EMBEDDEDPERL</span>
<a name="l00125"></a>00125 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="keywordtype">int</span>      use_embedded_perl;
<a name="l00126"></a>00126 <span class="preprocessor">#endif</span>
<a name="l00127"></a>00127 <span class="preprocessor"></span>
<a name="l00128"></a><a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">00128</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>;      <span class="comment">/* reduce compiler warnings */</span>
<a name="l00129"></a>00129 
<a name="l00130"></a>00130 <span class="comment">/******************************************************************/</span>
<a name="l00131"></a>00131 <span class="comment">/********************* MISCELLANEOUS FUNCTIONS ********************/</span>
<a name="l00132"></a>00132 <span class="comment">/******************************************************************/</span>
<a name="l00133"></a>00133 
<a name="l00134"></a>00134 <span class="comment">/* extract check result */</span>
<a name="l00135"></a>00135 <span class="keyword">static</span> <span class="keywordtype">void</span> extract_check_result(FILE *fp,<a class="code" href="structdbuf__struct.html">dbuf</a> *checkresult_dbuf){
<a name="l00136"></a>00136         <span class="keywordtype">char</span> output_buffer[<a class="code" href="include_2common_8h.html#a23c82337fe6c21111837512469ea40af">MAX_INPUT_BUFFER</a>]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l00137"></a>00137         <span class="keywordtype">char</span> *temp_buffer;
<a name="l00138"></a>00138 
<a name="l00139"></a>00139         <span class="comment">/* initialize buffer */</span>
<a name="l00140"></a>00140         strcpy(output_buffer,<span class="stringliteral">&quot;&quot;</span>);
<a name="l00141"></a>00141 
<a name="l00142"></a>00142         <span class="comment">/* get all lines of plugin output - escape newlines */</span>
<a name="l00143"></a>00143         <span class="keywordflow">while</span>(fgets(output_buffer,<span class="keyword">sizeof</span>(output_buffer)-1,fp)){
<a name="l00144"></a>00144                 temp_buffer=<a class="code" href="base_2utils_8c.html#a7122ec70de7a5439b8360b86a97071b0">escape_newlines</a>(output_buffer);
<a name="l00145"></a>00145                 <a class="code" href="base_2utils_8c.html#a302c0b1965465017578bba02a6d9e6c9">dbuf_strcat</a>(checkresult_dbuf,temp_buffer);
<a name="l00146"></a>00146                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_buffer);
<a name="l00147"></a>00147         }
<a name="l00148"></a>00148 }
<a name="l00149"></a>00149 
<a name="l00150"></a>00150 <span class="comment">/* convert a command line to an array of arguments, suitable for exec* functions */</span>
<a name="l00151"></a>00151 <span class="keyword">static</span> <span class="keywordtype">int</span> parse_command_line(<span class="keywordtype">char</span> *cmd, <span class="keywordtype">char</span> *argv[<a class="code" href="icinga_8h.html#aa2ee87dd56484c6eadb1a9ae23804925">MAX_CMD_ARGS</a>]){
<a name="l00152"></a>00152         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> argc=0;
<a name="l00153"></a>00153         <span class="keywordtype">char</span> *parsed_cmd;
<a name="l00154"></a>00154 
<a name="l00155"></a>00155         <span class="comment">/* Skip initial white-space characters. */</span>
<a name="l00156"></a>00156         <span class="keywordflow">for</span>(parsed_cmd=cmd;isspace(*cmd);++cmd)
<a name="l00157"></a>00157                 ;
<a name="l00158"></a>00158 
<a name="l00159"></a>00159         <span class="comment">/* Parse command line. */</span>
<a name="l00160"></a>00160         <span class="keywordflow">while</span>(*cmd&amp;&amp;(argc&lt;MAX_CMD_ARGS-1)){
<a name="l00161"></a>00161                 argv[argc++]=parsed_cmd;
<a name="l00162"></a>00162 
<a name="l00163"></a>00163                 <span class="keywordflow">switch</span>(*cmd){
<a name="l00164"></a>00164                         <span class="keywordflow">case</span> <span class="charliteral">&#39;\&#39;&#39;</span>:
<a name="l00165"></a>00165                                 <span class="keywordflow">while</span>((*cmd)&amp;&amp;(*cmd!=<span class="charliteral">&#39;\&#39;&#39;</span>))
<a name="l00166"></a>00166                                         *(parsed_cmd++)=*(cmd++);
<a name="l00167"></a>00167                                 <span class="keywordflow">if</span>(*cmd)
<a name="l00168"></a>00168                                         ++cmd;
<a name="l00169"></a>00169                                 <span class="keywordflow">break</span>;
<a name="l00170"></a>00170                         <span class="keywordflow">case</span> <span class="charliteral">&#39;&quot;&#39;</span>:
<a name="l00171"></a>00171                                 <span class="keywordflow">while</span>((*cmd)&amp;&amp;(*cmd!=<span class="charliteral">&#39;&quot;&#39;</span>)){
<a name="l00172"></a>00172                                         <span class="keywordflow">if</span>((*cmd==<span class="charliteral">&#39;\\&#39;</span>)&amp;&amp;cmd[1]&amp;&amp;strchr(<span class="stringliteral">&quot;\&quot;\\\n&quot;</span>,cmd[1]))
<a name="l00173"></a>00173                                                 ++cmd;
<a name="l00174"></a>00174                                         *(parsed_cmd++)=*(cmd++);
<a name="l00175"></a>00175                                 }
<a name="l00176"></a>00176                                 <span class="keywordflow">if</span>(*cmd)
<a name="l00177"></a>00177                                         ++cmd;
<a name="l00178"></a>00178                                 <span class="keywordflow">break</span>;
<a name="l00179"></a>00179                         <span class="keywordflow">default</span>:
<a name="l00180"></a>00180                                 <span class="keywordflow">while</span>((*cmd)&amp;&amp;!isspace(*cmd)){
<a name="l00181"></a>00181                                         <span class="keywordflow">if</span>((*cmd==<span class="charliteral">&#39;\\&#39;</span>)&amp;&amp;cmd[1])
<a name="l00182"></a>00182                                                 ++cmd;
<a name="l00183"></a>00183                                         *(parsed_cmd++)=*(cmd++);
<a name="l00184"></a>00184                                 }
<a name="l00185"></a>00185                 }
<a name="l00186"></a>00186 
<a name="l00187"></a>00187                 <span class="keywordflow">while</span>(isspace(*cmd))
<a name="l00188"></a>00188                         ++cmd;
<a name="l00189"></a>00189 
<a name="l00190"></a>00190                 <span class="keywordflow">if</span>(argc&gt;=MAX_CMD_ARGS-1){
<a name="l00191"></a>00191                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;overlimit args for command %s\n&quot;</span>,argv[0]);
<a name="l00192"></a>00192                         _exit(<a class="code" href="cgiutils_8h.html#a3a671c5b5d9122f1158555575bc0feb1">STATE_UNKNOWN</a>);
<a name="l00193"></a>00193                 }
<a name="l00194"></a>00194                 <span class="keywordflow">else</span>
<a name="l00195"></a>00195                         *(parsed_cmd++)=<span class="charliteral">&#39;\0&#39;</span>;
<a name="l00196"></a>00196         }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198         argv[argc]=NULL;
<a name="l00199"></a>00199 
<a name="l00200"></a>00200         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00201"></a>00201 }
<a name="l00202"></a>00202 
<a name="l00203"></a>00203 <span class="comment">/* run a check */</span>
<a name="l00204"></a>00204 <span class="keyword">static</span> <span class="keywordtype">int</span> run_check(<span class="keywordtype">char</span> *processed_command,<a class="code" href="structdbuf__struct.html">dbuf</a> *checkresult_dbuf){
<a name="l00205"></a>00205         <span class="keywordtype">char</span> *argv[<a class="code" href="icinga_8h.html#aa2ee87dd56484c6eadb1a9ae23804925">MAX_CMD_ARGS</a>];
<a name="l00206"></a>00206         FILE *fp;
<a name="l00207"></a>00207         pid_t pid;
<a name="l00208"></a>00208         <span class="keywordtype">int</span> pipefds[2];
<a name="l00209"></a>00209         <span class="keywordtype">int</span> retval;
<a name="l00210"></a>00210 
<a name="l00211"></a>00211         <span class="comment">/* check for check execution method (shell or execvp) */</span>
<a name="l00212"></a>00212         <span class="keywordflow">if</span>(!<a class="code" href="base_2utils_8c.html#aed22a9c033532de4a6b649d24d8705b8">has_shell_metachars</a>(processed_command)){
<a name="l00213"></a>00213 
<a name="l00214"></a>00214                 <span class="keywordflow">if</span>(pipe(pipefds)&lt;0){
<a name="l00215"></a>00215                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;error creating pipe: %s\n&quot;</span>, strerror(errno));
<a name="l00216"></a>00216                         _exit(<a class="code" href="cgiutils_8h.html#a3a671c5b5d9122f1158555575bc0feb1">STATE_UNKNOWN</a>);
<a name="l00217"></a>00217                 }
<a name="l00218"></a>00218                 <span class="keywordflow">if</span>((pid=fork())&lt;0){
<a name="l00219"></a>00219                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;fork error\n&quot;</span>);
<a name="l00220"></a>00220                         _exit(<a class="code" href="cgiutils_8h.html#a3a671c5b5d9122f1158555575bc0feb1">STATE_UNKNOWN</a>);
<a name="l00221"></a>00221                 }
<a name="l00222"></a>00222                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!pid){
<a name="l00223"></a>00223                         <span class="comment">/* child replaces stdout/stderr with output of the pipe */</span>
<a name="l00224"></a>00224                         <span class="keywordflow">if</span>((dup2(pipefds[1],STDOUT_FILENO)&lt;0)||(dup2(pipefds[1],STDERR_FILENO)&lt;0)){
<a name="l00225"></a>00225                                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;dup2 error\n&quot;</span>);
<a name="l00226"></a>00226                                 _exit(<a class="code" href="cgiutils_8h.html#a3a671c5b5d9122f1158555575bc0feb1">STATE_UNKNOWN</a>);
<a name="l00227"></a>00227                         }
<a name="l00228"></a>00228 
<a name="l00229"></a>00229                         <span class="comment">/* close unused half of pipe */</span>
<a name="l00230"></a>00230                         close(pipefds[1]);
<a name="l00231"></a>00231 
<a name="l00232"></a>00232                         <span class="comment">/* extract command args for execv */</span>
<a name="l00233"></a>00233                         parse_command_line(processed_command,argv);
<a name="l00234"></a>00234 
<a name="l00235"></a>00235                         <span class="keywordflow">if</span>(!argv[0]){
<a name="l00236"></a>00236                                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;plugin command definition empty\n&quot;</span>);
<a name="l00237"></a>00237                                 _exit(<a class="code" href="cgiutils_8h.html#a3a671c5b5d9122f1158555575bc0feb1">STATE_UNKNOWN</a>);
<a name="l00238"></a>00238                         }
<a name="l00239"></a>00239 
<a name="l00240"></a>00240                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;running command %s via execvp\n&quot;</span>,processed_command);
<a name="l00241"></a>00241 
<a name="l00242"></a>00242                         <span class="keywordflow">if</span>(execvp(argv[0], argv)&lt;0){ <span class="comment">/* execvp only returns in case of an error */</span>
<a name="l00243"></a>00243                                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;error executing command &#39;%s&#39;: %s. Make sure that the file actually exists (in PATH, if set) and is executable!\n&quot;</span>,processed_command, strerror(errno));
<a name="l00244"></a>00244                                 _exit(<a class="code" href="cgiutils_8h.html#a3a671c5b5d9122f1158555575bc0feb1">STATE_UNKNOWN</a>);
<a name="l00245"></a>00245                         }
<a name="l00246"></a>00246                         _exit(<a class="code" href="cgiutils_8h.html#a3a671c5b5d9122f1158555575bc0feb1">STATE_UNKNOWN</a>);
<a name="l00247"></a>00247                 }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249                 <span class="comment">/* prepare pipe reading */</span>
<a name="l00250"></a>00250                 close(pipefds[1]);
<a name="l00251"></a>00251                 fp=fdopen(pipefds[0],<span class="stringliteral">&quot;r&quot;</span>);
<a name="l00252"></a>00252                 <span class="keywordflow">if</span>(!fp){
<a name="l00253"></a>00253                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;fdopen error\n&quot;</span>);
<a name="l00254"></a>00254                         _exit(<a class="code" href="cgiutils_8h.html#a3a671c5b5d9122f1158555575bc0feb1">STATE_UNKNOWN</a>);
<a name="l00255"></a>00255                 }
<a name="l00256"></a>00256 
<a name="l00257"></a>00257                 <span class="comment">/* extract check result */</span>
<a name="l00258"></a>00258                 extract_check_result(fp,checkresult_dbuf);
<a name="l00259"></a>00259 
<a name="l00260"></a>00260                 <span class="comment">/* close the process */</span>
<a name="l00261"></a>00261                 fclose(fp);
<a name="l00262"></a>00262                 close(pipefds[0]);
<a name="l00263"></a>00263 
<a name="l00264"></a>00264                 <span class="keywordflow">if</span>(waitpid(pid,&amp;retval,0)!=pid)
<a name="l00265"></a>00265                         retval=-1;
<a name="l00266"></a>00266         }
<a name="l00267"></a>00267         <span class="keywordflow">else</span>{
<a name="l00268"></a>00268                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;running command %s via popen\n&quot;</span>,processed_command);
<a name="l00269"></a>00269                 fp=popen(processed_command,<span class="stringliteral">&quot;r&quot;</span>);
<a name="l00270"></a>00270 
<a name="l00271"></a>00271                 <span class="keywordflow">if</span>(fp==NULL)
<a name="l00272"></a>00272                         _exit(<a class="code" href="cgiutils_8h.html#a3a671c5b5d9122f1158555575bc0feb1">STATE_UNKNOWN</a>);
<a name="l00273"></a>00273 
<a name="l00274"></a>00274                 <span class="comment">/* extract check result */</span>
<a name="l00275"></a>00275                 extract_check_result(fp,checkresult_dbuf);
<a name="l00276"></a>00276 
<a name="l00277"></a>00277                 <span class="comment">/* close the process */</span>
<a name="l00278"></a>00278                 retval=pclose(fp);
<a name="l00279"></a>00279         }
<a name="l00280"></a>00280 
<a name="l00281"></a>00281         <span class="keywordflow">return</span> retval;
<a name="l00282"></a>00282 }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284 
<a name="l00285"></a>00285 <span class="comment">/******************************************************************/</span>
<a name="l00286"></a>00286 <span class="comment">/********************** CHECK REAPER FUNCTIONS ********************/</span>
<a name="l00287"></a>00287 <span class="comment">/******************************************************************/</span>
<a name="l00288"></a>00288 
<a name="l00289"></a>00289 <span class="comment">/* reaps host and service check results */</span>
<a name="l00290"></a><a class="code" href="icinga_8h.html#a1f116877f65bf9539995cf3f2c67f247">00290</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#a1f116877f65bf9539995cf3f2c67f247">reap_check_results</a>(<span class="keywordtype">void</span>){
<a name="l00291"></a>00291         <a class="code" href="structcheck__result__struct.html">check_result</a> *queued_check_result=NULL;
<a name="l00292"></a>00292         <a class="code" href="structservice__struct.html">service</a> *temp_service=NULL;
<a name="l00293"></a>00293         <a class="code" href="structhost__struct.html">host</a> *temp_host=NULL;
<a name="l00294"></a>00294         time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>=0L;
<a name="l00295"></a>00295         time_t reaper_start_time=0L;
<a name="l00296"></a>00296         <span class="keywordtype">int</span> reaped_checks=0;
<a name="l00297"></a>00297 
<a name="l00298"></a>00298         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;reap_check_results() start\n&quot;</span>);
<a name="l00299"></a>00299         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Starting to reap check results.\n&quot;</span>);
<a name="l00300"></a>00300 
<a name="l00301"></a>00301         <span class="comment">/* get the start time */</span>
<a name="l00302"></a>00302         time(&amp;reaper_start_time);
<a name="l00303"></a>00303 
<a name="l00304"></a>00304         <span class="comment">/* process files in the check result queue */</span>
<a name="l00305"></a>00305         <a class="code" href="base_2utils_8c.html#a47aaee3f3f1aba69773b5d25b7fa4cfe">process_check_result_queue</a>(<a class="code" href="checks_8c.html#a3964b0cff6f7740b1f35a62ba0ef0d6a">check_result_path</a>);
<a name="l00306"></a>00306 
<a name="l00307"></a>00307         <span class="comment">/* read all check results that have come in... */</span>
<a name="l00308"></a>00308         <span class="keywordflow">while</span>((queued_check_result=<a class="code" href="base_2utils_8c.html#acce9620a3784efaed89f5f4fade5fa08">read_check_result</a>())){
<a name="l00309"></a>00309 
<a name="l00310"></a>00310                 reaped_checks++;
<a name="l00311"></a>00311 
<a name="l00312"></a>00312                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Found a check result (#%d) to handle...\n&quot;</span>,reaped_checks);
<a name="l00313"></a>00313 
<a name="l00314"></a>00314                 <span class="comment">/* service check */</span>
<a name="l00315"></a>00315                 <span class="keywordflow">if</span>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#aab46f07f58a12b95f55f483637e2f937">object_check_type</a>==<a class="code" href="icinga_8h.html#ade4e796d45e5c3ffcee218cd4c2d5469">SERVICE_CHECK</a>){
<a name="l00316"></a>00316 
<a name="l00317"></a>00317                         <span class="comment">/* make sure the service exists */</span>
<a name="l00318"></a>00318                         <span class="keywordflow">if</span>((temp_service=<a class="code" href="objects_8c.html#ab1d2d0b3d54898c574aa58b9fe332aa6">find_service</a>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a8e0609d9dd4bf77156c9e967ab8c8924">host_name</a>,queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a3cd7e3c42f1bce1761e6c84b76588877">service_description</a>))==NULL){
<a name="l00319"></a>00319 
<a name="l00320"></a>00320                                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: Check result queue contained results for service &#39;%s&#39; on host &#39;%s&#39;, but the service could not be found!  Perhaps you forgot to define the service in your config files?\n&quot;</span>,queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a3cd7e3c42f1bce1761e6c84b76588877">service_description</a>,queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a8e0609d9dd4bf77156c9e967ab8c8924">host_name</a>);
<a name="l00321"></a>00321 
<a name="l00322"></a>00322                                 <span class="comment">/* delete the file that contains the check results, as well as the ok-to-go file */</span>
<a name="l00323"></a>00323                                 <a class="code" href="base_2utils_8c.html#a18f87ac621d1954ac8be83fe327742df">delete_check_result_file</a>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1ef7b671552d6ed92421a522c4127bf6">output_file</a>);
<a name="l00324"></a>00324 
<a name="l00325"></a>00325                                 <span class="comment">/* free memory */</span>
<a name="l00326"></a>00326                                 <a class="code" href="base_2utils_8c.html#a36701093a323ae768707b7a025a13e01">free_check_result</a>(queued_check_result);
<a name="l00327"></a>00327                                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(queued_check_result);
<a name="l00328"></a>00328 
<a name="l00329"></a>00329                                 <span class="comment">/* TODO - add new service definition automatically */</span>
<a name="l00330"></a>00330 
<a name="l00331"></a>00331                                 <span class="keywordflow">continue</span>;
<a name="l00332"></a>00332                         }
<a name="l00333"></a>00333 
<a name="l00334"></a>00334                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Handling check result for service &#39;%s&#39; on host &#39;%s&#39;...\n&quot;</span>,temp_service-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,temp_service-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>);
<a name="l00335"></a>00335 
<a name="l00336"></a>00336                         <span class="comment">/* process the check result */</span>
<a name="l00337"></a>00337                         <a class="code" href="checks_8c.html#ac1f1f0f4f9554acef259385eae86aa9a">handle_async_service_check_result</a>(temp_service,queued_check_result);
<a name="l00338"></a>00338                 }
<a name="l00339"></a>00339 
<a name="l00340"></a>00340                 <span class="comment">/* host check */</span>
<a name="l00341"></a>00341                 <span class="keywordflow">else</span>{
<a name="l00342"></a>00342                         <span class="keywordflow">if</span>((temp_host=<a class="code" href="objects_8c.html#a00522e51ee51756c73a5395e6d1498d3">find_host</a>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a8e0609d9dd4bf77156c9e967ab8c8924">host_name</a>))==NULL){
<a name="l00343"></a>00343 
<a name="l00344"></a>00344                                 <span class="comment">/* make sure the host exists */</span>
<a name="l00345"></a>00345                                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: Check result queue contained results for host &#39;%s&#39;, but the host could not be found!  Perhaps you forgot to define the host in your config files?\n&quot;</span>,queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a8e0609d9dd4bf77156c9e967ab8c8924">host_name</a>);
<a name="l00346"></a>00346 
<a name="l00347"></a>00347                                 <span class="comment">/* delete the file that contains the check results, as well as the ok-to-go file */</span>
<a name="l00348"></a>00348                                 <a class="code" href="base_2utils_8c.html#a18f87ac621d1954ac8be83fe327742df">delete_check_result_file</a>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1ef7b671552d6ed92421a522c4127bf6">output_file</a>);
<a name="l00349"></a>00349 
<a name="l00350"></a>00350                                 <span class="comment">/* free memory */</span>
<a name="l00351"></a>00351                                 <a class="code" href="base_2utils_8c.html#a36701093a323ae768707b7a025a13e01">free_check_result</a>(queued_check_result);
<a name="l00352"></a>00352                                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(queued_check_result);
<a name="l00353"></a>00353 
<a name="l00354"></a>00354                                 <span class="comment">/* TODO - add new host definition automatically */</span>
<a name="l00355"></a>00355 
<a name="l00356"></a>00356                                 <span class="keywordflow">continue</span>;
<a name="l00357"></a>00357                         }
<a name="l00358"></a>00358 
<a name="l00359"></a>00359                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Handling check result for host &#39;%s&#39;...\n&quot;</span>,temp_host-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l00360"></a>00360 
<a name="l00361"></a>00361                         <span class="comment">/* process the check result */</span>
<a name="l00362"></a>00362                         <a class="code" href="checks_8c.html#a113eb9743ca3e9d18fc6dae81dd85de8">handle_async_host_check_result_3x</a>(temp_host,queued_check_result);
<a name="l00363"></a>00363                 }
<a name="l00364"></a>00364 
<a name="l00365"></a>00365                 <span class="comment">/* delete the file that contains the check results, as well as the ok-to-go file */</span>
<a name="l00366"></a>00366                 <span class="comment">/* files can contain multiple check results - in this case, the file will be removed when the first check result is processed */</span>
<a name="l00367"></a>00367                 <a class="code" href="base_2utils_8c.html#a18f87ac621d1954ac8be83fe327742df">delete_check_result_file</a>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1ef7b671552d6ed92421a522c4127bf6">output_file</a>);
<a name="l00368"></a>00368 
<a name="l00369"></a>00369                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>|<a class="code" href="logging_8h.html#addc28db449ac01a4e1e04a0646ae70bd">DEBUGL_IPC</a>,1,<span class="stringliteral">&quot;Deleted check result file &#39;%s&#39;\n&quot;</span>,queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1ef7b671552d6ed92421a522c4127bf6">output_file</a>);
<a name="l00370"></a>00370 
<a name="l00371"></a>00371                 <span class="comment">/* free allocated memory */</span>
<a name="l00372"></a>00372                 <a class="code" href="base_2utils_8c.html#a36701093a323ae768707b7a025a13e01">free_check_result</a>(queued_check_result);
<a name="l00373"></a>00373                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(queued_check_result);
<a name="l00374"></a>00374 
<a name="l00375"></a>00375                 <span class="comment">/* break out if we&#39;ve been here too long (max_check_reaper_time seconds) */</span>
<a name="l00376"></a>00376                 time(&amp;current_time);
<a name="l00377"></a>00377                 <span class="keywordflow">if</span>((<span class="keywordtype">int</span>)(current_time-reaper_start_time)&gt;<a class="code" href="checks_8c.html#aec4c41d4a0f2abb5ccb88695fa1a7afd">max_check_reaper_time</a>){
<a name="l00378"></a>00378                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Breaking out of check result reaper: max reaper time exceeded\n&quot;</span>);
<a name="l00379"></a>00379                         <span class="keywordflow">break</span>;
<a name="l00380"></a>00380                 }
<a name="l00381"></a>00381 
<a name="l00382"></a>00382                 <span class="comment">/* bail out if we encountered a signal */</span>
<a name="l00383"></a>00383                 <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a2b5f7762caad7a548645f2d9c4cdee47">sigshutdown</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> || <a class="code" href="checks_8c.html#aadf2eea990498582cc7dac355c3d7e71">sigrestart</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l00384"></a>00384                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Breaking out of check result reaper: signal encountered\n&quot;</span>);
<a name="l00385"></a>00385                         <span class="keywordflow">break</span>;
<a name="l00386"></a>00386                 }
<a name="l00387"></a>00387         }
<a name="l00388"></a>00388 
<a name="l00389"></a>00389         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Finished reaping %d check results\n&quot;</span>,reaped_checks);
<a name="l00390"></a>00390         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;reap_check_results() end\n&quot;</span>);
<a name="l00391"></a>00391 
<a name="l00392"></a>00392         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00393"></a>00393 }
<a name="l00394"></a>00394 
<a name="l00395"></a>00395 
<a name="l00396"></a>00396 
<a name="l00397"></a>00397 
<a name="l00398"></a>00398 <span class="comment">/******************************************************************/</span>
<a name="l00399"></a>00399 <span class="comment">/****************** SERVICE MONITORING FUNCTIONS ******************/</span>
<a name="l00400"></a>00400 <span class="comment">/******************************************************************/</span>
<a name="l00401"></a>00401 
<a name="l00402"></a>00402 <span class="comment">/* executes a scheduled service check */</span>
<a name="l00403"></a><a class="code" href="icinga_8h.html#a63da59342352905d3a86d7598ef214cc">00403</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#a659d76e8437441edd2e388f532b05d85">run_scheduled_service_check</a>(<a class="code" href="structservice__struct.html">service</a> *svc, <span class="keywordtype">int</span> check_options, <span class="keywordtype">double</span> latency){
<a name="l00404"></a>00404         <span class="keywordtype">int</span> result=<a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00405"></a>00405         time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>=0L;
<a name="l00406"></a>00406         time_t preferred_time=0L;
<a name="l00407"></a>00407         time_t next_valid_time=0L;
<a name="l00408"></a>00408         <span class="keywordtype">int</span> time_is_valid=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00409"></a>00409 
<a name="l00410"></a>00410         <span class="keywordflow">if</span>(svc==NULL)
<a name="l00411"></a>00411                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l00412"></a>00412 
<a name="l00413"></a>00413         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;run_scheduled_service_check() start\n&quot;</span>);
<a name="l00414"></a>00414         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Attempting to run scheduled check of service &#39;%s&#39; on host &#39;%s&#39;: check options=%d, latency=%lf\n&quot;</span>,svc-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,svc-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>,check_options,latency);
<a name="l00415"></a>00415 
<a name="l00416"></a>00416         <span class="comment">/* attempt to run the check */</span>
<a name="l00417"></a>00417         result=<a class="code" href="checks_8c.html#a7d23809fb047f645c28c5f676d2d60c9">run_async_service_check</a>(svc,check_options,latency,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,&amp;time_is_valid,&amp;preferred_time);
<a name="l00418"></a>00418 
<a name="l00419"></a>00419         <span class="comment">/* an error occurred, so reschedule the check */</span>
<a name="l00420"></a>00420         <span class="keywordflow">if</span>(result==<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>){
<a name="l00421"></a>00421 
<a name="l00422"></a>00422                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Unable to run scheduled service check at this time\n&quot;</span>);
<a name="l00423"></a>00423 
<a name="l00424"></a>00424                 <span class="comment">/* only attempt to (re)schedule checks that should get checked... */</span>
<a name="l00425"></a>00425                 <span class="keywordflow">if</span>(svc-&gt;should_be_scheduled==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l00426"></a>00426 
<a name="l00427"></a>00427                         <span class="comment">/* get current time */</span>
<a name="l00428"></a>00428                         time(&amp;current_time);
<a name="l00429"></a>00429 
<a name="l00430"></a>00430                         <span class="comment">/* determine next time we should check the service if needed */</span>
<a name="l00431"></a>00431                         <span class="comment">/* if service has no check interval, schedule it again for 5 minutes from now */</span>
<a name="l00432"></a>00432                         <span class="keywordflow">if</span>(current_time&gt;=preferred_time)
<a name="l00433"></a>00433                                 preferred_time=current_time+((svc-&gt;<a class="code" href="structservice__struct.html#a54179e5f4bb721f91c11e943a1f9f32c">check_interval</a>&lt;=0)?300:(svc-&gt;<a class="code" href="structservice__struct.html#a54179e5f4bb721f91c11e943a1f9f32c">check_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>));
<a name="l00434"></a>00434 
<a name="l00435"></a>00435                         <span class="comment">/* make sure we rescheduled the next service check at a valid time */</span>
<a name="l00436"></a>00436                         <a class="code" href="base_2utils_8c.html#a887cf03e0c7cfc020e10e9f1949aae2e">get_next_valid_time</a>(preferred_time,&amp;next_valid_time,svc-&gt;check_period_ptr);
<a name="l00437"></a>00437 
<a name="l00438"></a>00438                         <span class="comment">/*</span>
<a name="l00439"></a>00439 <span class="comment">                        logit(NSLOG_RUNTIME_WARNING,TRUE,&quot;Warning: Service &#39;%s&#39; on host &#39;%s&#39; timeperiod check failed...\n&quot;,svc-&gt;description,svc-&gt;host_name);</span>
<a name="l00440"></a>00440 <span class="comment">                        logit(NSLOG_RUNTIME_WARNING,TRUE,&quot;Current time: %s&quot;,ctime(&amp;current_time));</span>
<a name="l00441"></a>00441 <span class="comment">                        logit(NSLOG_RUNTIME_WARNING,TRUE,&quot;Preferred time: %s&quot;,ctime(&amp;preferred_time));</span>
<a name="l00442"></a>00442 <span class="comment">                        logit(NSLOG_RUNTIME_WARNING,TRUE,&quot;Next valid time: %s&quot;,ctime(&amp;next_valid_time));</span>
<a name="l00443"></a>00443 <span class="comment">                         */</span>
<a name="l00444"></a>00444 
<a name="l00445"></a>00445                         <span class="comment">/* the service could not be rescheduled properly - set the next check time for next week */</span>
<a name="l00446"></a>00446                         <span class="comment">/*if(time_is_valid==FALSE &amp;&amp; next_valid_time==preferred_time){*/</span>
<a name="l00447"></a>00447                         <span class="comment">/* UPDATED 08/12/09 EG to reflect proper timeperod check logic */</span>
<a name="l00448"></a>00448                         <span class="keywordflow">if</span>(time_is_valid==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> &amp;&amp;  <a class="code" href="base_2utils_8c.html#a49602563f5f03788d56b2d06d2c72bfb">check_time_against_period</a>(next_valid_time,svc-&gt;check_period_ptr)==<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>){
<a name="l00449"></a>00449 
<a name="l00450"></a>00450                                 <span class="comment">/*</span>
<a name="l00451"></a>00451 <span class="comment">                                svc-&gt;next_check=(time_t)(next_valid_time+(60*60*24*365));</span>
<a name="l00452"></a>00452 <span class="comment">                                svc-&gt;should_be_scheduled=FALSE;</span>
<a name="l00453"></a>00453 <span class="comment">                                 */</span>
<a name="l00454"></a>00454 
<a name="l00455"></a>00455                                 svc-&gt;next_check=(time_t)(next_valid_time+(60*60*24*7));
<a name="l00456"></a>00456 
<a name="l00457"></a>00457                                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: Check of service &#39;%s&#39; on host &#39;%s&#39; could not be rescheduled properly.  Scheduling check for next week...\n&quot;</span>,svc-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,svc-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>);
<a name="l00458"></a>00458 
<a name="l00459"></a>00459                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Unable to find any valid times to reschedule the next service check!\n&quot;</span>);
<a name="l00460"></a>00460                         }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462                         <span class="comment">/* this service could be rescheduled... */</span>
<a name="l00463"></a>00463                         <span class="keywordflow">else</span>{
<a name="l00464"></a>00464                                 svc-&gt;next_check=next_valid_time;
<a name="l00465"></a>00465                                 svc-&gt;should_be_scheduled=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00466"></a>00466 
<a name="l00467"></a>00467                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Rescheduled next service check for %s&quot;</span>,ctime(&amp;next_valid_time));
<a name="l00468"></a>00468                         }
<a name="l00469"></a>00469                 }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471                 <span class="comment">/* reschedule the next service check - unless we couldn&#39;t find a valid next check time */</span>
<a name="l00472"></a>00472                 <span class="comment">/* 10/19/07 EG - keep original check options */</span>
<a name="l00473"></a>00473                 <span class="keywordflow">if</span>(svc-&gt;should_be_scheduled==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l00474"></a>00474                         <a class="code" href="checks_8c.html#a9b14dc5a4e9f578544fdf45375701517">schedule_service_check</a>(svc,svc-&gt;next_check,check_options);
<a name="l00475"></a>00475 
<a name="l00476"></a>00476                 <span class="comment">/* update the status log */</span>
<a name="l00477"></a>00477                 update_service_status(svc,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00478"></a>00478 
<a name="l00479"></a>00479                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l00480"></a>00480         }
<a name="l00481"></a>00481 
<a name="l00482"></a>00482         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00483"></a>00483 }
<a name="l00484"></a>00484 
<a name="l00485"></a>00485 
<a name="l00486"></a>00486 <span class="comment">/* forks a child process to run a service check, but does not wait for the service check result */</span>
<a name="l00487"></a><a class="code" href="icinga_8h.html#a47962d355c7521765c9cc88b51759e2b">00487</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#a7d23809fb047f645c28c5f676d2d60c9">run_async_service_check</a>(<a class="code" href="structservice__struct.html">service</a> *svc, <span class="keywordtype">int</span> check_options, <span class="keywordtype">double</span> latency, <span class="keywordtype">int</span> scheduled_check, <span class="keywordtype">int</span> reschedule_check, <span class="keywordtype">int</span> *time_is_valid, time_t *preferred_time){
<a name="l00488"></a>00488         <a class="code" href="structicinga__macros.html">icinga_macros</a> mac;
<a name="l00489"></a>00489         <span class="keywordtype">char</span> *raw_command=NULL;
<a name="l00490"></a>00490         <span class="keywordtype">char</span> *processed_command=NULL;
<a name="l00491"></a>00491         <span class="keyword">struct </span>timeval start_time,end_time;
<a name="l00492"></a>00492         pid_t pid=0;
<a name="l00493"></a>00493         <span class="keywordtype">int</span> fork_error=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00494"></a>00494         <span class="keywordtype">int</span> wait_result=0;
<a name="l00495"></a>00495         <a class="code" href="structhost__struct.html">host</a> *temp_host=NULL;
<a name="l00496"></a>00496         <span class="keywordtype">int</span> pclose_result=0;
<a name="l00497"></a>00497         mode_t new_umask=077;
<a name="l00498"></a>00498         mode_t old_umask;
<a name="l00499"></a>00499         <span class="keywordtype">char</span> *output_file=NULL;
<a name="l00500"></a>00500         <span class="keywordtype">double</span> old_latency=0.0;
<a name="l00501"></a>00501         <a class="code" href="structdbuf__struct.html">dbuf</a> checkresult_dbuf;
<a name="l00502"></a>00502         <span class="keywordtype">int</span> dbuf_chunk=1024;
<a name="l00503"></a>00503 <span class="preprocessor">#ifdef USE_EVENT_BROKER</span>
<a name="l00504"></a>00504 <span class="preprocessor"></span>        <span class="keywordtype">int</span> neb_result=<a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00505"></a>00505 <span class="preprocessor">#endif</span>
<a name="l00506"></a>00506 <span class="preprocessor"></span><span class="preprocessor">#ifdef EMBEDDEDPERL</span>
<a name="l00507"></a>00507 <span class="preprocessor"></span>        <span class="keywordtype">char</span> fname[512]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l00508"></a>00508         <span class="keywordtype">char</span> *args[5]={<span class="stringliteral">&quot;&quot;</span>,<a class="code" href="new__mini__epn_8c.html#ab31155ed74e967f1594a68acbc1cab7d">DO_CLEAN</a>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, NULL };
<a name="l00509"></a>00509         <span class="keywordtype">char</span> *perl_plugin_output=NULL;
<a name="l00510"></a>00510         <span class="keywordtype">char</span> *temp_buffer=NULL;
<a name="l00511"></a>00511         <span class="keywordtype">char</span> *args3=NULL;
<a name="l00512"></a>00512         SV *plugin_hndlr_cr=NULL; <span class="comment">/* perl.h holds typedef struct */</span>
<a name="l00513"></a>00513         <span class="keywordtype">int</span> count;
<a name="l00514"></a>00514         <span class="keywordtype">int</span> use_epn=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00515"></a>00515 <span class="preprocessor">#ifdef aTHX</span>
<a name="l00516"></a>00516 <span class="preprocessor"></span>        dTHX;
<a name="l00517"></a>00517 <span class="preprocessor">#endif</span>
<a name="l00518"></a>00518 <span class="preprocessor"></span>        dSP;
<a name="l00519"></a>00519 <span class="preprocessor">#endif</span>
<a name="l00520"></a>00520 <span class="preprocessor"></span>
<a name="l00521"></a>00521         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;run_async_service_check()\n&quot;</span>);
<a name="l00522"></a>00522 
<a name="l00523"></a>00523         <span class="comment">/* make sure we have something */</span>
<a name="l00524"></a>00524         <span class="keywordflow">if</span>(svc==NULL)
<a name="l00525"></a>00525                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l00526"></a>00526 
<a name="l00527"></a>00527         <span class="comment">/* is the service check viable at this time? */</span>
<a name="l00528"></a>00528         <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#ac6a052aeefc9b3d7e77a58f64da4e98d">check_service_check_viability</a>(svc,check_options,time_is_valid,preferred_time)==<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>)
<a name="l00529"></a>00529                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l00530"></a>00530 
<a name="l00531"></a>00531         <span class="comment">/* find the host associated with this service */</span>
<a name="l00532"></a>00532         <span class="keywordflow">if</span>((temp_host=svc-&gt;host_ptr)==NULL)
<a name="l00533"></a>00533                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l00534"></a>00534 
<a name="l00535"></a>00535         <span class="comment">/******** GOOD TO GO FOR A REAL SERVICE CHECK AT THIS POINT ********/</span>
<a name="l00536"></a>00536 
<a name="l00537"></a>00537 <span class="preprocessor">#ifdef USE_EVENT_BROKER</span>
<a name="l00538"></a>00538 <span class="preprocessor"></span>        <span class="comment">/* initialize start/end times */</span>
<a name="l00539"></a>00539         start_time.tv_sec=0L;
<a name="l00540"></a>00540         start_time.tv_usec=0L;
<a name="l00541"></a>00541         end_time.tv_sec=0L;
<a name="l00542"></a>00542         end_time.tv_usec=0L;
<a name="l00543"></a>00543 
<a name="l00544"></a>00544         <span class="comment">/* send data to event broker */</span>
<a name="l00545"></a>00545         neb_result=<a class="code" href="broker_8h.html#af573dd59adab1dbd5041b80ae07b6245">broker_service_check</a>(<a class="code" href="broker_8h.html#a789ff653c6d19a62d304ecbc1bc747bd">NEBTYPE_SERVICECHECK_ASYNC_PRECHECK</a>,<a class="code" href="broker_8h.html#ae7b50b735fa9d5baf42ab19525993635">NEBFLAG_NONE</a>,<a class="code" href="broker_8h.html#a2e1afa1e543c76a752561dbc9eb38d65">NEBATTR_NONE</a>,svc,<a class="code" href="include_2common_8h.html#ae9ca0dbecc9fa615f650f349a9b410f2">SERVICE_CHECK_ACTIVE</a>,start_time,end_time,svc-&gt;<a class="code" href="structservice__struct.html#a979cc671dd6fd908e92d232a5e2458ca">service_check_command</a>,svc-&gt;latency,0.0,0,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,0,NULL,NULL);
<a name="l00546"></a>00546 
<a name="l00547"></a>00547         <span class="comment">/* neb module wants to cancel the service check - the check will be rescheduled for a later time by the scheduling logic */</span>
<a name="l00548"></a>00548         <span class="keywordflow">if</span>(neb_result==<a class="code" href="neberrors_8h.html#a600d6e38d658749244cc38a42344a389">NEBERROR_CALLBACKCANCEL</a>){
<a name="l00549"></a>00549                 <span class="keywordflow">if</span>(preferred_time)
<a name="l00550"></a>00550                         *preferred_time+=(svc-&gt;<a class="code" href="structservice__struct.html#a54179e5f4bb721f91c11e943a1f9f32c">check_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>);
<a name="l00551"></a>00551                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l00552"></a>00552         }
<a name="l00553"></a>00553 
<a name="l00554"></a>00554         <span class="comment">/* neb module wants to override (or cancel) the service check - perhaps it will check the service itself */</span>
<a name="l00555"></a>00555         <span class="comment">/* NOTE: if a module does this, it has to do a lot of the stuff found below to make sure things don&#39;t get whacked out of shape! */</span>
<a name="l00556"></a>00556         <span class="comment">/* NOTE: if would be easier for modules to override checks when the NEBTYPE_SERVICECHECK_INITIATE event is called (later) */</span>
<a name="l00557"></a>00557         <span class="keywordflow">if</span>(neb_result==<a class="code" href="neberrors_8h.html#a239dad95dfec616d6591de5368fb78f4">NEBERROR_CALLBACKOVERRIDE</a>)
<a name="l00558"></a>00558                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00559"></a>00559 <span class="preprocessor">#endif</span>
<a name="l00560"></a>00560 <span class="preprocessor"></span>
<a name="l00561"></a>00561 
<a name="l00562"></a>00562         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Checking service &#39;%s&#39; on host &#39;%s&#39;...\n&quot;</span>,svc-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,svc-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>);
<a name="l00563"></a>00563 
<a name="l00564"></a>00564         <span class="comment">/* clear check options - we don&#39;t want old check options retained */</span>
<a name="l00565"></a>00565         <span class="comment">/* only clear check options for scheduled checks - ondemand checks shouldn&#39;t affected retained check options */</span>
<a name="l00566"></a>00566         <span class="keywordflow">if</span>(scheduled_check==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l00567"></a>00567                 svc-&gt;check_options=<a class="code" href="include_2common_8h.html#ac2e0ba323965f243a1988566a8ea53da">CHECK_OPTION_NONE</a>;
<a name="l00568"></a>00568 
<a name="l00569"></a>00569         <span class="comment">/* update latency for macros, event broker, save old value for later */</span>
<a name="l00570"></a>00570         old_latency=svc-&gt;latency;
<a name="l00571"></a>00571         svc-&gt;latency=latency;
<a name="l00572"></a>00572 
<a name="l00573"></a>00573         <span class="comment">/* grab the host and service macro variables */</span>
<a name="l00574"></a>00574         memset(&amp;mac, 0, <span class="keyword">sizeof</span>(mac));
<a name="l00575"></a>00575         <a class="code" href="macros_8c.html#a61cae7ada74ecff37182103a3ddc76b9">grab_host_macros_r</a>(&amp;mac, temp_host);
<a name="l00576"></a>00576         <a class="code" href="macros_8c.html#a903149d29b752b9613f6ec1a0ee8f0f6">grab_service_macros_r</a>(&amp;mac, svc);
<a name="l00577"></a>00577 
<a name="l00578"></a>00578         <span class="comment">/* get the raw command line */</span>
<a name="l00579"></a>00579         <a class="code" href="base_2utils_8c.html#a786c23913ee9613d6e4782aa5e33a8e6">get_raw_command_line_r</a>(&amp;mac, svc-&gt;check_command_ptr,svc-&gt;<a class="code" href="structservice__struct.html#a979cc671dd6fd908e92d232a5e2458ca">service_check_command</a>,&amp;raw_command,0);
<a name="l00580"></a>00580         <span class="keywordflow">if</span>(raw_command==NULL){
<a name="l00581"></a>00581                 <a class="code" href="macros_8c.html#a447a756f699af137cdd85eb4caa4d0e5">clear_volatile_macros_r</a>(&amp;mac);
<a name="l00582"></a>00582                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Raw check command for service &#39;%s&#39; on host &#39;%s&#39; was NULL - aborting.\n&quot;</span>,svc-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,svc-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>);
<a name="l00583"></a>00583                 <span class="keywordflow">if</span>(preferred_time)
<a name="l00584"></a>00584                         *preferred_time+=(svc-&gt;<a class="code" href="structservice__struct.html#a54179e5f4bb721f91c11e943a1f9f32c">check_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>);
<a name="l00585"></a>00585                 svc-&gt;latency=old_latency;
<a name="l00586"></a>00586                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l00587"></a>00587         }
<a name="l00588"></a>00588 
<a name="l00589"></a>00589         <span class="comment">/* process any macros contained in the argument */</span>
<a name="l00590"></a>00590         <a class="code" href="macros_8c.html#a1be6f89f750b75aeab483d93badda0e4">process_macros_r</a>(&amp;mac, raw_command,&amp;processed_command,0);
<a name="l00591"></a>00591         <span class="keywordflow">if</span>(processed_command==NULL){
<a name="l00592"></a>00592                 <a class="code" href="macros_8c.html#a447a756f699af137cdd85eb4caa4d0e5">clear_volatile_macros_r</a>(&amp;mac);
<a name="l00593"></a>00593                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Processed check command for service &#39;%s&#39; on host &#39;%s&#39; was NULL - aborting.\n&quot;</span>,svc-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,svc-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>);
<a name="l00594"></a>00594                 <span class="keywordflow">if</span>(preferred_time)
<a name="l00595"></a>00595                         *preferred_time+=(svc-&gt;<a class="code" href="structservice__struct.html#a54179e5f4bb721f91c11e943a1f9f32c">check_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>);
<a name="l00596"></a>00596                 svc-&gt;latency=old_latency;
<a name="l00597"></a>00597                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(raw_command);
<a name="l00598"></a>00598                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l00599"></a>00599         }
<a name="l00600"></a>00600 
<a name="l00601"></a>00601         <span class="comment">/* get the command start time */</span>
<a name="l00602"></a>00602         gettimeofday(&amp;start_time,NULL);
<a name="l00603"></a>00603 
<a name="l00604"></a>00604         <span class="comment">/* increment number of service checks that are currently running... */</span>
<a name="l00605"></a>00605         <a class="code" href="checks_8c.html#a01f1a65871aff67ece2c26f543691083">currently_running_service_checks</a>++;
<a name="l00606"></a>00606 
<a name="l00607"></a>00607         <span class="comment">/* set the execution flag */</span>
<a name="l00608"></a>00608         svc-&gt;is_executing=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00609"></a>00609 
<a name="l00610"></a>00610         <span class="comment">/* start save check info */</span>
<a name="l00611"></a>00611         check_result_info.<a class="code" href="structcheck__result__struct.html#aab46f07f58a12b95f55f483637e2f937">object_check_type</a>=<a class="code" href="icinga_8h.html#ade4e796d45e5c3ffcee218cd4c2d5469">SERVICE_CHECK</a>;
<a name="l00612"></a>00612         check_result_info.<a class="code" href="structcheck__result__struct.html#a06a6efffb27b304e4b983b5cfab66851">check_type</a>=<a class="code" href="include_2common_8h.html#ae9ca0dbecc9fa615f650f349a9b410f2">SERVICE_CHECK_ACTIVE</a>;
<a name="l00613"></a>00613         check_result_info.<a class="code" href="structcheck__result__struct.html#ae0708b0eaec7709912168f85c5ba503a">check_options</a>=check_options;
<a name="l00614"></a>00614         check_result_info.<a class="code" href="structcheck__result__struct.html#ac3d4cf6179d9c2b29f98be9f2ca2941a">scheduled_check</a>=scheduled_check;
<a name="l00615"></a>00615         check_result_info.<a class="code" href="structcheck__result__struct.html#a55af6097dbb3c68a52f1bfa4027f37f5">reschedule_check</a>=reschedule_check;
<a name="l00616"></a>00616         check_result_info.<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>=<a class="code" href="cmd_8c.html#ad20e89e0c86aa812dc3a8e2fb7b5777b">start_time</a>;
<a name="l00617"></a>00617         check_result_info.<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>=<a class="code" href="cmd_8c.html#ad20e89e0c86aa812dc3a8e2fb7b5777b">start_time</a>;
<a name="l00618"></a>00618         check_result_info.<a class="code" href="structcheck__result__struct.html#a8fd6dc8e62fa817f85971b929d2a50ea">early_timeout</a>=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00619"></a>00619         check_result_info.<a class="code" href="structcheck__result__struct.html#acdf1b91b61c379a2e1c42421ac1f76b8">exited_ok</a>=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00620"></a>00620         check_result_info.<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>=<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>;
<a name="l00621"></a>00621         check_result_info.<a class="code" href="structcheck__result__struct.html#aabb1b6da0b348c809c7139c5e32938e0">output</a>=NULL;
<a name="l00622"></a>00622 
<a name="l00623"></a>00623 <span class="preprocessor">#ifdef USE_EVENT_BROKER</span>
<a name="l00624"></a>00624 <span class="preprocessor"></span>        <span class="comment">/* send data to event broker */</span>
<a name="l00625"></a>00625         neb_result=<a class="code" href="broker_8h.html#af573dd59adab1dbd5041b80ae07b6245">broker_service_check</a>(<a class="code" href="broker_8h.html#a2ac49efd629c781c203fa6be6aee65e2">NEBTYPE_SERVICECHECK_INITIATE</a>,<a class="code" href="broker_8h.html#ae7b50b735fa9d5baf42ab19525993635">NEBFLAG_NONE</a>,<a class="code" href="broker_8h.html#a2e1afa1e543c76a752561dbc9eb38d65">NEBATTR_NONE</a>,svc,<a class="code" href="include_2common_8h.html#ae9ca0dbecc9fa615f650f349a9b410f2">SERVICE_CHECK_ACTIVE</a>,start_time,end_time,svc-&gt;<a class="code" href="structservice__struct.html#a979cc671dd6fd908e92d232a5e2458ca">service_check_command</a>,svc-&gt;latency,0.0,<a class="code" href="checks_8c.html#aae037924192ae115d84c3aa5c42502db">service_check_timeout</a>,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,0,processed_command,NULL);
<a name="l00626"></a>00626 
<a name="l00627"></a>00627         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(svc-&gt;<a class="code" href="structservice__struct.html#aecb6488864065aed8282fb78b5fe6d2f">processed_command</a>);
<a name="l00628"></a>00628         svc-&gt;<a class="code" href="structservice__struct.html#aecb6488864065aed8282fb78b5fe6d2f">processed_command</a>=strdup(processed_command);
<a name="l00629"></a>00629 
<a name="l00630"></a>00630         <span class="comment">/* neb module wants to override the service check - perhaps it will check the service itself */</span>
<a name="l00631"></a>00631         <span class="keywordflow">if</span>(neb_result==<a class="code" href="neberrors_8h.html#a239dad95dfec616d6591de5368fb78f4">NEBERROR_CALLBACKOVERRIDE</a>){
<a name="l00632"></a>00632                 <a class="code" href="macros_8c.html#a447a756f699af137cdd85eb4caa4d0e5">clear_volatile_macros_r</a>(&amp;mac);
<a name="l00633"></a>00633                 svc-&gt;latency=old_latency;
<a name="l00634"></a>00634                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(processed_command);
<a name="l00635"></a>00635                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(raw_command);
<a name="l00636"></a>00636                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00637"></a>00637         }
<a name="l00638"></a>00638 <span class="preprocessor">#endif</span>
<a name="l00639"></a>00639 <span class="preprocessor"></span>
<a name="l00640"></a>00640         <span class="comment">/* open a temp file for storing check output */</span>
<a name="l00641"></a>00641         old_umask=umask(new_umask);
<a name="l00642"></a>00642         <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=<a class="code" href="snprintf_8c.html#a28a648dd20504ebc0c03623a28d82c93">asprintf</a>(&amp;output_file,<span class="stringliteral">&quot;%s/checkXXXXXX&quot;</span>,<a class="code" href="checks_8c.html#ac633a7a52422f2b1d56ed02a56dc8fcf">temp_path</a>);
<a name="l00643"></a>00643         check_result_info.<a class="code" href="structcheck__result__struct.html#aec5b08d38761af6fe89eef17bd831f53">output_file_fd</a>=mkstemp(output_file);
<a name="l00644"></a>00644         <span class="keywordflow">if</span>(check_result_info.<a class="code" href="structcheck__result__struct.html#aec5b08d38761af6fe89eef17bd831f53">output_file_fd</a>&gt;=0)
<a name="l00645"></a>00645                 check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>=fdopen(check_result_info.<a class="code" href="structcheck__result__struct.html#aec5b08d38761af6fe89eef17bd831f53">output_file_fd</a>,<span class="stringliteral">&quot;w&quot;</span>);
<a name="l00646"></a>00646         <span class="keywordflow">else</span>{
<a name="l00647"></a>00647                 check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>=NULL;
<a name="l00648"></a>00648                 check_result_info.<a class="code" href="structcheck__result__struct.html#aec5b08d38761af6fe89eef17bd831f53">output_file_fd</a>=-1;
<a name="l00649"></a>00649         }
<a name="l00650"></a>00650         umask(old_umask);
<a name="l00651"></a>00651 
<a name="l00652"></a>00652         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>|<a class="code" href="logging_8h.html#addc28db449ac01a4e1e04a0646ae70bd">DEBUGL_IPC</a>,1,<span class="stringliteral">&quot;Check result output will be written to &#39;%s&#39; (fd=%d)\n&quot;</span>,output_file,check_result_info.<a class="code" href="structcheck__result__struct.html#aec5b08d38761af6fe89eef17bd831f53">output_file_fd</a>);
<a name="l00653"></a>00653 
<a name="l00654"></a>00654 
<a name="l00655"></a>00655         <span class="comment">/* finish save check info */</span>
<a name="l00656"></a>00656         check_result_info.<a class="code" href="structcheck__result__struct.html#a8e0609d9dd4bf77156c9e967ab8c8924">host_name</a>=(<span class="keywordtype">char</span> *)strdup(svc-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>);
<a name="l00657"></a>00657         check_result_info.<a class="code" href="structcheck__result__struct.html#a3cd7e3c42f1bce1761e6c84b76588877">service_description</a>=(<span class="keywordtype">char</span> *)strdup(svc-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>);
<a name="l00658"></a>00658         check_result_info.<a class="code" href="structcheck__result__struct.html#a1ef7b671552d6ed92421a522c4127bf6">output_file</a>=(check_result_info.<a class="code" href="structcheck__result__struct.html#aec5b08d38761af6fe89eef17bd831f53">output_file_fd</a>&lt;0 || output_file==NULL)?NULL:strdup(output_file);
<a name="l00659"></a>00659 
<a name="l00660"></a>00660         <span class="comment">/* free memory */</span>
<a name="l00661"></a>00661         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(output_file);
<a name="l00662"></a>00662 
<a name="l00663"></a>00663         <span class="comment">/* write start of check result file */</span>
<a name="l00664"></a>00664         <span class="comment">/* if things go really bad later on down the line, the user will at least have a partial file to help debug missing output results */</span>
<a name="l00665"></a>00665         <span class="keywordflow">if</span>(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>){
<a name="l00666"></a>00666 
<a name="l00667"></a>00667                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;### Active Check Result File ###\n&quot;</span>);
<a name="l00668"></a>00668                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;file_time=%lu\n&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)check_result_info.<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>.tv_sec);
<a name="l00669"></a>00669                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00670"></a>00670 
<a name="l00671"></a>00671                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;### Icinga Service Check Result ###\n&quot;</span>);
<a name="l00672"></a>00672                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;# Time: %s&quot;</span>,ctime(&amp;check_result_info.<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>.tv_sec));
<a name="l00673"></a>00673                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;host_name=%s\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#a8e0609d9dd4bf77156c9e967ab8c8924">host_name</a>);
<a name="l00674"></a>00674                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;service_description=%s\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#a3cd7e3c42f1bce1761e6c84b76588877">service_description</a>);
<a name="l00675"></a>00675                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;check_type=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#a06a6efffb27b304e4b983b5cfab66851">check_type</a>);
<a name="l00676"></a>00676                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;check_options=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#ae0708b0eaec7709912168f85c5ba503a">check_options</a>);
<a name="l00677"></a>00677                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;scheduled_check=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#ac3d4cf6179d9c2b29f98be9f2ca2941a">scheduled_check</a>);
<a name="l00678"></a>00678                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;reschedule_check=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#a55af6097dbb3c68a52f1bfa4027f37f5">reschedule_check</a>);
<a name="l00679"></a>00679                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;latency=%f\n&quot;</span>,svc-&gt;latency);
<a name="l00680"></a>00680                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;start_time=%lu.%lu\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>.tv_sec,check_result_info.<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>.tv_usec);
<a name="l00681"></a>00681 
<a name="l00682"></a>00682                 <span class="comment">/* flush output or it&#39;ll get written again when we fork() */</span>
<a name="l00683"></a>00683                 fflush(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>);
<a name="l00684"></a>00684         }
<a name="l00685"></a>00685 
<a name="l00686"></a>00686         <span class="comment">/* initialize dynamic buffer for storing plugin output */</span>
<a name="l00687"></a>00687         <a class="code" href="base_2utils_8c.html#aa18c99ae8f740d8ab59ef720dbbde1ad">dbuf_init</a>(&amp;checkresult_dbuf,dbuf_chunk);
<a name="l00688"></a>00688 
<a name="l00689"></a>00689 
<a name="l00690"></a>00690         <span class="comment">/* reset latency (permanent value will be set later) */</span>
<a name="l00691"></a>00691         svc-&gt;latency=old_latency;
<a name="l00692"></a>00692 
<a name="l00693"></a>00693         <span class="comment">/* update check statistics */</span>
<a name="l00694"></a>00694         <a class="code" href="base_2utils_8c.html#ac3e9d864e9a2d00cbd2b8f3cf22ea2c1">update_check_stats</a>((scheduled_check==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)?<a class="code" href="include_2common_8h.html#a546b2eec87c8243899498cdc064a8772">ACTIVE_SCHEDULED_SERVICE_CHECK_STATS</a>:<a class="code" href="include_2common_8h.html#af6ace7e599173a6c9fa4d2c17c68a42b">ACTIVE_ONDEMAND_SERVICE_CHECK_STATS</a>,start_time.tv_sec);
<a name="l00695"></a>00695 
<a name="l00696"></a>00696 <span class="preprocessor">#ifdef EMBEDDEDPERL</span>
<a name="l00697"></a>00697 <span class="preprocessor"></span>
<a name="l00698"></a>00698         <span class="comment">/* get&quot;filename&quot; component of command */</span>
<a name="l00699"></a>00699         strncpy(fname,processed_command,strcspn(processed_command,<span class="stringliteral">&quot; &quot;</span>));
<a name="l00700"></a>00700         fname[strcspn(processed_command,<span class="stringliteral">&quot; &quot;</span>)]=<span class="stringliteral">&#39;\x0&#39;</span>;
<a name="l00701"></a>00701 
<a name="l00702"></a>00702         <span class="comment">/* should we use the embedded Perl interpreter to run this script? */</span>
<a name="l00703"></a>00703         use_epn=<a class="code" href="base_2utils_8c.html#a93fc2f1f5f573f9812f65e54d8f7ed22">file_uses_embedded_perl</a>(fname);
<a name="l00704"></a>00704 
<a name="l00705"></a>00705         <span class="comment">/* if yes, do some initialization */</span>
<a name="l00706"></a>00706         <span class="keywordflow">if</span>(use_epn==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l00707"></a>00707 
<a name="l00708"></a>00708                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;** Using Embedded Perl interpreter to run service check...\n&quot;</span>);
<a name="l00709"></a>00709 
<a name="l00710"></a>00710                 args[0]=fname;
<a name="l00711"></a>00711                 args[2]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l00712"></a>00712 
<a name="l00713"></a>00713                 <span class="keywordflow">if</span>(strchr(processed_command,<span class="charliteral">&#39; &#39;</span>)==NULL){
<a name="l00714"></a>00714                         args[3]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l00715"></a>00715                 } <span class="keywordflow">else</span> {
<a name="l00716"></a>00716                         <span class="comment">/* make sure to strip leading whitespaces from args */</span>
<a name="l00717"></a>00717                         args3=processed_command+strlen(fname)+1;
<a name="l00718"></a>00718                         <span class="keywordflow">for</span> (;isspace(*args3);args3++);
<a name="l00719"></a>00719                         args[3]=args3;
<a name="l00720"></a>00720                 }
<a name="l00721"></a>00721 
<a name="l00722"></a>00722                 ENTER;
<a name="l00723"></a>00723                 SAVETMPS;
<a name="l00724"></a>00724                 PUSHMARK(SP);
<a name="l00725"></a>00725                 XPUSHs(sv_2mortal(newSVpv(args[0],0)));
<a name="l00726"></a>00726                 XPUSHs(sv_2mortal(newSVpv(args[1],0)));
<a name="l00727"></a>00727                 XPUSHs(sv_2mortal(newSVpv(args[2],0)));
<a name="l00728"></a>00728                 XPUSHs(sv_2mortal(newSVpv(args[3],0)));
<a name="l00729"></a>00729                 PUTBACK;
<a name="l00730"></a>00730 
<a name="l00731"></a>00731                 <span class="comment">/* call our perl interpreter to compile and optionally cache the command */</span>
<a name="l00732"></a>00732 
<a name="l00733"></a>00733                 call_pv(<span class="stringliteral">&quot;Embed::Persistent::eval_file&quot;</span>, G_SCALAR | G_EVAL);
<a name="l00734"></a>00734 
<a name="l00735"></a>00735                 SPAGAIN ;
<a name="l00736"></a>00736 
<a name="l00737"></a>00737                 <span class="keywordflow">if</span>( SvTRUE(ERRSV) ){
<a name="l00738"></a>00738 
<a name="l00739"></a>00739                         <span class="comment">/*</span>
<a name="l00740"></a>00740 <span class="comment">                         * if SvTRUE(ERRSV)</span>
<a name="l00741"></a>00741 <span class="comment">                         *      write failure to IPC pipe</span>
<a name="l00742"></a>00742 <span class="comment">                         *      return</span>
<a name="l00743"></a>00743 <span class="comment">                         */</span>
<a name="l00744"></a>00744 
<a name="l00745"></a>00745                         <span class="comment">/* remove the top element of the Perl stack (undef) */</span>
<a name="l00746"></a>00746                         (void) POPs ;
<a name="l00747"></a>00747 
<a name="l00748"></a>00748                         pclose_result=<a class="code" href="cgiutils_8h.html#a3a671c5b5d9122f1158555575bc0feb1">STATE_UNKNOWN</a>;
<a name="l00749"></a>00749                         perl_plugin_output=SvPVX(ERRSV);
<a name="l00750"></a>00750 
<a name="l00751"></a>00751                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Embedded Perl failed to compile %s, compile error %s - skipping plugin\n&quot;</span>,fname,perl_plugin_output);
<a name="l00752"></a>00752 
<a name="l00753"></a>00753                         <span class="comment">/* save plugin output */</span>
<a name="l00754"></a>00754                         <span class="keywordflow">if</span>(perl_plugin_output!=NULL){
<a name="l00755"></a>00755                                 temp_buffer=<a class="code" href="base_2utils_8c.html#a7122ec70de7a5439b8360b86a97071b0">escape_newlines</a>(perl_plugin_output);
<a name="l00756"></a>00756                                 <a class="code" href="base_2utils_8c.html#a302c0b1965465017578bba02a6d9e6c9">dbuf_strcat</a>(&amp;checkresult_dbuf,temp_buffer);
<a name="l00757"></a>00757                                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_buffer);
<a name="l00758"></a>00758                         }
<a name="l00759"></a>00759 
<a name="l00760"></a>00760                         <span class="comment">/* get the check finish time */</span>
<a name="l00761"></a>00761                         gettimeofday(&amp;end_time,NULL);
<a name="l00762"></a>00762 
<a name="l00763"></a>00763                         <span class="comment">/* record check result info */</span>
<a name="l00764"></a>00764                         check_result_info.<a class="code" href="structcheck__result__struct.html#acdf1b91b61c379a2e1c42421ac1f76b8">exited_ok</a>=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00765"></a>00765                         check_result_info.<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>=pclose_result;
<a name="l00766"></a>00766                         check_result_info.<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>=<a class="code" href="cmd_8c.html#a1e324d62e65642694c00de363bf8a8ba">end_time</a>;
<a name="l00767"></a>00767 
<a name="l00768"></a>00768                         <span class="comment">/* write check result to file */</span>
<a name="l00769"></a>00769                         <span class="keywordflow">if</span>(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>){
<a name="l00770"></a>00770 
<a name="l00771"></a>00771                                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;finish_time=%lu.%lu\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_sec,check_result_info.<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_usec);
<a name="l00772"></a>00772                                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;early_timeout=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#a8fd6dc8e62fa817f85971b929d2a50ea">early_timeout</a>);
<a name="l00773"></a>00773                                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;exited_ok=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#acdf1b91b61c379a2e1c42421ac1f76b8">exited_ok</a>);
<a name="l00774"></a>00774                                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;return_code=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>);
<a name="l00775"></a>00775                                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;output=%s\n&quot;</span>,(checkresult_dbuf.<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>==NULL)?<span class="stringliteral">&quot;(null)&quot;</span>:checkresult_dbuf.<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>);
<a name="l00776"></a>00776 
<a name="l00777"></a>00777                                 <span class="comment">/* close the temp file */</span>
<a name="l00778"></a>00778                                 fclose(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>);
<a name="l00779"></a>00779 
<a name="l00780"></a>00780                                 <span class="comment">/* move check result to queue directory */</span>
<a name="l00781"></a>00781                                 <a class="code" href="base_2utils_8c.html#a69855a30b12dfe19f6663bc9165bb1cf">move_check_result_to_queue</a>(check_result_info.<a class="code" href="structcheck__result__struct.html#a1ef7b671552d6ed92421a522c4127bf6">output_file</a>);
<a name="l00782"></a>00782                         }
<a name="l00783"></a>00783 
<a name="l00784"></a>00784                         <span class="comment">/* free memory */</span>
<a name="l00785"></a>00785                         <a class="code" href="base_2utils_8c.html#ad793f77d0d1041d670ff9bee3a5cda5d">dbuf_free</a>(&amp;checkresult_dbuf);
<a name="l00786"></a>00786 
<a name="l00787"></a>00787                         <span class="comment">/* free check result memory */</span>
<a name="l00788"></a>00788                         <a class="code" href="base_2utils_8c.html#a36701093a323ae768707b7a025a13e01">free_check_result</a>(&amp;check_result_info);
<a name="l00789"></a>00789 
<a name="l00790"></a>00790                         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00791"></a>00791                 }
<a name="l00792"></a>00792                 <span class="keywordflow">else</span>{
<a name="l00793"></a>00793 
<a name="l00794"></a>00794                         plugin_hndlr_cr=newSVsv(POPs);
<a name="l00795"></a>00795 
<a name="l00796"></a>00796                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Embedded Perl successfully compiled %s and returned code ref to plugin handler\n&quot;</span>,fname);
<a name="l00797"></a>00797 
<a name="l00798"></a>00798                         PUTBACK ;
<a name="l00799"></a>00799                         FREETMPS ;
<a name="l00800"></a>00800                         LEAVE ;
<a name="l00801"></a>00801                 }
<a name="l00802"></a>00802         }
<a name="l00803"></a>00803 <span class="preprocessor">#endif</span>
<a name="l00804"></a>00804 <span class="preprocessor"></span>
<a name="l00805"></a>00805         <span class="comment">/* plugin is a C plugin or a Perl plugin _without_ compilation errors */</span>
<a name="l00806"></a>00806 
<a name="l00807"></a>00807         <span class="comment">/* fork a child process */</span>
<a name="l00808"></a>00808         pid=fork();
<a name="l00809"></a>00809 
<a name="l00810"></a>00810         <span class="comment">/* an error occurred while trying to fork */</span>
<a name="l00811"></a>00811         <span class="keywordflow">if</span>(pid==-1){
<a name="l00812"></a>00812 
<a name="l00813"></a>00813                 fork_error=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00814"></a>00814 
<a name="l00815"></a>00815                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: The check of service &#39;%s&#39; on host &#39;%s&#39; could not be performed due to a fork() error: &#39;%s&#39;.  The check will be rescheduled.\n&quot;</span>,svc-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,svc-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>,strerror(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00816"></a>00816 
<a name="l00817"></a>00817                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Check of service &#39;%s&#39; on host &#39;%s&#39; could not be performed due to a fork() error: &#39;%s&#39;!\n&quot;</span>,svc-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,svc-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>,strerror(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00818"></a>00818         }
<a name="l00819"></a>00819 
<a name="l00820"></a>00820         <span class="comment">/* if we are in the child process... */</span>
<a name="l00821"></a>00821         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pid==0){
<a name="l00822"></a>00822 
<a name="l00823"></a>00823                 <span class="comment">/* set environment variables */</span>
<a name="l00824"></a>00824                 set_all_macro_environment_vars_r(&amp;mac, <a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00825"></a>00825 
<a name="l00826"></a>00826                 <span class="comment">/* ADDED 11/12/07 EG */</span>
<a name="l00827"></a>00827                 <span class="comment">/* close external command file and shut down worker thread */</span>
<a name="l00828"></a>00828                 <a class="code" href="base_2utils_8c.html#a5e15280db8f3a81c3d955260965899a0">close_command_file</a>();
<a name="l00829"></a>00829 
<a name="l00830"></a>00830                 <span class="comment">/* fork again if we&#39;re not in a large installation */</span>
<a name="l00831"></a>00831                 <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a2976ddc6ad4325c074912d0f61bb0184">child_processes_fork_twice</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l00832"></a>00832 
<a name="l00833"></a>00833                         <span class="comment">/* fork again... */</span>
<a name="l00834"></a>00834                         pid=fork();
<a name="l00835"></a>00835 
<a name="l00836"></a>00836                         <span class="comment">/* an error occurred while trying to fork again */</span>
<a name="l00837"></a>00837                         <span class="keywordflow">if</span>(pid==-1)
<a name="l00838"></a>00838                                 exit(<a class="code" href="cgiutils_8h.html#a3a671c5b5d9122f1158555575bc0feb1">STATE_UNKNOWN</a>);
<a name="l00839"></a>00839                 }
<a name="l00840"></a>00840 
<a name="l00841"></a>00841                 <span class="comment">/* the grandchild (or child if large install tweaks are enabled) process should run the service check... */</span>
<a name="l00842"></a>00842                 <span class="keywordflow">if</span>(pid==0 || <a class="code" href="checks_8c.html#a2976ddc6ad4325c074912d0f61bb0184">child_processes_fork_twice</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l00843"></a>00843 
<a name="l00844"></a>00844                         <span class="comment">/* reset signal handling */</span>
<a name="l00845"></a>00845                         <a class="code" href="base_2utils_8c.html#a1686ce1c6b73859e70249769c544999a">reset_sighandler</a>();
<a name="l00846"></a>00846 
<a name="l00847"></a>00847                         <span class="comment">/* become the process group leader */</span>
<a name="l00848"></a>00848                         setpgid(0,0);
<a name="l00849"></a>00849 
<a name="l00850"></a>00850                         <span class="comment">/* catch term signals at this process level */</span>
<a name="l00851"></a>00851                         signal(SIGTERM,<a class="code" href="base_2utils_8c.html#a2da0cda493fadb6f7040b9b078b67327">service_check_sighandler</a>);
<a name="l00852"></a>00852 
<a name="l00853"></a>00853                         <span class="comment">/* catch plugins that don&#39;t finish in a timely manner */</span>
<a name="l00854"></a>00854                         signal(SIGALRM,<a class="code" href="base_2utils_8c.html#a2da0cda493fadb6f7040b9b078b67327">service_check_sighandler</a>);
<a name="l00855"></a>00855                         alarm(<a class="code" href="checks_8c.html#aae037924192ae115d84c3aa5c42502db">service_check_timeout</a>);
<a name="l00856"></a>00856 
<a name="l00857"></a>00857                         <span class="comment">/* disable rotation of the debug file */</span>
<a name="l00858"></a>00858                         <a class="code" href="checks_8c.html#ac919486c0bf77cab5e1ec2f0aba1803f">max_debug_file_size</a>=0L;
<a name="l00859"></a>00859 
<a name="l00860"></a>00860                         <span class="comment">/******** BEGIN EMBEDDED PERL INTERPRETER EXECUTION ********/</span>
<a name="l00861"></a>00861 <span class="preprocessor">#ifdef EMBEDDEDPERL</span>
<a name="l00862"></a>00862 <span class="preprocessor"></span>                        <span class="keywordflow">if</span>(use_epn==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l00863"></a>00863 
<a name="l00864"></a>00864                                 <span class="comment">/* execute our previously compiled script - from call_pv(&quot;Embed::Persistent::eval_file&quot;,..) */</span>
<a name="l00865"></a>00865                                 <span class="comment">/* NB. args[2] is _now_ a code ref (to the Perl subroutine corresp to the plugin) returned by eval_file() */</span>
<a name="l00866"></a>00866 
<a name="l00867"></a>00867                                 ENTER;
<a name="l00868"></a>00868                                 SAVETMPS;
<a name="l00869"></a>00869                                 PUSHMARK(SP);
<a name="l00870"></a>00870 
<a name="l00871"></a>00871                                 XPUSHs(sv_2mortal(newSVpv(args[0],0)));
<a name="l00872"></a>00872                                 XPUSHs(sv_2mortal(newSVpv(args[1],0)));
<a name="l00873"></a>00873                                 XPUSHs(plugin_hndlr_cr);
<a name="l00874"></a>00874                                 XPUSHs(sv_2mortal(newSVpv(args[3],0)));
<a name="l00875"></a>00875 
<a name="l00876"></a>00876                                 PUTBACK;
<a name="l00877"></a>00877 
<a name="l00878"></a>00878                                 count=call_pv(<span class="stringliteral">&quot;Embed::Persistent::run_package&quot;</span>, G_ARRAY);
<a name="l00879"></a>00879 
<a name="l00880"></a>00880                                 SPAGAIN;
<a name="l00881"></a>00881 
<a name="l00882"></a>00882                                 perl_plugin_output = POPpx ;
<a name="l00883"></a>00883                                 pclose_result = POPi ;
<a name="l00884"></a>00884 
<a name="l00885"></a>00885                                 <span class="comment">/* NOTE: 07/16/07 This has to be done before FREETMPS statement below, or the POPpx pointer will be invalid (Hendrik B.) */</span>
<a name="l00886"></a>00886                                 <span class="comment">/* get perl plugin output - escape newlines */</span>
<a name="l00887"></a>00887                                 <span class="keywordflow">if</span>(perl_plugin_output!=NULL){
<a name="l00888"></a>00888                                         temp_buffer=<a class="code" href="base_2utils_8c.html#a7122ec70de7a5439b8360b86a97071b0">escape_newlines</a>(perl_plugin_output);
<a name="l00889"></a>00889                                         <a class="code" href="base_2utils_8c.html#a302c0b1965465017578bba02a6d9e6c9">dbuf_strcat</a>(&amp;checkresult_dbuf,temp_buffer);
<a name="l00890"></a>00890                                         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_buffer);
<a name="l00891"></a>00891                                 }
<a name="l00892"></a>00892 
<a name="l00893"></a>00893                                 PUTBACK;
<a name="l00894"></a>00894                                 FREETMPS;
<a name="l00895"></a>00895                                 LEAVE;
<a name="l00896"></a>00896 
<a name="l00897"></a>00897                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Embedded Perl ran %s: return code=%d, plugin output=%s\n&quot;</span>,fname,pclose_result,(perl_plugin_output==NULL)?<span class="stringliteral">&quot;NULL&quot;</span>:checkresult_dbuf.<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>);
<a name="l00898"></a>00898 
<a name="l00899"></a>00899                                 <span class="comment">/* reset the alarm */</span>
<a name="l00900"></a>00900                                 alarm(0);
<a name="l00901"></a>00901 
<a name="l00902"></a>00902                                 <span class="comment">/* get the check finish time */</span>
<a name="l00903"></a>00903                                 gettimeofday(&amp;end_time,NULL);
<a name="l00904"></a>00904 
<a name="l00905"></a>00905                                 <span class="comment">/* record check result info */</span>
<a name="l00906"></a>00906                                 check_result_info.<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>=pclose_result;
<a name="l00907"></a>00907                                 check_result_info.<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>=<a class="code" href="cmd_8c.html#a1e324d62e65642694c00de363bf8a8ba">end_time</a>;
<a name="l00908"></a>00908 
<a name="l00909"></a>00909                                 <span class="comment">/* write check result to file */</span>
<a name="l00910"></a>00910                                 <span class="keywordflow">if</span>(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>){
<a name="l00911"></a>00911 
<a name="l00912"></a>00912                                         fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;finish_time=%lu.%lu\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_sec,check_result_info.<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_usec);
<a name="l00913"></a>00913                                         fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;early_timeout=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#a8fd6dc8e62fa817f85971b929d2a50ea">early_timeout</a>);
<a name="l00914"></a>00914                                         fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;exited_ok=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#acdf1b91b61c379a2e1c42421ac1f76b8">exited_ok</a>);
<a name="l00915"></a>00915                                         fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;return_code=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>);
<a name="l00916"></a>00916                                         fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;output=%s\n&quot;</span>,(checkresult_dbuf.<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>==NULL)?<span class="stringliteral">&quot;(null)&quot;</span>:checkresult_dbuf.<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>);
<a name="l00917"></a>00917 
<a name="l00918"></a>00918                                         <span class="comment">/* close the temp file */</span>
<a name="l00919"></a>00919                                         fclose(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>);
<a name="l00920"></a>00920 
<a name="l00921"></a>00921                                         <span class="comment">/* move check result to queue directory */</span>
<a name="l00922"></a>00922                                         <a class="code" href="base_2utils_8c.html#a69855a30b12dfe19f6663bc9165bb1cf">move_check_result_to_queue</a>(check_result_info.<a class="code" href="structcheck__result__struct.html#a1ef7b671552d6ed92421a522c4127bf6">output_file</a>);
<a name="l00923"></a>00923                                 }
<a name="l00924"></a>00924 
<a name="l00925"></a>00925                                 <span class="comment">/* free memory */</span>
<a name="l00926"></a>00926                                 <a class="code" href="base_2utils_8c.html#ad793f77d0d1041d670ff9bee3a5cda5d">dbuf_free</a>(&amp;checkresult_dbuf);
<a name="l00927"></a>00927 
<a name="l00928"></a>00928                                 <span class="comment">/* free check result memory */</span>
<a name="l00929"></a>00929                                 <a class="code" href="base_2utils_8c.html#a36701093a323ae768707b7a025a13e01">free_check_result</a>(&amp;check_result_info);
<a name="l00930"></a>00930 
<a name="l00931"></a>00931                                 <span class="comment">/* return with plugin exit status - not really necessary... */</span>
<a name="l00932"></a>00932                                 _exit(pclose_result);
<a name="l00933"></a>00933                         }
<a name="l00934"></a>00934 <span class="preprocessor">#endif</span>
<a name="l00935"></a>00935 <span class="preprocessor"></span>                        <span class="comment">/******** END EMBEDDED PERL INTERPRETER EXECUTION ********/</span>
<a name="l00936"></a>00936 
<a name="l00937"></a>00937 
<a name="l00938"></a>00938                         <span class="comment">/* run the plugin check command */</span>
<a name="l00939"></a>00939                         pclose_result=run_check(processed_command,&amp;checkresult_dbuf);
<a name="l00940"></a>00940 
<a name="l00941"></a>00941                         <span class="comment">/* reset the alarm */</span>
<a name="l00942"></a>00942                         alarm(0);
<a name="l00943"></a>00943 
<a name="l00944"></a>00944                         <span class="comment">/* get the check finish time */</span>
<a name="l00945"></a>00945                         gettimeofday(&amp;end_time,NULL);
<a name="l00946"></a>00946 
<a name="l00947"></a>00947                         <span class="comment">/* record check result info */</span>
<a name="l00948"></a>00948                         check_result_info.<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>=<a class="code" href="cmd_8c.html#a1e324d62e65642694c00de363bf8a8ba">end_time</a>;
<a name="l00949"></a>00949                         check_result_info.<a class="code" href="structcheck__result__struct.html#a8fd6dc8e62fa817f85971b929d2a50ea">early_timeout</a>=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00950"></a>00950 
<a name="l00951"></a>00951                         <span class="comment">/* test for execution error */</span>
<a name="l00952"></a>00952                         <span class="keywordflow">if</span>(pclose_result==-1){
<a name="l00953"></a>00953                                 pclose_result=<a class="code" href="cgiutils_8h.html#a3a671c5b5d9122f1158555575bc0feb1">STATE_UNKNOWN</a>;
<a name="l00954"></a>00954                                 check_result_info.<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>=<a class="code" href="cgiutils_8h.html#a19827c887254e66b983c3269a42562bc">STATE_CRITICAL</a>;
<a name="l00955"></a>00955                                 check_result_info.<a class="code" href="structcheck__result__struct.html#acdf1b91b61c379a2e1c42421ac1f76b8">exited_ok</a>=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00956"></a>00956                         }
<a name="l00957"></a>00957                         <span class="keywordflow">else</span>{
<a name="l00958"></a>00958                                 <span class="keywordflow">if</span>(<a class="code" href="config_8h.html#a7a9fed9392a51acd68e5f469e63f7961">WEXITSTATUS</a>(pclose_result)==0 &amp;&amp; WIFSIGNALED(pclose_result))
<a name="l00959"></a>00959                                         check_result_info.<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>=128+WTERMSIG(pclose_result);
<a name="l00960"></a>00960                                 <span class="keywordflow">else</span>
<a name="l00961"></a>00961                                         check_result_info.<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>=<a class="code" href="config_8h.html#a7a9fed9392a51acd68e5f469e63f7961">WEXITSTATUS</a>(pclose_result);
<a name="l00962"></a>00962                         }
<a name="l00963"></a>00963 
<a name="l00964"></a>00964                         <span class="comment">/* write check result to file */</span>
<a name="l00965"></a>00965                         <span class="keywordflow">if</span>(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>){
<a name="l00966"></a>00966 
<a name="l00967"></a>00967                                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;finish_time=%lu.%lu\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_sec,check_result_info.<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_usec);
<a name="l00968"></a>00968                                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;early_timeout=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#a8fd6dc8e62fa817f85971b929d2a50ea">early_timeout</a>);
<a name="l00969"></a>00969                                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;exited_ok=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#acdf1b91b61c379a2e1c42421ac1f76b8">exited_ok</a>);
<a name="l00970"></a>00970                                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;return_code=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>);
<a name="l00971"></a>00971                                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;output=%s\n&quot;</span>,(checkresult_dbuf.<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>==NULL)?<span class="stringliteral">&quot;(null)&quot;</span>:checkresult_dbuf.<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>);
<a name="l00972"></a>00972 
<a name="l00973"></a>00973                                 <span class="comment">/* close the temp file */</span>
<a name="l00974"></a>00974                                 fclose(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>);
<a name="l00975"></a>00975 
<a name="l00976"></a>00976                                 <span class="comment">/* move check result to queue directory */</span>
<a name="l00977"></a>00977                                 <a class="code" href="base_2utils_8c.html#a69855a30b12dfe19f6663bc9165bb1cf">move_check_result_to_queue</a>(check_result_info.<a class="code" href="structcheck__result__struct.html#a1ef7b671552d6ed92421a522c4127bf6">output_file</a>);
<a name="l00978"></a>00978                         }
<a name="l00979"></a>00979 
<a name="l00980"></a>00980                         <span class="comment">/* free memory */</span>
<a name="l00981"></a>00981                         <a class="code" href="base_2utils_8c.html#ad793f77d0d1041d670ff9bee3a5cda5d">dbuf_free</a>(&amp;checkresult_dbuf);
<a name="l00982"></a>00982                         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(raw_command);
<a name="l00983"></a>00983                         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(processed_command);
<a name="l00984"></a>00984 
<a name="l00985"></a>00985                         <span class="comment">/* free check result memory */</span>
<a name="l00986"></a>00986                         <a class="code" href="base_2utils_8c.html#a36701093a323ae768707b7a025a13e01">free_check_result</a>(&amp;check_result_info);
<a name="l00987"></a>00987 
<a name="l00988"></a>00988                         <span class="comment">/* return with plugin exit status - not really necessary... */</span>
<a name="l00989"></a>00989                         _exit(pclose_result);
<a name="l00990"></a>00990                 }
<a name="l00991"></a>00991 
<a name="l00992"></a>00992                 <span class="comment">/* NOTE: this code is never reached if large install tweaks are enabled... */</span>
<a name="l00993"></a>00993 
<a name="l00994"></a>00994                 <span class="comment">/* unset environment variables */</span>
<a name="l00995"></a>00995                 set_all_macro_environment_vars_r(&amp;mac, <a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00996"></a>00996 
<a name="l00997"></a>00997                 <span class="comment">/* free allocated memory */</span>
<a name="l00998"></a>00998                 <span class="comment">/* this needs to be done last, so we don&#39;t free memory for variables before they&#39;re used above */</span>
<a name="l00999"></a>00999                 <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a73881c51ba02b6ea241ab71a8e2c354c">free_child_process_memory</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01000"></a>01000                         <a class="code" href="base_2utils_8c.html#ae49e5228711e021ca4ea8da8e4d2f447">free_memory</a>(&amp;mac);
<a name="l01001"></a>01001 
<a name="l01002"></a>01002                 <span class="comment">/* parent exits immediately - grandchild process is inherited by the INIT process, so we have no zombie problem... */</span>
<a name="l01003"></a>01003                 _exit(<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>);
<a name="l01004"></a>01004         }
<a name="l01005"></a>01005 
<a name="l01006"></a>01006         <span class="comment">/* else the parent should wait for the first child to return... */</span>
<a name="l01007"></a>01007         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pid&gt;0){
<a name="l01008"></a>01008                 <a class="code" href="macros_8c.html#a447a756f699af137cdd85eb4caa4d0e5">clear_volatile_macros_r</a>(&amp;mac);
<a name="l01009"></a>01009 
<a name="l01010"></a>01010                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Service check is executing in child process (pid=%lu)\n&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)pid);
<a name="l01011"></a>01011 
<a name="l01012"></a>01012                 <span class="comment">/* parent should close output file */</span>
<a name="l01013"></a>01013                 <span class="keywordflow">if</span>(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>)
<a name="l01014"></a>01014                         fclose(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>);
<a name="l01015"></a>01015 
<a name="l01016"></a>01016                 <span class="comment">/* should this be done in first child process (after spawning grandchild) as well? */</span>
<a name="l01017"></a>01017                 <span class="comment">/* free memory allocated for IPC functionality */</span>
<a name="l01018"></a>01018                 <a class="code" href="base_2utils_8c.html#a36701093a323ae768707b7a025a13e01">free_check_result</a>(&amp;check_result_info);
<a name="l01019"></a>01019 
<a name="l01020"></a>01020                 <span class="comment">/* free memory */</span>
<a name="l01021"></a>01021                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(raw_command);
<a name="l01022"></a>01022                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(processed_command);
<a name="l01023"></a>01023 
<a name="l01024"></a>01024                 <span class="comment">/* wait for the first child to return */</span>
<a name="l01025"></a>01025                 <span class="comment">/* don&#39;t do this if large install tweaks are enabled - we&#39;ll clean up children in event loop */</span>
<a name="l01026"></a>01026                 <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a2976ddc6ad4325c074912d0f61bb0184">child_processes_fork_twice</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01027"></a>01027                         wait_result=waitpid(pid,NULL,0);
<a name="l01028"></a>01028         }
<a name="l01029"></a>01029 
<a name="l01030"></a>01030         <span class="comment">/* see if we were able to run the check... */</span>
<a name="l01031"></a>01031         <span class="keywordflow">if</span>(fork_error==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01032"></a>01032                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l01033"></a>01033 
<a name="l01034"></a>01034         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l01035"></a>01035 }
<a name="l01036"></a>01036 
<a name="l01037"></a>01037 
<a name="l01038"></a>01038 
<a name="l01039"></a>01039 <span class="comment">/* handles asynchronous service check results */</span>
<a name="l01040"></a><a class="code" href="icinga_8h.html#a7f50a30826deb72b6e1619d0be474bd4">01040</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#ac1f1f0f4f9554acef259385eae86aa9a">handle_async_service_check_result</a>(<a class="code" href="structservice__struct.html">service</a> *temp_service, <a class="code" href="structcheck__result__struct.html">check_result</a> *queued_check_result){
<a name="l01041"></a>01041         <a class="code" href="structhost__struct.html">host</a> *temp_host=NULL;
<a name="l01042"></a>01042         time_t next_service_check=0L;
<a name="l01043"></a>01043         time_t preferred_time=0L;
<a name="l01044"></a>01044         time_t next_valid_time=0L;
<a name="l01045"></a>01045         <span class="keywordtype">int</span> reschedule_check=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01046"></a>01046         <span class="keywordtype">int</span> state_change=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01047"></a>01047         <span class="keywordtype">int</span> hard_state_change=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01048"></a>01048         <span class="keywordtype">int</span> first_host_check_initiated=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01049"></a>01049         <span class="keywordtype">int</span> route_result=<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>;
<a name="l01050"></a>01050         time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>=0L;
<a name="l01051"></a>01051         <span class="keywordtype">int</span> state_was_logged=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01052"></a>01052         <span class="keywordtype">char</span> *old_plugin_output=NULL;
<a name="l01053"></a>01053         <span class="keywordtype">char</span> *temp_plugin_output=NULL;
<a name="l01054"></a>01054         <span class="keywordtype">char</span> *temp_ptr=NULL;
<a name="l01055"></a>01055         <a class="code" href="structservicedependency__struct.html">servicedependency</a> *temp_dependency=NULL;
<a name="l01056"></a>01056         <a class="code" href="structobjectlist__struct.html">objectlist</a> *check_servicelist=NULL;
<a name="l01057"></a>01057         <a class="code" href="structobjectlist__struct.html">objectlist</a> *servicelist_item=NULL;
<a name="l01058"></a>01058         <a class="code" href="structservice__struct.html">service</a> *master_service=NULL;
<a name="l01059"></a>01059         <span class="keywordtype">int</span> run_async_check=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01060"></a>01060         <span class="keywordtype">int</span> state_changes_use_cached_state=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;  <span class="comment">/* TODO - 09/23/07 move this to a global variable */</span>
<a name="l01061"></a>01061         <span class="keywordtype">int</span> flapping_check_done=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01062"></a>01062         <span class="keywordtype">void</span> *ptr=NULL;
<a name="l01063"></a>01063 
<a name="l01064"></a>01064 
<a name="l01065"></a>01065         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;handle_async_service_check_result()\n&quot;</span>);
<a name="l01066"></a>01066 
<a name="l01067"></a>01067         <span class="comment">/* make sure we have what we need */</span>
<a name="l01068"></a>01068         <span class="keywordflow">if</span>(temp_service==NULL || queued_check_result==NULL)
<a name="l01069"></a>01069                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l01070"></a>01070 
<a name="l01071"></a>01071         <span class="comment">/* get the current time */</span>
<a name="l01072"></a>01072         time(&amp;current_time);
<a name="l01073"></a>01073 
<a name="l01074"></a>01074         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;** Handling check result for service &#39;%s&#39; on host &#39;%s&#39;...\n&quot;</span>,temp_service-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,temp_service-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>);
<a name="l01075"></a>01075         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;HOST: %s, SERVICE: %s, CHECK TYPE: %s, OPTIONS: %d, SCHEDULED: %s, RESCHEDULE: %s, EXITED OK: %s, RETURN CODE: %d, OUTPUT: %s\n&quot;</span>,temp_service-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>,temp_service-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a06a6efffb27b304e4b983b5cfab66851">check_type</a>==<a class="code" href="include_2common_8h.html#ae9ca0dbecc9fa615f650f349a9b410f2">SERVICE_CHECK_ACTIVE</a>)?<span class="stringliteral">&quot;Active&quot;</span>:<span class="stringliteral">&quot;Passive&quot;</span>,queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#ae0708b0eaec7709912168f85c5ba503a">check_options</a>,(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#ac3d4cf6179d9c2b29f98be9f2ca2941a">scheduled_check</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)?<span class="stringliteral">&quot;Yes&quot;</span>:<span class="stringliteral">&quot;No&quot;</span>,(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a55af6097dbb3c68a52f1bfa4027f37f5">reschedule_check</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)?<span class="stringliteral">&quot;Yes&quot;</span>:<span class="stringliteral">&quot;No&quot;</span>,(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#acdf1b91b61c379a2e1c42421ac1f76b8">exited_ok</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)?<span class="stringliteral">&quot;Yes&quot;</span>:<span class="stringliteral">&quot;No&quot;</span>,queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>,queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#aabb1b6da0b348c809c7139c5e32938e0">output</a>);
<a name="l01076"></a>01076 
<a name="l01077"></a>01077         <span class="comment">/* decrement the number of service checks still out there... */</span>
<a name="l01078"></a>01078         <span class="keywordflow">if</span>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a06a6efffb27b304e4b983b5cfab66851">check_type</a>==<a class="code" href="include_2common_8h.html#ae9ca0dbecc9fa615f650f349a9b410f2">SERVICE_CHECK_ACTIVE</a> &amp;&amp; <a class="code" href="checks_8c.html#a01f1a65871aff67ece2c26f543691083">currently_running_service_checks</a>&gt;0)
<a name="l01079"></a>01079                 <a class="code" href="checks_8c.html#a01f1a65871aff67ece2c26f543691083">currently_running_service_checks</a>--;
<a name="l01080"></a>01080 
<a name="l01081"></a>01081         <span class="comment">/* skip this service check results if its passive and we aren&#39;t accepting passive check results */</span>
<a name="l01082"></a>01082         <span class="keywordflow">if</span>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a06a6efffb27b304e4b983b5cfab66851">check_type</a>==<a class="code" href="include_2common_8h.html#a1e83cffcb80bc89c63f26b84442c87cf">SERVICE_CHECK_PASSIVE</a>){
<a name="l01083"></a>01083                 <span class="keywordflow">if</span>(<a class="code" href="broker_8c.html#ac2cfe61062d4e6db6236a829ee16864a">accept_passive_service_checks</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l01084"></a>01084                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Discarding passive service check result because passive service checks are disabled globally.\n&quot;</span>);
<a name="l01085"></a>01085                         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l01086"></a>01086                 }
<a name="l01087"></a>01087                 <span class="keywordflow">if</span>(temp_service-&gt;<a class="code" href="structservice__struct.html#a42f6c98e6316fdca156aec717f4b547c">accept_passive_service_checks</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l01088"></a>01088                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Discarding passive service check result because passive checks are disabled for this service.\n&quot;</span>);
<a name="l01089"></a>01089                         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l01090"></a>01090                 }
<a name="l01091"></a>01091         }
<a name="l01092"></a>01092 
<a name="l01093"></a>01093         <span class="comment">/* clear the freshening flag (it would have been set if this service was determined to be stale) */</span>
<a name="l01094"></a>01094         <span class="keywordflow">if</span>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#ae0708b0eaec7709912168f85c5ba503a">check_options</a> &amp; <a class="code" href="include_2common_8h.html#a8c0fa51fb6ee777f4e21f2210f948e2a">CHECK_OPTION_FRESHNESS_CHECK</a>)
<a name="l01095"></a>01095                 temp_service-&gt;is_being_freshened=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01096"></a>01096 
<a name="l01097"></a>01097         <span class="comment">/* clear the execution flag if this was an active check */</span>
<a name="l01098"></a>01098         <span class="keywordflow">if</span>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a06a6efffb27b304e4b983b5cfab66851">check_type</a>==<a class="code" href="include_2common_8h.html#ae9ca0dbecc9fa615f650f349a9b410f2">SERVICE_CHECK_ACTIVE</a>)
<a name="l01099"></a>01099                 temp_service-&gt;is_executing=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01100"></a>01100 
<a name="l01101"></a>01101         <span class="comment">/* DISCARD INVALID FRESHNESS CHECK RESULTS */</span>
<a name="l01102"></a>01102         <span class="comment">/* If a services goes stale, Icinga will initiate a forced check in order to freshen it.  There is a race condition whereby a passive check</span>
<a name="l01103"></a>01103 <span class="comment">           could arrive between the 1) initiation of the forced check and 2) the time when the forced check result is processed here.  This would</span>
<a name="l01104"></a>01104 <span class="comment">           make the service fresh again, so we do a quick check to make sure the service is still stale before we accept the check result. */</span>
<a name="l01105"></a>01105         <span class="keywordflow">if</span>((queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#ae0708b0eaec7709912168f85c5ba503a">check_options</a> &amp; <a class="code" href="include_2common_8h.html#a8c0fa51fb6ee777f4e21f2210f948e2a">CHECK_OPTION_FRESHNESS_CHECK</a>) &amp;&amp; <a class="code" href="checks_8c.html#a6e7cdf40c6e908a95798ede828f0ec00">is_service_result_fresh</a>(temp_service,current_time,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l01106"></a>01106                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Discarding service freshness check result because the service is currently fresh (race condition avoided).\n&quot;</span>);
<a name="l01107"></a>01107                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l01108"></a>01108         }
<a name="l01109"></a>01109 
<a name="l01110"></a>01110         <span class="comment">/* check latency is passed to us */</span>
<a name="l01111"></a>01111         temp_service-&gt;latency=queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a2e6d8e1efd138ab3970cb6f0233f7eb4">latency</a>;
<a name="l01112"></a>01112 
<a name="l01113"></a>01113         <span class="comment">/* update the execution time for this check (millisecond resolution) */</span>
<a name="l01114"></a>01114         temp_service-&gt;execution_time=(double)((<span class="keywordtype">double</span>)(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_sec-queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>.tv_sec)+(<span class="keywordtype">double</span>)((queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_usec-queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>.tv_usec)/1000.0)/1000.0);
<a name="l01115"></a>01115         <span class="keywordflow">if</span>(temp_service-&gt;execution_time&lt;0.0)
<a name="l01116"></a>01116                 temp_service-&gt;execution_time=0.0;
<a name="l01117"></a>01117 
<a name="l01118"></a>01118         <span class="comment">/* get the last check time */</span>
<a name="l01119"></a>01119         temp_service-&gt;last_check=queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>.tv_sec;
<a name="l01120"></a>01120 
<a name="l01121"></a>01121         <span class="comment">/* was this check passive or active? */</span>
<a name="l01122"></a>01122         temp_service-&gt;check_type=(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a06a6efffb27b304e4b983b5cfab66851">check_type</a>==<a class="code" href="include_2common_8h.html#ae9ca0dbecc9fa615f650f349a9b410f2">SERVICE_CHECK_ACTIVE</a>)?<a class="code" href="include_2common_8h.html#ae9ca0dbecc9fa615f650f349a9b410f2">SERVICE_CHECK_ACTIVE</a>:<a class="code" href="include_2common_8h.html#a1e83cffcb80bc89c63f26b84442c87cf">SERVICE_CHECK_PASSIVE</a>;
<a name="l01123"></a>01123 
<a name="l01124"></a>01124         <span class="comment">/* update check statistics for passive checks */</span>
<a name="l01125"></a>01125         <span class="keywordflow">if</span>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a06a6efffb27b304e4b983b5cfab66851">check_type</a>==<a class="code" href="include_2common_8h.html#a1e83cffcb80bc89c63f26b84442c87cf">SERVICE_CHECK_PASSIVE</a>)
<a name="l01126"></a>01126                 <a class="code" href="base_2utils_8c.html#ac3e9d864e9a2d00cbd2b8f3cf22ea2c1">update_check_stats</a>(<a class="code" href="include_2common_8h.html#a9cebdd4f41cec404226a0b23ce0ea063">PASSIVE_SERVICE_CHECK_STATS</a>,queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>.tv_sec);
<a name="l01127"></a>01127 
<a name="l01128"></a>01128         <span class="comment">/* should we reschedule the next service check? NOTE: This may be overridden later... */</span>
<a name="l01129"></a>01129         reschedule_check=queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a55af6097dbb3c68a52f1bfa4027f37f5">reschedule_check</a>;
<a name="l01130"></a>01130 
<a name="l01131"></a>01131         <span class="comment">/* save the old service status info */</span>
<a name="l01132"></a>01132         temp_service-&gt;last_state=temp_service-&gt;current_state;
<a name="l01133"></a>01133 
<a name="l01134"></a>01134         <span class="comment">/* save old plugin output */</span>
<a name="l01135"></a>01135         <span class="keywordflow">if</span>(temp_service-&gt;plugin_output)
<a name="l01136"></a>01136                 old_plugin_output=(<span class="keywordtype">char</span> *)strdup(temp_service-&gt;plugin_output);
<a name="l01137"></a>01137 
<a name="l01138"></a>01138         <span class="comment">/* clear the old plugin output and perf data buffers */</span>
<a name="l01139"></a>01139         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_service-&gt;plugin_output);
<a name="l01140"></a>01140         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_service-&gt;long_plugin_output);
<a name="l01141"></a>01141         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_service-&gt;perf_data);
<a name="l01142"></a>01142 
<a name="l01143"></a>01143         <span class="comment">/* if there was some error running the command, just skip it (this shouldn&#39;t be happening) */</span>
<a name="l01144"></a>01144         <span class="keywordflow">if</span>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#acdf1b91b61c379a2e1c42421ac1f76b8">exited_ok</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l01145"></a>01145 
<a name="l01146"></a>01146                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning:  Check of service &#39;%s&#39; on host &#39;%s&#39; did not exit properly!\n&quot;</span>,temp_service-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,temp_service-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>);
<a name="l01147"></a>01147 
<a name="l01148"></a>01148                 temp_service-&gt;plugin_output=(<span class="keywordtype">char</span> *)strdup(<span class="stringliteral">&quot;(Service check did not exit properly)&quot;</span>);
<a name="l01149"></a>01149 
<a name="l01150"></a>01150                 temp_service-&gt;current_state=<a class="code" href="cgiutils_8h.html#a19827c887254e66b983c3269a42562bc">STATE_CRITICAL</a>;
<a name="l01151"></a>01151         }
<a name="l01152"></a>01152 
<a name="l01153"></a>01153         <span class="comment">/* make sure the return code is within bounds */</span>
<a name="l01154"></a>01154         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>&lt;0 || queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>&gt;3){
<a name="l01155"></a>01155 
<a name="l01156"></a>01156                 <span class="keywordflow">if</span> ( queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>==126 ) {
<a name="l01157"></a>01157                         <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=<a class="code" href="snprintf_8c.html#a28a648dd20504ebc0c03623a28d82c93">asprintf</a>(&amp;temp_service-&gt;plugin_output,<span class="stringliteral">&quot;The command defined for service %s is not an executable\n&quot;</span>, queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a3cd7e3c42f1bce1761e6c84b76588877">service_description</a>);
<a name="l01158"></a>01158                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>  ( queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>==127 ) {
<a name="l01159"></a>01159                         <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=<a class="code" href="snprintf_8c.html#a28a648dd20504ebc0c03623a28d82c93">asprintf</a>(&amp;temp_service-&gt;plugin_output,<span class="stringliteral">&quot;The command defined for service %s does not exist\n&quot;</span>, queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a3cd7e3c42f1bce1761e6c84b76588877">service_description</a>);
<a name="l01160"></a>01160                 } <span class="keywordflow">else</span> {
<a name="l01161"></a>01161                         <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=<a class="code" href="snprintf_8c.html#a28a648dd20504ebc0c03623a28d82c93">asprintf</a>(&amp;temp_service-&gt;plugin_output, <span class="stringliteral">&quot;Return code of %d is out of bounds&quot;</span>, queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>);
<a name="l01162"></a>01162                 }
<a name="l01163"></a>01163                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;%s&quot;</span>,temp_service-&gt;plugin_output);
<a name="l01164"></a>01164 
<a name="l01165"></a>01165                 temp_service-&gt;current_state=<a class="code" href="cgiutils_8h.html#a19827c887254e66b983c3269a42562bc">STATE_CRITICAL</a>;
<a name="l01166"></a>01166         }
<a name="l01167"></a>01167 
<a name="l01168"></a>01168         <span class="comment">/* else the return code is okay... */</span>
<a name="l01169"></a>01169         <span class="keywordflow">else</span>{
<a name="l01170"></a>01170 
<a name="l01171"></a>01171                 <span class="comment">/* parse check output to get: (1) short output, (2) long output, (3) perf data */</span>
<a name="l01172"></a>01172                 <a class="code" href="base_2utils_8c.html#a3899c46155b515e207829a7bf127700c">parse_check_output</a>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#aabb1b6da0b348c809c7139c5e32938e0">output</a>,&amp;temp_service-&gt;plugin_output,&amp;temp_service-&gt;long_plugin_output,&amp;temp_service-&gt;perf_data,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01173"></a>01173 
<a name="l01174"></a>01174                 <span class="comment">/* make sure the plugin output isn&#39;t null */</span>
<a name="l01175"></a>01175                 <span class="keywordflow">if</span>(temp_service-&gt;plugin_output==NULL)
<a name="l01176"></a>01176                         temp_service-&gt;plugin_output=(<span class="keywordtype">char</span> *)strdup(<span class="stringliteral">&quot;(No output returned from plugin)&quot;</span>);
<a name="l01177"></a>01177 
<a name="l01178"></a>01178                 <span class="comment">/* replace semicolons in plugin output (but not performance data) with colons */</span>
<a name="l01179"></a>01179                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>((temp_ptr=temp_service-&gt;plugin_output)){
<a name="l01180"></a>01180                         <span class="keywordflow">while</span>((temp_ptr=strchr(temp_ptr,<span class="charliteral">&#39;;&#39;</span>)))
<a name="l01181"></a>01181                                 *temp_ptr=<span class="charliteral">&#39;:&#39;</span>;
<a name="l01182"></a>01182                 }
<a name="l01183"></a>01183 
<a name="l01184"></a>01184                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Parsing check output...\n&quot;</span>);
<a name="l01185"></a>01185                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Short Output: %s\n&quot;</span>,(temp_service-&gt;plugin_output==NULL)?<span class="stringliteral">&quot;NULL&quot;</span>:temp_service-&gt;plugin_output);
<a name="l01186"></a>01186                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Long Output:  %s\n&quot;</span>,(temp_service-&gt;long_plugin_output==NULL)?<span class="stringliteral">&quot;NULL&quot;</span>:temp_service-&gt;long_plugin_output);
<a name="l01187"></a>01187                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Perf Data:    %s\n&quot;</span>,(temp_service-&gt;perf_data==NULL)?<span class="stringliteral">&quot;NULL&quot;</span>:temp_service-&gt;perf_data);
<a name="l01188"></a>01188 
<a name="l01189"></a>01189                 <span class="comment">/* grab the return code */</span>
<a name="l01190"></a>01190                 temp_service-&gt;current_state=queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>;
<a name="l01191"></a>01191         }
<a name="l01192"></a>01192 
<a name="l01193"></a>01193 
<a name="l01194"></a>01194         <span class="comment">/* record the last state time */</span>
<a name="l01195"></a>01195         <span class="keywordflow">switch</span>(temp_service-&gt;current_state){
<a name="l01196"></a>01196         <span class="keywordflow">case</span> <a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>:
<a name="l01197"></a>01197                 temp_service-&gt;last_time_ok=temp_service-&gt;last_check;
<a name="l01198"></a>01198                 <span class="keywordflow">break</span>;
<a name="l01199"></a>01199         <span class="keywordflow">case</span> <a class="code" href="cgiutils_8h.html#a4b06ae38f5452bbb219bb49f0081c3f0">STATE_WARNING</a>:
<a name="l01200"></a>01200                 temp_service-&gt;last_time_warning=temp_service-&gt;last_check;
<a name="l01201"></a>01201                 <span class="keywordflow">break</span>;
<a name="l01202"></a>01202         <span class="keywordflow">case</span> <a class="code" href="cgiutils_8h.html#a3a671c5b5d9122f1158555575bc0feb1">STATE_UNKNOWN</a>:
<a name="l01203"></a>01203                 temp_service-&gt;last_time_unknown=temp_service-&gt;last_check;
<a name="l01204"></a>01204                 <span class="keywordflow">break</span>;
<a name="l01205"></a>01205         <span class="keywordflow">case</span> <a class="code" href="cgiutils_8h.html#a19827c887254e66b983c3269a42562bc">STATE_CRITICAL</a>:
<a name="l01206"></a>01206                 temp_service-&gt;last_time_critical=temp_service-&gt;last_check;
<a name="l01207"></a>01207                 <span class="keywordflow">break</span>;
<a name="l01208"></a>01208         <span class="keywordflow">default</span>:
<a name="l01209"></a>01209                 <span class="keywordflow">break</span>;
<a name="l01210"></a>01210         }
<a name="l01211"></a>01211 
<a name="l01212"></a>01212         <span class="comment">/* log passive checks - we need to do this here, as some my bypass external commands by getting dropped in checkresults dir */</span>
<a name="l01213"></a>01213         <span class="keywordflow">if</span>(temp_service-&gt;check_type==<a class="code" href="include_2common_8h.html#a1e83cffcb80bc89c63f26b84442c87cf">SERVICE_CHECK_PASSIVE</a>){
<a name="l01214"></a>01214                 <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a5e7d59bfd5de9be3ca0ab421999029ef">log_passive_checks</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01215"></a>01215                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#aae0d009469c891e6beb069d38efa7a4f">NSLOG_PASSIVE_CHECK</a>,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,<span class="stringliteral">&quot;PASSIVE SERVICE CHECK: %s;%s;%d;%s\n&quot;</span>,temp_service-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>,temp_service-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,temp_service-&gt;current_state,temp_service-&gt;plugin_output);
<a name="l01216"></a>01216         }
<a name="l01217"></a>01217 
<a name="l01218"></a>01218         <span class="comment">/* get the host that this service runs on */</span>
<a name="l01219"></a>01219         temp_host=(<a class="code" href="structhost__struct.html">host</a> *)temp_service-&gt;host_ptr;
<a name="l01220"></a>01220 
<a name="l01221"></a>01221         <span class="comment">/* if the service check was okay... */</span>
<a name="l01222"></a>01222         <span class="keywordflow">if</span>(temp_service-&gt;current_state==<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>){
<a name="l01223"></a>01223 
<a name="l01224"></a>01224                 <span class="comment">/* if the host has never been checked before, verify its status */</span>
<a name="l01225"></a>01225                 <span class="comment">/* only do this if 1) the initial state was set to non-UP or 2) the host is not scheduled to be checked soon (next 5 minutes) */</span>
<a name="l01226"></a>01226                 <span class="keywordflow">if</span>(temp_host-&gt;has_been_checked==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> &amp;&amp; (temp_host-&gt;<a class="code" href="structhost__struct.html#ae9ae984fbba7335cb3293c3f3fb6786e">initial_state</a>!=<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a> || (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)temp_host-&gt;next_check==0L || (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(temp_host-&gt;next_check-current_time)&gt;300)){
<a name="l01227"></a>01227 
<a name="l01228"></a>01228                         <span class="comment">/* set a flag to remember that we launched a check */</span>
<a name="l01229"></a>01229                         first_host_check_initiated=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01230"></a>01230 
<a name="l01231"></a>01231                         <span class="comment">/* 08/04/07 EG launch an async (parallel) host check unless aggressive host checking is enabled */</span>
<a name="l01232"></a>01232                         <span class="comment">/* previous logic was to simply run a sync (serial) host check */</span>
<a name="l01233"></a>01233                         <span class="comment">/* do NOT allow cached check results to happen here - we need the host to be checked for real... */</span>
<a name="l01234"></a>01234                         <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a8f8fcb1a4bb32b1c5fa753ac9cb48578">use_aggressive_host_checking</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01235"></a>01235                                 <a class="code" href="checks_8c.html#af1fc676aa948946ae72918ba650bb509">perform_on_demand_host_check</a>(temp_host,NULL,<a class="code" href="include_2common_8h.html#ac2e0ba323965f243a1988566a8ea53da">CHECK_OPTION_NONE</a>,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,0L);
<a name="l01236"></a>01236                         <span class="keywordflow">else</span>
<a name="l01237"></a>01237                                 <a class="code" href="checks_8c.html#ae41ccfe2cbc8c303d642f3315a0ad4d7">run_async_host_check_3x</a>(temp_host,<a class="code" href="include_2common_8h.html#ac2e0ba323965f243a1988566a8ea53da">CHECK_OPTION_NONE</a>,0.0,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,NULL,NULL);
<a name="l01238"></a>01238                 }
<a name="l01239"></a>01239         }
<a name="l01240"></a>01240 
<a name="l01241"></a>01241 
<a name="l01242"></a>01242         <span class="comment">/**** NOTE - THIS WAS MOVED UP FROM LINE 1049 BELOW TO FIX PROBLEMS WHERE CURRENT ATTEMPT VALUE WAS ACTUALLY &quot;LEADING&quot; REAL VALUE ****/</span>
<a name="l01243"></a>01243         <span class="comment">/* increment the current attempt number if this is a soft state (service was rechecked) */</span>
<a name="l01244"></a>01244         <span class="keywordflow">if</span>(temp_service-&gt;state_type==<a class="code" href="include_2common_8h.html#a74a8e12b67587cb027f5f12bb7b0fe8d">SOFT_STATE</a> &amp;&amp; (temp_service-&gt;current_attempt &lt; temp_service-&gt;<a class="code" href="structservice__struct.html#a4cc582ba5131b3efd4cfbf6389bbe938">max_attempts</a>))
<a name="l01245"></a>01245                 temp_service-&gt;current_attempt=temp_service-&gt;current_attempt+1;
<a name="l01246"></a>01246 
<a name="l01247"></a>01247 
<a name="l01248"></a>01248         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;ST: %s  CA: %d  MA: %d  CS: %d  LS: %d  LHS: %d\n&quot;</span>,(temp_service-&gt;state_type==<a class="code" href="include_2common_8h.html#a74a8e12b67587cb027f5f12bb7b0fe8d">SOFT_STATE</a>)?<span class="stringliteral">&quot;SOFT&quot;</span>:<span class="stringliteral">&quot;HARD&quot;</span>,temp_service-&gt;current_attempt,temp_service-&gt;<a class="code" href="structservice__struct.html#a4cc582ba5131b3efd4cfbf6389bbe938">max_attempts</a>,temp_service-&gt;current_state,temp_service-&gt;last_state,temp_service-&gt;last_hard_state);
<a name="l01249"></a>01249 
<a name="l01250"></a>01250         <span class="comment">/* check for a state change (either soft or hard) */</span>
<a name="l01251"></a>01251         <span class="keywordflow">if</span>(temp_service-&gt;current_state!=temp_service-&gt;last_state){
<a name="l01252"></a>01252                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Service has changed state since last check!\n&quot;</span>);
<a name="l01253"></a>01253                 state_change=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01254"></a>01254         }
<a name="l01255"></a>01255 
<a name="l01256"></a>01256         <span class="comment">/* checks for a hard state change where host was down at last service check */</span>
<a name="l01257"></a>01257         <span class="comment">/* this occurs in the case where host goes down and service current attempt gets reset to 1 */</span>
<a name="l01258"></a>01258         <span class="comment">/* if this check is not made, the service recovery looks like a soft recovery instead of a hard one */</span>
<a name="l01259"></a>01259         <span class="keywordflow">if</span>(temp_service-&gt;host_problem_at_last_check==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; temp_service-&gt;current_state==<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>){
<a name="l01260"></a>01260                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Service had a HARD STATE CHANGE!!\n&quot;</span>);
<a name="l01261"></a>01261                 hard_state_change=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01262"></a>01262         }
<a name="l01263"></a>01263 
<a name="l01264"></a>01264         <span class="comment">/* check for a &quot;normal&quot; hard state change where max check attempts is reached */</span>
<a name="l01265"></a>01265         <span class="keywordflow">if</span>(temp_service-&gt;current_attempt&gt;=temp_service-&gt;<a class="code" href="structservice__struct.html#a4cc582ba5131b3efd4cfbf6389bbe938">max_attempts</a> &amp;&amp; temp_service-&gt;current_state!=temp_service-&gt;last_hard_state){
<a name="l01266"></a>01266                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Service had a HARD STATE CHANGE!!\n&quot;</span>);
<a name="l01267"></a>01267                 hard_state_change=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01268"></a>01268         }
<a name="l01269"></a>01269 
<a name="l01270"></a>01270         <span class="comment">/* a state change occurred... */</span>
<a name="l01271"></a>01271         <span class="comment">/* reset last and next notification times and acknowledgement flag if necessary, misc other stuff */</span>
<a name="l01272"></a>01272         <span class="keywordflow">if</span>(state_change==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> || hard_state_change==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l01273"></a>01273 
<a name="l01274"></a>01274                 <span class="comment">/* reschedule the service check */</span>
<a name="l01275"></a>01275                 reschedule_check=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01276"></a>01276 
<a name="l01277"></a>01277                 <span class="comment">/* reset notification times */</span>
<a name="l01278"></a>01278                 temp_service-&gt;last_notification=(time_t)0;
<a name="l01279"></a>01279                 temp_service-&gt;next_notification=(time_t)0;
<a name="l01280"></a>01280 
<a name="l01281"></a>01281                 <span class="comment">/* reset notification suppression option */</span>
<a name="l01282"></a>01282                 temp_service-&gt;no_more_notifications=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01283"></a>01283 
<a name="l01284"></a>01284                 <span class="keywordflow">if</span>(temp_service-&gt;acknowledgement_type==<a class="code" href="include_2common_8h.html#a1bcd09fb6b178a332a4f438d4e929db5">ACKNOWLEDGEMENT_NORMAL</a>){
<a name="l01285"></a>01285 
<a name="l01286"></a>01286                         temp_service-&gt;problem_has_been_acknowledged=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01287"></a>01287                         temp_service-&gt;acknowledgement_type=<a class="code" href="include_2common_8h.html#a744bbe5aaf72c3187a55ba660cf37142">ACKNOWLEDGEMENT_NONE</a>;
<a name="l01288"></a>01288 
<a name="l01289"></a>01289                         <span class="comment">/* remove any non-persistant comments associated with the ack */</span>
<a name="l01290"></a>01290                         delete_service_acknowledgement_comments(temp_service);
<a name="l01291"></a>01291                 }
<a name="l01292"></a>01292                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(temp_service-&gt;acknowledgement_type==<a class="code" href="include_2common_8h.html#a20d768ff427f46df3c3c1abbd31a081e">ACKNOWLEDGEMENT_STICKY</a> &amp;&amp; temp_service-&gt;current_state==<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>){
<a name="l01293"></a>01293 
<a name="l01294"></a>01294                         temp_service-&gt;problem_has_been_acknowledged=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01295"></a>01295                         temp_service-&gt;acknowledgement_type=<a class="code" href="include_2common_8h.html#a744bbe5aaf72c3187a55ba660cf37142">ACKNOWLEDGEMENT_NONE</a>;
<a name="l01296"></a>01296 
<a name="l01297"></a>01297                         <span class="comment">/* remove any non-persistant comments associated with the ack */</span>
<a name="l01298"></a>01298                         delete_service_acknowledgement_comments(temp_service);
<a name="l01299"></a>01299                 }
<a name="l01300"></a>01300 
<a name="l01301"></a>01301                 <span class="comment">/* do NOT reset current notification number!!! */</span>
<a name="l01302"></a>01302                 <span class="comment">/* hard changes between non-OK states should continue to be escalated, so don&#39;t reset current notification number */</span>
<a name="l01303"></a>01303                 <span class="comment">/*temp_service-&gt;current_notification_number=0;*/</span>
<a name="l01304"></a>01304         }
<a name="l01305"></a>01305 
<a name="l01306"></a>01306         <span class="comment">/* initialize the last host and service state change times if necessary */</span>
<a name="l01307"></a>01307         <span class="keywordflow">if</span>(temp_service-&gt;last_state_change==(time_t)0)
<a name="l01308"></a>01308                 temp_service-&gt;last_state_change=temp_service-&gt;last_check;
<a name="l01309"></a>01309         <span class="keywordflow">if</span>(temp_service-&gt;last_hard_state_change==(time_t)0)
<a name="l01310"></a>01310                 temp_service-&gt;last_hard_state_change=temp_service-&gt;last_check;
<a name="l01311"></a>01311         <span class="keywordflow">if</span>(temp_host-&gt;last_state_change==(time_t)0)
<a name="l01312"></a>01312                 temp_host-&gt;last_state_change=temp_service-&gt;last_check;
<a name="l01313"></a>01313         <span class="keywordflow">if</span>(temp_host-&gt;last_hard_state_change==(time_t)0)
<a name="l01314"></a>01314                 temp_host-&gt;last_hard_state_change=temp_service-&gt;last_check;
<a name="l01315"></a>01315 
<a name="l01316"></a>01316         <span class="comment">/* update last service state change times */</span>
<a name="l01317"></a>01317         <span class="keywordflow">if</span>(state_change==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01318"></a>01318                 temp_service-&gt;last_state_change=temp_service-&gt;last_check;
<a name="l01319"></a>01319         <span class="keywordflow">if</span>(hard_state_change==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01320"></a>01320                 temp_service-&gt;last_hard_state_change=temp_service-&gt;last_check;
<a name="l01321"></a>01321 
<a name="l01322"></a>01322         <span class="comment">/* update the event and problem ids */</span>
<a name="l01323"></a>01323         <span class="keywordflow">if</span>(state_change==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l01324"></a>01324 
<a name="l01325"></a>01325                 <span class="comment">/* always update the event id on a state change */</span>
<a name="l01326"></a>01326                 temp_service-&gt;last_event_id=temp_service-&gt;current_event_id;
<a name="l01327"></a>01327                 temp_service-&gt;current_event_id=<a class="code" href="checks_8c.html#a75ecfdc2a9af9431daf6d862bc9ab9cc">next_event_id</a>;
<a name="l01328"></a>01328                 <a class="code" href="checks_8c.html#a75ecfdc2a9af9431daf6d862bc9ab9cc">next_event_id</a>++;
<a name="l01329"></a>01329 
<a name="l01330"></a>01330                 <span class="comment">/* update the problem id when transitioning to a problem state */</span>
<a name="l01331"></a>01331                 <span class="keywordflow">if</span>(temp_service-&gt;last_state==<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>){
<a name="l01332"></a>01332                         <span class="comment">/* don&#39;t reset last problem id, or it will be zero the next time a problem is encountered */</span>
<a name="l01333"></a>01333                         <span class="comment">/* temp_service-&gt;last_problem_id=temp_service-&gt;current_problem_id;*/</span>
<a name="l01334"></a>01334                         temp_service-&gt;current_problem_id=<a class="code" href="checks_8c.html#a9932153d944780dd9f1156d4c7788c0d">next_problem_id</a>;
<a name="l01335"></a>01335                         <a class="code" href="checks_8c.html#a9932153d944780dd9f1156d4c7788c0d">next_problem_id</a>++;
<a name="l01336"></a>01336                 }
<a name="l01337"></a>01337 
<a name="l01338"></a>01338                 <span class="comment">/* clear the problem id when transitioning from a problem state to an OK state */</span>
<a name="l01339"></a>01339                 <span class="keywordflow">if</span>(temp_service-&gt;current_state==<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>){
<a name="l01340"></a>01340                         temp_service-&gt;last_problem_id=temp_service-&gt;current_problem_id;
<a name="l01341"></a>01341                         temp_service-&gt;current_problem_id=0L;
<a name="l01342"></a>01342                 }
<a name="l01343"></a>01343         }
<a name="l01344"></a>01344 
<a name="l01345"></a>01345 
<a name="l01346"></a>01346         <span class="comment">/**************************************/</span>
<a name="l01347"></a>01347         <span class="comment">/******* SERVICE CHECK OK LOGIC *******/</span>
<a name="l01348"></a>01348         <span class="comment">/**************************************/</span>
<a name="l01349"></a>01349 
<a name="l01350"></a>01350         <span class="comment">/* if the service is up and running OK... */</span>
<a name="l01351"></a>01351         <span class="keywordflow">if</span>(temp_service-&gt;current_state==<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>){
<a name="l01352"></a>01352 
<a name="l01353"></a>01353                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Service is OK.\n&quot;</span>);
<a name="l01354"></a>01354 
<a name="l01355"></a>01355                 <span class="comment">/* reset the acknowledgement flag (this should already have been done, but just in case...) */</span>
<a name="l01356"></a>01356                 temp_service-&gt;problem_has_been_acknowledged=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01357"></a>01357                 temp_service-&gt;acknowledgement_type=<a class="code" href="include_2common_8h.html#a744bbe5aaf72c3187a55ba660cf37142">ACKNOWLEDGEMENT_NONE</a>;
<a name="l01358"></a>01358 
<a name="l01359"></a>01359                 <span class="comment">/* verify the route to the host and send out host recovery notifications */</span>
<a name="l01360"></a>01360                 <span class="keywordflow">if</span>(temp_host-&gt;current_state!=<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>){
<a name="l01361"></a>01361 
<a name="l01362"></a>01362                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Host is NOT UP, so we&#39;ll check it to see if it recovered...\n&quot;</span>);
<a name="l01363"></a>01363 
<a name="l01364"></a>01364                         <span class="comment">/* 08/04/07 EG launch an async (parallel) host check (possibly cached) unless aggressive host checking is enabled */</span>
<a name="l01365"></a>01365                         <span class="comment">/* previous logic was to simply run a sync (serial) host check */</span>
<a name="l01366"></a>01366                         <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a8f8fcb1a4bb32b1c5fa753ac9cb48578">use_aggressive_host_checking</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01367"></a>01367                                 <a class="code" href="checks_8c.html#af1fc676aa948946ae72918ba650bb509">perform_on_demand_host_check</a>(temp_host,NULL,<a class="code" href="include_2common_8h.html#ac2e0ba323965f243a1988566a8ea53da">CHECK_OPTION_NONE</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<a class="code" href="checks_8c.html#a55fd26f1da3fea26b41e92a035472ea2">cached_host_check_horizon</a>);
<a name="l01368"></a>01368                         <span class="comment">/* 09/23/07 EG don&#39;t launch a new host check if we already did so earlier */</span>
<a name="l01369"></a>01369                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(first_host_check_initiated==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01370"></a>01370                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;First host check was already initiated, so we&#39;ll skip a new host check.\n&quot;</span>);
<a name="l01371"></a>01371                         <span class="keywordflow">else</span>{
<a name="l01372"></a>01372                                 <span class="comment">/* can we use the last cached host state? */</span>
<a name="l01373"></a>01373                                 <span class="comment">/* usually only use cached host state if no service state change has occurred */</span>
<a name="l01374"></a>01374                                 <span class="keywordflow">if</span>((state_change==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> || state_changes_use_cached_state==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) &amp;&amp; temp_host-&gt;has_been_checked==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; ((current_time-temp_host-&gt;last_check) &lt;= <a class="code" href="checks_8c.html#a55fd26f1da3fea26b41e92a035472ea2">cached_host_check_horizon</a>)){
<a name="l01375"></a>01375                                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;* Using cached host state: %d\n&quot;</span>,temp_host-&gt;current_state);
<a name="l01376"></a>01376                                         <a class="code" href="base_2utils_8c.html#ac3e9d864e9a2d00cbd2b8f3cf22ea2c1">update_check_stats</a>(<a class="code" href="include_2common_8h.html#a294c695b3b8a7790a88cd83cdc507543">ACTIVE_ONDEMAND_HOST_CHECK_STATS</a>,current_time);
<a name="l01377"></a>01377                                         <a class="code" href="base_2utils_8c.html#ac3e9d864e9a2d00cbd2b8f3cf22ea2c1">update_check_stats</a>(<a class="code" href="include_2common_8h.html#a591cbd02fed0ac4b49e246d41a1174c5">ACTIVE_CACHED_HOST_CHECK_STATS</a>,current_time);
<a name="l01378"></a>01378                                 }
<a name="l01379"></a>01379 
<a name="l01380"></a>01380                                 <span class="comment">/* else launch an async (parallel) check of the host */</span>
<a name="l01381"></a>01381                                 <span class="keywordflow">else</span>
<a name="l01382"></a>01382                                         <a class="code" href="checks_8c.html#ae41ccfe2cbc8c303d642f3315a0ad4d7">run_async_host_check_3x</a>(temp_host,<a class="code" href="include_2common_8h.html#ac2e0ba323965f243a1988566a8ea53da">CHECK_OPTION_NONE</a>,0.0,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,NULL,NULL);
<a name="l01383"></a>01383                         }
<a name="l01384"></a>01384                 }
<a name="l01385"></a>01385 
<a name="l01386"></a>01386                 <span class="comment">/* if a hard service recovery has occurred... */</span>
<a name="l01387"></a>01387                 <span class="keywordflow">if</span>(hard_state_change==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l01388"></a>01388 
<a name="l01389"></a>01389                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Service experienced a HARD RECOVERY.\n&quot;</span>);
<a name="l01390"></a>01390 
<a name="l01391"></a>01391                         <span class="comment">/* set the state type macro */</span>
<a name="l01392"></a>01392                         temp_service-&gt;state_type=<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a>;
<a name="l01393"></a>01393 
<a name="l01394"></a>01394                         <span class="comment">/* log the service recovery */</span>
<a name="l01395"></a>01395                         <a class="code" href="logging_8c.html#a065103de997cebd9a116cde5267b4a99">log_service_event</a>(temp_service);
<a name="l01396"></a>01396                         state_was_logged=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01397"></a>01397 
<a name="l01398"></a>01398                         <span class="comment">/* 10/04/07 check to see if the service and/or associate host is flapping */</span>
<a name="l01399"></a>01399                         <span class="comment">/* this should be done before a notification is sent out to ensure the host didn&#39;t just start flapping */</span>
<a name="l01400"></a>01400                         <a class="code" href="flapping_8c.html#aad761fe9d3eb521f513aa20772d220f9">check_for_service_flapping</a>(temp_service,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01401"></a>01401                         <a class="code" href="flapping_8c.html#a8630308cd8208adfcb1ec86ae1a6e8f8">check_for_host_flapping</a>(temp_host,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01402"></a>01402                         flapping_check_done=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01403"></a>01403 
<a name="l01404"></a>01404                         <span class="comment">/* notify contacts about the service recovery */</span>
<a name="l01405"></a>01405                         <a class="code" href="base_2notifications_8c.html#ada5c2318b45360c58b62a34482fd6a28">service_notification</a>(temp_service,<a class="code" href="icinga_8h.html#a70dcdf7b05f34b149e17400599ae2c88">NOTIFICATION_NORMAL</a>,NULL,NULL,<a class="code" href="include_2common_8h.html#a93c6746f02572f189061d1fadbec07b5">NOTIFICATION_OPTION_NONE</a>);
<a name="l01406"></a>01406 
<a name="l01407"></a>01407                         <span class="comment">/* run the service event handler to handle the hard state change */</span>
<a name="l01408"></a>01408                         <a class="code" href="sehandlers_8c.html#a65b699f3cedcc0b9a6915e52e3aee1b2">handle_service_event</a>(temp_service);
<a name="l01409"></a>01409                 }
<a name="l01410"></a>01410 
<a name="l01411"></a>01411                 <span class="comment">/* else if a soft service recovery has occurred... */</span>
<a name="l01412"></a>01412                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(state_change==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l01413"></a>01413 
<a name="l01414"></a>01414                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Service experienced a SOFT RECOVERY.\n&quot;</span>);
<a name="l01415"></a>01415 
<a name="l01416"></a>01416                         <span class="comment">/* this is a soft recovery */</span>
<a name="l01417"></a>01417                         temp_service-&gt;state_type=<a class="code" href="include_2common_8h.html#a74a8e12b67587cb027f5f12bb7b0fe8d">SOFT_STATE</a>;
<a name="l01418"></a>01418 
<a name="l01419"></a>01419                         <span class="comment">/* log the soft recovery */</span>
<a name="l01420"></a>01420                         <a class="code" href="logging_8c.html#a065103de997cebd9a116cde5267b4a99">log_service_event</a>(temp_service);
<a name="l01421"></a>01421                         state_was_logged=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01422"></a>01422 
<a name="l01423"></a>01423                         <span class="comment">/* run the service event handler to handle the soft state change */</span>
<a name="l01424"></a>01424                         <a class="code" href="sehandlers_8c.html#a65b699f3cedcc0b9a6915e52e3aee1b2">handle_service_event</a>(temp_service);
<a name="l01425"></a>01425                 }
<a name="l01426"></a>01426 
<a name="l01427"></a>01427                 <span class="comment">/* else no service state change has occurred... */</span>
<a name="l01428"></a>01428                 <span class="keywordflow">else</span>{
<a name="l01429"></a>01429                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Service did not change state.\n&quot;</span>);
<a name="l01430"></a>01430                 }
<a name="l01431"></a>01431 
<a name="l01432"></a>01432                 <span class="comment">/* should we obsessive over service checks? */</span>
<a name="l01433"></a>01433                 <span class="keywordflow">if</span>(<a class="code" href="broker_8c.html#a03e994eebc8f1e065991e7f8994a7059">obsess_over_services</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01434"></a>01434                         <a class="code" href="sehandlers_8c.html#a7f0a4c91426d2b935738118e94c54608">obsessive_compulsive_service_check_processor</a>(temp_service);
<a name="l01435"></a>01435 
<a name="l01436"></a>01436                 <span class="comment">/* reset all service variables because its okay now... */</span>
<a name="l01437"></a>01437                 temp_service-&gt;host_problem_at_last_check=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01438"></a>01438                 temp_service-&gt;current_attempt=1;
<a name="l01439"></a>01439                 temp_service-&gt;state_type=<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a>;
<a name="l01440"></a>01440                 temp_service-&gt;last_hard_state=<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>;
<a name="l01441"></a>01441                 temp_service-&gt;last_notification=(time_t)0;
<a name="l01442"></a>01442                 temp_service-&gt;next_notification=(time_t)0;
<a name="l01443"></a>01443                 temp_service-&gt;current_notification_number=0;
<a name="l01444"></a>01444 <span class="preprocessor">#ifdef USE_ST_BASED_ESCAL_RANGES</span>
<a name="l01445"></a>01445 <span class="preprocessor"></span>                temp_service-&gt;current_warning_notification_number=0;
<a name="l01446"></a>01446                 temp_service-&gt;current_critical_notification_number=0;
<a name="l01447"></a>01447                 temp_service-&gt;current_unknown_notification_number=0;
<a name="l01448"></a>01448 <span class="preprocessor">#endif</span>
<a name="l01449"></a>01449 <span class="preprocessor"></span>                temp_service-&gt;problem_has_been_acknowledged=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01450"></a>01450                 temp_service-&gt;acknowledgement_type=<a class="code" href="include_2common_8h.html#a744bbe5aaf72c3187a55ba660cf37142">ACKNOWLEDGEMENT_NONE</a>;
<a name="l01451"></a>01451                 temp_service-&gt;notified_on_unknown=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01452"></a>01452                 temp_service-&gt;notified_on_warning=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01453"></a>01453                 temp_service-&gt;notified_on_critical=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01454"></a>01454                 temp_service-&gt;no_more_notifications=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01455"></a>01455 
<a name="l01456"></a>01456                 <span class="keywordflow">if</span>(reschedule_check==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01457"></a>01457                         next_service_check=(time_t)(temp_service-&gt;last_check+(temp_service-&gt;<a class="code" href="structservice__struct.html#a54179e5f4bb721f91c11e943a1f9f32c">check_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>));
<a name="l01458"></a>01458         }
<a name="l01459"></a>01459 
<a name="l01460"></a>01460 
<a name="l01461"></a>01461         <span class="comment">/*******************************************/</span>
<a name="l01462"></a>01462         <span class="comment">/******* SERVICE CHECK PROBLEM LOGIC *******/</span>
<a name="l01463"></a>01463         <span class="comment">/*******************************************/</span>
<a name="l01464"></a>01464 
<a name="l01465"></a>01465         <span class="comment">/* hey, something&#39;s not working quite like it should... */</span>
<a name="l01466"></a>01466         <span class="keywordflow">else</span>{
<a name="l01467"></a>01467 
<a name="l01468"></a>01468                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Service is in a non-OK state!\n&quot;</span>);
<a name="l01469"></a>01469 
<a name="l01470"></a>01470                 <span class="comment">/* check the route to the host if its up right now... */</span>
<a name="l01471"></a>01471                 <span class="keywordflow">if</span>(temp_host-&gt;current_state==<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>){
<a name="l01472"></a>01472 
<a name="l01473"></a>01473                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Host is currently UP, so we&#39;ll recheck its state to make sure...\n&quot;</span>);
<a name="l01474"></a>01474 
<a name="l01475"></a>01475                         <span class="comment">/* 08/04/07 EG launch an async (parallel) host check (possibly cached) unless aggressive host checking is enabled */</span>
<a name="l01476"></a>01476                         <span class="comment">/* previous logic was to simply run a sync (serial) host check */</span>
<a name="l01477"></a>01477                         <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a8f8fcb1a4bb32b1c5fa753ac9cb48578">use_aggressive_host_checking</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01478"></a>01478                                 <a class="code" href="checks_8c.html#af1fc676aa948946ae72918ba650bb509">perform_on_demand_host_check</a>(temp_host,&amp;route_result,<a class="code" href="include_2common_8h.html#ac2e0ba323965f243a1988566a8ea53da">CHECK_OPTION_NONE</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<a class="code" href="checks_8c.html#a55fd26f1da3fea26b41e92a035472ea2">cached_host_check_horizon</a>);
<a name="l01479"></a>01479                         <span class="keywordflow">else</span>{
<a name="l01480"></a>01480                                 <span class="comment">/* can we use the last cached host state? */</span>
<a name="l01481"></a>01481                                 <span class="comment">/* only use cached host state if no service state change has occurred */</span>
<a name="l01482"></a>01482                                 <span class="keywordflow">if</span>((state_change==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> || state_changes_use_cached_state==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) &amp;&amp; temp_host-&gt;has_been_checked==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; ((current_time-temp_host-&gt;last_check) &lt;= <a class="code" href="checks_8c.html#a55fd26f1da3fea26b41e92a035472ea2">cached_host_check_horizon</a>)){
<a name="l01483"></a>01483                                         <span class="comment">/* use current host state as route result */</span>
<a name="l01484"></a>01484                                         route_result=temp_host-&gt;current_state;
<a name="l01485"></a>01485                                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;* Using cached host state: %d\n&quot;</span>,temp_host-&gt;current_state);
<a name="l01486"></a>01486                                         <a class="code" href="base_2utils_8c.html#ac3e9d864e9a2d00cbd2b8f3cf22ea2c1">update_check_stats</a>(<a class="code" href="include_2common_8h.html#a294c695b3b8a7790a88cd83cdc507543">ACTIVE_ONDEMAND_HOST_CHECK_STATS</a>,current_time);
<a name="l01487"></a>01487                                         <a class="code" href="base_2utils_8c.html#ac3e9d864e9a2d00cbd2b8f3cf22ea2c1">update_check_stats</a>(<a class="code" href="include_2common_8h.html#a591cbd02fed0ac4b49e246d41a1174c5">ACTIVE_CACHED_HOST_CHECK_STATS</a>,current_time);
<a name="l01488"></a>01488                                 }
<a name="l01489"></a>01489 
<a name="l01490"></a>01490                                 <span class="comment">/* else launch an async (parallel) check of the host */</span>
<a name="l01491"></a>01491                                 <span class="comment">/* CHANGED 02/15/08 only if service changed state since service was last checked */</span>
<a name="l01492"></a>01492                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(state_change==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l01493"></a>01493                                         <span class="comment">/* use current host state as route result */</span>
<a name="l01494"></a>01494                                         route_result=temp_host-&gt;current_state;
<a name="l01495"></a>01495                                         <a class="code" href="checks_8c.html#ae41ccfe2cbc8c303d642f3315a0ad4d7">run_async_host_check_3x</a>(temp_host,<a class="code" href="include_2common_8h.html#ac2e0ba323965f243a1988566a8ea53da">CHECK_OPTION_NONE</a>,0.0,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,NULL,NULL);
<a name="l01496"></a>01496                                 }
<a name="l01497"></a>01497 
<a name="l01498"></a>01498                                 <span class="comment">/* ADDED 02/15/08 */</span>
<a name="l01499"></a>01499                                 <span class="comment">/* else assume same host state */</span>
<a name="l01500"></a>01500                                 <span class="keywordflow">else</span>{
<a name="l01501"></a>01501                                         route_result=temp_host-&gt;current_state;
<a name="l01502"></a>01502                                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;* Using last known host state: %d\n&quot;</span>,temp_host-&gt;current_state);
<a name="l01503"></a>01503                                         <a class="code" href="base_2utils_8c.html#ac3e9d864e9a2d00cbd2b8f3cf22ea2c1">update_check_stats</a>(<a class="code" href="include_2common_8h.html#a294c695b3b8a7790a88cd83cdc507543">ACTIVE_ONDEMAND_HOST_CHECK_STATS</a>,current_time);
<a name="l01504"></a>01504                                         <a class="code" href="base_2utils_8c.html#ac3e9d864e9a2d00cbd2b8f3cf22ea2c1">update_check_stats</a>(<a class="code" href="include_2common_8h.html#a591cbd02fed0ac4b49e246d41a1174c5">ACTIVE_CACHED_HOST_CHECK_STATS</a>,current_time);
<a name="l01505"></a>01505                                 }
<a name="l01506"></a>01506                         }
<a name="l01507"></a>01507                 }
<a name="l01508"></a>01508 
<a name="l01509"></a>01509                 <span class="comment">/* else the host is either down or unreachable, so recheck it if necessary */</span>
<a name="l01510"></a>01510                 <span class="keywordflow">else</span>{
<a name="l01511"></a>01511 
<a name="l01512"></a>01512                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Host is currently DOWN/UNREACHABLE.\n&quot;</span>);
<a name="l01513"></a>01513 
<a name="l01514"></a>01514                         <span class="comment">/* we&#39;re using aggressive host checking, so really do recheck the host... */</span>
<a name="l01515"></a>01515                         <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a8f8fcb1a4bb32b1c5fa753ac9cb48578">use_aggressive_host_checking</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l01516"></a>01516                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Agressive host checking is enabled, so we&#39;ll recheck the host state...\n&quot;</span>);
<a name="l01517"></a>01517                                 <a class="code" href="checks_8c.html#af1fc676aa948946ae72918ba650bb509">perform_on_demand_host_check</a>(temp_host,&amp;route_result,<a class="code" href="include_2common_8h.html#ac2e0ba323965f243a1988566a8ea53da">CHECK_OPTION_NONE</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<a class="code" href="checks_8c.html#a55fd26f1da3fea26b41e92a035472ea2">cached_host_check_horizon</a>);
<a name="l01518"></a>01518                         }
<a name="l01519"></a>01519 
<a name="l01520"></a>01520                         <span class="comment">/* the service wobbled between non-OK states, so check the host... */</span>
<a name="l01521"></a>01521                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>((state_change==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; state_changes_use_cached_state==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) &amp;&amp; temp_service-&gt;last_hard_state!=<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>){
<a name="l01522"></a>01522                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Service wobbled between non-OK states, so we&#39;ll recheck the host state...\n&quot;</span>);
<a name="l01523"></a>01523                                 <span class="comment">/* 08/04/07 EG launch an async (parallel) host check unless aggressive host checking is enabled */</span>
<a name="l01524"></a>01524                                 <span class="comment">/* previous logic was to simply run a sync (serial) host check */</span>
<a name="l01525"></a>01525                                 <span class="comment">/* use current host state as route result */</span>
<a name="l01526"></a>01526                                 route_result=temp_host-&gt;current_state;
<a name="l01527"></a>01527                                 <a class="code" href="checks_8c.html#ae41ccfe2cbc8c303d642f3315a0ad4d7">run_async_host_check_3x</a>(temp_host,<a class="code" href="include_2common_8h.html#ac2e0ba323965f243a1988566a8ea53da">CHECK_OPTION_NONE</a>,0.0,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,NULL,NULL);
<a name="l01528"></a>01528                                 <span class="comment">/*perform_on_demand_host_check(temp_host,&amp;route_result,CHECK_OPTION_NONE,TRUE,cached_host_check_horizon);*/</span>
<a name="l01529"></a>01529                         }
<a name="l01530"></a>01530 
<a name="l01531"></a>01531                         <span class="comment">/* else fake the host check, but (possibly) resend host notifications to contacts... */</span>
<a name="l01532"></a>01532                         <span class="keywordflow">else</span>{
<a name="l01533"></a>01533 
<a name="l01534"></a>01534                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Assuming host is in same state as before...\n&quot;</span>);
<a name="l01535"></a>01535 
<a name="l01536"></a>01536                                 <span class="comment">/* if the host has never been checked before, set the checked flag and last check time */</span>
<a name="l01537"></a>01537                                 <span class="comment">/* 03/11/06 EG Note: This probably never evaluates to FALSE, present for historical reasons only, can probably be removed in the future */</span>
<a name="l01538"></a>01538                                 <span class="keywordflow">if</span>(temp_host-&gt;has_been_checked==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l01539"></a>01539                                         temp_host-&gt;has_been_checked=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01540"></a>01540                                         temp_host-&gt;last_check=temp_service-&gt;last_check;
<a name="l01541"></a>01541                                 }
<a name="l01542"></a>01542 
<a name="l01543"></a>01543                                 <span class="comment">/* fake the route check result */</span>
<a name="l01544"></a>01544                                 route_result=temp_host-&gt;current_state;
<a name="l01545"></a>01545 
<a name="l01546"></a>01546                                 <span class="comment">/* possibly re-send host notifications... */</span>
<a name="l01547"></a>01547                                 <a class="code" href="base_2notifications_8c.html#af37405cd35cd3cbc073ca825b5cc2980">host_notification</a>(temp_host,<a class="code" href="icinga_8h.html#a70dcdf7b05f34b149e17400599ae2c88">NOTIFICATION_NORMAL</a>,NULL,NULL,<a class="code" href="include_2common_8h.html#a93c6746f02572f189061d1fadbec07b5">NOTIFICATION_OPTION_NONE</a>);
<a name="l01548"></a>01548                         }
<a name="l01549"></a>01549                 }
<a name="l01550"></a>01550 
<a name="l01551"></a>01551                 <span class="comment">/* if the host is down or unreachable ... */</span>
<a name="l01552"></a>01552                 <span class="comment">/* 05/29/2007 NOTE: The host might be in a SOFT problem state due to host check retries/caching.  Not sure if we should take that into account and do something different or not... */</span>
<a name="l01553"></a>01553                 <span class="keywordflow">if</span>(route_result!=<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>){
<a name="l01554"></a>01554 
<a name="l01555"></a>01555                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Host is not UP, so we mark state changes if appropriate\n&quot;</span>);
<a name="l01556"></a>01556 
<a name="l01557"></a>01557                         <span class="comment">/* &quot;fake&quot; a hard state change for the service - well, its not really fake, but it didn&#39;t get caught earlier... */</span>
<a name="l01558"></a>01558                         <span class="keywordflow">if</span>(temp_service-&gt;last_hard_state!=temp_service-&gt;current_state)
<a name="l01559"></a>01559                                 hard_state_change=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01560"></a>01560 
<a name="l01561"></a>01561                         <span class="comment">/* update last state change times */</span>
<a name="l01562"></a>01562                         <span class="keywordflow">if</span>(state_change==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> || hard_state_change==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01563"></a>01563                                 temp_service-&gt;last_state_change=temp_service-&gt;last_check;
<a name="l01564"></a>01564                         <span class="keywordflow">if</span>(hard_state_change==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) {
<a name="l01565"></a>01565                                 temp_service-&gt;last_hard_state_change=temp_service-&gt;last_check;
<a name="l01566"></a>01566                                 temp_service-&gt;state_type=<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a>;
<a name="l01567"></a>01567                                 temp_service-&gt;last_hard_state=temp_service-&gt;current_state;
<a name="l01568"></a>01568                         }
<a name="l01569"></a>01569 
<a name="l01570"></a>01570                         <span class="comment">/* put service into a hard state without attempting check retries and don&#39;t send out notifications about it */</span>
<a name="l01571"></a>01571                         temp_service-&gt;host_problem_at_last_check=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01572"></a>01572                         temp_service-&gt;state_type=<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a>;
<a name="l01573"></a>01573                         temp_service-&gt;last_hard_state=temp_service-&gt;current_state;
<a name="l01574"></a>01574                         temp_service-&gt;current_attempt=1;
<a name="l01575"></a>01575                 }
<a name="l01576"></a>01576 
<a name="l01577"></a>01577                 <span class="comment">/* the host is up - it recovered since the last time the service was checked... */</span>
<a name="l01578"></a>01578                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(temp_service-&gt;host_problem_at_last_check==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l01579"></a>01579 
<a name="l01580"></a>01580                         <span class="comment">/* next time the service is checked we shouldn&#39;t get into this same case... */</span>
<a name="l01581"></a>01581                         temp_service-&gt;host_problem_at_last_check=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01582"></a>01582 
<a name="l01583"></a>01583                         <span class="comment">/* reset the current check counter, so we give the service a chance */</span>
<a name="l01584"></a>01584                         <span class="comment">/* this helps prevent the case where service has N max check attempts, N-1 of which have already occurred. */</span>
<a name="l01585"></a>01585                         <span class="comment">/* if we didn&#39;t do this, the next check might fail and result in a hard problem - we should really give it more time */</span>
<a name="l01586"></a>01586                         <span class="comment">/* ADDED IF STATEMENT 01-17-05 EG */</span>
<a name="l01587"></a>01587                         <span class="comment">/* 01-17-05: Services in hard problem states before hosts went down would sometimes come back as soft problem states after */</span>
<a name="l01588"></a>01588                         <span class="comment">/* the hosts recovered.  This caused problems, so hopefully this will fix it */</span>
<a name="l01589"></a>01589                         <span class="keywordflow">if</span>(temp_service-&gt;state_type==<a class="code" href="include_2common_8h.html#a74a8e12b67587cb027f5f12bb7b0fe8d">SOFT_STATE</a>)
<a name="l01590"></a>01590                                 temp_service-&gt;current_attempt=1;
<a name="l01591"></a>01591                 }
<a name="l01592"></a>01592 
<a name="l01593"></a>01593                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Current/Max Attempt(s): %d/%d\n&quot;</span>,temp_service-&gt;current_attempt,temp_service-&gt;<a class="code" href="structservice__struct.html#a4cc582ba5131b3efd4cfbf6389bbe938">max_attempts</a>);
<a name="l01594"></a>01594 
<a name="l01595"></a>01595                 <span class="comment">/* if we should retry the service check, do so (except it the host is down or unreachable!) */</span>
<a name="l01596"></a>01596                 <span class="keywordflow">if</span>(temp_service-&gt;current_attempt &lt; temp_service-&gt;<a class="code" href="structservice__struct.html#a4cc582ba5131b3efd4cfbf6389bbe938">max_attempts</a>){
<a name="l01597"></a>01597 
<a name="l01598"></a>01598                         <span class="comment">/* the host is down or unreachable, so don&#39;t attempt to retry the service check */</span>
<a name="l01599"></a>01599                         <span class="keywordflow">if</span>(route_result!=<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>){
<a name="l01600"></a>01600 
<a name="l01601"></a>01601                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Host isn&#39;t UP, so we won&#39;t retry the service check...\n&quot;</span>);
<a name="l01602"></a>01602 
<a name="l01603"></a>01603                                 <span class="comment">/* the host is not up, so reschedule the next service check at regular interval */</span>
<a name="l01604"></a>01604                                 <span class="keywordflow">if</span>(reschedule_check==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01605"></a>01605                                         next_service_check=(time_t)(temp_service-&gt;last_check+(temp_service-&gt;<a class="code" href="structservice__struct.html#a54179e5f4bb721f91c11e943a1f9f32c">check_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>));
<a name="l01606"></a>01606 
<a name="l01607"></a>01607                                 <span class="comment">/* log the problem as a hard state if the host just went down */</span>
<a name="l01608"></a>01608                                 <span class="keywordflow">if</span>(hard_state_change==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l01609"></a>01609                                         <a class="code" href="logging_8c.html#a065103de997cebd9a116cde5267b4a99">log_service_event</a>(temp_service);
<a name="l01610"></a>01610                                         state_was_logged=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01611"></a>01611 
<a name="l01612"></a>01612                                         <span class="comment">/* run the service event handler to handle the hard state */</span>
<a name="l01613"></a>01613                                         <a class="code" href="sehandlers_8c.html#a65b699f3cedcc0b9a6915e52e3aee1b2">handle_service_event</a>(temp_service);
<a name="l01614"></a>01614                                 }
<a name="l01615"></a>01615                         }
<a name="l01616"></a>01616 
<a name="l01617"></a>01617                         <span class="comment">/* the host is up, so continue to retry the service check */</span>
<a name="l01618"></a>01618                         <span class="keywordflow">else</span>{
<a name="l01619"></a>01619 
<a name="l01620"></a>01620                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Host is UP, so we&#39;ll retry the service check...\n&quot;</span>);
<a name="l01621"></a>01621 
<a name="l01622"></a>01622                                 <span class="comment">/* this is a soft state */</span>
<a name="l01623"></a>01623                                 <span class="keywordflow">if</span> (temp_service-&gt;current_attempt &lt; temp_service-&gt;<a class="code" href="structservice__struct.html#a4cc582ba5131b3efd4cfbf6389bbe938">max_attempts</a>) {
<a name="l01624"></a>01624                                         temp_service-&gt;state_type=<a class="code" href="include_2common_8h.html#a74a8e12b67587cb027f5f12bb7b0fe8d">SOFT_STATE</a>;
<a name="l01625"></a>01625                                 }
<a name="l01626"></a>01626 
<a name="l01627"></a>01627                                 <span class="comment">/* log the service check retry */</span>
<a name="l01628"></a>01628                                 <a class="code" href="logging_8c.html#a065103de997cebd9a116cde5267b4a99">log_service_event</a>(temp_service);
<a name="l01629"></a>01629                                 state_was_logged=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01630"></a>01630 
<a name="l01631"></a>01631                                 <span class="comment">/* run the service event handler to handle the soft state */</span>
<a name="l01632"></a>01632                                 <a class="code" href="sehandlers_8c.html#a65b699f3cedcc0b9a6915e52e3aee1b2">handle_service_event</a>(temp_service);
<a name="l01633"></a>01633 
<a name="l01634"></a>01634                                 <span class="keywordflow">if</span>(reschedule_check==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01635"></a>01635                                         next_service_check=(time_t)(temp_service-&gt;last_check+(temp_service-&gt;<a class="code" href="structservice__struct.html#a6d72d0d693531b23f2873e4081463076">retry_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>));
<a name="l01636"></a>01636                         }
<a name="l01637"></a>01637 
<a name="l01638"></a>01638                         <span class="comment">/* perform dependency checks on the second to last check of the service */</span>
<a name="l01639"></a>01639                         <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#afb630146760296e213a019a7f14f48f3">enable_predictive_service_dependency_checks</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; temp_service-&gt;current_attempt==(temp_service-&gt;<a class="code" href="structservice__struct.html#a4cc582ba5131b3efd4cfbf6389bbe938">max_attempts</a>-1)){
<a name="l01640"></a>01640 
<a name="l01641"></a>01641                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Looking for services to check for predictive dependency checks...\n&quot;</span>);
<a name="l01642"></a>01642 
<a name="l01643"></a>01643                                 <span class="comment">/* check services that THIS ONE depends on for notification AND execution */</span>
<a name="l01644"></a>01644                                 <span class="comment">/* we do this because we might be sending out a notification soon and we want the dependency logic to be accurate */</span>
<a name="l01645"></a>01645                                 <span class="keywordflow">for</span>(temp_dependency=<a class="code" href="objects_8c.html#abb428bf603eeb073ffa8df096aa2edc2">get_first_servicedependency_by_dependent_service</a>(temp_service-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>,temp_service-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,&amp;ptr);temp_dependency!=NULL;temp_dependency=<a class="code" href="objects_8c.html#ac6e6f7b659c12d79bb4c4ea0b4742989">get_next_servicedependency_by_dependent_service</a>(temp_service-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>,temp_service-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,&amp;ptr)){
<a name="l01646"></a>01646                                         <span class="keywordflow">if</span>(temp_dependency-&gt;dependent_service_ptr==temp_service &amp;&amp; temp_dependency-&gt;master_service_ptr!=NULL){
<a name="l01647"></a>01647                                                 master_service=(<a class="code" href="structservice__struct.html">service</a> *)temp_dependency-&gt;master_service_ptr;
<a name="l01648"></a>01648                                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Predictive check of service &#39;%s&#39; on host &#39;%s&#39; queued.\n&quot;</span>,master_service-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,master_service-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>);
<a name="l01649"></a>01649                                                 add_object_to_objectlist(&amp;check_servicelist,(<span class="keywordtype">void</span> *)master_service);
<a name="l01650"></a>01650                                         }
<a name="l01651"></a>01651                                 }
<a name="l01652"></a>01652                         }
<a name="l01653"></a>01653                 }
<a name="l01654"></a>01654 
<a name="l01655"></a>01655 
<a name="l01656"></a>01656                 <span class="comment">/* we&#39;ve reached the maximum number of service rechecks, so handle the error */</span>
<a name="l01657"></a>01657                 <span class="keywordflow">else</span>{
<a name="l01658"></a>01658 
<a name="l01659"></a>01659                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Service has reached max number of rechecks, so we&#39;ll handle the error...\n&quot;</span>);
<a name="l01660"></a>01660 
<a name="l01661"></a>01661                         <span class="comment">/* this is a hard state */</span>
<a name="l01662"></a>01662                         temp_service-&gt;state_type=<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a>;
<a name="l01663"></a>01663 
<a name="l01664"></a>01664                         <span class="comment">/* if we&#39;ve hard a hard state change... */</span>
<a name="l01665"></a>01665                         <span class="keywordflow">if</span>(hard_state_change==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l01666"></a>01666 
<a name="l01667"></a>01667                                 <span class="comment">/* log the service problem (even if host is not up, which is new in 0.0.5) */</span>
<a name="l01668"></a>01668                                 <a class="code" href="logging_8c.html#a065103de997cebd9a116cde5267b4a99">log_service_event</a>(temp_service);
<a name="l01669"></a>01669                                 state_was_logged=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01670"></a>01670                         }
<a name="l01671"></a>01671 
<a name="l01672"></a>01672                         <span class="comment">/* else log the problem (again) if this service is flagged as being volatile */</span>
<a name="l01673"></a>01673                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(temp_service-&gt;<a class="code" href="structservice__struct.html#a8f139754d3a0b6d21bcd3e78b2d96dc0">is_volatile</a>!=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l01674"></a>01674                                 <a class="code" href="logging_8c.html#a065103de997cebd9a116cde5267b4a99">log_service_event</a>(temp_service);
<a name="l01675"></a>01675                                 state_was_logged=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01676"></a>01676                         }
<a name="l01677"></a>01677 
<a name="l01678"></a>01678                         <span class="comment">/* check for start of flexible (non-fixed) scheduled downtime if we just had a hard/soft error */</span>
<a name="l01679"></a>01679                         <span class="comment">/* 2011-02-21 MF: we need to check for both, state_change (SOFT) and hard_state_change (HARD) values */</span>
<a name="l01680"></a>01680                         <span class="keywordflow">if</span>((hard_state_change==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> || state_change==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) &amp;&amp; temp_service-&gt;pending_flex_downtime&gt;0)
<a name="l01681"></a>01681                                 check_pending_flex_service_downtime(temp_service);
<a name="l01682"></a>01682 
<a name="l01683"></a>01683                         <span class="comment">/* 10/04/07 check to see if the service and/or associate host is flapping */</span>
<a name="l01684"></a>01684                         <span class="comment">/* this should be done before a notification is sent out to ensure the host didn&#39;t just start flapping */</span>
<a name="l01685"></a>01685                         <a class="code" href="flapping_8c.html#aad761fe9d3eb521f513aa20772d220f9">check_for_service_flapping</a>(temp_service,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01686"></a>01686                         <a class="code" href="flapping_8c.html#a8630308cd8208adfcb1ec86ae1a6e8f8">check_for_host_flapping</a>(temp_host,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01687"></a>01687                         flapping_check_done=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01688"></a>01688 
<a name="l01689"></a>01689 <span class="preprocessor">#ifdef USE_ST_BASED_ESCAL_RANGES</span>
<a name="l01690"></a>01690 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (hard_state_change==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l01691"></a>01691                                 temp_service-&gt;current_warning_notification_number=0;
<a name="l01692"></a>01692                                 temp_service-&gt;current_critical_notification_number=0;
<a name="l01693"></a>01693                                 temp_service-&gt;current_unknown_notification_number=0;
<a name="l01694"></a>01694                         }
<a name="l01695"></a>01695 <span class="preprocessor">#endif</span>
<a name="l01696"></a>01696 <span class="preprocessor"></span>                        <span class="comment">/* (re)send notifications out about this service problem if the host is up (and was at last check also) and the dependencies were okay... */</span>
<a name="l01697"></a>01697                         <a class="code" href="base_2notifications_8c.html#ada5c2318b45360c58b62a34482fd6a28">service_notification</a>(temp_service,<a class="code" href="icinga_8h.html#a70dcdf7b05f34b149e17400599ae2c88">NOTIFICATION_NORMAL</a>,NULL,NULL,<a class="code" href="include_2common_8h.html#a93c6746f02572f189061d1fadbec07b5">NOTIFICATION_OPTION_NONE</a>);
<a name="l01698"></a>01698 
<a name="l01699"></a>01699                         <span class="comment">/* run the service event handler if we changed state from the last hard state or if this service is flagged as being volatile */</span>
<a name="l01700"></a>01700                         <span class="keywordflow">if</span>(hard_state_change==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> || temp_service-&gt;<a class="code" href="structservice__struct.html#a8f139754d3a0b6d21bcd3e78b2d96dc0">is_volatile</a>!=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l01701"></a>01701                                 <a class="code" href="sehandlers_8c.html#a65b699f3cedcc0b9a6915e52e3aee1b2">handle_service_event</a>(temp_service);
<a name="l01702"></a>01702 
<a name="l01703"></a>01703                         <span class="comment">/* save the last hard state */</span>
<a name="l01704"></a>01704                         temp_service-&gt;last_hard_state=temp_service-&gt;current_state;
<a name="l01705"></a>01705 
<a name="l01706"></a>01706                         <span class="comment">/* reschedule the next check at the regular interval */</span>
<a name="l01707"></a>01707                         <span class="keywordflow">if</span>(reschedule_check==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01708"></a>01708                                 next_service_check=(time_t)(temp_service-&gt;last_check+(temp_service-&gt;<a class="code" href="structservice__struct.html#a54179e5f4bb721f91c11e943a1f9f32c">check_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>));
<a name="l01709"></a>01709                 }
<a name="l01710"></a>01710 
<a name="l01711"></a>01711 
<a name="l01712"></a>01712                 <span class="comment">/* should we obsessive over service checks? */</span>
<a name="l01713"></a>01713                 <span class="keywordflow">if</span>(<a class="code" href="broker_8c.html#a03e994eebc8f1e065991e7f8994a7059">obsess_over_services</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01714"></a>01714                         <a class="code" href="sehandlers_8c.html#a7f0a4c91426d2b935738118e94c54608">obsessive_compulsive_service_check_processor</a>(temp_service);
<a name="l01715"></a>01715         }
<a name="l01716"></a>01716 
<a name="l01717"></a>01717         <span class="comment">/* reschedule the next service check ONLY for active, scheduled checks */</span>
<a name="l01718"></a>01718         <span class="keywordflow">if</span>(reschedule_check==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l01719"></a>01719 
<a name="l01720"></a>01720                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Rescheduling next check of service at %s&quot;</span>,ctime(&amp;next_service_check));
<a name="l01721"></a>01721 
<a name="l01722"></a>01722                 <span class="comment">/* default is to reschedule service check unless a test below fails... */</span>
<a name="l01723"></a>01723                 temp_service-&gt;should_be_scheduled=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01724"></a>01724 
<a name="l01725"></a>01725                 <span class="comment">/* next check time was calculated above */</span>
<a name="l01726"></a>01726                 temp_service-&gt;next_check=next_service_check;
<a name="l01727"></a>01727 
<a name="l01728"></a>01728                 <span class="comment">/* make sure we don&#39;t get ourselves into too much trouble... */</span>
<a name="l01729"></a>01729                 <span class="keywordflow">if</span>(current_time&gt;temp_service-&gt;next_check)
<a name="l01730"></a>01730                         temp_service-&gt;next_check=<a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>;
<a name="l01731"></a>01731 
<a name="l01732"></a>01732                 <span class="comment">/* make sure we rescheduled the next service check at a valid time */</span>
<a name="l01733"></a>01733                 preferred_time=temp_service-&gt;next_check;
<a name="l01734"></a>01734                 <a class="code" href="base_2utils_8c.html#a887cf03e0c7cfc020e10e9f1949aae2e">get_next_valid_time</a>(preferred_time,&amp;next_valid_time,temp_service-&gt;check_period_ptr);
<a name="l01735"></a>01735                 temp_service-&gt;next_check=next_valid_time;
<a name="l01736"></a>01736 
<a name="l01737"></a>01737                 <span class="comment">/* services with non-recurring intervals do not get rescheduled */</span>
<a name="l01738"></a>01738                 <span class="keywordflow">if</span>(temp_service-&gt;<a class="code" href="structservice__struct.html#a54179e5f4bb721f91c11e943a1f9f32c">check_interval</a>==0)
<a name="l01739"></a>01739                         temp_service-&gt;should_be_scheduled=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01740"></a>01740 
<a name="l01741"></a>01741                 <span class="comment">/* services with active checks disabled do not get rescheduled */</span>
<a name="l01742"></a>01742                 <span class="keywordflow">if</span>(temp_service-&gt;<a class="code" href="structservice__struct.html#adf593773ee59f1c896e2189934ca68eb">checks_enabled</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l01743"></a>01743                         temp_service-&gt;should_be_scheduled=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01744"></a>01744 
<a name="l01745"></a>01745                 <span class="comment">/* schedule a non-forced check if we can */</span>
<a name="l01746"></a>01746                 <span class="keywordflow">if</span>(temp_service-&gt;should_be_scheduled==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01747"></a>01747                         <a class="code" href="checks_8c.html#a9b14dc5a4e9f578544fdf45375701517">schedule_service_check</a>(temp_service,temp_service-&gt;next_check,<a class="code" href="include_2common_8h.html#ac2e0ba323965f243a1988566a8ea53da">CHECK_OPTION_NONE</a>);
<a name="l01748"></a>01748         }
<a name="l01749"></a>01749 
<a name="l01750"></a>01750         <span class="comment">/* if we&#39;re stalking this state type and state was not already logged AND the plugin output changed since last check, log it now.. */</span>
<a name="l01751"></a>01751         <span class="keywordflow">if</span>(temp_service-&gt;state_type==<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a> &amp;&amp; state_change==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> &amp;&amp; state_was_logged==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> &amp;&amp; <a class="code" href="base_2utils_8c.html#a93ccc39494aa0f291d6c4a117be0bfff">compare_strings</a>(old_plugin_output,temp_service-&gt;plugin_output)){
<a name="l01752"></a>01752 
<a name="l01753"></a>01753                 <span class="keywordflow">if</span>((temp_service-&gt;current_state==<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a> &amp;&amp; temp_service-&gt;<a class="code" href="structservice__struct.html#ab5a68bd42dac0b3c16e9f6b8271d2f06">stalk_on_ok</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)) {
<a name="l01754"></a>01754 
<a name="l01755"></a>01755                         <a class="code" href="logging_8c.html#a065103de997cebd9a116cde5267b4a99">log_service_event</a>(temp_service);
<a name="l01756"></a>01756 
<a name="l01757"></a>01757                         <span class="comment">/* should we run event handlers ? */</span>
<a name="l01758"></a>01758                         <span class="keywordflow">if</span> (<a class="code" href="checks_8c.html#a4113366f27b640f3e76ecef1b7ba9809">stalking_event_handlers_for_services</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01759"></a>01759                                 <a class="code" href="sehandlers_8c.html#a65b699f3cedcc0b9a6915e52e3aee1b2">handle_service_event</a>(temp_service);
<a name="l01760"></a>01760 
<a name="l01761"></a>01761                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>((temp_service-&gt;current_state==<a class="code" href="cgiutils_8h.html#a4b06ae38f5452bbb219bb49f0081c3f0">STATE_WARNING</a> &amp;&amp; temp_service-&gt;<a class="code" href="structservice__struct.html#a301e35ebb1b47badd65bd8b6a40a3033">stalk_on_warning</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)) {
<a name="l01762"></a>01762 
<a name="l01763"></a>01763                         <a class="code" href="logging_8c.html#a065103de997cebd9a116cde5267b4a99">log_service_event</a>(temp_service);
<a name="l01764"></a>01764 
<a name="l01765"></a>01765                         <span class="comment">/* should we run event handlers ? */</span>
<a name="l01766"></a>01766                         <span class="keywordflow">if</span> (<a class="code" href="checks_8c.html#a4113366f27b640f3e76ecef1b7ba9809">stalking_event_handlers_for_services</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01767"></a>01767                                 <a class="code" href="sehandlers_8c.html#a65b699f3cedcc0b9a6915e52e3aee1b2">handle_service_event</a>(temp_service);
<a name="l01768"></a>01768 
<a name="l01769"></a>01769                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>((temp_service-&gt;current_state==<a class="code" href="cgiutils_8h.html#a3a671c5b5d9122f1158555575bc0feb1">STATE_UNKNOWN</a> &amp;&amp; temp_service-&gt;<a class="code" href="structservice__struct.html#a23c16f15e032a2d4ecab6bbf3ca401f5">stalk_on_unknown</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)) {
<a name="l01770"></a>01770 
<a name="l01771"></a>01771                         <a class="code" href="logging_8c.html#a065103de997cebd9a116cde5267b4a99">log_service_event</a>(temp_service);
<a name="l01772"></a>01772 
<a name="l01773"></a>01773                         <span class="comment">/* should we run event handlers ? */</span>
<a name="l01774"></a>01774                         <span class="keywordflow">if</span> (<a class="code" href="checks_8c.html#a4113366f27b640f3e76ecef1b7ba9809">stalking_event_handlers_for_services</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01775"></a>01775                                 <a class="code" href="sehandlers_8c.html#a65b699f3cedcc0b9a6915e52e3aee1b2">handle_service_event</a>(temp_service);
<a name="l01776"></a>01776 
<a name="l01777"></a>01777                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>((temp_service-&gt;current_state==<a class="code" href="cgiutils_8h.html#a19827c887254e66b983c3269a42562bc">STATE_CRITICAL</a> &amp;&amp; temp_service-&gt;<a class="code" href="structservice__struct.html#a7d2b73584c8f734c3115f6cc9ec14133">stalk_on_critical</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)) {
<a name="l01778"></a>01778 
<a name="l01779"></a>01779                         <a class="code" href="logging_8c.html#a065103de997cebd9a116cde5267b4a99">log_service_event</a>(temp_service);
<a name="l01780"></a>01780 
<a name="l01781"></a>01781                         <span class="comment">/* should we run event handlers ? */</span>
<a name="l01782"></a>01782                         <span class="keywordflow">if</span> (<a class="code" href="checks_8c.html#a4113366f27b640f3e76ecef1b7ba9809">stalking_event_handlers_for_services</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01783"></a>01783                                 <a class="code" href="sehandlers_8c.html#a65b699f3cedcc0b9a6915e52e3aee1b2">handle_service_event</a>(temp_service);
<a name="l01784"></a>01784 
<a name="l01785"></a>01785                 }
<a name="l01786"></a>01786         }
<a name="l01787"></a>01787 
<a name="l01788"></a>01788 <span class="preprocessor">#ifdef USE_EVENT_BROKER</span>
<a name="l01789"></a>01789 <span class="preprocessor"></span>        <span class="comment">/* send data to event broker */</span>
<a name="l01790"></a>01790         <a class="code" href="broker_8h.html#af573dd59adab1dbd5041b80ae07b6245">broker_service_check</a>(<a class="code" href="broker_8h.html#a3ddcffa5241d83e58d6530b927ccad2d">NEBTYPE_SERVICECHECK_PROCESSED</a>,<a class="code" href="broker_8h.html#ae7b50b735fa9d5baf42ab19525993635">NEBFLAG_NONE</a>,<a class="code" href="broker_8h.html#a2e1afa1e543c76a752561dbc9eb38d65">NEBATTR_NONE</a>,temp_service,temp_service-&gt;check_type,queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>,queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>,temp_service-&gt;<a class="code" href="structservice__struct.html#a979cc671dd6fd908e92d232a5e2458ca">service_check_command</a>,temp_service-&gt;latency,temp_service-&gt;execution_time,<a class="code" href="checks_8c.html#aae037924192ae115d84c3aa5c42502db">service_check_timeout</a>,queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a8fd6dc8e62fa817f85971b929d2a50ea">early_timeout</a>,queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>,temp_service-&gt;<a class="code" href="structservice__struct.html#aecb6488864065aed8282fb78b5fe6d2f">processed_command</a>,NULL);
<a name="l01791"></a>01791 <span class="preprocessor">#endif</span>
<a name="l01792"></a>01792 <span class="preprocessor"></span>
<a name="l01793"></a>01793         <span class="comment">/* set the checked flag */</span>
<a name="l01794"></a>01794         temp_service-&gt;has_been_checked=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01795"></a>01795 
<a name="l01796"></a>01796         <span class="comment">/* update the current service status log */</span>
<a name="l01797"></a>01797         update_service_status(temp_service,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01798"></a>01798 
<a name="l01799"></a>01799         <span class="comment">/* check to see if the service and/or associate host is flapping */</span>
<a name="l01800"></a>01800         <span class="keywordflow">if</span>(flapping_check_done==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l01801"></a>01801                 <a class="code" href="flapping_8c.html#aad761fe9d3eb521f513aa20772d220f9">check_for_service_flapping</a>(temp_service,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01802"></a>01802                 <a class="code" href="flapping_8c.html#a8630308cd8208adfcb1ec86ae1a6e8f8">check_for_host_flapping</a>(temp_host,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01803"></a>01803         }
<a name="l01804"></a>01804 
<a name="l01805"></a>01805         <span class="comment">/* update service performance info */</span>
<a name="l01806"></a>01806         <a class="code" href="perfdata_8c.html#a1ad31dd7aa3a55cdb07fc97c1ef504ee">update_service_performance_data</a>(temp_service);
<a name="l01807"></a>01807 
<a name="l01808"></a>01808         <span class="comment">/* free allocated memory */</span>
<a name="l01809"></a>01809         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_plugin_output);
<a name="l01810"></a>01810         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(old_plugin_output);
<a name="l01811"></a>01811 
<a name="l01812"></a>01812 
<a name="l01813"></a>01813         <span class="comment">/* run async checks of all services we added above */</span>
<a name="l01814"></a>01814         <span class="comment">/* don&#39;t run a check if one is already executing or we can get by with a cached state */</span>
<a name="l01815"></a>01815         <span class="keywordflow">for</span>(servicelist_item=check_servicelist;servicelist_item!=NULL;servicelist_item=servicelist_item-&gt;<a class="code" href="structobjectlist__struct.html#accd7c929ab00effa8a00c5f698bd2de6">next</a>){
<a name="l01816"></a>01816                 run_async_check=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01817"></a>01817                 temp_service=(<a class="code" href="structservice__struct.html">service</a> *)servicelist_item-&gt;<a class="code" href="structobjectlist__struct.html#a82bc35402bbb2d57a919e2660f232c68">object_ptr</a>;
<a name="l01818"></a>01818 
<a name="l01819"></a>01819                 <span class="comment">/* we can get by with a cached state, so don&#39;t check the service */</span>
<a name="l01820"></a>01820                 <span class="keywordflow">if</span>((current_time-temp_service-&gt;last_check)&lt;=<a class="code" href="checks_8c.html#a63020ec01859a9c631414e69dd951b5d">cached_service_check_horizon</a>){
<a name="l01821"></a>01821                         run_async_check=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01822"></a>01822 
<a name="l01823"></a>01823                         <span class="comment">/* update check statistics */</span>
<a name="l01824"></a>01824                         <a class="code" href="base_2utils_8c.html#ac3e9d864e9a2d00cbd2b8f3cf22ea2c1">update_check_stats</a>(<a class="code" href="include_2common_8h.html#adbd7720c3a9aae899fa24d0e34eac047">ACTIVE_CACHED_SERVICE_CHECK_STATS</a>,current_time);
<a name="l01825"></a>01825                 }
<a name="l01826"></a>01826 
<a name="l01827"></a>01827                 <span class="keywordflow">if</span>(temp_service-&gt;is_executing==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01828"></a>01828                         run_async_check=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01829"></a>01829 
<a name="l01830"></a>01830                 <span class="keywordflow">if</span>(run_async_check==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01831"></a>01831                         <a class="code" href="checks_8c.html#a7d23809fb047f645c28c5f676d2d60c9">run_async_service_check</a>(temp_service,<a class="code" href="include_2common_8h.html#ac2e0ba323965f243a1988566a8ea53da">CHECK_OPTION_NONE</a>,0.0,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,NULL,NULL);
<a name="l01832"></a>01832         }
<a name="l01833"></a>01833         free_objectlist(&amp;check_servicelist);
<a name="l01834"></a>01834 
<a name="l01835"></a>01835         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l01836"></a>01836 }
<a name="l01837"></a>01837 
<a name="l01838"></a>01838 
<a name="l01839"></a>01839 
<a name="l01840"></a>01840 <span class="comment">/* schedules an immediate or delayed service check */</span>
<a name="l01841"></a><a class="code" href="icinga_8h.html#a5d7b092cdf384a105070cf66b62e8a71">01841</a> <span class="keywordtype">void</span> <a class="code" href="checks_8c.html#a9b14dc5a4e9f578544fdf45375701517">schedule_service_check</a>(<a class="code" href="structservice__struct.html">service</a> *svc, time_t check_time, <span class="keywordtype">int</span> options){
<a name="l01842"></a>01842         <a class="code" href="structtimed__event__struct.html">timed_event</a> *temp_event=NULL;
<a name="l01843"></a>01843         <a class="code" href="structtimed__event__struct.html">timed_event</a> *new_event=NULL;
<a name="l01844"></a>01844         <span class="keywordtype">int</span> found=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01845"></a>01845         <span class="keywordtype">int</span> use_original_event=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01846"></a>01846 
<a name="l01847"></a>01847         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;schedule_service_check()\n&quot;</span>);
<a name="l01848"></a>01848 
<a name="l01849"></a>01849         <span class="keywordflow">if</span>(svc==NULL)
<a name="l01850"></a>01850                 <span class="keywordflow">return</span>;
<a name="l01851"></a>01851 
<a name="l01852"></a>01852         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Scheduling a %s, active check of service &#39;%s&#39; on host &#39;%s&#39; @ %s&quot;</span>,(options &amp; <a class="code" href="include_2common_8h.html#a7c2da00f285e024a7f2f81d633684b0f">CHECK_OPTION_FORCE_EXECUTION</a>)?<span class="stringliteral">&quot;forced&quot;</span>:<span class="stringliteral">&quot;non-forced&quot;</span>,svc-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,svc-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>,ctime(&amp;check_time));
<a name="l01853"></a>01853 
<a name="l01854"></a>01854         <span class="comment">/* don&#39;t schedule a check if active checks of this service are disabled */</span>
<a name="l01855"></a>01855         <span class="keywordflow">if</span>(svc-&gt;<a class="code" href="structservice__struct.html#adf593773ee59f1c896e2189934ca68eb">checks_enabled</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> &amp;&amp; !(options &amp; CHECK_OPTION_FORCE_EXECUTION)){
<a name="l01856"></a>01856                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Active checks of this service are disabled.\n&quot;</span>);
<a name="l01857"></a>01857                 <span class="keywordflow">return</span>;
<a name="l01858"></a>01858         }
<a name="l01859"></a>01859 
<a name="l01860"></a>01860         <span class="comment">/* allocate memory for a new event item */</span>
<a name="l01861"></a>01861         new_event=(<a class="code" href="structtimed__event__struct.html">timed_event</a> *)malloc(<span class="keyword">sizeof</span>(<a class="code" href="structtimed__event__struct.html">timed_event</a>));
<a name="l01862"></a>01862         <span class="keywordflow">if</span>(new_event==NULL){
<a name="l01863"></a>01863 
<a name="l01864"></a>01864                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: Could not reschedule check of service &#39;%s&#39; on host &#39;%s&#39;!\n&quot;</span>,svc-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,svc-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>);
<a name="l01865"></a>01865 
<a name="l01866"></a>01866                 <span class="keywordflow">return</span>;
<a name="l01867"></a>01867         }
<a name="l01868"></a>01868 
<a name="l01869"></a>01869         <span class="comment">/* default is to use the new event */</span>
<a name="l01870"></a>01870         use_original_event=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01871"></a>01871         found=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01872"></a>01872 
<a name="l01873"></a>01873 <span class="preprocessor">#ifdef PERFORMANCE_INCREASE_BUT_VERY_BAD_IDEA_INDEED</span>
<a name="l01874"></a>01874 <span class="preprocessor"></span>        <span class="comment">/* WARNING! 1/19/07 on-demand async service checks will end up causing mutliple scheduled checks of a service to appear in the queue if the code below is skipped */</span>
<a name="l01875"></a>01875         <span class="comment">/* if(use_large_installation_tweaks==FALSE)... skip code below */</span>
<a name="l01876"></a>01876 <span class="preprocessor">#endif</span>
<a name="l01877"></a>01877 <span class="preprocessor"></span>
<a name="l01878"></a>01878         <span class="comment">/* see if there are any other scheduled checks of this service in the queue */</span>
<a name="l01879"></a>01879         <span class="keywordflow">for</span>(temp_event=event_list_low;temp_event!=NULL;temp_event=temp_event-&gt;<a class="code" href="structtimed__event__struct.html#a8a7e9def5bccc2d9df958f027d62e5a9">next</a>){
<a name="l01880"></a>01880 
<a name="l01881"></a>01881                 <span class="keywordflow">if</span>(temp_event-&gt;<a class="code" href="structtimed__event__struct.html#a07431a09f5ea160cc672347851843060">event_type</a>==<a class="code" href="icinga_8h.html#ac4b16f89255236e7625b6f1429d8ea7a">EVENT_SERVICE_CHECK</a> &amp;&amp; svc==(<a class="code" href="structservice__struct.html">service</a> *)temp_event-&gt;<a class="code" href="structtimed__event__struct.html#acf4bcbbb5e85490b262342efaba53be7">event_data</a>){
<a name="l01882"></a>01882                         found=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01883"></a>01883                         <span class="keywordflow">break</span>;
<a name="l01884"></a>01884                 }
<a name="l01885"></a>01885         }
<a name="l01886"></a>01886 
<a name="l01887"></a>01887         <span class="comment">/* we found another service check event for this service in the queue - what should we do? */</span>
<a name="l01888"></a>01888         <span class="keywordflow">if</span>(found==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; temp_event!=NULL){
<a name="l01889"></a>01889 
<a name="l01890"></a>01890                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Found another service check event for this service @ %s&quot;</span>,ctime(&amp;temp_event-&gt;<a class="code" href="structtimed__event__struct.html#ab587fd4005d25a52e689ac52cc19dd35">run_time</a>));
<a name="l01891"></a>01891 
<a name="l01892"></a>01892                 <span class="comment">/* use the originally scheduled check unless we decide otherwise */</span>
<a name="l01893"></a>01893                 use_original_event=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01894"></a>01894 
<a name="l01895"></a>01895                 <span class="comment">/* the original event is a forced check... */</span>
<a name="l01896"></a>01896                 <span class="keywordflow">if</span>((temp_event-&gt;<a class="code" href="structtimed__event__struct.html#af99d862c4fbe76165935c3ba01a9944d">event_options</a> &amp; CHECK_OPTION_FORCE_EXECUTION)){
<a name="l01897"></a>01897 
<a name="l01898"></a>01898                         <span class="comment">/* the new event is also forced and its execution time is earlier than the original, so use it instead */</span>
<a name="l01899"></a>01899                         <span class="keywordflow">if</span>((options &amp; CHECK_OPTION_FORCE_EXECUTION) &amp;&amp; (check_time &lt; temp_event-&gt;run_time)){
<a name="l01900"></a>01900                                 use_original_event=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01901"></a>01901                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;New service check event is forced and occurs before the existing event, so the new event will be used instead.\n&quot;</span>);
<a name="l01902"></a>01902                         }
<a name="l01903"></a>01903                 }
<a name="l01904"></a>01904 
<a name="l01905"></a>01905                 <span class="comment">/* the original event is not a forced check... */</span>
<a name="l01906"></a>01906                 <span class="keywordflow">else</span>{
<a name="l01907"></a>01907 
<a name="l01908"></a>01908                         <span class="comment">/* the new event is a forced check, so use it instead */</span>
<a name="l01909"></a>01909                         <span class="keywordflow">if</span>((options &amp; CHECK_OPTION_FORCE_EXECUTION)){
<a name="l01910"></a>01910                                 use_original_event=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01911"></a>01911                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;New service check event is forced, so it will be used instead of the existing event.\n&quot;</span>);
<a name="l01912"></a>01912                         }
<a name="l01913"></a>01913 
<a name="l01914"></a>01914                         <span class="comment">/* the new event is not forced either and its execution time is earlier than the original, so use it instead */</span>
<a name="l01915"></a>01915                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(check_time &lt; temp_event-&gt;run_time){
<a name="l01916"></a>01916                                 use_original_event=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01917"></a>01917                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;New service check event occurs before the existing (older) event, so it will be used instead.\n&quot;</span>);
<a name="l01918"></a>01918                         }
<a name="l01919"></a>01919 
<a name="l01920"></a>01920                         <span class="comment">/* the new event is older, so override the existing one */</span>
<a name="l01921"></a>01921                         <span class="keywordflow">else</span>{
<a name="l01922"></a>01922                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;New service check event occurs after the existing event, so we&#39;ll ignore it.\n&quot;</span>);
<a name="l01923"></a>01923                         }
<a name="l01924"></a>01924                 }
<a name="l01925"></a>01925 
<a name="l01926"></a>01926                 <span class="comment">/* the originally queued event won the battle, so keep it */</span>
<a name="l01927"></a>01927                 <span class="keywordflow">if</span>(use_original_event==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l01928"></a>01928                         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(new_event);
<a name="l01929"></a>01929                 }
<a name="l01930"></a>01930 
<a name="l01931"></a>01931                 <span class="comment">/* else we&#39;re using the new event, so remove the old one */</span>
<a name="l01932"></a>01932                 <span class="keywordflow">else</span>{
<a name="l01933"></a>01933                         <a class="code" href="events_8c.html#a431ab9294a04ba5faf19fa088bace5d2">remove_event</a>(temp_event,&amp;event_list_low,&amp;event_list_low_tail);
<a name="l01934"></a>01934                         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_event);
<a name="l01935"></a>01935                 }
<a name="l01936"></a>01936         }
<a name="l01937"></a>01937 
<a name="l01938"></a>01938         <span class="comment">/* save check options for retention purposes */</span>
<a name="l01939"></a>01939         svc-&gt;check_options=options;
<a name="l01940"></a>01940 
<a name="l01941"></a>01941         <span class="comment">/* schedule a new event */</span>
<a name="l01942"></a>01942         <span class="keywordflow">if</span>(use_original_event==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l01943"></a>01943 
<a name="l01944"></a>01944                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Scheduling new service check event.\n&quot;</span>);
<a name="l01945"></a>01945 
<a name="l01946"></a>01946                 <span class="comment">/* set the next service check time */</span>
<a name="l01947"></a>01947                 svc-&gt;next_check=check_time;
<a name="l01948"></a>01948 
<a name="l01949"></a>01949                 <span class="comment">/* place the new event in the event queue */</span>
<a name="l01950"></a>01950                 new_event-&gt;<a class="code" href="structtimed__event__struct.html#a07431a09f5ea160cc672347851843060">event_type</a>=<a class="code" href="icinga_8h.html#ac4b16f89255236e7625b6f1429d8ea7a">EVENT_SERVICE_CHECK</a>;
<a name="l01951"></a>01951                 new_event-&gt;<a class="code" href="structtimed__event__struct.html#acf4bcbbb5e85490b262342efaba53be7">event_data</a>=(<span class="keywordtype">void</span> *)svc;
<a name="l01952"></a>01952                 new_event-&gt;<a class="code" href="structtimed__event__struct.html#ad8d32f8baac88c5da74f6af72dd977ec">event_args</a>=(<span class="keywordtype">void</span> *)NULL;
<a name="l01953"></a>01953                 new_event-&gt;<a class="code" href="structtimed__event__struct.html#af99d862c4fbe76165935c3ba01a9944d">event_options</a>=options;
<a name="l01954"></a>01954                 new_event-&gt;<a class="code" href="structtimed__event__struct.html#ab587fd4005d25a52e689ac52cc19dd35">run_time</a>=svc-&gt;next_check;
<a name="l01955"></a>01955                 new_event-&gt;<a class="code" href="structtimed__event__struct.html#a380357264ff8bcfe3be16b3799a20245">recurring</a>=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01956"></a>01956                 new_event-&gt;<a class="code" href="structtimed__event__struct.html#aadf4ef3f63ad109cea37b99d947f8b43">event_interval</a>=0L;
<a name="l01957"></a>01957                 new_event-&gt;<a class="code" href="structtimed__event__struct.html#a80ac445ac29a4e8d631416328f15e711">timing_func</a>=NULL;
<a name="l01958"></a>01958                 new_event-&gt;<a class="code" href="structtimed__event__struct.html#a7699c13f3cd6740e0bda5df3dd0b2473">compensate_for_time_change</a>=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01959"></a>01959                 <a class="code" href="events_8c.html#aa794c69458107f2f37800beb11944f5a">reschedule_event</a>(new_event,&amp;event_list_low,&amp;event_list_low_tail);
<a name="l01960"></a>01960         }
<a name="l01961"></a>01961 
<a name="l01962"></a>01962         <span class="keywordflow">else</span>{
<a name="l01963"></a>01963                 <span class="comment">/* reset the next check time (it may be out of sync) */</span>
<a name="l01964"></a>01964                 <span class="keywordflow">if</span>(temp_event!=NULL)
<a name="l01965"></a>01965                         svc-&gt;next_check=temp_event-&gt;<a class="code" href="structtimed__event__struct.html#ab587fd4005d25a52e689ac52cc19dd35">run_time</a>;
<a name="l01966"></a>01966 
<a name="l01967"></a>01967                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Keeping original service check event (ignoring the new one).\n&quot;</span>);
<a name="l01968"></a>01968         }
<a name="l01969"></a>01969 
<a name="l01970"></a>01970         <span class="keywordflow">return</span>;
<a name="l01971"></a>01971 }
<a name="l01972"></a>01972 
<a name="l01973"></a>01973 
<a name="l01974"></a>01974 
<a name="l01975"></a>01975 <span class="comment">/* checks viability of performing a service check */</span>
<a name="l01976"></a><a class="code" href="icinga_8h.html#a9ed96bc489473ca6f539d794a8a254a6">01976</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#ac6a052aeefc9b3d7e77a58f64da4e98d">check_service_check_viability</a>(<a class="code" href="structservice__struct.html">service</a> *svc, <span class="keywordtype">int</span> check_options, <span class="keywordtype">int</span> *time_is_valid, time_t *new_time){
<a name="l01977"></a>01977         <span class="keywordtype">int</span> result=<a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l01978"></a>01978         <span class="keywordtype">int</span> perform_check=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01979"></a>01979         time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>=0L;
<a name="l01980"></a>01980         time_t preferred_time=0L;
<a name="l01981"></a>01981         <span class="keywordtype">int</span> check_interval=0;
<a name="l01982"></a>01982 
<a name="l01983"></a>01983         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;check_service_check_viability()\n&quot;</span>);
<a name="l01984"></a>01984 
<a name="l01985"></a>01985         <span class="comment">/* make sure we have a service */</span>
<a name="l01986"></a>01986         <span class="keywordflow">if</span>(svc==NULL)
<a name="l01987"></a>01987                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l01988"></a>01988 
<a name="l01989"></a>01989         <span class="comment">/* get the check interval to use if we need to reschedule the check */</span>
<a name="l01990"></a>01990         <span class="keywordflow">if</span>(svc-&gt;state_type==<a class="code" href="include_2common_8h.html#a74a8e12b67587cb027f5f12bb7b0fe8d">SOFT_STATE</a> &amp;&amp; svc-&gt;current_state!=<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>)
<a name="l01991"></a>01991                 check_interval=(svc-&gt;<a class="code" href="structservice__struct.html#a6d72d0d693531b23f2873e4081463076">retry_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>);
<a name="l01992"></a>01992         <span class="keywordflow">else</span>
<a name="l01993"></a>01993                 check_interval=(svc-&gt;<a class="code" href="structservice__struct.html#a54179e5f4bb721f91c11e943a1f9f32c">check_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>);
<a name="l01994"></a>01994 
<a name="l01995"></a>01995         <span class="comment">/* get the current time */</span>
<a name="l01996"></a>01996         time(&amp;current_time);
<a name="l01997"></a>01997 
<a name="l01998"></a>01998         <span class="comment">/* initialize the next preferred check time */</span>
<a name="l01999"></a>01999         preferred_time=<a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>;
<a name="l02000"></a>02000 
<a name="l02001"></a>02001         <span class="comment">/* can we check the host right now? */</span>
<a name="l02002"></a>02002         <span class="keywordflow">if</span>(!(check_options &amp; <a class="code" href="include_2common_8h.html#a7c2da00f285e024a7f2f81d633684b0f">CHECK_OPTION_FORCE_EXECUTION</a>)){
<a name="l02003"></a>02003 
<a name="l02004"></a>02004                 <span class="comment">/* if checks of the service are currently disabled... */</span>
<a name="l02005"></a>02005                 <span class="keywordflow">if</span>(svc-&gt;<a class="code" href="structservice__struct.html#adf593773ee59f1c896e2189934ca68eb">checks_enabled</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l02006"></a>02006                         preferred_time=current_time+check_interval;
<a name="l02007"></a>02007                         perform_check=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02008"></a>02008 
<a name="l02009"></a>02009                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Active checks of the service are currently disabled.\n&quot;</span>);
<a name="l02010"></a>02010                 }
<a name="l02011"></a>02011 
<a name="l02012"></a>02012                 <span class="comment">/* make sure this is a valid time to check the service */</span>
<a name="l02013"></a>02013                 <span class="keywordflow">if</span>(<a class="code" href="base_2utils_8c.html#a49602563f5f03788d56b2d06d2c72bfb">check_time_against_period</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)current_time,svc-&gt;check_period_ptr)==<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>){
<a name="l02014"></a>02014                         preferred_time=<a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>;
<a name="l02015"></a>02015                         <span class="keywordflow">if</span>(time_is_valid)
<a name="l02016"></a>02016                                 *time_is_valid=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02017"></a>02017                         perform_check=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02018"></a>02018 
<a name="l02019"></a>02019                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;This is not a valid time for this service to be actively checked.\n&quot;</span>);
<a name="l02020"></a>02020                 }
<a name="l02021"></a>02021 
<a name="l02022"></a>02022                 <span class="comment">/* check service dependencies for execution */</span>
<a name="l02023"></a>02023                 <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a4ba017ed5ad04b8c86e44f5f2c182f73">check_service_dependencies</a>(svc,<a class="code" href="include_2common_8h.html#a70583e81777a3d22be6d62b295302b85">EXECUTION_DEPENDENCY</a>)==<a class="code" href="icinga_8h.html#a9c4ca9fdb0f89ec497ae74bf7ab7404c">DEPENDENCIES_FAILED</a>){
<a name="l02024"></a>02024                         preferred_time=current_time+check_interval;
<a name="l02025"></a>02025                         perform_check=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02026"></a>02026 
<a name="l02027"></a>02027                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Execution dependencies for this service failed, so it will not be actively checked.\n&quot;</span>);
<a name="l02028"></a>02028                 }
<a name="l02029"></a>02029         }
<a name="l02030"></a>02030 
<a name="l02031"></a>02031         <span class="comment">/* pass back the next viable check time */</span>
<a name="l02032"></a>02032         <span class="keywordflow">if</span>(new_time)
<a name="l02033"></a>02033                 *new_time=preferred_time;
<a name="l02034"></a>02034 
<a name="l02035"></a>02035         result=(perform_check==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)?<a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>:<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l02036"></a>02036 
<a name="l02037"></a>02037         <span class="keywordflow">return</span> result;
<a name="l02038"></a>02038 }
<a name="l02039"></a>02039 
<a name="l02040"></a>02040 
<a name="l02041"></a>02041 
<a name="l02042"></a>02042 <span class="comment">/* checks service dependencies */</span>
<a name="l02043"></a><a class="code" href="icinga_8h.html#a2a8f7416fa5ff01013e46d4d02a1040a">02043</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#a4ba017ed5ad04b8c86e44f5f2c182f73">check_service_dependencies</a>(<a class="code" href="structservice__struct.html">service</a> *svc,<span class="keywordtype">int</span> dependency_type){
<a name="l02044"></a>02044         <a class="code" href="structservicedependency__struct.html">servicedependency</a> *temp_dependency=NULL;
<a name="l02045"></a>02045         <a class="code" href="structservice__struct.html">service</a> *temp_service=NULL;
<a name="l02046"></a>02046         <span class="keywordtype">int</span> state=<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>;
<a name="l02047"></a>02047         time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>=0L;
<a name="l02048"></a>02048         <span class="keywordtype">void</span> *ptr=NULL;
<a name="l02049"></a>02049 
<a name="l02050"></a>02050 
<a name="l02051"></a>02051         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;check_service_dependencies()\n&quot;</span>);
<a name="l02052"></a>02052 
<a name="l02053"></a>02053         <span class="comment">/* check all dependencies... */</span>
<a name="l02054"></a>02054         <span class="keywordflow">for</span>(temp_dependency=<a class="code" href="objects_8c.html#abb428bf603eeb073ffa8df096aa2edc2">get_first_servicedependency_by_dependent_service</a>(svc-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>,svc-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,&amp;ptr);temp_dependency!=NULL;temp_dependency=<a class="code" href="objects_8c.html#ac6e6f7b659c12d79bb4c4ea0b4742989">get_next_servicedependency_by_dependent_service</a>(svc-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>,svc-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,&amp;ptr)){
<a name="l02055"></a>02055 
<a name="l02056"></a>02056                 <span class="comment">/* only check dependencies of the desired type (notification or execution) */</span>
<a name="l02057"></a>02057                 <span class="keywordflow">if</span>(temp_dependency-&gt;<a class="code" href="structservicedependency__struct.html#a7eb5cbb3e53c56877b9210a1b0d18b84">dependency_type</a>!=dependency_type)
<a name="l02058"></a>02058                         <span class="keywordflow">continue</span>;
<a name="l02059"></a>02059 
<a name="l02060"></a>02060                 <span class="comment">/* find the service we depend on... */</span>
<a name="l02061"></a>02061                 <span class="keywordflow">if</span>((temp_service=temp_dependency-&gt;master_service_ptr)==NULL)
<a name="l02062"></a>02062                         <span class="keywordflow">continue</span>;
<a name="l02063"></a>02063 
<a name="l02064"></a>02064                 <span class="comment">/* skip this dependency if it has a timeperiod and the current time isn&#39;t valid */</span>
<a name="l02065"></a>02065                 time(&amp;current_time);
<a name="l02066"></a>02066                 <span class="keywordflow">if</span>(temp_dependency-&gt;<a class="code" href="structservicedependency__struct.html#a8329aa5980c11bdd14cfe1b1d4ea0541">dependency_period</a>!=NULL &amp;&amp; <a class="code" href="base_2utils_8c.html#a49602563f5f03788d56b2d06d2c72bfb">check_time_against_period</a>(current_time,temp_dependency-&gt;dependency_period_ptr)==<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>)
<a name="l02067"></a>02067                         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02068"></a>02068 
<a name="l02069"></a>02069                 <span class="comment">/* get the status to use (use last hard state if its currently in a soft state) */</span>
<a name="l02070"></a>02070                 <span class="keywordflow">if</span>(temp_service-&gt;state_type==<a class="code" href="include_2common_8h.html#a74a8e12b67587cb027f5f12bb7b0fe8d">SOFT_STATE</a> &amp;&amp; <a class="code" href="checks_8c.html#a7c9ecd6259817de56ca91f1adaaea842">soft_state_dependencies</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l02071"></a>02071                         state=temp_service-&gt;last_hard_state;
<a name="l02072"></a>02072                 <span class="keywordflow">else</span>
<a name="l02073"></a>02073                         state=temp_service-&gt;current_state;
<a name="l02074"></a>02074 
<a name="l02075"></a>02075                 <span class="comment">/* is the service we depend on in state that fails the dependency tests? */</span>
<a name="l02076"></a>02076                 <span class="keywordflow">if</span>(state==<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a> &amp;&amp; temp_dependency-&gt;<a class="code" href="structservicedependency__struct.html#abbd394c73470c448731cf6fc38f57caf">fail_on_ok</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l02077"></a>02077                         <span class="keywordflow">return</span> <a class="code" href="icinga_8h.html#a9c4ca9fdb0f89ec497ae74bf7ab7404c">DEPENDENCIES_FAILED</a>;
<a name="l02078"></a>02078                 <span class="keywordflow">if</span>(state==<a class="code" href="cgiutils_8h.html#a4b06ae38f5452bbb219bb49f0081c3f0">STATE_WARNING</a> &amp;&amp; temp_dependency-&gt;<a class="code" href="structservicedependency__struct.html#a3a05ec9d8e27a4e79bd406c86130e787">fail_on_warning</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l02079"></a>02079                         <span class="keywordflow">return</span> <a class="code" href="icinga_8h.html#a9c4ca9fdb0f89ec497ae74bf7ab7404c">DEPENDENCIES_FAILED</a>;
<a name="l02080"></a>02080                 <span class="keywordflow">if</span>(state==<a class="code" href="cgiutils_8h.html#a3a671c5b5d9122f1158555575bc0feb1">STATE_UNKNOWN</a> &amp;&amp; temp_dependency-&gt;<a class="code" href="structservicedependency__struct.html#abb6a3938502e280e45dca71921c0693c">fail_on_unknown</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l02081"></a>02081                         <span class="keywordflow">return</span> <a class="code" href="icinga_8h.html#a9c4ca9fdb0f89ec497ae74bf7ab7404c">DEPENDENCIES_FAILED</a>;
<a name="l02082"></a>02082                 <span class="keywordflow">if</span>(state==<a class="code" href="cgiutils_8h.html#a19827c887254e66b983c3269a42562bc">STATE_CRITICAL</a> &amp;&amp; temp_dependency-&gt;<a class="code" href="structservicedependency__struct.html#a9c2cd85c42e70f9f1bd305a882d7704d">fail_on_critical</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l02083"></a>02083                         <span class="keywordflow">return</span> <a class="code" href="icinga_8h.html#a9c4ca9fdb0f89ec497ae74bf7ab7404c">DEPENDENCIES_FAILED</a>;
<a name="l02084"></a>02084                 <span class="keywordflow">if</span>((state==<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a> &amp;&amp; temp_service-&gt;has_been_checked==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) &amp;&amp; temp_dependency-&gt;<a class="code" href="structservicedependency__struct.html#afa27956be9fa97e192fe4d7e76623626">fail_on_pending</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l02085"></a>02085                         <span class="keywordflow">return</span> <a class="code" href="icinga_8h.html#a9c4ca9fdb0f89ec497ae74bf7ab7404c">DEPENDENCIES_FAILED</a>;
<a name="l02086"></a>02086 
<a name="l02087"></a>02087                 <span class="comment">/* immediate dependencies ok at this point - check parent dependencies if necessary */</span>
<a name="l02088"></a>02088                 <span class="keywordflow">if</span>(temp_dependency-&gt;<a class="code" href="structservicedependency__struct.html#a0b6e556cdf03d434b2e98ec45c054782">inherits_parent</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l02089"></a>02089                         <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a4ba017ed5ad04b8c86e44f5f2c182f73">check_service_dependencies</a>(temp_service,dependency_type)!=<a class="code" href="icinga_8h.html#aa91fb10787e799c2344282b53faa929e">DEPENDENCIES_OK</a>)
<a name="l02090"></a>02090                                 <span class="keywordflow">return</span> <a class="code" href="icinga_8h.html#a9c4ca9fdb0f89ec497ae74bf7ab7404c">DEPENDENCIES_FAILED</a>;
<a name="l02091"></a>02091                 }
<a name="l02092"></a>02092         }
<a name="l02093"></a>02093 
<a name="l02094"></a>02094         <span class="keywordflow">return</span> <a class="code" href="icinga_8h.html#aa91fb10787e799c2344282b53faa929e">DEPENDENCIES_OK</a>;
<a name="l02095"></a>02095 }
<a name="l02096"></a>02096 
<a name="l02097"></a>02097 
<a name="l02098"></a>02098 
<a name="l02099"></a>02099 <span class="comment">/* check for services that never returned from a check... */</span>
<a name="l02100"></a><a class="code" href="icinga_8h.html#abf762ca4bc888380ffd15ce68ab88088">02100</a> <span class="keywordtype">void</span> <a class="code" href="checks_8c.html#abf762ca4bc888380ffd15ce68ab88088">check_for_orphaned_services</a>(<span class="keywordtype">void</span>){
<a name="l02101"></a>02101         <a class="code" href="structservice__struct.html">service</a> *temp_service=NULL;
<a name="l02102"></a>02102         time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>=0L;
<a name="l02103"></a>02103         time_t expected_time=0L;
<a name="l02104"></a>02104 
<a name="l02105"></a>02105 
<a name="l02106"></a>02106         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;check_for_orphaned_services()\n&quot;</span>);
<a name="l02107"></a>02107 
<a name="l02108"></a>02108         <span class="comment">/* get the current time */</span>
<a name="l02109"></a>02109         time(&amp;current_time);
<a name="l02110"></a>02110 
<a name="l02111"></a>02111         <span class="comment">/* check all services... */</span>
<a name="l02112"></a>02112         <span class="keywordflow">for</span>(temp_service=service_list;temp_service!=NULL;temp_service=temp_service-&gt;<a class="code" href="structservice__struct.html#a32394c09b9ce32d454c99f8a90e77e8b">next</a>){
<a name="l02113"></a>02113 
<a name="l02114"></a>02114                 <span class="comment">/* skip services that are not currently executing */</span>
<a name="l02115"></a>02115                 <span class="keywordflow">if</span>(temp_service-&gt;is_executing==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l02116"></a>02116                         <span class="keywordflow">continue</span>;
<a name="l02117"></a>02117 
<a name="l02118"></a>02118                 <span class="comment">/* determine the time at which the check results should have come in (allow 10 minutes slack time) */</span>
<a name="l02119"></a>02119                 expected_time=(time_t)(temp_service-&gt;next_check+temp_service-&gt;latency+<a class="code" href="checks_8c.html#aae037924192ae115d84c3aa5c42502db">service_check_timeout</a>+<a class="code" href="checks_8c.html#af5316c1b7ca4d4261fb4edc45cafcca2">check_reaper_interval</a>+600);
<a name="l02120"></a>02120 
<a name="l02121"></a>02121                 <span class="comment">/* this service was supposed to have executed a while ago, but for some reason the results haven&#39;t come back in... */</span>
<a name="l02122"></a>02122                 <span class="keywordflow">if</span>(expected_time&lt;current_time){
<a name="l02123"></a>02123 
<a name="l02124"></a>02124                         <span class="comment">/* log a warning */</span>
<a name="l02125"></a>02125                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: The check of service &#39;%s&#39; on host &#39;%s&#39; looks like it was orphaned (results never came back).  I&#39;m scheduling an immediate check of the service...\n&quot;</span>,temp_service-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,temp_service-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>);
<a name="l02126"></a>02126 
<a name="l02127"></a>02127                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Service &#39;%s&#39; on host &#39;%s&#39; was orphaned, so we&#39;re scheduling an immediate check...\n&quot;</span>,temp_service-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,temp_service-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>);
<a name="l02128"></a>02128 
<a name="l02129"></a>02129                         <span class="comment">/* decrement the number of running service checks */</span>
<a name="l02130"></a>02130                         <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a01f1a65871aff67ece2c26f543691083">currently_running_service_checks</a>&gt;0)
<a name="l02131"></a>02131                                 <a class="code" href="checks_8c.html#a01f1a65871aff67ece2c26f543691083">currently_running_service_checks</a>--;
<a name="l02132"></a>02132 
<a name="l02133"></a>02133                         <span class="comment">/* disable the executing flag */</span>
<a name="l02134"></a>02134                         temp_service-&gt;is_executing=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02135"></a>02135 
<a name="l02136"></a>02136                         <span class="comment">/* schedule an immediate check of the service */</span>
<a name="l02137"></a>02137                         <a class="code" href="checks_8c.html#a9b14dc5a4e9f578544fdf45375701517">schedule_service_check</a>(temp_service,current_time,<a class="code" href="include_2common_8h.html#a3d4925829311731add8fdaaa283863dc">CHECK_OPTION_ORPHAN_CHECK</a>);
<a name="l02138"></a>02138                 }
<a name="l02139"></a>02139 
<a name="l02140"></a>02140         }
<a name="l02141"></a>02141 
<a name="l02142"></a>02142         <span class="keywordflow">return</span>;
<a name="l02143"></a>02143 }
<a name="l02144"></a>02144 
<a name="l02145"></a>02145 
<a name="l02146"></a>02146 
<a name="l02147"></a>02147 <span class="comment">/* check freshness of service results */</span>
<a name="l02148"></a><a class="code" href="icinga_8h.html#a0bb9e12baf03915983cd37e07f73c799">02148</a> <span class="keywordtype">void</span> <a class="code" href="checks_8c.html#a0bb9e12baf03915983cd37e07f73c799">check_service_result_freshness</a>(<span class="keywordtype">void</span>){
<a name="l02149"></a>02149         <a class="code" href="structservice__struct.html">service</a> *temp_service=NULL;
<a name="l02150"></a>02150         time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>=0L;
<a name="l02151"></a>02151 
<a name="l02152"></a>02152 
<a name="l02153"></a>02153         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;check_service_result_freshness()\n&quot;</span>);
<a name="l02154"></a>02154         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Checking the freshness of service check results...\n&quot;</span>);
<a name="l02155"></a>02155 
<a name="l02156"></a>02156         <span class="comment">/* bail out if we&#39;re not supposed to be checking freshness */</span>
<a name="l02157"></a>02157         <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a2361e9b42a0ea220db317dff75dc9dc0">check_service_freshness</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l02158"></a>02158                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Service freshness checking is disabled.\n&quot;</span>);
<a name="l02159"></a>02159                 <span class="keywordflow">return</span>;
<a name="l02160"></a>02160         }
<a name="l02161"></a>02161 
<a name="l02162"></a>02162         <span class="comment">/* get the current time */</span>
<a name="l02163"></a>02163         time(&amp;current_time);
<a name="l02164"></a>02164 
<a name="l02165"></a>02165         <span class="comment">/* check all services... */</span>
<a name="l02166"></a>02166         <span class="keywordflow">for</span>(temp_service=service_list;temp_service!=NULL;temp_service=temp_service-&gt;<a class="code" href="structservice__struct.html#a32394c09b9ce32d454c99f8a90e77e8b">next</a>){
<a name="l02167"></a>02167 
<a name="l02168"></a>02168                 <span class="comment">/* skip services we shouldn&#39;t be checking for freshness */</span>
<a name="l02169"></a>02169                 <span class="keywordflow">if</span>(temp_service-&gt;<a class="code" href="structservice__struct.html#a8e47137c1533fa36a4f9b3e5daa49ff6">check_freshness</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l02170"></a>02170                         <span class="keywordflow">continue</span>;
<a name="l02171"></a>02171 
<a name="l02172"></a>02172                 <span class="comment">/* skip services that are currently executing (problems here will be caught by orphaned service check) */</span>
<a name="l02173"></a>02173                 <span class="keywordflow">if</span>(temp_service-&gt;is_executing==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l02174"></a>02174                         <span class="keywordflow">continue</span>;
<a name="l02175"></a>02175 
<a name="l02176"></a>02176                 <span class="comment">/* skip services that have both active and passive checks disabled */</span>
<a name="l02177"></a>02177                 <span class="keywordflow">if</span>(temp_service-&gt;<a class="code" href="structservice__struct.html#adf593773ee59f1c896e2189934ca68eb">checks_enabled</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> &amp;&amp; temp_service-&gt;<a class="code" href="structservice__struct.html#a42f6c98e6316fdca156aec717f4b547c">accept_passive_service_checks</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l02178"></a>02178                         <span class="keywordflow">continue</span>;
<a name="l02179"></a>02179 
<a name="l02180"></a>02180                 <span class="comment">/* skip services that are already being freshened */</span>
<a name="l02181"></a>02181                 <span class="keywordflow">if</span>(temp_service-&gt;is_being_freshened==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l02182"></a>02182                         <span class="keywordflow">continue</span>;
<a name="l02183"></a>02183 
<a name="l02184"></a>02184                 <span class="comment">/* see if the time is right... */</span>
<a name="l02185"></a>02185                 <span class="keywordflow">if</span>(<a class="code" href="base_2utils_8c.html#a49602563f5f03788d56b2d06d2c72bfb">check_time_against_period</a>(current_time,temp_service-&gt;check_period_ptr)==<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>)
<a name="l02186"></a>02186                         <span class="keywordflow">continue</span>;
<a name="l02187"></a>02187 
<a name="l02188"></a>02188                 <span class="comment">/* EXCEPTION */</span>
<a name="l02189"></a>02189                 <span class="comment">/* don&#39;t check freshness of services without regular check intervals if we&#39;re using auto-freshness threshold */</span>
<a name="l02190"></a>02190                 <span class="keywordflow">if</span>(temp_service-&gt;<a class="code" href="structservice__struct.html#a54179e5f4bb721f91c11e943a1f9f32c">check_interval</a>==0 &amp;&amp; temp_service-&gt;<a class="code" href="structservice__struct.html#a03dab54b603b0bdbfc9b740590753e6c">freshness_threshold</a>==0)
<a name="l02191"></a>02191                         <span class="keywordflow">continue</span>;
<a name="l02192"></a>02192 
<a name="l02193"></a>02193                 <span class="comment">/* the results for the last check of this service are stale! */</span>
<a name="l02194"></a>02194                 <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a6e7cdf40c6e908a95798ede828f0ec00">is_service_result_fresh</a>(temp_service,current_time,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l02195"></a>02195 
<a name="l02196"></a>02196                         <span class="comment">/* set the freshen flag */</span>
<a name="l02197"></a>02197                         temp_service-&gt;is_being_freshened=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02198"></a>02198 
<a name="l02199"></a>02199                         <span class="comment">/* schedule an immediate forced check of the service */</span>
<a name="l02200"></a>02200                         <a class="code" href="checks_8c.html#a9b14dc5a4e9f578544fdf45375701517">schedule_service_check</a>(temp_service,current_time,<a class="code" href="include_2common_8h.html#a7c2da00f285e024a7f2f81d633684b0f">CHECK_OPTION_FORCE_EXECUTION</a> | <a class="code" href="include_2common_8h.html#a8c0fa51fb6ee777f4e21f2210f948e2a">CHECK_OPTION_FRESHNESS_CHECK</a>);
<a name="l02201"></a>02201                 }
<a name="l02202"></a>02202 
<a name="l02203"></a>02203         }
<a name="l02204"></a>02204 
<a name="l02205"></a>02205         <span class="keywordflow">return</span>;
<a name="l02206"></a>02206 }
<a name="l02207"></a>02207 
<a name="l02208"></a>02208 
<a name="l02209"></a>02209 
<a name="l02210"></a>02210 <span class="comment">/* tests whether or not a service&#39;s check results are fresh */</span>
<a name="l02211"></a><a class="code" href="icinga_8h.html#a4ebe2dd2c92484586a59e657182c726c">02211</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#a6e7cdf40c6e908a95798ede828f0ec00">is_service_result_fresh</a>(<a class="code" href="structservice__struct.html">service</a> *temp_service, time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>, <span class="keywordtype">int</span> log_this){
<a name="l02212"></a>02212         <span class="keywordtype">int</span> freshness_threshold=0;
<a name="l02213"></a>02213         time_t expiration_time=0L;
<a name="l02214"></a>02214         <span class="keywordtype">int</span> days=0;
<a name="l02215"></a>02215         <span class="keywordtype">int</span> hours=0;
<a name="l02216"></a>02216         <span class="keywordtype">int</span> minutes=0;
<a name="l02217"></a>02217         <span class="keywordtype">int</span> seconds=0;
<a name="l02218"></a>02218         <span class="keywordtype">int</span> tdays=0;
<a name="l02219"></a>02219         <span class="keywordtype">int</span> thours=0;
<a name="l02220"></a>02220         <span class="keywordtype">int</span> tminutes=0;
<a name="l02221"></a>02221         <span class="keywordtype">int</span> tseconds=0;
<a name="l02222"></a>02222 
<a name="l02223"></a>02223         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Checking freshness of service &#39;%s&#39; on host &#39;%s&#39;...\n&quot;</span>,temp_service-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,temp_service-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>);
<a name="l02224"></a>02224 
<a name="l02225"></a>02225         <span class="comment">/* use user-supplied freshness threshold or auto-calculate a freshness threshold to use? */</span>
<a name="l02226"></a>02226         <span class="keywordflow">if</span>(temp_service-&gt;<a class="code" href="structservice__struct.html#a03dab54b603b0bdbfc9b740590753e6c">freshness_threshold</a>==0){
<a name="l02227"></a>02227                 <span class="keywordflow">if</span>(temp_service-&gt;state_type==<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a> || temp_service-&gt;current_state==<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>)
<a name="l02228"></a>02228                         freshness_threshold=(temp_service-&gt;<a class="code" href="structservice__struct.html#a54179e5f4bb721f91c11e943a1f9f32c">check_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>)+temp_service-&gt;latency+<a class="code" href="checks_8c.html#ab5dcf3b2f001760548fd0d0fab5c2cd7">additional_freshness_latency</a>;
<a name="l02229"></a>02229                 <span class="keywordflow">else</span>
<a name="l02230"></a>02230                         freshness_threshold=(temp_service-&gt;<a class="code" href="structservice__struct.html#a6d72d0d693531b23f2873e4081463076">retry_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>)+temp_service-&gt;latency+<a class="code" href="checks_8c.html#ab5dcf3b2f001760548fd0d0fab5c2cd7">additional_freshness_latency</a>;
<a name="l02231"></a>02231         }
<a name="l02232"></a>02232         <span class="keywordflow">else</span>
<a name="l02233"></a>02233                 freshness_threshold=temp_service-&gt;<a class="code" href="structservice__struct.html#a03dab54b603b0bdbfc9b740590753e6c">freshness_threshold</a>;
<a name="l02234"></a>02234 
<a name="l02235"></a>02235         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Freshness thresholds: service=%d, use=%d\n&quot;</span>,temp_service-&gt;<a class="code" href="structservice__struct.html#a03dab54b603b0bdbfc9b740590753e6c">freshness_threshold</a>,freshness_threshold);
<a name="l02236"></a>02236 
<a name="l02237"></a>02237         <span class="comment">/* calculate expiration time */</span>
<a name="l02238"></a>02238         <span class="comment">/* CHANGED 11/10/05 EG - program start is only used in expiration time calculation if &gt; last check AND active checks are enabled, so active checks can become stale immediately upon program startup */</span>
<a name="l02239"></a>02239         <span class="comment">/* CHANGED 02/25/06 SG - passive checks also become stale, so remove dependence on active check logic */</span>
<a name="l02240"></a>02240         <span class="keywordflow">if</span>(temp_service-&gt;has_been_checked==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l02241"></a>02241                 expiration_time=(time_t)(<a class="code" href="checks_8c.html#aa9869971067b17a06b557d85afa4d8cd">event_start</a>+freshness_threshold);
<a name="l02242"></a>02242         <span class="comment">/* CHANGED 06/19/07 EG - Per Ton&#39;s suggestion (and user requests), only use program start time over last check if no specific threshold has been set by user.  Otheriwse use it.  Problems can occur if Icinga is restarted more frequently that freshness threshold intervals (services never go stale). */</span>
<a name="l02243"></a>02243         <span class="comment">/* CHANGED 10/07/07 EG - Only match next condition for services that have active checks enabled... */</span>
<a name="l02244"></a>02244         <span class="comment">/* CHANGED 10/07/07 EG - Added max_service_check_spread to expiration time as suggested by Altinity */</span>
<a name="l02245"></a>02245         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(temp_service-&gt;<a class="code" href="structservice__struct.html#adf593773ee59f1c896e2189934ca68eb">checks_enabled</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; <a class="code" href="checks_8c.html#aa9869971067b17a06b557d85afa4d8cd">event_start</a>&gt;temp_service-&gt;last_check &amp;&amp; temp_service-&gt;<a class="code" href="structservice__struct.html#a03dab54b603b0bdbfc9b740590753e6c">freshness_threshold</a>==0)
<a name="l02246"></a>02246                 expiration_time=(time_t)(<a class="code" href="checks_8c.html#aa9869971067b17a06b557d85afa4d8cd">event_start</a>+freshness_threshold+(<a class="code" href="checks_8c.html#a13c7e7d13d812c96e312c5f7ee893a66">max_service_check_spread</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>));
<a name="l02247"></a>02247         <span class="keywordflow">else</span>
<a name="l02248"></a>02248                 expiration_time=(time_t)(temp_service-&gt;last_check+freshness_threshold);
<a name="l02249"></a>02249 
<a name="l02250"></a>02250         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;HBC: %d, PS: %lu, ES: %lu, LC: %lu, CT: %lu, ET: %lu\n&quot;</span>,temp_service-&gt;has_been_checked,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)<a class="code" href="broker_8c.html#a2b5a4f2875a1a545f44ac2faad7a6b67">program_start</a>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)<a class="code" href="checks_8c.html#aa9869971067b17a06b557d85afa4d8cd">event_start</a>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)temp_service-&gt;last_check,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)current_time,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)expiration_time);
<a name="l02251"></a>02251 
<a name="l02252"></a>02252         <span class="comment">/* the results for the last check of this service are stale */</span>
<a name="l02253"></a>02253         <span class="keywordflow">if</span>(expiration_time&lt;current_time){
<a name="l02254"></a>02254 
<a name="l02255"></a>02255                 <a class="code" href="icingastats_8c.html#a13230b1b393a52cbe4c41c44d90085ac">get_time_breakdown</a>((current_time-expiration_time),&amp;days,&amp;hours,&amp;minutes,&amp;seconds);
<a name="l02256"></a>02256                 <a class="code" href="icingastats_8c.html#a13230b1b393a52cbe4c41c44d90085ac">get_time_breakdown</a>(freshness_threshold,&amp;tdays,&amp;thours,&amp;tminutes,&amp;tseconds);
<a name="l02257"></a>02257 
<a name="l02258"></a>02258                 <span class="comment">/* log a warning */</span>
<a name="l02259"></a>02259                 <span class="keywordflow">if</span>(log_this==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l02260"></a>02260                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: The results of service &#39;%s&#39; on host &#39;%s&#39; are stale by %dd %dh %dm %ds (threshold=%dd %dh %dm %ds).  I&#39;m forcing an immediate check of the service.\n&quot;</span>,temp_service-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,temp_service-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>,days,hours,minutes,seconds,tdays,thours,tminutes,tseconds);
<a name="l02261"></a>02261 
<a name="l02262"></a>02262                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Check results for service &#39;%s&#39; on host &#39;%s&#39; are stale by %dd %dh %dm %ds (threshold=%dd %dh %dm %ds).  Forcing an immediate check of the service...\n&quot;</span>,temp_service-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,temp_service-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>,days,hours,minutes,seconds,tdays,thours,tminutes,tseconds);
<a name="l02263"></a>02263 
<a name="l02264"></a>02264                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02265"></a>02265         }
<a name="l02266"></a>02266 
<a name="l02267"></a>02267         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Check results for service &#39;%s&#39; on host &#39;%s&#39; are fresh.\n&quot;</span>,temp_service-&gt;<a class="code" href="structservice__struct.html#a646fc0478ea62db804e9cd8c84f53ad9">description</a>,temp_service-&gt;<a class="code" href="structservice__struct.html#ac8e06ecb2bddf149916fa2f6e4077836">host_name</a>);
<a name="l02268"></a>02268 
<a name="l02269"></a>02269         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02270"></a>02270 }
<a name="l02271"></a>02271 
<a name="l02272"></a>02272 
<a name="l02273"></a>02273 
<a name="l02274"></a>02274 
<a name="l02275"></a>02275 <span class="comment">/******************************************************************/</span>
<a name="l02276"></a>02276 <span class="comment">/*************** COMMON ROUTE/HOST CHECK FUNCTIONS ****************/</span>
<a name="l02277"></a>02277 <span class="comment">/******************************************************************/</span>
<a name="l02278"></a>02278 
<a name="l02279"></a>02279 <span class="comment">/* execute an on-demand check  */</span>
<a name="l02280"></a><a class="code" href="icinga_8h.html#a86a4191aa525b194d80b4f1434507d73">02280</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#af1fc676aa948946ae72918ba650bb509">perform_on_demand_host_check</a>(<a class="code" href="structhost__struct.html">host</a> *hst, <span class="keywordtype">int</span> *check_return_code, <span class="keywordtype">int</span> check_options, <span class="keywordtype">int</span> use_cached_result, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> check_timestamp_horizon){
<a name="l02281"></a>02281 
<a name="l02282"></a>02282         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;perform_on_demand_host_check()\n&quot;</span>);
<a name="l02283"></a>02283 
<a name="l02284"></a>02284         <a class="code" href="checks_8c.html#a61a82be30f244ff0b0b9090d61e67d5f">perform_on_demand_host_check_3x</a>(hst,check_return_code,check_options,use_cached_result,check_timestamp_horizon);
<a name="l02285"></a>02285 
<a name="l02286"></a>02286         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l02287"></a>02287 }
<a name="l02288"></a>02288 
<a name="l02289"></a>02289 
<a name="l02290"></a>02290 
<a name="l02291"></a>02291 <span class="comment">/* execute a scheduled host check using either the 2.x or 3.x logic */</span>
<a name="l02292"></a><a class="code" href="icinga_8h.html#a30d13ed188e8bf2bced5f8200ea13164">02292</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#a7955818a24323061ea28bd65a5419ec9">perform_scheduled_host_check</a>(<a class="code" href="structhost__struct.html">host</a> *hst, <span class="keywordtype">int</span> check_options, <span class="keywordtype">double</span> latency){
<a name="l02293"></a>02293 
<a name="l02294"></a>02294         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;perform_scheduled_host_check()\n&quot;</span>);
<a name="l02295"></a>02295 
<a name="l02296"></a>02296         <a class="code" href="checks_8c.html#a595a22d1d374a4859a68b5cc4d448b3a">run_scheduled_host_check_3x</a>(hst,check_options,latency);
<a name="l02297"></a>02297 
<a name="l02298"></a>02298         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l02299"></a>02299 }
<a name="l02300"></a>02300 
<a name="l02301"></a>02301 
<a name="l02302"></a>02302 
<a name="l02303"></a>02303 <span class="comment">/* schedules an immediate or delayed host check */</span>
<a name="l02304"></a><a class="code" href="icinga_8h.html#a98d814821835bc964ca1bf3e77ac2a65">02304</a> <span class="keywordtype">void</span> <a class="code" href="checks_8c.html#aacf489b05d155c06c18a596107484b79">schedule_host_check</a>(<a class="code" href="structhost__struct.html">host</a> *hst, time_t check_time, <span class="keywordtype">int</span> options){
<a name="l02305"></a>02305         <a class="code" href="structtimed__event__struct.html">timed_event</a> *temp_event=NULL;
<a name="l02306"></a>02306         <a class="code" href="structtimed__event__struct.html">timed_event</a> *new_event=NULL;
<a name="l02307"></a>02307         <span class="keywordtype">int</span> found=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02308"></a>02308         <span class="keywordtype">int</span> use_original_event=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02309"></a>02309 
<a name="l02310"></a>02310 
<a name="l02311"></a>02311         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;schedule_host_check()\n&quot;</span>);
<a name="l02312"></a>02312 
<a name="l02313"></a>02313         <span class="keywordflow">if</span>(hst==NULL)
<a name="l02314"></a>02314                 <span class="keywordflow">return</span>;
<a name="l02315"></a>02315 
<a name="l02316"></a>02316         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Scheduling a %s, active check of host &#39;%s&#39; @ %s&quot;</span>,(options &amp; <a class="code" href="include_2common_8h.html#a7c2da00f285e024a7f2f81d633684b0f">CHECK_OPTION_FORCE_EXECUTION</a>)?<span class="stringliteral">&quot;forced&quot;</span>:<span class="stringliteral">&quot;non-forced&quot;</span>,hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>,ctime(&amp;check_time));
<a name="l02317"></a>02317 
<a name="l02318"></a>02318         <span class="comment">/* don&#39;t schedule a check if active checks of this host are disabled */</span>
<a name="l02319"></a>02319         <span class="keywordflow">if</span>(hst-&gt;<a class="code" href="structhost__struct.html#a3ef980834ed0a10fd7fe1f02a7daba9b">checks_enabled</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> &amp;&amp; !(options &amp; CHECK_OPTION_FORCE_EXECUTION)){
<a name="l02320"></a>02320                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Active checks are disabled for this host.\n&quot;</span>);
<a name="l02321"></a>02321                 <span class="keywordflow">return</span>;
<a name="l02322"></a>02322         }
<a name="l02323"></a>02323 
<a name="l02324"></a>02324         <span class="comment">/* allocate memory for a new event item */</span>
<a name="l02325"></a>02325         <span class="keywordflow">if</span>((new_event=(<a class="code" href="structtimed__event__struct.html">timed_event</a> *)malloc(<span class="keyword">sizeof</span>(<a class="code" href="structtimed__event__struct.html">timed_event</a>)))==NULL){
<a name="l02326"></a>02326 
<a name="l02327"></a>02327                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: Could not reschedule check of host &#39;%s&#39;!\n&quot;</span>,hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l02328"></a>02328 
<a name="l02329"></a>02329                 <span class="keywordflow">return</span>;
<a name="l02330"></a>02330         }
<a name="l02331"></a>02331 
<a name="l02332"></a>02332         <span class="comment">/* default is to use the new event */</span>
<a name="l02333"></a>02333         use_original_event=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02334"></a>02334         found=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02335"></a>02335 
<a name="l02336"></a>02336 <span class="preprocessor">#ifdef PERFORMANCE_INCREASE_BUT_VERY_BAD_IDEA_INDEED</span>
<a name="l02337"></a>02337 <span class="preprocessor"></span>        <span class="comment">/* WARNING! 1/19/07 on-demand async host checks will end up causing mutliple scheduled checks of a host to appear in the queue if the code below is skipped */</span>
<a name="l02338"></a>02338         <span class="comment">/* if(use_large_installation_tweaks==FALSE)... skip code below */</span>
<a name="l02339"></a>02339 <span class="preprocessor">#endif</span>
<a name="l02340"></a>02340 <span class="preprocessor"></span>
<a name="l02341"></a>02341         <span class="comment">/* see if there are any other scheduled checks of this host in the queue */</span>
<a name="l02342"></a>02342         <span class="keywordflow">for</span>(temp_event=event_list_low;temp_event!=NULL;temp_event=temp_event-&gt;<a class="code" href="structtimed__event__struct.html#a8a7e9def5bccc2d9df958f027d62e5a9">next</a>){
<a name="l02343"></a>02343                 <span class="keywordflow">if</span>(temp_event-&gt;<a class="code" href="structtimed__event__struct.html#a07431a09f5ea160cc672347851843060">event_type</a>==<a class="code" href="icinga_8h.html#adac8bc2857b48c06d324ceda474084c8">EVENT_HOST_CHECK</a> &amp;&amp; hst==(<a class="code" href="structhost__struct.html">host</a> *)temp_event-&gt;<a class="code" href="structtimed__event__struct.html#acf4bcbbb5e85490b262342efaba53be7">event_data</a>){
<a name="l02344"></a>02344                         found=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02345"></a>02345                         <span class="keywordflow">break</span>;
<a name="l02346"></a>02346                 }
<a name="l02347"></a>02347         }
<a name="l02348"></a>02348 
<a name="l02349"></a>02349         <span class="comment">/* we found another host check event for this host in the queue - what should we do? */</span>
<a name="l02350"></a>02350         <span class="keywordflow">if</span>(found==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; temp_event!=NULL){
<a name="l02351"></a>02351 
<a name="l02352"></a>02352                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Found another host check event for this host @ %s&quot;</span>,ctime(&amp;temp_event-&gt;<a class="code" href="structtimed__event__struct.html#ab587fd4005d25a52e689ac52cc19dd35">run_time</a>));
<a name="l02353"></a>02353 
<a name="l02354"></a>02354                 <span class="comment">/* use the originally scheduled check unless we decide otherwise */</span>
<a name="l02355"></a>02355                 use_original_event=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02356"></a>02356 
<a name="l02357"></a>02357                 <span class="comment">/* the original event is a forced check... */</span>
<a name="l02358"></a>02358                 <span class="keywordflow">if</span>((temp_event-&gt;<a class="code" href="structtimed__event__struct.html#af99d862c4fbe76165935c3ba01a9944d">event_options</a> &amp; CHECK_OPTION_FORCE_EXECUTION)){
<a name="l02359"></a>02359 
<a name="l02360"></a>02360                         <span class="comment">/* the new event is also forced and its execution time is earlier than the original, so use it instead */</span>
<a name="l02361"></a>02361                         <span class="keywordflow">if</span>((options &amp; CHECK_OPTION_FORCE_EXECUTION) &amp;&amp; (check_time &lt; temp_event-&gt;run_time)){
<a name="l02362"></a>02362                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;New host check event is forced and occurs before the existing event, so the new event be used instead.\n&quot;</span>);
<a name="l02363"></a>02363                                 use_original_event=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02364"></a>02364                         }
<a name="l02365"></a>02365                 }
<a name="l02366"></a>02366 
<a name="l02367"></a>02367                 <span class="comment">/* the original event is not a forced check... */</span>
<a name="l02368"></a>02368                 <span class="keywordflow">else</span>{
<a name="l02369"></a>02369 
<a name="l02370"></a>02370                         <span class="comment">/* the new event is a forced check, so use it instead */</span>
<a name="l02371"></a>02371                         <span class="keywordflow">if</span>((options &amp; CHECK_OPTION_FORCE_EXECUTION)){
<a name="l02372"></a>02372                                 use_original_event=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02373"></a>02373                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;New host check event is forced, so it will be used instead of the existing event.\n&quot;</span>);
<a name="l02374"></a>02374                         }
<a name="l02375"></a>02375 
<a name="l02376"></a>02376                         <span class="comment">/* the new event is not forced either and its execution time is earlier than the original, so use it instead */</span>
<a name="l02377"></a>02377                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(check_time &lt; temp_event-&gt;run_time){
<a name="l02378"></a>02378                                 use_original_event=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02379"></a>02379                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;New host check event occurs before the existing (older) event, so it will be used instead.\n&quot;</span>);
<a name="l02380"></a>02380                         }
<a name="l02381"></a>02381 
<a name="l02382"></a>02382                         <span class="comment">/* the new event is older, so override the existing one */</span>
<a name="l02383"></a>02383                         <span class="keywordflow">else</span>{
<a name="l02384"></a>02384                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;New host check event occurs after the existing event, so we&#39;ll ignore it.\n&quot;</span>);
<a name="l02385"></a>02385                         }
<a name="l02386"></a>02386                 }
<a name="l02387"></a>02387 
<a name="l02388"></a>02388                 <span class="comment">/* the originally queued event won the battle, so keep it */</span>
<a name="l02389"></a>02389                 <span class="keywordflow">if</span>(use_original_event==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l02390"></a>02390                         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(new_event);
<a name="l02391"></a>02391                 }
<a name="l02392"></a>02392 
<a name="l02393"></a>02393                 <span class="comment">/* else use the new event, so remove the old */</span>
<a name="l02394"></a>02394                 <span class="keywordflow">else</span>{
<a name="l02395"></a>02395                         <a class="code" href="events_8c.html#a431ab9294a04ba5faf19fa088bace5d2">remove_event</a>(temp_event,&amp;event_list_low,&amp;event_list_low_tail);
<a name="l02396"></a>02396                         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_event);
<a name="l02397"></a>02397                 }
<a name="l02398"></a>02398         }
<a name="l02399"></a>02399 
<a name="l02400"></a>02400         <span class="comment">/* save check options for retention purposes */</span>
<a name="l02401"></a>02401         hst-&gt;check_options=options;
<a name="l02402"></a>02402 
<a name="l02403"></a>02403         <span class="comment">/* use the new event */</span>
<a name="l02404"></a>02404         <span class="keywordflow">if</span>(use_original_event==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l02405"></a>02405 
<a name="l02406"></a>02406                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Scheduling new host check event.\n&quot;</span>);
<a name="l02407"></a>02407 
<a name="l02408"></a>02408                 <span class="comment">/* set the next host check time */</span>
<a name="l02409"></a>02409                 hst-&gt;next_check=check_time;
<a name="l02410"></a>02410 
<a name="l02411"></a>02411                 <span class="comment">/* place the new event in the event queue */</span>
<a name="l02412"></a>02412                 new_event-&gt;<a class="code" href="structtimed__event__struct.html#a07431a09f5ea160cc672347851843060">event_type</a>=<a class="code" href="icinga_8h.html#adac8bc2857b48c06d324ceda474084c8">EVENT_HOST_CHECK</a>;
<a name="l02413"></a>02413                 new_event-&gt;<a class="code" href="structtimed__event__struct.html#acf4bcbbb5e85490b262342efaba53be7">event_data</a>=(<span class="keywordtype">void</span> *)hst;
<a name="l02414"></a>02414                 new_event-&gt;<a class="code" href="structtimed__event__struct.html#ad8d32f8baac88c5da74f6af72dd977ec">event_args</a>=(<span class="keywordtype">void</span> *)NULL;
<a name="l02415"></a>02415                 new_event-&gt;<a class="code" href="structtimed__event__struct.html#af99d862c4fbe76165935c3ba01a9944d">event_options</a>=options;
<a name="l02416"></a>02416                 new_event-&gt;<a class="code" href="structtimed__event__struct.html#ab587fd4005d25a52e689ac52cc19dd35">run_time</a>=hst-&gt;next_check;
<a name="l02417"></a>02417                 new_event-&gt;<a class="code" href="structtimed__event__struct.html#a380357264ff8bcfe3be16b3799a20245">recurring</a>=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02418"></a>02418                 new_event-&gt;<a class="code" href="structtimed__event__struct.html#aadf4ef3f63ad109cea37b99d947f8b43">event_interval</a>=0L;
<a name="l02419"></a>02419                 new_event-&gt;<a class="code" href="structtimed__event__struct.html#a80ac445ac29a4e8d631416328f15e711">timing_func</a>=NULL;
<a name="l02420"></a>02420                 new_event-&gt;<a class="code" href="structtimed__event__struct.html#a7699c13f3cd6740e0bda5df3dd0b2473">compensate_for_time_change</a>=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02421"></a>02421                 <a class="code" href="events_8c.html#aa794c69458107f2f37800beb11944f5a">reschedule_event</a>(new_event,&amp;event_list_low,&amp;event_list_low_tail);
<a name="l02422"></a>02422         }
<a name="l02423"></a>02423 
<a name="l02424"></a>02424         <span class="keywordflow">else</span>{
<a name="l02425"></a>02425                 <span class="comment">/* reset the next check time (it may be out of sync) */</span>
<a name="l02426"></a>02426                 <span class="keywordflow">if</span>(temp_event!=NULL)
<a name="l02427"></a>02427                         hst-&gt;next_check=temp_event-&gt;<a class="code" href="structtimed__event__struct.html#ab587fd4005d25a52e689ac52cc19dd35">run_time</a>;
<a name="l02428"></a>02428 
<a name="l02429"></a>02429                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Keeping original host check event (ignoring the new one).\n&quot;</span>);
<a name="l02430"></a>02430         }
<a name="l02431"></a>02431 
<a name="l02432"></a>02432         <span class="keywordflow">return</span>;
<a name="l02433"></a>02433 }
<a name="l02434"></a>02434 
<a name="l02435"></a>02435 
<a name="l02436"></a>02436 
<a name="l02437"></a>02437 <span class="comment">/* checks host dependencies */</span>
<a name="l02438"></a><a class="code" href="icinga_8h.html#af059cb6fa65611124b3efa5b9e45f560">02438</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#ac467ac509d3608fa5105ba8eaaea6910">check_host_dependencies</a>(<a class="code" href="structhost__struct.html">host</a> *hst,<span class="keywordtype">int</span> dependency_type){
<a name="l02439"></a>02439         <a class="code" href="structhostdependency__struct.html">hostdependency</a> *temp_dependency=NULL;
<a name="l02440"></a>02440         <a class="code" href="structhost__struct.html">host</a> *temp_host=NULL;
<a name="l02441"></a>02441         <span class="keywordtype">int</span> state=<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>;
<a name="l02442"></a>02442         time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>=0L;
<a name="l02443"></a>02443         <span class="keywordtype">void</span> *ptr=NULL;
<a name="l02444"></a>02444 
<a name="l02445"></a>02445 
<a name="l02446"></a>02446         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;check_host_dependencies()\n&quot;</span>);
<a name="l02447"></a>02447 
<a name="l02448"></a>02448         <span class="comment">/* check all dependencies... */</span>
<a name="l02449"></a>02449         <span class="keywordflow">for</span>(temp_dependency=<a class="code" href="objects_8c.html#a548bd02d785a9bc99c58599312e3ec51">get_first_hostdependency_by_dependent_host</a>(hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>,&amp;ptr);temp_dependency!=NULL;temp_dependency=<a class="code" href="objects_8c.html#ab963c7b6af43e541e5a147f5ac3f5aa6">get_next_hostdependency_by_dependent_host</a>(hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>,&amp;ptr)){
<a name="l02450"></a>02450 
<a name="l02451"></a>02451                 <span class="comment">/* only check dependencies of the desired type (notification or execution) */</span>
<a name="l02452"></a>02452                 <span class="keywordflow">if</span>(temp_dependency-&gt;<a class="code" href="structhostdependency__struct.html#a3ef8b05c32e8f8c832a5508d8163187d">dependency_type</a>!=dependency_type)
<a name="l02453"></a>02453                         <span class="keywordflow">continue</span>;
<a name="l02454"></a>02454 
<a name="l02455"></a>02455                 <span class="comment">/* find the host we depend on... */</span>
<a name="l02456"></a>02456                 <span class="keywordflow">if</span>((temp_host=temp_dependency-&gt;master_host_ptr)==NULL)
<a name="l02457"></a>02457                         <span class="keywordflow">continue</span>;
<a name="l02458"></a>02458 
<a name="l02459"></a>02459                 <span class="comment">/* skip this dependency if it has a timeperiod and the current time isn&#39;t valid */</span>
<a name="l02460"></a>02460                 time(&amp;current_time);
<a name="l02461"></a>02461                 <span class="keywordflow">if</span>(temp_dependency-&gt;<a class="code" href="structhostdependency__struct.html#a6f3c4748c01302d126449f88a3d0896e">dependency_period</a>!=NULL &amp;&amp; <a class="code" href="base_2utils_8c.html#a49602563f5f03788d56b2d06d2c72bfb">check_time_against_period</a>(current_time,temp_dependency-&gt;dependency_period_ptr)==<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>)
<a name="l02462"></a>02462                         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02463"></a>02463 
<a name="l02464"></a>02464                 <span class="comment">/* get the status to use (use last hard state if its currently in a soft state) */</span>
<a name="l02465"></a>02465                 <span class="keywordflow">if</span>(temp_host-&gt;state_type==<a class="code" href="include_2common_8h.html#a74a8e12b67587cb027f5f12bb7b0fe8d">SOFT_STATE</a> &amp;&amp; <a class="code" href="checks_8c.html#a7c9ecd6259817de56ca91f1adaaea842">soft_state_dependencies</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l02466"></a>02466                         state=temp_host-&gt;last_hard_state;
<a name="l02467"></a>02467                 <span class="keywordflow">else</span>
<a name="l02468"></a>02468                         state=temp_host-&gt;current_state;
<a name="l02469"></a>02469 
<a name="l02470"></a>02470                 <span class="comment">/* is the host we depend on in state that fails the dependency tests? */</span>
<a name="l02471"></a>02471                 <span class="keywordflow">if</span>(state==<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a> &amp;&amp; temp_dependency-&gt;<a class="code" href="structhostdependency__struct.html#a511fc2510fa860ee6e4868b196705272">fail_on_up</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l02472"></a>02472                         <span class="keywordflow">return</span> <a class="code" href="icinga_8h.html#a9c4ca9fdb0f89ec497ae74bf7ab7404c">DEPENDENCIES_FAILED</a>;
<a name="l02473"></a>02473                 <span class="keywordflow">if</span>(state==<a class="code" href="icinga_8h.html#a19d20cca11e4cf399742ad25c05d73fb">HOST_DOWN</a> &amp;&amp; temp_dependency-&gt;<a class="code" href="structhostdependency__struct.html#ab19ac3915f0377cd05e686d903a63450">fail_on_down</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l02474"></a>02474                         <span class="keywordflow">return</span> <a class="code" href="icinga_8h.html#a9c4ca9fdb0f89ec497ae74bf7ab7404c">DEPENDENCIES_FAILED</a>;
<a name="l02475"></a>02475                 <span class="keywordflow">if</span>(state==<a class="code" href="icinga_8h.html#ab1433105627834e0a2c670250bf64285">HOST_UNREACHABLE</a> &amp;&amp; temp_dependency-&gt;<a class="code" href="structhostdependency__struct.html#ae9bbc2108ca84ef881f936717b41fa2e">fail_on_unreachable</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l02476"></a>02476                         <span class="keywordflow">return</span> <a class="code" href="icinga_8h.html#a9c4ca9fdb0f89ec497ae74bf7ab7404c">DEPENDENCIES_FAILED</a>;
<a name="l02477"></a>02477                 <span class="keywordflow">if</span>((state==<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a> &amp;&amp; temp_host-&gt;has_been_checked==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) &amp;&amp; temp_dependency-&gt;<a class="code" href="structhostdependency__struct.html#a3c265ed2b9316f567932c3fa9a0c05df">fail_on_pending</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l02478"></a>02478                         <span class="keywordflow">return</span> <a class="code" href="icinga_8h.html#a9c4ca9fdb0f89ec497ae74bf7ab7404c">DEPENDENCIES_FAILED</a>;
<a name="l02479"></a>02479 
<a name="l02480"></a>02480                 <span class="comment">/* immediate dependencies ok at this point - check parent dependencies if necessary */</span>
<a name="l02481"></a>02481                 <span class="keywordflow">if</span>(temp_dependency-&gt;<a class="code" href="structhostdependency__struct.html#a2f35a9287c53f9dbe5ff93dca270258a">inherits_parent</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l02482"></a>02482                         <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#ac467ac509d3608fa5105ba8eaaea6910">check_host_dependencies</a>(temp_host,dependency_type)!=<a class="code" href="icinga_8h.html#aa91fb10787e799c2344282b53faa929e">DEPENDENCIES_OK</a>)
<a name="l02483"></a>02483                                 <span class="keywordflow">return</span> <a class="code" href="icinga_8h.html#a9c4ca9fdb0f89ec497ae74bf7ab7404c">DEPENDENCIES_FAILED</a>;
<a name="l02484"></a>02484                 }
<a name="l02485"></a>02485         }
<a name="l02486"></a>02486 
<a name="l02487"></a>02487         <span class="keywordflow">return</span> <a class="code" href="icinga_8h.html#aa91fb10787e799c2344282b53faa929e">DEPENDENCIES_OK</a>;
<a name="l02488"></a>02488 }
<a name="l02489"></a>02489 
<a name="l02490"></a>02490 
<a name="l02491"></a>02491 
<a name="l02492"></a>02492 <span class="comment">/* check for hosts that never returned from a check... */</span>
<a name="l02493"></a><a class="code" href="icinga_8h.html#a338f9183d4860d527e15aafe96decaa6">02493</a> <span class="keywordtype">void</span> <a class="code" href="checks_8c.html#a338f9183d4860d527e15aafe96decaa6">check_for_orphaned_hosts</a>(<span class="keywordtype">void</span>){
<a name="l02494"></a>02494         <a class="code" href="structhost__struct.html">host</a> *temp_host=NULL;
<a name="l02495"></a>02495         time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>=0L;
<a name="l02496"></a>02496         time_t expected_time=0L;
<a name="l02497"></a>02497 
<a name="l02498"></a>02498 
<a name="l02499"></a>02499         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;check_for_orphaned_hosts()\n&quot;</span>);
<a name="l02500"></a>02500 
<a name="l02501"></a>02501         <span class="comment">/* get the current time */</span>
<a name="l02502"></a>02502         time(&amp;current_time);
<a name="l02503"></a>02503 
<a name="l02504"></a>02504         <span class="comment">/* check all hosts... */</span>
<a name="l02505"></a>02505         <span class="keywordflow">for</span>(temp_host=host_list;temp_host!=NULL;temp_host=temp_host-&gt;<a class="code" href="structhost__struct.html#a1978313b0f984953066cdb6c1c4ee31c">next</a>){
<a name="l02506"></a>02506 
<a name="l02507"></a>02507                 <span class="comment">/* skip hosts that don&#39;t have a set check interval (on-demand checks are missed by the orphan logic) */</span>
<a name="l02508"></a>02508                 <span class="keywordflow">if</span>(temp_host-&gt;next_check==(time_t)0L)
<a name="l02509"></a>02509                         <span class="keywordflow">continue</span>;
<a name="l02510"></a>02510 
<a name="l02511"></a>02511                 <span class="comment">/* skip hosts that are not currently executing */</span>
<a name="l02512"></a>02512                 <span class="keywordflow">if</span>(temp_host-&gt;is_executing==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l02513"></a>02513                         <span class="keywordflow">continue</span>;
<a name="l02514"></a>02514 
<a name="l02515"></a>02515                 <span class="comment">/* determine the time at which the check results should have come in (allow 10 minutes slack time) */</span>
<a name="l02516"></a>02516                 expected_time=(time_t)(temp_host-&gt;next_check+temp_host-&gt;latency+<a class="code" href="checks_8c.html#a57a8709265e39d9953db6dd65bfc0796">host_check_timeout</a>+<a class="code" href="checks_8c.html#af5316c1b7ca4d4261fb4edc45cafcca2">check_reaper_interval</a>+600);
<a name="l02517"></a>02517 
<a name="l02518"></a>02518                 <span class="comment">/* this host was supposed to have executed a while ago, but for some reason the results haven&#39;t come back in... */</span>
<a name="l02519"></a>02519                 <span class="keywordflow">if</span>(expected_time&lt;current_time){
<a name="l02520"></a>02520 
<a name="l02521"></a>02521                         <span class="comment">/* log a warning */</span>
<a name="l02522"></a>02522                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: The check of host &#39;%s&#39; looks like it was orphaned (results never came back).  I&#39;m scheduling an immediate check of the host...\n&quot;</span>,temp_host-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l02523"></a>02523 
<a name="l02524"></a>02524                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Host &#39;%s&#39; was orphaned, so we&#39;re scheduling an immediate check...\n&quot;</span>,temp_host-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l02525"></a>02525 
<a name="l02526"></a>02526                         <span class="comment">/* decrement the number of running host checks */</span>
<a name="l02527"></a>02527                         <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a546436c5e70468c98d7b4a7f335a170b">currently_running_host_checks</a>&gt;0)
<a name="l02528"></a>02528                                 <a class="code" href="checks_8c.html#a546436c5e70468c98d7b4a7f335a170b">currently_running_host_checks</a>--;
<a name="l02529"></a>02529 
<a name="l02530"></a>02530                         <span class="comment">/* disable the executing flag */</span>
<a name="l02531"></a>02531                         temp_host-&gt;is_executing=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02532"></a>02532 
<a name="l02533"></a>02533                         <span class="comment">/* schedule an immediate check of the host */</span>
<a name="l02534"></a>02534                         <a class="code" href="checks_8c.html#aacf489b05d155c06c18a596107484b79">schedule_host_check</a>(temp_host,current_time,<a class="code" href="include_2common_8h.html#a3d4925829311731add8fdaaa283863dc">CHECK_OPTION_ORPHAN_CHECK</a>);
<a name="l02535"></a>02535                 }
<a name="l02536"></a>02536 
<a name="l02537"></a>02537         }
<a name="l02538"></a>02538 
<a name="l02539"></a>02539         <span class="keywordflow">return</span>;
<a name="l02540"></a>02540 }
<a name="l02541"></a>02541 
<a name="l02542"></a>02542 
<a name="l02543"></a>02543 
<a name="l02544"></a>02544 <span class="comment">/* check freshness of host results */</span>
<a name="l02545"></a><a class="code" href="icinga_8h.html#ae4d8149d3e49d18b241750e5db03725f">02545</a> <span class="keywordtype">void</span> <a class="code" href="checks_8c.html#ae4d8149d3e49d18b241750e5db03725f">check_host_result_freshness</a>(<span class="keywordtype">void</span>){
<a name="l02546"></a>02546         <a class="code" href="structhost__struct.html">host</a> *temp_host=NULL;
<a name="l02547"></a>02547         time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>=0L;
<a name="l02548"></a>02548 
<a name="l02549"></a>02549 
<a name="l02550"></a>02550         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;check_host_result_freshness()\n&quot;</span>);
<a name="l02551"></a>02551         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Attempting to check the freshness of host check results...\n&quot;</span>);
<a name="l02552"></a>02552 
<a name="l02553"></a>02553         <span class="comment">/* bail out if we&#39;re not supposed to be checking freshness */</span>
<a name="l02554"></a>02554         <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a4f92c0b0b8d9f56191bcdf5dc5a706b2">check_host_freshness</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l02555"></a>02555                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Host freshness checking is disabled.\n&quot;</span>);
<a name="l02556"></a>02556                 <span class="keywordflow">return</span>;
<a name="l02557"></a>02557         }
<a name="l02558"></a>02558 
<a name="l02559"></a>02559         <span class="comment">/* get the current time */</span>
<a name="l02560"></a>02560         time(&amp;current_time);
<a name="l02561"></a>02561 
<a name="l02562"></a>02562         <span class="comment">/* check all hosts... */</span>
<a name="l02563"></a>02563         <span class="keywordflow">for</span>(temp_host=host_list;temp_host!=NULL;temp_host=temp_host-&gt;<a class="code" href="structhost__struct.html#a1978313b0f984953066cdb6c1c4ee31c">next</a>){
<a name="l02564"></a>02564 
<a name="l02565"></a>02565                 <span class="comment">/* skip hosts we shouldn&#39;t be checking for freshness */</span>
<a name="l02566"></a>02566                 <span class="keywordflow">if</span>(temp_host-&gt;<a class="code" href="structhost__struct.html#a0bbe71ab7ff3b11eee89d66cb9ab3d1b">check_freshness</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l02567"></a>02567                         <span class="keywordflow">continue</span>;
<a name="l02568"></a>02568 
<a name="l02569"></a>02569                 <span class="comment">/* skip hosts that have both active and passive checks disabled */</span>
<a name="l02570"></a>02570                 <span class="keywordflow">if</span>(temp_host-&gt;<a class="code" href="structhost__struct.html#a3ef980834ed0a10fd7fe1f02a7daba9b">checks_enabled</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> &amp;&amp; temp_host-&gt;<a class="code" href="structhost__struct.html#a02adcb873992725eadf6e3b7946ec475">accept_passive_host_checks</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l02571"></a>02571                         <span class="keywordflow">continue</span>;
<a name="l02572"></a>02572 
<a name="l02573"></a>02573                 <span class="comment">/* skip hosts that are currently executing (problems here will be caught by orphaned host check) */</span>
<a name="l02574"></a>02574                 <span class="keywordflow">if</span>(temp_host-&gt;is_executing==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l02575"></a>02575                         <span class="keywordflow">continue</span>;
<a name="l02576"></a>02576 
<a name="l02577"></a>02577                 <span class="comment">/* skip hosts that are already being freshened */</span>
<a name="l02578"></a>02578                 <span class="keywordflow">if</span>(temp_host-&gt;is_being_freshened==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l02579"></a>02579                         <span class="keywordflow">continue</span>;
<a name="l02580"></a>02580 
<a name="l02581"></a>02581                 <span class="comment">/* see if the time is right... */</span>
<a name="l02582"></a>02582                 <span class="keywordflow">if</span>(<a class="code" href="base_2utils_8c.html#a49602563f5f03788d56b2d06d2c72bfb">check_time_against_period</a>(current_time,temp_host-&gt;check_period_ptr)==<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>)
<a name="l02583"></a>02583                         <span class="keywordflow">continue</span>;
<a name="l02584"></a>02584 
<a name="l02585"></a>02585                 <span class="comment">/* the results for the last check of this host are stale */</span>
<a name="l02586"></a>02586                 <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a7a39bf6ff568d09ecdff304a45587027">is_host_result_fresh</a>(temp_host,current_time,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l02587"></a>02587 
<a name="l02588"></a>02588                         <span class="comment">/* set the freshen flag */</span>
<a name="l02589"></a>02589                         temp_host-&gt;is_being_freshened=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02590"></a>02590 
<a name="l02591"></a>02591                         <span class="comment">/* schedule an immediate forced check of the host */</span>
<a name="l02592"></a>02592                         <a class="code" href="checks_8c.html#aacf489b05d155c06c18a596107484b79">schedule_host_check</a>(temp_host,current_time,<a class="code" href="include_2common_8h.html#a7c2da00f285e024a7f2f81d633684b0f">CHECK_OPTION_FORCE_EXECUTION</a> | <a class="code" href="include_2common_8h.html#a8c0fa51fb6ee777f4e21f2210f948e2a">CHECK_OPTION_FRESHNESS_CHECK</a>);
<a name="l02593"></a>02593                 }
<a name="l02594"></a>02594         }
<a name="l02595"></a>02595 
<a name="l02596"></a>02596         <span class="keywordflow">return</span>;
<a name="l02597"></a>02597 }
<a name="l02598"></a>02598 
<a name="l02599"></a>02599 
<a name="l02600"></a>02600 
<a name="l02601"></a>02601 <span class="comment">/* checks to see if a hosts&#39;s check results are fresh */</span>
<a name="l02602"></a><a class="code" href="icinga_8h.html#ada55ad22672e406a609923c0a3763cc6">02602</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#a7a39bf6ff568d09ecdff304a45587027">is_host_result_fresh</a>(<a class="code" href="structhost__struct.html">host</a> *temp_host, time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>, <span class="keywordtype">int</span> log_this){
<a name="l02603"></a>02603         time_t expiration_time=0L;
<a name="l02604"></a>02604         <span class="keywordtype">int</span> freshness_threshold=0;
<a name="l02605"></a>02605         <span class="keywordtype">int</span> days=0;
<a name="l02606"></a>02606         <span class="keywordtype">int</span> hours=0;
<a name="l02607"></a>02607         <span class="keywordtype">int</span> minutes=0;
<a name="l02608"></a>02608         <span class="keywordtype">int</span> seconds=0;
<a name="l02609"></a>02609         <span class="keywordtype">int</span> tdays=0;
<a name="l02610"></a>02610         <span class="keywordtype">int</span> thours=0;
<a name="l02611"></a>02611         <span class="keywordtype">int</span> tminutes=0;
<a name="l02612"></a>02612         <span class="keywordtype">int</span> tseconds=0;
<a name="l02613"></a>02613 
<a name="l02614"></a>02614         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Checking freshness of host &#39;%s&#39;...\n&quot;</span>,temp_host-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l02615"></a>02615 
<a name="l02616"></a>02616         <span class="comment">/* use user-supplied freshness threshold or auto-calculate a freshness threshold to use? */</span>
<a name="l02617"></a>02617         <span class="keywordflow">if</span>(temp_host-&gt;<a class="code" href="structhost__struct.html#a04b2f9f531dd1503e2c53b1b3d9fe2c4">freshness_threshold</a>==0)
<a name="l02618"></a>02618                 freshness_threshold=(temp_host-&gt;<a class="code" href="structhost__struct.html#a75fa71ddb31a4fbfd6ce60ebd69d6064">check_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>)+temp_host-&gt;latency+<a class="code" href="checks_8c.html#ab5dcf3b2f001760548fd0d0fab5c2cd7">additional_freshness_latency</a>;
<a name="l02619"></a>02619         <span class="keywordflow">else</span>
<a name="l02620"></a>02620                 freshness_threshold=temp_host-&gt;<a class="code" href="structhost__struct.html#a04b2f9f531dd1503e2c53b1b3d9fe2c4">freshness_threshold</a>;
<a name="l02621"></a>02621 
<a name="l02622"></a>02622         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Freshness thresholds: host=%d, use=%d\n&quot;</span>,temp_host-&gt;<a class="code" href="structhost__struct.html#a04b2f9f531dd1503e2c53b1b3d9fe2c4">freshness_threshold</a>,freshness_threshold);
<a name="l02623"></a>02623 
<a name="l02624"></a>02624         <span class="comment">/* calculate expiration time */</span>
<a name="l02625"></a>02625         <span class="comment">/* CHANGED 11/10/05 EG - program start is only used in expiration time calculation if &gt; last check AND active checks are enabled, so active checks can become stale immediately upon program startup */</span>
<a name="l02626"></a>02626         <span class="keywordflow">if</span>(temp_host-&gt;has_been_checked==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l02627"></a>02627                 expiration_time=(time_t)(<a class="code" href="checks_8c.html#aa9869971067b17a06b557d85afa4d8cd">event_start</a>+freshness_threshold);
<a name="l02628"></a>02628         <span class="comment">/* CHANGED 06/19/07 EG - Per Ton&#39;s suggestion (and user requests), only use program start time over last check if no specific threshold has been set by user.  Otheriwse use it.  Problems can occur if Icinga is restarted more frequently that freshness threshold intervals (hosts never go stale). */</span>
<a name="l02629"></a>02629         <span class="comment">/* CHANGED 10/07/07 EG - Added max_host_check_spread to expiration time as suggested by Altinity */</span>
<a name="l02630"></a>02630         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(temp_host-&gt;<a class="code" href="structhost__struct.html#a3ef980834ed0a10fd7fe1f02a7daba9b">checks_enabled</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; <a class="code" href="checks_8c.html#aa9869971067b17a06b557d85afa4d8cd">event_start</a>&gt;temp_host-&gt;last_check &amp;&amp; temp_host-&gt;<a class="code" href="structhost__struct.html#a04b2f9f531dd1503e2c53b1b3d9fe2c4">freshness_threshold</a>==0)
<a name="l02631"></a>02631                 expiration_time=(time_t)(<a class="code" href="checks_8c.html#aa9869971067b17a06b557d85afa4d8cd">event_start</a>+freshness_threshold+(<a class="code" href="checks_8c.html#a6c91e39bfb52d983e8a77a70698f147e">max_host_check_spread</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>));
<a name="l02632"></a>02632         <span class="keywordflow">else</span>
<a name="l02633"></a>02633                 expiration_time=(time_t)(temp_host-&gt;last_check+freshness_threshold);
<a name="l02634"></a>02634 
<a name="l02635"></a>02635         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;HBC: %d, PS: %lu, ES: %lu, LC: %lu, CT: %lu, ET: %lu\n&quot;</span>,temp_host-&gt;has_been_checked,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)<a class="code" href="broker_8c.html#a2b5a4f2875a1a545f44ac2faad7a6b67">program_start</a>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)<a class="code" href="checks_8c.html#aa9869971067b17a06b557d85afa4d8cd">event_start</a>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)temp_host-&gt;last_check,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)current_time,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)expiration_time);
<a name="l02636"></a>02636 
<a name="l02637"></a>02637         <span class="comment">/* the results for the last check of this host are stale */</span>
<a name="l02638"></a>02638         <span class="keywordflow">if</span>(expiration_time&lt;current_time){
<a name="l02639"></a>02639 
<a name="l02640"></a>02640                 <a class="code" href="icingastats_8c.html#a13230b1b393a52cbe4c41c44d90085ac">get_time_breakdown</a>((current_time-expiration_time),&amp;days,&amp;hours,&amp;minutes,&amp;seconds);
<a name="l02641"></a>02641                 <a class="code" href="icingastats_8c.html#a13230b1b393a52cbe4c41c44d90085ac">get_time_breakdown</a>(freshness_threshold,&amp;tdays,&amp;thours,&amp;tminutes,&amp;tseconds);
<a name="l02642"></a>02642 
<a name="l02643"></a>02643                 <span class="comment">/* log a warning */</span>
<a name="l02644"></a>02644                 <span class="keywordflow">if</span>(log_this==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l02645"></a>02645                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: The results of host &#39;%s&#39; are stale by %dd %dh %dm %ds (threshold=%dd %dh %dm %ds).  I&#39;m forcing an immediate check of the host.\n&quot;</span>,temp_host-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>,days,hours,minutes,seconds,tdays,thours,tminutes,tseconds);
<a name="l02646"></a>02646 
<a name="l02647"></a>02647                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Check results for host &#39;%s&#39; are stale by %dd %dh %dm %ds (threshold=%dd %dh %dm %ds).  Forcing an immediate check of the host...\n&quot;</span>,temp_host-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>,days,hours,minutes,seconds,tdays,thours,tminutes,tseconds);
<a name="l02648"></a>02648 
<a name="l02649"></a>02649                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02650"></a>02650         }
<a name="l02651"></a>02651         <span class="keywordflow">else</span>
<a name="l02652"></a>02652                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Check results for host &#39;%s&#39; are fresh.\n&quot;</span>,temp_host-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l02653"></a>02653 
<a name="l02654"></a>02654         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02655"></a>02655 }
<a name="l02656"></a>02656 
<a name="l02657"></a>02657 
<a name="l02658"></a>02658 
<a name="l02659"></a>02659 <span class="comment">/******************************************************************/</span>
<a name="l02660"></a>02660 <span class="comment">/************* Icinga 3.X ROUTE/HOST CHECK FUNCTIONS **************/</span>
<a name="l02661"></a>02661 <span class="comment">/******************************************************************/</span>
<a name="l02662"></a>02662 
<a name="l02663"></a>02663 
<a name="l02664"></a>02664 <span class="comment">/*** ON-DEMAND HOST CHECKS USE THIS FUNCTION ***/</span>
<a name="l02665"></a>02665 <span class="comment">/* check to see if we can reach the host */</span>
<a name="l02666"></a><a class="code" href="icinga_8h.html#a2e1d92808f6d23d4d90b9254ee0d4199">02666</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#a61a82be30f244ff0b0b9090d61e67d5f">perform_on_demand_host_check_3x</a>(<a class="code" href="structhost__struct.html">host</a> *hst, <span class="keywordtype">int</span> *check_result_code, <span class="keywordtype">int</span> check_options, <span class="keywordtype">int</span> use_cached_result, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> check_timestamp_horizon){
<a name="l02667"></a>02667         <span class="keywordtype">int</span> result=<a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l02668"></a>02668 
<a name="l02669"></a>02669         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;perform_on_demand_host_check_3x()\n&quot;</span>);
<a name="l02670"></a>02670 
<a name="l02671"></a>02671         <span class="comment">/* make sure we have a host */</span>
<a name="l02672"></a>02672         <span class="keywordflow">if</span>(hst==NULL)
<a name="l02673"></a>02673                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l02674"></a>02674 
<a name="l02675"></a>02675         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;** On-demand check for host &#39;%s&#39;...\n&quot;</span>,hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l02676"></a>02676 
<a name="l02677"></a>02677         <span class="comment">/* check the status of the host */</span>
<a name="l02678"></a>02678         result=<a class="code" href="checks_8c.html#a9ef139bca6ec112f21d6ac880cfa8483">run_sync_host_check_3x</a>(hst,check_result_code,check_options,use_cached_result,check_timestamp_horizon);
<a name="l02679"></a>02679 
<a name="l02680"></a>02680         <span class="keywordflow">return</span> result;
<a name="l02681"></a>02681 }
<a name="l02682"></a>02682 
<a name="l02683"></a>02683 
<a name="l02684"></a>02684 
<a name="l02685"></a>02685 <span class="comment">/* perform a synchronous check of a host */</span>
<a name="l02686"></a>02686 <span class="comment">/* on-demand host checks will use this... */</span>
<a name="l02687"></a><a class="code" href="icinga_8h.html#a634784b79b8f9f0c272523cc57b9330d">02687</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#a9ef139bca6ec112f21d6ac880cfa8483">run_sync_host_check_3x</a>(<a class="code" href="structhost__struct.html">host</a> *hst, <span class="keywordtype">int</span> *check_result_code, <span class="keywordtype">int</span> check_options, <span class="keywordtype">int</span> use_cached_result, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> check_timestamp_horizon){
<a name="l02688"></a>02688         <span class="keywordtype">int</span> result=<a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l02689"></a>02689         time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>=0L;
<a name="l02690"></a>02690         <span class="keywordtype">int</span> host_result=<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>;
<a name="l02691"></a>02691         <span class="keywordtype">char</span> *old_plugin_output=NULL;
<a name="l02692"></a>02692         <span class="keyword">struct </span>timeval start_time;
<a name="l02693"></a>02693         <span class="keyword">struct </span>timeval end_time;
<a name="l02694"></a>02694 
<a name="l02695"></a>02695 
<a name="l02696"></a>02696         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;run_sync_host_check_3x()\n&quot;</span>);
<a name="l02697"></a>02697 
<a name="l02698"></a>02698         <span class="comment">/* make sure we have a host */</span>
<a name="l02699"></a>02699         <span class="keywordflow">if</span>(hst==NULL)
<a name="l02700"></a>02700                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l02701"></a>02701 
<a name="l02702"></a>02702         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;** Run sync check of host &#39;%s&#39;...\n&quot;</span>,hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l02703"></a>02703 
<a name="l02704"></a>02704         <span class="comment">/* is the host check viable at this time? */</span>
<a name="l02705"></a>02705         <span class="comment">/* if not, return current state and bail out */</span>
<a name="l02706"></a>02706         <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#aaffacd6bdfb12ea872c68d820700213f">check_host_check_viability_3x</a>(hst,check_options,NULL,NULL)==<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>){
<a name="l02707"></a>02707                 <span class="keywordflow">if</span>(check_result_code)
<a name="l02708"></a>02708                         *check_result_code=hst-&gt;current_state;
<a name="l02709"></a>02709                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Host check is not viable at this time.\n&quot;</span>);
<a name="l02710"></a>02710                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l02711"></a>02711         }
<a name="l02712"></a>02712 
<a name="l02713"></a>02713         <span class="comment">/* get the current time */</span>
<a name="l02714"></a>02714         time(&amp;current_time);
<a name="l02715"></a>02715 
<a name="l02716"></a>02716         <span class="comment">/* high resolution start time for event broker */</span>
<a name="l02717"></a>02717         gettimeofday(&amp;start_time,NULL);
<a name="l02718"></a>02718 
<a name="l02719"></a>02719         <span class="comment">/* can we use the last cached host state? */</span>
<a name="l02720"></a>02720         <span class="keywordflow">if</span>(use_cached_result==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; !(check_options &amp; <a class="code" href="include_2common_8h.html#a7c2da00f285e024a7f2f81d633684b0f">CHECK_OPTION_FORCE_EXECUTION</a>)){
<a name="l02721"></a>02721 
<a name="l02722"></a>02722                 <span class="comment">/* we can used the cached result, so return it and get out of here... */</span>
<a name="l02723"></a>02723                 <span class="keywordflow">if</span>(hst-&gt;has_been_checked==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; ((current_time-hst-&gt;last_check) &lt;= check_timestamp_horizon)){
<a name="l02724"></a>02724                         <span class="keywordflow">if</span>(check_result_code)
<a name="l02725"></a>02725                                 *check_result_code=hst-&gt;current_state;
<a name="l02726"></a>02726 
<a name="l02727"></a>02727                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;* Using cached host state: %d\n&quot;</span>,hst-&gt;current_state);
<a name="l02728"></a>02728 
<a name="l02729"></a>02729                         <span class="comment">/* update check statistics */</span>
<a name="l02730"></a>02730                         <a class="code" href="base_2utils_8c.html#ac3e9d864e9a2d00cbd2b8f3cf22ea2c1">update_check_stats</a>(<a class="code" href="include_2common_8h.html#a294c695b3b8a7790a88cd83cdc507543">ACTIVE_ONDEMAND_HOST_CHECK_STATS</a>,current_time);
<a name="l02731"></a>02731                         <a class="code" href="base_2utils_8c.html#ac3e9d864e9a2d00cbd2b8f3cf22ea2c1">update_check_stats</a>(<a class="code" href="include_2common_8h.html#a591cbd02fed0ac4b49e246d41a1174c5">ACTIVE_CACHED_HOST_CHECK_STATS</a>,current_time);
<a name="l02732"></a>02732 
<a name="l02733"></a>02733                         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l02734"></a>02734                 }
<a name="l02735"></a>02735         }
<a name="l02736"></a>02736 
<a name="l02737"></a>02737 
<a name="l02738"></a>02738         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;* Running actual host check: old state=%d\n&quot;</span>,hst-&gt;current_state);
<a name="l02739"></a>02739 
<a name="l02740"></a>02740 
<a name="l02741"></a>02741         <span class="comment">/******** GOOD TO GO FOR A REAL HOST CHECK AT THIS POINT ********/</span>
<a name="l02742"></a>02742 
<a name="l02743"></a>02743         <span class="comment">/* update check statistics */</span>
<a name="l02744"></a>02744         <a class="code" href="base_2utils_8c.html#ac3e9d864e9a2d00cbd2b8f3cf22ea2c1">update_check_stats</a>(<a class="code" href="include_2common_8h.html#a294c695b3b8a7790a88cd83cdc507543">ACTIVE_ONDEMAND_HOST_CHECK_STATS</a>,current_time);
<a name="l02745"></a>02745         <a class="code" href="base_2utils_8c.html#ac3e9d864e9a2d00cbd2b8f3cf22ea2c1">update_check_stats</a>(<a class="code" href="include_2common_8h.html#a5e8d3ed56af719df9b7ea4b26dacf645">SERIAL_HOST_CHECK_STATS</a>,start_time.tv_sec);
<a name="l02746"></a>02746 
<a name="l02747"></a>02747         <span class="comment">/* reset host check latency, since on-demand checks have none */</span>
<a name="l02748"></a>02748         hst-&gt;latency=0.0;
<a name="l02749"></a>02749 
<a name="l02750"></a>02750         <span class="comment">/* adjust host check attempt */</span>
<a name="l02751"></a>02751         <a class="code" href="checks_8c.html#ab34b1556234001a05a9765f063eaf0e6">adjust_host_check_attempt_3x</a>(hst,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02752"></a>02752 
<a name="l02753"></a>02753         <span class="comment">/* save old host state */</span>
<a name="l02754"></a>02754         hst-&gt;last_state=hst-&gt;current_state;
<a name="l02755"></a>02755         <span class="keywordflow">if</span>(hst-&gt;state_type==<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a>)
<a name="l02756"></a>02756                 hst-&gt;last_hard_state=hst-&gt;current_state;
<a name="l02757"></a>02757 
<a name="l02758"></a>02758         <span class="comment">/* save old plugin output for state stalking */</span>
<a name="l02759"></a>02759         <span class="keywordflow">if</span>(hst-&gt;plugin_output)
<a name="l02760"></a>02760                 old_plugin_output=(<span class="keywordtype">char</span> *)strdup(hst-&gt;plugin_output);
<a name="l02761"></a>02761 
<a name="l02762"></a>02762         <span class="comment">/* set the checked flag */</span>
<a name="l02763"></a>02763         hst-&gt;has_been_checked=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02764"></a>02764 
<a name="l02765"></a>02765         <span class="comment">/* clear the freshness flag */</span>
<a name="l02766"></a>02766         hst-&gt;is_being_freshened=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02767"></a>02767 
<a name="l02768"></a>02768         <span class="comment">/* clear check options - we don&#39;t want old check options retained */</span>
<a name="l02769"></a>02769         hst-&gt;check_options=<a class="code" href="include_2common_8h.html#ac2e0ba323965f243a1988566a8ea53da">CHECK_OPTION_NONE</a>;
<a name="l02770"></a>02770 
<a name="l02771"></a>02771         <span class="comment">/* set the check type */</span>
<a name="l02772"></a>02772         hst-&gt;check_type=<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a>;
<a name="l02773"></a>02773 
<a name="l02774"></a>02774 
<a name="l02775"></a>02775         <span class="comment">/*********** EXECUTE THE CHECK AND PROCESS THE RESULTS **********/</span>
<a name="l02776"></a>02776 
<a name="l02777"></a>02777 <span class="preprocessor">#ifdef USE_EVENT_BROKER</span>
<a name="l02778"></a>02778 <span class="preprocessor"></span>        <span class="comment">/* send data to event broker */</span>
<a name="l02779"></a>02779         end_time.tv_sec=0L;
<a name="l02780"></a>02780         end_time.tv_usec=0L;
<a name="l02781"></a>02781         <a class="code" href="broker_8h.html#a7a70fd5a4b2d6afbcaa8bbb5436a065a">broker_host_check</a>(<a class="code" href="broker_8h.html#af4b599c04cd6f532a329317ecf941e97">NEBTYPE_HOSTCHECK_INITIATE</a>,<a class="code" href="broker_8h.html#ae7b50b735fa9d5baf42ab19525993635">NEBFLAG_NONE</a>,<a class="code" href="broker_8h.html#a2e1afa1e543c76a752561dbc9eb38d65">NEBATTR_NONE</a>,hst,<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a>,hst-&gt;current_state,hst-&gt;state_type,start_time,end_time,hst-&gt;<a class="code" href="structhost__struct.html#add4274af8704b502b95ce8ad2ec0ddff">host_check_command</a>,hst-&gt;latency,0.0,<a class="code" href="checks_8c.html#a57a8709265e39d9953db6dd65bfc0796">host_check_timeout</a>,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,0,NULL,NULL,NULL,NULL,NULL);
<a name="l02782"></a>02782 <span class="preprocessor">#endif</span>
<a name="l02783"></a>02783 <span class="preprocessor"></span>
<a name="l02784"></a>02784         <span class="comment">/* execute the host check */</span>
<a name="l02785"></a>02785         host_result=<a class="code" href="checks_8c.html#ad2437de91e902b835de3333874908ca7">execute_sync_host_check_3x</a>(hst);
<a name="l02786"></a>02786 
<a name="l02787"></a>02787         <span class="comment">/* process the host check result */</span>
<a name="l02788"></a>02788         <a class="code" href="checks_8c.html#a74139a3bafaf6ecc8d445e81bc84d392">process_host_check_result_3x</a>(hst,host_result,old_plugin_output,check_options,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,use_cached_result,check_timestamp_horizon);
<a name="l02789"></a>02789 
<a name="l02790"></a>02790         <span class="comment">/* free memory */</span>
<a name="l02791"></a>02791         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(old_plugin_output);
<a name="l02792"></a>02792 
<a name="l02793"></a>02793         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;* Sync host check done: new state=%d\n&quot;</span>,hst-&gt;current_state);
<a name="l02794"></a>02794 
<a name="l02795"></a>02795         <span class="comment">/* high resolution end time for event broker */</span>
<a name="l02796"></a>02796         gettimeofday(&amp;end_time,NULL);
<a name="l02797"></a>02797 
<a name="l02798"></a>02798 <span class="preprocessor">#ifdef USE_EVENT_BROKER</span>
<a name="l02799"></a>02799 <span class="preprocessor"></span>        <span class="comment">/* send data to event broker */</span>
<a name="l02800"></a>02800         <a class="code" href="broker_8h.html#a7a70fd5a4b2d6afbcaa8bbb5436a065a">broker_host_check</a>(<a class="code" href="broker_8h.html#a1d83d192c64f341aca35a6cd145c71be">NEBTYPE_HOSTCHECK_PROCESSED</a>,<a class="code" href="broker_8h.html#ae7b50b735fa9d5baf42ab19525993635">NEBFLAG_NONE</a>,<a class="code" href="broker_8h.html#a2e1afa1e543c76a752561dbc9eb38d65">NEBATTR_NONE</a>,hst,<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a>,hst-&gt;current_state,hst-&gt;state_type,start_time,end_time,hst-&gt;<a class="code" href="structhost__struct.html#add4274af8704b502b95ce8ad2ec0ddff">host_check_command</a>,hst-&gt;latency,hst-&gt;execution_time,<a class="code" href="checks_8c.html#a57a8709265e39d9953db6dd65bfc0796">host_check_timeout</a>,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,hst-&gt;current_state,hst-&gt;<a class="code" href="structhost__struct.html#ab9860d6289fafe65e7244cff5def26fd">processed_command</a>,hst-&gt;plugin_output,hst-&gt;long_plugin_output,hst-&gt;perf_data,NULL);
<a name="l02801"></a>02801 <span class="preprocessor">#endif</span>
<a name="l02802"></a>02802 <span class="preprocessor"></span>
<a name="l02803"></a>02803         <span class="keywordflow">return</span> result;
<a name="l02804"></a>02804 }
<a name="l02805"></a>02805 
<a name="l02806"></a>02806 
<a name="l02807"></a>02807 
<a name="l02808"></a>02808 <span class="comment">/* run an &quot;alive&quot; check on a host */</span>
<a name="l02809"></a>02809 <span class="comment">/* on-demand host checks will use this... */</span>
<a name="l02810"></a><a class="code" href="icinga_8h.html#ad18d37b3d8483c25a69daec9b321fc22">02810</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#ad2437de91e902b835de3333874908ca7">execute_sync_host_check_3x</a>(<a class="code" href="structhost__struct.html">host</a> *hst){
<a name="l02811"></a>02811         <a class="code" href="structicinga__macros.html">icinga_macros</a> mac;
<a name="l02812"></a>02812         <span class="keywordtype">int</span> result=<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>;
<a name="l02813"></a>02813         <span class="keywordtype">int</span> return_result=<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>;
<a name="l02814"></a>02814         <span class="keywordtype">char</span> *processed_command=NULL;
<a name="l02815"></a>02815         <span class="keywordtype">char</span> *raw_command=NULL;
<a name="l02816"></a>02816         <span class="keyword">struct </span>timeval start_time;
<a name="l02817"></a>02817         <span class="keyword">struct </span>timeval end_time;
<a name="l02818"></a>02818         <span class="keywordtype">char</span> *temp_ptr;
<a name="l02819"></a>02819         <span class="keywordtype">int</span> early_timeout=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02820"></a>02820         <span class="keywordtype">double</span> exectime;
<a name="l02821"></a>02821         <span class="keywordtype">char</span> *temp_plugin_output=NULL;
<a name="l02822"></a>02822 <span class="preprocessor">#ifdef USE_EVENT_BROKER</span>
<a name="l02823"></a>02823 <span class="preprocessor"></span>        <span class="keywordtype">int</span> neb_result=<a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l02824"></a>02824 <span class="preprocessor">#endif</span>
<a name="l02825"></a>02825 <span class="preprocessor"></span>
<a name="l02826"></a>02826 
<a name="l02827"></a>02827         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;execute_sync_host_check_3x()\n&quot;</span>);
<a name="l02828"></a>02828 
<a name="l02829"></a>02829         <span class="keywordflow">if</span>(hst==NULL)
<a name="l02830"></a>02830                 <span class="keywordflow">return</span> <a class="code" href="icinga_8h.html#a19d20cca11e4cf399742ad25c05d73fb">HOST_DOWN</a>;
<a name="l02831"></a>02831 
<a name="l02832"></a>02832         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;** Executing sync check of host &#39;%s&#39;...\n&quot;</span>,hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l02833"></a>02833 
<a name="l02834"></a>02834 <span class="preprocessor">#ifdef USE_EVENT_BROKER</span>
<a name="l02835"></a>02835 <span class="preprocessor"></span>        <span class="comment">/* initialize start/end times */</span>
<a name="l02836"></a>02836         start_time.tv_sec=0L;
<a name="l02837"></a>02837         start_time.tv_usec=0L;
<a name="l02838"></a>02838         end_time.tv_sec=0L;
<a name="l02839"></a>02839         end_time.tv_usec=0L;
<a name="l02840"></a>02840 
<a name="l02841"></a>02841         <span class="comment">/* send data to event broker */</span>
<a name="l02842"></a>02842         neb_result=<a class="code" href="broker_8h.html#a7a70fd5a4b2d6afbcaa8bbb5436a065a">broker_host_check</a>(<a class="code" href="broker_8h.html#a92d7b881c6651f7a5fcd094cad98b2ff">NEBTYPE_HOSTCHECK_SYNC_PRECHECK</a>,<a class="code" href="broker_8h.html#ae7b50b735fa9d5baf42ab19525993635">NEBFLAG_NONE</a>,<a class="code" href="broker_8h.html#a2e1afa1e543c76a752561dbc9eb38d65">NEBATTR_NONE</a>,hst,<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a>,hst-&gt;current_state,hst-&gt;state_type,start_time,end_time,hst-&gt;<a class="code" href="structhost__struct.html#add4274af8704b502b95ce8ad2ec0ddff">host_check_command</a>,hst-&gt;latency,0.0,<a class="code" href="checks_8c.html#a57a8709265e39d9953db6dd65bfc0796">host_check_timeout</a>,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,0,NULL,NULL,NULL,NULL,NULL);
<a name="l02843"></a>02843 
<a name="l02844"></a>02844         <span class="comment">/* neb module wants to cancel the host check - return the current state of the host */</span>
<a name="l02845"></a>02845         <span class="keywordflow">if</span>(neb_result==<a class="code" href="neberrors_8h.html#a600d6e38d658749244cc38a42344a389">NEBERROR_CALLBACKCANCEL</a>)
<a name="l02846"></a>02846                 <span class="keywordflow">return</span> hst-&gt;current_state;
<a name="l02847"></a>02847 
<a name="l02848"></a>02848         <span class="comment">/* neb module wants to override the host check - perhaps it will check the host itself */</span>
<a name="l02849"></a>02849         <span class="comment">/* NOTE: if a module does this, it must check the status of the host and populate the data structures BEFORE it returns from the callback! */</span>
<a name="l02850"></a>02850         <span class="keywordflow">if</span>(neb_result==<a class="code" href="neberrors_8h.html#a239dad95dfec616d6591de5368fb78f4">NEBERROR_CALLBACKOVERRIDE</a>)
<a name="l02851"></a>02851                 <span class="keywordflow">return</span> hst-&gt;current_state;
<a name="l02852"></a>02852 <span class="preprocessor">#endif</span>
<a name="l02853"></a>02853 <span class="preprocessor"></span>
<a name="l02854"></a>02854         <span class="comment">/* grab the host macros */</span>
<a name="l02855"></a>02855         memset(&amp;mac, 0, <span class="keyword">sizeof</span>(mac));
<a name="l02856"></a>02856         <a class="code" href="macros_8c.html#a61cae7ada74ecff37182103a3ddc76b9">grab_host_macros_r</a>(&amp;mac, hst);
<a name="l02857"></a>02857 
<a name="l02858"></a>02858         <span class="comment">/* high resolution start time for event broker */</span>
<a name="l02859"></a>02859         gettimeofday(&amp;start_time,NULL);
<a name="l02860"></a>02860 
<a name="l02861"></a>02861         <span class="comment">/* get the last host check time */</span>
<a name="l02862"></a>02862         time(&amp;hst-&gt;last_check);
<a name="l02863"></a>02863 
<a name="l02864"></a>02864         <span class="comment">/* get the raw command line */</span>
<a name="l02865"></a>02865         <a class="code" href="base_2utils_8c.html#a786c23913ee9613d6e4782aa5e33a8e6">get_raw_command_line_r</a>(&amp;mac, hst-&gt;check_command_ptr,hst-&gt;<a class="code" href="structhost__struct.html#add4274af8704b502b95ce8ad2ec0ddff">host_check_command</a>,&amp;raw_command,0);
<a name="l02866"></a>02866         <span class="keywordflow">if</span>(raw_command==NULL) {
<a name="l02867"></a>02867                 <a class="code" href="macros_8c.html#a447a756f699af137cdd85eb4caa4d0e5">clear_volatile_macros_r</a>(&amp;mac);
<a name="l02868"></a>02868                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l02869"></a>02869         }
<a name="l02870"></a>02870 
<a name="l02871"></a>02871         <span class="comment">/* process any macros contained in the argument */</span>
<a name="l02872"></a>02872         <a class="code" href="macros_8c.html#a1be6f89f750b75aeab483d93badda0e4">process_macros_r</a>(&amp;mac, raw_command,&amp;processed_command,0);
<a name="l02873"></a>02873         <span class="keywordflow">if</span>(processed_command==NULL) {
<a name="l02874"></a>02874                 <a class="code" href="macros_8c.html#a447a756f699af137cdd85eb4caa4d0e5">clear_volatile_macros_r</a>(&amp;mac);
<a name="l02875"></a>02875                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l02876"></a>02876         }
<a name="l02877"></a>02877 
<a name="l02878"></a>02878         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(hst-&gt;<a class="code" href="structhost__struct.html#ab9860d6289fafe65e7244cff5def26fd">processed_command</a>);
<a name="l02879"></a>02879         hst-&gt;<a class="code" href="structhost__struct.html#ab9860d6289fafe65e7244cff5def26fd">processed_command</a>=strdup(processed_command);
<a name="l02880"></a>02880 
<a name="l02881"></a>02881 <span class="preprocessor">#ifdef USE_EVENT_BROKER</span>
<a name="l02882"></a>02882 <span class="preprocessor"></span>        <span class="comment">/* send data to event broker */</span>
<a name="l02883"></a>02883         end_time.tv_sec=0L;
<a name="l02884"></a>02884         end_time.tv_usec=0L;
<a name="l02885"></a>02885         <a class="code" href="broker_8h.html#a7a70fd5a4b2d6afbcaa8bbb5436a065a">broker_host_check</a>(<a class="code" href="broker_8h.html#a0f1f6a51b191ef42263e4070e8988ec0">NEBTYPE_HOSTCHECK_RAW_START</a>,<a class="code" href="broker_8h.html#ae7b50b735fa9d5baf42ab19525993635">NEBFLAG_NONE</a>,<a class="code" href="broker_8h.html#a2e1afa1e543c76a752561dbc9eb38d65">NEBATTR_NONE</a>,hst,<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a>,return_result,hst-&gt;state_type,start_time,end_time,hst-&gt;<a class="code" href="structhost__struct.html#add4274af8704b502b95ce8ad2ec0ddff">host_check_command</a>,0.0,0.0,<a class="code" href="checks_8c.html#a57a8709265e39d9953db6dd65bfc0796">host_check_timeout</a>,early_timeout,result,processed_command,hst-&gt;plugin_output,hst-&gt;long_plugin_output,hst-&gt;perf_data,NULL);
<a name="l02886"></a>02886 <span class="preprocessor">#endif</span>
<a name="l02887"></a>02887 <span class="preprocessor"></span>
<a name="l02888"></a>02888         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#acb53d17d520c3d4c373eeb03cb929123">DEBUGL_COMMANDS</a>,1,<span class="stringliteral">&quot;Raw host check command: %s\n&quot;</span>,raw_command);
<a name="l02889"></a>02889         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#acb53d17d520c3d4c373eeb03cb929123">DEBUGL_COMMANDS</a>,0,<span class="stringliteral">&quot;Processed host check ommand: %s\n&quot;</span>,processed_command);
<a name="l02890"></a>02890 
<a name="l02891"></a>02891         <span class="comment">/* clear plugin output and performance data buffers */</span>
<a name="l02892"></a>02892         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(hst-&gt;plugin_output);
<a name="l02893"></a>02893         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(hst-&gt;long_plugin_output);
<a name="l02894"></a>02894         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(hst-&gt;perf_data);
<a name="l02895"></a>02895 
<a name="l02896"></a>02896         <span class="comment">/* run the host check command */</span>
<a name="l02897"></a>02897         result=<a class="code" href="base_2utils_8c.html#aaec741bbcbb039485348567cc5f2ce2c">my_system_r</a>(&amp;mac, processed_command,<a class="code" href="checks_8c.html#a57a8709265e39d9953db6dd65bfc0796">host_check_timeout</a>,&amp;early_timeout,&amp;exectime,&amp;temp_plugin_output,<a class="code" href="icinga_8h.html#a4c6b763b5e19e0320c1f6fdb38295de2">MAX_PLUGIN_OUTPUT_LENGTH</a>);
<a name="l02898"></a>02898         <a class="code" href="macros_8c.html#a447a756f699af137cdd85eb4caa4d0e5">clear_volatile_macros_r</a>(&amp;mac);
<a name="l02899"></a>02899 
<a name="l02900"></a>02900         <span class="comment">/* if the check timed out, report an error */</span>
<a name="l02901"></a>02901         <span class="keywordflow">if</span>(early_timeout==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l02902"></a>02902 
<a name="l02903"></a>02903                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_plugin_output);
<a name="l02904"></a>02904                 <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=<a class="code" href="snprintf_8c.html#a28a648dd20504ebc0c03623a28d82c93">asprintf</a>(&amp;temp_plugin_output,<span class="stringliteral">&quot;Host check timed out after %d seconds\n&quot;</span>,<a class="code" href="checks_8c.html#a57a8709265e39d9953db6dd65bfc0796">host_check_timeout</a>);
<a name="l02905"></a>02905 
<a name="l02906"></a>02906                 <span class="comment">/* log the timeout */</span>
<a name="l02907"></a>02907                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: Host check command &#39;%s&#39; for host &#39;%s&#39; timed out after %d seconds\n&quot;</span>,processed_command,hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>,<a class="code" href="checks_8c.html#a57a8709265e39d9953db6dd65bfc0796">host_check_timeout</a>);
<a name="l02908"></a>02908         }
<a name="l02909"></a>02909 
<a name="l02910"></a>02910         <span class="comment">/* calculate total execution time */</span>
<a name="l02911"></a>02911         hst-&gt;execution_time=exectime;
<a name="l02912"></a>02912 
<a name="l02913"></a>02913         <span class="comment">/* record check type */</span>
<a name="l02914"></a>02914         hst-&gt;check_type=<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a>;
<a name="l02915"></a>02915 
<a name="l02916"></a>02916         <span class="comment">/* parse the output: short and long output, and perf data */</span>
<a name="l02917"></a>02917         <a class="code" href="base_2utils_8c.html#a3899c46155b515e207829a7bf127700c">parse_check_output</a>(temp_plugin_output,&amp;hst-&gt;plugin_output,&amp;hst-&gt;long_plugin_output,&amp;hst-&gt;perf_data,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02918"></a>02918 
<a name="l02919"></a>02919         <span class="comment">/* free memory */</span>
<a name="l02920"></a>02920         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_plugin_output);
<a name="l02921"></a>02921         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(raw_command);
<a name="l02922"></a>02922         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(processed_command);
<a name="l02923"></a>02923 
<a name="l02924"></a>02924         <span class="comment">/* a NULL host check command means we should assume the host is UP */</span>
<a name="l02925"></a>02925         <span class="keywordflow">if</span>(hst-&gt;<a class="code" href="structhost__struct.html#add4274af8704b502b95ce8ad2ec0ddff">host_check_command</a>==NULL){
<a name="l02926"></a>02926                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(hst-&gt;plugin_output);
<a name="l02927"></a>02927                 hst-&gt;plugin_output=(<span class="keywordtype">char</span> *)strdup(<span class="stringliteral">&quot;(Host assumed to be UP)&quot;</span>);
<a name="l02928"></a>02928                 result=<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>;
<a name="l02929"></a>02929         }
<a name="l02930"></a>02930 
<a name="l02931"></a>02931         <span class="comment">/* make sure we have some data */</span>
<a name="l02932"></a>02932         <span class="keywordflow">if</span>(hst-&gt;plugin_output==NULL || !strcmp(hst-&gt;plugin_output,<span class="stringliteral">&quot;&quot;</span>)){
<a name="l02933"></a>02933                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(hst-&gt;plugin_output);
<a name="l02934"></a>02934                 hst-&gt;plugin_output=(<span class="keywordtype">char</span> *)strdup(<span class="stringliteral">&quot;(No output returned from host check)&quot;</span>);
<a name="l02935"></a>02935         }
<a name="l02936"></a>02936 
<a name="l02937"></a>02937         <span class="comment">/* replace semicolons in plugin output (but not performance data) with colons */</span>
<a name="l02938"></a>02938         <span class="keywordflow">if</span>((temp_ptr=hst-&gt;plugin_output)){
<a name="l02939"></a>02939                 <span class="keywordflow">while</span>((temp_ptr=strchr(temp_ptr,<span class="charliteral">&#39;;&#39;</span>)))
<a name="l02940"></a>02940                         *temp_ptr=<span class="charliteral">&#39;:&#39;</span>;
<a name="l02941"></a>02941         }
<a name="l02942"></a>02942 
<a name="l02943"></a>02943         <span class="comment">/* if we&#39;re not doing aggressive host checking, let WARNING states indicate the host is up (fake the result to be STATE_OK) */</span>
<a name="l02944"></a>02944         <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a8f8fcb1a4bb32b1c5fa753ac9cb48578">use_aggressive_host_checking</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> &amp;&amp; result==<a class="code" href="cgiutils_8h.html#a4b06ae38f5452bbb219bb49f0081c3f0">STATE_WARNING</a>)
<a name="l02945"></a>02945                 result=<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>;
<a name="l02946"></a>02946 
<a name="l02947"></a>02947 
<a name="l02948"></a>02948         <span class="keywordflow">if</span>(result==<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>)
<a name="l02949"></a>02949                 return_result=<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>;
<a name="l02950"></a>02950         <span class="keywordflow">else</span>
<a name="l02951"></a>02951                 return_result=<a class="code" href="icinga_8h.html#a19d20cca11e4cf399742ad25c05d73fb">HOST_DOWN</a>;
<a name="l02952"></a>02952 
<a name="l02953"></a>02953         <span class="comment">/* high resolution end time for event broker */</span>
<a name="l02954"></a>02954         gettimeofday(&amp;end_time,NULL);
<a name="l02955"></a>02955 
<a name="l02956"></a>02956 <span class="preprocessor">#ifdef USE_EVENT_BROKER</span>
<a name="l02957"></a>02957 <span class="preprocessor"></span>        <span class="comment">/* send data to event broker */</span>
<a name="l02958"></a>02958         <a class="code" href="broker_8h.html#a7a70fd5a4b2d6afbcaa8bbb5436a065a">broker_host_check</a>(<a class="code" href="broker_8h.html#a541290dce53f965c73910c9560da71e0">NEBTYPE_HOSTCHECK_RAW_END</a>,<a class="code" href="broker_8h.html#ae7b50b735fa9d5baf42ab19525993635">NEBFLAG_NONE</a>,<a class="code" href="broker_8h.html#a2e1afa1e543c76a752561dbc9eb38d65">NEBATTR_NONE</a>,hst,<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a>,return_result,hst-&gt;state_type,start_time,end_time,hst-&gt;<a class="code" href="structhost__struct.html#add4274af8704b502b95ce8ad2ec0ddff">host_check_command</a>,0.0,exectime,<a class="code" href="checks_8c.html#a57a8709265e39d9953db6dd65bfc0796">host_check_timeout</a>,early_timeout,result,processed_command,hst-&gt;plugin_output,hst-&gt;long_plugin_output,hst-&gt;perf_data,NULL);
<a name="l02959"></a>02959 <span class="preprocessor">#endif</span>
<a name="l02960"></a>02960 <span class="preprocessor"></span>
<a name="l02961"></a>02961         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;** Sync host check done: state=%d\n&quot;</span>,return_result);
<a name="l02962"></a>02962 
<a name="l02963"></a>02963         <span class="keywordflow">return</span> return_result;
<a name="l02964"></a>02964 }
<a name="l02965"></a>02965 
<a name="l02966"></a>02966 
<a name="l02967"></a>02967 
<a name="l02968"></a>02968 <span class="comment">/* run a scheduled host check asynchronously */</span>
<a name="l02969"></a><a class="code" href="icinga_8h.html#abc4a59428a3517a67b69a4d63ad022e8">02969</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#a595a22d1d374a4859a68b5cc4d448b3a">run_scheduled_host_check_3x</a>(<a class="code" href="structhost__struct.html">host</a> *hst, <span class="keywordtype">int</span> check_options, <span class="keywordtype">double</span> latency){
<a name="l02970"></a>02970         <span class="keywordtype">int</span> result=<a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l02971"></a>02971         time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>=0L;
<a name="l02972"></a>02972         time_t preferred_time=0L;
<a name="l02973"></a>02973         time_t next_valid_time=0L;
<a name="l02974"></a>02974         <span class="keywordtype">int</span> time_is_valid=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02975"></a>02975 
<a name="l02976"></a>02976 
<a name="l02977"></a>02977         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;run_scheduled_host_check_3x()\n&quot;</span>);
<a name="l02978"></a>02978 
<a name="l02979"></a>02979         <span class="keywordflow">if</span>(hst==NULL)
<a name="l02980"></a>02980                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l02981"></a>02981 
<a name="l02982"></a>02982         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Attempting to run scheduled check of host &#39;%s&#39;: check options=%d, latency=%lf\n&quot;</span>,hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>,check_options,latency);
<a name="l02983"></a>02983 
<a name="l02984"></a>02984         <span class="comment">/* attempt to run the check */</span>
<a name="l02985"></a>02985         result=<a class="code" href="checks_8c.html#ae41ccfe2cbc8c303d642f3315a0ad4d7">run_async_host_check_3x</a>(hst,check_options,latency,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,&amp;time_is_valid,&amp;preferred_time);
<a name="l02986"></a>02986 
<a name="l02987"></a>02987         <span class="comment">/* an error occurred, so reschedule the check */</span>
<a name="l02988"></a>02988         <span class="keywordflow">if</span>(result==<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>){
<a name="l02989"></a>02989 
<a name="l02990"></a>02990                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Unable to run scheduled host check at this time\n&quot;</span>);
<a name="l02991"></a>02991 
<a name="l02992"></a>02992                 <span class="comment">/* only attempt to (re)schedule checks that should get checked... */</span>
<a name="l02993"></a>02993                 <span class="keywordflow">if</span>(hst-&gt;should_be_scheduled==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l02994"></a>02994 
<a name="l02995"></a>02995                         <span class="comment">/* get current time */</span>
<a name="l02996"></a>02996                         time(&amp;current_time);
<a name="l02997"></a>02997 
<a name="l02998"></a>02998                         <span class="comment">/* determine next time we should check the host if needed */</span>
<a name="l02999"></a>02999                         <span class="comment">/* if host has no check interval, schedule it again for 5 minutes from now */</span>
<a name="l03000"></a>03000                         <span class="keywordflow">if</span>(current_time&gt;=preferred_time)
<a name="l03001"></a>03001                                 preferred_time=current_time+((hst-&gt;<a class="code" href="structhost__struct.html#a75fa71ddb31a4fbfd6ce60ebd69d6064">check_interval</a>&lt;=0)?300:(hst-&gt;<a class="code" href="structhost__struct.html#a75fa71ddb31a4fbfd6ce60ebd69d6064">check_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>));
<a name="l03002"></a>03002 
<a name="l03003"></a>03003                         <span class="comment">/* make sure we rescheduled the next host check at a valid time */</span>
<a name="l03004"></a>03004                         <a class="code" href="base_2utils_8c.html#a887cf03e0c7cfc020e10e9f1949aae2e">get_next_valid_time</a>(preferred_time,&amp;next_valid_time,hst-&gt;check_period_ptr);
<a name="l03005"></a>03005 
<a name="l03006"></a>03006                         <span class="comment">/* the host could not be rescheduled properly - set the next check time for next week */</span>
<a name="l03007"></a>03007                         <span class="keywordflow">if</span>(time_is_valid==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> &amp;&amp; next_valid_time==preferred_time){
<a name="l03008"></a>03008 
<a name="l03009"></a>03009                                 <span class="comment">/*</span>
<a name="l03010"></a>03010 <span class="comment">                                hst-&gt;next_check=(time_t)(next_valid_time+(60*60*24*365));</span>
<a name="l03011"></a>03011 <span class="comment">                                hst-&gt;should_be_scheduled=FALSE;</span>
<a name="l03012"></a>03012 <span class="comment">                                 */</span>
<a name="l03013"></a>03013 
<a name="l03014"></a>03014                                 hst-&gt;next_check=(time_t)(next_valid_time+(60*60*24*7));
<a name="l03015"></a>03015 
<a name="l03016"></a>03016                                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: Check of host &#39;%s&#39; could not be rescheduled properly.  Scheduling check for next week...\n&quot;</span>,hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l03017"></a>03017 
<a name="l03018"></a>03018                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Unable to find any valid times to reschedule the next host check!\n&quot;</span>);
<a name="l03019"></a>03019                         }
<a name="l03020"></a>03020 
<a name="l03021"></a>03021                         <span class="comment">/* this service could be rescheduled... */</span>
<a name="l03022"></a>03022                         <span class="keywordflow">else</span>{
<a name="l03023"></a>03023                                 hst-&gt;next_check=next_valid_time;
<a name="l03024"></a>03024                                 hst-&gt;should_be_scheduled=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03025"></a>03025 
<a name="l03026"></a>03026                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Rescheduled next host check for %s&quot;</span>,ctime(&amp;next_valid_time));
<a name="l03027"></a>03027                         }
<a name="l03028"></a>03028                 }
<a name="l03029"></a>03029 
<a name="l03030"></a>03030                 <span class="comment">/* update the status log */</span>
<a name="l03031"></a>03031                 update_host_status(hst,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l03032"></a>03032 
<a name="l03033"></a>03033                 <span class="comment">/* reschedule the next host check - unless we couldn&#39;t find a valid next check time */</span>
<a name="l03034"></a>03034                 <span class="comment">/* 10/19/07 EG - keep original check options */</span>
<a name="l03035"></a>03035                 <span class="keywordflow">if</span>(hst-&gt;should_be_scheduled==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l03036"></a>03036                         <a class="code" href="checks_8c.html#aacf489b05d155c06c18a596107484b79">schedule_host_check</a>(hst,hst-&gt;next_check,check_options);
<a name="l03037"></a>03037 
<a name="l03038"></a>03038                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03039"></a>03039         }
<a name="l03040"></a>03040 
<a name="l03041"></a>03041         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03042"></a>03042 }
<a name="l03043"></a>03043 
<a name="l03044"></a>03044 
<a name="l03045"></a>03045 
<a name="l03046"></a>03046 <span class="comment">/* perform an asynchronous check of a host */</span>
<a name="l03047"></a>03047 <span class="comment">/* scheduled host checks will use this, as will some checks that result from on-demand checks... */</span>
<a name="l03048"></a><a class="code" href="icinga_8h.html#acc2778d3a64e6c38de237e4ef673648a">03048</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#ae41ccfe2cbc8c303d642f3315a0ad4d7">run_async_host_check_3x</a>(<a class="code" href="structhost__struct.html">host</a> *hst, <span class="keywordtype">int</span> check_options, <span class="keywordtype">double</span> latency, <span class="keywordtype">int</span> scheduled_check, <span class="keywordtype">int</span> reschedule_check, <span class="keywordtype">int</span> *time_is_valid, time_t *preferred_time){
<a name="l03049"></a>03049         <a class="code" href="structicinga__macros.html">icinga_macros</a> mac;
<a name="l03050"></a>03050         <span class="keywordtype">char</span> *raw_command=NULL;
<a name="l03051"></a>03051         <span class="keywordtype">char</span> *processed_command=NULL;
<a name="l03052"></a>03052         <span class="keyword">struct </span>timeval start_time,end_time;
<a name="l03053"></a>03053         pid_t pid=0;
<a name="l03054"></a>03054         <span class="keywordtype">int</span> fork_error=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03055"></a>03055         <span class="keywordtype">int</span> wait_result=0;
<a name="l03056"></a>03056         <span class="keywordtype">int</span> pclose_result=0;
<a name="l03057"></a>03057         mode_t new_umask=077;
<a name="l03058"></a>03058         mode_t old_umask;
<a name="l03059"></a>03059         <span class="keywordtype">char</span> *output_file=NULL;
<a name="l03060"></a>03060         <span class="keywordtype">double</span> old_latency=0.0;
<a name="l03061"></a>03061         <a class="code" href="structdbuf__struct.html">dbuf</a> checkresult_dbuf;
<a name="l03062"></a>03062         <span class="keywordtype">int</span> dbuf_chunk=1024;
<a name="l03063"></a>03063 <span class="preprocessor">#ifdef USE_EVENT_BROKER</span>
<a name="l03064"></a>03064 <span class="preprocessor"></span>        <span class="keywordtype">int</span> neb_result=<a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03065"></a>03065 <span class="preprocessor">#endif</span>
<a name="l03066"></a>03066 <span class="preprocessor"></span>
<a name="l03067"></a>03067         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;run_async_host_check_3x()\n&quot;</span>);
<a name="l03068"></a>03068 
<a name="l03069"></a>03069         <span class="comment">/* make sure we have a host */</span>
<a name="l03070"></a>03070         <span class="keywordflow">if</span>(hst==NULL)
<a name="l03071"></a>03071                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03072"></a>03072 
<a name="l03073"></a>03073         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;** Running async check of host &#39;%s&#39;...\n&quot;</span>,hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l03074"></a>03074 
<a name="l03075"></a>03075         <span class="comment">/* is the host check viable at this time? */</span>
<a name="l03076"></a>03076         <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#aaffacd6bdfb12ea872c68d820700213f">check_host_check_viability_3x</a>(hst,check_options,time_is_valid,preferred_time)==<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>)
<a name="l03077"></a>03077                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03078"></a>03078 
<a name="l03079"></a>03079         <span class="comment">/* 08/04/07 EG don&#39;t execute a new host check if one is already running */</span>
<a name="l03080"></a>03080         <span class="keywordflow">if</span>(hst-&gt;is_executing==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; !(check_options &amp; <a class="code" href="include_2common_8h.html#a7c2da00f285e024a7f2f81d633684b0f">CHECK_OPTION_FORCE_EXECUTION</a>)){
<a name="l03081"></a>03081                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;A check of this host is already being executed, so we&#39;ll pass for the moment...\n&quot;</span>);
<a name="l03082"></a>03082                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03083"></a>03083         }
<a name="l03084"></a>03084 
<a name="l03085"></a>03085         <span class="comment">/******** GOOD TO GO FOR A REAL HOST CHECK AT THIS POINT ********/</span>
<a name="l03086"></a>03086 
<a name="l03087"></a>03087 <span class="preprocessor">#ifdef USE_EVENT_BROKER</span>
<a name="l03088"></a>03088 <span class="preprocessor"></span>        <span class="comment">/* initialize start/end times */</span>
<a name="l03089"></a>03089         start_time.tv_sec=0L;
<a name="l03090"></a>03090         start_time.tv_usec=0L;
<a name="l03091"></a>03091         end_time.tv_sec=0L;
<a name="l03092"></a>03092         end_time.tv_usec=0L;
<a name="l03093"></a>03093 
<a name="l03094"></a>03094         <span class="comment">/* send data to event broker */</span>
<a name="l03095"></a>03095         neb_result=<a class="code" href="broker_8h.html#a7a70fd5a4b2d6afbcaa8bbb5436a065a">broker_host_check</a>(<a class="code" href="broker_8h.html#a82fa57399161d1126393ab8b7618b98e">NEBTYPE_HOSTCHECK_ASYNC_PRECHECK</a>,<a class="code" href="broker_8h.html#ae7b50b735fa9d5baf42ab19525993635">NEBFLAG_NONE</a>,<a class="code" href="broker_8h.html#a2e1afa1e543c76a752561dbc9eb38d65">NEBATTR_NONE</a>,hst,<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a>,hst-&gt;current_state,hst-&gt;state_type,start_time,end_time,hst-&gt;<a class="code" href="structhost__struct.html#add4274af8704b502b95ce8ad2ec0ddff">host_check_command</a>,hst-&gt;latency,0.0,<a class="code" href="checks_8c.html#a57a8709265e39d9953db6dd65bfc0796">host_check_timeout</a>,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,0,NULL,NULL,NULL,NULL,NULL);
<a name="l03096"></a>03096 
<a name="l03097"></a>03097         <span class="comment">/* neb module wants to cancel the host check - the check will be rescheduled for a later time by the scheduling logic */</span>
<a name="l03098"></a>03098         <span class="keywordflow">if</span>(neb_result==<a class="code" href="neberrors_8h.html#a600d6e38d658749244cc38a42344a389">NEBERROR_CALLBACKCANCEL</a>)
<a name="l03099"></a>03099                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03100"></a>03100 
<a name="l03101"></a>03101         <span class="comment">/* neb module wants to override the host check - perhaps it will check the host itself */</span>
<a name="l03102"></a>03102         <span class="comment">/* NOTE: if a module does this, it has to do a lot of the stuff found below to make sure things don&#39;t get whacked out of shape! */</span>
<a name="l03103"></a>03103         <span class="keywordflow">if</span>(neb_result==<a class="code" href="neberrors_8h.html#a239dad95dfec616d6591de5368fb78f4">NEBERROR_CALLBACKOVERRIDE</a>)
<a name="l03104"></a>03104                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03105"></a>03105 <span class="preprocessor">#endif</span>
<a name="l03106"></a>03106 <span class="preprocessor"></span>
<a name="l03107"></a>03107         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Checking host &#39;%s&#39;...\n&quot;</span>,hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l03108"></a>03108 
<a name="l03109"></a>03109         <span class="comment">/* clear check options - we don&#39;t want old check options retained */</span>
<a name="l03110"></a>03110         <span class="comment">/* only clear options if this was a scheduled check - on demand check options shouldn&#39;t affect retained info */</span>
<a name="l03111"></a>03111         <span class="keywordflow">if</span>(scheduled_check==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l03112"></a>03112                 hst-&gt;check_options=<a class="code" href="include_2common_8h.html#ac2e0ba323965f243a1988566a8ea53da">CHECK_OPTION_NONE</a>;
<a name="l03113"></a>03113 
<a name="l03114"></a>03114         <span class="comment">/* adjust host check attempt */</span>
<a name="l03115"></a>03115         <a class="code" href="checks_8c.html#ab34b1556234001a05a9765f063eaf0e6">adjust_host_check_attempt_3x</a>(hst,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l03116"></a>03116 
<a name="l03117"></a>03117         <span class="comment">/* set latency (temporarily) for macros and event broker */</span>
<a name="l03118"></a>03118         old_latency=hst-&gt;latency;
<a name="l03119"></a>03119         hst-&gt;latency=latency;
<a name="l03120"></a>03120 
<a name="l03121"></a>03121         <span class="comment">/* grab the host macro variables */</span>
<a name="l03122"></a>03122         memset(&amp;mac, 0, <span class="keyword">sizeof</span>(mac));
<a name="l03123"></a>03123         <a class="code" href="macros_8c.html#a61cae7ada74ecff37182103a3ddc76b9">grab_host_macros_r</a>(&amp;mac, hst);
<a name="l03124"></a>03124 
<a name="l03125"></a>03125         <span class="comment">/* get the raw command line */</span>
<a name="l03126"></a>03126         <a class="code" href="base_2utils_8c.html#a786c23913ee9613d6e4782aa5e33a8e6">get_raw_command_line_r</a>(&amp;mac, hst-&gt;check_command_ptr,hst-&gt;<a class="code" href="structhost__struct.html#add4274af8704b502b95ce8ad2ec0ddff">host_check_command</a>,&amp;raw_command,0);
<a name="l03127"></a>03127         <span class="keywordflow">if</span>(raw_command==NULL){
<a name="l03128"></a>03128                 <a class="code" href="macros_8c.html#a447a756f699af137cdd85eb4caa4d0e5">clear_volatile_macros_r</a>(&amp;mac);
<a name="l03129"></a>03129                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Raw check command for host &#39;%s&#39; was NULL - aborting.\n&quot;</span>,hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l03130"></a>03130                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03131"></a>03131         }
<a name="l03132"></a>03132 
<a name="l03133"></a>03133         <span class="comment">/* process any macros contained in the argument */</span>
<a name="l03134"></a>03134         <a class="code" href="macros_8c.html#a1be6f89f750b75aeab483d93badda0e4">process_macros_r</a>(&amp;mac, raw_command,&amp;processed_command,0);
<a name="l03135"></a>03135         <span class="keywordflow">if</span>(processed_command==NULL){
<a name="l03136"></a>03136                 <a class="code" href="macros_8c.html#a447a756f699af137cdd85eb4caa4d0e5">clear_volatile_macros_r</a>(&amp;mac);
<a name="l03137"></a>03137                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Processed check command for host &#39;%s&#39; was NULL - aborting.\n&quot;</span>,hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l03138"></a>03138                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03139"></a>03139         }
<a name="l03140"></a>03140 
<a name="l03141"></a>03141         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(hst-&gt;<a class="code" href="structhost__struct.html#ab9860d6289fafe65e7244cff5def26fd">processed_command</a>);
<a name="l03142"></a>03142         hst-&gt;<a class="code" href="structhost__struct.html#ab9860d6289fafe65e7244cff5def26fd">processed_command</a>=strdup(processed_command);
<a name="l03143"></a>03143 
<a name="l03144"></a>03144         <span class="comment">/* get the command start time */</span>
<a name="l03145"></a>03145         gettimeofday(&amp;start_time,NULL);
<a name="l03146"></a>03146 
<a name="l03147"></a>03147         <span class="comment">/* set check time for on-demand checks, so they&#39;re not incorrectly detected as being orphaned - Luke Ross 5/16/08 */</span>
<a name="l03148"></a>03148         <span class="comment">/* NOTE: 06/23/08 EG not sure if there will be side effects to this or not.... */</span>
<a name="l03149"></a>03149         <span class="keywordflow">if</span>(scheduled_check==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l03150"></a>03150                 hst-&gt;next_check=start_time.tv_sec;
<a name="l03151"></a>03151 
<a name="l03152"></a>03152         <span class="comment">/* increment number of host checks that are currently running... */</span>
<a name="l03153"></a>03153         <a class="code" href="checks_8c.html#a546436c5e70468c98d7b4a7f335a170b">currently_running_host_checks</a>++;
<a name="l03154"></a>03154 
<a name="l03155"></a>03155         <span class="comment">/* set the execution flag */</span>
<a name="l03156"></a>03156         hst-&gt;is_executing=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03157"></a>03157 
<a name="l03158"></a>03158         <span class="comment">/* open a temp file for storing check output */</span>
<a name="l03159"></a>03159         old_umask=umask(new_umask);
<a name="l03160"></a>03160         <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=<a class="code" href="snprintf_8c.html#a28a648dd20504ebc0c03623a28d82c93">asprintf</a>(&amp;output_file,<span class="stringliteral">&quot;%s/checkXXXXXX&quot;</span>,<a class="code" href="checks_8c.html#ac633a7a52422f2b1d56ed02a56dc8fcf">temp_path</a>);
<a name="l03161"></a>03161         check_result_info.<a class="code" href="structcheck__result__struct.html#aec5b08d38761af6fe89eef17bd831f53">output_file_fd</a>=mkstemp(output_file);
<a name="l03162"></a>03162         <span class="keywordflow">if</span>(check_result_info.<a class="code" href="structcheck__result__struct.html#aec5b08d38761af6fe89eef17bd831f53">output_file_fd</a>&gt;=0)
<a name="l03163"></a>03163                 check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>=fdopen(check_result_info.<a class="code" href="structcheck__result__struct.html#aec5b08d38761af6fe89eef17bd831f53">output_file_fd</a>,<span class="stringliteral">&quot;w&quot;</span>);
<a name="l03164"></a>03164         <span class="keywordflow">else</span>{
<a name="l03165"></a>03165                 check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>=NULL;
<a name="l03166"></a>03166                 check_result_info.<a class="code" href="structcheck__result__struct.html#aec5b08d38761af6fe89eef17bd831f53">output_file_fd</a>=-1;
<a name="l03167"></a>03167         }
<a name="l03168"></a>03168         umask(old_umask);
<a name="l03169"></a>03169 
<a name="l03170"></a>03170         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>|<a class="code" href="logging_8h.html#addc28db449ac01a4e1e04a0646ae70bd">DEBUGL_IPC</a>,1,<span class="stringliteral">&quot;Check result output will be written to &#39;%s&#39; (fd=%d)\n&quot;</span>,output_file,check_result_info.<a class="code" href="structcheck__result__struct.html#aec5b08d38761af6fe89eef17bd831f53">output_file_fd</a>);
<a name="l03171"></a>03171 
<a name="l03172"></a>03172         <span class="comment">/* save check info */</span>
<a name="l03173"></a>03173         check_result_info.<a class="code" href="structcheck__result__struct.html#aab46f07f58a12b95f55f483637e2f937">object_check_type</a>=<a class="code" href="icinga_8h.html#af3d22c9e46ee1d7539669117eee89882">HOST_CHECK</a>;
<a name="l03174"></a>03174         check_result_info.<a class="code" href="structcheck__result__struct.html#a8e0609d9dd4bf77156c9e967ab8c8924">host_name</a>=(<span class="keywordtype">char</span> *)strdup(hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l03175"></a>03175         check_result_info.<a class="code" href="structcheck__result__struct.html#a3cd7e3c42f1bce1761e6c84b76588877">service_description</a>=NULL;
<a name="l03176"></a>03176         check_result_info.<a class="code" href="structcheck__result__struct.html#a06a6efffb27b304e4b983b5cfab66851">check_type</a>=<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a>;
<a name="l03177"></a>03177         check_result_info.<a class="code" href="structcheck__result__struct.html#ae0708b0eaec7709912168f85c5ba503a">check_options</a>=check_options;
<a name="l03178"></a>03178         check_result_info.<a class="code" href="structcheck__result__struct.html#ac3d4cf6179d9c2b29f98be9f2ca2941a">scheduled_check</a>=scheduled_check;
<a name="l03179"></a>03179         check_result_info.<a class="code" href="structcheck__result__struct.html#a55af6097dbb3c68a52f1bfa4027f37f5">reschedule_check</a>=reschedule_check;
<a name="l03180"></a>03180         check_result_info.<a class="code" href="structcheck__result__struct.html#a1ef7b671552d6ed92421a522c4127bf6">output_file</a>=(check_result_info.<a class="code" href="structcheck__result__struct.html#aec5b08d38761af6fe89eef17bd831f53">output_file_fd</a>&lt;0 || output_file==NULL)?NULL:strdup(output_file);
<a name="l03181"></a>03181         check_result_info.<a class="code" href="structcheck__result__struct.html#a2e6d8e1efd138ab3970cb6f0233f7eb4">latency</a>=latency;
<a name="l03182"></a>03182         check_result_info.<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>=<a class="code" href="cmd_8c.html#ad20e89e0c86aa812dc3a8e2fb7b5777b">start_time</a>;
<a name="l03183"></a>03183         check_result_info.<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>=<a class="code" href="cmd_8c.html#ad20e89e0c86aa812dc3a8e2fb7b5777b">start_time</a>;
<a name="l03184"></a>03184         check_result_info.<a class="code" href="structcheck__result__struct.html#a8fd6dc8e62fa817f85971b929d2a50ea">early_timeout</a>=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03185"></a>03185         check_result_info.<a class="code" href="structcheck__result__struct.html#acdf1b91b61c379a2e1c42421ac1f76b8">exited_ok</a>=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03186"></a>03186         check_result_info.<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>=<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>;
<a name="l03187"></a>03187         check_result_info.<a class="code" href="structcheck__result__struct.html#aabb1b6da0b348c809c7139c5e32938e0">output</a>=NULL;
<a name="l03188"></a>03188 
<a name="l03189"></a>03189         <span class="comment">/* free memory */</span>
<a name="l03190"></a>03190         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(output_file);
<a name="l03191"></a>03191 
<a name="l03192"></a>03192         <span class="comment">/* write initial check info to file */</span>
<a name="l03193"></a>03193         <span class="comment">/* if things go bad later on, the user will at least have something to go on when debugging... */</span>
<a name="l03194"></a>03194         <span class="keywordflow">if</span>(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>){
<a name="l03195"></a>03195 
<a name="l03196"></a>03196                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;### Active Check Result File ###\n&quot;</span>);
<a name="l03197"></a>03197                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;file_time=%lu\n&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)check_result_info.<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>.tv_sec);
<a name="l03198"></a>03198                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l03199"></a>03199 
<a name="l03200"></a>03200                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;### Icinga Host Check Result ###\n&quot;</span>);
<a name="l03201"></a>03201                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;# Time: %s&quot;</span>,ctime(&amp;check_result_info.<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>.tv_sec));
<a name="l03202"></a>03202                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;host_name=%s\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#a8e0609d9dd4bf77156c9e967ab8c8924">host_name</a>);
<a name="l03203"></a>03203                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;check_type=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#a06a6efffb27b304e4b983b5cfab66851">check_type</a>);
<a name="l03204"></a>03204                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;check_options=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#ae0708b0eaec7709912168f85c5ba503a">check_options</a>);
<a name="l03205"></a>03205                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;scheduled_check=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#ac3d4cf6179d9c2b29f98be9f2ca2941a">scheduled_check</a>);
<a name="l03206"></a>03206                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;reschedule_check=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#a55af6097dbb3c68a52f1bfa4027f37f5">reschedule_check</a>);
<a name="l03207"></a>03207                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;latency=%f\n&quot;</span>,hst-&gt;latency);
<a name="l03208"></a>03208                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;start_time=%lu.%lu\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>.tv_sec,check_result_info.<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>.tv_usec);
<a name="l03209"></a>03209 
<a name="l03210"></a>03210                 <span class="comment">/* flush buffer or we&#39;ll end up writing twice when we fork() */</span>
<a name="l03211"></a>03211                 fflush(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>);
<a name="l03212"></a>03212         }
<a name="l03213"></a>03213 
<a name="l03214"></a>03214         <span class="comment">/* initialize dynamic buffer for storing plugin output */</span>
<a name="l03215"></a>03215         <a class="code" href="base_2utils_8c.html#aa18c99ae8f740d8ab59ef720dbbde1ad">dbuf_init</a>(&amp;checkresult_dbuf,dbuf_chunk);
<a name="l03216"></a>03216 
<a name="l03217"></a>03217 <span class="preprocessor">#ifdef USE_EVENT_BROKER</span>
<a name="l03218"></a>03218 <span class="preprocessor"></span>        <span class="comment">/* send data to event broker */</span>
<a name="l03219"></a>03219         <a class="code" href="broker_8h.html#a7a70fd5a4b2d6afbcaa8bbb5436a065a">broker_host_check</a>(<a class="code" href="broker_8h.html#af4b599c04cd6f532a329317ecf941e97">NEBTYPE_HOSTCHECK_INITIATE</a>,<a class="code" href="broker_8h.html#ae7b50b735fa9d5baf42ab19525993635">NEBFLAG_NONE</a>,<a class="code" href="broker_8h.html#a2e1afa1e543c76a752561dbc9eb38d65">NEBATTR_NONE</a>,hst,<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a>,hst-&gt;current_state,hst-&gt;state_type,start_time,end_time,hst-&gt;<a class="code" href="structhost__struct.html#add4274af8704b502b95ce8ad2ec0ddff">host_check_command</a>,hst-&gt;latency,0.0,<a class="code" href="checks_8c.html#a57a8709265e39d9953db6dd65bfc0796">host_check_timeout</a>,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,0,processed_command,NULL,NULL,NULL,NULL);
<a name="l03220"></a>03220 <span class="preprocessor">#endif</span>
<a name="l03221"></a>03221 <span class="preprocessor"></span>
<a name="l03222"></a>03222         <span class="comment">/* reset latency (permanent value for this check will get set later) */</span>
<a name="l03223"></a>03223         hst-&gt;latency=old_latency;
<a name="l03224"></a>03224 
<a name="l03225"></a>03225         <span class="comment">/* update check statistics */</span>
<a name="l03226"></a>03226         <a class="code" href="base_2utils_8c.html#ac3e9d864e9a2d00cbd2b8f3cf22ea2c1">update_check_stats</a>((scheduled_check==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)?<a class="code" href="include_2common_8h.html#aa3c98ccfa7a0e1be503776d03aa08fe1">ACTIVE_SCHEDULED_HOST_CHECK_STATS</a>:<a class="code" href="include_2common_8h.html#a294c695b3b8a7790a88cd83cdc507543">ACTIVE_ONDEMAND_HOST_CHECK_STATS</a>,start_time.tv_sec);
<a name="l03227"></a>03227         <a class="code" href="base_2utils_8c.html#ac3e9d864e9a2d00cbd2b8f3cf22ea2c1">update_check_stats</a>(<a class="code" href="include_2common_8h.html#ad963b5b081fa02f6c845b94d87f916f9">PARALLEL_HOST_CHECK_STATS</a>,start_time.tv_sec);
<a name="l03228"></a>03228 
<a name="l03229"></a>03229         <span class="comment">/* fork a child process */</span>
<a name="l03230"></a>03230         pid=fork();
<a name="l03231"></a>03231 
<a name="l03232"></a>03232         <span class="comment">/* an error occurred while trying to fork */</span>
<a name="l03233"></a>03233         <span class="keywordflow">if</span>(pid==-1){
<a name="l03234"></a>03234 
<a name="l03235"></a>03235                 fork_error=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03236"></a>03236 
<a name="l03237"></a>03237                 <span class="comment">/* log an error */</span>
<a name="l03238"></a>03238                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: The check of host &#39;%s&#39; could not be performed due to a fork() error: &#39;%s&#39;.\n&quot;</span>,hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>,strerror(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03239"></a>03239 
<a name="l03240"></a>03240                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Check of host &#39;%s&#39; could not be performed due to a fork() error: &#39;%s&#39;!\n&quot;</span>,hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>,strerror(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03241"></a>03241         }
<a name="l03242"></a>03242 
<a name="l03243"></a>03243         <span class="comment">/* if we are in the child process... */</span>
<a name="l03244"></a>03244         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pid==0){
<a name="l03245"></a>03245 
<a name="l03246"></a>03246                 <span class="comment">/* set environment variables */</span>
<a name="l03247"></a>03247                 set_all_macro_environment_vars_r(&amp;mac, <a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l03248"></a>03248 
<a name="l03249"></a>03249                 <span class="comment">/* ADDED 11/12/07 EG */</span>
<a name="l03250"></a>03250                 <span class="comment">/* close external command file and shut down worker thread */</span>
<a name="l03251"></a>03251                 <a class="code" href="base_2utils_8c.html#a5e15280db8f3a81c3d955260965899a0">close_command_file</a>();
<a name="l03252"></a>03252 
<a name="l03253"></a>03253                 <span class="comment">/* fork again if we&#39;re not in a large installation */</span>
<a name="l03254"></a>03254                 <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a2976ddc6ad4325c074912d0f61bb0184">child_processes_fork_twice</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l03255"></a>03255 
<a name="l03256"></a>03256                         <span class="comment">/* fork again... */</span>
<a name="l03257"></a>03257                         pid=fork();
<a name="l03258"></a>03258 
<a name="l03259"></a>03259                         <span class="comment">/* an error occurred while trying to fork again */</span>
<a name="l03260"></a>03260                         <span class="keywordflow">if</span>(pid==-1)
<a name="l03261"></a>03261                                 exit(<a class="code" href="cgiutils_8h.html#a3a671c5b5d9122f1158555575bc0feb1">STATE_UNKNOWN</a>);
<a name="l03262"></a>03262                 }
<a name="l03263"></a>03263 
<a name="l03264"></a>03264                 <span class="comment">/* the grandchild (or child if large install tweaks are enabled) process should run the host check... */</span>
<a name="l03265"></a>03265                 <span class="keywordflow">if</span>(pid==0 || <a class="code" href="checks_8c.html#a2976ddc6ad4325c074912d0f61bb0184">child_processes_fork_twice</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l03266"></a>03266 
<a name="l03267"></a>03267                         <span class="comment">/* reset signal handling */</span>
<a name="l03268"></a>03268                         <a class="code" href="base_2utils_8c.html#a1686ce1c6b73859e70249769c544999a">reset_sighandler</a>();
<a name="l03269"></a>03269 
<a name="l03270"></a>03270                         <span class="comment">/* become the process group leader */</span>
<a name="l03271"></a>03271                         setpgid(0,0);
<a name="l03272"></a>03272 
<a name="l03273"></a>03273                         <span class="comment">/* catch term signals at this process level */</span>
<a name="l03274"></a>03274                         signal(SIGTERM,<a class="code" href="base_2utils_8c.html#a28a203010e63d8b8d56381211cdf8bc4">host_check_sighandler</a>);
<a name="l03275"></a>03275 
<a name="l03276"></a>03276                         <span class="comment">/* catch plugins that don&#39;t finish in a timely manner */</span>
<a name="l03277"></a>03277                         signal(SIGALRM,<a class="code" href="base_2utils_8c.html#a28a203010e63d8b8d56381211cdf8bc4">host_check_sighandler</a>);
<a name="l03278"></a>03278                         alarm(<a class="code" href="checks_8c.html#a57a8709265e39d9953db6dd65bfc0796">host_check_timeout</a>);
<a name="l03279"></a>03279 
<a name="l03280"></a>03280                         <span class="comment">/* disable rotation of the debug file */</span>
<a name="l03281"></a>03281                         <a class="code" href="checks_8c.html#ac919486c0bf77cab5e1ec2f0aba1803f">max_debug_file_size</a>=0L;
<a name="l03282"></a>03282 
<a name="l03283"></a>03283                         <span class="comment">/* run the plugin check command */</span>
<a name="l03284"></a>03284                         pclose_result=run_check(processed_command,&amp;checkresult_dbuf);
<a name="l03285"></a>03285 
<a name="l03286"></a>03286                         <span class="comment">/* reset the alarm */</span>
<a name="l03287"></a>03287                         alarm(0);
<a name="l03288"></a>03288 
<a name="l03289"></a>03289                         <span class="comment">/* get the check finish time */</span>
<a name="l03290"></a>03290                         gettimeofday(&amp;end_time,NULL);
<a name="l03291"></a>03291 
<a name="l03292"></a>03292                         <span class="comment">/* record check result info */</span>
<a name="l03293"></a>03293                         check_result_info.<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>=<a class="code" href="cmd_8c.html#a1e324d62e65642694c00de363bf8a8ba">end_time</a>;
<a name="l03294"></a>03294                         check_result_info.<a class="code" href="structcheck__result__struct.html#a8fd6dc8e62fa817f85971b929d2a50ea">early_timeout</a>=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03295"></a>03295 
<a name="l03296"></a>03296                         <span class="comment">/* test for execution error */</span>
<a name="l03297"></a>03297                         <span class="keywordflow">if</span>(pclose_result==-1){
<a name="l03298"></a>03298                                 pclose_result=<a class="code" href="cgiutils_8h.html#a3a671c5b5d9122f1158555575bc0feb1">STATE_UNKNOWN</a>;
<a name="l03299"></a>03299                                 check_result_info.<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>=<a class="code" href="cgiutils_8h.html#a19827c887254e66b983c3269a42562bc">STATE_CRITICAL</a>;
<a name="l03300"></a>03300                                 check_result_info.<a class="code" href="structcheck__result__struct.html#acdf1b91b61c379a2e1c42421ac1f76b8">exited_ok</a>=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03301"></a>03301                         }
<a name="l03302"></a>03302                         <span class="keywordflow">else</span>{
<a name="l03303"></a>03303                                 <span class="keywordflow">if</span>(<a class="code" href="config_8h.html#a7a9fed9392a51acd68e5f469e63f7961">WEXITSTATUS</a>(pclose_result)==0 &amp;&amp; WIFSIGNALED(pclose_result))
<a name="l03304"></a>03304                                         check_result_info.<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>=128+WTERMSIG(pclose_result);
<a name="l03305"></a>03305                                 <span class="keywordflow">else</span>
<a name="l03306"></a>03306                                         check_result_info.<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>=<a class="code" href="config_8h.html#a7a9fed9392a51acd68e5f469e63f7961">WEXITSTATUS</a>(pclose_result);
<a name="l03307"></a>03307                         }
<a name="l03308"></a>03308 
<a name="l03309"></a>03309                         <span class="comment">/* write check result to file */</span>
<a name="l03310"></a>03310                         <span class="keywordflow">if</span>(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>){
<a name="l03311"></a>03311 
<a name="l03312"></a>03312                                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;finish_time=%lu.%lu\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_sec,check_result_info.<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_usec);
<a name="l03313"></a>03313                                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;early_timeout=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#a8fd6dc8e62fa817f85971b929d2a50ea">early_timeout</a>);
<a name="l03314"></a>03314                                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;exited_ok=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#acdf1b91b61c379a2e1c42421ac1f76b8">exited_ok</a>);
<a name="l03315"></a>03315                                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;return_code=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>);
<a name="l03316"></a>03316                                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;output=%s\n&quot;</span>,(checkresult_dbuf.<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>==NULL)?<span class="stringliteral">&quot;(null)&quot;</span>:checkresult_dbuf.<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>);
<a name="l03317"></a>03317 
<a name="l03318"></a>03318                                 <span class="comment">/* close the temp file */</span>
<a name="l03319"></a>03319                                 fclose(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>);
<a name="l03320"></a>03320 
<a name="l03321"></a>03321                                 <span class="comment">/* move check result to queue directory */</span>
<a name="l03322"></a>03322                                 <a class="code" href="base_2utils_8c.html#a69855a30b12dfe19f6663bc9165bb1cf">move_check_result_to_queue</a>(check_result_info.<a class="code" href="structcheck__result__struct.html#a1ef7b671552d6ed92421a522c4127bf6">output_file</a>);
<a name="l03323"></a>03323                         }
<a name="l03324"></a>03324 
<a name="l03325"></a>03325                         <span class="comment">/* free memory */</span>
<a name="l03326"></a>03326                         <a class="code" href="base_2utils_8c.html#ad793f77d0d1041d670ff9bee3a5cda5d">dbuf_free</a>(&amp;checkresult_dbuf);
<a name="l03327"></a>03327                         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(raw_command);
<a name="l03328"></a>03328                         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(processed_command);
<a name="l03329"></a>03329 
<a name="l03330"></a>03330                         <span class="comment">/* free check result memory */</span>
<a name="l03331"></a>03331                         <a class="code" href="base_2utils_8c.html#a36701093a323ae768707b7a025a13e01">free_check_result</a>(&amp;check_result_info);
<a name="l03332"></a>03332 
<a name="l03333"></a>03333                         <span class="comment">/* return with plugin exit status - not really necessary... */</span>
<a name="l03334"></a>03334                         _exit(pclose_result);
<a name="l03335"></a>03335                 }
<a name="l03336"></a>03336 
<a name="l03337"></a>03337                 <span class="comment">/* NOTE: this code is never reached if large install tweaks are enabled... */</span>
<a name="l03338"></a>03338 
<a name="l03339"></a>03339                 <span class="comment">/* unset environment variables */</span>
<a name="l03340"></a>03340                 set_all_macro_environment_vars_r(&amp;mac, <a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l03341"></a>03341 
<a name="l03342"></a>03342                 <span class="comment">/* free allocated memory */</span>
<a name="l03343"></a>03343                 <span class="comment">/* this needs to be done last, so we don&#39;t free memory for variables before they&#39;re used above */</span>
<a name="l03344"></a>03344                 <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a73881c51ba02b6ea241ab71a8e2c354c">free_child_process_memory</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l03345"></a>03345                         <a class="code" href="base_2utils_8c.html#ae49e5228711e021ca4ea8da8e4d2f447">free_memory</a>(&amp;mac);
<a name="l03346"></a>03346 
<a name="l03347"></a>03347                 <span class="comment">/* parent exits immediately - grandchild process is inherited by the INIT process, so we have no zombie problem... */</span>
<a name="l03348"></a>03348                 _exit(<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>);
<a name="l03349"></a>03349         }
<a name="l03350"></a>03350 
<a name="l03351"></a>03351         <span class="comment">/* else the parent should wait for the first child to return... */</span>
<a name="l03352"></a>03352         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pid&gt;0){
<a name="l03353"></a>03353                 <a class="code" href="macros_8c.html#a447a756f699af137cdd85eb4caa4d0e5">clear_volatile_macros_r</a>(&amp;mac);
<a name="l03354"></a>03354 
<a name="l03355"></a>03355                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Host check is executing in child process (pid=%lu)\n&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)pid);
<a name="l03356"></a>03356 
<a name="l03357"></a>03357                 <span class="comment">/* parent should close output file */</span>
<a name="l03358"></a>03358                 <span class="keywordflow">if</span>(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>)
<a name="l03359"></a>03359                         fclose(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>);
<a name="l03360"></a>03360 
<a name="l03361"></a>03361                 <span class="comment">/* should this be done in first child process (after spawning grandchild) as well? */</span>
<a name="l03362"></a>03362                 <span class="comment">/* free memory allocated for IPC functionality */</span>
<a name="l03363"></a>03363                 <a class="code" href="base_2utils_8c.html#a36701093a323ae768707b7a025a13e01">free_check_result</a>(&amp;check_result_info);
<a name="l03364"></a>03364 
<a name="l03365"></a>03365                 <span class="comment">/* free memory */</span>
<a name="l03366"></a>03366                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(raw_command);
<a name="l03367"></a>03367                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(processed_command);
<a name="l03368"></a>03368 
<a name="l03369"></a>03369                 <span class="comment">/* wait for the first child to return */</span>
<a name="l03370"></a>03370                 <span class="comment">/* if large install tweaks are enabled, we&#39;ll clean up the zombie process later */</span>
<a name="l03371"></a>03371                 <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a2976ddc6ad4325c074912d0f61bb0184">child_processes_fork_twice</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l03372"></a>03372                         wait_result=waitpid(pid,NULL,0);
<a name="l03373"></a>03373         }
<a name="l03374"></a>03374 
<a name="l03375"></a>03375         <span class="comment">/* see if we were able to run the check... */</span>
<a name="l03376"></a>03376         <span class="keywordflow">if</span>(fork_error==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l03377"></a>03377                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03378"></a>03378 
<a name="l03379"></a>03379         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03380"></a>03380 }
<a name="l03381"></a>03381 
<a name="l03382"></a>03382 
<a name="l03383"></a>03383 
<a name="l03384"></a>03384 <span class="comment">/* process results of an asynchronous host check */</span>
<a name="l03385"></a><a class="code" href="icinga_8h.html#a85e1840af68a552f4d7e311273c7edca">03385</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#a113eb9743ca3e9d18fc6dae81dd85de8">handle_async_host_check_result_3x</a>(<a class="code" href="structhost__struct.html">host</a> *temp_host, <a class="code" href="structcheck__result__struct.html">check_result</a> *queued_check_result){
<a name="l03386"></a>03386         time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>;
<a name="l03387"></a>03387         <span class="keywordtype">int</span> result=<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>;
<a name="l03388"></a>03388         <span class="keywordtype">int</span> reschedule_check=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03389"></a>03389         <span class="keywordtype">char</span> *old_plugin_output=NULL;
<a name="l03390"></a>03390         <span class="keywordtype">char</span> *temp_ptr=NULL;
<a name="l03391"></a>03391         <span class="keyword">struct </span>timeval start_time_hires;
<a name="l03392"></a>03392         <span class="keyword">struct </span>timeval end_time_hires;
<a name="l03393"></a>03393 
<a name="l03394"></a>03394         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;handle_async_host_check_result_3x()\n&quot;</span>);
<a name="l03395"></a>03395 
<a name="l03396"></a>03396         <span class="comment">/* make sure we have what we need */</span>
<a name="l03397"></a>03397         <span class="keywordflow">if</span>(temp_host==NULL || queued_check_result==NULL)
<a name="l03398"></a>03398                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03399"></a>03399 
<a name="l03400"></a>03400         time(&amp;current_time);
<a name="l03401"></a>03401 
<a name="l03402"></a>03402         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;** Handling async check result for host &#39;%s&#39;...\n&quot;</span>,temp_host-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l03403"></a>03403 
<a name="l03404"></a>03404         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;\tCheck Type:         %s\n&quot;</span>,(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a06a6efffb27b304e4b983b5cfab66851">check_type</a>==<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a>)?<span class="stringliteral">&quot;Active&quot;</span>:<span class="stringliteral">&quot;Passive&quot;</span>);
<a name="l03405"></a>03405         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;\tCheck Options:      %d\n&quot;</span>,queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#ae0708b0eaec7709912168f85c5ba503a">check_options</a>);
<a name="l03406"></a>03406         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;\tScheduled Check?:   %s\n&quot;</span>,(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#ac3d4cf6179d9c2b29f98be9f2ca2941a">scheduled_check</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)?<span class="stringliteral">&quot;Yes&quot;</span>:<span class="stringliteral">&quot;No&quot;</span>);
<a name="l03407"></a>03407         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;\tReschedule Check?:  %s\n&quot;</span>,(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a55af6097dbb3c68a52f1bfa4027f37f5">reschedule_check</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)?<span class="stringliteral">&quot;Yes&quot;</span>:<span class="stringliteral">&quot;No&quot;</span>);
<a name="l03408"></a>03408         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;\tExited OK?:         %s\n&quot;</span>,(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#acdf1b91b61c379a2e1c42421ac1f76b8">exited_ok</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)?<span class="stringliteral">&quot;Yes&quot;</span>:<span class="stringliteral">&quot;No&quot;</span>);
<a name="l03409"></a>03409         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;\tExec Time:          %.3f\n&quot;</span>,temp_host-&gt;execution_time);
<a name="l03410"></a>03410         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;\tLatency:            %.3f\n&quot;</span>,temp_host-&gt;latency);
<a name="l03411"></a>03411         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;\tReturn Status:      %d\n&quot;</span>,queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>);
<a name="l03412"></a>03412         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;\tOutput:             %s\n&quot;</span>,(queued_check_result==NULL)?<span class="stringliteral">&quot;NULL&quot;</span>:queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#aabb1b6da0b348c809c7139c5e32938e0">output</a>);
<a name="l03413"></a>03413 
<a name="l03414"></a>03414         <span class="comment">/* decrement the number of host checks still out there... */</span>
<a name="l03415"></a>03415         <span class="keywordflow">if</span>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a06a6efffb27b304e4b983b5cfab66851">check_type</a>==<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a> &amp;&amp; <a class="code" href="checks_8c.html#a546436c5e70468c98d7b4a7f335a170b">currently_running_host_checks</a>&gt;0)
<a name="l03416"></a>03416                 <a class="code" href="checks_8c.html#a546436c5e70468c98d7b4a7f335a170b">currently_running_host_checks</a>--;
<a name="l03417"></a>03417 
<a name="l03418"></a>03418         <span class="comment">/* skip this host check results if its passive and we aren&#39;t accepting passive check results */</span>
<a name="l03419"></a>03419         <span class="keywordflow">if</span>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a06a6efffb27b304e4b983b5cfab66851">check_type</a>==<a class="code" href="include_2common_8h.html#a27483f73cf77ca968054fe1da6df90f2">HOST_CHECK_PASSIVE</a>){
<a name="l03420"></a>03420                 <span class="keywordflow">if</span>(<a class="code" href="broker_8c.html#a1f08a9399cbf8d1781f7921cb39ad461">accept_passive_host_checks</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l03421"></a>03421                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Discarding passive host check result because passive host checks are disabled globally.\n&quot;</span>);
<a name="l03422"></a>03422                         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03423"></a>03423                 }
<a name="l03424"></a>03424                 <span class="keywordflow">if</span>(temp_host-&gt;<a class="code" href="structhost__struct.html#a02adcb873992725eadf6e3b7946ec475">accept_passive_host_checks</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l03425"></a>03425                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Discarding passive host check result because passive checks are disabled for this host.\n&quot;</span>);
<a name="l03426"></a>03426                         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03427"></a>03427                 }
<a name="l03428"></a>03428         }
<a name="l03429"></a>03429 
<a name="l03430"></a>03430         <span class="comment">/* clear the freshening flag (it would have been set if this host was determined to be stale) */</span>
<a name="l03431"></a>03431         <span class="keywordflow">if</span>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#ae0708b0eaec7709912168f85c5ba503a">check_options</a> &amp; <a class="code" href="include_2common_8h.html#a8c0fa51fb6ee777f4e21f2210f948e2a">CHECK_OPTION_FRESHNESS_CHECK</a>)
<a name="l03432"></a>03432                 temp_host-&gt;is_being_freshened=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03433"></a>03433 
<a name="l03434"></a>03434         <span class="comment">/* DISCARD INVALID FRESHNESS CHECK RESULTS */</span>
<a name="l03435"></a>03435         <span class="comment">/* If a host goes stale, Icinga will initiate a forced check in order to freshen it.  There is a race condition whereby a passive check</span>
<a name="l03436"></a>03436 <span class="comment">           could arrive between the 1) initiation of the forced check and 2) the time when the forced check result is processed here.  This would</span>
<a name="l03437"></a>03437 <span class="comment">           make the host fresh again, so we do a quick check to make sure the host is still stale before we accept the check result. */</span>
<a name="l03438"></a>03438         <span class="keywordflow">if</span>((queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#ae0708b0eaec7709912168f85c5ba503a">check_options</a> &amp; <a class="code" href="include_2common_8h.html#a8c0fa51fb6ee777f4e21f2210f948e2a">CHECK_OPTION_FRESHNESS_CHECK</a>) &amp;&amp; <a class="code" href="checks_8c.html#a7a39bf6ff568d09ecdff304a45587027">is_host_result_fresh</a>(temp_host,current_time,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l03439"></a>03439                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,0,<span class="stringliteral">&quot;Discarding host freshness check result because the host is currently fresh (race condition avoided).\n&quot;</span>);
<a name="l03440"></a>03440                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03441"></a>03441         }
<a name="l03442"></a>03442 
<a name="l03443"></a>03443         <span class="comment">/* was this check passive or active? */</span>
<a name="l03444"></a>03444         temp_host-&gt;check_type=(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a06a6efffb27b304e4b983b5cfab66851">check_type</a>==<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a>)?<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a>:<a class="code" href="include_2common_8h.html#a27483f73cf77ca968054fe1da6df90f2">HOST_CHECK_PASSIVE</a>;
<a name="l03445"></a>03445 
<a name="l03446"></a>03446         <span class="comment">/* update check statistics for passive results */</span>
<a name="l03447"></a>03447         <span class="keywordflow">if</span>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a06a6efffb27b304e4b983b5cfab66851">check_type</a>==<a class="code" href="include_2common_8h.html#a27483f73cf77ca968054fe1da6df90f2">HOST_CHECK_PASSIVE</a>)
<a name="l03448"></a>03448                 <a class="code" href="base_2utils_8c.html#ac3e9d864e9a2d00cbd2b8f3cf22ea2c1">update_check_stats</a>(<a class="code" href="include_2common_8h.html#a3a5bbab2e0ba7d46674ab4a4f01a83a2">PASSIVE_HOST_CHECK_STATS</a>,queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>.tv_sec);
<a name="l03449"></a>03449 
<a name="l03450"></a>03450         <span class="comment">/* should we reschedule the next check of the host? NOTE: this might be overridden later... */</span>
<a name="l03451"></a>03451         reschedule_check=queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a55af6097dbb3c68a52f1bfa4027f37f5">reschedule_check</a>;
<a name="l03452"></a>03452 
<a name="l03453"></a>03453         <span class="comment">/* check latency is passed to us for both active and passive checks */</span>
<a name="l03454"></a>03454         temp_host-&gt;latency=queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a2e6d8e1efd138ab3970cb6f0233f7eb4">latency</a>;
<a name="l03455"></a>03455 
<a name="l03456"></a>03456         <span class="comment">/* update the execution time for this check (millisecond resolution) */</span>
<a name="l03457"></a>03457         temp_host-&gt;execution_time=(double)((<span class="keywordtype">double</span>)(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_sec-queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>.tv_sec)+(<span class="keywordtype">double</span>)((queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_usec-queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>.tv_usec)/1000.0)/1000.0);
<a name="l03458"></a>03458         <span class="keywordflow">if</span>(temp_host-&gt;execution_time&lt;0.0)
<a name="l03459"></a>03459                 temp_host-&gt;execution_time=0.0;
<a name="l03460"></a>03460 
<a name="l03461"></a>03461         <span class="comment">/* set the checked flag */</span>
<a name="l03462"></a>03462         temp_host-&gt;has_been_checked=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03463"></a>03463 
<a name="l03464"></a>03464         <span class="comment">/* clear the execution flag if this was an active check */</span>
<a name="l03465"></a>03465         <span class="keywordflow">if</span>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a06a6efffb27b304e4b983b5cfab66851">check_type</a>==<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a>)
<a name="l03466"></a>03466                 temp_host-&gt;is_executing=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03467"></a>03467 
<a name="l03468"></a>03468         <span class="comment">/* get the last check time */</span>
<a name="l03469"></a>03469         temp_host-&gt;last_check=queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>.tv_sec;
<a name="l03470"></a>03470 
<a name="l03471"></a>03471         <span class="comment">/* was this check passive or active? */</span>
<a name="l03472"></a>03472         temp_host-&gt;check_type=(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a06a6efffb27b304e4b983b5cfab66851">check_type</a>==<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a>)?<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a>:<a class="code" href="include_2common_8h.html#a27483f73cf77ca968054fe1da6df90f2">HOST_CHECK_PASSIVE</a>;
<a name="l03473"></a>03473 
<a name="l03474"></a>03474         <span class="comment">/* save the old host state */</span>
<a name="l03475"></a>03475         temp_host-&gt;last_state=temp_host-&gt;current_state;
<a name="l03476"></a>03476         <span class="keywordflow">if</span>(temp_host-&gt;state_type==<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a>)
<a name="l03477"></a>03477                 temp_host-&gt;last_hard_state=temp_host-&gt;current_state;
<a name="l03478"></a>03478 
<a name="l03479"></a>03479         <span class="comment">/* save old plugin output */</span>
<a name="l03480"></a>03480         <span class="keywordflow">if</span>(temp_host-&gt;plugin_output)
<a name="l03481"></a>03481                 old_plugin_output=(<span class="keywordtype">char</span> *)strdup(temp_host-&gt;plugin_output);
<a name="l03482"></a>03482 
<a name="l03483"></a>03483         <span class="comment">/* clear the old plugin output and perf data buffers */</span>
<a name="l03484"></a>03484         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_host-&gt;plugin_output);
<a name="l03485"></a>03485         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_host-&gt;long_plugin_output);
<a name="l03486"></a>03486         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_host-&gt;perf_data);
<a name="l03487"></a>03487 
<a name="l03488"></a>03488         <span class="comment">/* parse check output to get: (1) short output, (2) long output, (3) perf data */</span>
<a name="l03489"></a>03489         <a class="code" href="base_2utils_8c.html#a3899c46155b515e207829a7bf127700c">parse_check_output</a>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#aabb1b6da0b348c809c7139c5e32938e0">output</a>,&amp;temp_host-&gt;plugin_output,&amp;temp_host-&gt;long_plugin_output,&amp;temp_host-&gt;perf_data,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l03490"></a>03490 
<a name="l03491"></a>03491         <span class="comment">/* make sure we have some data */</span>
<a name="l03492"></a>03492         <span class="keywordflow">if</span>(temp_host-&gt;plugin_output==NULL || !strcmp(temp_host-&gt;plugin_output,<span class="stringliteral">&quot;&quot;</span>)){
<a name="l03493"></a>03493                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_host-&gt;plugin_output);
<a name="l03494"></a>03494                 temp_host-&gt;plugin_output=(<span class="keywordtype">char</span> *)strdup(<span class="stringliteral">&quot;(No output returned from host check)&quot;</span>);
<a name="l03495"></a>03495         }
<a name="l03496"></a>03496 
<a name="l03497"></a>03497         <span class="comment">/* replace semicolons in plugin output (but not performance data) with colons */</span>
<a name="l03498"></a>03498         <span class="keywordflow">if</span>((temp_ptr=temp_host-&gt;plugin_output)){
<a name="l03499"></a>03499                 <span class="keywordflow">while</span>((temp_ptr=strchr(temp_ptr,<span class="charliteral">&#39;;&#39;</span>)))
<a name="l03500"></a>03500                         *temp_ptr=<span class="charliteral">&#39;:&#39;</span>;
<a name="l03501"></a>03501         }
<a name="l03502"></a>03502 
<a name="l03503"></a>03503         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Parsing check output...\n&quot;</span>);
<a name="l03504"></a>03504         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Short Output: %s\n&quot;</span>,(temp_host-&gt;plugin_output==NULL)?<span class="stringliteral">&quot;NULL&quot;</span>:temp_host-&gt;plugin_output);
<a name="l03505"></a>03505         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Long Output:  %s\n&quot;</span>,(temp_host-&gt;long_plugin_output==NULL)?<span class="stringliteral">&quot;NULL&quot;</span>:temp_host-&gt;long_plugin_output);
<a name="l03506"></a>03506         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Perf Data:    %s\n&quot;</span>,(temp_host-&gt;perf_data==NULL)?<span class="stringliteral">&quot;NULL&quot;</span>:temp_host-&gt;perf_data);
<a name="l03507"></a>03507 
<a name="l03508"></a>03508         <span class="comment">/* get the unprocessed return code */</span>
<a name="l03509"></a>03509         <span class="comment">/* NOTE: for passive checks, this is the final/processed state */</span>
<a name="l03510"></a>03510         result=queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>;
<a name="l03511"></a>03511 
<a name="l03512"></a>03512         <span class="comment">/* adjust return code (active checks only) */</span>
<a name="l03513"></a>03513         <span class="keywordflow">if</span>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a06a6efffb27b304e4b983b5cfab66851">check_type</a>==<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a>){
<a name="l03514"></a>03514 
<a name="l03515"></a>03515                 <span class="comment">/* if there was some error running the command, just skip it (this shouldn&#39;t be happening) */</span>
<a name="l03516"></a>03516                 <span class="keywordflow">if</span>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#acdf1b91b61c379a2e1c42421ac1f76b8">exited_ok</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l03517"></a>03517 
<a name="l03518"></a>03518                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning:  Check of host &#39;%s&#39; did not exit properly!\n&quot;</span>,temp_host-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l03519"></a>03519 
<a name="l03520"></a>03520                         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_host-&gt;plugin_output);
<a name="l03521"></a>03521                         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_host-&gt;long_plugin_output);
<a name="l03522"></a>03522                         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_host-&gt;perf_data);
<a name="l03523"></a>03523 
<a name="l03524"></a>03524                         temp_host-&gt;plugin_output=(<span class="keywordtype">char</span> *)strdup(<span class="stringliteral">&quot;(Host check did not exit properly)&quot;</span>);
<a name="l03525"></a>03525 
<a name="l03526"></a>03526                         result=<a class="code" href="cgiutils_8h.html#a19827c887254e66b983c3269a42562bc">STATE_CRITICAL</a>;
<a name="l03527"></a>03527                 }
<a name="l03528"></a>03528 
<a name="l03529"></a>03529                 <span class="comment">/* make sure the return code is within bounds */</span>
<a name="l03530"></a>03530                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>&lt;0 || queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>&gt;3){
<a name="l03531"></a>03531 
<a name="l03532"></a>03532                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: Return code of %d for check of host &#39;%s&#39; was out of bounds.%s\n&quot;</span>,queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>,temp_host-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>,(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>==126 || queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>==127)?<span class="stringliteral">&quot; Make sure the plugin you&#39;re trying to run actually exists.&quot;</span>:<span class="stringliteral">&quot;&quot;</span>);
<a name="l03533"></a>03533 
<a name="l03534"></a>03534                         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_host-&gt;plugin_output);
<a name="l03535"></a>03535                         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_host-&gt;long_plugin_output);
<a name="l03536"></a>03536                         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_host-&gt;perf_data);
<a name="l03537"></a>03537 
<a name="l03538"></a>03538                         <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=<a class="code" href="snprintf_8c.html#a28a648dd20504ebc0c03623a28d82c93">asprintf</a>(&amp;temp_host-&gt;plugin_output,<span class="stringliteral">&quot;(Return code of %d is out of bounds%s)&quot;</span>,queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>,(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>==126 || queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>==127)?<span class="stringliteral">&quot; - plugin may be missing&quot;</span>:<span class="stringliteral">&quot;&quot;</span>);
<a name="l03539"></a>03539 
<a name="l03540"></a>03540                         result=<a class="code" href="cgiutils_8h.html#a19827c887254e66b983c3269a42562bc">STATE_CRITICAL</a>;
<a name="l03541"></a>03541                 }
<a name="l03542"></a>03542 
<a name="l03543"></a>03543                 <span class="comment">/* a NULL host check command means we should assume the host is UP */</span>
<a name="l03544"></a>03544                 <span class="keywordflow">if</span>(temp_host-&gt;<a class="code" href="structhost__struct.html#add4274af8704b502b95ce8ad2ec0ddff">host_check_command</a>==NULL){
<a name="l03545"></a>03545                         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_host-&gt;plugin_output);
<a name="l03546"></a>03546                         temp_host-&gt;plugin_output=(<span class="keywordtype">char</span> *)strdup(<span class="stringliteral">&quot;(Host assumed to be UP)&quot;</span>);
<a name="l03547"></a>03547                         result=<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>;
<a name="l03548"></a>03548                 }
<a name="l03549"></a>03549         }
<a name="l03550"></a>03550 
<a name="l03551"></a>03551         <span class="comment">/* translate return code to basic UP/DOWN state - the DOWN/UNREACHABLE state determination is made later */</span>
<a name="l03552"></a>03552         <span class="comment">/* NOTE: only do this for active checks - passive check results already have the final state */</span>
<a name="l03553"></a>03553         <span class="keywordflow">if</span>(queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a06a6efffb27b304e4b983b5cfab66851">check_type</a>==<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a>){
<a name="l03554"></a>03554 
<a name="l03555"></a>03555                 <span class="comment">/* if we&#39;re not doing aggressive host checking, let WARNING states indicate the host is up (fake the result to be STATE_OK) */</span>
<a name="l03556"></a>03556                 <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a8f8fcb1a4bb32b1c5fa753ac9cb48578">use_aggressive_host_checking</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> &amp;&amp; result==<a class="code" href="cgiutils_8h.html#a4b06ae38f5452bbb219bb49f0081c3f0">STATE_WARNING</a>)
<a name="l03557"></a>03557                         result=<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>;
<a name="l03558"></a>03558 
<a name="l03559"></a>03559                 <span class="comment">/* OK states means the host is UP */</span>
<a name="l03560"></a>03560                 <span class="keywordflow">if</span>(result==<a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>)
<a name="l03561"></a>03561                         result=<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>;
<a name="l03562"></a>03562 
<a name="l03563"></a>03563                 <span class="comment">/* any problem state indicates the host is not UP */</span>
<a name="l03564"></a>03564                 <span class="keywordflow">else</span>
<a name="l03565"></a>03565                         result=<a class="code" href="icinga_8h.html#a19d20cca11e4cf399742ad25c05d73fb">HOST_DOWN</a>;
<a name="l03566"></a>03566         }
<a name="l03567"></a>03567 
<a name="l03568"></a>03568 
<a name="l03569"></a>03569         <span class="comment">/******************* PROCESS THE CHECK RESULTS ******************/</span>
<a name="l03570"></a>03570 
<a name="l03571"></a>03571         <span class="comment">/* process the host check result */</span>
<a name="l03572"></a>03572         <a class="code" href="checks_8c.html#a74139a3bafaf6ecc8d445e81bc84d392">process_host_check_result_3x</a>(temp_host,result,old_plugin_output,<a class="code" href="include_2common_8h.html#ac2e0ba323965f243a1988566a8ea53da">CHECK_OPTION_NONE</a>,reschedule_check,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<a class="code" href="checks_8c.html#a55fd26f1da3fea26b41e92a035472ea2">cached_host_check_horizon</a>);
<a name="l03573"></a>03573 
<a name="l03574"></a>03574         <span class="comment">/* free memory */</span>
<a name="l03575"></a>03575         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(old_plugin_output);
<a name="l03576"></a>03576 
<a name="l03577"></a>03577         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;** Async check result for host &#39;%s&#39; handled: new state=%d\n&quot;</span>,temp_host-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>,temp_host-&gt;current_state);
<a name="l03578"></a>03578 
<a name="l03579"></a>03579         <span class="comment">/* high resolution start time for event broker */</span>
<a name="l03580"></a>03580         start_time_hires=queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>;
<a name="l03581"></a>03581 
<a name="l03582"></a>03582         <span class="comment">/* high resolution end time for event broker */</span>
<a name="l03583"></a>03583         gettimeofday(&amp;end_time_hires,NULL);
<a name="l03584"></a>03584 
<a name="l03585"></a>03585 <span class="preprocessor">#ifdef USE_EVENT_BROKER</span>
<a name="l03586"></a>03586 <span class="preprocessor"></span>        <span class="comment">/* send data to event broker */</span>
<a name="l03587"></a>03587         <a class="code" href="broker_8h.html#a7a70fd5a4b2d6afbcaa8bbb5436a065a">broker_host_check</a>(<a class="code" href="broker_8h.html#a1d83d192c64f341aca35a6cd145c71be">NEBTYPE_HOSTCHECK_PROCESSED</a>,<a class="code" href="broker_8h.html#ae7b50b735fa9d5baf42ab19525993635">NEBFLAG_NONE</a>,<a class="code" href="broker_8h.html#a2e1afa1e543c76a752561dbc9eb38d65">NEBATTR_NONE</a>,temp_host,temp_host-&gt;check_type,temp_host-&gt;current_state,temp_host-&gt;state_type,start_time_hires,end_time_hires,temp_host-&gt;<a class="code" href="structhost__struct.html#add4274af8704b502b95ce8ad2ec0ddff">host_check_command</a>,temp_host-&gt;latency,temp_host-&gt;execution_time,<a class="code" href="checks_8c.html#a57a8709265e39d9953db6dd65bfc0796">host_check_timeout</a>,queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a8fd6dc8e62fa817f85971b929d2a50ea">early_timeout</a>,queued_check_result-&gt;<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>,temp_host-&gt;<a class="code" href="structhost__struct.html#ab9860d6289fafe65e7244cff5def26fd">processed_command</a>,temp_host-&gt;plugin_output,temp_host-&gt;long_plugin_output,temp_host-&gt;perf_data,NULL);
<a name="l03588"></a>03588 <span class="preprocessor">#endif</span>
<a name="l03589"></a>03589 <span class="preprocessor"></span>
<a name="l03590"></a>03590         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03591"></a>03591 }
<a name="l03592"></a>03592 
<a name="l03593"></a>03593 
<a name="l03594"></a>03594 
<a name="l03595"></a>03595 <span class="comment">/* processes the result of a synchronous or asynchronous host check */</span>
<a name="l03596"></a><a class="code" href="icinga_8h.html#a38e87dd99da3c63a7f86d5c630f4c4ee">03596</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#a74139a3bafaf6ecc8d445e81bc84d392">process_host_check_result_3x</a>(<a class="code" href="structhost__struct.html">host</a> *hst, <span class="keywordtype">int</span> new_state, <span class="keywordtype">char</span> *old_plugin_output, <span class="keywordtype">int</span> check_options, <span class="keywordtype">int</span> reschedule_check, <span class="keywordtype">int</span> use_cached_result, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> check_timestamp_horizon){
<a name="l03597"></a>03597         <a class="code" href="structhostsmember__struct.html">hostsmember</a> *temp_hostsmember=NULL;
<a name="l03598"></a>03598         <a class="code" href="structhost__struct.html">host</a> *child_host=NULL;
<a name="l03599"></a>03599         <a class="code" href="structhost__struct.html">host</a> *parent_host=NULL;
<a name="l03600"></a>03600         <a class="code" href="structhost__struct.html">host</a> *master_host=NULL;
<a name="l03601"></a>03601         <a class="code" href="structhost__struct.html">host</a> *temp_host=NULL;
<a name="l03602"></a>03602         <a class="code" href="structhostdependency__struct.html">hostdependency</a> *temp_dependency=NULL;
<a name="l03603"></a>03603         <a class="code" href="structobjectlist__struct.html">objectlist</a> *check_hostlist=NULL;
<a name="l03604"></a>03604         <a class="code" href="structobjectlist__struct.html">objectlist</a> *hostlist_item=NULL;
<a name="l03605"></a>03605         <span class="keywordtype">int</span> parent_state=<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>;
<a name="l03606"></a>03606         time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>=0L;
<a name="l03607"></a>03607         time_t next_check=0L;
<a name="l03608"></a>03608         time_t preferred_time=0L;
<a name="l03609"></a>03609         time_t next_valid_time=0L;
<a name="l03610"></a>03610         <span class="keywordtype">int</span> run_async_check=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03611"></a>03611         <span class="keywordtype">void</span> *ptr=NULL;
<a name="l03612"></a>03612 
<a name="l03613"></a>03613 
<a name="l03614"></a>03614         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;process_host_check_result_3x()\n&quot;</span>);
<a name="l03615"></a>03615 
<a name="l03616"></a>03616         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;HOST: %s, ATTEMPT=%d/%d, CHECK TYPE=%s, STATE TYPE=%s, OLD STATE=%d, NEW STATE=%d\n&quot;</span>,hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>,hst-&gt;current_attempt,hst-&gt;<a class="code" href="structhost__struct.html#a091388e27be66d35e87ed643567079c5">max_attempts</a>,(hst-&gt;check_type==<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a>)?<span class="stringliteral">&quot;ACTIVE&quot;</span>:<span class="stringliteral">&quot;PASSIVE&quot;</span>,(hst-&gt;state_type==<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a>)?<span class="stringliteral">&quot;HARD&quot;</span>:<span class="stringliteral">&quot;SOFT&quot;</span>,hst-&gt;current_state,new_state);
<a name="l03617"></a>03617 
<a name="l03618"></a>03618         <span class="comment">/* get the current time */</span>
<a name="l03619"></a>03619         time(&amp;current_time);
<a name="l03620"></a>03620 
<a name="l03621"></a>03621         <span class="comment">/* default next check time */</span>
<a name="l03622"></a>03622         next_check=(<span class="keywordtype">unsigned</span> long)(current_time+(hst-&gt;<a class="code" href="structhost__struct.html#a75fa71ddb31a4fbfd6ce60ebd69d6064">check_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>));
<a name="l03623"></a>03623 
<a name="l03624"></a>03624         <span class="comment">/* we have to adjust current attempt # for passive checks, as it isn&#39;t done elsewhere */</span>
<a name="l03625"></a>03625         <span class="keywordflow">if</span>(hst-&gt;check_type==<a class="code" href="include_2common_8h.html#a27483f73cf77ca968054fe1da6df90f2">HOST_CHECK_PASSIVE</a> &amp;&amp; <a class="code" href="checks_8c.html#a90011bddac350082a4ab3b13758afcbe">passive_host_checks_are_soft</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l03626"></a>03626                 <a class="code" href="checks_8c.html#ab34b1556234001a05a9765f063eaf0e6">adjust_host_check_attempt_3x</a>(hst,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l03627"></a>03627 
<a name="l03628"></a>03628         <span class="comment">/* log passive checks - we need to do this here, as some my bypass external commands by getting dropped in checkresults dir */</span>
<a name="l03629"></a>03629         <span class="keywordflow">if</span>(hst-&gt;check_type==<a class="code" href="include_2common_8h.html#a27483f73cf77ca968054fe1da6df90f2">HOST_CHECK_PASSIVE</a>){
<a name="l03630"></a>03630                 <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a5e7d59bfd5de9be3ca0ab421999029ef">log_passive_checks</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l03631"></a>03631                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#aae0d009469c891e6beb069d38efa7a4f">NSLOG_PASSIVE_CHECK</a>,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,<span class="stringliteral">&quot;PASSIVE HOST CHECK: %s;%d;%s\n&quot;</span>,hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>,new_state,hst-&gt;plugin_output);
<a name="l03632"></a>03632         }
<a name="l03633"></a>03633 
<a name="l03634"></a>03634 
<a name="l03635"></a>03635         <span class="comment">/******* HOST WAS DOWN/UNREACHABLE INITIALLY *******/</span>
<a name="l03636"></a>03636         <span class="keywordflow">if</span>(hst-&gt;current_state!=<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>){
<a name="l03637"></a>03637 
<a name="l03638"></a>03638                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Host was DOWN/UNREACHABLE.\n&quot;</span>);
<a name="l03639"></a>03639 
<a name="l03640"></a>03640                 <span class="comment">/***** HOST IS NOW UP *****/</span>
<a name="l03641"></a>03641                 <span class="comment">/* the host just recovered! */</span>
<a name="l03642"></a>03642                 <span class="keywordflow">if</span>(new_state==<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>){
<a name="l03643"></a>03643 
<a name="l03644"></a>03644                         <span class="comment">/* set the current state */</span>
<a name="l03645"></a>03645                         hst-&gt;current_state=<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>;
<a name="l03646"></a>03646 
<a name="l03647"></a>03647                         <span class="comment">/* set the state type */</span>
<a name="l03648"></a>03648                         <span class="comment">/* set state type to HARD for passive checks and active checks that were previously in a HARD STATE */</span>
<a name="l03649"></a>03649                         <span class="keywordflow">if</span>(hst-&gt;state_type==<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a> || (hst-&gt;check_type==<a class="code" href="include_2common_8h.html#a27483f73cf77ca968054fe1da6df90f2">HOST_CHECK_PASSIVE</a> &amp;&amp; <a class="code" href="checks_8c.html#a90011bddac350082a4ab3b13758afcbe">passive_host_checks_are_soft</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>))
<a name="l03650"></a>03650                                 hst-&gt;state_type=<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a>;
<a name="l03651"></a>03651                         <span class="keywordflow">else</span>
<a name="l03652"></a>03652                                 hst-&gt;state_type=<a class="code" href="include_2common_8h.html#a74a8e12b67587cb027f5f12bb7b0fe8d">SOFT_STATE</a>;
<a name="l03653"></a>03653 
<a name="l03654"></a>03654                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Host experienced a %s recovery (it&#39;s now UP).\n&quot;</span>,(hst-&gt;state_type==<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a>)?<span class="stringliteral">&quot;HARD&quot;</span>:<span class="stringliteral">&quot;SOFT&quot;</span>);
<a name="l03655"></a>03655 
<a name="l03656"></a>03656                         <span class="comment">/* reschedule the next check of the host at the normal interval */</span>
<a name="l03657"></a>03657                         reschedule_check=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03658"></a>03658                         next_check=(<span class="keywordtype">unsigned</span> long)(current_time+(hst-&gt;<a class="code" href="structhost__struct.html#a75fa71ddb31a4fbfd6ce60ebd69d6064">check_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>));
<a name="l03659"></a>03659 
<a name="l03660"></a>03660                         <span class="comment">/* propagate checks to immediate parents if they are not already UP */</span>
<a name="l03661"></a>03661                         <span class="comment">/* we do this because a parent host (or grandparent) may have recovered somewhere and we should catch the recovery as soon as possible */</span>
<a name="l03662"></a>03662                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Propagating checks to parent host(s)...\n&quot;</span>);
<a name="l03663"></a>03663 
<a name="l03664"></a>03664                         <span class="keywordflow">for</span>(temp_hostsmember=hst-&gt;<a class="code" href="structhost__struct.html#aa095184cd77886611768b09f7e4f6822">parent_hosts</a>;temp_hostsmember!=NULL;temp_hostsmember=temp_hostsmember-&gt;<a class="code" href="structhostsmember__struct.html#afdbb9b1473010e32f413d5d8aa57f265">next</a>){
<a name="l03665"></a>03665                                 <span class="keywordflow">if</span>((parent_host=temp_hostsmember-&gt;host_ptr)==NULL)
<a name="l03666"></a>03666                                         <span class="keywordflow">continue</span>;
<a name="l03667"></a>03667                                 <span class="keywordflow">if</span>(parent_host-&gt;current_state!=<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>){
<a name="l03668"></a>03668                                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Check of parent host &#39;%s&#39; queued.\n&quot;</span>,parent_host-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l03669"></a>03669                                         add_object_to_objectlist(&amp;check_hostlist,(<span class="keywordtype">void</span> *)parent_host);
<a name="l03670"></a>03670                                 }
<a name="l03671"></a>03671                         }
<a name="l03672"></a>03672 
<a name="l03673"></a>03673                         <span class="comment">/* propagate checks to immediate children if they are not already UP */</span>
<a name="l03674"></a>03674                         <span class="comment">/* we do this because children may currently be UNREACHABLE, but may (as a result of this recovery) switch to UP or DOWN states */</span>
<a name="l03675"></a>03675                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Propagating checks to child host(s)...\n&quot;</span>);
<a name="l03676"></a>03676 
<a name="l03677"></a>03677                         <span class="keywordflow">for</span>(temp_hostsmember=hst-&gt;<a class="code" href="structhost__struct.html#aa18c4cc7c68f01848dc967ff7779b22d">child_hosts</a>;temp_hostsmember!=NULL;temp_hostsmember=temp_hostsmember-&gt;<a class="code" href="structhostsmember__struct.html#afdbb9b1473010e32f413d5d8aa57f265">next</a>){
<a name="l03678"></a>03678                                 <span class="keywordflow">if</span>((child_host=temp_hostsmember-&gt;host_ptr)==NULL)
<a name="l03679"></a>03679                                         <span class="keywordflow">continue</span>;
<a name="l03680"></a>03680                                 <span class="keywordflow">if</span>(child_host-&gt;current_state!=<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>){
<a name="l03681"></a>03681                                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Check of child host &#39;%s&#39; queued.\n&quot;</span>,child_host-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l03682"></a>03682                                         add_object_to_objectlist(&amp;check_hostlist,(<span class="keywordtype">void</span> *)child_host);
<a name="l03683"></a>03683                                 }
<a name="l03684"></a>03684                         }
<a name="l03685"></a>03685                 }
<a name="l03686"></a>03686 
<a name="l03687"></a>03687                 <span class="comment">/***** HOST IS STILL DOWN/UNREACHABLE *****/</span>
<a name="l03688"></a>03688                 <span class="comment">/* we&#39;re still in a problem state... */</span>
<a name="l03689"></a>03689                 <span class="keywordflow">else</span>{
<a name="l03690"></a>03690 
<a name="l03691"></a>03691                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Host is still DOWN/UNREACHABLE.\n&quot;</span>);
<a name="l03692"></a>03692 
<a name="l03693"></a>03693                         <span class="comment">/* passive checks are treated as HARD states by default... */</span>
<a name="l03694"></a>03694                         <span class="keywordflow">if</span>(hst-&gt;check_type==<a class="code" href="include_2common_8h.html#a27483f73cf77ca968054fe1da6df90f2">HOST_CHECK_PASSIVE</a> &amp;&amp; <a class="code" href="checks_8c.html#a90011bddac350082a4ab3b13758afcbe">passive_host_checks_are_soft</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l03695"></a>03695 
<a name="l03696"></a>03696                                 <span class="comment">/* set the state type */</span>
<a name="l03697"></a>03697                                 hst-&gt;state_type=<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a>;
<a name="l03698"></a>03698 
<a name="l03699"></a>03699                                 <span class="comment">/* reset the current attempt */</span>
<a name="l03700"></a>03700                                 hst-&gt;current_attempt=1;
<a name="l03701"></a>03701                         }
<a name="l03702"></a>03702 
<a name="l03703"></a>03703                         <span class="comment">/* active checks and passive checks (treated as SOFT states) */</span>
<a name="l03704"></a>03704                         <span class="keywordflow">else</span>{
<a name="l03705"></a>03705 
<a name="l03706"></a>03706                                 <span class="comment">/* set the state type */</span>
<a name="l03707"></a>03707                                 <span class="comment">/* we&#39;ve maxed out on the retries */</span>
<a name="l03708"></a>03708                                 <span class="keywordflow">if</span>(hst-&gt;current_attempt==hst-&gt;<a class="code" href="structhost__struct.html#a091388e27be66d35e87ed643567079c5">max_attempts</a>)
<a name="l03709"></a>03709                                         hst-&gt;state_type=<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a>;
<a name="l03710"></a>03710                                 <span class="comment">/* the host was in a hard problem state before, so it still is now */</span>
<a name="l03711"></a>03711                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(hst-&gt;current_attempt==1)
<a name="l03712"></a>03712                                         hst-&gt;state_type=<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a>;
<a name="l03713"></a>03713                                 <span class="comment">/* the host is in a soft state and the check will be retried */</span>
<a name="l03714"></a>03714                                 <span class="keywordflow">else</span>
<a name="l03715"></a>03715                                         hst-&gt;state_type=<a class="code" href="include_2common_8h.html#a74a8e12b67587cb027f5f12bb7b0fe8d">SOFT_STATE</a>;
<a name="l03716"></a>03716                         }
<a name="l03717"></a>03717 
<a name="l03718"></a>03718                         <span class="comment">/* make a determination of the host&#39;s state */</span>
<a name="l03719"></a>03719                         <span class="comment">/* translate host state between DOWN/UNREACHABLE (only for passive checks if enabled) */</span>
<a name="l03720"></a>03720                         hst-&gt;current_state=new_state;
<a name="l03721"></a>03721                         <span class="keywordflow">if</span>(hst-&gt;check_type==<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a> || <a class="code" href="checks_8c.html#aeef0f20f58de2ac8a2db469fdc767b6f">translate_passive_host_checks</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l03722"></a>03722                                 hst-&gt;current_state=<a class="code" href="checks_8c.html#a191896d6b76732d8432d65107faa5954">determine_host_reachability</a>(hst);
<a name="l03723"></a>03723 
<a name="l03724"></a>03724                         <span class="comment">/* reschedule the next check if the host state changed */</span>
<a name="l03725"></a>03725                         <span class="keywordflow">if</span>(hst-&gt;last_state!=hst-&gt;current_state || hst-&gt;last_hard_state!=hst-&gt;current_state){
<a name="l03726"></a>03726 
<a name="l03727"></a>03727                                 reschedule_check=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03728"></a>03728 
<a name="l03729"></a>03729                                 <span class="comment">/* schedule a re-check of the host at the retry interval because we can&#39;t determine its final state yet... */</span>
<a name="l03730"></a>03730                                 <span class="keywordflow">if</span>(hst-&gt;state_type==<a class="code" href="include_2common_8h.html#a74a8e12b67587cb027f5f12bb7b0fe8d">SOFT_STATE</a>)
<a name="l03731"></a>03731                                         next_check=(<span class="keywordtype">unsigned</span> long)(current_time+(hst-&gt;<a class="code" href="structhost__struct.html#a444411c02f976b4141d2cc28e55b5eda">retry_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>));
<a name="l03732"></a>03732 
<a name="l03733"></a>03733                                 <span class="comment">/* host has maxed out on retries (or was previously in a hard problem state), so reschedule the next check at the normal interval */</span>
<a name="l03734"></a>03734                                 <span class="keywordflow">else</span>
<a name="l03735"></a>03735                                         next_check=(<span class="keywordtype">unsigned</span> long)(current_time+(hst-&gt;<a class="code" href="structhost__struct.html#a75fa71ddb31a4fbfd6ce60ebd69d6064">check_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>));
<a name="l03736"></a>03736                         }
<a name="l03737"></a>03737 
<a name="l03738"></a>03738                 }
<a name="l03739"></a>03739 
<a name="l03740"></a>03740         }
<a name="l03741"></a>03741 
<a name="l03742"></a>03742         <span class="comment">/******* HOST WAS UP INITIALLY *******/</span>
<a name="l03743"></a>03743         <span class="keywordflow">else</span>{
<a name="l03744"></a>03744 
<a name="l03745"></a>03745                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Host was UP.\n&quot;</span>);
<a name="l03746"></a>03746 
<a name="l03747"></a>03747                 <span class="comment">/***** HOST IS STILL UP *****/</span>
<a name="l03748"></a>03748                 <span class="comment">/* either the host never went down since last check */</span>
<a name="l03749"></a>03749                 <span class="keywordflow">if</span>(new_state==<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>){
<a name="l03750"></a>03750 
<a name="l03751"></a>03751                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Host is still UP.\n&quot;</span>);
<a name="l03752"></a>03752 
<a name="l03753"></a>03753                         <span class="comment">/* set the current state */</span>
<a name="l03754"></a>03754                         hst-&gt;current_state=<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>;
<a name="l03755"></a>03755 
<a name="l03756"></a>03756                         <span class="comment">/* set the state type */</span>
<a name="l03757"></a>03757                         hst-&gt;state_type=<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a>;
<a name="l03758"></a>03758 
<a name="l03759"></a>03759                         <span class="comment">/* reschedule the next check at the normal interval */</span>
<a name="l03760"></a>03760                         <span class="keywordflow">if</span>(reschedule_check==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l03761"></a>03761                                 next_check=(<span class="keywordtype">unsigned</span> long)(current_time+(hst-&gt;<a class="code" href="structhost__struct.html#a75fa71ddb31a4fbfd6ce60ebd69d6064">check_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>));
<a name="l03762"></a>03762                 }
<a name="l03763"></a>03763 
<a name="l03764"></a>03764                 <span class="comment">/***** HOST IS NOW DOWN/UNREACHABLE *****/</span>
<a name="l03765"></a>03765                 <span class="keywordflow">else</span>{
<a name="l03766"></a>03766 
<a name="l03767"></a>03767                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Host is now DOWN/UNREACHABLE.\n&quot;</span>);
<a name="l03768"></a>03768 
<a name="l03769"></a>03769                         <span class="comment">/***** SPECIAL CASE FOR HOSTS WITH MAX_ATTEMPTS==1 *****/</span>
<a name="l03770"></a>03770                         <span class="keywordflow">if</span>(hst-&gt;<a class="code" href="structhost__struct.html#a091388e27be66d35e87ed643567079c5">max_attempts</a>==1){
<a name="l03771"></a>03771 
<a name="l03772"></a>03772                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Max attempts = 1!.\n&quot;</span>);
<a name="l03773"></a>03773 
<a name="l03774"></a>03774                                 <span class="comment">/* set the state type */</span>
<a name="l03775"></a>03775                                 hst-&gt;state_type=<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a>;
<a name="l03776"></a>03776 
<a name="l03777"></a>03777                                 <span class="comment">/* host has maxed out on retries, so reschedule the next check at the normal interval */</span>
<a name="l03778"></a>03778                                 reschedule_check=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03779"></a>03779                                 next_check=(<span class="keywordtype">unsigned</span> long)(current_time+(hst-&gt;<a class="code" href="structhost__struct.html#a75fa71ddb31a4fbfd6ce60ebd69d6064">check_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>));
<a name="l03780"></a>03780 
<a name="l03781"></a>03781                                 <span class="comment">/* we need to run SYNCHRONOUS checks of all parent hosts to accurately determine the state of this host */</span>
<a name="l03782"></a>03782                                 <span class="comment">/* this is extremely inefficient (reminiscent of Icinga 2.x logic), but there&#39;s no other good way around it */</span>
<a name="l03783"></a>03783                                 <span class="comment">/* check all parent hosts to see if we&#39;re DOWN or UNREACHABLE */</span>
<a name="l03784"></a>03784                                 <span class="comment">/* only do this for ACTIVE checks, as PASSIVE checks contain a pre-determined state */</span>
<a name="l03785"></a>03785                                 <span class="keywordflow">if</span>(hst-&gt;check_type==<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a>){
<a name="l03786"></a>03786 
<a name="l03787"></a>03787                                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;** WARNING: Max attempts = 1, so we have to run serial checks of all parent hosts!\n&quot;</span>);
<a name="l03788"></a>03788 
<a name="l03789"></a>03789                                         <span class="keywordflow">for</span>(temp_hostsmember=hst-&gt;<a class="code" href="structhost__struct.html#aa095184cd77886611768b09f7e4f6822">parent_hosts</a>;temp_hostsmember!=NULL;temp_hostsmember=temp_hostsmember-&gt;<a class="code" href="structhostsmember__struct.html#afdbb9b1473010e32f413d5d8aa57f265">next</a>){
<a name="l03790"></a>03790 
<a name="l03791"></a>03791                                                 <span class="keywordflow">if</span>((parent_host=temp_hostsmember-&gt;host_ptr)==NULL)
<a name="l03792"></a>03792                                                         <span class="keywordflow">continue</span>;
<a name="l03793"></a>03793 
<a name="l03794"></a>03794                                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Running serial check parent host &#39;%s&#39;...\n&quot;</span>,parent_host-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l03795"></a>03795 
<a name="l03796"></a>03796                                                 <span class="comment">/* run an immediate check of the parent host */</span>
<a name="l03797"></a>03797                                                 <a class="code" href="checks_8c.html#a9ef139bca6ec112f21d6ac880cfa8483">run_sync_host_check_3x</a>(parent_host,&amp;parent_state,check_options,use_cached_result,check_timestamp_horizon);
<a name="l03798"></a>03798 
<a name="l03799"></a>03799                                                 <span class="comment">/* bail out as soon as we find one parent host that is UP */</span>
<a name="l03800"></a>03800                                                 <span class="keywordflow">if</span>(parent_state==<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>){
<a name="l03801"></a>03801 
<a name="l03802"></a>03802                                                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Parent host is UP, so this one is DOWN.\n&quot;</span>);
<a name="l03803"></a>03803 
<a name="l03804"></a>03804                                                         <span class="comment">/* set the current state */</span>
<a name="l03805"></a>03805                                                         hst-&gt;current_state=<a class="code" href="icinga_8h.html#a19d20cca11e4cf399742ad25c05d73fb">HOST_DOWN</a>;
<a name="l03806"></a>03806                                                         <span class="keywordflow">break</span>;
<a name="l03807"></a>03807                                                 }
<a name="l03808"></a>03808                                         }
<a name="l03809"></a>03809 
<a name="l03810"></a>03810                                         <span class="keywordflow">if</span>(temp_hostsmember==NULL){
<a name="l03811"></a>03811                                                 <span class="comment">/* host has no parents, so its up */</span>
<a name="l03812"></a>03812                                                 <span class="keywordflow">if</span>(hst-&gt;<a class="code" href="structhost__struct.html#aa095184cd77886611768b09f7e4f6822">parent_hosts</a>==NULL){
<a name="l03813"></a>03813                                                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Host has no parents, so it&#39;s DOWN.\n&quot;</span>);
<a name="l03814"></a>03814                                                         hst-&gt;current_state=<a class="code" href="icinga_8h.html#a19d20cca11e4cf399742ad25c05d73fb">HOST_DOWN</a>;
<a name="l03815"></a>03815                                                 }
<a name="l03816"></a>03816                                                 <span class="keywordflow">else</span>{
<a name="l03817"></a>03817                                                         <span class="comment">/* no parents were up, so this host is UNREACHABLE */</span>
<a name="l03818"></a>03818                                                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;No parents were UP, so this host is UNREACHABLE.\n&quot;</span>);
<a name="l03819"></a>03819                                                         hst-&gt;current_state=<a class="code" href="icinga_8h.html#ab1433105627834e0a2c670250bf64285">HOST_UNREACHABLE</a>;
<a name="l03820"></a>03820                                                 }
<a name="l03821"></a>03821                                         }
<a name="l03822"></a>03822                                 }
<a name="l03823"></a>03823 
<a name="l03824"></a>03824                                 <span class="comment">/* set the host state for passive checks */</span>
<a name="l03825"></a>03825                                 <span class="keywordflow">else</span>{
<a name="l03826"></a>03826                                         <span class="comment">/* set the state */</span>
<a name="l03827"></a>03827                                         hst-&gt;current_state=new_state;
<a name="l03828"></a>03828 
<a name="l03829"></a>03829                                         <span class="comment">/* translate host state between DOWN/UNREACHABLE for passive checks (if enabled) */</span>
<a name="l03830"></a>03830                                         <span class="comment">/* make a determination of the host&#39;s state */</span>
<a name="l03831"></a>03831                                         <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#aeef0f20f58de2ac8a2db469fdc767b6f">translate_passive_host_checks</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l03832"></a>03832                                                 hst-&gt;current_state=<a class="code" href="checks_8c.html#a191896d6b76732d8432d65107faa5954">determine_host_reachability</a>(hst);
<a name="l03833"></a>03833 
<a name="l03834"></a>03834                                 }
<a name="l03835"></a>03835 
<a name="l03836"></a>03836                                 <span class="comment">/* propagate checks to immediate children if they are not UNREACHABLE */</span>
<a name="l03837"></a>03837                                 <span class="comment">/* we do this because we may now be blocking the route to child hosts */</span>
<a name="l03838"></a>03838                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Propagating check to immediate non-UNREACHABLE child hosts...\n&quot;</span>);
<a name="l03839"></a>03839 
<a name="l03840"></a>03840                                 <span class="keywordflow">for</span>(temp_hostsmember=hst-&gt;<a class="code" href="structhost__struct.html#aa18c4cc7c68f01848dc967ff7779b22d">child_hosts</a>;temp_hostsmember!=NULL;temp_hostsmember=temp_hostsmember-&gt;<a class="code" href="structhostsmember__struct.html#afdbb9b1473010e32f413d5d8aa57f265">next</a>){
<a name="l03841"></a>03841                                         <span class="keywordflow">if</span>((child_host=temp_hostsmember-&gt;host_ptr)==NULL)
<a name="l03842"></a>03842                                                 <span class="keywordflow">continue</span>;
<a name="l03843"></a>03843                                         <span class="keywordflow">if</span>(child_host-&gt;current_state!=<a class="code" href="icinga_8h.html#ab1433105627834e0a2c670250bf64285">HOST_UNREACHABLE</a>){
<a name="l03844"></a>03844                                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Check of child host &#39;%s&#39; queued.\n&quot;</span>,child_host-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l03845"></a>03845                                                 add_object_to_objectlist(&amp;check_hostlist,(<span class="keywordtype">void</span> *)child_host);
<a name="l03846"></a>03846                                         }
<a name="l03847"></a>03847                                 }
<a name="l03848"></a>03848                         }
<a name="l03849"></a>03849 
<a name="l03850"></a>03850                         <span class="comment">/***** MAX ATTEMPTS &gt; 1 *****/</span>
<a name="l03851"></a>03851                         <span class="keywordflow">else</span>{
<a name="l03852"></a>03852 
<a name="l03853"></a>03853                                 <span class="comment">/* active and (in some cases) passive check results are treated as SOFT states */</span>
<a name="l03854"></a>03854                                 <span class="keywordflow">if</span>(hst-&gt;check_type==<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a> || <a class="code" href="checks_8c.html#a90011bddac350082a4ab3b13758afcbe">passive_host_checks_are_soft</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l03855"></a>03855 
<a name="l03856"></a>03856                                         <span class="comment">/* set the state type */</span>
<a name="l03857"></a>03857                                         hst-&gt;state_type=<a class="code" href="include_2common_8h.html#a74a8e12b67587cb027f5f12bb7b0fe8d">SOFT_STATE</a>;
<a name="l03858"></a>03858                                 }
<a name="l03859"></a>03859 
<a name="l03860"></a>03860                                 <span class="comment">/* by default, passive check results are treated as HARD states */</span>
<a name="l03861"></a>03861                                 <span class="keywordflow">else</span>{
<a name="l03862"></a>03862 
<a name="l03863"></a>03863                                         <span class="comment">/* set the state type */</span>
<a name="l03864"></a>03864                                         hst-&gt;state_type=<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a>;
<a name="l03865"></a>03865 
<a name="l03866"></a>03866                                         <span class="comment">/* reset the current attempt */</span>
<a name="l03867"></a>03867                                         hst-&gt;current_attempt=1;
<a name="l03868"></a>03868                                 }
<a name="l03869"></a>03869 
<a name="l03870"></a>03870                                 <span class="comment">/* make a (in some cases) preliminary determination of the host&#39;s state */</span>
<a name="l03871"></a>03871                                 <span class="comment">/* translate host state between DOWN/UNREACHABLE (for passive checks only if enabled) */</span>
<a name="l03872"></a>03872                                 hst-&gt;current_state=new_state;
<a name="l03873"></a>03873                                 <span class="keywordflow">if</span>(hst-&gt;check_type==<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a> || <a class="code" href="checks_8c.html#aeef0f20f58de2ac8a2db469fdc767b6f">translate_passive_host_checks</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l03874"></a>03874                                         hst-&gt;current_state=<a class="code" href="checks_8c.html#a191896d6b76732d8432d65107faa5954">determine_host_reachability</a>(hst);
<a name="l03875"></a>03875 
<a name="l03876"></a>03876                                 <span class="comment">/* reschedule a check of the host */</span>
<a name="l03877"></a>03877                                 reschedule_check=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03878"></a>03878 
<a name="l03879"></a>03879                                 <span class="comment">/* schedule a re-check of the host at the retry interval because we can&#39;t determine its final state yet... */</span>
<a name="l03880"></a>03880                                 <span class="keywordflow">if</span>(hst-&gt;check_type==<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a> || <a class="code" href="checks_8c.html#a90011bddac350082a4ab3b13758afcbe">passive_host_checks_are_soft</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l03881"></a>03881                                         next_check=(<span class="keywordtype">unsigned</span> long)(current_time+(hst-&gt;<a class="code" href="structhost__struct.html#a444411c02f976b4141d2cc28e55b5eda">retry_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>));
<a name="l03882"></a>03882 
<a name="l03883"></a>03883                                 <span class="comment">/* schedule a re-check of the host at the normal interval */</span>
<a name="l03884"></a>03884                                 <span class="keywordflow">else</span>
<a name="l03885"></a>03885                                         next_check=(<span class="keywordtype">unsigned</span> long)(current_time+(hst-&gt;<a class="code" href="structhost__struct.html#a75fa71ddb31a4fbfd6ce60ebd69d6064">check_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>));
<a name="l03886"></a>03886 
<a name="l03887"></a>03887                                 <span class="comment">/* propagate checks to immediate parents if they are UP */</span>
<a name="l03888"></a>03888                                 <span class="comment">/* we do this because a parent host (or grandparent) may have gone down and blocked our route */</span>
<a name="l03889"></a>03889                                 <span class="comment">/* checking the parents ASAP will allow us to better determine the final state (DOWN/UNREACHABLE) of this host later */</span>
<a name="l03890"></a>03890                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Propagating checks to immediate parent hosts that are UP...\n&quot;</span>);
<a name="l03891"></a>03891 
<a name="l03892"></a>03892                                 <span class="keywordflow">for</span>(temp_hostsmember=hst-&gt;<a class="code" href="structhost__struct.html#aa095184cd77886611768b09f7e4f6822">parent_hosts</a>;temp_hostsmember!=NULL;temp_hostsmember=temp_hostsmember-&gt;<a class="code" href="structhostsmember__struct.html#afdbb9b1473010e32f413d5d8aa57f265">next</a>){
<a name="l03893"></a>03893                                         <span class="keywordflow">if</span>((parent_host=temp_hostsmember-&gt;host_ptr)==NULL)
<a name="l03894"></a>03894                                                 <span class="keywordflow">continue</span>;
<a name="l03895"></a>03895                                         <span class="keywordflow">if</span>(parent_host-&gt;current_state==<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>){
<a name="l03896"></a>03896                                                 add_object_to_objectlist(&amp;check_hostlist,(<span class="keywordtype">void</span> *)parent_host);
<a name="l03897"></a>03897                                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Check of host &#39;%s&#39; queued.\n&quot;</span>,parent_host-&gt;name);
<a name="l03898"></a>03898                                         }
<a name="l03899"></a>03899                                 }
<a name="l03900"></a>03900 
<a name="l03901"></a>03901                                 <span class="comment">/* propagate checks to immediate children if they are not UNREACHABLE */</span>
<a name="l03902"></a>03902                                 <span class="comment">/* we do this because we may now be blocking the route to child hosts */</span>
<a name="l03903"></a>03903                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Propagating checks to immediate non-UNREACHABLE child hosts...\n&quot;</span>);
<a name="l03904"></a>03904 
<a name="l03905"></a>03905                                 <span class="keywordflow">for</span>(temp_hostsmember=hst-&gt;<a class="code" href="structhost__struct.html#aa18c4cc7c68f01848dc967ff7779b22d">child_hosts</a>;temp_hostsmember!=NULL;temp_hostsmember=temp_hostsmember-&gt;<a class="code" href="structhostsmember__struct.html#afdbb9b1473010e32f413d5d8aa57f265">next</a>){
<a name="l03906"></a>03906                                         <span class="keywordflow">if</span>((child_host=temp_hostsmember-&gt;host_ptr)==NULL)
<a name="l03907"></a>03907                                                 <span class="keywordflow">continue</span>;
<a name="l03908"></a>03908                                         <span class="keywordflow">if</span>(child_host-&gt;current_state!=<a class="code" href="icinga_8h.html#ab1433105627834e0a2c670250bf64285">HOST_UNREACHABLE</a>){
<a name="l03909"></a>03909                                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Check of child host &#39;%s&#39; queued.\n&quot;</span>,child_host-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l03910"></a>03910                                                 add_object_to_objectlist(&amp;check_hostlist,(<span class="keywordtype">void</span> *)child_host);
<a name="l03911"></a>03911                                         }
<a name="l03912"></a>03912                                 }
<a name="l03913"></a>03913 
<a name="l03914"></a>03914                                 <span class="comment">/* check dependencies on second to last host check */</span>
<a name="l03915"></a>03915                                 <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#ad658f0152df44d67fd5fe012fc1faf3f">enable_predictive_host_dependency_checks</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; hst-&gt;current_attempt==(hst-&gt;<a class="code" href="structhost__struct.html#a091388e27be66d35e87ed643567079c5">max_attempts</a>-1)){
<a name="l03916"></a>03916 
<a name="l03917"></a>03917                                         <span class="comment">/* propagate checks to hosts that THIS ONE depends on for notifications AND execution */</span>
<a name="l03918"></a>03918                                         <span class="comment">/* we do to help ensure that the dependency checks are accurate before it comes time to notify */</span>
<a name="l03919"></a>03919                                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Propagating predictive dependency checks to hosts this one depends on...\n&quot;</span>);
<a name="l03920"></a>03920 
<a name="l03921"></a>03921                                         <span class="keywordflow">for</span>(temp_dependency=<a class="code" href="objects_8c.html#a548bd02d785a9bc99c58599312e3ec51">get_first_hostdependency_by_dependent_host</a>(hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>,&amp;ptr);temp_dependency!=NULL;temp_dependency=<a class="code" href="objects_8c.html#ab963c7b6af43e541e5a147f5ac3f5aa6">get_next_hostdependency_by_dependent_host</a>(hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>,&amp;ptr)){
<a name="l03922"></a>03922                                                 <span class="keywordflow">if</span>(temp_dependency-&gt;dependent_host_ptr==hst &amp;&amp; temp_dependency-&gt;master_host_ptr!=NULL){
<a name="l03923"></a>03923                                                         master_host=(<a class="code" href="structhost__struct.html">host</a> *)temp_dependency-&gt;master_host_ptr;
<a name="l03924"></a>03924                                                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Check of host &#39;%s&#39; queued.\n&quot;</span>,master_host-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l03925"></a>03925                                                         add_object_to_objectlist(&amp;check_hostlist,(<span class="keywordtype">void</span> *)master_host);
<a name="l03926"></a>03926                                                 }
<a name="l03927"></a>03927                                         }
<a name="l03928"></a>03928                                 }
<a name="l03929"></a>03929                         }
<a name="l03930"></a>03930                 }
<a name="l03931"></a>03931         }
<a name="l03932"></a>03932 
<a name="l03933"></a>03933         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Pre-handle_host_state() Host: %s, Attempt=%d/%d, Type=%s, Final State=%d\n&quot;</span>,hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>,hst-&gt;current_attempt,hst-&gt;<a class="code" href="structhost__struct.html#a091388e27be66d35e87ed643567079c5">max_attempts</a>,(hst-&gt;state_type==<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a>)?<span class="stringliteral">&quot;HARD&quot;</span>:<span class="stringliteral">&quot;SOFT&quot;</span>,hst-&gt;current_state);
<a name="l03934"></a>03934 
<a name="l03935"></a>03935         <span class="comment">/* handle the host state */</span>
<a name="l03936"></a>03936         <a class="code" href="sehandlers_8c.html#a29ee94acf1b2eae07d8c7d00091612ed">handle_host_state</a>(hst);
<a name="l03937"></a>03937 
<a name="l03938"></a>03938         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Post-handle_host_state() Host: %s, Attempt=%d/%d, Type=%s, Final State=%d\n&quot;</span>,hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>,hst-&gt;current_attempt,hst-&gt;<a class="code" href="structhost__struct.html#a091388e27be66d35e87ed643567079c5">max_attempts</a>,(hst-&gt;state_type==<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a>)?<span class="stringliteral">&quot;HARD&quot;</span>:<span class="stringliteral">&quot;SOFT&quot;</span>,hst-&gt;current_state);
<a name="l03939"></a>03939 
<a name="l03940"></a>03940 
<a name="l03941"></a>03941         <span class="comment">/******************** POST-PROCESSING STUFF *********************/</span>
<a name="l03942"></a>03942 
<a name="l03943"></a>03943         <span class="comment">/* if the plugin output differs from previous check and no state change, log the current state/output if state stalking is enabled */</span>
<a name="l03944"></a>03944         <span class="keywordflow">if</span>(hst-&gt;last_state==hst-&gt;current_state &amp;&amp; <a class="code" href="base_2utils_8c.html#a93ccc39494aa0f291d6c4a117be0bfff">compare_strings</a>(old_plugin_output,hst-&gt;plugin_output)){
<a name="l03945"></a>03945 
<a name="l03946"></a>03946                 <span class="keywordflow">if</span>(hst-&gt;current_state==<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a> &amp;&amp; hst-&gt;<a class="code" href="structhost__struct.html#a45cf66258d41c63fc1a5fa8474a0edd6">stalk_on_up</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) {
<a name="l03947"></a>03947 
<a name="l03948"></a>03948                         <a class="code" href="logging_8c.html#a07fdbbcac91ef9dced2a590877b9eb61">log_host_event</a>(hst);
<a name="l03949"></a>03949 
<a name="l03950"></a>03950                         <span class="comment">/* should we run event handlers ? */</span>
<a name="l03951"></a>03951                         <span class="keywordflow">if</span> (<a class="code" href="checks_8c.html#ae96ccc43c200c07e833891d2b6ca8bba">stalking_event_handlers_for_hosts</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l03952"></a>03952                                 <a class="code" href="sehandlers_8c.html#a1044cc6deb1a97da7dfd132978685205">handle_host_event</a>(hst);
<a name="l03953"></a>03953 
<a name="l03954"></a>03954                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(hst-&gt;current_state==<a class="code" href="icinga_8h.html#a19d20cca11e4cf399742ad25c05d73fb">HOST_DOWN</a> &amp;&amp; hst-&gt;<a class="code" href="structhost__struct.html#a6385929b59a76d7248e7462f61febb6a">stalk_on_down</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) {
<a name="l03955"></a>03955 
<a name="l03956"></a>03956                         <a class="code" href="logging_8c.html#a07fdbbcac91ef9dced2a590877b9eb61">log_host_event</a>(hst);
<a name="l03957"></a>03957 
<a name="l03958"></a>03958                         <span class="comment">/* should we run event handlers ? */</span>
<a name="l03959"></a>03959                         <span class="keywordflow">if</span> (<a class="code" href="checks_8c.html#ae96ccc43c200c07e833891d2b6ca8bba">stalking_event_handlers_for_hosts</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l03960"></a>03960                                 <a class="code" href="sehandlers_8c.html#a1044cc6deb1a97da7dfd132978685205">handle_host_event</a>(hst);
<a name="l03961"></a>03961 
<a name="l03962"></a>03962                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(hst-&gt;current_state==<a class="code" href="icinga_8h.html#ab1433105627834e0a2c670250bf64285">HOST_UNREACHABLE</a> &amp;&amp; hst-&gt;<a class="code" href="structhost__struct.html#aff6e4f42df1c1f50a886687d90a40580">stalk_on_unreachable</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) {
<a name="l03963"></a>03963 
<a name="l03964"></a>03964                         <a class="code" href="logging_8c.html#a07fdbbcac91ef9dced2a590877b9eb61">log_host_event</a>(hst);
<a name="l03965"></a>03965 
<a name="l03966"></a>03966                         <span class="comment">/* should we run event handlers ? */</span>
<a name="l03967"></a>03967                         <span class="keywordflow">if</span> (<a class="code" href="checks_8c.html#ae96ccc43c200c07e833891d2b6ca8bba">stalking_event_handlers_for_hosts</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l03968"></a>03968                                 <a class="code" href="sehandlers_8c.html#a1044cc6deb1a97da7dfd132978685205">handle_host_event</a>(hst);
<a name="l03969"></a>03969                 }
<a name="l03970"></a>03970         }
<a name="l03971"></a>03971 
<a name="l03972"></a>03972         <span class="comment">/* check to see if the associated host is flapping */</span>
<a name="l03973"></a>03973         <a class="code" href="flapping_8c.html#a8630308cd8208adfcb1ec86ae1a6e8f8">check_for_host_flapping</a>(hst,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l03974"></a>03974 
<a name="l03975"></a>03975         <span class="comment">/* reschedule the next check of the host (usually ONLY for scheduled, active checks, unless overridden above) */</span>
<a name="l03976"></a>03976         <span class="keywordflow">if</span>(reschedule_check==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l03977"></a>03977 
<a name="l03978"></a>03978                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Rescheduling next check of host at %s&quot;</span>,ctime(&amp;next_check));
<a name="l03979"></a>03979 
<a name="l03980"></a>03980                 <span class="comment">/* default is to reschedule host check unless a test below fails... */</span>
<a name="l03981"></a>03981                 hst-&gt;should_be_scheduled=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03982"></a>03982 
<a name="l03983"></a>03983                 <span class="comment">/* get the new current time */</span>
<a name="l03984"></a>03984                 time(&amp;current_time);
<a name="l03985"></a>03985 
<a name="l03986"></a>03986                 <span class="comment">/* make sure we don&#39;t get ourselves into too much trouble... */</span>
<a name="l03987"></a>03987                 <span class="keywordflow">if</span>(current_time&gt;next_check)
<a name="l03988"></a>03988                         hst-&gt;next_check=<a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>;
<a name="l03989"></a>03989                 <span class="keywordflow">else</span>
<a name="l03990"></a>03990                         hst-&gt;next_check=next_check;
<a name="l03991"></a>03991 
<a name="l03992"></a>03992                 <span class="comment">/* make sure we rescheduled the next service check at a valid time */</span>
<a name="l03993"></a>03993                 preferred_time=hst-&gt;next_check;
<a name="l03994"></a>03994                 <a class="code" href="base_2utils_8c.html#a887cf03e0c7cfc020e10e9f1949aae2e">get_next_valid_time</a>(preferred_time,&amp;next_valid_time,hst-&gt;check_period_ptr);
<a name="l03995"></a>03995                 hst-&gt;next_check=next_valid_time;
<a name="l03996"></a>03996 
<a name="l03997"></a>03997                 <span class="comment">/* hosts with non-recurring intervals do not get rescheduled if we&#39;re in a HARD or UP state */</span>
<a name="l03998"></a>03998                 <span class="keywordflow">if</span>(hst-&gt;<a class="code" href="structhost__struct.html#a75fa71ddb31a4fbfd6ce60ebd69d6064">check_interval</a>==0 &amp;&amp; (hst-&gt;state_type==<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a> || hst-&gt;current_state==<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>))
<a name="l03999"></a>03999                         hst-&gt;should_be_scheduled=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04000"></a>04000 
<a name="l04001"></a>04001                 <span class="comment">/* host with active checks disabled do not get rescheduled */</span>
<a name="l04002"></a>04002                 <span class="keywordflow">if</span>(hst-&gt;<a class="code" href="structhost__struct.html#a3ef980834ed0a10fd7fe1f02a7daba9b">checks_enabled</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l04003"></a>04003                         hst-&gt;should_be_scheduled=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04004"></a>04004 
<a name="l04005"></a>04005                 <span class="comment">/* schedule a non-forced check if we can */</span>
<a name="l04006"></a>04006                 <span class="keywordflow">if</span>(hst-&gt;should_be_scheduled==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l04007"></a>04007                         <a class="code" href="checks_8c.html#aacf489b05d155c06c18a596107484b79">schedule_host_check</a>(hst,hst-&gt;next_check,<a class="code" href="include_2common_8h.html#ac2e0ba323965f243a1988566a8ea53da">CHECK_OPTION_NONE</a>);
<a name="l04008"></a>04008                 }
<a name="l04009"></a>04009 
<a name="l04010"></a>04010         }
<a name="l04011"></a>04011 
<a name="l04012"></a>04012         <span class="comment">/* update host status - for both active (scheduled) and passive (non-scheduled) hosts */</span>
<a name="l04013"></a>04013         update_host_status(hst,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l04014"></a>04014 
<a name="l04015"></a>04015         <span class="comment">/* run async checks of all hosts we added above */</span>
<a name="l04016"></a>04016         <span class="comment">/* don&#39;t run a check if one is already executing or we can get by with a cached state */</span>
<a name="l04017"></a>04017         <span class="keywordflow">for</span>(hostlist_item=check_hostlist;hostlist_item!=NULL;hostlist_item=hostlist_item-&gt;<a class="code" href="structobjectlist__struct.html#accd7c929ab00effa8a00c5f698bd2de6">next</a>){
<a name="l04018"></a>04018                 run_async_check=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04019"></a>04019                 temp_host=(<a class="code" href="structhost__struct.html">host</a> *)hostlist_item-&gt;<a class="code" href="structobjectlist__struct.html#a82bc35402bbb2d57a919e2660f232c68">object_ptr</a>;
<a name="l04020"></a>04020 
<a name="l04021"></a>04021                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;ASYNC CHECK OF HOST: %s, CURRENTTIME: %lu, LASTHOSTCHECK: %lu, CACHEDTIMEHORIZON: %lu, USECACHEDRESULT: %d, ISEXECUTING: %d\n&quot;</span>,temp_host-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>,current_time,temp_host-&gt;last_check,check_timestamp_horizon,use_cached_result,temp_host-&gt;is_executing);
<a name="l04022"></a>04022 
<a name="l04023"></a>04023                 <span class="keywordflow">if</span>(use_cached_result==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; ((current_time-temp_host-&gt;last_check)&lt;=check_timestamp_horizon))
<a name="l04024"></a>04024                         run_async_check=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04025"></a>04025                 <span class="keywordflow">if</span>(temp_host-&gt;is_executing==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l04026"></a>04026                         run_async_check=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04027"></a>04027                 <span class="keywordflow">if</span>(run_async_check==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l04028"></a>04028                         <a class="code" href="checks_8c.html#ae41ccfe2cbc8c303d642f3315a0ad4d7">run_async_host_check_3x</a>(temp_host,<a class="code" href="include_2common_8h.html#ac2e0ba323965f243a1988566a8ea53da">CHECK_OPTION_NONE</a>,0.0,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,NULL,NULL);
<a name="l04029"></a>04029         }
<a name="l04030"></a>04030         free_objectlist(&amp;check_hostlist);
<a name="l04031"></a>04031 
<a name="l04032"></a>04032         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l04033"></a>04033 }
<a name="l04034"></a>04034 
<a name="l04035"></a>04035 
<a name="l04036"></a>04036 
<a name="l04037"></a>04037 <span class="comment">/* checks viability of performing a host check */</span>
<a name="l04038"></a><a class="code" href="icinga_8h.html#a4bf7a47da0bb8a7a5c41fb64614312d1">04038</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#aaffacd6bdfb12ea872c68d820700213f">check_host_check_viability_3x</a>(<a class="code" href="structhost__struct.html">host</a> *hst, <span class="keywordtype">int</span> check_options, <span class="keywordtype">int</span> *time_is_valid, time_t *new_time){
<a name="l04039"></a>04039         <span class="keywordtype">int</span> result=<a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l04040"></a>04040         <span class="keywordtype">int</span> perform_check=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04041"></a>04041         time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>=0L;
<a name="l04042"></a>04042         time_t preferred_time=0L;
<a name="l04043"></a>04043         <span class="keywordtype">int</span> check_interval=0;
<a name="l04044"></a>04044 
<a name="l04045"></a>04045         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;check_host_check_viability_3x()\n&quot;</span>);
<a name="l04046"></a>04046 
<a name="l04047"></a>04047         <span class="comment">/* make sure we have a host */</span>
<a name="l04048"></a>04048         <span class="keywordflow">if</span>(hst==NULL)
<a name="l04049"></a>04049                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l04050"></a>04050 
<a name="l04051"></a>04051         <span class="comment">/* get the check interval to use if we need to reschedule the check */</span>
<a name="l04052"></a>04052         <span class="keywordflow">if</span>(hst-&gt;state_type==<a class="code" href="include_2common_8h.html#a74a8e12b67587cb027f5f12bb7b0fe8d">SOFT_STATE</a> &amp;&amp; hst-&gt;current_state!=<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>)
<a name="l04053"></a>04053                 check_interval=(hst-&gt;<a class="code" href="structhost__struct.html#a444411c02f976b4141d2cc28e55b5eda">retry_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>);
<a name="l04054"></a>04054         <span class="keywordflow">else</span>
<a name="l04055"></a>04055                 check_interval=(hst-&gt;<a class="code" href="structhost__struct.html#a75fa71ddb31a4fbfd6ce60ebd69d6064">check_interval</a>*<a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>);
<a name="l04056"></a>04056 
<a name="l04057"></a>04057         <span class="comment">/* make sure check interval is positive - otherwise use 5 minutes out for next check */</span>
<a name="l04058"></a>04058         <span class="keywordflow">if</span>(check_interval&lt;=0)
<a name="l04059"></a>04059                 check_interval=300;
<a name="l04060"></a>04060 
<a name="l04061"></a>04061         <span class="comment">/* get the current time */</span>
<a name="l04062"></a>04062         time(&amp;current_time);
<a name="l04063"></a>04063 
<a name="l04064"></a>04064         <span class="comment">/* initialize the next preferred check time */</span>
<a name="l04065"></a>04065         preferred_time=<a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>;
<a name="l04066"></a>04066 
<a name="l04067"></a>04067         <span class="comment">/* can we check the host right now? */</span>
<a name="l04068"></a>04068         <span class="keywordflow">if</span>(!(check_options &amp; <a class="code" href="include_2common_8h.html#a7c2da00f285e024a7f2f81d633684b0f">CHECK_OPTION_FORCE_EXECUTION</a>)){
<a name="l04069"></a>04069 
<a name="l04070"></a>04070                 <span class="comment">/* if checks of the host are currently disabled... */</span>
<a name="l04071"></a>04071                 <span class="keywordflow">if</span>(hst-&gt;<a class="code" href="structhost__struct.html#a3ef980834ed0a10fd7fe1f02a7daba9b">checks_enabled</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l04072"></a>04072                         preferred_time=current_time+check_interval;
<a name="l04073"></a>04073                         perform_check=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04074"></a>04074                 }
<a name="l04075"></a>04075 
<a name="l04076"></a>04076                 <span class="comment">/* make sure this is a valid time to check the host */</span>
<a name="l04077"></a>04077                 <span class="keywordflow">if</span>(<a class="code" href="base_2utils_8c.html#a49602563f5f03788d56b2d06d2c72bfb">check_time_against_period</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)current_time,hst-&gt;check_period_ptr)==<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>){
<a name="l04078"></a>04078                         preferred_time=<a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>;
<a name="l04079"></a>04079                         <span class="keywordflow">if</span>(time_is_valid)
<a name="l04080"></a>04080                                 *time_is_valid=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04081"></a>04081                         perform_check=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04082"></a>04082                 }
<a name="l04083"></a>04083 
<a name="l04084"></a>04084                 <span class="comment">/* check host dependencies for execution */</span>
<a name="l04085"></a>04085                 <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#ac467ac509d3608fa5105ba8eaaea6910">check_host_dependencies</a>(hst,<a class="code" href="include_2common_8h.html#a70583e81777a3d22be6d62b295302b85">EXECUTION_DEPENDENCY</a>)==<a class="code" href="icinga_8h.html#a9c4ca9fdb0f89ec497ae74bf7ab7404c">DEPENDENCIES_FAILED</a>){
<a name="l04086"></a>04086                         preferred_time=current_time+check_interval;
<a name="l04087"></a>04087                         perform_check=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04088"></a>04088                 }
<a name="l04089"></a>04089         }
<a name="l04090"></a>04090 
<a name="l04091"></a>04091         <span class="comment">/* pass back the next viable check time */</span>
<a name="l04092"></a>04092         <span class="keywordflow">if</span>(new_time)
<a name="l04093"></a>04093                 *new_time=preferred_time;
<a name="l04094"></a>04094 
<a name="l04095"></a>04095         result=(perform_check==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)?<a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>:<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l04096"></a>04096 
<a name="l04097"></a>04097         <span class="keywordflow">return</span> result;
<a name="l04098"></a>04098 }
<a name="l04099"></a>04099 
<a name="l04100"></a>04100 
<a name="l04101"></a>04101 
<a name="l04102"></a>04102 <span class="comment">/* adjusts current host check attempt before a new check is performed */</span>
<a name="l04103"></a><a class="code" href="icinga_8h.html#a0c3248f1ab1ba9862040bd318681dc5e">04103</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#ab34b1556234001a05a9765f063eaf0e6">adjust_host_check_attempt_3x</a>(<a class="code" href="structhost__struct.html">host</a> *hst, <span class="keywordtype">int</span> is_active){
<a name="l04104"></a>04104 
<a name="l04105"></a>04105         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;adjust_host_check_attempt_3x()\n&quot;</span>);
<a name="l04106"></a>04106 
<a name="l04107"></a>04107         <span class="keywordflow">if</span>(hst==NULL)
<a name="l04108"></a>04108                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l04109"></a>04109 
<a name="l04110"></a>04110         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Adjusting check attempt number for host &#39;%s&#39;: current attempt=%d/%d, state=%d, state type=%d\n&quot;</span>,hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>,hst-&gt;current_attempt,hst-&gt;<a class="code" href="structhost__struct.html#a091388e27be66d35e87ed643567079c5">max_attempts</a>,hst-&gt;current_state,hst-&gt;state_type);
<a name="l04111"></a>04111 
<a name="l04112"></a>04112         <span class="comment">/* if host is in a hard state, reset current attempt number */</span>
<a name="l04113"></a>04113         <span class="keywordflow">if</span>(hst-&gt;state_type==<a class="code" href="include_2common_8h.html#aa976aa0e10c83f54795a5bf5f56b9d14">HARD_STATE</a>)
<a name="l04114"></a>04114                 hst-&gt;current_attempt=1;
<a name="l04115"></a>04115 
<a name="l04116"></a>04116         <span class="comment">/* if host is in a soft UP state, reset current attempt number (active checks only) */</span>
<a name="l04117"></a>04117         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(is_active==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; hst-&gt;state_type==<a class="code" href="include_2common_8h.html#a74a8e12b67587cb027f5f12bb7b0fe8d">SOFT_STATE</a> &amp;&amp; hst-&gt;current_state==<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>)
<a name="l04118"></a>04118                 hst-&gt;current_attempt=1;
<a name="l04119"></a>04119 
<a name="l04120"></a>04120         <span class="comment">/* increment current attempt number */</span>
<a name="l04121"></a>04121         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(hst-&gt;current_attempt &lt; hst-&gt;<a class="code" href="structhost__struct.html#a091388e27be66d35e87ed643567079c5">max_attempts</a>)
<a name="l04122"></a>04122                 hst-&gt;current_attempt++;
<a name="l04123"></a>04123 
<a name="l04124"></a>04124         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;New check attempt number = %d\n&quot;</span>,hst-&gt;current_attempt);
<a name="l04125"></a>04125 
<a name="l04126"></a>04126         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l04127"></a>04127 }
<a name="l04128"></a>04128 
<a name="l04129"></a>04129 
<a name="l04130"></a>04130 
<a name="l04131"></a>04131 <span class="comment">/* determination of the host&#39;s state based on route availability*/</span>
<a name="l04132"></a>04132 <span class="comment">/* used only to determine difference between DOWN and UNREACHABLE states */</span>
<a name="l04133"></a><a class="code" href="icinga_8h.html#ad55fc4dd3c48837aae3dd1d555d6d277">04133</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#a191896d6b76732d8432d65107faa5954">determine_host_reachability</a>(<a class="code" href="structhost__struct.html">host</a> *hst){
<a name="l04134"></a>04134         <span class="keywordtype">int</span> state=<a class="code" href="icinga_8h.html#a19d20cca11e4cf399742ad25c05d73fb">HOST_DOWN</a>;
<a name="l04135"></a>04135         <a class="code" href="structhost__struct.html">host</a> *parent_host=NULL;
<a name="l04136"></a>04136         <a class="code" href="structhostsmember__struct.html">hostsmember</a> *temp_hostsmember=NULL;
<a name="l04137"></a>04137 
<a name="l04138"></a>04138         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;determine_host_reachability()\n&quot;</span>);
<a name="l04139"></a>04139 
<a name="l04140"></a>04140         <span class="keywordflow">if</span>(hst==NULL)
<a name="l04141"></a>04141                 <span class="keywordflow">return</span> <a class="code" href="icinga_8h.html#a19d20cca11e4cf399742ad25c05d73fb">HOST_DOWN</a>;
<a name="l04142"></a>04142 
<a name="l04143"></a>04143         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Determining state of host &#39;%s&#39;: current state=%d\n&quot;</span>,hst-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>,hst-&gt;current_state);
<a name="l04144"></a>04144 
<a name="l04145"></a>04145         <span class="comment">/* host is UP - no translation needed */</span>
<a name="l04146"></a>04146         <span class="keywordflow">if</span>(hst-&gt;current_state==<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>){
<a name="l04147"></a>04147                 state=<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>;
<a name="l04148"></a>04148                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Host is UP, no state translation needed.\n&quot;</span>);
<a name="l04149"></a>04149         }
<a name="l04150"></a>04150 
<a name="l04151"></a>04151         <span class="comment">/* host has no parents, so it is DOWN */</span>
<a name="l04152"></a>04152         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(hst-&gt;<a class="code" href="structhost__struct.html#aa095184cd77886611768b09f7e4f6822">parent_hosts</a>==NULL){
<a name="l04153"></a>04153                 state=<a class="code" href="icinga_8h.html#a19d20cca11e4cf399742ad25c05d73fb">HOST_DOWN</a>;
<a name="l04154"></a>04154                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Host has no parents, so it is DOWN.\n&quot;</span>);
<a name="l04155"></a>04155         }
<a name="l04156"></a>04156 
<a name="l04157"></a>04157         <span class="comment">/* check all parent hosts to see if we&#39;re DOWN or UNREACHABLE */</span>
<a name="l04158"></a>04158         <span class="keywordflow">else</span>{
<a name="l04159"></a>04159 
<a name="l04160"></a>04160                 <span class="keywordflow">for</span>(temp_hostsmember=hst-&gt;<a class="code" href="structhost__struct.html#aa095184cd77886611768b09f7e4f6822">parent_hosts</a>;temp_hostsmember!=NULL;temp_hostsmember=temp_hostsmember-&gt;<a class="code" href="structhostsmember__struct.html#afdbb9b1473010e32f413d5d8aa57f265">next</a>){
<a name="l04161"></a>04161 
<a name="l04162"></a>04162                         <span class="keywordflow">if</span>((parent_host=temp_hostsmember-&gt;host_ptr)==NULL)
<a name="l04163"></a>04163                                 <span class="keywordflow">continue</span>;
<a name="l04164"></a>04164 
<a name="l04165"></a>04165                         <span class="comment">/* bail out as soon as we find one parent host that is UP */</span>
<a name="l04166"></a>04166                         <span class="keywordflow">if</span>(parent_host-&gt;current_state==<a class="code" href="icinga_8h.html#a38e2a1ffa128bd8c4c48866d120dc4b0">HOST_UP</a>){
<a name="l04167"></a>04167                                 <span class="comment">/* set the current state */</span>
<a name="l04168"></a>04168                                 state=<a class="code" href="icinga_8h.html#a19d20cca11e4cf399742ad25c05d73fb">HOST_DOWN</a>;
<a name="l04169"></a>04169                                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;At least one parent (%s) is up, so host is DOWN.\n&quot;</span>,parent_host-&gt;<a class="code" href="structhost__struct.html#a29629acc48c023596d81b061b5f135f7">name</a>);
<a name="l04170"></a>04170                                 <span class="keywordflow">break</span>;
<a name="l04171"></a>04171                         }
<a name="l04172"></a>04172                 }
<a name="l04173"></a>04173                 <span class="comment">/* no parents were up, so this host is UNREACHABLE */</span>
<a name="l04174"></a>04174                 <span class="keywordflow">if</span>(temp_hostsmember==NULL){
<a name="l04175"></a>04175                         state=<a class="code" href="icinga_8h.html#ab1433105627834e0a2c670250bf64285">HOST_UNREACHABLE</a>;
<a name="l04176"></a>04176                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;No parents were up, so host is UNREACHABLE.\n&quot;</span>);
<a name="l04177"></a>04177                 }
<a name="l04178"></a>04178         }
<a name="l04179"></a>04179 
<a name="l04180"></a>04180         <span class="keywordflow">return</span> state;
<a name="l04181"></a>04181 }
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="checks_8c.html">checks.c</a>      </li>
      <li class="footer">Generated on Tue May 3 2011 22:33:38 for Icinga-core by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


</body>
</html>
