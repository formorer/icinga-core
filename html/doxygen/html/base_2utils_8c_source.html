<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Icinga-core: base/utils.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="icinga_logo4-300x109.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Icinga-core&#160;<span id="projectnumber">1.4.0</span></div>
   <div id="projectbrief">next gen monitoring</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('base_2utils_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">base/utils.c</div>  </div>
</div>
<div class="contents">
<a href="base_2utils_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*****************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> *</span>
<a name="l00003"></a>00003 <span class="comment"> * UTILS.C - Miscellaneous utility functions for Icinga</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * Copyright (c) 1999-2009 Ethan Galstad (egalstad@nagios.org)</span>
<a name="l00006"></a>00006 <span class="comment"> * Copyright (c) 2009-2011 Nagios Core Development Team and Community Contributors</span>
<a name="l00007"></a>00007 <span class="comment"> * Copyright (c) 2009-2011 Icinga Development Team (http://www.icinga.org)</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * License:</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00012"></a>00012 <span class="comment"> * it under the terms of the GNU General Public License version 2 as</span>
<a name="l00013"></a>00013 <span class="comment"> * published by the Free Software Foundation.</span>
<a name="l00014"></a>00014 <span class="comment"> *</span>
<a name="l00015"></a>00015 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00016"></a>00016 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00017"></a>00017 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00018"></a>00018 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00021"></a>00021 <span class="comment"> * along with this program; if not, write to the Free Software</span>
<a name="l00022"></a>00022 <span class="comment"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> *****************************************************************************/</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;../include/config.h&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;../include/common.h&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;../include/objects.h&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;../include/statusdata.h&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;../include/comments.h&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;../include/macros.h&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;../include/icinga.h&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;../include/netutils.h&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;../include/broker.h&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;../include/nebmods.h&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;../include/nebmodules.h&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="preprocessor">#ifdef EMBEDDEDPERL</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span><span class="preprocessor">#include &quot;../include/epn_icinga.h&quot;</span>
<a name="l00041"></a>00041 <span class="keyword">static</span> PerlInterpreter *my_perl=NULL;
<a name="l00042"></a>00042 <span class="keywordtype">int</span> use_embedded_perl=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00043"></a>00043 <span class="preprocessor">#endif</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span>
<a name="l00045"></a>00045 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="commands_8c.html#ac269be8b91ae4b24df48de5d8ad7e7a7">config_file</a>;
<a name="l00046"></a>00046 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="commands_8c.html#abb31cd37c986dc4fd87305ea83516af1">log_file</a>;
<a name="l00047"></a>00047 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="commands_8c.html#ad6bb81fae52e357701eadd493eca7902">command_file</a>;
<a name="l00048"></a>00048 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="checks_8c.html#af9f03269d81f06c6a86926e77620eed4">temp_file</a>;
<a name="l00049"></a>00049 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="checks_8c.html#ac633a7a52422f2b1d56ed02a56dc8fcf">temp_path</a>;
<a name="l00050"></a>00050 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="checks_8c.html#a3964b0cff6f7740b1f35a62ba0ef0d6a">check_result_path</a>;
<a name="l00051"></a><a class="code" href="base_2utils_8c.html#a6ea49ef51dfed805fe76cc2e9d373b99">00051</a> <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="checks_8c.html#a3964b0cff6f7740b1f35a62ba0ef0d6a">check_result_path</a>;
<a name="l00052"></a>00052 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="base_2config_8c.html#a55d7cb41b1bacf3965ecc3592b0502fa">lock_file</a>;
<a name="l00053"></a>00053 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="base_2config_8c.html#a0cc0c09d24937cc9202b164b490bc8ef">log_archive_path</a>;
<a name="l00054"></a>00054 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="base_2config_8c.html#a586e23a923f9be00036075adc1134a3a">auth_file</a>;
<a name="l00055"></a>00055 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="base_2config_8c.html#a86d006b27636dbe3bc7a35c71883f7c4">p1_file</a>;
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="base_2config_8c.html#a05cfb9b76ef2434c8e0ccf88207999a6">nagios_user</a>;
<a name="l00058"></a>00058 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="base_2config_8c.html#a18f68ce260b08820f7b519437e84beb4">nagios_group</a>;
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="base_2utils_8c.html#a88a9afc019dc991f3ddfa0891614af7c">macro_x_names</a>[<a class="code" href="macros_8h.html#a48c68655aa149c66fe5abf675d9f138a">MACRO_X_COUNT</a>];
<a name="l00061"></a>00061 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="base_2config_8c.html#afee7e99fdb2e7b9024ed9385e2d1278e">macro_user</a>[<a class="code" href="macros_8h.html#ab0c1d0ff8b27c7911f500427825ccdfd">MAX_USER_MACROS</a>];
<a name="l00062"></a>00062 <span class="keyword">extern</span> <a class="code" href="structcustomvariablesmember__struct.html">customvariablesmember</a> *<a class="code" href="base_2utils_8c.html#a8533f324b353ce873d5395ad8c7d69af">macro_custom_host_vars</a>;
<a name="l00063"></a>00063 <span class="keyword">extern</span> <a class="code" href="structcustomvariablesmember__struct.html">customvariablesmember</a> *<a class="code" href="base_2utils_8c.html#a39e7e19e1eb1bac0985760b8429f1954">macro_custom_service_vars</a>;
<a name="l00064"></a>00064 <span class="keyword">extern</span> <a class="code" href="structcustomvariablesmember__struct.html">customvariablesmember</a> *<a class="code" href="base_2utils_8c.html#aa7f33d3497060296ac17d8fe5fd4f3b7">macro_custom_contact_vars</a>;
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="keyword">extern</span> <a class="code" href="structhost__struct.html">host</a>         *<a class="code" href="base_2utils_8c.html#ae47d0d9fa7e6ba6b7f6a8ce362569ba8">macro_host_ptr</a>;
<a name="l00067"></a>00067 <span class="keyword">extern</span> <a class="code" href="structhostgroup__struct.html">hostgroup</a>    *<a class="code" href="base_2utils_8c.html#a4130f516e135071f5b5d5239873c356c">macro_hostgroup_ptr</a>;
<a name="l00068"></a>00068 <span class="keyword">extern</span> <a class="code" href="structservice__struct.html">service</a>      *<a class="code" href="base_2utils_8c.html#a0f161ba9cba9a872e3f5980e35e0d1e3">macro_service_ptr</a>;
<a name="l00069"></a>00069 <span class="keyword">extern</span> <a class="code" href="structservicegroup__struct.html">servicegroup</a> *<a class="code" href="base_2utils_8c.html#ada67d73713f7c84d6cc23e215048012f">macro_servicegroup_ptr</a>;
<a name="l00070"></a>00070 <span class="keyword">extern</span> <a class="code" href="structcontact__struct.html">contact</a>      *<a class="code" href="base_2utils_8c.html#a2e05507891e7732998ede15e1df2a7a3">macro_contact_ptr</a>;
<a name="l00071"></a>00071 <span class="keyword">extern</span> <a class="code" href="structcontactgroup__struct.html">contactgroup</a> *<a class="code" href="base_2utils_8c.html#a6e9c3f10be60737804a9c1c9742039b3">macro_contactgroup_ptr</a>;
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="broker_8c.html#a2cd88e2da654d6d1d2c52e79d0174109">global_host_event_handler</a>;
<a name="l00074"></a>00074 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="broker_8c.html#a0073f89db72fa9c3474b5a1327382784">global_service_event_handler</a>;
<a name="l00075"></a>00075 <span class="keyword">extern</span> <a class="code" href="structcommand__struct.html">command</a>  *<a class="code" href="commands_8c.html#a446a1015872b0b803359e329127d67dc">global_host_event_handler_ptr</a>;
<a name="l00076"></a>00076 <span class="keyword">extern</span> <a class="code" href="structcommand__struct.html">command</a>  *<a class="code" href="commands_8c.html#abb28c580288a78deb5c4202eb7c7e0ad">global_service_event_handler_ptr</a>;
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="base_2config_8c.html#a00f19e2546f0f60b11d12685571c3184">ocsp_command</a>;
<a name="l00079"></a>00079 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="base_2config_8c.html#a2941a8b9d15b20828dbc065543e6854a">ochp_command</a>;
<a name="l00080"></a>00080 <span class="keyword">extern</span> <a class="code" href="structcommand__struct.html">command</a>  *<a class="code" href="base_2config_8c.html#a2e848e6ea39d099b0caa753e35b10ab5">ocsp_command_ptr</a>;
<a name="l00081"></a>00081 <span class="keyword">extern</span> <a class="code" href="structcommand__struct.html">command</a>  *<a class="code" href="base_2config_8c.html#a7a3b275f9c15bbf3a95f0934d39423c6">ochp_command_ptr</a>;
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="base_2config_8c.html#a21ee8da3605317fd63a1b2dca3f3fd22">illegal_object_chars</a>;
<a name="l00084"></a>00084 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="base_2config_8c.html#a3ed671a447fc4befbc9264eec6a929bf">illegal_output_chars</a>;
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#acd4edfa8f0c276d1b2913c64811d43b3">use_regexp_matches</a>;
<a name="l00087"></a>00087 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a079c14ca692b31d9a5144cdde9135cff">use_true_regexp_matching</a>;
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a2b5f7762caad7a548645f2d9c4cdee47">sigshutdown</a>;
<a name="l00090"></a>00090 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#aadf2eea990498582cc7dac355c3d7e71">sigrestart</a>;
<a name="l00091"></a>00091 <span class="keyword">extern</span> <span class="keywordtype">char</span>     *<a class="code" href="icinga_8c.html#a8b84b2f08d8a7a6a7f1e6dff51b4b7f0">sigs</a>[35];
<a name="l00092"></a>00092 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="icinga_8c.html#aca9bbdce369ba2a9376650249a4d57a3">caught_signal</a>;
<a name="l00093"></a>00093 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="icinga_8c.html#a502e2f89c462dc55db74ad66cecd89ba">sig_id</a>;
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="broker_8c.html#a4255d3efd1474d8e9d267e4b1559c1f9">daemon_mode</a>;
<a name="l00096"></a>00096 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#ae99471075b1351740cb0aa515527e59f">daemon_dumps_core</a>;
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="broker_8c.html#ad99d124d1c85c3b69de36466353f295e">nagios_pid</a>;
<a name="l00099"></a>00099 
<a name="l00100"></a>00100 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a39fad10c86b64c04422ec7edec0c100d">use_daemon_log</a>;
<a name="l00101"></a>00101 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#ac41cf9c7984d80be911c60382a68cc7f">use_syslog</a>;
<a name="l00102"></a>00102 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#ab88ce77c4fc0820877f3391c14255cf4">use_syslog_local_facility</a>;
<a name="l00103"></a>00103 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a2da308fe577e0436d8bb3244d7ab3554">syslog_local_facility</a>;
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a721e6c51d8206e96123fe584be655b10">log_notifications</a>;
<a name="l00106"></a>00106 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a8c026debf41f215571837376d674b64e">log_service_retries</a>;
<a name="l00107"></a>00107 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a3d94f59d8f5b223150321cc970e4ee95">log_host_retries</a>;
<a name="l00108"></a>00108 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a259fec0a0e05601985b40c88ecf1da1c">log_event_handlers</a>;
<a name="l00109"></a>00109 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="commands_8c.html#a4fd5c348c6bd19b33d05d97d921e8f44">log_external_commands</a>;
<a name="l00110"></a>00110 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="commands_8c.html#ad0b68c2d5394aea2ad23c94641936dc1">log_external_commands_user</a>;
<a name="l00111"></a>00111 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a5e7d59bfd5de9be3ca0ab421999029ef">log_passive_checks</a>;
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>      <a class="code" href="icinga_8c.html#a9abdd763db679f200dcefbfbd3d38dbf">logging_options</a>;
<a name="l00114"></a>00114 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>      <a class="code" href="icinga_8c.html#aba97413828a24299cdaebd42dc6a60bb">syslog_options</a>;
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#aae037924192ae115d84c3aa5c42502db">service_check_timeout</a>;
<a name="l00117"></a>00117 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#ab754e7bcef1c0ed0f0334cdf12178b6b">service_check_timeout_state</a>;
<a name="l00118"></a>00118 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a57a8709265e39d9953db6dd65bfc0796">host_check_timeout</a>;
<a name="l00119"></a>00119 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#acf7e0ac7c504daebb951029d2595dfc3">event_handler_timeout</a>;
<a name="l00120"></a>00120 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#ae8619a981efc4b705bce98f0b6eccd54">notification_timeout</a>;
<a name="l00121"></a>00121 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a6637dcc9d4238294cbb0cc87702ffee8">ocsp_timeout</a>;
<a name="l00122"></a>00122 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#ad8fd89e4c976ac03482bb7133b71a030">ochp_timeout</a>;
<a name="l00123"></a>00123 
<a name="l00124"></a>00124 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a978adb7bd99819db24cb71610e211201">log_initial_states</a>;
<a name="l00125"></a>00125 
<a name="l00126"></a>00126 <span class="keyword">extern</span> <span class="keywordtype">double</span>   <a class="code" href="base_2config_8c.html#a922b1acd3bbab55cc1a1fba869a52cf3">sleep_time</a>;
<a name="l00127"></a>00127 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>;
<a name="l00128"></a>00128 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#acd946f8db9b1c8bb876f807958a67158">service_inter_check_delay_method</a>;
<a name="l00129"></a>00129 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a4a5e0c1bc20f9b50c89e9a45a6b7dd32">host_inter_check_delay_method</a>;
<a name="l00130"></a>00130 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#ae51089c18962e9d01b6d86beb51d3a86">service_interleave_factor_method</a>;
<a name="l00131"></a>00131 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a6c91e39bfb52d983e8a77a70698f147e">max_host_check_spread</a>;
<a name="l00132"></a>00132 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a13c7e7d13d812c96e312c5f7ee893a66">max_service_check_spread</a>;
<a name="l00133"></a>00133 
<a name="l00134"></a>00134 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a7efed83b6f6698f73e4ede444065917c">command_check_interval</a>;
<a name="l00135"></a>00135 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#af5316c1b7ca4d4261fb4edc45cafcca2">check_reaper_interval</a>;
<a name="l00136"></a>00136 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#aec4c41d4a0f2abb5ccb88695fa1a7afd">max_check_reaper_time</a>;
<a name="l00137"></a>00137 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#abab6f0cb75ffb3f8314a91eb45daff73">service_freshness_check_interval</a>;
<a name="l00138"></a>00138 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#ad3e63ef3ddf9da6b5129e4af48050e57">host_freshness_check_interval</a>;
<a name="l00139"></a>00139 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a44cbf83f13ce339bea20c45e1b6ddef4">auto_rescheduling_interval</a>;
<a name="l00140"></a>00140 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a7faf812fb9197efcc5f55b028269fc15">auto_rescheduling_window</a>;
<a name="l00141"></a>00141 
<a name="l00142"></a>00142 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="commands_8c.html#abf64fe29cddb0d890bbece7d4d970c18">check_external_commands</a>;
<a name="l00143"></a>00143 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a3e061975c062d8fa45e1da8f605b1f1b">check_orphaned_services</a>;
<a name="l00144"></a>00144 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a168ff4c02e76f18767e941ecc2d3279c">check_orphaned_hosts</a>;
<a name="l00145"></a>00145 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a2361e9b42a0ea220db317dff75dc9dc0">check_service_freshness</a>;
<a name="l00146"></a>00146 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a4f92c0b0b8d9f56191bcdf5dc5a706b2">check_host_freshness</a>;
<a name="l00147"></a>00147 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a92449527b62f5217e54424e9180a90d2">auto_reschedule_checks</a>;
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#ab5dcf3b2f001760548fd0d0fab5c2cd7">additional_freshness_latency</a>;
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a8f8fcb1a4bb32b1c5fa753ac9cb48578">use_aggressive_host_checking</a>;
<a name="l00152"></a>00152 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="checks_8c.html#a55fd26f1da3fea26b41e92a035472ea2">cached_host_check_horizon</a>;
<a name="l00153"></a>00153 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="checks_8c.html#a63020ec01859a9c631414e69dd951b5d">cached_service_check_horizon</a>;
<a name="l00154"></a>00154 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#ad658f0152df44d67fd5fe012fc1faf3f">enable_predictive_host_dependency_checks</a>;
<a name="l00155"></a>00155 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#afb630146760296e213a019a7f14f48f3">enable_predictive_service_dependency_checks</a>;
<a name="l00156"></a>00156 
<a name="l00157"></a>00157 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a7c9ecd6259817de56ca91f1adaaea842">soft_state_dependencies</a>;
<a name="l00158"></a>00158 
<a name="l00159"></a>00159 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a66929a60ac22bcaaa279ded5c2c6eb9a">retain_state_information</a>;
<a name="l00160"></a>00160 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a1043c5f5292784386c9aab188c743c5a">retention_update_interval</a>;
<a name="l00161"></a>00161 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#aced0c5bbed1bb4b772f105b4f2988bb6">use_retained_program_state</a>;
<a name="l00162"></a>00162 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a1eaa6a870e346de62067378dc1d6137d">use_retained_scheduling_info</a>;
<a name="l00163"></a>00163 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a2a4d71e3630882927484ec3b5c060729">retention_scheduling_horizon</a>;
<a name="l00164"></a>00164 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="broker_8c.html#a786e354f5a91ca30fe28ede97505e181">modified_host_process_attributes</a>;
<a name="l00165"></a>00165 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="broker_8c.html#aa128280b704d982e64c50a9427cf5f71">modified_service_process_attributes</a>;
<a name="l00166"></a>00166 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="base_2config_8c.html#a899e484813a8be290aa2f240a1209748">retained_host_attribute_mask</a>;
<a name="l00167"></a>00167 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="base_2config_8c.html#a226294b0bafb951e4895f0e030ea92b4">retained_service_attribute_mask</a>;
<a name="l00168"></a>00168 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="base_2config_8c.html#a99d719730540007a974ab1aaa84074b4">retained_contact_host_attribute_mask</a>;
<a name="l00169"></a>00169 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="base_2config_8c.html#ab7d4cf16bedd8d688e2a49d99364fbb8">retained_contact_service_attribute_mask</a>;
<a name="l00170"></a>00170 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="base_2config_8c.html#a9cf78112bcff73f4ac5913a2a6a2fee4">retained_process_host_attribute_mask</a>;
<a name="l00171"></a>00171 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="base_2config_8c.html#a3942846d40cc9545a1d0f042733e0943">retained_process_service_attribute_mask</a>;
<a name="l00172"></a>00172 
<a name="l00173"></a>00173 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="icinga_8c.html#a7c6764a5ab4c86e19f5c6727b9ee974d">next_comment_id</a>;
<a name="l00174"></a>00174 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="icinga_8c.html#ac1079538ca861064140e0c8daa032ace">next_downtime_id</a>;
<a name="l00175"></a>00175 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="checks_8c.html#a75ecfdc2a9af9431daf6d862bc9ab9cc">next_event_id</a>;
<a name="l00176"></a>00176 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="icinga_8c.html#a220de5d08cd9e05a26be2549fce2a638">next_notification_id</a>;
<a name="l00177"></a>00177 
<a name="l00178"></a>00178 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#ab994c46c876a9f9f338e28c170dd3e4e">log_rotation_method</a>;
<a name="l00179"></a>00179 
<a name="l00180"></a>00180 <span class="keyword">extern</span> time_t   <a class="code" href="broker_8c.html#a2b5a4f2875a1a545f44ac2faad7a6b67">program_start</a>;
<a name="l00181"></a>00181 
<a name="l00182"></a>00182 <span class="keyword">extern</span> time_t   <a class="code" href="broker_8c.html#aeb85ffd1c5c7f91fe9ccb3e4f58584a2">last_command_check</a>;
<a name="l00183"></a>00183 <span class="keyword">extern</span> time_t   <a class="code" href="commands_8c.html#a3345a3ba93555dc1bd4405d8a9db19e8">last_command_status_update</a>;
<a name="l00184"></a>00184 <span class="keyword">extern</span> time_t   <a class="code" href="broker_8c.html#aa087a80bdb1191f94e86f0a83d5c2eed">last_log_rotation</a>;
<a name="l00185"></a>00185 
<a name="l00186"></a>00186 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a041664757d19a243c37d44f2a7f5b833">verify_config</a>;
<a name="l00187"></a>00187 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a9c463c3c30ed1c48affd9a99a07c6302">test_scheduling</a>;
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 <span class="keyword">extern</span> <a class="code" href="structcheck__result__struct.html">check_result</a> <a class="code" href="checks_8c.html#a3c4ba85a60252149f09be4923bc98b4a">check_result_info</a>;
<a name="l00190"></a>00190 
<a name="l00191"></a>00191 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a46b9282388870ec482000ee3834f847d">max_parallel_service_checks</a>;
<a name="l00192"></a>00192 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a01f1a65871aff67ece2c26f543691083">currently_running_service_checks</a>;
<a name="l00193"></a>00193 
<a name="l00194"></a>00194 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="broker_8c.html#aeab76c66fa95f6b3a22143bade01cbe9">enable_notifications</a>;
<a name="l00195"></a>00195 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="broker_8c.html#ab7c771c65ac24bc0d04ddae988128f8a">execute_service_checks</a>;
<a name="l00196"></a>00196 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="broker_8c.html#ac2cfe61062d4e6db6236a829ee16864a">accept_passive_service_checks</a>;
<a name="l00197"></a>00197 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="broker_8c.html#af4ed1772a5decb43a2711b6d560a0737">execute_host_checks</a>;
<a name="l00198"></a>00198 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="broker_8c.html#a1f08a9399cbf8d1781f7921cb39ad461">accept_passive_host_checks</a>;
<a name="l00199"></a>00199 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="broker_8c.html#adf8bd6fb1b3fc3cf7750d887773feace">enable_event_handlers</a>;
<a name="l00200"></a>00200 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="broker_8c.html#a03e994eebc8f1e065991e7f8994a7059">obsess_over_services</a>;
<a name="l00201"></a>00201 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="broker_8c.html#a879982dc6cb9e3e1e23c49eba4f7bc12">obsess_over_hosts</a>;
<a name="l00202"></a>00202 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="broker_8c.html#ad9af8e808ce1df2c763d260502b58e4c">enable_failure_prediction</a>;
<a name="l00203"></a>00203 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="broker_8c.html#a3cef48503f834db51896cd2262c4ddbd">process_performance_data</a>;
<a name="l00204"></a>00204 
<a name="l00205"></a>00205 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#aeef0f20f58de2ac8a2db469fdc767b6f">translate_passive_host_checks</a>;
<a name="l00206"></a>00206 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a90011bddac350082a4ab3b13758afcbe">passive_host_checks_are_soft</a>;
<a name="l00207"></a>00207 
<a name="l00208"></a>00208 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="broker_8c.html#a9586ccf6845ee26a92ae931feb52a467">aggregate_status_updates</a>;
<a name="l00209"></a>00209 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a0bf1c35db9cc1c250c958f12db3373b8">status_update_interval</a>;
<a name="l00210"></a>00210 
<a name="l00211"></a>00211 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a4dbfc5ebd719a4bca93b043f39a5750a">time_change_threshold</a>;
<a name="l00212"></a>00212 
<a name="l00213"></a>00213 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="broker_8c.html#a6dd9e21f0c5cd86be9c0bb8575387430">event_broker_options</a>;
<a name="l00214"></a>00214 
<a name="l00215"></a><a class="code" href="base_2utils_8c.html#a3cef48503f834db51896cd2262c4ddbd">00215</a> <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="broker_8c.html#a3cef48503f834db51896cd2262c4ddbd">process_performance_data</a>;
<a name="l00216"></a>00216 
<a name="l00217"></a>00217 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="broker_8c.html#a2dff02e57dcb9656ac523b8f6d548ee4">enable_flap_detection</a>;
<a name="l00218"></a>00218 
<a name="l00219"></a>00219 <span class="keyword">extern</span> <span class="keywordtype">double</span>   <a class="code" href="base_2config_8c.html#a14a94d5f46c0a28d726d9413a26fca28">low_service_flap_threshold</a>;
<a name="l00220"></a>00220 <span class="keyword">extern</span> <span class="keywordtype">double</span>   <a class="code" href="base_2config_8c.html#aaff51075d28f9df1c11fbc396b947652">high_service_flap_threshold</a>;
<a name="l00221"></a>00221 <span class="keyword">extern</span> <span class="keywordtype">double</span>   <a class="code" href="base_2config_8c.html#aa9db7a3c64eac4aac4f7631a0472c63c">low_host_flap_threshold</a>;
<a name="l00222"></a>00222 <span class="keyword">extern</span> <span class="keywordtype">double</span>   <a class="code" href="base_2config_8c.html#a1d9ea93bade3c2b490b2270823eec560">high_host_flap_threshold</a>;
<a name="l00223"></a>00223 
<a name="l00224"></a>00224 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#af7ebc1e3e652fbcaed250840df2ccba2">use_large_installation_tweaks</a>;
<a name="l00225"></a>00225 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a11317c78b1d2431ae9b6ac57a40e3095">enable_environment_macros</a>;
<a name="l00226"></a>00226 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a73881c51ba02b6ea241ab71a8e2c354c">free_child_process_memory</a>;
<a name="l00227"></a>00227 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a2976ddc6ad4325c074912d0f61bb0184">child_processes_fork_twice</a>;
<a name="l00228"></a>00228 
<a name="l00229"></a>00229 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a46fa3066353e093f0726ffb3cf9dd151">enable_embedded_perl</a>;
<a name="l00230"></a>00230 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a422c10fc8a317232590a568d58e0562e">use_embedded_perl_implicitly</a>;
<a name="l00231"></a>00231 
<a name="l00232"></a>00232 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#ae96ccc43c200c07e833891d2b6ca8bba">stalking_event_handlers_for_hosts</a>;
<a name="l00233"></a>00233 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="checks_8c.html#a4113366f27b640f3e76ecef1b7ba9809">stalking_event_handlers_for_services</a>;
<a name="l00234"></a>00234 
<a name="l00235"></a>00235 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="base_2config_8c.html#a724a2263d444550e456b32059ab08c00">date_format</a>;
<a name="l00236"></a>00236 
<a name="l00237"></a>00237 <span class="keyword">extern</span> <a class="code" href="structcontact__struct.html">contact</a>          *<a class="code" href="base_2config_8c.html#af6cb44967a671bbb9e6c0dcd57f75259">contact_list</a>;
<a name="l00238"></a>00238 <span class="keyword">extern</span> <a class="code" href="structcontactgroup__struct.html">contactgroup</a>     *<a class="code" href="base_2config_8c.html#aedbc4ad6955f964b3dbff1bbf5fb309d">contactgroup_list</a>;
<a name="l00239"></a>00239 <span class="keyword">extern</span> <a class="code" href="structhost__struct.html">host</a>             *<a class="code" href="checks_8c.html#a7efb54fbdc5a556ffdbe25c56e6e7469">host_list</a>;
<a name="l00240"></a>00240 <span class="keyword">extern</span> <a class="code" href="structhostgroup__struct.html">hostgroup</a>        *<a class="code" href="base_2config_8c.html#a4a15afed3efea74c99e450dc19fc9f5d">hostgroup_list</a>;
<a name="l00241"></a>00241 <span class="keyword">extern</span> <a class="code" href="structservice__struct.html">service</a>          *<a class="code" href="checks_8c.html#aa680c491c2d6c99868a3789592868c15">service_list</a>;
<a name="l00242"></a>00242 <span class="keyword">extern</span> <a class="code" href="structservicegroup__struct.html">servicegroup</a>     *<a class="code" href="base_2config_8c.html#a77e50a8587b7b8e1ca12d99a05af684e">servicegroup_list</a>;
<a name="l00243"></a>00243 <span class="keyword">extern</span> <a class="code" href="structtimed__event__struct.html">timed_event</a>      *<a class="code" href="events_8c.html#aa5e8cad8fba97edbd96b5464e32cc752">event_list_high</a>;
<a name="l00244"></a>00244 <span class="keyword">extern</span> <a class="code" href="structtimed__event__struct.html">timed_event</a>      *<a class="code" href="checks_8c.html#a5fc3341e76625e95ab611a9f9237b839">event_list_low</a>;
<a name="l00245"></a>00245 <span class="keyword">extern</span> <a class="code" href="structnotify__list__struct.html">notification</a>     *<a class="code" href="base_2config_8c.html#a78c463e6f4c8735520d6819b2aa21a5b">notification_list</a>;
<a name="l00246"></a>00246 <span class="keyword">extern</span> <a class="code" href="structcommand__struct.html">command</a>          *<a class="code" href="base_2config_8c.html#a9a492850fa6692dc161ac48fff09e2b5">command_list</a>;
<a name="l00247"></a>00247 <span class="keyword">extern</span> <a class="code" href="structtimeperiod__struct.html">timeperiod</a>       *<a class="code" href="base_2config_8c.html#ae2e0edcdc460ca51c836c07df857f85e">timeperiod_list</a>;
<a name="l00248"></a>00248 
<a name="l00249"></a>00249 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="commands_8c.html#a8d1be59b1a087eaeb87f6e4774cb499a">command_file_fd</a>;
<a name="l00250"></a>00250 <span class="keyword">extern</span> FILE     *<a class="code" href="commands_8c.html#a67e68b43d7661b866f04f4609dd1decf">command_file_fp</a>;
<a name="l00251"></a>00251 <span class="keyword">extern</span> <span class="keywordtype">int</span>      <a class="code" href="icinga_8c.html#a3416bf570587e753da5b8da11d1f8f5c">command_file_created</a>;
<a name="l00252"></a>00252 
<a name="l00253"></a>00253 <span class="preprocessor">#ifdef HAVE_TZNAME</span>
<a name="l00254"></a>00254 <span class="preprocessor"></span><span class="preprocessor">#ifdef CYGWIN</span>
<a name="l00255"></a>00255 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="keywordtype">char</span>     *_tzname[2] __declspec(dllimport);
<a name="l00256"></a>00256 <span class="preprocessor">#else</span>
<a name="l00257"></a>00257 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="keywordtype">char</span>     *tzname[2];
<a name="l00258"></a>00258 <span class="preprocessor">#endif</span>
<a name="l00259"></a>00259 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00260"></a>00260 <span class="preprocessor"></span>
<a name="l00261"></a>00261 <span class="keyword">extern</span> <a class="code" href="structcheck__result__struct.html">check_result</a>    *<a class="code" href="checks_8c.html#a9a65c5bcf2a37699d3438209379f79c2">check_result_list</a>;
<a name="l00262"></a>00262 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   <a class="code" href="base_2config_8c.html#a339144b840e81ab177c4c80178da7470">max_check_result_file_age</a>;
<a name="l00263"></a>00263 
<a name="l00264"></a>00264 <span class="keyword">extern</span> <a class="code" href="structdbuf__struct.html">dbuf</a>            <a class="code" href="icinga_8c.html#a196b79fb855aaef5e5af1817202ab24f">check_result_dbuf</a>;
<a name="l00265"></a>00265 
<a name="l00266"></a>00266 <span class="keyword">extern</span> pthread_t       <a class="code" href="checks_8c.html#a5c1a9b9ccaf872452bec541a26ab586b">worker_threads</a>[<a class="code" href="icinga_8h.html#a39f497fe500265af5f37b35c16224047">TOTAL_WORKER_THREADS</a>];
<a name="l00267"></a>00267 <span class="keyword">extern</span> <a class="code" href="structcircular__buffer__struct.html">circular_buffer</a> <a class="code" href="commands_8c.html#ac0c5df0ac52923268176eddeb6b179e3">external_command_buffer</a>;
<a name="l00268"></a>00268 <span class="keyword">extern</span> <a class="code" href="structcircular__buffer__struct.html">circular_buffer</a> <a class="code" href="icinga_8c.html#a4c93e00636e0a69527e56420e284d416">check_result_buffer</a>;
<a name="l00269"></a>00269 <span class="keyword">extern</span> <a class="code" href="structcircular__buffer__struct.html">circular_buffer</a> <a class="code" href="base_2utils_8c.html#a31e5909a2f4f215e9f17089750ee4321">event_broker_buffer</a>;
<a name="l00270"></a>00270 <span class="keyword">extern</span> <span class="keywordtype">int</span>             <a class="code" href="commands_8c.html#aa9e89558ebe0496997935aca44cc0123">external_command_buffer_slots</a>;
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 <span class="keyword">extern</span> <a class="code" href="structcheck__stats__struct.html">check_stats</a>     <a class="code" href="icinga_8c.html#a2b9afeefba56c9290ac7cbbecc923639">check_statistics</a>[<a class="code" href="include_2common_8h.html#aa7a5f37f784624687d6766812bc99b2e">MAX_CHECK_STATS_TYPES</a>];
<a name="l00273"></a>00273 
<a name="l00274"></a>00274 <span class="keyword">extern</span> <span class="keywordtype">char</span>            *<a class="code" href="base_2config_8c.html#a4dd633413e09f17ee505abe8699254da">debug_file</a>;
<a name="l00275"></a>00275 <span class="keyword">extern</span> <span class="keywordtype">int</span>             <a class="code" href="base_2config_8c.html#a6a7850ecbb72e1e42b73aefa00562183">debug_level</a>;
<a name="l00276"></a>00276 <span class="keyword">extern</span> <span class="keywordtype">int</span>             <a class="code" href="base_2config_8c.html#a34a87268f6423660b89263430f5f776c">debug_verbosity</a>;
<a name="l00277"></a>00277 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   <a class="code" href="checks_8c.html#ac919486c0bf77cab5e1ec2f0aba1803f">max_debug_file_size</a>;
<a name="l00278"></a>00278 
<a name="l00279"></a>00279 <span class="comment">/* from GNU defines errno as a macro, since it&#39;s a per-thread variable */</span>
<a name="l00280"></a>00280 <span class="preprocessor">#ifndef errno</span>
<a name="l00281"></a>00281 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>;
<a name="l00282"></a>00282 <span class="preprocessor">#endif</span>
<a name="l00283"></a>00283 <span class="preprocessor"></span>
<a name="l00284"></a><a class="code" href="base_2utils_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">00284</a> <span class="keywordtype">int</span> <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>;      <span class="comment">/* reduce compiler warnings */</span>
<a name="l00285"></a>00285 
<a name="l00286"></a>00286 <span class="comment">/******************************************************************/</span>
<a name="l00287"></a>00287 <span class="comment">/******************** SYSTEM COMMAND FUNCTIONS ********************/</span>
<a name="l00288"></a>00288 <span class="comment">/******************************************************************/</span>
<a name="l00289"></a>00289 
<a name="l00290"></a>00290 
<a name="l00291"></a>00291 <span class="comment">/* executes a system command - used for notifications, event handlers, etc. */</span>
<a name="l00292"></a><a class="code" href="icinga_8h.html#a4c50624ad2b555a0dd8cd48e18c7991d">00292</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#aaec741bbcbb039485348567cc5f2ce2c">my_system_r</a>(<a class="code" href="structicinga__macros.html">icinga_macros</a> *mac, <span class="keywordtype">char</span> *cmd,<span class="keywordtype">int</span> timeout,<span class="keywordtype">int</span> *early_timeout,<span class="keywordtype">double</span> *exectime,<span class="keywordtype">char</span> **output,<span class="keywordtype">int</span> max_output_length){
<a name="l00293"></a>00293         pid_t pid=0;
<a name="l00294"></a>00294         <span class="keywordtype">int</span> status=0;
<a name="l00295"></a>00295         <span class="keywordtype">int</span> result=0;
<a name="l00296"></a>00296         <span class="keywordtype">char</span> buffer[<a class="code" href="include_2common_8h.html#a23c82337fe6c21111837512469ea40af">MAX_INPUT_BUFFER</a>]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l00297"></a>00297         <span class="keywordtype">char</span> *temp_buffer=NULL;
<a name="l00298"></a>00298         <span class="keywordtype">int</span> fd[2];
<a name="l00299"></a>00299         FILE *fp=NULL;
<a name="l00300"></a>00300         <span class="keywordtype">int</span> bytes_read=0;
<a name="l00301"></a>00301         <span class="keyword">struct </span>timeval start_time,end_time;
<a name="l00302"></a>00302         <a class="code" href="structdbuf__struct.html">dbuf</a> output_dbuf;
<a name="l00303"></a>00303         <span class="keywordtype">int</span> dbuf_chunk=1024;
<a name="l00304"></a>00304         <span class="keywordtype">int</span> flags;
<a name="l00305"></a>00305 <span class="preprocessor">#ifdef EMBEDDEDPERL</span>
<a name="l00306"></a>00306 <span class="preprocessor"></span>        <span class="keywordtype">char</span> fname[512]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l00307"></a>00307         <span class="keywordtype">char</span> *args[5]={<span class="stringliteral">&quot;&quot;</span>,<a class="code" href="new__mini__epn_8c.html#ab31155ed74e967f1594a68acbc1cab7d">DO_CLEAN</a>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, NULL };
<a name="l00308"></a>00308         SV *plugin_hndlr_cr=NULL; <span class="comment">/* perl.h holds typedef struct */</span>
<a name="l00309"></a>00309         <span class="keywordtype">char</span> *perl_output=NULL;
<a name="l00310"></a>00310         <span class="keywordtype">int</span> count;
<a name="l00311"></a>00311         <span class="keywordtype">int</span> use_epn=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00312"></a>00312 <span class="preprocessor">#ifdef aTHX</span>
<a name="l00313"></a>00313 <span class="preprocessor"></span>        dTHX;
<a name="l00314"></a>00314 <span class="preprocessor">#endif</span>
<a name="l00315"></a>00315 <span class="preprocessor"></span>        dSP;
<a name="l00316"></a>00316 <span class="preprocessor">#endif</span>
<a name="l00317"></a>00317 <span class="preprocessor"></span>
<a name="l00318"></a>00318 
<a name="l00319"></a>00319         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;my_system_r()\n&quot;</span>);
<a name="l00320"></a>00320 
<a name="l00321"></a>00321         <span class="comment">/* initialize return variables */</span>
<a name="l00322"></a>00322         <span class="keywordflow">if</span>(output!=NULL)
<a name="l00323"></a>00323                 *output=NULL;
<a name="l00324"></a>00324         *early_timeout=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00325"></a>00325         *exectime=0.0;
<a name="l00326"></a>00326 
<a name="l00327"></a>00327         <span class="comment">/* if no command was passed, return with no error */</span>
<a name="l00328"></a>00328         <span class="keywordflow">if</span>(cmd==NULL)
<a name="l00329"></a>00329                 <span class="keywordflow">return</span> <a class="code" href="cgiutils_8h.html#a35937514c20ebac19d6598f04416db7e">STATE_OK</a>;
<a name="l00330"></a>00330 
<a name="l00331"></a>00331         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#acb53d17d520c3d4c373eeb03cb929123">DEBUGL_COMMANDS</a>,1,<span class="stringliteral">&quot;Running command &#39;%s&#39;...\n&quot;</span>,cmd);
<a name="l00332"></a>00332 
<a name="l00333"></a>00333 <span class="preprocessor">#ifdef EMBEDDEDPERL</span>
<a name="l00334"></a>00334 <span class="preprocessor"></span>
<a name="l00335"></a>00335         <span class="comment">/* get&quot;filename&quot; component of command */</span>
<a name="l00336"></a>00336         strncpy(fname,cmd,strcspn(cmd,<span class="stringliteral">&quot; &quot;</span>));
<a name="l00337"></a>00337         fname[strcspn(cmd,<span class="stringliteral">&quot; &quot;</span>)]=<span class="stringliteral">&#39;\x0&#39;</span>;
<a name="l00338"></a>00338 
<a name="l00339"></a>00339         <span class="comment">/* should we use the embedded Perl interpreter to run this script? */</span>
<a name="l00340"></a>00340         use_epn=<a class="code" href="base_2utils_8c.html#a93fc2f1f5f573f9812f65e54d8f7ed22">file_uses_embedded_perl</a>(fname);
<a name="l00341"></a>00341 
<a name="l00342"></a>00342         <span class="comment">/* if yes, do some initialization */</span>
<a name="l00343"></a>00343         <span class="keywordflow">if</span>(use_epn==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l00344"></a>00344 
<a name="l00345"></a>00345                 args[0]=fname;
<a name="l00346"></a>00346                 args[2]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l00347"></a>00347 
<a name="l00348"></a>00348                 <span class="keywordflow">if</span>(strchr(cmd,<span class="charliteral">&#39; &#39;</span>)==NULL)
<a name="l00349"></a>00349                         args[3]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l00350"></a>00350                 <span class="keywordflow">else</span>
<a name="l00351"></a>00351                         args[3]=cmd+strlen(fname)+1;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353                 <span class="comment">/* call our perl interpreter to compile and optionally cache the compiled script. */</span>
<a name="l00354"></a>00354 
<a name="l00355"></a>00355                 ENTER;
<a name="l00356"></a>00356                 SAVETMPS;
<a name="l00357"></a>00357                 PUSHMARK(SP);
<a name="l00358"></a>00358 
<a name="l00359"></a>00359                 XPUSHs(sv_2mortal(newSVpv(args[0],0)));
<a name="l00360"></a>00360                 XPUSHs(sv_2mortal(newSVpv(args[1],0)));
<a name="l00361"></a>00361                 XPUSHs(sv_2mortal(newSVpv(args[2],0)));
<a name="l00362"></a>00362                 XPUSHs(sv_2mortal(newSVpv(args[3],0)));
<a name="l00363"></a>00363 
<a name="l00364"></a>00364                 PUTBACK;
<a name="l00365"></a>00365 
<a name="l00366"></a>00366                 call_pv(<span class="stringliteral">&quot;Embed::Persistent::eval_file&quot;</span>, G_EVAL);
<a name="l00367"></a>00367 
<a name="l00368"></a>00368                 SPAGAIN;
<a name="l00369"></a>00369 
<a name="l00370"></a>00370                 <span class="keywordflow">if</span>( SvTRUE(ERRSV) ){
<a name="l00371"></a>00371                         <span class="comment">/*</span>
<a name="l00372"></a>00372 <span class="comment">                         * XXXX need pipe open to send the compilation failure message back to Icinga ?</span>
<a name="l00373"></a>00373 <span class="comment">                         */</span>
<a name="l00374"></a>00374                         (void) POPs ;
<a name="l00375"></a>00375 
<a name="l00376"></a>00376                         <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=<a class="code" href="snprintf_8c.html#a28a648dd20504ebc0c03623a28d82c93">asprintf</a>(&amp;temp_buffer,<span class="stringliteral">&quot;%s&quot;</span>, SvPVX(ERRSV));
<a name="l00377"></a>00377 
<a name="l00378"></a>00378                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#acb53d17d520c3d4c373eeb03cb929123">DEBUGL_COMMANDS</a>,0,<span class="stringliteral">&quot;Embedded perl failed to compile %s, compile error %s\n&quot;</span>,fname,temp_buffer);
<a name="l00379"></a>00379 
<a name="l00380"></a>00380                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;%s\n&quot;</span>,temp_buffer);
<a name="l00381"></a>00381 
<a name="l00382"></a>00382                         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_buffer);
<a name="l00383"></a>00383 
<a name="l00384"></a>00384                         <span class="keywordflow">return</span> <a class="code" href="cgiutils_8h.html#a3a671c5b5d9122f1158555575bc0feb1">STATE_UNKNOWN</a>;
<a name="l00385"></a>00385                         }
<a name="l00386"></a>00386                 <span class="keywordflow">else</span>{
<a name="l00387"></a>00387                         plugin_hndlr_cr=newSVsv(POPs);
<a name="l00388"></a>00388 
<a name="l00389"></a>00389                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#acb53d17d520c3d4c373eeb03cb929123">DEBUGL_COMMANDS</a>,0,<span class="stringliteral">&quot;Embedded perl successfully compiled %s and returned plugin handler (Perl subroutine code ref)\n&quot;</span>,fname);
<a name="l00390"></a>00390 
<a name="l00391"></a>00391                         PUTBACK ;
<a name="l00392"></a>00392                         FREETMPS ;
<a name="l00393"></a>00393                         LEAVE ;
<a name="l00394"></a>00394                         }
<a name="l00395"></a>00395                 }
<a name="l00396"></a>00396 <span class="preprocessor">#endif</span>
<a name="l00397"></a>00397 <span class="preprocessor"></span>
<a name="l00398"></a>00398         <span class="comment">/* create a pipe */</span>
<a name="l00399"></a>00399         <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=pipe(fd);
<a name="l00400"></a>00400 
<a name="l00401"></a>00401         <span class="comment">/* make the pipe non-blocking */</span>
<a name="l00402"></a>00402         fcntl(fd[0],F_SETFL,O_NONBLOCK);
<a name="l00403"></a>00403         fcntl(fd[1],F_SETFL,O_NONBLOCK);
<a name="l00404"></a>00404 
<a name="l00405"></a>00405         <span class="comment">/* get the command start time */</span>
<a name="l00406"></a>00406         gettimeofday(&amp;start_time,NULL);
<a name="l00407"></a>00407 
<a name="l00408"></a>00408 <span class="preprocessor">#ifdef USE_EVENT_BROKER</span>
<a name="l00409"></a>00409 <span class="preprocessor"></span>        <span class="comment">/* send data to event broker */</span>
<a name="l00410"></a>00410         end_time.tv_sec=0L;
<a name="l00411"></a>00411         end_time.tv_usec=0L;
<a name="l00412"></a>00412         <a class="code" href="broker_8h.html#ae213b3f01554239ba25daa95b2af16f7">broker_system_command</a>(<a class="code" href="broker_8h.html#a713d8d2946832d4c9eea053d8da78112">NEBTYPE_SYSTEM_COMMAND_START</a>,<a class="code" href="broker_8h.html#ae7b50b735fa9d5baf42ab19525993635">NEBFLAG_NONE</a>,<a class="code" href="broker_8h.html#a2e1afa1e543c76a752561dbc9eb38d65">NEBATTR_NONE</a>,start_time,end_time,*exectime,timeout,*early_timeout,result,cmd,NULL,NULL);
<a name="l00413"></a>00413 <span class="preprocessor">#endif</span>
<a name="l00414"></a>00414 <span class="preprocessor"></span>
<a name="l00415"></a>00415         <span class="comment">/* fork */</span>
<a name="l00416"></a>00416         pid=fork();
<a name="l00417"></a>00417 
<a name="l00418"></a>00418         <span class="comment">/* return an error if we couldn&#39;t fork */</span>
<a name="l00419"></a>00419         <span class="keywordflow">if</span>(pid==-1){
<a name="l00420"></a>00420                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: fork() in my_system_r() failed for command \&quot;%s\&quot;\n&quot;</span>,cmd);
<a name="l00421"></a>00421 
<a name="l00422"></a>00422                 <span class="comment">/* close both ends of the pipe */</span>
<a name="l00423"></a>00423                 close(fd[0]);
<a name="l00424"></a>00424                 close(fd[1]);
<a name="l00425"></a>00425 
<a name="l00426"></a>00426                 <span class="keywordflow">return</span> <a class="code" href="cgiutils_8h.html#a3a671c5b5d9122f1158555575bc0feb1">STATE_UNKNOWN</a>;
<a name="l00427"></a>00427                 }
<a name="l00428"></a>00428 
<a name="l00429"></a>00429         <span class="comment">/* execute the command in the child process */</span>
<a name="l00430"></a>00430         <span class="keywordflow">if</span> (pid==0){
<a name="l00431"></a>00431 
<a name="l00432"></a>00432                 <span class="comment">/* become process group leader */</span>
<a name="l00433"></a>00433                 setpgid(0,0);
<a name="l00434"></a>00434 
<a name="l00435"></a>00435                 <span class="comment">/* set environment variables */</span>
<a name="l00436"></a>00436                 set_all_macro_environment_vars_r(mac, <a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00437"></a>00437 
<a name="l00438"></a>00438                 <span class="comment">/* ADDED 11/12/07 EG */</span>
<a name="l00439"></a>00439                 <span class="comment">/* close external command file and shut down worker thread */</span>
<a name="l00440"></a>00440                 <a class="code" href="base_2utils_8c.html#a5e15280db8f3a81c3d955260965899a0">close_command_file</a>();
<a name="l00441"></a>00441 
<a name="l00442"></a>00442                 <span class="comment">/* reset signal handling */</span>
<a name="l00443"></a>00443                 <a class="code" href="base_2utils_8c.html#a1686ce1c6b73859e70249769c544999a">reset_sighandler</a>();
<a name="l00444"></a>00444 
<a name="l00445"></a>00445                 <span class="comment">/* close pipe for reading */</span>
<a name="l00446"></a>00446                 close(fd[0]);
<a name="l00447"></a>00447 
<a name="l00448"></a>00448                 <span class="comment">/* prevent fd from being inherited by child processed */</span>
<a name="l00449"></a>00449                 flags=fcntl(fd[1],F_GETFD,0);
<a name="l00450"></a>00450                 flags|=FD_CLOEXEC;
<a name="l00451"></a>00451                 fcntl(fd[1],F_SETFD,flags);
<a name="l00452"></a>00452 
<a name="l00453"></a>00453                 <span class="comment">/* trap commands that timeout */</span>
<a name="l00454"></a>00454                 signal(SIGALRM,<a class="code" href="base_2utils_8c.html#a834080b62d6d7fd14afda015a5caa78e">my_system_sighandler</a>);
<a name="l00455"></a>00455                 alarm(timeout);
<a name="l00456"></a>00456 
<a name="l00457"></a>00457 
<a name="l00458"></a>00458                 <span class="comment">/******** BEGIN EMBEDDED PERL CODE EXECUTION ********/</span>
<a name="l00459"></a>00459 
<a name="l00460"></a>00460 <span class="preprocessor">#ifdef EMBEDDEDPERL</span>
<a name="l00461"></a>00461 <span class="preprocessor"></span>                <span class="keywordflow">if</span>(use_epn==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l00462"></a>00462 
<a name="l00463"></a>00463                         <span class="comment">/* execute our previously compiled script - by call_pv(&quot;Embed::Persistent::eval_file&quot;,..) */</span>
<a name="l00464"></a>00464                         ENTER;
<a name="l00465"></a>00465                         SAVETMPS;
<a name="l00466"></a>00466                         PUSHMARK(SP);
<a name="l00467"></a>00467 
<a name="l00468"></a>00468                         XPUSHs(sv_2mortal(newSVpv(args[0],0)));
<a name="l00469"></a>00469                         XPUSHs(sv_2mortal(newSVpv(args[1],0)));
<a name="l00470"></a>00470                         XPUSHs(plugin_hndlr_cr);
<a name="l00471"></a>00471                         XPUSHs(sv_2mortal(newSVpv(args[3],0)));
<a name="l00472"></a>00472 
<a name="l00473"></a>00473                         PUTBACK;
<a name="l00474"></a>00474 
<a name="l00475"></a>00475                         count=call_pv(<span class="stringliteral">&quot;Embed::Persistent::run_package&quot;</span>, G_ARRAY);
<a name="l00476"></a>00476                         <span class="comment">/* count is a debug hook. It should always be two (2), because the persistence framework tries to return two (2) args */</span>
<a name="l00477"></a>00477 
<a name="l00478"></a>00478                         SPAGAIN;
<a name="l00479"></a>00479 
<a name="l00480"></a>00480                         perl_output=POPpx ;
<a name="l00481"></a>00481                         <a class="code" href="icingastats_8c.html#a44ed939e710ce4674954d98865b42ec0">strip</a>(perl_output);
<a name="l00482"></a>00482                         strncpy(buffer,(perl_output==NULL)?<span class="stringliteral">&quot;&quot;</span>:perl_output,<span class="keyword">sizeof</span>(buffer));
<a name="l00483"></a>00483                         buffer[<span class="keyword">sizeof</span>(buffer)-1]=<span class="stringliteral">&#39;\x0&#39;</span>;
<a name="l00484"></a>00484                         status=POPi ;
<a name="l00485"></a>00485 
<a name="l00486"></a>00486                         PUTBACK;
<a name="l00487"></a>00487                         FREETMPS;
<a name="l00488"></a>00488                         LEAVE;
<a name="l00489"></a>00489 
<a name="l00490"></a>00490                         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#acb53d17d520c3d4c373eeb03cb929123">DEBUGL_COMMANDS</a>,0,<span class="stringliteral">&quot;Embedded perl ran command %s with output %d, %s\n&quot;</span>,fname,status,buffer);
<a name="l00491"></a>00491 
<a name="l00492"></a>00492                         <span class="comment">/* write the output back to the parent process */</span>
<a name="l00493"></a>00493                         <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=write(fd[1],buffer,strlen(buffer)+1);
<a name="l00494"></a>00494 
<a name="l00495"></a>00495                         <span class="comment">/* close pipe for writing */</span>
<a name="l00496"></a>00496                         close(fd[1]);
<a name="l00497"></a>00497 
<a name="l00498"></a>00498                         <span class="comment">/* reset the alarm */</span>
<a name="l00499"></a>00499                         alarm(0);
<a name="l00500"></a>00500 
<a name="l00501"></a>00501                         _exit(status);
<a name="l00502"></a>00502                         }
<a name="l00503"></a>00503 <span class="preprocessor">#endif</span>
<a name="l00504"></a>00504 <span class="preprocessor"></span>                <span class="comment">/******** END EMBEDDED PERL CODE EXECUTION ********/</span>
<a name="l00505"></a>00505 
<a name="l00506"></a>00506 
<a name="l00507"></a>00507                 <span class="comment">/* run the command */</span>
<a name="l00508"></a>00508                 fp=(FILE *)popen(cmd,<span class="stringliteral">&quot;r&quot;</span>);
<a name="l00509"></a>00509 
<a name="l00510"></a>00510                 <span class="comment">/* report an error if we couldn&#39;t run the command */</span>
<a name="l00511"></a>00511                 <span class="keywordflow">if</span>(fp==NULL){
<a name="l00512"></a>00512 
<a name="l00513"></a>00513                         strncpy(buffer,<span class="stringliteral">&quot;(Error: Could not execute command)\n&quot;</span>,<span class="keyword">sizeof</span>(buffer)-1);
<a name="l00514"></a>00514                         buffer[<span class="keyword">sizeof</span>(buffer)-1]=<span class="stringliteral">&#39;\x0&#39;</span>;
<a name="l00515"></a>00515 
<a name="l00516"></a>00516                         <span class="comment">/* write the error back to the parent process */</span>
<a name="l00517"></a>00517                         <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=write(fd[1],buffer,strlen(buffer)+1);
<a name="l00518"></a>00518 
<a name="l00519"></a>00519                         result=<a class="code" href="cgiutils_8h.html#a19827c887254e66b983c3269a42562bc">STATE_CRITICAL</a>;
<a name="l00520"></a>00520                         }
<a name="l00521"></a>00521                 <span class="keywordflow">else</span>{
<a name="l00522"></a>00522 
<a name="l00523"></a>00523                         <span class="comment">/* write all the lines of output back to the parent process */</span>
<a name="l00524"></a>00524                         <span class="keywordflow">while</span>(fgets(buffer,<span class="keyword">sizeof</span>(buffer)-1,fp))
<a name="l00525"></a>00525                                 <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=write(fd[1],buffer,strlen(buffer));
<a name="l00526"></a>00526 
<a name="l00527"></a>00527                         <span class="comment">/* close the command and get termination status */</span>
<a name="l00528"></a>00528                         status=pclose(fp);
<a name="l00529"></a>00529 
<a name="l00530"></a>00530                         <span class="comment">/* report an error if we couldn&#39;t close the command */</span>
<a name="l00531"></a>00531                         <span class="keywordflow">if</span>(status==-1)
<a name="l00532"></a>00532                                 result=<a class="code" href="cgiutils_8h.html#a19827c887254e66b983c3269a42562bc">STATE_CRITICAL</a>;
<a name="l00533"></a>00533                         <span class="keywordflow">else</span>{
<a name="l00534"></a>00534                                 <span class="keywordflow">if</span>(<a class="code" href="config_8h.html#a7a9fed9392a51acd68e5f469e63f7961">WEXITSTATUS</a>(status)==0 &amp;&amp; WIFSIGNALED(status))
<a name="l00535"></a>00535                                         result=128+WTERMSIG(status);
<a name="l00536"></a>00536                                 result=<a class="code" href="config_8h.html#a7a9fed9392a51acd68e5f469e63f7961">WEXITSTATUS</a>(status);
<a name="l00537"></a>00537                                 }
<a name="l00538"></a>00538                         }
<a name="l00539"></a>00539 
<a name="l00540"></a>00540                 <span class="comment">/* close pipe for writing */</span>
<a name="l00541"></a>00541                 close(fd[1]);
<a name="l00542"></a>00542 
<a name="l00543"></a>00543                 <span class="comment">/* reset the alarm */</span>
<a name="l00544"></a>00544                 alarm(0);
<a name="l00545"></a>00545 
<a name="l00546"></a>00546                 <span class="comment">/* clear environment variables */</span>
<a name="l00547"></a>00547                 set_all_macro_environment_vars_r(mac, <a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00548"></a>00548 
<a name="l00549"></a>00549 <span class="preprocessor">#ifndef DONT_USE_MEMORY_PERFORMANCE_TWEAKS</span>
<a name="l00550"></a>00550 <span class="preprocessor"></span>                <span class="comment">/* free allocated memory */</span>
<a name="l00551"></a>00551                 <span class="comment">/* this needs to be done last, so we don&#39;t free memory for variables before they&#39;re used above */</span>
<a name="l00552"></a>00552                 <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a73881c51ba02b6ea241ab71a8e2c354c">free_child_process_memory</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l00553"></a>00553                         <a class="code" href="base_2utils_8c.html#ae49e5228711e021ca4ea8da8e4d2f447">free_memory</a>(mac);
<a name="l00554"></a>00554 <span class="preprocessor">#endif</span>
<a name="l00555"></a>00555 <span class="preprocessor"></span>
<a name="l00556"></a>00556                 _exit(result);
<a name="l00557"></a>00557                 }
<a name="l00558"></a>00558 
<a name="l00559"></a>00559         <span class="comment">/* parent waits for child to finish executing command */</span>
<a name="l00560"></a>00560         <span class="keywordflow">else</span>{
<a name="l00561"></a>00561 
<a name="l00562"></a>00562                 <span class="comment">/* close pipe for writing */</span>
<a name="l00563"></a>00563                 close(fd[1]);
<a name="l00564"></a>00564 
<a name="l00565"></a>00565                 <span class="comment">/* wait for child to exit */</span>
<a name="l00566"></a>00566                 waitpid(pid,&amp;status,0);
<a name="l00567"></a>00567 
<a name="l00568"></a>00568                 <span class="comment">/* get the end time for running the command */</span>
<a name="l00569"></a>00569                 gettimeofday(&amp;end_time,NULL);
<a name="l00570"></a>00570 
<a name="l00571"></a>00571                 <span class="comment">/* return execution time in milliseconds */</span>
<a name="l00572"></a>00572                 *exectime=(double)((<span class="keywordtype">double</span>)(end_time.tv_sec-start_time.tv_sec)+(<span class="keywordtype">double</span>)((end_time.tv_usec-start_time.tv_usec)/1000)/1000.0);
<a name="l00573"></a>00573                 <span class="keywordflow">if</span>(*exectime&lt;0.0)
<a name="l00574"></a>00574                         *exectime=0.0;
<a name="l00575"></a>00575 
<a name="l00576"></a>00576                 <span class="comment">/* get the exit code returned from the program */</span>
<a name="l00577"></a>00577                 result=<a class="code" href="config_8h.html#a7a9fed9392a51acd68e5f469e63f7961">WEXITSTATUS</a>(status);
<a name="l00578"></a>00578 
<a name="l00579"></a>00579                 <span class="comment">/* check for possibly missing scripts/binaries/etc */</span>
<a name="l00580"></a>00580                 <span class="keywordflow">if</span>(result==126 || result==127){
<a name="l00581"></a>00581                         temp_buffer=<span class="stringliteral">&quot;\163\157\151\147\141\156\040\145\144\151\163\156\151&quot;</span>;
<a name="l00582"></a>00582                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: Attempting to execute the command \&quot;%s\&quot; resulted in a return code of %d.  Make sure the script or binary you are trying to execute actually exists...\n&quot;</span>,cmd,result);
<a name="l00583"></a>00583                         }
<a name="l00584"></a>00584 
<a name="l00585"></a>00585                 <span class="comment">/* check bounds on the return value */</span>
<a name="l00586"></a>00586                 <span class="keywordflow">if</span>(result&lt;-1 || result&gt;3)
<a name="l00587"></a>00587                         result=<a class="code" href="cgiutils_8h.html#a3a671c5b5d9122f1158555575bc0feb1">STATE_UNKNOWN</a>;
<a name="l00588"></a>00588 
<a name="l00589"></a>00589                 <span class="comment">/* initialize dynamic buffer */</span>
<a name="l00590"></a>00590                 <a class="code" href="base_2utils_8c.html#aa18c99ae8f740d8ab59ef720dbbde1ad">dbuf_init</a>(&amp;output_dbuf,dbuf_chunk);
<a name="l00591"></a>00591 
<a name="l00592"></a>00592                 <span class="comment">/* Opsera patch to check timeout before attempting to read output via pipe. Originally by Sven Nierlein */</span>
<a name="l00593"></a>00593                 <span class="comment">/* if there was a critical return code AND the command time exceeded the timeout thresholds, assume a timeout */</span>
<a name="l00594"></a>00594                 <span class="keywordflow">if</span>(result==<a class="code" href="cgiutils_8h.html#a19827c887254e66b983c3269a42562bc">STATE_CRITICAL</a> &amp;&amp; (end_time.tv_sec-start_time.tv_sec)&gt;=timeout){
<a name="l00595"></a>00595 
<a name="l00596"></a>00596                         <span class="comment">/* set the early timeout flag */</span>
<a name="l00597"></a>00597                         *early_timeout=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00598"></a>00598 
<a name="l00599"></a>00599                         <span class="comment">/* try to kill the command that timed out by sending termination signal to child process group */</span>
<a name="l00600"></a>00600                         kill((pid_t)(-pid),SIGTERM);
<a name="l00601"></a>00601                         sleep(1);
<a name="l00602"></a>00602                         kill((pid_t)(-pid),SIGKILL);
<a name="l00603"></a>00603                         }
<a name="l00604"></a>00604 
<a name="l00605"></a>00605                 <span class="comment">/* read output if timeout has not occurred */</span>
<a name="l00606"></a>00606                 <span class="keywordflow">else</span>{
<a name="l00607"></a>00607 
<a name="l00608"></a>00608                         <span class="comment">/* initialize output */</span>
<a name="l00609"></a>00609                         strcpy(buffer,<span class="stringliteral">&quot;&quot;</span>);
<a name="l00610"></a>00610 
<a name="l00611"></a>00611                         <span class="comment">/* try and read the results from the command output (retry if we encountered a signal) */</span>
<a name="l00612"></a>00612                         <span class="keywordflow">do</span>{
<a name="l00613"></a>00613                                 bytes_read=read(fd[0],buffer,<span class="keyword">sizeof</span>(buffer)-1);
<a name="l00614"></a>00614 
<a name="l00615"></a>00615                                 <span class="comment">/* append data we just read to dynamic buffer */</span>
<a name="l00616"></a>00616                                 <span class="keywordflow">if</span>(bytes_read&gt;0){
<a name="l00617"></a>00617                                         buffer[bytes_read]=<span class="stringliteral">&#39;\x0&#39;</span>;
<a name="l00618"></a>00618                                         <a class="code" href="base_2utils_8c.html#a302c0b1965465017578bba02a6d9e6c9">dbuf_strcat</a>(&amp;output_dbuf,buffer);
<a name="l00619"></a>00619                                         }
<a name="l00620"></a>00620 
<a name="l00621"></a>00621                                 <span class="comment">/* handle errors */</span>
<a name="l00622"></a>00622                                 <span class="keywordflow">if</span>(bytes_read==-1){
<a name="l00623"></a>00623                                         <span class="comment">/* we encountered a recoverable error, so try again */</span>
<a name="l00624"></a>00624                                         <span class="keywordflow">if</span>(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>==EINTR)
<a name="l00625"></a>00625                                                 <span class="keywordflow">continue</span>;
<a name="l00626"></a>00626                                         <span class="comment">/* patch by Henning Brauer to prevent CPU hogging */</span>
<a name="l00627"></a>00627                                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>==EAGAIN){
<a name="l00628"></a>00628                                                 <span class="keyword">struct </span>pollfd pfd;
<a name="l00629"></a>00629 
<a name="l00630"></a>00630                                                 pfd.fd = fd[0];
<a name="l00631"></a>00631                                                 pfd.events = POLLIN;
<a name="l00632"></a>00632                                                 poll(&amp;pfd, 1, -1);
<a name="l00633"></a>00633                                                 <span class="keywordflow">continue</span>;
<a name="l00634"></a>00634                                                 }
<a name="l00635"></a>00635                                         <span class="keywordflow">else</span>
<a name="l00636"></a>00636                                                 <span class="keywordflow">break</span>;
<a name="l00637"></a>00637                                         }
<a name="l00638"></a>00638 
<a name="l00639"></a>00639                                 <span class="comment">/* we&#39;re done */</span>
<a name="l00640"></a>00640                                 <span class="keywordflow">if</span>(bytes_read==0)
<a name="l00641"></a>00641                                         <span class="keywordflow">break</span>;
<a name="l00642"></a>00642 
<a name="l00643"></a>00643                                 }<span class="keywordflow">while</span>(1);
<a name="l00644"></a>00644 
<a name="l00645"></a>00645                         <span class="comment">/* cap output length - this isn&#39;t necessary, but it keeps runaway plugin output from causing problems */</span>
<a name="l00646"></a>00646                         <span class="keywordflow">if</span>(max_output_length&gt;0  &amp;&amp; output_dbuf.used_size&gt;max_output_length)
<a name="l00647"></a>00647                                 output_dbuf.buf[max_output_length]=<span class="stringliteral">&#39;\x0&#39;</span>;
<a name="l00648"></a>00648 
<a name="l00649"></a>00649                         <span class="keywordflow">if</span>(output!=NULL &amp;&amp; output_dbuf.buf)
<a name="l00650"></a>00650                                 *output=(<span class="keywordtype">char</span> *)strdup(output_dbuf.buf);
<a name="l00651"></a>00651 
<a name="l00652"></a>00652                         }
<a name="l00653"></a>00653 
<a name="l00654"></a>00654                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#acb53d17d520c3d4c373eeb03cb929123">DEBUGL_COMMANDS</a>,1,<span class="stringliteral">&quot;Execution time=%.3f sec, early timeout=%d, result=%d, output=%s\n&quot;</span>,*exectime,*early_timeout,result,(output_dbuf.buf==NULL)?<span class="stringliteral">&quot;(null)&quot;</span>:output_dbuf.buf);
<a name="l00655"></a>00655 
<a name="l00656"></a>00656 <span class="preprocessor">#ifdef USE_EVENT_BROKER</span>
<a name="l00657"></a>00657 <span class="preprocessor"></span>                <span class="comment">/* send data to event broker */</span>
<a name="l00658"></a>00658                 <a class="code" href="broker_8h.html#ae213b3f01554239ba25daa95b2af16f7">broker_system_command</a>(<a class="code" href="broker_8h.html#adbd4bae1c1d0feaf66d67da972dd7cf9">NEBTYPE_SYSTEM_COMMAND_END</a>,<a class="code" href="broker_8h.html#ae7b50b735fa9d5baf42ab19525993635">NEBFLAG_NONE</a>,<a class="code" href="broker_8h.html#a2e1afa1e543c76a752561dbc9eb38d65">NEBATTR_NONE</a>,start_time,end_time,*exectime,timeout,*early_timeout,result,cmd,(output_dbuf.buf==NULL)?NULL:output_dbuf.buf,NULL);
<a name="l00659"></a>00659 <span class="preprocessor">#endif</span>
<a name="l00660"></a>00660 <span class="preprocessor"></span>
<a name="l00661"></a>00661                 <span class="comment">/* free memory */</span>
<a name="l00662"></a>00662                 <a class="code" href="base_2utils_8c.html#ad793f77d0d1041d670ff9bee3a5cda5d">dbuf_free</a>(&amp;output_dbuf);
<a name="l00663"></a>00663 
<a name="l00664"></a>00664                 <span class="comment">/* close the pipe for reading */</span>
<a name="l00665"></a>00665                 close(fd[0]);
<a name="l00666"></a>00666                 }
<a name="l00667"></a>00667 
<a name="l00668"></a>00668         <span class="keywordflow">return</span> result;
<a name="l00669"></a>00669 }
<a name="l00670"></a>00670 
<a name="l00671"></a>00671 <span class="comment">/*</span>
<a name="l00672"></a>00672 <span class="comment"> * For API compatibility, we must include a my_system() whose</span>
<a name="l00673"></a>00673 <span class="comment"> * signature doesn&#39;t include the icinga_macros variable.</span>
<a name="l00674"></a>00674 <span class="comment"> * IDOUtils uses this. Possibly other modules as well.</span>
<a name="l00675"></a>00675 <span class="comment"> */</span>
<a name="l00676"></a><a class="code" href="icinga_8h.html#a354cb07091b07f7f190fa90e76ef0f74">00676</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a27ee699ba68d55a7dac97174d4516d41">my_system</a>(<span class="keywordtype">char</span> *cmd,<span class="keywordtype">int</span> timeout,<span class="keywordtype">int</span> *early_timeout,<span class="keywordtype">double</span> *exectime,<span class="keywordtype">char</span> **output,<span class="keywordtype">int</span> max_output_length){
<a name="l00677"></a>00677         <span class="keywordflow">return</span> <a class="code" href="base_2utils_8c.html#aaec741bbcbb039485348567cc5f2ce2c">my_system_r</a>(<a class="code" href="macros_8c.html#ab140ad54ce6173c73864a7b1da8c68fe">get_global_macros</a>(), cmd, timeout, early_timeout, exectime, output, max_output_length);
<a name="l00678"></a>00678 }
<a name="l00679"></a>00679 
<a name="l00680"></a>00680 
<a name="l00681"></a>00681 <span class="comment">/* given a &quot;raw&quot; command, return the &quot;expanded&quot; or &quot;whole&quot; command line */</span>
<a name="l00682"></a><a class="code" href="icinga_8h.html#af80ce67ce807ed6f2d0d7936bf91ca20">00682</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a786c23913ee9613d6e4782aa5e33a8e6">get_raw_command_line_r</a>(<a class="code" href="structicinga__macros.html">icinga_macros</a> *mac, <a class="code" href="structcommand__struct.html">command</a> *cmd_ptr, <span class="keywordtype">char</span> *cmd, <span class="keywordtype">char</span> **full_command, <span class="keywordtype">int</span> macro_options){
<a name="l00683"></a>00683         <span class="keywordtype">char</span> temp_arg[<a class="code" href="include_2common_8h.html#a21db2bc2305ba9c6162afb23c7ce0c8d">MAX_COMMAND_BUFFER</a>]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l00684"></a>00684         <span class="keywordtype">char</span> *arg_buffer=NULL;
<a name="l00685"></a>00685         <span class="keyword">register</span> <span class="keywordtype">int</span> x=0;
<a name="l00686"></a>00686         <span class="keyword">register</span> <span class="keywordtype">int</span> y=0;
<a name="l00687"></a>00687         <span class="keyword">register</span> <span class="keywordtype">int</span> arg_index=0;
<a name="l00688"></a>00688         <span class="keyword">register</span> <span class="keywordtype">int</span> escaped=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00689"></a>00689 
<a name="l00690"></a>00690         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;get_raw_command_line_r()\n&quot;</span>);
<a name="l00691"></a>00691 
<a name="l00692"></a>00692         <span class="comment">/* clear the argv macros */</span>
<a name="l00693"></a>00693         <a class="code" href="macros_8c.html#ad0e2371729860db2ac94815c889b45c6">clear_argv_macros_r</a>(mac);
<a name="l00694"></a>00694 
<a name="l00695"></a>00695         <span class="comment">/* make sure we&#39;ve got all the requirements */</span>
<a name="l00696"></a>00696         <span class="keywordflow">if</span>(cmd_ptr==NULL || full_command==NULL)
<a name="l00697"></a>00697                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l00698"></a>00698 
<a name="l00699"></a>00699         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#acb53d17d520c3d4c373eeb03cb929123">DEBUGL_COMMANDS</a>|<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>|<a class="code" href="logging_8h.html#a3df6b9d6b03a175d57729275029710ff">DEBUGL_MACROS</a>,2,<span class="stringliteral">&quot;Raw Command Input: %s\n&quot;</span>,cmd_ptr-&gt;<a class="code" href="structcommand__struct.html#a57f84cb1d2a7f5fa72595d73d59282f5">command_line</a>);
<a name="l00700"></a>00700 
<a name="l00701"></a>00701         <span class="comment">/* get the full command line */</span>
<a name="l00702"></a>00702         *full_command=(<span class="keywordtype">char</span> *)strdup((cmd_ptr-&gt;<a class="code" href="structcommand__struct.html#a57f84cb1d2a7f5fa72595d73d59282f5">command_line</a>==NULL)?<span class="stringliteral">&quot;&quot;</span>:cmd_ptr-&gt;<a class="code" href="structcommand__struct.html#a57f84cb1d2a7f5fa72595d73d59282f5">command_line</a>);
<a name="l00703"></a>00703 
<a name="l00704"></a>00704         <span class="comment">/* XXX: Crazy indent */</span>
<a name="l00705"></a>00705         <span class="comment">/* get the command arguments */</span>
<a name="l00706"></a>00706         <span class="keywordflow">if</span>(cmd!=NULL){
<a name="l00707"></a>00707 
<a name="l00708"></a>00708                 <span class="comment">/* skip the command name (we&#39;re about to get the arguments)... */</span>
<a name="l00709"></a>00709                 <span class="keywordflow">for</span>(arg_index=0;;arg_index++){
<a name="l00710"></a>00710                         <span class="keywordflow">if</span>(cmd[arg_index]==<span class="charliteral">&#39;!&#39;</span> || cmd[arg_index]==<span class="stringliteral">&#39;\x0&#39;</span>)
<a name="l00711"></a>00711                                 <span class="keywordflow">break</span>;
<a name="l00712"></a>00712                         }
<a name="l00713"></a>00713 
<a name="l00714"></a>00714                 <span class="comment">/* get each command argument */</span>
<a name="l00715"></a>00715                 <span class="keywordflow">for</span>(x=0;x&lt;<a class="code" href="macros_8h.html#af62a9ff61a318311e2a0de0fb58cd58f">MAX_COMMAND_ARGUMENTS</a>;x++){
<a name="l00716"></a>00716 
<a name="l00717"></a>00717                         <span class="comment">/* we reached the end of the arguments... */</span>
<a name="l00718"></a>00718                         <span class="keywordflow">if</span>(cmd[arg_index]==<span class="stringliteral">&#39;\x0&#39;</span>)
<a name="l00719"></a>00719                                 <span class="keywordflow">break</span>;
<a name="l00720"></a>00720 
<a name="l00721"></a>00721                         <span class="comment">/* get the next argument */</span>
<a name="l00722"></a>00722                         <span class="comment">/* can&#39;t use strtok(), as that&#39;s used in process_macros... */</span>
<a name="l00723"></a>00723                         <span class="keywordflow">for</span>(arg_index++,y=0;y&lt;<span class="keyword">sizeof</span>(temp_arg)-1;arg_index++){
<a name="l00724"></a>00724 
<a name="l00725"></a>00725                                 <span class="comment">/* backslashes escape */</span>
<a name="l00726"></a>00726                                 <span class="keywordflow">if</span>(cmd[arg_index]==<span class="charliteral">&#39;\\&#39;</span> &amp;&amp; escaped==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l00727"></a>00727                                         escaped=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00728"></a>00728                                         <span class="keywordflow">continue</span>;
<a name="l00729"></a>00729                                         }
<a name="l00730"></a>00730 
<a name="l00731"></a>00731                                 <span class="comment">/* end of argument */</span>
<a name="l00732"></a>00732                                 <span class="keywordflow">if</span>((cmd[arg_index]==<span class="charliteral">&#39;!&#39;</span> &amp;&amp; escaped==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) || cmd[arg_index]==<span class="stringliteral">&#39;\x0&#39;</span>)
<a name="l00733"></a>00733                                         <span class="keywordflow">break</span>;
<a name="l00734"></a>00734 
<a name="l00735"></a>00735                                 <span class="comment">/* normal of escaped char */</span>
<a name="l00736"></a>00736                                 temp_arg[y]=cmd[arg_index];
<a name="l00737"></a>00737                                 y++;
<a name="l00738"></a>00738 
<a name="l00739"></a>00739                                 <span class="comment">/* clear escaped flag */</span>
<a name="l00740"></a>00740                                 escaped=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00741"></a>00741                                 }
<a name="l00742"></a>00742                         temp_arg[y]=<span class="stringliteral">&#39;\x0&#39;</span>;
<a name="l00743"></a>00743 
<a name="l00744"></a>00744                         <span class="comment">/* ADDED 01/29/04 EG */</span>
<a name="l00745"></a>00745                         <span class="comment">/* process any macros we find in the argument */</span>
<a name="l00746"></a>00746                         <a class="code" href="macros_8c.html#a1be6f89f750b75aeab483d93badda0e4">process_macros_r</a>(mac, temp_arg,&amp;arg_buffer,macro_options);
<a name="l00747"></a>00747 
<a name="l00748"></a>00748                         mac-&gt;<a class="code" href="structicinga__macros.html#ab83597626c72cb309b73830e35d894da">argv</a>[x]=arg_buffer;
<a name="l00749"></a>00749                         }
<a name="l00750"></a>00750                 }
<a name="l00751"></a>00751 
<a name="l00752"></a>00752         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#acb53d17d520c3d4c373eeb03cb929123">DEBUGL_COMMANDS</a>|<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>|<a class="code" href="logging_8h.html#a3df6b9d6b03a175d57729275029710ff">DEBUGL_MACROS</a>,2,<span class="stringliteral">&quot;Expanded Command Output: %s\n&quot;</span>,*full_command);
<a name="l00753"></a>00753 
<a name="l00754"></a>00754         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00755"></a>00755 }
<a name="l00756"></a>00756 
<a name="l00757"></a>00757 <span class="comment">/*</span>
<a name="l00758"></a>00758 <span class="comment"> * This function modifies the global macro struct and is thus not</span>
<a name="l00759"></a>00759 <span class="comment"> * threadsafe</span>
<a name="l00760"></a>00760 <span class="comment"> */</span>
<a name="l00761"></a><a class="code" href="icinga_8h.html#af13ea19c67353f67f255ab79cf82942f">00761</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a8a8692945e33ba738c6f9ae8cf8bb9b1">get_raw_command_line</a>(<a class="code" href="structcommand__struct.html">command</a> *cmd_ptr, <span class="keywordtype">char</span> *cmd, <span class="keywordtype">char</span> **full_command, <span class="keywordtype">int</span> macro_options){
<a name="l00762"></a>00762         <a class="code" href="structicinga__macros.html">icinga_macros</a> *mac;
<a name="l00763"></a>00763 
<a name="l00764"></a>00764         mac = <a class="code" href="macros_8c.html#ab140ad54ce6173c73864a7b1da8c68fe">get_global_macros</a>();
<a name="l00765"></a>00765         <span class="keywordflow">return</span> <a class="code" href="base_2utils_8c.html#a786c23913ee9613d6e4782aa5e33a8e6">get_raw_command_line_r</a>(mac, cmd_ptr, cmd, full_command, macro_options);
<a name="l00766"></a>00766 }
<a name="l00767"></a>00767 
<a name="l00768"></a>00768 
<a name="l00769"></a>00769 
<a name="l00770"></a>00770 <span class="comment">/******************************************************************/</span>
<a name="l00771"></a>00771 <span class="comment">/******************** ENVIRONMENT FUNCTIONS ***********************/</span>
<a name="l00772"></a>00772 <span class="comment">/******************************************************************/</span>
<a name="l00773"></a>00773 
<a name="l00774"></a>00774 <span class="comment">/* sets or unsets an environment variable */</span>
<a name="l00775"></a><a class="code" href="icinga_8h.html#a5e89490665eec1fb9939d4512ffc9be8">00775</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a6e48963e077d47e34f3e8ce1f5ba4204">set_environment_var</a>(<span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> *value, <span class="keywordtype">int</span> <span class="keyword">set</span>){
<a name="l00776"></a>00776 <span class="preprocessor">#ifndef HAVE_SETENV</span>
<a name="l00777"></a>00777 <span class="preprocessor"></span>        <span class="keywordtype">char</span> *env_string=NULL;
<a name="l00778"></a>00778 <span class="preprocessor">#endif</span>
<a name="l00779"></a>00779 <span class="preprocessor"></span>
<a name="l00780"></a>00780         <span class="comment">/* we won&#39;t mess with null variable names */</span>
<a name="l00781"></a>00781         <span class="keywordflow">if</span>(name==NULL)
<a name="l00782"></a>00782                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l00783"></a>00783 
<a name="l00784"></a>00784         <span class="comment">/* set the environment variable */</span>
<a name="l00785"></a>00785         <span class="keywordflow">if</span>(<span class="keyword">set</span>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l00786"></a>00786 
<a name="l00787"></a>00787 <span class="preprocessor">#ifdef HAVE_SETENV</span>
<a name="l00788"></a>00788 <span class="preprocessor"></span>                setenv(name,(value==NULL)?<span class="stringliteral">&quot;&quot;</span>:value,1);
<a name="l00789"></a>00789 <span class="preprocessor">#else</span>
<a name="l00790"></a>00790 <span class="preprocessor"></span>                <span class="comment">/* needed for Solaris and systems that don&#39;t have setenv() */</span>
<a name="l00791"></a>00791                 <span class="comment">/* this will leak memory, but in a &quot;controlled&quot; way, since lost memory should be freed when the child process exits */</span>
<a name="l00792"></a>00792                 <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=<a class="code" href="snprintf_8c.html#a28a648dd20504ebc0c03623a28d82c93">asprintf</a>(&amp;env_string,<span class="stringliteral">&quot;%s=%s&quot;</span>,name,(value==NULL)?<span class="stringliteral">&quot;&quot;</span>:value);
<a name="l00793"></a>00793                 <span class="keywordflow">if</span>(env_string)
<a name="l00794"></a>00794                         putenv(env_string);
<a name="l00795"></a>00795 <span class="preprocessor">#endif</span>
<a name="l00796"></a>00796 <span class="preprocessor"></span>                }
<a name="l00797"></a>00797         <span class="comment">/* clear the variable */</span>
<a name="l00798"></a>00798         <span class="keywordflow">else</span>{
<a name="l00799"></a>00799 <span class="preprocessor">#ifdef HAVE_UNSETENV</span>
<a name="l00800"></a>00800 <span class="preprocessor"></span>                unsetenv(name);
<a name="l00801"></a>00801 <span class="preprocessor">#endif</span>
<a name="l00802"></a>00802 <span class="preprocessor"></span>                }
<a name="l00803"></a>00803 
<a name="l00804"></a>00804         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00805"></a>00805         }
<a name="l00806"></a>00806 
<a name="l00807"></a>00807 
<a name="l00808"></a>00808 
<a name="l00809"></a>00809 
<a name="l00810"></a>00810 <span class="comment">/******************************************************************/</span>
<a name="l00811"></a>00811 <span class="comment">/************************* TIME FUNCTIONS *************************/</span>
<a name="l00812"></a>00812 <span class="comment">/******************************************************************/</span>
<a name="l00813"></a>00813 
<a name="l00814"></a>00814 <span class="comment">/* Checks if the given time is in daylight time saving period */</span>
<a name="l00815"></a><a class="code" href="cgiutils_8h.html#a76baed6f4e100a3e74e2a90d6c82d5a2">00815</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a72b9db5453903fa0357d3409d92d75b8">is_dlst_time</a>(time_t *time) {
<a name="l00816"></a>00816         <span class="keyword">struct </span>tm *bt = localtime(time);
<a name="l00817"></a>00817         <span class="keywordflow">return</span> bt-&gt;tm_isdst;
<a name="l00818"></a>00818 }
<a name="l00819"></a>00819 
<a name="l00820"></a>00820 <span class="comment">/* Returns the shift in seconds if the given times are across the daylight time saving period change */</span>
<a name="l00821"></a><a class="code" href="base_2utils_8c.html#af8827c20db029bc74ce240a818a2a800">00821</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#af8827c20db029bc74ce240a818a2a800">get_dlst_shift</a>(time_t *start, time_t *end) {
<a name="l00822"></a>00822         <span class="keywordtype">int</span> shift = 0, dlst_end, dlst_start;
<a name="l00823"></a>00823         dlst_start = <a class="code" href="base_2utils_8c.html#a72b9db5453903fa0357d3409d92d75b8">is_dlst_time</a>(start);
<a name="l00824"></a>00824         dlst_end = <a class="code" href="base_2utils_8c.html#a72b9db5453903fa0357d3409d92d75b8">is_dlst_time</a>(end);
<a name="l00825"></a>00825         <span class="keywordflow">if</span> (dlst_start &lt; dlst_end) {
<a name="l00826"></a>00826                 shift = 3600;
<a name="l00827"></a>00827         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dlst_start &gt; dlst_end) {
<a name="l00828"></a>00828                 shift = -3600;
<a name="l00829"></a>00829         }
<a name="l00830"></a>00830         <span class="keywordflow">return</span> shift;
<a name="l00831"></a>00831 }
<a name="l00832"></a>00832 
<a name="l00833"></a>00833 <span class="comment">/*#define TEST_TIMEPERIODS_A 1*/</span>
<a name="l00834"></a>00834 
<a name="l00835"></a>00835 <span class="comment">/* see if the specified time falls into a valid time range in the given time period */</span>
<a name="l00836"></a><a class="code" href="icinga_8h.html#a4afb0ddaa13d1b93c6f2b836dd92f00d">00836</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a49602563f5f03788d56b2d06d2c72bfb">check_time_against_period</a>(time_t test_time, <a class="code" href="structtimeperiod__struct.html">timeperiod</a> *tperiod){
<a name="l00837"></a>00837         <a class="code" href="structtimeperiodexclusion__struct.html">timeperiodexclusion</a> *temp_timeperiodexclusion=NULL;
<a name="l00838"></a>00838         <a class="code" href="structtimeperiodexclusion__struct.html">timeperiodexclusion</a> *first_timeperiodexclusion=NULL;
<a name="l00839"></a>00839         <a class="code" href="structdaterange__struct.html">daterange</a> *temp_daterange=NULL;
<a name="l00840"></a>00840         <a class="code" href="structtimerange__struct.html">timerange</a> *temp_timerange=NULL;
<a name="l00841"></a>00841         time_t midnight=0L;
<a name="l00842"></a>00842         time_t <a class="code" href="cmd_8c.html#ad20e89e0c86aa812dc3a8e2fb7b5777b">start_time</a>=(time_t)0L;
<a name="l00843"></a>00843         time_t <a class="code" href="cmd_8c.html#a1e324d62e65642694c00de363bf8a8ba">end_time</a>=(time_t)0L;
<a name="l00844"></a>00844         <span class="keywordtype">int</span> found_match=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00845"></a>00845         <span class="keyword">struct </span>tm *t, tm_s;
<a name="l00846"></a>00846         <span class="keywordtype">int</span> daterange_type=0;
<a name="l00847"></a>00847         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> days=0L;
<a name="l00848"></a>00848         time_t day_range_start=(time_t)0L;
<a name="l00849"></a>00849         time_t day_range_end=(time_t)0L;
<a name="l00850"></a>00850         <span class="keywordtype">int</span> test_time_year=0;
<a name="l00851"></a>00851         <span class="keywordtype">int</span> test_time_mon=0;
<a name="l00852"></a>00852         <span class="keywordtype">int</span> test_time_mday=0;
<a name="l00853"></a>00853         <span class="keywordtype">int</span> test_time_wday=0;
<a name="l00854"></a>00854         <span class="keywordtype">int</span> year=0;
<a name="l00855"></a>00855         <span class="keywordtype">int</span> shift;
<a name="l00856"></a>00856 
<a name="l00857"></a>00857         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;check_time_against_period()\n&quot;</span>);
<a name="l00858"></a>00858 
<a name="l00859"></a>00859         <span class="comment">/* if no period was specified, assume the time is good */</span>
<a name="l00860"></a>00860         <span class="keywordflow">if</span>(tperiod==NULL)
<a name="l00861"></a>00861                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00862"></a>00862 
<a name="l00863"></a>00863         <span class="comment">/* test exclusions first - if exclusions match current time, bail out with an error */</span>
<a name="l00864"></a>00864         <span class="comment">/* clear exclusions list before recursing (and restore afterwards) to prevent endless loops... */</span>
<a name="l00865"></a>00865         first_timeperiodexclusion=tperiod-&gt;<a class="code" href="structtimeperiod__struct.html#a318ee4afd605158f3335a7e32d86dc39">exclusions</a>;
<a name="l00866"></a>00866         tperiod-&gt;<a class="code" href="structtimeperiod__struct.html#a318ee4afd605158f3335a7e32d86dc39">exclusions</a>=NULL;
<a name="l00867"></a>00867         <span class="keywordflow">for</span>(temp_timeperiodexclusion=first_timeperiodexclusion;temp_timeperiodexclusion!=NULL;temp_timeperiodexclusion=temp_timeperiodexclusion-&gt;<a class="code" href="structtimeperiodexclusion__struct.html#ada739dcf291c6a8db98b43211f28ab54">next</a>){
<a name="l00868"></a>00868                 <span class="keywordflow">if</span>(<a class="code" href="base_2utils_8c.html#a49602563f5f03788d56b2d06d2c72bfb">check_time_against_period</a>(test_time,temp_timeperiodexclusion-&gt;<a class="code" href="structtimeperiodexclusion__struct.html#a0a45daadc082654ab3e5bb517ed9015e">timeperiod_ptr</a>)==<a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>){
<a name="l00869"></a>00869                         tperiod-&gt;<a class="code" href="structtimeperiod__struct.html#a318ee4afd605158f3335a7e32d86dc39">exclusions</a>=first_timeperiodexclusion;
<a name="l00870"></a>00870                         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l00871"></a>00871                         }
<a name="l00872"></a>00872                 }
<a name="l00873"></a>00873         tperiod-&gt;<a class="code" href="structtimeperiod__struct.html#a318ee4afd605158f3335a7e32d86dc39">exclusions</a>=first_timeperiodexclusion;
<a name="l00874"></a>00874 
<a name="l00875"></a>00875         <span class="comment">/* save values for later */</span>
<a name="l00876"></a>00876         t = localtime_r(&amp;test_time, &amp;tm_s);
<a name="l00877"></a>00877         test_time_year=t-&gt;tm_year;
<a name="l00878"></a>00878         test_time_mon=t-&gt;tm_mon;
<a name="l00879"></a>00879         test_time_mday=t-&gt;tm_mday;
<a name="l00880"></a>00880         test_time_wday=t-&gt;tm_wday;
<a name="l00881"></a>00881 
<a name="l00882"></a>00882         <span class="comment">/* calculate the start of the day (midnight, 00:00 hours) when the specified test time occurs */</span>
<a name="l00883"></a>00883         t-&gt;tm_sec=0;
<a name="l00884"></a>00884         t-&gt;tm_min=0;
<a name="l00885"></a>00885         t-&gt;tm_hour=0;
<a name="l00886"></a>00886         midnight=(<span class="keywordtype">unsigned</span> long)mktime(t);
<a name="l00887"></a>00887 
<a name="l00888"></a>00888         <span class="comment">/**** check exceptions first ****/</span>
<a name="l00889"></a>00889         <span class="keywordflow">for</span>(daterange_type=0;daterange_type&lt;<a class="code" href="include_2common_8h.html#a09487af157aaf6684304caff29fc563c">DATERANGE_TYPES</a>;daterange_type++){
<a name="l00890"></a>00890 
<a name="l00891"></a>00891                 <span class="keywordflow">for</span>(temp_daterange=tperiod-&gt;<a class="code" href="structtimeperiod__struct.html#a3e17bec1cdcefe9eeaa79851124e2315">exceptions</a>[daterange_type];temp_daterange!=NULL;temp_daterange=temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aee7ef6e3b7ac927f7455026c5c908148">next</a>){
<a name="l00892"></a>00892 
<a name="l00893"></a>00893 <span class="preprocessor">#ifdef TEST_TIMEPERIODS_A</span>
<a name="l00894"></a>00894 <span class="preprocessor"></span>                        printf(<span class="stringliteral">&quot;TYPE: %d\n&quot;</span>,daterange_type);
<a name="l00895"></a>00895                         printf(<span class="stringliteral">&quot;TEST:     %lu = %s&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)test_time,ctime(&amp;test_time));
<a name="l00896"></a>00896                         printf(<span class="stringliteral">&quot;MIDNIGHT: %lu = %s&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)midnight,ctime(&amp;midnight));
<a name="l00897"></a>00897 <span class="preprocessor">#endif</span>
<a name="l00898"></a>00898 <span class="preprocessor"></span>
<a name="l00899"></a>00899                         <span class="comment">/* get the start time */</span>
<a name="l00900"></a>00900                         <span class="keywordflow">switch</span>(daterange_type){
<a name="l00901"></a>00901                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a1c9ce3548ed47cffbe81e5c9f7406aa1">DATERANGE_CALENDAR_DATE</a>:
<a name="l00902"></a>00902                                 t-&gt;tm_sec=0;
<a name="l00903"></a>00903                                 t-&gt;tm_min=0;
<a name="l00904"></a>00904                                 t-&gt;tm_hour=0;
<a name="l00905"></a>00905                                 t-&gt;tm_wday=0;
<a name="l00906"></a>00906                                 t-&gt;tm_mday=temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a2b11fe1c52944be6794b98970ec4e1c4">smday</a>;
<a name="l00907"></a>00907                                 t-&gt;tm_mon=temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a193b929d793c4af88306041edfd4d529">smon</a>;
<a name="l00908"></a>00908                                 t-&gt;tm_year=(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#afb9081e26e6d1d876caab0819faba099">syear</a>-1900);
<a name="l00909"></a>00909                                 t-&gt;tm_isdst=-1;
<a name="l00910"></a>00910                                 start_time=mktime(t);
<a name="l00911"></a>00911                                 <span class="keywordflow">break</span>;
<a name="l00912"></a>00912                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#afdb343e1ee0ba1e9d1c412c094593ae4">DATERANGE_MONTH_DATE</a>:
<a name="l00913"></a>00913                                 start_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(test_time_year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a193b929d793c4af88306041edfd4d529">smon</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a2b11fe1c52944be6794b98970ec4e1c4">smday</a>);
<a name="l00914"></a>00914                                 <span class="keywordflow">break</span>;
<a name="l00915"></a>00915                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a475d446034173a132dec339e1ea9bc8a">DATERANGE_MONTH_DAY</a>:
<a name="l00916"></a>00916                                 start_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(test_time_year,test_time_mon,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a2b11fe1c52944be6794b98970ec4e1c4">smday</a>);
<a name="l00917"></a>00917                                 <span class="keywordflow">break</span>;
<a name="l00918"></a>00918                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#aea35d5146a0a7a0931bf4558435bb11a">DATERANGE_MONTH_WEEK_DAY</a>:
<a name="l00919"></a>00919                                 start_time=<a class="code" href="base_2utils_8c.html#aa379bf40b48f3ea5f97d2cf69154a472">calculate_time_from_weekday_of_month</a>(test_time_year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a193b929d793c4af88306041edfd4d529">smon</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a043846fe0bcb8e61f2860508391f4f4b">swday</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ac4f374102495f80f724c0e9fe1072eaa">swday_offset</a>);
<a name="l00920"></a>00920                                 <span class="keywordflow">break</span>;
<a name="l00921"></a>00921                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a3de3abee01597af4482790b789c64ce9">DATERANGE_WEEK_DAY</a>:
<a name="l00922"></a>00922                                 start_time=<a class="code" href="base_2utils_8c.html#aa379bf40b48f3ea5f97d2cf69154a472">calculate_time_from_weekday_of_month</a>(test_time_year,test_time_mon,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a043846fe0bcb8e61f2860508391f4f4b">swday</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ac4f374102495f80f724c0e9fe1072eaa">swday_offset</a>);
<a name="l00923"></a>00923                                 <span class="keywordflow">break</span>;
<a name="l00924"></a>00924                         <span class="keywordflow">default</span>:
<a name="l00925"></a>00925                                 <span class="keywordflow">continue</span>;
<a name="l00926"></a>00926                                 <span class="keywordflow">break</span>;
<a name="l00927"></a>00927                                 }
<a name="l00928"></a>00928 
<a name="l00929"></a>00929                         <span class="comment">/* get the end time */</span>
<a name="l00930"></a>00930                         <span class="keywordflow">switch</span>(daterange_type){
<a name="l00931"></a>00931                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a1c9ce3548ed47cffbe81e5c9f7406aa1">DATERANGE_CALENDAR_DATE</a>:
<a name="l00932"></a>00932                                 t-&gt;tm_sec=0;
<a name="l00933"></a>00933                                 t-&gt;tm_min=0;
<a name="l00934"></a>00934                                 t-&gt;tm_hour=0;
<a name="l00935"></a>00935                                 t-&gt;tm_wday=0;
<a name="l00936"></a>00936                                 t-&gt;tm_mday=temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a>;
<a name="l00937"></a>00937                                 t-&gt;tm_mon=temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a>;
<a name="l00938"></a>00938                                 t-&gt;tm_year=(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aced1e14d0e382f397d41fe9d186af11b">eyear</a>-1900);
<a name="l00939"></a>00939                                 t-&gt;tm_isdst=-1;
<a name="l00940"></a>00940                                 end_time=mktime(t);
<a name="l00941"></a>00941                                 <span class="keywordflow">break</span>;
<a name="l00942"></a>00942                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#afdb343e1ee0ba1e9d1c412c094593ae4">DATERANGE_MONTH_DATE</a>:
<a name="l00943"></a>00943                                 year=test_time_year;
<a name="l00944"></a>00944                                 end_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a>);
<a name="l00945"></a>00945                                 <span class="comment">/* advance a year if necessary: august 2 - february 5 */</span>
<a name="l00946"></a>00946                                 <span class="keywordflow">if</span>(end_time&lt;start_time){
<a name="l00947"></a>00947                                         year++;
<a name="l00948"></a>00948                                         end_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a>);
<a name="l00949"></a>00949                                         }
<a name="l00950"></a>00950                                 <span class="keywordflow">break</span>;
<a name="l00951"></a>00951                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a475d446034173a132dec339e1ea9bc8a">DATERANGE_MONTH_DAY</a>:
<a name="l00952"></a>00952                                 end_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(test_time_year,test_time_mon,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a>);
<a name="l00953"></a>00953                                 <span class="keywordflow">break</span>;
<a name="l00954"></a>00954                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#aea35d5146a0a7a0931bf4558435bb11a">DATERANGE_MONTH_WEEK_DAY</a>:
<a name="l00955"></a>00955                                 year=test_time_year;
<a name="l00956"></a>00956                                 end_time=<a class="code" href="base_2utils_8c.html#aa379bf40b48f3ea5f97d2cf69154a472">calculate_time_from_weekday_of_month</a>(year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#abc5090255e6001c7b681566af5150003">ewday</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a3582804a2df2c892d8d1e2f059f67230">ewday_offset</a>);
<a name="l00957"></a>00957                                 <span class="comment">/* advance a year if necessary: thursday 2 august - monday 3 february */</span>
<a name="l00958"></a>00958                                 <span class="keywordflow">if</span>(end_time&lt;start_time){
<a name="l00959"></a>00959                                         year++;
<a name="l00960"></a>00960                                         end_time=<a class="code" href="base_2utils_8c.html#aa379bf40b48f3ea5f97d2cf69154a472">calculate_time_from_weekday_of_month</a>(year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#abc5090255e6001c7b681566af5150003">ewday</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a3582804a2df2c892d8d1e2f059f67230">ewday_offset</a>);
<a name="l00961"></a>00961                                         }
<a name="l00962"></a>00962                                 <span class="keywordflow">break</span>;
<a name="l00963"></a>00963                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a3de3abee01597af4482790b789c64ce9">DATERANGE_WEEK_DAY</a>:
<a name="l00964"></a>00964                                 end_time=<a class="code" href="base_2utils_8c.html#aa379bf40b48f3ea5f97d2cf69154a472">calculate_time_from_weekday_of_month</a>(test_time_year,test_time_mon,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#abc5090255e6001c7b681566af5150003">ewday</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a3582804a2df2c892d8d1e2f059f67230">ewday_offset</a>);
<a name="l00965"></a>00965                                 <span class="keywordflow">break</span>;
<a name="l00966"></a>00966                         <span class="keywordflow">default</span>:
<a name="l00967"></a>00967                                 <span class="keywordflow">continue</span>;
<a name="l00968"></a>00968                                 <span class="keywordflow">break</span>;
<a name="l00969"></a>00969                                 }
<a name="l00970"></a>00970 
<a name="l00971"></a>00971 <span class="preprocessor">#ifdef TEST_TIMEPERIODS_A</span>
<a name="l00972"></a>00972 <span class="preprocessor"></span>                        printf(<span class="stringliteral">&quot;START:    %lu = %s&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)start_time,ctime(&amp;start_time));
<a name="l00973"></a>00973                         printf(<span class="stringliteral">&quot;END:      %lu = %s&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)end_time,ctime(&amp;end_time));
<a name="l00974"></a>00974 <span class="preprocessor">#endif</span>
<a name="l00975"></a>00975 <span class="preprocessor"></span>
<a name="l00976"></a>00976                         <span class="comment">/* start date was bad, so skip this date range */</span>
<a name="l00977"></a>00977                         <span class="keywordflow">if</span>((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)start_time==0L)
<a name="l00978"></a>00978                                 <span class="keywordflow">continue</span>;
<a name="l00979"></a>00979 
<a name="l00980"></a>00980                         <span class="comment">/* end date was bad - see if we can handle the error */</span>
<a name="l00981"></a>00981                         <span class="keywordflow">if</span>((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)end_time==0L){
<a name="l00982"></a>00982                                 <span class="keywordflow">switch</span>(daterange_type){
<a name="l00983"></a>00983                                 <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a1c9ce3548ed47cffbe81e5c9f7406aa1">DATERANGE_CALENDAR_DATE</a>:
<a name="l00984"></a>00984                                         <span class="keywordflow">continue</span>;
<a name="l00985"></a>00985                                         <span class="keywordflow">break</span>;
<a name="l00986"></a>00986                                 <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#afdb343e1ee0ba1e9d1c412c094593ae4">DATERANGE_MONTH_DATE</a>:
<a name="l00987"></a>00987                                         <span class="comment">/* end date can&#39;t be helped, so skip it */</span>
<a name="l00988"></a>00988                                         <span class="keywordflow">if</span>(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a>&lt;0)
<a name="l00989"></a>00989                                                 <span class="keywordflow">continue</span>;
<a name="l00990"></a>00990 
<a name="l00991"></a>00991                                         <span class="comment">/* else end date slipped past end of month, so use last day of month as end date */</span>
<a name="l00992"></a>00992                                         <span class="comment">/* use same year calculated above */</span>
<a name="l00993"></a>00993                                         end_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a>,-1);
<a name="l00994"></a>00994                                         <span class="keywordflow">break</span>;
<a name="l00995"></a>00995                                 <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a475d446034173a132dec339e1ea9bc8a">DATERANGE_MONTH_DAY</a>:
<a name="l00996"></a>00996                                         <span class="comment">/* end date can&#39;t be helped, so skip it */</span>
<a name="l00997"></a>00997                                         <span class="keywordflow">if</span>(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a>&lt;0)
<a name="l00998"></a>00998                                                 <span class="keywordflow">continue</span>;
<a name="l00999"></a>00999 
<a name="l01000"></a>01000                                         <span class="comment">/* else end date slipped past end of month, so use last day of month as end date */</span>
<a name="l01001"></a>01001                                         end_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(test_time_year,test_time_mon,-1);
<a name="l01002"></a>01002                                         <span class="keywordflow">break</span>;
<a name="l01003"></a>01003                                 <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#aea35d5146a0a7a0931bf4558435bb11a">DATERANGE_MONTH_WEEK_DAY</a>:
<a name="l01004"></a>01004                                         <span class="comment">/* end date can&#39;t be helped, so skip it */</span>
<a name="l01005"></a>01005                                         <span class="keywordflow">if</span>(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a3582804a2df2c892d8d1e2f059f67230">ewday_offset</a>&lt;0)
<a name="l01006"></a>01006                                                 <span class="keywordflow">continue</span>;
<a name="l01007"></a>01007 
<a name="l01008"></a>01008                                         <span class="comment">/* else end date slipped past end of month, so use last day of month as end date */</span>
<a name="l01009"></a>01009                                         <span class="comment">/* use same year calculated above */</span>
<a name="l01010"></a>01010                                         end_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,test_time_mon,-1);
<a name="l01011"></a>01011                                         <span class="keywordflow">break</span>;
<a name="l01012"></a>01012                                 <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a3de3abee01597af4482790b789c64ce9">DATERANGE_WEEK_DAY</a>:
<a name="l01013"></a>01013                                         <span class="comment">/* end date can&#39;t be helped, so skip it */</span>
<a name="l01014"></a>01014                                         <span class="keywordflow">if</span>(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a3582804a2df2c892d8d1e2f059f67230">ewday_offset</a>&lt;0)
<a name="l01015"></a>01015                                                 <span class="keywordflow">continue</span>;
<a name="l01016"></a>01016 
<a name="l01017"></a>01017                                         <span class="comment">/* else end date slipped past end of month, so use last day of month as end date */</span>
<a name="l01018"></a>01018                                         end_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(test_time_year,test_time_mon,-1);
<a name="l01019"></a>01019                                         <span class="keywordflow">break</span>;
<a name="l01020"></a>01020                                 <span class="keywordflow">default</span>:
<a name="l01021"></a>01021                                         <span class="keywordflow">continue</span>;
<a name="l01022"></a>01022                                         <span class="keywordflow">break</span>;
<a name="l01023"></a>01023                                         }
<a name="l01024"></a>01024                                 }
<a name="l01025"></a>01025 
<a name="l01026"></a>01026                         <span class="comment">/* calculate skip date start (and end) */</span>
<a name="l01027"></a>01027                         <span class="keywordflow">if</span>(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ab8f50f350863005f22bc2e5e807aee50">skip_interval</a>&gt;1){
<a name="l01028"></a>01028                                 <span class="comment">/* skip start date must be before test time */</span>
<a name="l01029"></a>01029                                 <span class="keywordflow">if</span>(start_time&gt;test_time)
<a name="l01030"></a>01030                                         <span class="keywordflow">continue</span>;
<a name="l01031"></a>01031 
<a name="l01032"></a>01032                                 <span class="comment">/* check if interval is across dlst change and gets the compensation */</span>
<a name="l01033"></a>01033                                 shift=<a class="code" href="base_2utils_8c.html#af8827c20db029bc74ce240a818a2a800">get_dlst_shift</a>(&amp;start_time,&amp;midnight);
<a name="l01034"></a>01034 
<a name="l01035"></a>01035                                 <span class="comment">/* how many days have passed between skip start date and test time? */</span>
<a name="l01036"></a>01036                                 days=(shift+midnight-(<span class="keywordtype">unsigned</span> long)start_time)/(3600*24);
<a name="l01037"></a>01037 
<a name="l01038"></a>01038                                 <span class="comment">/* if test date doesn&#39;t fall on a skip interval day, bail out early */</span>
<a name="l01039"></a>01039                                 <span class="keywordflow">if</span>((days % temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ab8f50f350863005f22bc2e5e807aee50">skip_interval</a>)!=0)
<a name="l01040"></a>01040                                         <span class="keywordflow">continue</span>;
<a name="l01041"></a>01041 
<a name="l01042"></a>01042                                 <span class="comment">/* use midnight of test date as start time */</span>
<a name="l01043"></a>01043                                 <span class="keywordflow">else</span>
<a name="l01044"></a>01044                                         start_time=(time_t)midnight;
<a name="l01045"></a>01045 
<a name="l01046"></a>01046                                 <span class="comment">/* if skipping range has no end, use test date as end */</span>
<a name="l01047"></a>01047                                 <span class="keywordflow">if</span>((daterange_type==<a class="code" href="include_2common_8h.html#a1c9ce3548ed47cffbe81e5c9f7406aa1">DATERANGE_CALENDAR_DATE</a>) &amp;&amp; (<a class="code" href="base_2utils_8c.html#a79145211870703746ce61d4a9ca23a3d">is_daterange_single_day</a>(temp_daterange)==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>))
<a name="l01048"></a>01048                                         end_time=(time_t)midnight;
<a name="l01049"></a>01049                                 }
<a name="l01050"></a>01050 
<a name="l01051"></a>01051 <span class="preprocessor">#ifdef TEST_TIMEPERIODS_A</span>
<a name="l01052"></a>01052 <span class="preprocessor"></span>                        printf(<span class="stringliteral">&quot;NEW START:    %lu = %s&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)start_time,ctime(&amp;start_time));
<a name="l01053"></a>01053                         printf(<span class="stringliteral">&quot;NEW END:      %lu = %s&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)end_time,ctime(&amp;end_time));
<a name="l01054"></a>01054                         printf(<span class="stringliteral">&quot;%d DAYS PASSED\n&quot;</span>,days);
<a name="l01055"></a>01055                         printf(<span class="stringliteral">&quot;DLST SHIFT:   %d&quot;</span>,shift);
<a name="l01056"></a>01056 <span class="preprocessor">#endif</span>
<a name="l01057"></a>01057 <span class="preprocessor"></span>
<a name="l01058"></a>01058                         <span class="comment">/* time falls into the range of days */</span>
<a name="l01059"></a>01059                         <span class="keywordflow">if</span>(midnight&gt;=start_time &amp;&amp; midnight&lt;=end_time)
<a name="l01060"></a>01060                                 found_match=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01061"></a>01061 
<a name="l01062"></a>01062                         <span class="comment">/* found a day match, so see if time ranges are good */</span>
<a name="l01063"></a>01063                         <span class="keywordflow">if</span>(found_match==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l01064"></a>01064 
<a name="l01065"></a>01065                                 <span class="keywordflow">for</span>(temp_timerange=temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a0fe4e4fa1fab70183ea923e2b4bdef5b">times</a>;temp_timerange!=NULL;temp_timerange=temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#afd9ea6d61bbc09f855fa17b65e06b8c0">next</a>){
<a name="l01066"></a>01066 
<a name="l01067"></a>01067                                         <span class="comment">/* ranges with start/end of zero mean exlude this day */</span>
<a name="l01068"></a>01068                                         <span class="keywordflow">if</span>(temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#a472faf570efd10d46cc3cb49bbed58b4">range_start</a>==0 &amp;&amp; temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#a399206befe1b5e7efc7f8215f3f23fbd">range_end</a>==0){
<a name="l01069"></a>01069 <span class="preprocessor">#ifdef TEST_TIMEPERIODS_A</span>
<a name="l01070"></a>01070 <span class="preprocessor"></span>                                                printf(<span class="stringliteral">&quot;0 MINUTE RANGE EXCLUSION\n&quot;</span>);
<a name="l01071"></a>01071 <span class="preprocessor">#endif</span>
<a name="l01072"></a>01072 <span class="preprocessor"></span>                                                <span class="keywordflow">continue</span>;
<a name="l01073"></a>01073                                                 }
<a name="l01074"></a>01074 
<a name="l01075"></a>01075                                         day_range_start=(time_t)(midnight + temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#a472faf570efd10d46cc3cb49bbed58b4">range_start</a>);
<a name="l01076"></a>01076                                         day_range_end=(time_t)(midnight + temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#a399206befe1b5e7efc7f8215f3f23fbd">range_end</a>);
<a name="l01077"></a>01077 
<a name="l01078"></a>01078 <span class="preprocessor">#ifdef TEST_TIMEPERIODS_A</span>
<a name="l01079"></a>01079 <span class="preprocessor"></span>                                        printf(<span class="stringliteral">&quot;  RANGE START: %lu (%lu) = %s&quot;</span>,temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#a472faf570efd10d46cc3cb49bbed58b4">range_start</a>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)day_range_start,ctime(&amp;day_range_start));
<a name="l01080"></a>01080                                         printf(<span class="stringliteral">&quot;  RANGE END:   %lu (%lu) = %s&quot;</span>,temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#a399206befe1b5e7efc7f8215f3f23fbd">range_end</a>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)day_range_end,ctime(&amp;day_range_end));
<a name="l01081"></a>01081 <span class="preprocessor">#endif</span>
<a name="l01082"></a>01082 <span class="preprocessor"></span>
<a name="l01083"></a>01083                                         <span class="comment">/* if the user-specified time falls in this range, return with a positive result */</span>
<a name="l01084"></a>01084                                         <span class="keywordflow">if</span>(test_time&gt;=day_range_start &amp;&amp; test_time&lt;=day_range_end)
<a name="l01085"></a>01085                                                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l01086"></a>01086                                         }
<a name="l01087"></a>01087 
<a name="l01088"></a>01088                                 <span class="comment">/* no match, so bail with error */</span>
<a name="l01089"></a>01089                                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l01090"></a>01090                                 }
<a name="l01091"></a>01091                         }
<a name="l01092"></a>01092                 }
<a name="l01093"></a>01093 
<a name="l01094"></a>01094 
<a name="l01095"></a>01095         <span class="comment">/**** check normal, weekly rotating schedule last ****/</span>
<a name="l01096"></a>01096 
<a name="l01097"></a>01097         <span class="comment">/* check weekday time ranges */</span>
<a name="l01098"></a>01098         <span class="keywordflow">for</span>(temp_timerange=tperiod-&gt;<a class="code" href="structtimeperiod__struct.html#a80a66ae6bf3d3514a1f10b4d4f62cfd0">days</a>[test_time_wday];temp_timerange!=NULL;temp_timerange=temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#afd9ea6d61bbc09f855fa17b65e06b8c0">next</a>){
<a name="l01099"></a>01099 
<a name="l01100"></a>01100                 day_range_start=(time_t)(midnight + temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#a472faf570efd10d46cc3cb49bbed58b4">range_start</a>);
<a name="l01101"></a>01101                 day_range_end=(time_t)(midnight + temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#a399206befe1b5e7efc7f8215f3f23fbd">range_end</a>);
<a name="l01102"></a>01102 
<a name="l01103"></a>01103                 <span class="comment">/* if the user-specified time falls in this range, return with a positive result */</span>
<a name="l01104"></a>01104                 <span class="keywordflow">if</span>(test_time&gt;=day_range_start &amp;&amp; test_time&lt;=day_range_end)
<a name="l01105"></a>01105                         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l01106"></a>01106                 }
<a name="l01107"></a>01107 
<a name="l01108"></a>01108         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l01109"></a>01109         }
<a name="l01110"></a>01110 
<a name="l01111"></a>01111 
<a name="l01112"></a>01112 
<a name="l01113"></a>01113 <span class="comment">/*#define TEST_TIMEPERIODS_B 1*/</span>
<a name="l01114"></a>01114 
<a name="l01115"></a>01115 <span class="comment">/* Separate this out from public get_next_valid_time for testing, so we can mock current_time */</span>
<a name="l01116"></a>01116 
<a name="l01117"></a><a class="code" href="base_2utils_8c.html#a749cae5cd9c695f214a89f5b6b969cc5">01117</a> <span class="keywordtype">void</span> <a class="code" href="base_2utils_8c.html#a749cae5cd9c695f214a89f5b6b969cc5">_get_next_valid_time</a>(time_t pref_time, time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>, time_t *valid_time, <a class="code" href="structtimeperiod__struct.html">timeperiod</a> *tperiod){
<a name="l01118"></a>01118         time_t preferred_time=(time_t)0L;
<a name="l01119"></a>01119         preferred_time=(pref_time&lt;<a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>)?current_time:pref_time;
<a name="l01120"></a>01120 
<a name="l01121"></a>01121         <span class="keywordflow">if</span>(tperiod==NULL){
<a name="l01122"></a>01122                 *valid_time=preferred_time;
<a name="l01123"></a>01123                 <span class="keywordflow">return</span>;
<a name="l01124"></a>01124                 }
<a name="l01125"></a>01125 
<a name="l01126"></a>01126         <span class="keywordflow">if</span>(<a class="code" href="base_2utils_8c.html#a49602563f5f03788d56b2d06d2c72bfb">check_time_against_period</a>(preferred_time,tperiod)==<a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>){
<a name="l01127"></a>01127 <span class="preprocessor">#ifdef TEST_TIMEPERIODS_B</span>
<a name="l01128"></a>01128 <span class="preprocessor"></span>                printf(<span class="stringliteral">&quot;PREF TIME IS VALID\n&quot;</span>);
<a name="l01129"></a>01129 <span class="preprocessor">#endif</span>
<a name="l01130"></a>01130 <span class="preprocessor"></span>                *valid_time=preferred_time;
<a name="l01131"></a>01131                 <span class="keywordflow">return</span>;
<a name="l01132"></a>01132                 }
<a name="l01133"></a>01133 
<a name="l01134"></a>01134         <a class="code" href="base_2utils_8c.html#a3c98f089e822628d34aa086f54949217">get_earliest_time</a>(preferred_time,valid_time,current_time,tperiod,0);
<a name="l01135"></a>01135 }
<a name="l01136"></a>01136 
<a name="l01137"></a><a class="code" href="icinga_8h.html#a281331fcf63656fd758408d26b036247">01137</a> <span class="keywordtype">void</span> <a class="code" href="base_2utils_8c.html#a3c98f089e822628d34aa086f54949217">get_earliest_time</a>(time_t pref_time, time_t *valid_time, time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>, <a class="code" href="structtimeperiod__struct.html">timeperiod</a> *tperiod,<span class="keywordtype">int</span> level){
<a name="l01138"></a>01138 
<a name="l01139"></a>01139         time_t <a class="code" href="histogram_8c.html#af52fb2a1ec12b79ceb207523a77e1cf0">earliest_time</a>;
<a name="l01140"></a>01140         <a class="code" href="structtimeperiodexclusion__struct.html">timeperiodexclusion</a> *temp_timeperiodexclusion=NULL;
<a name="l01141"></a>01141         <a class="code" href="structtimeperiodexclusion__struct.html">timeperiodexclusion</a> *first_timeperiodexclusion=NULL;
<a name="l01142"></a>01142 
<a name="l01143"></a>01143         <span class="keywordflow">if</span>((level%2) == 0){
<a name="l01144"></a>01144                 <a class="code" href="base_2utils_8c.html#adf134427b3a4a610ba13da4f38d4effd">_get_next_valid_time_per_timeperiod</a>(pref_time,&amp;earliest_time,current_time,tperiod);
<a name="l01145"></a>01145                 <span class="keywordflow">if</span>(*valid_time == 0)
<a name="l01146"></a>01146                         *valid_time=<a class="code" href="histogram_8c.html#af52fb2a1ec12b79ceb207523a77e1cf0">earliest_time</a>;
<a name="l01147"></a>01147                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(earliest_time&lt;*valid_time)
<a name="l01148"></a>01148                         *valid_time=<a class="code" href="histogram_8c.html#af52fb2a1ec12b79ceb207523a77e1cf0">earliest_time</a>;
<a name="l01149"></a>01149         }
<a name="l01150"></a>01150         <span class="keywordflow">else</span>{
<a name="l01151"></a>01151                 <a class="code" href="base_2utils_8c.html#a8d85d50d4d06cade09bfcbb829393ee9">get_min_invalid_time_per_timeperiod</a>(pref_time,&amp;earliest_time,current_time,tperiod);
<a name="l01152"></a>01152                 <span class="keywordflow">if</span>(*valid_time == 0)
<a name="l01153"></a>01153                         *valid_time=<a class="code" href="histogram_8c.html#af52fb2a1ec12b79ceb207523a77e1cf0">earliest_time</a>;
<a name="l01154"></a>01154                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(earliest_time&lt;*valid_time)
<a name="l01155"></a>01155                         *valid_time=earliest_time+1;
<a name="l01156"></a>01156         }
<a name="l01157"></a>01157 
<a name="l01158"></a>01158         first_timeperiodexclusion=tperiod-&gt;<a class="code" href="structtimeperiod__struct.html#a318ee4afd605158f3335a7e32d86dc39">exclusions</a>;
<a name="l01159"></a>01159         tperiod-&gt;<a class="code" href="structtimeperiod__struct.html#a318ee4afd605158f3335a7e32d86dc39">exclusions</a>=NULL;
<a name="l01160"></a>01160         <span class="keywordflow">for</span>(temp_timeperiodexclusion=first_timeperiodexclusion;temp_timeperiodexclusion!=NULL;temp_timeperiodexclusion=temp_timeperiodexclusion-&gt;<a class="code" href="structtimeperiodexclusion__struct.html#ada739dcf291c6a8db98b43211f28ab54">next</a>){
<a name="l01161"></a>01161                 <a class="code" href="base_2utils_8c.html#a3c98f089e822628d34aa086f54949217">get_earliest_time</a>(pref_time,valid_time,current_time,temp_timeperiodexclusion-&gt;<a class="code" href="structtimeperiodexclusion__struct.html#a0a45daadc082654ab3e5bb517ed9015e">timeperiod_ptr</a>,level+1);
<a name="l01162"></a>01162         }
<a name="l01163"></a>01163         tperiod-&gt;<a class="code" href="structtimeperiod__struct.html#a318ee4afd605158f3335a7e32d86dc39">exclusions</a>=first_timeperiodexclusion;
<a name="l01164"></a>01164 }
<a name="l01165"></a>01165 
<a name="l01166"></a><a class="code" href="icinga_8h.html#a06d3852b676c3e8a34e3a9d051365685">01166</a> <span class="keywordtype">void</span> <a class="code" href="base_2utils_8c.html#adf134427b3a4a610ba13da4f38d4effd">_get_next_valid_time_per_timeperiod</a>(time_t pref_time, time_t *valid_time, time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>, <a class="code" href="structtimeperiod__struct.html">timeperiod</a> *tperiod){
<a name="l01167"></a>01167         time_t preferred_time=(time_t)0L;
<a name="l01168"></a>01168         <a class="code" href="structtimerange__struct.html">timerange</a> *temp_timerange;
<a name="l01169"></a>01169         <a class="code" href="structdaterange__struct.html">daterange</a> *temp_daterange;
<a name="l01170"></a>01170         time_t midnight=0L;
<a name="l01171"></a>01171         <span class="keyword">struct </span>tm *t, tm_s;
<a name="l01172"></a>01172         time_t day_start=(time_t)0L;
<a name="l01173"></a>01173         time_t day_range_start=(time_t)0L;
<a name="l01174"></a>01174         time_t day_range_end=(time_t)0L;
<a name="l01175"></a>01175         time_t <a class="code" href="cmd_8c.html#ad20e89e0c86aa812dc3a8e2fb7b5777b">start_time</a>=(time_t)0L;
<a name="l01176"></a>01176         time_t <a class="code" href="cmd_8c.html#a1e324d62e65642694c00de363bf8a8ba">end_time</a>=(time_t)0L;
<a name="l01177"></a>01177         <span class="keywordtype">int</span> have_earliest_time=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01178"></a>01178         time_t <a class="code" href="histogram_8c.html#af52fb2a1ec12b79ceb207523a77e1cf0">earliest_time</a>=(time_t)0L;
<a name="l01179"></a>01179         time_t earliest_day=(time_t)0L;
<a name="l01180"></a>01180         time_t potential_time=(time_t)0L;
<a name="l01181"></a>01181         <span class="keywordtype">int</span> weekday=0;
<a name="l01182"></a>01182         <span class="keywordtype">int</span> has_looped=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01183"></a>01183         <span class="keywordtype">int</span> days_into_the_future=0;
<a name="l01184"></a>01184         <span class="keywordtype">int</span> daterange_type=0;
<a name="l01185"></a>01185         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> days=0L;
<a name="l01186"></a>01186         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> advance_interval=0L;
<a name="l01187"></a>01187         <span class="keywordtype">int</span> year=0; <span class="comment">/* new */</span>
<a name="l01188"></a>01188         <span class="keywordtype">int</span> month=0; <span class="comment">/* new */</span>
<a name="l01189"></a>01189 
<a name="l01190"></a>01190         <span class="keywordtype">int</span> pref_time_year=0;
<a name="l01191"></a>01191         <span class="keywordtype">int</span> pref_time_mon=0;
<a name="l01192"></a>01192         <span class="keywordtype">int</span> pref_time_mday=0;
<a name="l01193"></a>01193         <span class="keywordtype">int</span> pref_time_wday=0;
<a name="l01194"></a>01194         <span class="keywordtype">int</span> current_time_year=0;
<a name="l01195"></a>01195         <span class="keywordtype">int</span> current_time_mon=0;
<a name="l01196"></a>01196         <span class="keywordtype">int</span> current_time_mday=0;
<a name="l01197"></a>01197         <span class="keywordtype">int</span> current_time_wday=0;
<a name="l01198"></a>01198         <span class="keywordtype">int</span> shift;
<a name="l01199"></a>01199 
<a name="l01200"></a>01200         <span class="comment">/* preferred time must be now or in the future */</span>
<a name="l01201"></a>01201         preferred_time=pref_time;
<a name="l01202"></a>01202 
<a name="l01203"></a>01203         <span class="comment">/* if no timeperiod, go with preferred time */</span>
<a name="l01204"></a>01204         <span class="keywordflow">if</span>(tperiod==NULL){
<a name="l01205"></a>01205                 *valid_time=preferred_time;
<a name="l01206"></a>01206                 <span class="keywordflow">return</span>;
<a name="l01207"></a>01207                 }
<a name="l01208"></a>01208 
<a name="l01209"></a>01209         <span class="comment">/* calculate the start of the day (midnight, 00:00 hours) of preferred time */</span>
<a name="l01210"></a>01210         t = localtime_r(&amp;preferred_time, &amp;tm_s);
<a name="l01211"></a>01211         t-&gt;tm_sec=0;
<a name="l01212"></a>01212         t-&gt;tm_min=0;
<a name="l01213"></a>01213         t-&gt;tm_hour=0;
<a name="l01214"></a>01214         midnight=(<span class="keywordtype">unsigned</span> long)mktime(t);
<a name="l01215"></a>01215 
<a name="l01216"></a>01216         <span class="comment">/* save pref time values for later */</span>
<a name="l01217"></a>01217         pref_time_year=t-&gt;tm_year;
<a name="l01218"></a>01218         pref_time_mon=t-&gt;tm_mon;
<a name="l01219"></a>01219         pref_time_mday=t-&gt;tm_mday;
<a name="l01220"></a>01220         pref_time_wday=t-&gt;tm_wday;
<a name="l01221"></a>01221 
<a name="l01222"></a>01222         <span class="comment">/* save current time values for later */</span>
<a name="l01223"></a>01223         t = localtime_r(&amp;current_time, &amp;tm_s);
<a name="l01224"></a>01224         current_time_year=t-&gt;tm_year;
<a name="l01225"></a>01225         current_time_mon=t-&gt;tm_mon;
<a name="l01226"></a>01226         current_time_mday=t-&gt;tm_mday;
<a name="l01227"></a>01227         current_time_wday=t-&gt;tm_wday;
<a name="l01228"></a>01228 
<a name="l01229"></a>01229 <span class="preprocessor">#ifdef TEST_TIMEPERIODS_B</span>
<a name="l01230"></a>01230 <span class="preprocessor"></span>        printf(<span class="stringliteral">&quot;PREF TIME:    %lu = %s&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)preferred_time,ctime(&amp;preferred_time));
<a name="l01231"></a>01231         printf(<span class="stringliteral">&quot;CURRENT TIME: %lu = %s&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)current_time,ctime(&amp;current_time));
<a name="l01232"></a>01232         printf(<span class="stringliteral">&quot;PREF YEAR:    %d, MON: %d, MDAY: %d, WDAY: %d\n&quot;</span>,pref_time_year,pref_time_mon,pref_time_mday,pref_time_wday);
<a name="l01233"></a>01233         printf(<span class="stringliteral">&quot;CURRENT YEAR: %d, MON: %d, MDAY: %d, WDAY: %d\n&quot;</span>,current_time_year,current_time_mon,current_time_mday,current_time_wday);
<a name="l01234"></a>01234 <span class="preprocessor">#endif</span>
<a name="l01235"></a>01235 <span class="preprocessor"></span>
<a name="l01236"></a>01236         <span class="comment">/**** check exceptions (in this timeperiod definition) first ****/</span>
<a name="l01237"></a>01237         <span class="keywordflow">for</span>(daterange_type=0;daterange_type&lt;<a class="code" href="include_2common_8h.html#a09487af157aaf6684304caff29fc563c">DATERANGE_TYPES</a>;daterange_type++){
<a name="l01238"></a>01238 
<a name="l01239"></a>01239 <span class="preprocessor">#ifdef TEST_TIMEPERIODS_B</span>
<a name="l01240"></a>01240 <span class="preprocessor"></span>                printf(<span class="stringliteral">&quot;TYPE: %d\n&quot;</span>,daterange_type);
<a name="l01241"></a>01241 <span class="preprocessor">#endif</span>
<a name="l01242"></a>01242 <span class="preprocessor"></span>
<a name="l01243"></a>01243                 <span class="keywordflow">for</span>(temp_daterange=tperiod-&gt;<a class="code" href="structtimeperiod__struct.html#a3e17bec1cdcefe9eeaa79851124e2315">exceptions</a>[daterange_type];temp_daterange!=NULL;temp_daterange=temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aee7ef6e3b7ac927f7455026c5c908148">next</a>){
<a name="l01244"></a>01244 
<a name="l01245"></a>01245                         <span class="comment">/* get the start time */</span>
<a name="l01246"></a>01246                         <span class="keywordflow">switch</span>(daterange_type){
<a name="l01247"></a>01247                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a1c9ce3548ed47cffbe81e5c9f7406aa1">DATERANGE_CALENDAR_DATE</a>: <span class="comment">/* 2009-08-11 */</span>
<a name="l01248"></a>01248                                 t-&gt;tm_sec=0;
<a name="l01249"></a>01249                                 t-&gt;tm_min=0;
<a name="l01250"></a>01250                                 t-&gt;tm_hour=0;
<a name="l01251"></a>01251                                 t-&gt;tm_mday=temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a2b11fe1c52944be6794b98970ec4e1c4">smday</a>;
<a name="l01252"></a>01252                                 t-&gt;tm_mon=temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a193b929d793c4af88306041edfd4d529">smon</a>;
<a name="l01253"></a>01253                                 t-&gt;tm_year=(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#afb9081e26e6d1d876caab0819faba099">syear</a>-1900);
<a name="l01254"></a>01254                                 t-&gt;tm_isdst=-1;
<a name="l01255"></a>01255                                 start_time=mktime(t);
<a name="l01256"></a>01256                                 <span class="keywordflow">break</span>;
<a name="l01257"></a>01257                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#afdb343e1ee0ba1e9d1c412c094593ae4">DATERANGE_MONTH_DATE</a>:  <span class="comment">/* january 1 */</span>
<a name="l01258"></a>01258                                 <span class="comment">/* what year should we use? */</span>
<a name="l01259"></a>01259                                 year=(pref_time_year &lt; current_time_year)?current_time_year:pref_time_year;
<a name="l01260"></a>01260                                 <span class="comment">/* advance an additional year if we already passed the end month date */</span>
<a name="l01261"></a>01261                                 <span class="keywordflow">if</span>((temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a> &lt; current_time_mon) || ((temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a> == current_time_mon) &amp;&amp; temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a> &lt; current_time_mday))
<a name="l01262"></a>01262                                         year++;
<a name="l01263"></a>01263                                 start_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a193b929d793c4af88306041edfd4d529">smon</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a2b11fe1c52944be6794b98970ec4e1c4">smday</a>);
<a name="l01264"></a>01264                                 <span class="keywordflow">break</span>;
<a name="l01265"></a>01265                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a475d446034173a132dec339e1ea9bc8a">DATERANGE_MONTH_DAY</a>:  <span class="comment">/* day 3 */</span>
<a name="l01266"></a>01266                                 <span class="comment">/* what year should we use? */</span>
<a name="l01267"></a>01267                                 year=(pref_time_year &lt; current_time_year)?current_time_year:pref_time_year;
<a name="l01268"></a>01268                                 <span class="comment">/* use current month */</span>
<a name="l01269"></a>01269                                 month=current_time_mon;
<a name="l01270"></a>01270                                 <span class="comment">/* advance an additional month (and possibly the year) if we already passed the end day of month */</span>
<a name="l01271"></a>01271                                 <span class="keywordflow">if</span>(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a> &lt; current_time_mday){
<a name="l01272"></a>01272                                         <span class="comment">/*if(month==1){*/</span>
<a name="l01273"></a>01273                                         <span class="keywordflow">if</span>(month==11){
<a name="l01274"></a>01274                                                 month=0;
<a name="l01275"></a>01275                                                 year++;
<a name="l01276"></a>01276                                                 }
<a name="l01277"></a>01277                                         <span class="keywordflow">else</span>
<a name="l01278"></a>01278                                                 month++;
<a name="l01279"></a>01279                                         }
<a name="l01280"></a>01280                                 start_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,month,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a2b11fe1c52944be6794b98970ec4e1c4">smday</a>);
<a name="l01281"></a>01281                                 <span class="keywordflow">break</span>;
<a name="l01282"></a>01282                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#aea35d5146a0a7a0931bf4558435bb11a">DATERANGE_MONTH_WEEK_DAY</a>: <span class="comment">/* thursday 2 april */</span>
<a name="l01283"></a>01283                                 <span class="comment">/* what year should we use? */</span>
<a name="l01284"></a>01284                                 year=(pref_time_year &lt; current_time_year)?current_time_year:pref_time_year;
<a name="l01285"></a>01285                                 <span class="comment">/* calculate time of specified weekday of specific month */</span>
<a name="l01286"></a>01286                                 start_time=<a class="code" href="base_2utils_8c.html#aa379bf40b48f3ea5f97d2cf69154a472">calculate_time_from_weekday_of_month</a>(year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a193b929d793c4af88306041edfd4d529">smon</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a043846fe0bcb8e61f2860508391f4f4b">swday</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ac4f374102495f80f724c0e9fe1072eaa">swday_offset</a>);
<a name="l01287"></a>01287                                 <span class="comment">/* advance to next year if we&#39;ve passed this month weekday already this year */</span>
<a name="l01288"></a>01288                                 <span class="keywordflow">if</span>(start_time &lt; preferred_time){
<a name="l01289"></a>01289                                         year++;
<a name="l01290"></a>01290                                         start_time=<a class="code" href="base_2utils_8c.html#aa379bf40b48f3ea5f97d2cf69154a472">calculate_time_from_weekday_of_month</a>(year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a193b929d793c4af88306041edfd4d529">smon</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a043846fe0bcb8e61f2860508391f4f4b">swday</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ac4f374102495f80f724c0e9fe1072eaa">swday_offset</a>);
<a name="l01291"></a>01291                                         }
<a name="l01292"></a>01292                                 <span class="keywordflow">break</span>;
<a name="l01293"></a>01293                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a3de3abee01597af4482790b789c64ce9">DATERANGE_WEEK_DAY</a>: <span class="comment">/* wednesday 1 */</span>
<a name="l01294"></a>01294                                 <span class="comment">/* what year should we use? */</span>
<a name="l01295"></a>01295                                 year=(pref_time_year &lt; current_time_year)?current_time_year:pref_time_year;
<a name="l01296"></a>01296                                 <span class="comment">/* calculate time of specified weekday of month */</span>
<a name="l01297"></a>01297                                 start_time=<a class="code" href="base_2utils_8c.html#aa379bf40b48f3ea5f97d2cf69154a472">calculate_time_from_weekday_of_month</a>(year,pref_time_mon,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a043846fe0bcb8e61f2860508391f4f4b">swday</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ac4f374102495f80f724c0e9fe1072eaa">swday_offset</a>);
<a name="l01298"></a>01298                                 <span class="comment">/* advance to next month (or year) if we&#39;ve passed this weekday of this month already */</span>
<a name="l01299"></a>01299                                 <span class="keywordflow">if</span>(start_time &lt; preferred_time){
<a name="l01300"></a>01300                                         month=pref_time_mon;
<a name="l01301"></a>01301                                         <span class="keywordflow">if</span>(month==11){
<a name="l01302"></a>01302                                                 month=0;
<a name="l01303"></a>01303                                                 year++;
<a name="l01304"></a>01304                                                 }
<a name="l01305"></a>01305                                         <span class="keywordflow">else</span>
<a name="l01306"></a>01306                                                 month++;
<a name="l01307"></a>01307                                         start_time=<a class="code" href="base_2utils_8c.html#aa379bf40b48f3ea5f97d2cf69154a472">calculate_time_from_weekday_of_month</a>(year,month,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a043846fe0bcb8e61f2860508391f4f4b">swday</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ac4f374102495f80f724c0e9fe1072eaa">swday_offset</a>);
<a name="l01308"></a>01308                                         }
<a name="l01309"></a>01309                                 <span class="keywordflow">break</span>;
<a name="l01310"></a>01310                         <span class="keywordflow">default</span>:
<a name="l01311"></a>01311                                 <span class="keywordflow">continue</span>;
<a name="l01312"></a>01312                                 <span class="keywordflow">break</span>;
<a name="l01313"></a>01313                                 }
<a name="l01314"></a>01314 
<a name="l01315"></a>01315 <span class="preprocessor">#ifdef TEST_TIMEPERIODS_B</span>
<a name="l01316"></a>01316 <span class="preprocessor"></span>                        printf(<span class="stringliteral">&quot;START TIME: %lu = %s&quot;</span>,start_time,ctime(&amp;start_time));
<a name="l01317"></a>01317 <span class="preprocessor">#endif</span>
<a name="l01318"></a>01318 <span class="preprocessor"></span>
<a name="l01319"></a>01319                         <span class="comment">/* get the end time */</span>
<a name="l01320"></a>01320                         <span class="keywordflow">switch</span>(daterange_type){
<a name="l01321"></a>01321                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a1c9ce3548ed47cffbe81e5c9f7406aa1">DATERANGE_CALENDAR_DATE</a>:
<a name="l01322"></a>01322                                 t-&gt;tm_sec=0;
<a name="l01323"></a>01323                                 t-&gt;tm_min=0;
<a name="l01324"></a>01324                                 t-&gt;tm_hour=0;
<a name="l01325"></a>01325                                 t-&gt;tm_mday=temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a>;
<a name="l01326"></a>01326                                 t-&gt;tm_mon=temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a>;
<a name="l01327"></a>01327                                 t-&gt;tm_year=(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aced1e14d0e382f397d41fe9d186af11b">eyear</a>-1900);
<a name="l01328"></a>01328                                 t-&gt;tm_isdst=-1;
<a name="l01329"></a>01329                                 end_time=mktime(t);
<a name="l01330"></a>01330                                 <span class="keywordflow">break</span>;
<a name="l01331"></a>01331                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#afdb343e1ee0ba1e9d1c412c094593ae4">DATERANGE_MONTH_DATE</a>:
<a name="l01332"></a>01332                                 <span class="comment">/* use same year as was calculated for start time above */</span>
<a name="l01333"></a>01333                                 end_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a>);
<a name="l01334"></a>01334                                 <span class="comment">/* advance a year if necessary: august 5 - feburary 2 */</span>
<a name="l01335"></a>01335                                 <span class="keywordflow">if</span>(end_time&lt;start_time){
<a name="l01336"></a>01336                                         year++;
<a name="l01337"></a>01337                                         end_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a>);
<a name="l01338"></a>01338                                         }
<a name="l01339"></a>01339                                 <span class="keywordflow">break</span>;
<a name="l01340"></a>01340                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a475d446034173a132dec339e1ea9bc8a">DATERANGE_MONTH_DAY</a>:
<a name="l01341"></a>01341                                 <span class="comment">/* use same year and month as was calculated for start time above */</span>
<a name="l01342"></a>01342                                 end_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,month,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a>+1);
<a name="l01343"></a>01343                                 <span class="keywordflow">break</span>;
<a name="l01344"></a>01344                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#aea35d5146a0a7a0931bf4558435bb11a">DATERANGE_MONTH_WEEK_DAY</a>:
<a name="l01345"></a>01345                                 <span class="comment">/* use same year as was calculated for start time above */</span>
<a name="l01346"></a>01346                                 end_time=<a class="code" href="base_2utils_8c.html#aa379bf40b48f3ea5f97d2cf69154a472">calculate_time_from_weekday_of_month</a>(year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#abc5090255e6001c7b681566af5150003">ewday</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a3582804a2df2c892d8d1e2f059f67230">ewday_offset</a>);
<a name="l01347"></a>01347                                 <span class="comment">/* advance a year if necessary: thursday 2 august - monday 3 february */</span>
<a name="l01348"></a>01348                                 <span class="keywordflow">if</span>(end_time&lt;start_time){
<a name="l01349"></a>01349                                         year++;
<a name="l01350"></a>01350                                         end_time=<a class="code" href="base_2utils_8c.html#aa379bf40b48f3ea5f97d2cf69154a472">calculate_time_from_weekday_of_month</a>(year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#abc5090255e6001c7b681566af5150003">ewday</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a3582804a2df2c892d8d1e2f059f67230">ewday_offset</a>);
<a name="l01351"></a>01351                                         }
<a name="l01352"></a>01352                                 <span class="keywordflow">break</span>;
<a name="l01353"></a>01353                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a3de3abee01597af4482790b789c64ce9">DATERANGE_WEEK_DAY</a>:
<a name="l01354"></a>01354                                 <span class="comment">/* use same year and month as was calculated for start time above */</span>
<a name="l01355"></a>01355                                 end_time=<a class="code" href="base_2utils_8c.html#aa379bf40b48f3ea5f97d2cf69154a472">calculate_time_from_weekday_of_month</a>(year,month,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#abc5090255e6001c7b681566af5150003">ewday</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a3582804a2df2c892d8d1e2f059f67230">ewday_offset</a>);
<a name="l01356"></a>01356                                 <span class="keywordflow">break</span>;
<a name="l01357"></a>01357                         <span class="keywordflow">default</span>:
<a name="l01358"></a>01358                                 <span class="keywordflow">continue</span>;
<a name="l01359"></a>01359                                 <span class="keywordflow">break</span>;
<a name="l01360"></a>01360                                 }
<a name="l01361"></a>01361 
<a name="l01362"></a>01362 <span class="preprocessor">#ifdef TEST_TIMEPERIODS_B</span>
<a name="l01363"></a>01363 <span class="preprocessor"></span>                        printf(<span class="stringliteral">&quot;STARTTIME: %lu = %s&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)start_time,ctime(&amp;start_time));
<a name="l01364"></a>01364                         printf(<span class="stringliteral">&quot;ENDTIME1: %lu = %s&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)end_time,ctime(&amp;end_time));
<a name="l01365"></a>01365 <span class="preprocessor">#endif</span>
<a name="l01366"></a>01366 <span class="preprocessor"></span>
<a name="l01367"></a>01367                         <span class="comment">/* start date was bad, so skip this date range */</span>
<a name="l01368"></a>01368                         <span class="keywordflow">if</span>((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)start_time==0L)
<a name="l01369"></a>01369                                 <span class="keywordflow">continue</span>;
<a name="l01370"></a>01370 
<a name="l01371"></a>01371                         <span class="comment">/* end date was bad - see if we can handle the error */</span>
<a name="l01372"></a>01372                         <span class="keywordflow">if</span>((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)end_time==0L){
<a name="l01373"></a>01373                                 <span class="keywordflow">switch</span>(daterange_type){
<a name="l01374"></a>01374                                 <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a1c9ce3548ed47cffbe81e5c9f7406aa1">DATERANGE_CALENDAR_DATE</a>:
<a name="l01375"></a>01375                                         <span class="keywordflow">continue</span>;
<a name="l01376"></a>01376                                         <span class="keywordflow">break</span>;
<a name="l01377"></a>01377                                 <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#afdb343e1ee0ba1e9d1c412c094593ae4">DATERANGE_MONTH_DATE</a>:
<a name="l01378"></a>01378                                         <span class="comment">/* end date can&#39;t be helped, so skip it */</span>
<a name="l01379"></a>01379                                         <span class="keywordflow">if</span>(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a>&lt;0)
<a name="l01380"></a>01380                                                 <span class="keywordflow">continue</span>;
<a name="l01381"></a>01381 
<a name="l01382"></a>01382                                         <span class="comment">/* else end date slipped past end of month, so use last day of month as end date */</span>
<a name="l01383"></a>01383                                         end_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a>,-1);
<a name="l01384"></a>01384                                         <span class="keywordflow">break</span>;
<a name="l01385"></a>01385                                 <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a475d446034173a132dec339e1ea9bc8a">DATERANGE_MONTH_DAY</a>:
<a name="l01386"></a>01386                                         <span class="comment">/* end date can&#39;t be helped, so skip it */</span>
<a name="l01387"></a>01387                                         <span class="keywordflow">if</span>(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a>&lt;0)
<a name="l01388"></a>01388                                                 <span class="keywordflow">continue</span>;
<a name="l01389"></a>01389 
<a name="l01390"></a>01390                                         <span class="comment">/* else end date slipped past end of month, so use last day of month as end date */</span>
<a name="l01391"></a>01391                                         end_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,month,-1);
<a name="l01392"></a>01392                                         <span class="keywordflow">break</span>;
<a name="l01393"></a>01393                                 <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#aea35d5146a0a7a0931bf4558435bb11a">DATERANGE_MONTH_WEEK_DAY</a>:
<a name="l01394"></a>01394                                         <span class="comment">/* end date can&#39;t be helped, so skip it */</span>
<a name="l01395"></a>01395                                         <span class="keywordflow">if</span>(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a3582804a2df2c892d8d1e2f059f67230">ewday_offset</a>&lt;0)
<a name="l01396"></a>01396                                                 <span class="keywordflow">continue</span>;
<a name="l01397"></a>01397 
<a name="l01398"></a>01398                                         <span class="comment">/* else end date slipped past end of month, so use last day of month as end date */</span>
<a name="l01399"></a>01399                                         end_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,pref_time_mon,-1);
<a name="l01400"></a>01400                                         <span class="keywordflow">break</span>;
<a name="l01401"></a>01401                                 <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a3de3abee01597af4482790b789c64ce9">DATERANGE_WEEK_DAY</a>:
<a name="l01402"></a>01402                                         <span class="comment">/* end date can&#39;t be helped, so skip it */</span>
<a name="l01403"></a>01403                                         <span class="keywordflow">if</span>(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a3582804a2df2c892d8d1e2f059f67230">ewday_offset</a>&lt;0)
<a name="l01404"></a>01404                                                 <span class="keywordflow">continue</span>;
<a name="l01405"></a>01405 
<a name="l01406"></a>01406                                         <span class="comment">/* else end date slipped past end of month, so use last day of month as end date */</span>
<a name="l01407"></a>01407                                         end_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,month,-1);
<a name="l01408"></a>01408                                         <span class="keywordflow">break</span>;
<a name="l01409"></a>01409                                 <span class="keywordflow">default</span>:
<a name="l01410"></a>01410                                         <span class="keywordflow">continue</span>;
<a name="l01411"></a>01411                                         <span class="keywordflow">break</span>;
<a name="l01412"></a>01412                                         }
<a name="l01413"></a>01413                                 }
<a name="l01414"></a>01414 
<a name="l01415"></a>01415 <span class="preprocessor">#ifdef TEST_TIMEPERIODS_B</span>
<a name="l01416"></a>01416 <span class="preprocessor"></span>                        printf(<span class="stringliteral">&quot;ENDTIME2: %lu = %s&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)end_time,ctime(&amp;end_time));
<a name="l01417"></a>01417 <span class="preprocessor">#endif</span>
<a name="l01418"></a>01418 <span class="preprocessor"></span>
<a name="l01419"></a>01419                         <span class="comment">/* if skipping days... */</span>
<a name="l01420"></a>01420                         <span class="keywordflow">if</span>(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ab8f50f350863005f22bc2e5e807aee50">skip_interval</a>&gt;1){
<a name="l01421"></a>01421 
<a name="l01422"></a>01422                                 <span class="comment">/* advance to the next possible skip date */</span>
<a name="l01423"></a>01423                                 <span class="keywordflow">if</span>(start_time&lt;preferred_time){
<a name="l01424"></a>01424                                         <span class="comment">/* check if interval is across dlst change and gets the compensation */</span>
<a name="l01425"></a>01425                                         shift=<a class="code" href="base_2utils_8c.html#af8827c20db029bc74ce240a818a2a800">get_dlst_shift</a>(&amp;start_time,&amp;midnight);
<a name="l01426"></a>01426 
<a name="l01427"></a>01427                                         <span class="comment">/* how many days have passed between skip start date and preferred time? */</span>
<a name="l01428"></a>01428                                         days=(shift+midnight-(<span class="keywordtype">unsigned</span> long)start_time)/(3600*24);
<a name="l01429"></a>01429 
<a name="l01430"></a>01430 <span class="preprocessor">#ifdef TEST_TIMEPERIODS_B</span>
<a name="l01431"></a>01431 <span class="preprocessor"></span>                                        printf(<span class="stringliteral">&quot;MIDNIGHT: %lu = %s&quot;</span>,midnight,ctime(&amp;midnight));
<a name="l01432"></a>01432                                         printf(<span class="stringliteral">&quot;%lu SECONDS PASSED\n&quot;</span>,(midnight-(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)start_time));
<a name="l01433"></a>01433                                         printf(<span class="stringliteral">&quot;%d DAYS PASSED\n&quot;</span>,days);
<a name="l01434"></a>01434                                         printf(<span class="stringliteral">&quot;REMAINDER: %d\n&quot;</span>,(days % temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ab8f50f350863005f22bc2e5e807aee50">skip_interval</a>));
<a name="l01435"></a>01435                                         printf(<span class="stringliteral">&quot;SKIP INTERVAL: %d\n&quot;</span>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ab8f50f350863005f22bc2e5e807aee50">skip_interval</a>);
<a name="l01436"></a>01436                                         printf(<span class="stringliteral">&quot;DLST SHIFT: %d&quot;</span>,shift);
<a name="l01437"></a>01437 <span class="preprocessor">#endif</span>
<a name="l01438"></a>01438 <span class="preprocessor"></span>
<a name="l01439"></a>01439                                         <span class="comment">/* advance start date to next skip day */</span>
<a name="l01440"></a>01440                                         <span class="keywordflow">if</span>((days % temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ab8f50f350863005f22bc2e5e807aee50">skip_interval</a>)==0)
<a name="l01441"></a>01441                                                 start_time+=(days*3600*24);
<a name="l01442"></a>01442                                         <span class="keywordflow">else</span>
<a name="l01443"></a>01443                                                 start_time+=((days-(days % temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ab8f50f350863005f22bc2e5e807aee50">skip_interval</a>)+temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ab8f50f350863005f22bc2e5e807aee50">skip_interval</a>)*3600*24);
<a name="l01444"></a>01444                                         }
<a name="l01445"></a>01445 
<a name="l01446"></a>01446                                 <span class="comment">/* if skipping has no end, use start date as end */</span>
<a name="l01447"></a>01447                                 <span class="keywordflow">if</span>((daterange_type==<a class="code" href="include_2common_8h.html#a1c9ce3548ed47cffbe81e5c9f7406aa1">DATERANGE_CALENDAR_DATE</a>) &amp;&amp; <a class="code" href="base_2utils_8c.html#a79145211870703746ce61d4a9ca23a3d">is_daterange_single_day</a>(temp_daterange)==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01448"></a>01448                                         end_time=start_time;
<a name="l01449"></a>01449                                 }
<a name="l01450"></a>01450 
<a name="l01451"></a>01451 <span class="preprocessor">#ifdef TEST_TIMEPERIODS_B</span>
<a name="l01452"></a>01452 <span class="preprocessor"></span>                        printf(<span class="stringliteral">&quot;\nSTART:     %lu = %s&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)start_time,ctime(&amp;start_time));
<a name="l01453"></a>01453                         printf(<span class="stringliteral">&quot;END:       %lu = %s&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)end_time,ctime(&amp;end_time));
<a name="l01454"></a>01454                         printf(<span class="stringliteral">&quot;PREFERRED: %lu = %s&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)preferred_time,ctime(&amp;preferred_time));
<a name="l01455"></a>01455                         printf(<span class="stringliteral">&quot;CURRENT:   %lu = %s&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)current_time,ctime(&amp;current_time));
<a name="l01456"></a>01456 <span class="preprocessor">#endif</span>
<a name="l01457"></a>01457 <span class="preprocessor"></span>
<a name="l01458"></a>01458                         <span class="comment">/* skip this date range its out of bounds with what we want */</span>
<a name="l01459"></a>01459                         <span class="keywordflow">if</span>(preferred_time &gt; end_time)
<a name="l01460"></a>01460                                 <span class="keywordflow">continue</span>;
<a name="l01461"></a>01461 
<a name="l01462"></a>01462                         <span class="comment">/* how many days at a time should we advance? */</span>
<a name="l01463"></a>01463                         <span class="keywordflow">if</span>(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ab8f50f350863005f22bc2e5e807aee50">skip_interval</a>&gt;1)
<a name="l01464"></a>01464                                 advance_interval=temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ab8f50f350863005f22bc2e5e807aee50">skip_interval</a>;
<a name="l01465"></a>01465                         <span class="keywordflow">else</span>
<a name="l01466"></a>01466                                 advance_interval=1;
<a name="l01467"></a>01467 
<a name="l01468"></a>01468                         <span class="comment">/* advance through the date range */</span>
<a name="l01469"></a>01469                         <span class="keywordflow">for</span>(day_start=start_time;day_start&lt;=<a class="code" href="cmd_8c.html#a1e324d62e65642694c00de363bf8a8ba">end_time</a>;day_start+=(advance_interval*3600*24)){
<a name="l01470"></a>01470 
<a name="l01471"></a>01471                                 <span class="comment">/* we already found a time from a higher-precendence date range exception */</span>
<a name="l01472"></a>01472                                 <span class="keywordflow">if</span>(day_start&gt;=earliest_day &amp;&amp; have_earliest_time==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01473"></a>01473                                         <span class="keywordflow">continue</span>;
<a name="l01474"></a>01474 
<a name="l01475"></a>01475                                 <span class="keywordflow">for</span>(temp_timerange=temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a0fe4e4fa1fab70183ea923e2b4bdef5b">times</a>;temp_timerange!=NULL;temp_timerange=temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#afd9ea6d61bbc09f855fa17b65e06b8c0">next</a>){
<a name="l01476"></a>01476 
<a name="l01477"></a>01477                                         <span class="comment">/* ranges with start/end of zero mean exlude this day */</span>
<a name="l01478"></a>01478                                         <span class="keywordflow">if</span>(temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#a472faf570efd10d46cc3cb49bbed58b4">range_start</a>==0 &amp;&amp; temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#a399206befe1b5e7efc7f8215f3f23fbd">range_end</a>==0)
<a name="l01479"></a>01479                                                 <span class="keywordflow">continue</span>;
<a name="l01480"></a>01480 
<a name="l01481"></a>01481                                         day_range_start=(time_t)(day_start + temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#a472faf570efd10d46cc3cb49bbed58b4">range_start</a>);
<a name="l01482"></a>01482                                         day_range_end=(time_t)(day_start + temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#a399206befe1b5e7efc7f8215f3f23fbd">range_end</a>);
<a name="l01483"></a>01483 
<a name="l01484"></a>01484 <span class="preprocessor">#ifdef TEST_TIMEPERIODS_B</span>
<a name="l01485"></a>01485 <span class="preprocessor"></span>                                        printf(<span class="stringliteral">&quot;  RANGE START: %lu (%lu) = %s&quot;</span>,temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#a472faf570efd10d46cc3cb49bbed58b4">range_start</a>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)day_range_start,ctime(&amp;day_range_start));
<a name="l01486"></a>01486                                         printf(<span class="stringliteral">&quot;  RANGE END:   %lu (%lu) = %s&quot;</span>,temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#a399206befe1b5e7efc7f8215f3f23fbd">range_end</a>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)day_range_end,ctime(&amp;day_range_end));
<a name="l01487"></a>01487 <span class="preprocessor">#endif</span>
<a name="l01488"></a>01488 <span class="preprocessor"></span>
<a name="l01489"></a>01489                                         <span class="comment">/* range is out of bounds */</span>
<a name="l01490"></a>01490                                         <span class="keywordflow">if</span>(day_range_end&lt;preferred_time)
<a name="l01491"></a>01491                                                 <span class="keywordflow">continue</span>;
<a name="l01492"></a>01492 
<a name="l01493"></a>01493                                         <span class="comment">/* preferred time occurs before range start, so use range start time as earliest potential time */</span>
<a name="l01494"></a>01494                                         <span class="keywordflow">if</span>(day_range_start&gt;=preferred_time)
<a name="l01495"></a>01495                                                 potential_time=day_range_start;
<a name="l01496"></a>01496                                         <span class="comment">/* preferred time occurs between range start/end, so use preferred time as earliest potential time */</span>
<a name="l01497"></a>01497                                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(day_range_end&gt;=preferred_time)
<a name="l01498"></a>01498                                                 potential_time=preferred_time;
<a name="l01499"></a>01499 
<a name="l01500"></a>01500                                         <span class="comment">/* is this the earliest time found thus far? */</span>
<a name="l01501"></a>01501                                         <span class="keywordflow">if</span>(have_earliest_time==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> || potential_time&lt;earliest_time){
<a name="l01502"></a>01502                                                 have_earliest_time=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01503"></a>01503                                                 earliest_time=potential_time;
<a name="l01504"></a>01504                                                 earliest_day=day_start;
<a name="l01505"></a>01505 <span class="preprocessor">#ifdef TEST_TIMEPERIODS_B</span>
<a name="l01506"></a>01506 <span class="preprocessor"></span>                                                printf(<span class="stringliteral">&quot;    EARLIEST TIME: %lu = %s&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)earliest_time,ctime(&amp;earliest_time));
<a name="l01507"></a>01507 <span class="preprocessor">#endif</span>
<a name="l01508"></a>01508 <span class="preprocessor"></span>                                                }
<a name="l01509"></a>01509                                         }
<a name="l01510"></a>01510                                 }
<a name="l01511"></a>01511                         }
<a name="l01512"></a>01512 
<a name="l01513"></a>01513                 }
<a name="l01514"></a>01514 
<a name="l01515"></a>01515 
<a name="l01516"></a>01516         <span class="comment">/**** find next available time from normal, weekly rotating schedule (in this timeperiod definition) ****/</span>
<a name="l01517"></a>01517 
<a name="l01518"></a>01518         <span class="comment">/* check a one week rotation of time */</span>
<a name="l01519"></a>01519         has_looped=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01520"></a>01520         <span class="keywordflow">for</span>(weekday=pref_time_wday,days_into_the_future=0;;weekday++,days_into_the_future++){
<a name="l01521"></a>01521 
<a name="l01522"></a>01522                 <span class="comment">/* break out of the loop if we have checked an entire week already */</span>
<a name="l01523"></a>01523                 <span class="keywordflow">if</span>(has_looped==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; weekday &gt;= pref_time_wday)
<a name="l01524"></a>01524                         <span class="keywordflow">break</span>;
<a name="l01525"></a>01525 
<a name="l01526"></a>01526                 <span class="keywordflow">if</span>(weekday&gt;=7){
<a name="l01527"></a>01527                         weekday-=7;
<a name="l01528"></a>01528                         has_looped=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01529"></a>01529                         }
<a name="l01530"></a>01530 
<a name="l01531"></a>01531                 <span class="comment">/* calculate start of this future weekday */</span>
<a name="l01532"></a>01532                 day_start=(time_t)(midnight + (days_into_the_future*3600*24));
<a name="l01533"></a>01533 
<a name="l01534"></a>01534                 <span class="comment">/* we already found a time from a higher-precendence date range exception */</span>
<a name="l01535"></a>01535                 <span class="keywordflow">if</span>(day_start==earliest_day)
<a name="l01536"></a>01536                         <span class="keywordflow">continue</span>;
<a name="l01537"></a>01537 
<a name="l01538"></a>01538                 <span class="comment">/* check all time ranges for this day of the week */</span>
<a name="l01539"></a>01539                 <span class="keywordflow">for</span>(temp_timerange=tperiod-&gt;<a class="code" href="structtimeperiod__struct.html#a80a66ae6bf3d3514a1f10b4d4f62cfd0">days</a>[weekday];temp_timerange!=NULL;temp_timerange=temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#afd9ea6d61bbc09f855fa17b65e06b8c0">next</a>){
<a name="l01540"></a>01540 
<a name="l01541"></a>01541                         <span class="comment">/* calculate the time for the start of this time range */</span>
<a name="l01542"></a>01542                         day_range_start=(time_t)(day_start + temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#a472faf570efd10d46cc3cb49bbed58b4">range_start</a>);
<a name="l01543"></a>01543 
<a name="l01544"></a>01544                         <span class="keywordflow">if</span>((have_earliest_time==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> || day_range_start&lt;earliest_time) &amp;&amp; day_range_start&gt;=preferred_time){
<a name="l01545"></a>01545                                 have_earliest_time=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01546"></a>01546                                 earliest_time=day_range_start;
<a name="l01547"></a>01547                                 earliest_day=day_start;
<a name="l01548"></a>01548                                 }
<a name="l01549"></a>01549                         }
<a name="l01550"></a>01550                 }
<a name="l01551"></a>01551 
<a name="l01552"></a>01552 
<a name="l01553"></a>01553         <span class="comment">/* if we couldn&#39;t find a time period there must be none defined */</span>
<a name="l01554"></a>01554         <span class="keywordflow">if</span>(have_earliest_time==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> || earliest_time==(time_t)0)
<a name="l01555"></a>01555                 *valid_time=(time_t)preferred_time;
<a name="l01556"></a>01556 
<a name="l01557"></a>01557         <span class="comment">/* else use the calculated time */</span>
<a name="l01558"></a>01558         <span class="keywordflow">else</span>
<a name="l01559"></a>01559                 *valid_time=<a class="code" href="histogram_8c.html#af52fb2a1ec12b79ceb207523a77e1cf0">earliest_time</a>;
<a name="l01560"></a>01560 
<a name="l01561"></a>01561         <span class="keywordflow">return</span>;
<a name="l01562"></a>01562         }
<a name="l01563"></a>01563 
<a name="l01564"></a><a class="code" href="icinga_8h.html#a32b27c515ee85f1cae743ff6fe8e594e">01564</a> <span class="keywordtype">void</span> <a class="code" href="base_2utils_8c.html#a8d85d50d4d06cade09bfcbb829393ee9">get_min_invalid_time_per_timeperiod</a>(time_t pref_time, time_t *valid_time, time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>, <a class="code" href="structtimeperiod__struct.html">timeperiod</a> *tperiod){
<a name="l01565"></a>01565         time_t preferred_time=(time_t)0L;
<a name="l01566"></a>01566         <a class="code" href="structtimerange__struct.html">timerange</a> *temp_timerange;
<a name="l01567"></a>01567         <a class="code" href="structdaterange__struct.html">daterange</a> *temp_daterange;
<a name="l01568"></a>01568         time_t midnight=0L;
<a name="l01569"></a>01569         <span class="keyword">struct </span>tm *t, tm_s;
<a name="l01570"></a>01570         time_t day_start=(time_t)0L;
<a name="l01571"></a>01571         time_t day_range_start=(time_t)0L;
<a name="l01572"></a>01572         time_t day_range_end=(time_t)0L;
<a name="l01573"></a>01573         time_t <a class="code" href="cmd_8c.html#ad20e89e0c86aa812dc3a8e2fb7b5777b">start_time</a>=(time_t)0L;
<a name="l01574"></a>01574         time_t <a class="code" href="cmd_8c.html#a1e324d62e65642694c00de363bf8a8ba">end_time</a>=(time_t)0L;
<a name="l01575"></a>01575         <span class="keywordtype">int</span> have_latest_time=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01576"></a>01576         time_t <a class="code" href="histogram_8c.html#a3fafe5129cbf9bcd75b864c31daf4464">latest_time</a>=(time_t)0L;
<a name="l01577"></a>01577         time_t earliest_day=(time_t)0L;
<a name="l01578"></a>01578         time_t potential_time=(time_t)0L;
<a name="l01579"></a>01579         <span class="keywordtype">int</span> weekday=0;
<a name="l01580"></a>01580         <span class="keywordtype">int</span> has_looped=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01581"></a>01581         <span class="keywordtype">int</span> days_into_the_future=0;
<a name="l01582"></a>01582         <span class="keywordtype">int</span> daterange_type=0;
<a name="l01583"></a>01583         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> days=0L;
<a name="l01584"></a>01584         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> advance_interval=0L;
<a name="l01585"></a>01585         <span class="keywordtype">int</span> year=0; <span class="comment">/* new */</span>
<a name="l01586"></a>01586         <span class="keywordtype">int</span> month=0; <span class="comment">/* new */</span>
<a name="l01587"></a>01587 
<a name="l01588"></a>01588         <span class="keywordtype">int</span> pref_time_year=0;
<a name="l01589"></a>01589         <span class="keywordtype">int</span> pref_time_mon=0;
<a name="l01590"></a>01590         <span class="keywordtype">int</span> pref_time_mday=0;
<a name="l01591"></a>01591         <span class="keywordtype">int</span> pref_time_wday=0;
<a name="l01592"></a>01592         <span class="keywordtype">int</span> current_time_year=0;
<a name="l01593"></a>01593         <span class="keywordtype">int</span> current_time_mon=0;
<a name="l01594"></a>01594         <span class="keywordtype">int</span> current_time_mday=0;
<a name="l01595"></a>01595         <span class="keywordtype">int</span> current_time_wday=0;
<a name="l01596"></a>01596         <span class="keywordtype">int</span> shift;
<a name="l01597"></a>01597 
<a name="l01598"></a>01598         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;get_next_valid_time_per_timeperiod()\n&quot;</span>);
<a name="l01599"></a>01599 
<a name="l01600"></a>01600         preferred_time=pref_time;
<a name="l01601"></a>01601 
<a name="l01602"></a>01602         <span class="comment">/* if no timeperiod, go with preferred time */</span>
<a name="l01603"></a>01603         <span class="keywordflow">if</span>(tperiod==NULL){
<a name="l01604"></a>01604                 *valid_time=preferred_time;
<a name="l01605"></a>01605                 <span class="keywordflow">return</span>;
<a name="l01606"></a>01606                 }
<a name="l01607"></a>01607 
<a name="l01608"></a>01608         <span class="comment">/* calculate the start of the day (midnight, 00:00 hours) of preferred time */</span>
<a name="l01609"></a>01609         t = localtime_r(&amp;preferred_time, &amp;tm_s);
<a name="l01610"></a>01610         t-&gt;tm_sec=0;
<a name="l01611"></a>01611         t-&gt;tm_min=0;
<a name="l01612"></a>01612         t-&gt;tm_hour=0;
<a name="l01613"></a>01613         t-&gt;tm_isdst=-1;
<a name="l01614"></a>01614         midnight=(<span class="keywordtype">unsigned</span> long)mktime(t);
<a name="l01615"></a>01615 
<a name="l01616"></a>01616         <span class="comment">/* save pref time values for later */</span>
<a name="l01617"></a>01617         pref_time_year=t-&gt;tm_year;
<a name="l01618"></a>01618         pref_time_mon=t-&gt;tm_mon;
<a name="l01619"></a>01619         pref_time_mday=t-&gt;tm_mday;
<a name="l01620"></a>01620         pref_time_wday=t-&gt;tm_wday;
<a name="l01621"></a>01621 
<a name="l01622"></a>01622         <span class="comment">/* save current time values for later */</span>
<a name="l01623"></a>01623         t = localtime_r(&amp;current_time, &amp;tm_s);
<a name="l01624"></a>01624         current_time_year=t-&gt;tm_year;
<a name="l01625"></a>01625         current_time_mon=t-&gt;tm_mon;
<a name="l01626"></a>01626         current_time_mday=t-&gt;tm_mday;
<a name="l01627"></a>01627         current_time_wday=t-&gt;tm_wday;
<a name="l01628"></a>01628 
<a name="l01629"></a>01629         <span class="comment">/**** check exceptions (in this timeperiod definition) first ****/</span>
<a name="l01630"></a>01630         <span class="keywordflow">for</span>(daterange_type=0;daterange_type&lt;<a class="code" href="include_2common_8h.html#a09487af157aaf6684304caff29fc563c">DATERANGE_TYPES</a>;daterange_type++){
<a name="l01631"></a>01631 
<a name="l01632"></a>01632                 <span class="keywordflow">for</span>(temp_daterange=tperiod-&gt;<a class="code" href="structtimeperiod__struct.html#a3e17bec1cdcefe9eeaa79851124e2315">exceptions</a>[daterange_type];temp_daterange!=NULL;temp_daterange=temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aee7ef6e3b7ac927f7455026c5c908148">next</a>){
<a name="l01633"></a>01633 
<a name="l01634"></a>01634                         <span class="comment">/* get the start time */</span>
<a name="l01635"></a>01635                         <span class="keywordflow">switch</span>(daterange_type){
<a name="l01636"></a>01636                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a1c9ce3548ed47cffbe81e5c9f7406aa1">DATERANGE_CALENDAR_DATE</a>: <span class="comment">/* 2009-08-11 */</span>
<a name="l01637"></a>01637                                 t-&gt;tm_sec=0;
<a name="l01638"></a>01638                                 t-&gt;tm_min=0;
<a name="l01639"></a>01639                                 t-&gt;tm_hour=0;
<a name="l01640"></a>01640                                 t-&gt;tm_mday=temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a2b11fe1c52944be6794b98970ec4e1c4">smday</a>;
<a name="l01641"></a>01641                                 t-&gt;tm_mon=temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a193b929d793c4af88306041edfd4d529">smon</a>;
<a name="l01642"></a>01642                                 t-&gt;tm_year=(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#afb9081e26e6d1d876caab0819faba099">syear</a>-1900);
<a name="l01643"></a>01643                                 t-&gt;tm_isdst=-1;
<a name="l01644"></a>01644                                 start_time=mktime(t);
<a name="l01645"></a>01645                                 <span class="keywordflow">break</span>;
<a name="l01646"></a>01646                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#afdb343e1ee0ba1e9d1c412c094593ae4">DATERANGE_MONTH_DATE</a>:  <span class="comment">/* january 1 */</span>
<a name="l01647"></a>01647                                 <span class="comment">/* what year should we use? */</span>
<a name="l01648"></a>01648                                 year=(pref_time_year &lt; current_time_year)?current_time_year:pref_time_year;
<a name="l01649"></a>01649                                 <span class="comment">/* advance an additional year if we already passed the end month date */</span>
<a name="l01650"></a>01650                                 <span class="keywordflow">if</span>((temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a> &lt; current_time_mon) || ((temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a> == current_time_mon) &amp;&amp; temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a> &lt; current_time_mday))
<a name="l01651"></a>01651                                         year++;
<a name="l01652"></a>01652                                 start_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a193b929d793c4af88306041edfd4d529">smon</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a2b11fe1c52944be6794b98970ec4e1c4">smday</a>);
<a name="l01653"></a>01653                                 <span class="keywordflow">break</span>;
<a name="l01654"></a>01654                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a475d446034173a132dec339e1ea9bc8a">DATERANGE_MONTH_DAY</a>:  <span class="comment">/* day 3 */</span>
<a name="l01655"></a>01655                                 <span class="comment">/* what year should we use? */</span>
<a name="l01656"></a>01656                                 year=(pref_time_year &lt; current_time_year)?current_time_year:pref_time_year;
<a name="l01657"></a>01657                                 <span class="comment">/* use current month */</span>
<a name="l01658"></a>01658                                 month=current_time_mon;
<a name="l01659"></a>01659                                 <span class="comment">/* advance an additional month (and possibly the year) if we already passed the end day of month */</span>
<a name="l01660"></a>01660                                 <span class="keywordflow">if</span>(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a> &lt; current_time_mday){
<a name="l01661"></a>01661                                         <span class="comment">/*if(month==1){*/</span>
<a name="l01662"></a>01662                                         <span class="keywordflow">if</span>(month==11){
<a name="l01663"></a>01663                                                 month=0;
<a name="l01664"></a>01664                                                 year++;
<a name="l01665"></a>01665                                                 }
<a name="l01666"></a>01666                                         <span class="keywordflow">else</span>
<a name="l01667"></a>01667                                                 month++;
<a name="l01668"></a>01668                                         }
<a name="l01669"></a>01669                                 start_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,month,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a2b11fe1c52944be6794b98970ec4e1c4">smday</a>);
<a name="l01670"></a>01670                                 <span class="keywordflow">break</span>;
<a name="l01671"></a>01671                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#aea35d5146a0a7a0931bf4558435bb11a">DATERANGE_MONTH_WEEK_DAY</a>: <span class="comment">/* thursday 2 april */</span>
<a name="l01672"></a>01672                                 <span class="comment">/* what year should we use? */</span>
<a name="l01673"></a>01673                                 year=(pref_time_year &lt; current_time_year)?current_time_year:pref_time_year;
<a name="l01674"></a>01674                                 <span class="comment">/* calculate time of specified weekday of specific month */</span>
<a name="l01675"></a>01675                                 start_time=<a class="code" href="base_2utils_8c.html#aa379bf40b48f3ea5f97d2cf69154a472">calculate_time_from_weekday_of_month</a>(year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a193b929d793c4af88306041edfd4d529">smon</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a043846fe0bcb8e61f2860508391f4f4b">swday</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ac4f374102495f80f724c0e9fe1072eaa">swday_offset</a>);
<a name="l01676"></a>01676                                 <span class="comment">/* advance to next year if we&#39;ve passed this month weekday already this year */</span>
<a name="l01677"></a>01677                                 <span class="keywordflow">if</span>(start_time &lt; preferred_time){
<a name="l01678"></a>01678                                         year++;
<a name="l01679"></a>01679                                         start_time=<a class="code" href="base_2utils_8c.html#aa379bf40b48f3ea5f97d2cf69154a472">calculate_time_from_weekday_of_month</a>(year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a193b929d793c4af88306041edfd4d529">smon</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a043846fe0bcb8e61f2860508391f4f4b">swday</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ac4f374102495f80f724c0e9fe1072eaa">swday_offset</a>);
<a name="l01680"></a>01680                                         }
<a name="l01681"></a>01681                                 <span class="keywordflow">break</span>;
<a name="l01682"></a>01682                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a3de3abee01597af4482790b789c64ce9">DATERANGE_WEEK_DAY</a>: <span class="comment">/* wednesday 1 */</span>
<a name="l01683"></a>01683                                 <span class="comment">/* what year should we use? */</span>
<a name="l01684"></a>01684                                 year=(pref_time_year &lt; current_time_year)?current_time_year:pref_time_year;
<a name="l01685"></a>01685                                 <span class="comment">/* calculate time of specified weekday of month */</span>
<a name="l01686"></a>01686                                 start_time=<a class="code" href="base_2utils_8c.html#aa379bf40b48f3ea5f97d2cf69154a472">calculate_time_from_weekday_of_month</a>(year,pref_time_mon,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a043846fe0bcb8e61f2860508391f4f4b">swday</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ac4f374102495f80f724c0e9fe1072eaa">swday_offset</a>);
<a name="l01687"></a>01687                                 <span class="comment">/* advance to next month (or year) if we&#39;ve passed this weekday of this month already */</span>
<a name="l01688"></a>01688                                 <span class="keywordflow">if</span>(start_time &lt; preferred_time){
<a name="l01689"></a>01689                                         month=pref_time_mon;
<a name="l01690"></a>01690                                         <span class="keywordflow">if</span>(month==11){
<a name="l01691"></a>01691                                                 month=0;
<a name="l01692"></a>01692                                                 year++;
<a name="l01693"></a>01693                                                 }
<a name="l01694"></a>01694                                         <span class="keywordflow">else</span>
<a name="l01695"></a>01695                                                 month++;
<a name="l01696"></a>01696                                         start_time=<a class="code" href="base_2utils_8c.html#aa379bf40b48f3ea5f97d2cf69154a472">calculate_time_from_weekday_of_month</a>(year,month,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a043846fe0bcb8e61f2860508391f4f4b">swday</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ac4f374102495f80f724c0e9fe1072eaa">swday_offset</a>);
<a name="l01697"></a>01697                                         }
<a name="l01698"></a>01698                                 <span class="keywordflow">break</span>;
<a name="l01699"></a>01699                         <span class="keywordflow">default</span>:
<a name="l01700"></a>01700                                 <span class="keywordflow">continue</span>;
<a name="l01701"></a>01701                                 <span class="keywordflow">break</span>;
<a name="l01702"></a>01702                                 }
<a name="l01703"></a>01703 
<a name="l01704"></a>01704                         <span class="comment">/* get the end time */</span>
<a name="l01705"></a>01705                         <span class="keywordflow">switch</span>(daterange_type){
<a name="l01706"></a>01706                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a1c9ce3548ed47cffbe81e5c9f7406aa1">DATERANGE_CALENDAR_DATE</a>:
<a name="l01707"></a>01707                                 t-&gt;tm_sec=0;
<a name="l01708"></a>01708                                 t-&gt;tm_min=0;
<a name="l01709"></a>01709                                 t-&gt;tm_hour=0;
<a name="l01710"></a>01710                                 t-&gt;tm_mday=temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a>;
<a name="l01711"></a>01711                                 t-&gt;tm_mon=temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a>;
<a name="l01712"></a>01712                                 t-&gt;tm_year=(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aced1e14d0e382f397d41fe9d186af11b">eyear</a>-1900);
<a name="l01713"></a>01713                                 t-&gt;tm_isdst=-1;
<a name="l01714"></a>01714                                 end_time=mktime(t);
<a name="l01715"></a>01715                                 <span class="keywordflow">break</span>;
<a name="l01716"></a>01716                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#afdb343e1ee0ba1e9d1c412c094593ae4">DATERANGE_MONTH_DATE</a>:
<a name="l01717"></a>01717                                 <span class="comment">/* use same year as was calculated for start time above */</span>
<a name="l01718"></a>01718                                 end_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a>);
<a name="l01719"></a>01719                                 <span class="comment">/* advance a year if necessary: august 5 - february 2 */</span>
<a name="l01720"></a>01720                                 <span class="keywordflow">if</span>(end_time&lt;start_time){
<a name="l01721"></a>01721                                         year++;
<a name="l01722"></a>01722                                         end_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a>);
<a name="l01723"></a>01723                                         }
<a name="l01724"></a>01724                                 <span class="keywordflow">break</span>;
<a name="l01725"></a>01725                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a475d446034173a132dec339e1ea9bc8a">DATERANGE_MONTH_DAY</a>:
<a name="l01726"></a>01726                                 <span class="comment">/* use same year and month as was calculated for start time above */</span>
<a name="l01727"></a>01727                                 end_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,month,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a>+1);
<a name="l01728"></a>01728                                 <span class="keywordflow">break</span>;
<a name="l01729"></a>01729                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#aea35d5146a0a7a0931bf4558435bb11a">DATERANGE_MONTH_WEEK_DAY</a>:
<a name="l01730"></a>01730                                 <span class="comment">/* use same year as was calculated for start time above */</span>
<a name="l01731"></a>01731                                 end_time=<a class="code" href="base_2utils_8c.html#aa379bf40b48f3ea5f97d2cf69154a472">calculate_time_from_weekday_of_month</a>(year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#abc5090255e6001c7b681566af5150003">ewday</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a3582804a2df2c892d8d1e2f059f67230">ewday_offset</a>);
<a name="l01732"></a>01732                                 <span class="comment">/* advance a year if necessary: thursday 2 august - monday 3 february */</span>
<a name="l01733"></a>01733                                 <span class="keywordflow">if</span>(end_time&lt;start_time){
<a name="l01734"></a>01734                                         year++;
<a name="l01735"></a>01735                                         end_time=<a class="code" href="base_2utils_8c.html#aa379bf40b48f3ea5f97d2cf69154a472">calculate_time_from_weekday_of_month</a>(year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#abc5090255e6001c7b681566af5150003">ewday</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a3582804a2df2c892d8d1e2f059f67230">ewday_offset</a>);
<a name="l01736"></a>01736                                         }
<a name="l01737"></a>01737                                 <span class="keywordflow">break</span>;
<a name="l01738"></a>01738                         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a3de3abee01597af4482790b789c64ce9">DATERANGE_WEEK_DAY</a>:
<a name="l01739"></a>01739                                 <span class="comment">/* use same year and month as was calculated for start time above */</span>
<a name="l01740"></a>01740                                 end_time=<a class="code" href="base_2utils_8c.html#aa379bf40b48f3ea5f97d2cf69154a472">calculate_time_from_weekday_of_month</a>(year,month,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#abc5090255e6001c7b681566af5150003">ewday</a>,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a3582804a2df2c892d8d1e2f059f67230">ewday_offset</a>);
<a name="l01741"></a>01741                                 <span class="keywordflow">break</span>;
<a name="l01742"></a>01742                         <span class="keywordflow">default</span>:
<a name="l01743"></a>01743                                 <span class="keywordflow">continue</span>;
<a name="l01744"></a>01744                                 <span class="keywordflow">break</span>;
<a name="l01745"></a>01745                                 }
<a name="l01746"></a>01746 
<a name="l01747"></a>01747                         <span class="comment">/* start date was bad, so skip this date range */</span>
<a name="l01748"></a>01748                         <span class="keywordflow">if</span>((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)start_time==0L)
<a name="l01749"></a>01749                                 <span class="keywordflow">continue</span>;
<a name="l01750"></a>01750 
<a name="l01751"></a>01751                         <span class="comment">/* end date was bad - see if we can handle the error */</span>
<a name="l01752"></a>01752                         <span class="keywordflow">if</span>((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)end_time==0L){
<a name="l01753"></a>01753                                 <span class="keywordflow">switch</span>(daterange_type){
<a name="l01754"></a>01754                                 <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a1c9ce3548ed47cffbe81e5c9f7406aa1">DATERANGE_CALENDAR_DATE</a>:
<a name="l01755"></a>01755                                         <span class="keywordflow">continue</span>;
<a name="l01756"></a>01756                                         <span class="keywordflow">break</span>;
<a name="l01757"></a>01757                                 <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#afdb343e1ee0ba1e9d1c412c094593ae4">DATERANGE_MONTH_DATE</a>:
<a name="l01758"></a>01758                                         <span class="comment">/* end date can&#39;t be helped, so skip it */</span>
<a name="l01759"></a>01759                                         <span class="keywordflow">if</span>(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a>&lt;0)
<a name="l01760"></a>01760                                                 <span class="keywordflow">continue</span>;
<a name="l01761"></a>01761 
<a name="l01762"></a>01762                                         <span class="comment">/* else end date slipped past end of month, so use last day of month as end date */</span>
<a name="l01763"></a>01763                                         end_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a>,-1);
<a name="l01764"></a>01764                                         <span class="keywordflow">break</span>;
<a name="l01765"></a>01765                                 <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a475d446034173a132dec339e1ea9bc8a">DATERANGE_MONTH_DAY</a>:
<a name="l01766"></a>01766                                         <span class="comment">/* end date can&#39;t be helped, so skip it */</span>
<a name="l01767"></a>01767                                         <span class="keywordflow">if</span>(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a>&lt;0)
<a name="l01768"></a>01768                                                 <span class="keywordflow">continue</span>;
<a name="l01769"></a>01769 
<a name="l01770"></a>01770                                         <span class="comment">/* else end date slipped past end of month, so use last day of month as end date */</span>
<a name="l01771"></a>01771                                         end_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,month,-1);
<a name="l01772"></a>01772                                         <span class="keywordflow">break</span>;
<a name="l01773"></a>01773                                 <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#aea35d5146a0a7a0931bf4558435bb11a">DATERANGE_MONTH_WEEK_DAY</a>:
<a name="l01774"></a>01774                                         <span class="comment">/* end date can&#39;t be helped, so skip it */</span>
<a name="l01775"></a>01775                                         <span class="keywordflow">if</span>(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a3582804a2df2c892d8d1e2f059f67230">ewday_offset</a>&lt;0)
<a name="l01776"></a>01776                                                 <span class="keywordflow">continue</span>;
<a name="l01777"></a>01777 
<a name="l01778"></a>01778                                         <span class="comment">/* else end date slipped past end of month, so use last day of month as end date */</span>
<a name="l01779"></a>01779                                         end_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,pref_time_mon,-1);
<a name="l01780"></a>01780                                         <span class="keywordflow">break</span>;
<a name="l01781"></a>01781                                 <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a3de3abee01597af4482790b789c64ce9">DATERANGE_WEEK_DAY</a>:
<a name="l01782"></a>01782                                         <span class="comment">/* end date can&#39;t be helped, so skip it */</span>
<a name="l01783"></a>01783                                         <span class="keywordflow">if</span>(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a3582804a2df2c892d8d1e2f059f67230">ewday_offset</a>&lt;0)
<a name="l01784"></a>01784                                                 <span class="keywordflow">continue</span>;
<a name="l01785"></a>01785 
<a name="l01786"></a>01786                                         <span class="comment">/* else end date slipped past end of month, so use last day of month as end date */</span>
<a name="l01787"></a>01787                                         end_time=<a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(year,month,-1);
<a name="l01788"></a>01788                                         <span class="keywordflow">break</span>;
<a name="l01789"></a>01789                                 <span class="keywordflow">default</span>:
<a name="l01790"></a>01790                                         <span class="keywordflow">continue</span>;
<a name="l01791"></a>01791                                         <span class="keywordflow">break</span>;
<a name="l01792"></a>01792                                         }
<a name="l01793"></a>01793                                 }
<a name="l01794"></a>01794 
<a name="l01795"></a>01795 
<a name="l01796"></a>01796                         <span class="comment">/* if skipping days... */</span>
<a name="l01797"></a>01797                         <span class="keywordflow">if</span>(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ab8f50f350863005f22bc2e5e807aee50">skip_interval</a>&gt;1){
<a name="l01798"></a>01798 
<a name="l01799"></a>01799                                 <span class="comment">/* advance to the next possible skip date */</span>
<a name="l01800"></a>01800                                 <span class="keywordflow">if</span>(start_time&lt;preferred_time){
<a name="l01801"></a>01801                                         <span class="comment">/* check if interval is across dlst change and gets the compensation */</span>
<a name="l01802"></a>01802                                         shift=<a class="code" href="base_2utils_8c.html#af8827c20db029bc74ce240a818a2a800">get_dlst_shift</a>(&amp;start_time,&amp;midnight);
<a name="l01803"></a>01803 
<a name="l01804"></a>01804                                         <span class="comment">/* how many days have passed between skip start date and preferred time? */</span>
<a name="l01805"></a>01805                                         days=(shift+midnight-(<span class="keywordtype">unsigned</span> long)start_time)/(3600*24);
<a name="l01806"></a>01806 
<a name="l01807"></a>01807                                         <span class="comment">/* advance start date to next skip day */</span>
<a name="l01808"></a>01808                                         <span class="keywordflow">if</span>((days % temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ab8f50f350863005f22bc2e5e807aee50">skip_interval</a>)==0)
<a name="l01809"></a>01809                                                 start_time+=(days*3600*24);
<a name="l01810"></a>01810                                         <span class="keywordflow">else</span>
<a name="l01811"></a>01811                                                 start_time+=((days-(days % temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ab8f50f350863005f22bc2e5e807aee50">skip_interval</a>)+temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ab8f50f350863005f22bc2e5e807aee50">skip_interval</a>)*3600*24);
<a name="l01812"></a>01812                                         }
<a name="l01813"></a>01813 
<a name="l01814"></a>01814                                 <span class="comment">/* if skipping has no end, use start date as end */</span>
<a name="l01815"></a>01815                                 <span class="keywordflow">if</span>((daterange_type==<a class="code" href="include_2common_8h.html#a1c9ce3548ed47cffbe81e5c9f7406aa1">DATERANGE_CALENDAR_DATE</a>) &amp;&amp; <a class="code" href="base_2utils_8c.html#a79145211870703746ce61d4a9ca23a3d">is_daterange_single_day</a>(temp_daterange)==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01816"></a>01816                                         end_time=start_time;
<a name="l01817"></a>01817                                 }
<a name="l01818"></a>01818 
<a name="l01819"></a>01819                         <span class="comment">/* skip this date range its out of bounds with what we want */</span>
<a name="l01820"></a>01820                         <span class="keywordflow">if</span>(preferred_time &gt; end_time)
<a name="l01821"></a>01821                                 <span class="keywordflow">continue</span>;
<a name="l01822"></a>01822 
<a name="l01823"></a>01823                         <span class="comment">/* how many days at a time should we advance? */</span>
<a name="l01824"></a>01824                         <span class="keywordflow">if</span>(temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ab8f50f350863005f22bc2e5e807aee50">skip_interval</a>&gt;1)
<a name="l01825"></a>01825                                 advance_interval=temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#ab8f50f350863005f22bc2e5e807aee50">skip_interval</a>;
<a name="l01826"></a>01826                         <span class="keywordflow">else</span>
<a name="l01827"></a>01827                                 advance_interval=1;
<a name="l01828"></a>01828 
<a name="l01829"></a>01829                         <span class="comment">/* advance through the date range */</span>
<a name="l01830"></a>01830                         <span class="keywordflow">for</span>(day_start=start_time;day_start&lt;=<a class="code" href="cmd_8c.html#a1e324d62e65642694c00de363bf8a8ba">end_time</a>;day_start+=(advance_interval*3600*24)){
<a name="l01831"></a>01831 
<a name="l01832"></a>01832                                 <span class="comment">/* we already found a time from a higher-precendence date range exception */</span>
<a name="l01833"></a>01833                                 <span class="keywordflow">if</span>(day_start&gt;=earliest_day &amp;&amp; have_latest_time==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01834"></a>01834                                         <span class="keywordflow">continue</span>;
<a name="l01835"></a>01835 
<a name="l01836"></a>01836                                 <span class="keywordflow">for</span>(temp_timerange=temp_daterange-&gt;<a class="code" href="structdaterange__struct.html#a0fe4e4fa1fab70183ea923e2b4bdef5b">times</a>;temp_timerange!=NULL;temp_timerange=temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#afd9ea6d61bbc09f855fa17b65e06b8c0">next</a>){
<a name="l01837"></a>01837 
<a name="l01838"></a>01838                                         day_range_start=(time_t)(day_start + temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#a472faf570efd10d46cc3cb49bbed58b4">range_start</a>);
<a name="l01839"></a>01839                                         day_range_end=(time_t)(day_start + temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#a399206befe1b5e7efc7f8215f3f23fbd">range_end</a>);
<a name="l01840"></a>01840 
<a name="l01841"></a>01841                                         <span class="comment">/* range is out of bounds */</span>
<a name="l01842"></a>01842                                         <span class="keywordflow">if</span>(day_range_end&lt;preferred_time)
<a name="l01843"></a>01843                                                 <span class="keywordflow">continue</span>;
<a name="l01844"></a>01844 
<a name="l01845"></a>01845                                         potential_time=day_range_end;
<a name="l01846"></a>01846 
<a name="l01847"></a>01847                                         <span class="comment">/* is this the earliest time found thus far? */</span>
<a name="l01848"></a>01848                                         <span class="keywordflow">if</span>(have_latest_time==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> || potential_time&lt;latest_time){
<a name="l01849"></a>01849                                                 have_latest_time=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01850"></a>01850                                                 latest_time=potential_time;
<a name="l01851"></a>01851                                                 earliest_day=day_start;
<a name="l01852"></a>01852                                                 }
<a name="l01853"></a>01853                                         }
<a name="l01854"></a>01854                                 }
<a name="l01855"></a>01855                         }
<a name="l01856"></a>01856 
<a name="l01857"></a>01857                 }
<a name="l01858"></a>01858 
<a name="l01859"></a>01859 
<a name="l01860"></a>01860         <span class="comment">/**** find next available time from normal, weekly rotating schedule (in this timeperiod definition) ****/</span>
<a name="l01861"></a>01861 
<a name="l01862"></a>01862         <span class="comment">/* check a one week rotation of time */</span>
<a name="l01863"></a>01863         has_looped=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01864"></a>01864         <span class="keywordflow">for</span>(weekday=pref_time_wday,days_into_the_future=0;;weekday++,days_into_the_future++){
<a name="l01865"></a>01865 
<a name="l01866"></a>01866                 <span class="comment">/* break out of the loop if we have checked an entire week already */</span>
<a name="l01867"></a>01867                 <span class="keywordflow">if</span>(has_looped==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; weekday &gt;= pref_time_wday)
<a name="l01868"></a>01868                         <span class="keywordflow">break</span>;
<a name="l01869"></a>01869 
<a name="l01870"></a>01870                 <span class="keywordflow">if</span>(weekday&gt;=7){
<a name="l01871"></a>01871                         weekday-=7;
<a name="l01872"></a>01872                         has_looped=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01873"></a>01873                         }
<a name="l01874"></a>01874 
<a name="l01875"></a>01875                 <span class="comment">/* calculate start of this future weekday */</span>
<a name="l01876"></a>01876                 day_start=(time_t)(midnight + (days_into_the_future*3600*24));
<a name="l01877"></a>01877 
<a name="l01878"></a>01878                 <span class="comment">/* we already found a time from a higher-precendence date range exception */</span>
<a name="l01879"></a>01879                 <span class="keywordflow">if</span>(day_start==earliest_day)
<a name="l01880"></a>01880                         <span class="keywordflow">continue</span>;
<a name="l01881"></a>01881 
<a name="l01882"></a>01882                 <span class="comment">/* check all time ranges for this day of the week */</span>
<a name="l01883"></a>01883                 <span class="keywordflow">for</span>(temp_timerange=tperiod-&gt;<a class="code" href="structtimeperiod__struct.html#a80a66ae6bf3d3514a1f10b4d4f62cfd0">days</a>[weekday];temp_timerange!=NULL;temp_timerange=temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#afd9ea6d61bbc09f855fa17b65e06b8c0">next</a>){
<a name="l01884"></a>01884 
<a name="l01885"></a>01885                         <span class="comment">/* calculate the time for the start of this time range */</span>
<a name="l01886"></a>01886                         day_range_start=(time_t)(day_start + temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#a472faf570efd10d46cc3cb49bbed58b4">range_start</a>);
<a name="l01887"></a>01887                         day_range_end=(time_t)(day_start + temp_timerange-&gt;<a class="code" href="structtimerange__struct.html#a399206befe1b5e7efc7f8215f3f23fbd">range_end</a>);
<a name="l01888"></a>01888 
<a name="l01889"></a>01889                         <span class="keywordflow">if</span>((have_latest_time==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> || day_range_end&lt;latest_time) &amp;&amp; day_range_end&gt;=preferred_time){
<a name="l01890"></a>01890                                 have_latest_time=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01891"></a>01891                                 latest_time=day_range_end;
<a name="l01892"></a>01892                                 earliest_day=day_start;
<a name="l01893"></a>01893                                 }
<a name="l01894"></a>01894                         }
<a name="l01895"></a>01895                 }
<a name="l01896"></a>01896 
<a name="l01897"></a>01897 
<a name="l01898"></a>01898         <span class="comment">/* if we couldn&#39;t find a time period there must be none defined */</span>
<a name="l01899"></a>01899         <span class="keywordflow">if</span>(have_latest_time==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> || latest_time==(time_t)0)
<a name="l01900"></a>01900                 *valid_time=(time_t)preferred_time;
<a name="l01901"></a>01901 
<a name="l01902"></a>01902         <span class="comment">/* else use the calculated time */</span>
<a name="l01903"></a>01903         <span class="keywordflow">else</span>
<a name="l01904"></a>01904                 *valid_time=<a class="code" href="histogram_8c.html#a3fafe5129cbf9bcd75b864c31daf4464">latest_time</a>;
<a name="l01905"></a>01905 
<a name="l01906"></a>01906         <span class="keywordflow">return</span>;
<a name="l01907"></a>01907         }
<a name="l01908"></a>01908 
<a name="l01909"></a>01909 
<a name="l01910"></a>01910 
<a name="l01911"></a>01911 <span class="comment">/* given a preferred time, get the next valid time within a time period */</span>
<a name="l01912"></a><a class="code" href="icinga_8h.html#ade4dbae8046c8803673712bff97f5ae2">01912</a> <span class="keywordtype">void</span> <a class="code" href="base_2utils_8c.html#a887cf03e0c7cfc020e10e9f1949aae2e">get_next_valid_time</a>(time_t pref_time, time_t *valid_time, <a class="code" href="structtimeperiod__struct.html">timeperiod</a> *tperiod){
<a name="l01913"></a>01913         time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>=(time_t)0L;
<a name="l01914"></a>01914 
<a name="l01915"></a>01915         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;get_next_valid_time()\n&quot;</span>);
<a name="l01916"></a>01916 
<a name="l01917"></a>01917         <span class="comment">/* get time right now, preferred time must be now or in the future */</span>
<a name="l01918"></a>01918         time(&amp;current_time);
<a name="l01919"></a>01919 
<a name="l01920"></a>01920         <a class="code" href="base_2utils_8c.html#a749cae5cd9c695f214a89f5b6b969cc5">_get_next_valid_time</a>(pref_time, current_time, valid_time, tperiod);
<a name="l01921"></a>01921 }
<a name="l01922"></a>01922 
<a name="l01923"></a>01923 
<a name="l01924"></a>01924 
<a name="l01925"></a>01925 <span class="comment">/* tests if a date range covers just a single day */</span>
<a name="l01926"></a><a class="code" href="icinga_8h.html#a1776fc3cf7f0df6a031429aa94e40cdb">01926</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a79145211870703746ce61d4a9ca23a3d">is_daterange_single_day</a>(<a class="code" href="structdaterange__struct.html">daterange</a> *dr){
<a name="l01927"></a>01927 
<a name="l01928"></a>01928         <span class="keywordflow">if</span>(dr==NULL)
<a name="l01929"></a>01929                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01930"></a>01930 
<a name="l01931"></a>01931         <span class="keywordflow">if</span>(dr-&gt;<a class="code" href="structdaterange__struct.html#afb9081e26e6d1d876caab0819faba099">syear</a>!=dr-&gt;<a class="code" href="structdaterange__struct.html#aced1e14d0e382f397d41fe9d186af11b">eyear</a>)
<a name="l01932"></a>01932                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01933"></a>01933         <span class="keywordflow">if</span>(dr-&gt;<a class="code" href="structdaterange__struct.html#a193b929d793c4af88306041edfd4d529">smon</a>!=dr-&gt;<a class="code" href="structdaterange__struct.html#aeb1e9d3ef62b0e9da83e4176e6f1d2bd">emon</a>)
<a name="l01934"></a>01934                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01935"></a>01935         <span class="keywordflow">if</span>(dr-&gt;<a class="code" href="structdaterange__struct.html#a2b11fe1c52944be6794b98970ec4e1c4">smday</a>!=dr-&gt;<a class="code" href="structdaterange__struct.html#a7d5cecb5fb2611d4d4cb7beae93bdec1">emday</a>)
<a name="l01936"></a>01936                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01937"></a>01937         <span class="keywordflow">if</span>(dr-&gt;<a class="code" href="structdaterange__struct.html#a043846fe0bcb8e61f2860508391f4f4b">swday</a>!=dr-&gt;<a class="code" href="structdaterange__struct.html#abc5090255e6001c7b681566af5150003">ewday</a>)
<a name="l01938"></a>01938                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01939"></a>01939         <span class="keywordflow">if</span>(dr-&gt;<a class="code" href="structdaterange__struct.html#ac4f374102495f80f724c0e9fe1072eaa">swday_offset</a>!=dr-&gt;<a class="code" href="structdaterange__struct.html#a3582804a2df2c892d8d1e2f059f67230">ewday_offset</a>)
<a name="l01940"></a>01940                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01941"></a>01941 
<a name="l01942"></a>01942         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01943"></a>01943         }
<a name="l01944"></a>01944 
<a name="l01945"></a>01945 
<a name="l01946"></a>01946 
<a name="l01947"></a>01947 <span class="comment">/* returns a time (midnight) of particular (3rd, last) day in a given month */</span>
<a name="l01948"></a><a class="code" href="icinga_8h.html#a0bc2e802e86ce86dfadd665edd4533a2">01948</a> time_t <a class="code" href="base_2utils_8c.html#aaf5efd888d823a352f904379a1f941b3">calculate_time_from_day_of_month</a>(<span class="keywordtype">int</span> year, <span class="keywordtype">int</span> month, <span class="keywordtype">int</span> monthday){
<a name="l01949"></a>01949         time_t midnight;
<a name="l01950"></a>01950         <span class="keywordtype">int</span> day=0;
<a name="l01951"></a>01951         <span class="keyword">struct </span>tm t;
<a name="l01952"></a>01952 
<a name="l01953"></a>01953 <span class="preprocessor">#ifdef TEST_TIMEPERIODS</span>
<a name="l01954"></a>01954 <span class="preprocessor"></span>        printf(<span class="stringliteral">&quot;YEAR: %d, MON: %d, MDAY: %d\n&quot;</span>,year,month,monthday);
<a name="l01955"></a>01955 <span class="preprocessor">#endif</span>
<a name="l01956"></a>01956 <span class="preprocessor"></span>
<a name="l01957"></a>01957         <span class="comment">/* positive day (3rd day) */</span>
<a name="l01958"></a>01958         <span class="keywordflow">if</span>(monthday&gt;0){
<a name="l01959"></a>01959 
<a name="l01960"></a>01960                 t.tm_sec=0;
<a name="l01961"></a>01961                 t.tm_min=0;
<a name="l01962"></a>01962                 t.tm_hour=0;
<a name="l01963"></a>01963                 t.tm_year=year;
<a name="l01964"></a>01964                 t.tm_mon=month;
<a name="l01965"></a>01965                 t.tm_mday=monthday;
<a name="l01966"></a>01966                 t.tm_isdst=-1;
<a name="l01967"></a>01967 
<a name="l01968"></a>01968                 midnight=mktime(&amp;t);
<a name="l01969"></a>01969 
<a name="l01970"></a>01970 <span class="preprocessor">#ifdef TEST_TIMEPERIODS</span>
<a name="l01971"></a>01971 <span class="preprocessor"></span>                printf(<span class="stringliteral">&quot;MIDNIGHT CALC: %s&quot;</span>,ctime(&amp;midnight));
<a name="l01972"></a>01972 <span class="preprocessor">#endif</span>
<a name="l01973"></a>01973 <span class="preprocessor"></span>
<a name="l01974"></a>01974                 <span class="comment">/* if we rolled over to the next month, time is invalid */</span>
<a name="l01975"></a>01975                 <span class="comment">/* assume the user&#39;s intention is to keep it in the current month */</span>
<a name="l01976"></a>01976                 <span class="keywordflow">if</span>(t.tm_mon!=month)
<a name="l01977"></a>01977                         midnight=(time_t)0L;
<a name="l01978"></a>01978                 }
<a name="l01979"></a>01979 
<a name="l01980"></a>01980         <span class="comment">/* negative offset (last day, 3rd to last day) */</span>
<a name="l01981"></a>01981         <span class="keywordflow">else</span>{
<a name="l01982"></a>01982                 <span class="comment">/* find last day in the month */</span>
<a name="l01983"></a>01983                 day=32;
<a name="l01984"></a>01984                 <span class="keywordflow">do</span>{
<a name="l01985"></a>01985                         <span class="comment">/* back up a day */</span>
<a name="l01986"></a>01986                         day--;
<a name="l01987"></a>01987 
<a name="l01988"></a>01988                         <span class="comment">/* make the new time */</span>
<a name="l01989"></a>01989                         t.tm_mon=month;
<a name="l01990"></a>01990                         t.tm_year=year;
<a name="l01991"></a>01991                         t.tm_mday=day;
<a name="l01992"></a>01992                         t.tm_isdst=-1;
<a name="l01993"></a>01993                         midnight=mktime(&amp;t);
<a name="l01994"></a>01994 
<a name="l01995"></a>01995                         }<span class="keywordflow">while</span>(t.tm_mon!=month);
<a name="l01996"></a>01996 
<a name="l01997"></a>01997                 <span class="comment">/* now that we know the last day, back up more */</span>
<a name="l01998"></a>01998                 <span class="comment">/* make the new time */</span>
<a name="l01999"></a>01999                 t.tm_mon=month;
<a name="l02000"></a>02000                 t.tm_year=year;
<a name="l02001"></a>02001                 <span class="comment">/* -1 means last day of month, so add one to to make this correct - Mike Bird */</span>
<a name="l02002"></a>02002                 t.tm_mday+=(monthday&lt;-30)?-30:monthday+1;
<a name="l02003"></a>02003                 t.tm_isdst=-1;
<a name="l02004"></a>02004                 midnight=mktime(&amp;t);
<a name="l02005"></a>02005 
<a name="l02006"></a>02006                 <span class="comment">/* if we rolled over to the previous month, time is invalid */</span>
<a name="l02007"></a>02007                 <span class="comment">/* assume the user&#39;s intention is to keep it in the current month */</span>
<a name="l02008"></a>02008                 <span class="keywordflow">if</span>(t.tm_mon!=month)
<a name="l02009"></a>02009                         midnight=(time_t)0L;
<a name="l02010"></a>02010                 }
<a name="l02011"></a>02011 
<a name="l02012"></a>02012         <span class="keywordflow">return</span> midnight;
<a name="l02013"></a>02013         }
<a name="l02014"></a>02014 
<a name="l02015"></a>02015 
<a name="l02016"></a>02016 
<a name="l02017"></a>02017 <span class="comment">/* returns a time (midnight) of particular (3rd, last) weekday in a given month */</span>
<a name="l02018"></a><a class="code" href="icinga_8h.html#aa56f969337843d544bd998883c792cd6">02018</a> time_t <a class="code" href="base_2utils_8c.html#aa379bf40b48f3ea5f97d2cf69154a472">calculate_time_from_weekday_of_month</a>(<span class="keywordtype">int</span> year, <span class="keywordtype">int</span> month, <span class="keywordtype">int</span> weekday, <span class="keywordtype">int</span> weekday_offset){
<a name="l02019"></a>02019         time_t midnight;
<a name="l02020"></a>02020         <span class="keywordtype">int</span> days=0;
<a name="l02021"></a>02021         <span class="keywordtype">int</span> weeks=0;
<a name="l02022"></a>02022         <span class="keyword">struct </span>tm t;
<a name="l02023"></a>02023 
<a name="l02024"></a>02024         t.tm_sec=0;
<a name="l02025"></a>02025         t.tm_min=0;
<a name="l02026"></a>02026         t.tm_hour=0;
<a name="l02027"></a>02027         t.tm_year=year;
<a name="l02028"></a>02028         t.tm_mon=month;
<a name="l02029"></a>02029         t.tm_mday=1;
<a name="l02030"></a>02030         t.tm_isdst=-1;
<a name="l02031"></a>02031 
<a name="l02032"></a>02032         midnight=mktime(&amp;t);
<a name="l02033"></a>02033 
<a name="l02034"></a>02034         <span class="comment">/* how many days must we advance to reach the first instance of the weekday this month? */</span>
<a name="l02035"></a>02035         days=weekday-(t.tm_wday);
<a name="l02036"></a>02036         <span class="keywordflow">if</span>(days&lt;0)
<a name="l02037"></a>02037                 days+=7;
<a name="l02038"></a>02038 
<a name="l02039"></a>02039         <span class="comment">/* positive offset (3rd thursday) */</span>
<a name="l02040"></a>02040         <span class="keywordflow">if</span>(weekday_offset&gt;0){
<a name="l02041"></a>02041 
<a name="l02042"></a>02042                 <span class="comment">/* how many weeks must we advance (no more than 5 possible) */</span>
<a name="l02043"></a>02043                 weeks=(weekday_offset&gt;5)?5:weekday_offset;
<a name="l02044"></a>02044                 days+=((weeks-1)*7);
<a name="l02045"></a>02045 
<a name="l02046"></a>02046                 <span class="comment">/* make the new time */</span>
<a name="l02047"></a>02047                 t.tm_mon=month;
<a name="l02048"></a>02048                 t.tm_year=year;
<a name="l02049"></a>02049                 t.tm_mday=days+1;
<a name="l02050"></a>02050                 t.tm_isdst=-1;
<a name="l02051"></a>02051                 midnight=mktime(&amp;t);
<a name="l02052"></a>02052 
<a name="l02053"></a>02053                 <span class="comment">/* if we rolled over to the next month, time is invalid */</span>
<a name="l02054"></a>02054                 <span class="comment">/* assume the user&#39;s intention is to keep it in the current month */</span>
<a name="l02055"></a>02055                 <span class="keywordflow">if</span>(t.tm_mon!=month)
<a name="l02056"></a>02056                         midnight=(time_t)0L;
<a name="l02057"></a>02057                 }
<a name="l02058"></a>02058 
<a name="l02059"></a>02059         <span class="comment">/* negative offset (last thursday, 3rd to last tuesday) */</span>
<a name="l02060"></a>02060         <span class="keywordflow">else</span>{
<a name="l02061"></a>02061                 <span class="comment">/* find last instance of weekday in the month */</span>
<a name="l02062"></a>02062                 days+=(5*7);
<a name="l02063"></a>02063                 <span class="keywordflow">do</span>{
<a name="l02064"></a>02064                         <span class="comment">/* back up a week */</span>
<a name="l02065"></a>02065                         days-=7;
<a name="l02066"></a>02066 
<a name="l02067"></a>02067                         <span class="comment">/* make the new time */</span>
<a name="l02068"></a>02068                         t.tm_mon=month;
<a name="l02069"></a>02069                         t.tm_year=year;
<a name="l02070"></a>02070                         t.tm_mday=days+1;
<a name="l02071"></a>02071                         t.tm_isdst=-1;
<a name="l02072"></a>02072                         midnight=mktime(&amp;t);
<a name="l02073"></a>02073 
<a name="l02074"></a>02074                         }<span class="keywordflow">while</span>(t.tm_mon!=month);
<a name="l02075"></a>02075 
<a name="l02076"></a>02076                 <span class="comment">/* now that we know the last instance of the weekday, back up more */</span>
<a name="l02077"></a>02077                 weeks=(weekday_offset&lt;-5)?-5:weekday_offset;
<a name="l02078"></a>02078                 days=((weeks+1)*7);
<a name="l02079"></a>02079 
<a name="l02080"></a>02080                 <span class="comment">/* make the new time */</span>
<a name="l02081"></a>02081                 t.tm_mon=month;
<a name="l02082"></a>02082                 t.tm_year=year;
<a name="l02083"></a>02083                 t.tm_mday+=days;
<a name="l02084"></a>02084                 t.tm_isdst=-1;
<a name="l02085"></a>02085                 midnight=mktime(&amp;t);
<a name="l02086"></a>02086 
<a name="l02087"></a>02087                 <span class="comment">/* if we rolled over to the previous month, time is invalid */</span>
<a name="l02088"></a>02088                 <span class="comment">/* assume the user&#39;s intention is to keep it in the current month */</span>
<a name="l02089"></a>02089                 <span class="keywordflow">if</span>(t.tm_mon!=month)
<a name="l02090"></a>02090                         midnight=(time_t)0L;
<a name="l02091"></a>02091                 }
<a name="l02092"></a>02092 
<a name="l02093"></a>02093         <span class="keywordflow">return</span> midnight;
<a name="l02094"></a>02094         }
<a name="l02095"></a>02095 
<a name="l02096"></a>02096 
<a name="l02097"></a>02097 <span class="comment">/* get the next time to schedule a log rotation */</span>
<a name="l02098"></a><a class="code" href="icinga_8h.html#aa31508af7595746f01487a440cdaa9bf">02098</a> time_t <a class="code" href="base_2utils_8c.html#aa31508af7595746f01487a440cdaa9bf">get_next_log_rotation_time</a>(<span class="keywordtype">void</span>){
<a name="l02099"></a>02099         time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>;
<a name="l02100"></a>02100         <span class="keyword">struct </span>tm *t, tm_s;
<a name="l02101"></a>02101         <span class="keywordtype">int</span> is_dst_now=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02102"></a>02102         time_t run_time;
<a name="l02103"></a>02103 
<a name="l02104"></a>02104         time(&amp;current_time);
<a name="l02105"></a>02105         t = localtime_r(&amp;current_time, &amp;tm_s);
<a name="l02106"></a>02106         t-&gt;tm_min=0;
<a name="l02107"></a>02107         t-&gt;tm_sec=0;
<a name="l02108"></a>02108         is_dst_now=(t-&gt;tm_isdst&gt;0)?<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>:<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02109"></a>02109 
<a name="l02110"></a>02110         <span class="keywordflow">switch</span>(<a class="code" href="base_2config_8c.html#ab994c46c876a9f9f338e28c170dd3e4e">log_rotation_method</a>){
<a name="l02111"></a>02111         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#ad811f9e7ccc3eaf886245e53adbfd0c4">LOG_ROTATION_HOURLY</a>:
<a name="l02112"></a>02112                 t-&gt;tm_hour++;
<a name="l02113"></a>02113                 run_time=mktime(t);
<a name="l02114"></a>02114                 <span class="keywordflow">break</span>;
<a name="l02115"></a>02115         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a5f6c365a2559e13a7c30ab8020655601">LOG_ROTATION_DAILY</a>:
<a name="l02116"></a>02116                 t-&gt;tm_mday++;
<a name="l02117"></a>02117                 t-&gt;tm_hour=0;
<a name="l02118"></a>02118                 run_time=mktime(t);
<a name="l02119"></a>02119                 <span class="keywordflow">break</span>;
<a name="l02120"></a>02120         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#a1f125b0440607d99802eb80722a5e6c2">LOG_ROTATION_WEEKLY</a>:
<a name="l02121"></a>02121                 t-&gt;tm_mday+=(7-t-&gt;tm_wday);
<a name="l02122"></a>02122                 t-&gt;tm_hour=0;
<a name="l02123"></a>02123                 run_time=mktime(t);
<a name="l02124"></a>02124                 <span class="keywordflow">break</span>;
<a name="l02125"></a>02125         <span class="keywordflow">case</span> <a class="code" href="include_2common_8h.html#aed239f299f584868fc2eb5f0be5c067a">LOG_ROTATION_MONTHLY</a>:
<a name="l02126"></a>02126         <span class="keywordflow">default</span>:
<a name="l02127"></a>02127                 t-&gt;tm_mon++;
<a name="l02128"></a>02128                 t-&gt;tm_mday=1;
<a name="l02129"></a>02129                 t-&gt;tm_hour=0;
<a name="l02130"></a>02130                 run_time=mktime(t);
<a name="l02131"></a>02131                 <span class="keywordflow">break</span>;
<a name="l02132"></a>02132                 }
<a name="l02133"></a>02133 
<a name="l02134"></a>02134         <span class="keywordflow">if</span>(is_dst_now==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; t-&gt;tm_isdst==0)
<a name="l02135"></a>02135                 run_time+=3600;
<a name="l02136"></a>02136         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(is_dst_now==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> &amp;&amp; t-&gt;tm_isdst&gt;0)
<a name="l02137"></a>02137                 run_time-=3600;
<a name="l02138"></a>02138 
<a name="l02139"></a>02139         <span class="keywordflow">return</span> run_time;
<a name="l02140"></a>02140         }
<a name="l02141"></a>02141 
<a name="l02142"></a>02142 
<a name="l02143"></a>02143 
<a name="l02144"></a>02144 <span class="comment">/******************************************************************/</span>
<a name="l02145"></a>02145 <span class="comment">/******************** SIGNAL HANDLER FUNCTIONS ********************/</span>
<a name="l02146"></a>02146 <span class="comment">/******************************************************************/</span>
<a name="l02147"></a>02147 
<a name="l02148"></a>02148 
<a name="l02149"></a>02149 <span class="comment">/* trap signals so we can exit gracefully */</span>
<a name="l02150"></a><a class="code" href="icinga_8h.html#a27963b96111eca3c22923a79fcc572d3">02150</a> <span class="keywordtype">void</span> <a class="code" href="base_2utils_8c.html#a27963b96111eca3c22923a79fcc572d3">setup_sighandler</a>(<span class="keywordtype">void</span>){
<a name="l02151"></a>02151 
<a name="l02152"></a>02152         <span class="comment">/* reset the shutdown flag */</span>
<a name="l02153"></a>02153         <a class="code" href="checks_8c.html#a2b5f7762caad7a548645f2d9c4cdee47">sigshutdown</a>=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02154"></a>02154 
<a name="l02155"></a>02155         <span class="comment">/* remove buffering from stderr, stdin, and stdout */</span>
<a name="l02156"></a>02156         setbuf(stdin,(<span class="keywordtype">char</span> *)NULL);
<a name="l02157"></a>02157         setbuf(stdout,(<span class="keywordtype">char</span> *)NULL);
<a name="l02158"></a>02158         setbuf(stderr,(<span class="keywordtype">char</span> *)NULL);
<a name="l02159"></a>02159 
<a name="l02160"></a>02160         <span class="comment">/* initialize signal handling */</span>
<a name="l02161"></a>02161         signal(SIGPIPE,SIG_IGN);
<a name="l02162"></a>02162         signal(SIGQUIT,<a class="code" href="base_2utils_8c.html#abd382ad3c8079e6bd94332234d24f5a0">sighandler</a>);
<a name="l02163"></a>02163         signal(SIGTERM,<a class="code" href="base_2utils_8c.html#abd382ad3c8079e6bd94332234d24f5a0">sighandler</a>);
<a name="l02164"></a>02164         signal(SIGHUP,<a class="code" href="base_2utils_8c.html#abd382ad3c8079e6bd94332234d24f5a0">sighandler</a>);
<a name="l02165"></a>02165         <span class="keywordflow">if</span>(<a class="code" href="base_2config_8c.html#ae99471075b1351740cb0aa515527e59f">daemon_dumps_core</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> &amp;&amp; <a class="code" href="broker_8c.html#a4255d3efd1474d8e9d267e4b1559c1f9">daemon_mode</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l02166"></a>02166                 signal(SIGSEGV,<a class="code" href="base_2utils_8c.html#abd382ad3c8079e6bd94332234d24f5a0">sighandler</a>);
<a name="l02167"></a>02167 
<a name="l02168"></a>02168         <span class="keywordflow">return</span>;
<a name="l02169"></a>02169         }
<a name="l02170"></a>02170 
<a name="l02171"></a>02171 
<a name="l02172"></a>02172 <span class="comment">/* reset signal handling... */</span>
<a name="l02173"></a><a class="code" href="icinga_8h.html#a1686ce1c6b73859e70249769c544999a">02173</a> <span class="keywordtype">void</span> <a class="code" href="base_2utils_8c.html#a1686ce1c6b73859e70249769c544999a">reset_sighandler</a>(<span class="keywordtype">void</span>){
<a name="l02174"></a>02174 
<a name="l02175"></a>02175         <span class="comment">/* set signal handling to default actions */</span>
<a name="l02176"></a>02176         signal(SIGQUIT,SIG_DFL);
<a name="l02177"></a>02177         signal(SIGTERM,SIG_DFL);
<a name="l02178"></a>02178         signal(SIGHUP,SIG_DFL);
<a name="l02179"></a>02179         signal(SIGSEGV,SIG_DFL);
<a name="l02180"></a>02180         signal(SIGPIPE,SIG_DFL);
<a name="l02181"></a>02181 
<a name="l02182"></a>02182         <span class="keywordflow">return</span>;
<a name="l02183"></a>02183         }
<a name="l02184"></a>02184 
<a name="l02185"></a>02185 
<a name="l02186"></a>02186 <span class="comment">/* handle signals */</span>
<a name="l02187"></a><a class="code" href="sockdebug_8c.html#a4bbdbc434dbf29d4b09821dbfb477100">02187</a> <span class="keywordtype">void</span> <a class="code" href="base_2utils_8c.html#abd382ad3c8079e6bd94332234d24f5a0">sighandler</a>(<span class="keywordtype">int</span> sig){
<a name="l02188"></a>02188         <span class="keywordtype">int</span> x=0;
<a name="l02189"></a>02189 
<a name="l02190"></a>02190         <span class="comment">/* if shutdown is already true, we&#39;re in a signal trap loop! */</span>
<a name="l02191"></a>02191         <span class="comment">/* changed 09/07/06 to only exit on segfaults */</span>
<a name="l02192"></a>02192         <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#a2b5f7762caad7a548645f2d9c4cdee47">sigshutdown</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; sig==SIGSEGV)
<a name="l02193"></a>02193                 exit(<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>);
<a name="l02194"></a>02194 
<a name="l02195"></a>02195         <a class="code" href="icinga_8c.html#aca9bbdce369ba2a9376650249a4d57a3">caught_signal</a>=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02196"></a>02196 
<a name="l02197"></a>02197         <span class="keywordflow">if</span>(sig&lt;0)
<a name="l02198"></a>02198                 sig=-sig;
<a name="l02199"></a>02199 
<a name="l02200"></a>02200         <span class="keywordflow">for</span>(x=0;<a class="code" href="icinga_8c.html#a8b84b2f08d8a7a6a7f1e6dff51b4b7f0">sigs</a>[x]!=(<span class="keywordtype">char</span> *)NULL;x++);
<a name="l02201"></a>02201         sig%=x;
<a name="l02202"></a>02202 
<a name="l02203"></a>02203         <a class="code" href="icinga_8c.html#a502e2f89c462dc55db74ad66cecd89ba">sig_id</a>=sig;
<a name="l02204"></a>02204 
<a name="l02205"></a>02205         <span class="comment">/* log errors about segfaults now, as we might not get a chance to later */</span>
<a name="l02206"></a>02206         <span class="comment">/* all other signals are logged at a later point in main() to prevent problems with NPTL */</span>
<a name="l02207"></a>02207         <span class="keywordflow">if</span>(sig==SIGSEGV)
<a name="l02208"></a>02208                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a22cc13d1c001b95c6c68386fe98d5b17">NSLOG_PROCESS_INFO</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Caught SIG%s, shutting down...\n&quot;</span>,<a class="code" href="icinga_8c.html#a8b84b2f08d8a7a6a7f1e6dff51b4b7f0">sigs</a>[sig]);
<a name="l02209"></a>02209 
<a name="l02210"></a>02210         <span class="comment">/* we received a SIGHUP, so restart... */</span>
<a name="l02211"></a>02211         <span class="keywordflow">if</span>(sig==SIGHUP)
<a name="l02212"></a>02212                 <a class="code" href="checks_8c.html#aadf2eea990498582cc7dac355c3d7e71">sigrestart</a>=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02213"></a>02213 
<a name="l02214"></a>02214         <span class="comment">/* else begin shutting down... */</span>
<a name="l02215"></a>02215         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(sig&lt;16)
<a name="l02216"></a>02216                 <a class="code" href="checks_8c.html#a2b5f7762caad7a548645f2d9c4cdee47">sigshutdown</a>=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02217"></a>02217 
<a name="l02218"></a>02218         <span class="keywordflow">return</span>;
<a name="l02219"></a>02219         }
<a name="l02220"></a>02220 
<a name="l02221"></a>02221 
<a name="l02222"></a>02222 <span class="comment">/* handle timeouts when executing service checks */</span>
<a name="l02223"></a>02223 <span class="comment">/* 07/16/08 EG also called when parent process gets a TERM signal */</span>
<a name="l02224"></a><a class="code" href="icinga_8h.html#aa0bb6f8fbf8f771c22e86cd8bed0b467">02224</a> <span class="keywordtype">void</span> <a class="code" href="base_2utils_8c.html#a2da0cda493fadb6f7040b9b078b67327">service_check_sighandler</a>(<span class="keywordtype">int</span> sig){
<a name="l02225"></a>02225         <span class="keyword">struct </span>timeval end_time;
<a name="l02226"></a>02226 
<a name="l02227"></a>02227         <span class="comment">/* get the current time */</span>
<a name="l02228"></a>02228         gettimeofday(&amp;end_time,NULL);
<a name="l02229"></a>02229 
<a name="l02230"></a>02230         check_result_info.<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>=<a class="code" href="base_2config_8c.html#ab754e7bcef1c0ed0f0334cdf12178b6b">service_check_timeout_state</a>;
<a name="l02231"></a>02231         check_result_info.<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>=<a class="code" href="cmd_8c.html#a1e324d62e65642694c00de363bf8a8ba">end_time</a>;
<a name="l02232"></a>02232         check_result_info.<a class="code" href="structcheck__result__struct.html#a8fd6dc8e62fa817f85971b929d2a50ea">early_timeout</a>=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02233"></a>02233 
<a name="l02234"></a>02234         <span class="comment">/* write check result to file */</span>
<a name="l02235"></a>02235         <span class="keywordflow">if</span>(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>){
<a name="l02236"></a>02236 
<a name="l02237"></a>02237                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;finish_time=%lu.%lu\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_sec,check_result_info.<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_usec);
<a name="l02238"></a>02238                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;early_timeout=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#a8fd6dc8e62fa817f85971b929d2a50ea">early_timeout</a>);
<a name="l02239"></a>02239                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;exited_ok=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#acdf1b91b61c379a2e1c42421ac1f76b8">exited_ok</a>);
<a name="l02240"></a>02240                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;return_code=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>);
<a name="l02241"></a>02241                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;output=%s\n&quot;</span>,<span class="stringliteral">&quot;(Service Check Timed Out)&quot;</span>);
<a name="l02242"></a>02242 
<a name="l02243"></a>02243                 <span class="comment">/* close the temp file */</span>
<a name="l02244"></a>02244                 fclose(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>);
<a name="l02245"></a>02245 
<a name="l02246"></a>02246                 <span class="comment">/* move check result to queue directory */</span>
<a name="l02247"></a>02247                 <a class="code" href="base_2utils_8c.html#a69855a30b12dfe19f6663bc9165bb1cf">move_check_result_to_queue</a>(check_result_info.<a class="code" href="structcheck__result__struct.html#a1ef7b671552d6ed92421a522c4127bf6">output_file</a>);
<a name="l02248"></a>02248                 }
<a name="l02249"></a>02249 
<a name="l02250"></a>02250         <span class="comment">/* free check result memory */</span>
<a name="l02251"></a>02251         <a class="code" href="base_2utils_8c.html#a36701093a323ae768707b7a025a13e01">free_check_result</a>(&amp;check_result_info);
<a name="l02252"></a>02252 
<a name="l02253"></a>02253         <span class="comment">/* try to kill the command that timed out by sending termination signal to our process group */</span>
<a name="l02254"></a>02254         <span class="comment">/* we also kill ourselves while doing this... */</span>
<a name="l02255"></a>02255         kill((pid_t)0,SIGKILL);
<a name="l02256"></a>02256 
<a name="l02257"></a>02257         <span class="comment">/* force the child process (service check) to exit... */</span>
<a name="l02258"></a>02258         _exit(<a class="code" href="cgiutils_8h.html#a19827c887254e66b983c3269a42562bc">STATE_CRITICAL</a>);
<a name="l02259"></a>02259         }
<a name="l02260"></a>02260 
<a name="l02261"></a>02261 
<a name="l02262"></a>02262 <span class="comment">/* handle timeouts when executing host checks */</span>
<a name="l02263"></a>02263 <span class="comment">/* 07/16/08 EG also called when parent process gets a TERM signal */</span>
<a name="l02264"></a><a class="code" href="icinga_8h.html#aff5c7058cb4b7c92071d2ae8efd5cc48">02264</a> <span class="keywordtype">void</span> <a class="code" href="base_2utils_8c.html#a28a203010e63d8b8d56381211cdf8bc4">host_check_sighandler</a>(<span class="keywordtype">int</span> sig){
<a name="l02265"></a>02265         <span class="keyword">struct </span>timeval end_time;
<a name="l02266"></a>02266 
<a name="l02267"></a>02267         <span class="comment">/* get the current time */</span>
<a name="l02268"></a>02268         gettimeofday(&amp;end_time,NULL);
<a name="l02269"></a>02269 
<a name="l02270"></a>02270         check_result_info.<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>=<a class="code" href="cgiutils_8h.html#a19827c887254e66b983c3269a42562bc">STATE_CRITICAL</a>;
<a name="l02271"></a>02271         check_result_info.<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>=<a class="code" href="cmd_8c.html#a1e324d62e65642694c00de363bf8a8ba">end_time</a>;
<a name="l02272"></a>02272         check_result_info.<a class="code" href="structcheck__result__struct.html#a8fd6dc8e62fa817f85971b929d2a50ea">early_timeout</a>=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02273"></a>02273 
<a name="l02274"></a>02274         <span class="comment">/* write check result to file */</span>
<a name="l02275"></a>02275         <span class="keywordflow">if</span>(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>){
<a name="l02276"></a>02276 
<a name="l02277"></a>02277                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;finish_time=%lu.%lu\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_sec,check_result_info.<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_usec);
<a name="l02278"></a>02278                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;early_timeout=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#a8fd6dc8e62fa817f85971b929d2a50ea">early_timeout</a>);
<a name="l02279"></a>02279                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;exited_ok=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#acdf1b91b61c379a2e1c42421ac1f76b8">exited_ok</a>);
<a name="l02280"></a>02280                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;return_code=%d\n&quot;</span>,check_result_info.<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>);
<a name="l02281"></a>02281                 fprintf(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>,<span class="stringliteral">&quot;output=%s\n&quot;</span>,<span class="stringliteral">&quot;(Host Check Timed Out)&quot;</span>);
<a name="l02282"></a>02282 
<a name="l02283"></a>02283                 <span class="comment">/* close the temp file */</span>
<a name="l02284"></a>02284                 fclose(check_result_info.<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>);
<a name="l02285"></a>02285 
<a name="l02286"></a>02286                 <span class="comment">/* move check result to queue directory */</span>
<a name="l02287"></a>02287                 <a class="code" href="base_2utils_8c.html#a69855a30b12dfe19f6663bc9165bb1cf">move_check_result_to_queue</a>(check_result_info.<a class="code" href="structcheck__result__struct.html#a1ef7b671552d6ed92421a522c4127bf6">output_file</a>);
<a name="l02288"></a>02288                 }
<a name="l02289"></a>02289 
<a name="l02290"></a>02290         <span class="comment">/* free check result memory */</span>
<a name="l02291"></a>02291         <a class="code" href="base_2utils_8c.html#a36701093a323ae768707b7a025a13e01">free_check_result</a>(&amp;check_result_info);
<a name="l02292"></a>02292 
<a name="l02293"></a>02293         <span class="comment">/* try to kill the command that timed out by sending termination signal to our process group */</span>
<a name="l02294"></a>02294         <span class="comment">/* we also kill ourselves while doing this... */</span>
<a name="l02295"></a>02295         kill((pid_t)0,SIGKILL);
<a name="l02296"></a>02296 
<a name="l02297"></a>02297         <span class="comment">/* force the child process (service check) to exit... */</span>
<a name="l02298"></a>02298         _exit(<a class="code" href="cgiutils_8h.html#a19827c887254e66b983c3269a42562bc">STATE_CRITICAL</a>);
<a name="l02299"></a>02299 }
<a name="l02300"></a>02300 
<a name="l02301"></a>02301 
<a name="l02302"></a>02302 <span class="comment">/* handle timeouts when executing commands via my_system_r() */</span>
<a name="l02303"></a><a class="code" href="icinga_8h.html#a324f234e3c698939c84ed1638990b62c">02303</a> <span class="keywordtype">void</span> <a class="code" href="base_2utils_8c.html#a834080b62d6d7fd14afda015a5caa78e">my_system_sighandler</a>(<span class="keywordtype">int</span> sig){
<a name="l02304"></a>02304 
<a name="l02305"></a>02305         <span class="comment">/* force the child process to exit... */</span>
<a name="l02306"></a>02306         _exit(<a class="code" href="cgiutils_8h.html#a19827c887254e66b983c3269a42562bc">STATE_CRITICAL</a>);
<a name="l02307"></a>02307         }
<a name="l02308"></a>02308 
<a name="l02309"></a>02309 
<a name="l02310"></a>02310 
<a name="l02311"></a>02311 
<a name="l02312"></a>02312 <span class="comment">/******************************************************************/</span>
<a name="l02313"></a>02313 <span class="comment">/************************ DAEMON FUNCTIONS ************************/</span>
<a name="l02314"></a>02314 <span class="comment">/******************************************************************/</span>
<a name="l02315"></a>02315 
<a name="l02316"></a><a class="code" href="icinga_8h.html#ab0c78c4962794992755b9e39517292db">02316</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#ab0c78c4962794992755b9e39517292db">daemon_init</a>(<span class="keywordtype">void</span>){
<a name="l02317"></a>02317         pid_t pid=-1;
<a name="l02318"></a>02318         <span class="keywordtype">int</span> pidno=0;
<a name="l02319"></a>02319         <span class="keywordtype">int</span> lockfile=0;
<a name="l02320"></a>02320         <span class="keywordtype">int</span> val=0;
<a name="l02321"></a>02321         <span class="keywordtype">char</span> buf[256];
<a name="l02322"></a>02322         <span class="keyword">struct </span>flock lock;
<a name="l02323"></a>02323         <span class="keywordtype">char</span> *homedir=NULL;
<a name="l02324"></a>02324 
<a name="l02325"></a>02325 <span class="preprocessor">#ifdef RLIMIT_CORE</span>
<a name="l02326"></a>02326 <span class="preprocessor"></span>        <span class="keyword">struct </span>rlimit limit;
<a name="l02327"></a>02327 <span class="preprocessor">#endif</span>
<a name="l02328"></a>02328 <span class="preprocessor"></span>
<a name="l02329"></a>02329         <span class="comment">/* change working directory. scuttle home if we&#39;re dumping core */</span>
<a name="l02330"></a>02330         homedir=getenv(<span class="stringliteral">&quot;HOME&quot;</span>);
<a name="l02331"></a>02331         <span class="keywordflow">if</span>(<a class="code" href="base_2config_8c.html#ae99471075b1351740cb0aa515527e59f">daemon_dumps_core</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; homedir!=NULL)
<a name="l02332"></a>02332                 <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=chdir(homedir);
<a name="l02333"></a>02333         <span class="keywordflow">else</span>
<a name="l02334"></a>02334                 <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=chdir(<span class="stringliteral">&quot;/&quot;</span>);
<a name="l02335"></a>02335 
<a name="l02336"></a>02336         umask(S_IWGRP|S_IWOTH);
<a name="l02337"></a>02337 
<a name="l02338"></a>02338         lockfile=open(<a class="code" href="base_2config_8c.html#a55d7cb41b1bacf3965ecc3592b0502fa">lock_file</a>,O_RDWR | O_CREAT, S_IWUSR | S_IRUSR | S_IRGRP | S_IROTH);
<a name="l02339"></a>02339 
<a name="l02340"></a>02340         <span class="keywordflow">if</span>(lockfile&lt;0){
<a name="l02341"></a>02341                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Failed to obtain lock on file %s: %s\n&quot;</span>, <a class="code" href="base_2config_8c.html#a55d7cb41b1bacf3965ecc3592b0502fa">lock_file</a>, strerror(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02342"></a>02342                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a22cc13d1c001b95c6c68386fe98d5b17">NSLOG_PROCESS_INFO</a> | <a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Bailing out due to errors encountered while attempting to daemonize... (PID=%d)&quot;</span>,(<span class="keywordtype">int</span>)getpid());
<a name="l02343"></a>02343 
<a name="l02344"></a>02344                 <a class="code" href="base_2utils_8c.html#aeb94fbd457627182ceee7e505f432541">cleanup</a>();
<a name="l02345"></a>02345                 exit(<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>);
<a name="l02346"></a>02346                 }
<a name="l02347"></a>02347 
<a name="l02348"></a>02348         <span class="comment">/* see if we can read the contents of the lockfile */</span>
<a name="l02349"></a>02349         <span class="keywordflow">if</span>((val=read(lockfile,buf,(<span class="keywordtype">size_t</span>)10))&lt;0){
<a name="l02350"></a>02350                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Lockfile exists but cannot be read&quot;</span>);
<a name="l02351"></a>02351                 <a class="code" href="base_2utils_8c.html#aeb94fbd457627182ceee7e505f432541">cleanup</a>();
<a name="l02352"></a>02352                 exit(<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>);
<a name="l02353"></a>02353                 }
<a name="l02354"></a>02354 
<a name="l02355"></a>02355         <span class="comment">/* we read something - check the PID */</span>
<a name="l02356"></a>02356         <span class="keywordflow">if</span>(val&gt;0){
<a name="l02357"></a>02357                 <span class="keywordflow">if</span>((val=sscanf(buf,<span class="stringliteral">&quot;%d&quot;</span>,&amp;pidno))&lt;1){
<a name="l02358"></a>02358                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Lockfile &#39;%s&#39; does not contain a valid PID (%s)&quot;</span>,<a class="code" href="base_2config_8c.html#a55d7cb41b1bacf3965ecc3592b0502fa">lock_file</a>,buf);
<a name="l02359"></a>02359                         <a class="code" href="base_2utils_8c.html#aeb94fbd457627182ceee7e505f432541">cleanup</a>();
<a name="l02360"></a>02360                         exit(<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>);
<a name="l02361"></a>02361                         }
<a name="l02362"></a>02362                 }
<a name="l02363"></a>02363 
<a name="l02364"></a>02364         <span class="comment">/* check for SIGHUP */</span>
<a name="l02365"></a>02365         <span class="keywordflow">if</span>(val==1 &amp;&amp; (pid=(pid_t)pidno)==getpid()){
<a name="l02366"></a>02366                 close(lockfile);
<a name="l02367"></a>02367                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l02368"></a>02368                 }
<a name="l02369"></a>02369 
<a name="l02370"></a>02370         <span class="comment">/* exit on errors... */</span>
<a name="l02371"></a>02371         <span class="keywordflow">if</span>((pid=fork())&lt;0)
<a name="l02372"></a>02372                 <span class="keywordflow">return</span>(<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>);
<a name="l02373"></a>02373 
<a name="l02374"></a>02374         <span class="comment">/* parent process goes away.. */</span>
<a name="l02375"></a>02375         <span class="keywordflow">else</span> <span class="keywordflow">if</span>((<span class="keywordtype">int</span>)pid!=0)
<a name="l02376"></a>02376                 exit(<a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>);
<a name="l02377"></a>02377 
<a name="l02378"></a>02378         <span class="comment">/* child continues... */</span>
<a name="l02379"></a>02379 
<a name="l02380"></a>02380         <span class="comment">/* child becomes session leader... */</span>
<a name="l02381"></a>02381         setsid();
<a name="l02382"></a>02382 
<a name="l02383"></a>02383         <span class="comment">/* place a file lock on the lock file */</span>
<a name="l02384"></a>02384         lock.l_type=F_WRLCK;
<a name="l02385"></a>02385         lock.l_start=0;
<a name="l02386"></a>02386         lock.l_whence=SEEK_SET;
<a name="l02387"></a>02387         lock.l_len=0;
<a name="l02388"></a>02388         <span class="keywordflow">if</span>(fcntl(lockfile,F_SETLK,&amp;lock)&lt;0){
<a name="l02389"></a>02389                 <span class="keywordflow">if</span>(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>==EACCES || <a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>==EAGAIN){
<a name="l02390"></a>02390                         fcntl(lockfile,F_GETLK,&amp;lock);
<a name="l02391"></a>02391                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Lockfile &#39;%s&#39; looks like its already held by another instance of %s (PID %d).  Bailing out...&quot;</span>, <a class="code" href="include_2common_8h.html#a3b6a35b8be8405a9db72cc5dea97954b">PROGRAM_NAME</a>, <a class="code" href="base_2config_8c.html#a55d7cb41b1bacf3965ecc3592b0502fa">lock_file</a>, (<span class="keywordtype">int</span>)lock.l_pid);
<a name="l02392"></a>02392                         }
<a name="l02393"></a>02393                 <span class="keywordflow">else</span>
<a name="l02394"></a>02394                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Cannot lock lockfile &#39;%s&#39;: %s. Bailing out...&quot;</span>,<a class="code" href="base_2config_8c.html#a55d7cb41b1bacf3965ecc3592b0502fa">lock_file</a>,strerror(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02395"></a>02395 
<a name="l02396"></a>02396                 <a class="code" href="base_2utils_8c.html#aeb94fbd457627182ceee7e505f432541">cleanup</a>();
<a name="l02397"></a>02397                 exit(<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>);
<a name="l02398"></a>02398                 }
<a name="l02399"></a>02399 
<a name="l02400"></a>02400         <span class="comment">/* prevent daemon from dumping a core file... */</span>
<a name="l02401"></a>02401 <span class="preprocessor">#ifdef RLIMIT_CORE</span>
<a name="l02402"></a>02402 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(<a class="code" href="base_2config_8c.html#ae99471075b1351740cb0aa515527e59f">daemon_dumps_core</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l02403"></a>02403                 getrlimit(RLIMIT_CORE,&amp;limit);
<a name="l02404"></a>02404                 limit.rlim_cur=0;
<a name="l02405"></a>02405                 setrlimit(RLIMIT_CORE,&amp;limit);
<a name="l02406"></a>02406                 }
<a name="l02407"></a>02407 <span class="preprocessor">#endif</span>
<a name="l02408"></a>02408 <span class="preprocessor"></span>
<a name="l02409"></a>02409         <span class="comment">/* write PID to lockfile... */</span>
<a name="l02410"></a>02410         lseek(lockfile,0,SEEK_SET);
<a name="l02411"></a>02411         <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=ftruncate(lockfile,0);
<a name="l02412"></a>02412         sprintf(buf,<span class="stringliteral">&quot;%d\n&quot;</span>,(<span class="keywordtype">int</span>)getpid());
<a name="l02413"></a>02413         <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=write(lockfile,buf,strlen(buf));
<a name="l02414"></a>02414 
<a name="l02415"></a>02415         <span class="comment">/* make sure lock file stays open while program is executing... */</span>
<a name="l02416"></a>02416         val=fcntl(lockfile,F_GETFD,0);
<a name="l02417"></a>02417         val|=FD_CLOEXEC;
<a name="l02418"></a>02418         fcntl(lockfile,F_SETFD,val);
<a name="l02419"></a>02419 
<a name="l02420"></a>02420         <span class="comment">/* close existing stdin, stdout, stderr */</span>
<a name="l02421"></a>02421         close(0);
<a name="l02422"></a>02422         close(1);
<a name="l02423"></a>02423         close(2);
<a name="l02424"></a>02424 
<a name="l02425"></a>02425         <span class="comment">/* THIS HAS TO BE DONE TO AVOID PROBLEMS WITH STDERR BEING REDIRECTED TO SERVICE MESSAGE PIPE! */</span>
<a name="l02426"></a>02426         <span class="comment">/* re-open stdin, stdout, stderr with known values */</span>
<a name="l02427"></a>02427         open(<span class="stringliteral">&quot;/dev/null&quot;</span>,O_RDONLY);
<a name="l02428"></a>02428         open(<span class="stringliteral">&quot;/dev/null&quot;</span>,O_WRONLY);
<a name="l02429"></a>02429         open(<span class="stringliteral">&quot;/dev/null&quot;</span>,O_WRONLY);
<a name="l02430"></a>02430 
<a name="l02431"></a>02431 <span class="preprocessor">#ifdef USE_EVENT_BROKER</span>
<a name="l02432"></a>02432 <span class="preprocessor"></span>        <span class="comment">/* send program data to broker */</span>
<a name="l02433"></a>02433         <a class="code" href="broker_8h.html#ac3b3a920cabd7e78a5edf10d5025e915">broker_program_state</a>(<a class="code" href="broker_8h.html#a64bdaaf823240d0d161831272fb8349e">NEBTYPE_PROCESS_DAEMONIZE</a>,<a class="code" href="broker_8h.html#ae7b50b735fa9d5baf42ab19525993635">NEBFLAG_NONE</a>,<a class="code" href="broker_8h.html#a2e1afa1e543c76a752561dbc9eb38d65">NEBATTR_NONE</a>,NULL);
<a name="l02434"></a>02434 <span class="preprocessor">#endif</span>
<a name="l02435"></a>02435 <span class="preprocessor"></span>
<a name="l02436"></a>02436         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l02437"></a>02437         }
<a name="l02438"></a>02438 
<a name="l02439"></a>02439 
<a name="l02440"></a>02440 
<a name="l02441"></a>02441 <span class="comment">/******************************************************************/</span>
<a name="l02442"></a>02442 <span class="comment">/*********************** SECURITY FUNCTIONS ***********************/</span>
<a name="l02443"></a>02443 <span class="comment">/******************************************************************/</span>
<a name="l02444"></a>02444 
<a name="l02445"></a>02445 <span class="comment">/* drops privileges */</span>
<a name="l02446"></a><a class="code" href="icinga_8h.html#a3b62295881f52f68a7dc357bd5163b78">02446</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#ab2ed30bc8d926d59453297fb5386dcf8">drop_privileges</a>(<span class="keywordtype">char</span> *user, <span class="keywordtype">char</span> *group){
<a name="l02447"></a>02447         uid_t uid=-1;
<a name="l02448"></a>02448         gid_t gid=-1;
<a name="l02449"></a>02449         <span class="keyword">struct </span>group *grp=NULL;
<a name="l02450"></a>02450         <span class="keyword">struct </span>passwd *pw=NULL;
<a name="l02451"></a>02451         <span class="keywordtype">int</span> result=<a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l02452"></a>02452 
<a name="l02453"></a>02453         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#a7c48214fa4660b7b7b31709c10d9be95">DEBUGL_FUNCTIONS</a>,0,<span class="stringliteral">&quot;drop_privileges() start\n&quot;</span>);
<a name="l02454"></a>02454         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#abde3796dd1b6bfa6368571c3196cc640">DEBUGL_PROCESS</a>,0,<span class="stringliteral">&quot;Original UID/GID: %d/%d\n&quot;</span>,(<span class="keywordtype">int</span>)getuid(),(<span class="keywordtype">int</span>)getgid());
<a name="l02455"></a>02455 
<a name="l02456"></a>02456         <span class="comment">/* only drop privileges if we&#39;re running as root, so we don&#39;t interfere with being debugged while running as some random user */</span>
<a name="l02457"></a>02457         <span class="keywordflow">if</span>(getuid()!=0)
<a name="l02458"></a>02458                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l02459"></a>02459 
<a name="l02460"></a>02460         <span class="comment">/* set effective group ID */</span>
<a name="l02461"></a>02461         <span class="keywordflow">if</span>(group!=NULL){
<a name="l02462"></a>02462 
<a name="l02463"></a>02463                 <span class="comment">/* see if this is a group name */</span>
<a name="l02464"></a>02464                 <span class="keywordflow">if</span>(strspn(group,<span class="stringliteral">&quot;0123456789&quot;</span>)&lt;strlen(group)){
<a name="l02465"></a>02465                         grp=(<span class="keyword">struct </span>group *)getgrnam(group);
<a name="l02466"></a>02466                         <span class="keywordflow">if</span>(grp!=NULL)
<a name="l02467"></a>02467                                 gid=(gid_t)(grp-&gt;gr_gid);
<a name="l02468"></a>02468                         <span class="keywordflow">else</span>
<a name="l02469"></a>02469                                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: Could not get group entry for &#39;%s&#39;&quot;</span>,group);
<a name="l02470"></a>02470                         }
<a name="l02471"></a>02471 
<a name="l02472"></a>02472                 <span class="comment">/* else we were passed the GID */</span>
<a name="l02473"></a>02473                 <span class="keywordflow">else</span>
<a name="l02474"></a>02474                         gid=(gid_t)atoi(group);
<a name="l02475"></a>02475 
<a name="l02476"></a>02476                 <span class="comment">/* set effective group ID if other than current EGID */</span>
<a name="l02477"></a>02477                 <span class="keywordflow">if</span>(gid!=getegid()){
<a name="l02478"></a>02478 
<a name="l02479"></a>02479                         <span class="keywordflow">if</span>(setgid(gid)==-1){
<a name="l02480"></a>02480                                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: Could not set effective GID=%d&quot;</span>,(<span class="keywordtype">int</span>)gid);
<a name="l02481"></a>02481                                 result=<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l02482"></a>02482                                 }
<a name="l02483"></a>02483                         }
<a name="l02484"></a>02484                 }
<a name="l02485"></a>02485 
<a name="l02486"></a>02486 
<a name="l02487"></a>02487         <span class="comment">/* set effective user ID */</span>
<a name="l02488"></a>02488         <span class="keywordflow">if</span>(user!=NULL){
<a name="l02489"></a>02489 
<a name="l02490"></a>02490                 <span class="comment">/* see if this is a user name */</span>
<a name="l02491"></a>02491                 <span class="keywordflow">if</span>(strspn(user,<span class="stringliteral">&quot;0123456789&quot;</span>)&lt;strlen(user)){
<a name="l02492"></a>02492                         pw=(<span class="keyword">struct </span>passwd *)getpwnam(user);
<a name="l02493"></a>02493                         <span class="keywordflow">if</span>(pw!=NULL)
<a name="l02494"></a>02494                                 uid=(uid_t)(pw-&gt;pw_uid);
<a name="l02495"></a>02495                         <span class="keywordflow">else</span>
<a name="l02496"></a>02496                                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: Could not get passwd entry for &#39;%s&#39;&quot;</span>,user);
<a name="l02497"></a>02497                         }
<a name="l02498"></a>02498 
<a name="l02499"></a>02499                 <span class="comment">/* else we were passed the UID */</span>
<a name="l02500"></a>02500                 <span class="keywordflow">else</span>
<a name="l02501"></a>02501                         uid=(uid_t)atoi(user);
<a name="l02502"></a>02502 
<a name="l02503"></a>02503 <span class="preprocessor">#ifdef HAVE_INITGROUPS</span>
<a name="l02504"></a>02504 <span class="preprocessor"></span>
<a name="l02505"></a>02505                 <span class="keywordflow">if</span>(uid!=geteuid()){
<a name="l02506"></a>02506 
<a name="l02507"></a>02507                         <span class="comment">/* initialize supplementary groups */</span>
<a name="l02508"></a>02508                         <span class="keywordflow">if</span>(initgroups(user,gid)==-1){
<a name="l02509"></a>02509                                 <span class="keywordflow">if</span>(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>==EPERM)
<a name="l02510"></a>02510                                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: Unable to change supplementary groups using initgroups() -- I hope you know what you&#39;re doing&quot;</span>);
<a name="l02511"></a>02511                                 <span class="keywordflow">else</span>{
<a name="l02512"></a>02512                                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: Possibly root user failed dropping privileges with initgroups()&quot;</span>);
<a name="l02513"></a>02513                                         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l02514"></a>02514                                         }
<a name="l02515"></a>02515                                 }
<a name="l02516"></a>02516                         }
<a name="l02517"></a>02517 <span class="preprocessor">#endif</span>
<a name="l02518"></a>02518 <span class="preprocessor"></span>                <span class="keywordflow">if</span>(setuid(uid)==-1){
<a name="l02519"></a>02519                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: Could not set effective UID=%d&quot;</span>,(<span class="keywordtype">int</span>)uid);
<a name="l02520"></a>02520                         result=<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l02521"></a>02521                         }
<a name="l02522"></a>02522                 }
<a name="l02523"></a>02523 
<a name="l02524"></a>02524         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#abde3796dd1b6bfa6368571c3196cc640">DEBUGL_PROCESS</a>,0,<span class="stringliteral">&quot;New UID/GID: %d/%d\n&quot;</span>,(<span class="keywordtype">int</span>)getuid(),(<span class="keywordtype">int</span>)getgid());
<a name="l02525"></a>02525 
<a name="l02526"></a>02526         <span class="keywordflow">return</span> result;
<a name="l02527"></a>02527         }
<a name="l02528"></a>02528 
<a name="l02529"></a>02529 
<a name="l02530"></a>02530 
<a name="l02531"></a>02531 
<a name="l02532"></a>02532 <span class="comment">/******************************************************************/</span>
<a name="l02533"></a>02533 <span class="comment">/************************* IPC FUNCTIONS **************************/</span>
<a name="l02534"></a>02534 <span class="comment">/******************************************************************/</span>
<a name="l02535"></a>02535 
<a name="l02536"></a>02536 <span class="comment">/* move check result to queue directory */</span>
<a name="l02537"></a><a class="code" href="icinga_8h.html#ae7426e040eeb19b9dcb4bf8ed0c57bda">02537</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a69855a30b12dfe19f6663bc9165bb1cf">move_check_result_to_queue</a>(<span class="keywordtype">char</span> *checkresult_file){
<a name="l02538"></a>02538         <span class="keywordtype">char</span> *output_file=NULL;
<a name="l02539"></a>02539         <span class="keywordtype">char</span> *temp_buffer=NULL;
<a name="l02540"></a>02540         <span class="keywordtype">int</span> output_file_fd=-1;
<a name="l02541"></a>02541         mode_t new_umask=077;
<a name="l02542"></a>02542         mode_t old_umask;
<a name="l02543"></a>02543         <span class="keywordtype">int</span> result=0;
<a name="l02544"></a>02544 
<a name="l02545"></a>02545         <span class="comment">/* save the file creation mask */</span>
<a name="l02546"></a>02546         old_umask=umask(new_umask);
<a name="l02547"></a>02547 
<a name="l02548"></a>02548         <span class="comment">/* create a safe temp file */</span>
<a name="l02549"></a>02549         <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=<a class="code" href="snprintf_8c.html#a28a648dd20504ebc0c03623a28d82c93">asprintf</a>(&amp;output_file,<span class="stringliteral">&quot;%s/cXXXXXX&quot;</span>,<a class="code" href="checks_8c.html#a3964b0cff6f7740b1f35a62ba0ef0d6a">check_result_path</a>);
<a name="l02550"></a>02550         output_file_fd=mkstemp(output_file);
<a name="l02551"></a>02551 
<a name="l02552"></a>02552         <span class="comment">/* file created okay */</span>
<a name="l02553"></a>02553         <span class="keywordflow">if</span>(output_file_fd&gt;=0){
<a name="l02554"></a>02554 
<a name="l02555"></a>02555                 <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,2,<span class="stringliteral">&quot;Moving temp check result file &#39;%s&#39; to queue file &#39;%s&#39;...\n&quot;</span>,checkresult_file,output_file);
<a name="l02556"></a>02556 
<a name="l02557"></a>02557 <span class="preprocessor">#ifdef __CYGWIN__</span>
<a name="l02558"></a>02558 <span class="preprocessor"></span>                <span class="comment">/* Cygwin cannot rename open files - gives Permission Denied */</span>
<a name="l02559"></a>02559                 <span class="comment">/* close the file */</span>
<a name="l02560"></a>02560                 close(output_file_fd);
<a name="l02561"></a>02561 <span class="preprocessor">#endif</span>
<a name="l02562"></a>02562 <span class="preprocessor"></span>
<a name="l02563"></a>02563                 <span class="comment">/* move the original file */</span>
<a name="l02564"></a>02564                 result=<a class="code" href="base_2utils_8c.html#aa23bc32b41818196b62048be4ee1803e">my_rename</a>(checkresult_file,output_file);
<a name="l02565"></a>02565 
<a name="l02566"></a>02566 <span class="preprocessor">#ifndef __CYGWIN__</span>
<a name="l02567"></a>02567 <span class="preprocessor"></span>                <span class="comment">/* close the file */</span>
<a name="l02568"></a>02568                 close(output_file_fd);
<a name="l02569"></a>02569 <span class="preprocessor">#endif</span>
<a name="l02570"></a>02570 <span class="preprocessor"></span>
<a name="l02571"></a>02571                 <span class="comment">/* create an ok-to-go indicator file */</span>
<a name="l02572"></a>02572                 <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=<a class="code" href="snprintf_8c.html#a28a648dd20504ebc0c03623a28d82c93">asprintf</a>(&amp;temp_buffer,<span class="stringliteral">&quot;%s.ok&quot;</span>,output_file);
<a name="l02573"></a>02573                 <span class="keywordflow">if</span>((output_file_fd=open(temp_buffer,O_CREAT|O_WRONLY|O_TRUNC,S_IRUSR|S_IWUSR))&gt;=0)
<a name="l02574"></a>02574                         close(output_file_fd);
<a name="l02575"></a>02575                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_buffer);
<a name="l02576"></a>02576 
<a name="l02577"></a>02577                 <span class="comment">/* delete the original file if it couldn&#39;t be moved */</span>
<a name="l02578"></a>02578                 <span class="keywordflow">if</span>(result!=0)
<a name="l02579"></a>02579                         unlink(checkresult_file);
<a name="l02580"></a>02580                 }
<a name="l02581"></a>02581         <span class="keywordflow">else</span>
<a name="l02582"></a>02582                 result=-1;
<a name="l02583"></a>02583 
<a name="l02584"></a>02584         <span class="comment">/* reset the file creation mask */</span>
<a name="l02585"></a>02585         umask(old_umask);
<a name="l02586"></a>02586 
<a name="l02587"></a>02587         <span class="comment">/* log a warning on errors */</span>
<a name="l02588"></a>02588         <span class="keywordflow">if</span>(result!=0)
<a name="l02589"></a>02589                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: Unable to move file &#39;%s&#39; to check results queue.\n&quot;</span>,checkresult_file);
<a name="l02590"></a>02590 
<a name="l02591"></a>02591         <span class="comment">/* free memory */</span>
<a name="l02592"></a>02592         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(output_file);
<a name="l02593"></a>02593 
<a name="l02594"></a>02594         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l02595"></a>02595         }
<a name="l02596"></a>02596 
<a name="l02597"></a>02597 
<a name="l02598"></a>02598 
<a name="l02599"></a>02599 <span class="comment">/* processes files in the check result queue directory */</span>
<a name="l02600"></a><a class="code" href="icinga_8h.html#ad087a4dcac5c7840256da7164a81eded">02600</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a47aaee3f3f1aba69773b5d25b7fa4cfe">process_check_result_queue</a>(<span class="keywordtype">char</span> *dirname){
<a name="l02601"></a>02601         <span class="keywordtype">char</span> file[<a class="code" href="include_2common_8h.html#a6773b93f3093658c3dcb569de3b4bdb2">MAX_FILENAME_LENGTH</a>];
<a name="l02602"></a>02602         DIR *dirp=NULL;
<a name="l02603"></a>02603         <span class="keyword">struct </span>dirent *dirfile=NULL;
<a name="l02604"></a>02604         <span class="keyword">register</span> <span class="keywordtype">int</span> x=0;
<a name="l02605"></a>02605         <span class="keyword">struct </span>stat stat_buf;
<a name="l02606"></a>02606         <span class="keyword">struct </span>stat ok_stat_buf;
<a name="l02607"></a>02607         <span class="keywordtype">char</span> *temp_buffer=NULL;
<a name="l02608"></a>02608         <span class="keywordtype">int</span> result=<a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l02609"></a>02609 
<a name="l02610"></a>02610         <span class="comment">/* make sure we have what we need */</span>
<a name="l02611"></a>02611         <span class="keywordflow">if</span>(dirname==NULL){
<a name="l02612"></a>02612                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a7eeb3698af991d137e2fdcda7b9e41a4">NSLOG_CONFIG_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Error: No check result queue directory specified.\n&quot;</span>);
<a name="l02613"></a>02613                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l02614"></a>02614                 }
<a name="l02615"></a>02615 
<a name="l02616"></a>02616         <span class="comment">/* open the directory for reading */</span>
<a name="l02617"></a>02617         <span class="keywordflow">if</span>((dirp=opendir(dirname))==NULL){
<a name="l02618"></a>02618                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a7eeb3698af991d137e2fdcda7b9e41a4">NSLOG_CONFIG_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Error: Could not open check result queue directory &#39;%s&#39; for reading.\n&quot;</span>,dirname);
<a name="l02619"></a>02619                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l02620"></a>02620                 }
<a name="l02621"></a>02621 
<a name="l02622"></a>02622         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Starting to read check result queue &#39;%s&#39;...\n&quot;</span>,dirname);
<a name="l02623"></a>02623 
<a name="l02624"></a>02624         <span class="comment">/* process all files in the directory... */</span>
<a name="l02625"></a>02625         <span class="keywordflow">while</span>((dirfile=readdir(dirp))!=NULL){
<a name="l02626"></a>02626 
<a name="l02627"></a>02627                 <span class="comment">/* create /path/to/file */</span>
<a name="l02628"></a>02628                 <a class="code" href="snprintf_8c.html#aa367b75c5aed883fef5befbdf04835a4">snprintf</a>(file,<span class="keyword">sizeof</span>(file),<span class="stringliteral">&quot;%s/%s&quot;</span>,dirname,dirfile-&gt;d_name);
<a name="l02629"></a>02629                 file[<span class="keyword">sizeof</span>(file)-1]=<span class="stringliteral">&#39;\x0&#39;</span>;
<a name="l02630"></a>02630 
<a name="l02631"></a>02631                 <span class="comment">/* process this if it&#39;s a check result file... */</span>
<a name="l02632"></a>02632                 x=strlen(dirfile-&gt;d_name);
<a name="l02633"></a>02633                 <span class="keywordflow">if</span>(x==7 &amp;&amp; dirfile-&gt;d_name[0]==<span class="charliteral">&#39;c&#39;</span>){
<a name="l02634"></a>02634 
<a name="l02635"></a>02635                         <span class="keywordflow">if</span>(stat(file,&amp;stat_buf)==-1){
<a name="l02636"></a>02636                                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Warning: Could not stat() check result file &#39;%s&#39;.\n&quot;</span>,file);
<a name="l02637"></a>02637                                 <span class="keywordflow">continue</span>;
<a name="l02638"></a>02638                                 }
<a name="l02639"></a>02639 
<a name="l02640"></a>02640                         <span class="keywordflow">switch</span>(stat_buf.st_mode &amp; S_IFMT){
<a name="l02641"></a>02641 
<a name="l02642"></a>02642                         <span class="keywordflow">case</span> S_IFREG:
<a name="l02643"></a>02643                                 <span class="comment">/* don&#39;t process symlinked files */</span>
<a name="l02644"></a>02644                                 <span class="keywordflow">if</span>(!S_ISREG(stat_buf.st_mode))
<a name="l02645"></a>02645                                         <span class="keywordflow">continue</span>;
<a name="l02646"></a>02646                                 <span class="keywordflow">break</span>;
<a name="l02647"></a>02647 
<a name="l02648"></a>02648                         <span class="keywordflow">default</span>:
<a name="l02649"></a>02649                                 <span class="comment">/* everything else we ignore */</span>
<a name="l02650"></a>02650                                 <span class="keywordflow">continue</span>;
<a name="l02651"></a>02651                                 <span class="keywordflow">break</span>;
<a name="l02652"></a>02652                                 }
<a name="l02653"></a>02653 
<a name="l02654"></a>02654                         <span class="comment">/* at this point we have a regular file... */</span>
<a name="l02655"></a>02655 
<a name="l02656"></a>02656                         <span class="comment">/* can we find the associated ok-to-go file ? */</span>
<a name="l02657"></a>02657                         <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=<a class="code" href="snprintf_8c.html#a28a648dd20504ebc0c03623a28d82c93">asprintf</a>(&amp;temp_buffer,<span class="stringliteral">&quot;%s.ok&quot;</span>,file);
<a name="l02658"></a>02658                         result=stat(temp_buffer,&amp;ok_stat_buf);
<a name="l02659"></a>02659                         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_buffer);
<a name="l02660"></a>02660                         <span class="keywordflow">if</span>(result==-1)
<a name="l02661"></a>02661                                 <span class="keywordflow">continue</span>;
<a name="l02662"></a>02662 
<a name="l02663"></a>02663                         <span class="comment">/* process the file */</span>
<a name="l02664"></a>02664                         result=<a class="code" href="base_2utils_8c.html#a37d412e93be89ef124327a8377401869">process_check_result_file</a>(file);
<a name="l02665"></a>02665 
<a name="l02666"></a>02666                         <span class="comment">/* break out if we encountered an error */</span>
<a name="l02667"></a>02667                         <span class="keywordflow">if</span>(result==<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>)
<a name="l02668"></a>02668                                 <span class="keywordflow">break</span>;
<a name="l02669"></a>02669                         }
<a name="l02670"></a>02670                 }
<a name="l02671"></a>02671 
<a name="l02672"></a>02672         closedir(dirp);
<a name="l02673"></a>02673 
<a name="l02674"></a>02674         <span class="keywordflow">return</span> result;
<a name="l02675"></a>02675 
<a name="l02676"></a>02676         }
<a name="l02677"></a>02677 
<a name="l02678"></a>02678 
<a name="l02679"></a>02679 
<a name="l02680"></a>02680 
<a name="l02681"></a>02681 <span class="comment">/* reads check result(s) from a file */</span>
<a name="l02682"></a><a class="code" href="icinga_8h.html#abe83fa50d350f62053dcf35cbbd127a7">02682</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a37d412e93be89ef124327a8377401869">process_check_result_file</a>(<span class="keywordtype">char</span> *fname){
<a name="l02683"></a>02683         <a class="code" href="structmmapfile__struct.html">mmapfile</a> *thefile=NULL;
<a name="l02684"></a>02684         <span class="keywordtype">char</span> *input=NULL;
<a name="l02685"></a>02685         <span class="keywordtype">char</span> *var=NULL;
<a name="l02686"></a>02686         <span class="keywordtype">char</span> *val=NULL;
<a name="l02687"></a>02687         <span class="keywordtype">char</span> *v1=NULL,*v2=NULL;
<a name="l02688"></a>02688         <span class="keywordtype">int</span> delete_file=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02689"></a>02689         time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>;
<a name="l02690"></a>02690         <a class="code" href="structcheck__result__struct.html">check_result</a> *new_cr=NULL;
<a name="l02691"></a>02691 
<a name="l02692"></a>02692         <span class="keywordflow">if</span>(fname==NULL)
<a name="l02693"></a>02693                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l02694"></a>02694 
<a name="l02695"></a>02695         time(&amp;current_time);
<a name="l02696"></a>02696 
<a name="l02697"></a>02697         <a class="code" href="logging_8c.html#a9011e466a55abe0e359455a18f86c3ef">log_debug_info</a>(<a class="code" href="logging_8h.html#ad11b56e65adf60985ff1b082f0ba29b9">DEBUGL_CHECKS</a>,1,<span class="stringliteral">&quot;Processing check result file: &#39;%s&#39;\n&quot;</span>,fname);
<a name="l02698"></a>02698 
<a name="l02699"></a>02699         <span class="comment">/* open the file for reading */</span>
<a name="l02700"></a>02700         <span class="keywordflow">if</span>((thefile=<a class="code" href="shared_8c.html#a82cfcc4c3252fdc185a07169a9457f74">mmap_fopen</a>(fname))==NULL){
<a name="l02701"></a>02701 
<a name="l02702"></a>02702                 <span class="comment">/* try removing the file - zero length files can&#39;t be mmap()&#39;ed, so it might exist */</span>
<a name="l02703"></a>02703                 unlink(fname);
<a name="l02704"></a>02704 
<a name="l02705"></a>02705                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l02706"></a>02706                 }
<a name="l02707"></a>02707 
<a name="l02708"></a>02708         <span class="comment">/* read in all lines from the file */</span>
<a name="l02709"></a>02709         <span class="keywordflow">while</span>(1){
<a name="l02710"></a>02710 
<a name="l02711"></a>02711                 <span class="comment">/* free memory */</span>
<a name="l02712"></a>02712                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(input);
<a name="l02713"></a>02713 
<a name="l02714"></a>02714                 <span class="comment">/* read the next line */</span>
<a name="l02715"></a>02715                 <span class="keywordflow">if</span>((input=<a class="code" href="shared_8c.html#ac1809947562174c3ee45be934bcfdceb">mmap_fgets_multiline</a>(thefile))==NULL)
<a name="l02716"></a>02716                         <span class="keywordflow">break</span>;
<a name="l02717"></a>02717 
<a name="l02718"></a>02718                 <span class="comment">/* skip comments */</span>
<a name="l02719"></a>02719                 <span class="keywordflow">if</span>(input[0]==<span class="charliteral">&#39;#&#39;</span>)
<a name="l02720"></a>02720                         <span class="keywordflow">continue</span>;
<a name="l02721"></a>02721 
<a name="l02722"></a>02722                 <span class="comment">/* empty line indicates end of record */</span>
<a name="l02723"></a>02723                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(input[0]==<span class="charliteral">&#39;\n&#39;</span>){
<a name="l02724"></a>02724 
<a name="l02725"></a>02725                         <span class="comment">/* we have something... */</span>
<a name="l02726"></a>02726                         <span class="keywordflow">if</span>(new_cr){
<a name="l02727"></a>02727 
<a name="l02728"></a>02728                                 <span class="comment">/* do we have the minimum amount of data? */</span>
<a name="l02729"></a>02729                                 <span class="keywordflow">if</span>(new_cr-&gt;<a class="code" href="structcheck__result__struct.html#a8e0609d9dd4bf77156c9e967ab8c8924">host_name</a>!=NULL &amp;&amp; new_cr-&gt;<a class="code" href="structcheck__result__struct.html#aabb1b6da0b348c809c7139c5e32938e0">output</a>!=NULL){
<a name="l02730"></a>02730 
<a name="l02731"></a>02731                                         <span class="comment">/* add check result to list in memory */</span>
<a name="l02732"></a>02732                                         <a class="code" href="base_2utils_8c.html#a8912ba7d3b6840c8882b892be1601384">add_check_result_to_list</a>(new_cr);
<a name="l02733"></a>02733 
<a name="l02734"></a>02734                                         <span class="comment">/* reset pointer */</span>
<a name="l02735"></a>02735                                         new_cr=NULL;
<a name="l02736"></a>02736                                         }
<a name="l02737"></a>02737 
<a name="l02738"></a>02738                                 <span class="comment">/* discard partial input */</span>
<a name="l02739"></a>02739                                 <span class="keywordflow">else</span>{
<a name="l02740"></a>02740                                         <a class="code" href="base_2utils_8c.html#a36701093a323ae768707b7a025a13e01">free_check_result</a>(new_cr);
<a name="l02741"></a>02741                                         <a class="code" href="base_2utils_8c.html#af488a319d9fb404a88cfddc206fc2bca">init_check_result</a>(new_cr);
<a name="l02742"></a>02742                                         new_cr-&gt;<a class="code" href="structcheck__result__struct.html#a1ef7b671552d6ed92421a522c4127bf6">output_file</a>=(<span class="keywordtype">char</span> *)strdup(fname);
<a name="l02743"></a>02743                                         }
<a name="l02744"></a>02744                                 }
<a name="l02745"></a>02745                         }
<a name="l02746"></a>02746 
<a name="l02747"></a>02747                 <span class="keywordflow">if</span>((var=<a class="code" href="shared_8c.html#a3cb00755a99d761debc38b7252aa263d">my_strtok</a>(input,<span class="stringliteral">&quot;=&quot;</span>))==NULL)
<a name="l02748"></a>02748                         <span class="keywordflow">continue</span>;
<a name="l02749"></a>02749                 <span class="keywordflow">if</span>((val=<a class="code" href="shared_8c.html#a3cb00755a99d761debc38b7252aa263d">my_strtok</a>(NULL,<span class="stringliteral">&quot;\n&quot;</span>))==NULL)
<a name="l02750"></a>02750                         <span class="keywordflow">continue</span>;
<a name="l02751"></a>02751 
<a name="l02752"></a>02752                 <span class="comment">/* found the file time */</span>
<a name="l02753"></a>02753                 <span class="keywordflow">if</span>(!strcmp(var,<span class="stringliteral">&quot;file_time&quot;</span>)){
<a name="l02754"></a>02754 
<a name="l02755"></a>02755                         <span class="comment">/* file is too old - ignore check results it contains and delete it */</span>
<a name="l02756"></a>02756                         <span class="comment">/* this will only work as intended if file_time comes before check results */</span>
<a name="l02757"></a>02757                         <span class="keywordflow">if</span>(<a class="code" href="base_2config_8c.html#a339144b840e81ab177c4c80178da7470">max_check_result_file_age</a>&gt;0 &amp;&amp; (current_time-(strtoul(val,NULL,0))&gt;<a class="code" href="base_2config_8c.html#a339144b840e81ab177c4c80178da7470">max_check_result_file_age</a>)){
<a name="l02758"></a>02758                                 delete_file=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02759"></a>02759                                 <span class="keywordflow">break</span>;
<a name="l02760"></a>02760                                 }
<a name="l02761"></a>02761                         }
<a name="l02762"></a>02762 
<a name="l02763"></a>02763                 <span class="comment">/* else we have check result data */</span>
<a name="l02764"></a>02764                 <span class="keywordflow">else</span>{
<a name="l02765"></a>02765 
<a name="l02766"></a>02766                         <span class="comment">/* allocate new check result if necessary */</span>
<a name="l02767"></a>02767                         <span class="keywordflow">if</span>(new_cr==NULL){
<a name="l02768"></a>02768 
<a name="l02769"></a>02769                                 <span class="keywordflow">if</span>((new_cr=(<a class="code" href="structcheck__result__struct.html">check_result</a> *)malloc(<span class="keyword">sizeof</span>(<a class="code" href="structcheck__result__struct.html">check_result</a>)))==NULL)
<a name="l02770"></a>02770                                         <span class="keywordflow">continue</span>;
<a name="l02771"></a>02771 
<a name="l02772"></a>02772                                 <span class="comment">/* init values */</span>
<a name="l02773"></a>02773                                 <a class="code" href="base_2utils_8c.html#af488a319d9fb404a88cfddc206fc2bca">init_check_result</a>(new_cr);
<a name="l02774"></a>02774                                 new_cr-&gt;<a class="code" href="structcheck__result__struct.html#a1ef7b671552d6ed92421a522c4127bf6">output_file</a>=(<span class="keywordtype">char</span> *)strdup(fname);
<a name="l02775"></a>02775                                 }
<a name="l02776"></a>02776 
<a name="l02777"></a>02777                         <span class="keywordflow">if</span>(!strcmp(var,<span class="stringliteral">&quot;host_name&quot;</span>))
<a name="l02778"></a>02778                                 new_cr-&gt;<a class="code" href="structcheck__result__struct.html#a8e0609d9dd4bf77156c9e967ab8c8924">host_name</a>=(<span class="keywordtype">char</span> *)strdup(val);
<a name="l02779"></a>02779                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(var,<span class="stringliteral">&quot;service_description&quot;</span>)){
<a name="l02780"></a>02780                                 new_cr-&gt;<a class="code" href="structcheck__result__struct.html#a3cd7e3c42f1bce1761e6c84b76588877">service_description</a>=(<span class="keywordtype">char</span> *)strdup(val);
<a name="l02781"></a>02781                                 new_cr-&gt;<a class="code" href="structcheck__result__struct.html#aab46f07f58a12b95f55f483637e2f937">object_check_type</a>=<a class="code" href="icinga_8h.html#ade4e796d45e5c3ffcee218cd4c2d5469">SERVICE_CHECK</a>;
<a name="l02782"></a>02782                                 }
<a name="l02783"></a>02783                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(var,<span class="stringliteral">&quot;check_type&quot;</span>))
<a name="l02784"></a>02784                                 new_cr-&gt;<a class="code" href="structcheck__result__struct.html#a06a6efffb27b304e4b983b5cfab66851">check_type</a>=atoi(val);
<a name="l02785"></a>02785                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(var,<span class="stringliteral">&quot;check_options&quot;</span>))
<a name="l02786"></a>02786                                 new_cr-&gt;<a class="code" href="structcheck__result__struct.html#ae0708b0eaec7709912168f85c5ba503a">check_options</a>=atoi(val);
<a name="l02787"></a>02787                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(var,<span class="stringliteral">&quot;scheduled_check&quot;</span>))
<a name="l02788"></a>02788                                 new_cr-&gt;<a class="code" href="structcheck__result__struct.html#ac3d4cf6179d9c2b29f98be9f2ca2941a">scheduled_check</a>=atoi(val);
<a name="l02789"></a>02789                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(var,<span class="stringliteral">&quot;reschedule_check&quot;</span>))
<a name="l02790"></a>02790                                 new_cr-&gt;<a class="code" href="structcheck__result__struct.html#a55af6097dbb3c68a52f1bfa4027f37f5">reschedule_check</a>=atoi(val);
<a name="l02791"></a>02791                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(var,<span class="stringliteral">&quot;latency&quot;</span>))
<a name="l02792"></a>02792                                 new_cr-&gt;<a class="code" href="structcheck__result__struct.html#a2e6d8e1efd138ab3970cb6f0233f7eb4">latency</a>=strtod(val,NULL);
<a name="l02793"></a>02793                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(var,<span class="stringliteral">&quot;start_time&quot;</span>)){
<a name="l02794"></a>02794                                 <span class="keywordflow">if</span>((v1=strtok(val,<span class="stringliteral">&quot;.&quot;</span>))==NULL)
<a name="l02795"></a>02795                                         <span class="keywordflow">continue</span>;
<a name="l02796"></a>02796                                 <span class="keywordflow">if</span>((v2=strtok(NULL,<span class="stringliteral">&quot;\n&quot;</span>))==NULL)
<a name="l02797"></a>02797                                         <span class="keywordflow">continue</span>;
<a name="l02798"></a>02798                                 new_cr-&gt;<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>.tv_sec=strtoul(v1,NULL,0);
<a name="l02799"></a>02799                                 new_cr-&gt;<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>.tv_usec=strtoul(v2,NULL,0);
<a name="l02800"></a>02800                                 }
<a name="l02801"></a>02801                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(var,<span class="stringliteral">&quot;finish_time&quot;</span>)){
<a name="l02802"></a>02802                                 <span class="keywordflow">if</span>((v1=strtok(val,<span class="stringliteral">&quot;.&quot;</span>))==NULL)
<a name="l02803"></a>02803                                         <span class="keywordflow">continue</span>;
<a name="l02804"></a>02804                                 <span class="keywordflow">if</span>((v2=strtok(NULL,<span class="stringliteral">&quot;\n&quot;</span>))==NULL)
<a name="l02805"></a>02805                                         <span class="keywordflow">continue</span>;
<a name="l02806"></a>02806                                 new_cr-&gt;<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_sec=strtoul(v1,NULL,0);
<a name="l02807"></a>02807                                 new_cr-&gt;<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_usec=strtoul(v2,NULL,0);
<a name="l02808"></a>02808                                 }
<a name="l02809"></a>02809                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(var,<span class="stringliteral">&quot;early_timeout&quot;</span>))
<a name="l02810"></a>02810                                 new_cr-&gt;<a class="code" href="structcheck__result__struct.html#a8fd6dc8e62fa817f85971b929d2a50ea">early_timeout</a>=atoi(val);
<a name="l02811"></a>02811                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(var,<span class="stringliteral">&quot;exited_ok&quot;</span>))
<a name="l02812"></a>02812                                 new_cr-&gt;<a class="code" href="structcheck__result__struct.html#acdf1b91b61c379a2e1c42421ac1f76b8">exited_ok</a>=atoi(val);
<a name="l02813"></a>02813                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(var,<span class="stringliteral">&quot;return_code&quot;</span>))
<a name="l02814"></a>02814                                 new_cr-&gt;<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>=atoi(val);
<a name="l02815"></a>02815                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(var,<span class="stringliteral">&quot;output&quot;</span>))
<a name="l02816"></a>02816                                 new_cr-&gt;<a class="code" href="structcheck__result__struct.html#aabb1b6da0b348c809c7139c5e32938e0">output</a>=(<span class="keywordtype">char</span> *)strdup(val);
<a name="l02817"></a>02817                         }
<a name="l02818"></a>02818                 }
<a name="l02819"></a>02819 
<a name="l02820"></a>02820         <span class="comment">/* we have something */</span>
<a name="l02821"></a>02821         <span class="keywordflow">if</span>(new_cr){
<a name="l02822"></a>02822 
<a name="l02823"></a>02823                 <span class="comment">/* do we have the minimum amount of data? */</span>
<a name="l02824"></a>02824                 <span class="keywordflow">if</span>(new_cr-&gt;<a class="code" href="structcheck__result__struct.html#a8e0609d9dd4bf77156c9e967ab8c8924">host_name</a>!=NULL &amp;&amp; new_cr-&gt;<a class="code" href="structcheck__result__struct.html#aabb1b6da0b348c809c7139c5e32938e0">output</a>!=NULL){
<a name="l02825"></a>02825 
<a name="l02826"></a>02826                         <span class="comment">/* add check result to list in memory */</span>
<a name="l02827"></a>02827                         <a class="code" href="base_2utils_8c.html#a8912ba7d3b6840c8882b892be1601384">add_check_result_to_list</a>(new_cr);
<a name="l02828"></a>02828 
<a name="l02829"></a>02829                         <span class="comment">/* reset pointer */</span>
<a name="l02830"></a>02830                         new_cr=NULL;
<a name="l02831"></a>02831                         }
<a name="l02832"></a>02832 
<a name="l02833"></a>02833                 <span class="comment">/* discard partial input */</span>
<a name="l02834"></a>02834                 <span class="comment">/* free memory for current check result record */</span>
<a name="l02835"></a>02835                 <span class="keywordflow">else</span>{
<a name="l02836"></a>02836                         <a class="code" href="base_2utils_8c.html#a36701093a323ae768707b7a025a13e01">free_check_result</a>(new_cr);
<a name="l02837"></a>02837                         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(new_cr);
<a name="l02838"></a>02838                         }
<a name="l02839"></a>02839                 }
<a name="l02840"></a>02840 
<a name="l02841"></a>02841         <span class="comment">/* free memory and close file */</span>
<a name="l02842"></a>02842         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(input);
<a name="l02843"></a>02843         <a class="code" href="shared_8c.html#a31d61f8da86226d734e7cadbd613bf3c">mmap_fclose</a>(thefile);
<a name="l02844"></a>02844 
<a name="l02845"></a>02845         <span class="comment">/* delete the file (as well its ok-to-go file) if it&#39;s too old */</span>
<a name="l02846"></a>02846         <span class="comment">/* other (current) files are deleted later (when results are processed) */</span>
<a name="l02847"></a>02847         <a class="code" href="base_2utils_8c.html#a18f87ac621d1954ac8be83fe327742df">delete_check_result_file</a>(fname);
<a name="l02848"></a>02848 
<a name="l02849"></a>02849         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l02850"></a>02850         }
<a name="l02851"></a>02851 
<a name="l02852"></a>02852 
<a name="l02853"></a>02853 
<a name="l02854"></a>02854 
<a name="l02855"></a>02855 <span class="comment">/* deletes as check result file, as well as its ok-to-go file */</span>
<a name="l02856"></a><a class="code" href="icinga_8h.html#a1300d10892cabbceb679b7762b79c8f8">02856</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a18f87ac621d1954ac8be83fe327742df">delete_check_result_file</a>(<span class="keywordtype">char</span> *fname){
<a name="l02857"></a>02857         <span class="keywordtype">char</span> *temp_buffer=NULL;
<a name="l02858"></a>02858 
<a name="l02859"></a>02859         <span class="comment">/* delete the result file */</span>
<a name="l02860"></a>02860         unlink(fname);
<a name="l02861"></a>02861 
<a name="l02862"></a>02862         <span class="comment">/* delete the ok-to-go file */</span>
<a name="l02863"></a>02863         <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=<a class="code" href="snprintf_8c.html#a28a648dd20504ebc0c03623a28d82c93">asprintf</a>(&amp;temp_buffer,<span class="stringliteral">&quot;%s.ok&quot;</span>,fname);
<a name="l02864"></a>02864         unlink(temp_buffer);
<a name="l02865"></a>02865         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_buffer);
<a name="l02866"></a>02866 
<a name="l02867"></a>02867         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l02868"></a>02868         }
<a name="l02869"></a>02869 
<a name="l02870"></a>02870 
<a name="l02871"></a>02871 
<a name="l02872"></a>02872 
<a name="l02873"></a>02873 <span class="comment">/* reads the first host/service check result from the list in memory */</span>
<a name="l02874"></a><a class="code" href="icinga_8h.html#acce9620a3784efaed89f5f4fade5fa08">02874</a> <a class="code" href="structcheck__result__struct.html">check_result</a> *<a class="code" href="base_2utils_8c.html#acce9620a3784efaed89f5f4fade5fa08">read_check_result</a>(<span class="keywordtype">void</span>){
<a name="l02875"></a>02875         <a class="code" href="structcheck__result__struct.html">check_result</a> *first_cr=NULL;
<a name="l02876"></a>02876 
<a name="l02877"></a>02877         <span class="keywordflow">if</span>(check_result_list==NULL)
<a name="l02878"></a>02878                 <span class="keywordflow">return</span> NULL;
<a name="l02879"></a>02879 
<a name="l02880"></a>02880         first_cr=<a class="code" href="checks_8c.html#a9a65c5bcf2a37699d3438209379f79c2">check_result_list</a>;
<a name="l02881"></a>02881         check_result_list=check_result_list-&gt;<a class="code" href="structcheck__result__struct.html#a2d3d97c7d3e976d0cab7f9dd7305a69d">next</a>;
<a name="l02882"></a>02882 
<a name="l02883"></a>02883         <span class="keywordflow">return</span> first_cr;
<a name="l02884"></a>02884         }
<a name="l02885"></a>02885 
<a name="l02886"></a>02886 
<a name="l02887"></a>02887 
<a name="l02888"></a>02888 <span class="comment">/* initializes a host/service check result */</span>
<a name="l02889"></a><a class="code" href="icinga_8h.html#ad7115751a97c361e92f28ad97fe789f8">02889</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#af488a319d9fb404a88cfddc206fc2bca">init_check_result</a>(<a class="code" href="structcheck__result__struct.html">check_result</a> *info){
<a name="l02890"></a>02890 
<a name="l02891"></a>02891         <span class="keywordflow">if</span>(info==NULL)
<a name="l02892"></a>02892                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l02893"></a>02893 
<a name="l02894"></a>02894         <span class="comment">/* reset vars */</span>
<a name="l02895"></a>02895         info-&gt;<a class="code" href="structcheck__result__struct.html#aab46f07f58a12b95f55f483637e2f937">object_check_type</a>=<a class="code" href="icinga_8h.html#af3d22c9e46ee1d7539669117eee89882">HOST_CHECK</a>;
<a name="l02896"></a>02896         info-&gt;<a class="code" href="structcheck__result__struct.html#a8e0609d9dd4bf77156c9e967ab8c8924">host_name</a>=NULL;
<a name="l02897"></a>02897         info-&gt;<a class="code" href="structcheck__result__struct.html#a3cd7e3c42f1bce1761e6c84b76588877">service_description</a>=NULL;
<a name="l02898"></a>02898         info-&gt;<a class="code" href="structcheck__result__struct.html#a06a6efffb27b304e4b983b5cfab66851">check_type</a>=<a class="code" href="include_2common_8h.html#ac9e449de784fe745dd2d6ff07efb8187">HOST_CHECK_ACTIVE</a>;
<a name="l02899"></a>02899         info-&gt;<a class="code" href="structcheck__result__struct.html#ae0708b0eaec7709912168f85c5ba503a">check_options</a>=<a class="code" href="include_2common_8h.html#ac2e0ba323965f243a1988566a8ea53da">CHECK_OPTION_NONE</a>;
<a name="l02900"></a>02900         info-&gt;<a class="code" href="structcheck__result__struct.html#ac3d4cf6179d9c2b29f98be9f2ca2941a">scheduled_check</a>=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02901"></a>02901         info-&gt;<a class="code" href="structcheck__result__struct.html#a55af6097dbb3c68a52f1bfa4027f37f5">reschedule_check</a>=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02902"></a>02902         info-&gt;<a class="code" href="structcheck__result__struct.html#a93bab7881b28cf1aa7b34e9dcfd9f7b7">output_file_fp</a>=NULL;
<a name="l02903"></a>02903         info-&gt;<a class="code" href="structcheck__result__struct.html#aec5b08d38761af6fe89eef17bd831f53">output_file_fd</a>=-1;
<a name="l02904"></a>02904         info-&gt;<a class="code" href="structcheck__result__struct.html#a2e6d8e1efd138ab3970cb6f0233f7eb4">latency</a>=0.0;
<a name="l02905"></a>02905         info-&gt;<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>.tv_sec=0;
<a name="l02906"></a>02906         info-&gt;<a class="code" href="structcheck__result__struct.html#a11d8f52db02cb2d119f061ea4ed434f7">start_time</a>.tv_usec=0;
<a name="l02907"></a>02907         info-&gt;<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_sec=0;
<a name="l02908"></a>02908         info-&gt;<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_usec=0;
<a name="l02909"></a>02909         info-&gt;<a class="code" href="structcheck__result__struct.html#a8fd6dc8e62fa817f85971b929d2a50ea">early_timeout</a>=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02910"></a>02910         info-&gt;<a class="code" href="structcheck__result__struct.html#acdf1b91b61c379a2e1c42421ac1f76b8">exited_ok</a>=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02911"></a>02911         info-&gt;<a class="code" href="structcheck__result__struct.html#a1412141edb2366ecd7e57ed18331c824">return_code</a>=0;
<a name="l02912"></a>02912         info-&gt;<a class="code" href="structcheck__result__struct.html#aabb1b6da0b348c809c7139c5e32938e0">output</a>=NULL;
<a name="l02913"></a>02913         info-&gt;<a class="code" href="structcheck__result__struct.html#a2d3d97c7d3e976d0cab7f9dd7305a69d">next</a>=NULL;
<a name="l02914"></a>02914 
<a name="l02915"></a>02915         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l02916"></a>02916         }
<a name="l02917"></a>02917 
<a name="l02918"></a>02918 
<a name="l02919"></a>02919 
<a name="l02920"></a>02920 
<a name="l02921"></a>02921 <span class="comment">/* adds a new host/service check result to the list in memory */</span>
<a name="l02922"></a><a class="code" href="icinga_8h.html#afafd31a1c0b0ebe807728386a52993b9">02922</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a8912ba7d3b6840c8882b892be1601384">add_check_result_to_list</a>(<a class="code" href="structcheck__result__struct.html">check_result</a> *new_cr){
<a name="l02923"></a>02923         <a class="code" href="structcheck__result__struct.html">check_result</a> *temp_cr=NULL;
<a name="l02924"></a>02924         <a class="code" href="structcheck__result__struct.html">check_result</a> *last_cr=NULL;
<a name="l02925"></a>02925 
<a name="l02926"></a>02926         <span class="keywordflow">if</span>(new_cr==NULL)
<a name="l02927"></a>02927                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l02928"></a>02928 
<a name="l02929"></a>02929         <span class="comment">/* add to list, sorted by finish time (asc) */</span>
<a name="l02930"></a>02930 
<a name="l02931"></a>02931         <span class="comment">/* find insertion point */</span>
<a name="l02932"></a>02932         last_cr=<a class="code" href="checks_8c.html#a9a65c5bcf2a37699d3438209379f79c2">check_result_list</a>;
<a name="l02933"></a>02933         <span class="keywordflow">for</span>(temp_cr=check_result_list;temp_cr!=NULL;temp_cr=temp_cr-&gt;<a class="code" href="structcheck__result__struct.html#a2d3d97c7d3e976d0cab7f9dd7305a69d">next</a>){
<a name="l02934"></a>02934                 <span class="keywordflow">if</span>(temp_cr-&gt;<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_sec &gt;= new_cr-&gt;<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_sec){
<a name="l02935"></a>02935                         <span class="keywordflow">if</span>(temp_cr-&gt;<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_sec &gt; new_cr-&gt;<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_sec)
<a name="l02936"></a>02936                                 <span class="keywordflow">break</span>;
<a name="l02937"></a>02937                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(temp_cr-&gt;<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_usec &gt; new_cr-&gt;<a class="code" href="structcheck__result__struct.html#aa29ef53b9d065a4326d3433852ef9520">finish_time</a>.tv_usec)
<a name="l02938"></a>02938                                 <span class="keywordflow">break</span>;
<a name="l02939"></a>02939                         }
<a name="l02940"></a>02940                 last_cr=temp_cr;
<a name="l02941"></a>02941                 }
<a name="l02942"></a>02942 
<a name="l02943"></a>02943         <span class="comment">/* item goes at head of list */</span>
<a name="l02944"></a>02944         <span class="keywordflow">if</span>(check_result_list==NULL || temp_cr==check_result_list){
<a name="l02945"></a>02945                 new_cr-&gt;<a class="code" href="structcheck__result__struct.html#a2d3d97c7d3e976d0cab7f9dd7305a69d">next</a>=<a class="code" href="checks_8c.html#a9a65c5bcf2a37699d3438209379f79c2">check_result_list</a>;
<a name="l02946"></a>02946                 check_result_list=new_cr;
<a name="l02947"></a>02947                 }
<a name="l02948"></a>02948 
<a name="l02949"></a>02949         <span class="comment">/* item goes in middle or at end of list */</span>
<a name="l02950"></a>02950         <span class="keywordflow">else</span>{
<a name="l02951"></a>02951                 new_cr-&gt;<a class="code" href="structcheck__result__struct.html#a2d3d97c7d3e976d0cab7f9dd7305a69d">next</a>=temp_cr;
<a name="l02952"></a>02952                 last_cr-&gt;<a class="code" href="structcheck__result__struct.html#a2d3d97c7d3e976d0cab7f9dd7305a69d">next</a>=new_cr;
<a name="l02953"></a>02953                 }
<a name="l02954"></a>02954 
<a name="l02955"></a>02955         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l02956"></a>02956         }
<a name="l02957"></a>02957 
<a name="l02958"></a>02958 
<a name="l02959"></a>02959 
<a name="l02960"></a>02960 
<a name="l02961"></a>02961 <span class="comment">/* frees all memory associated with the check result list */</span>
<a name="l02962"></a><a class="code" href="icinga_8h.html#a5e94c626a547114bc50ad15269e0b561">02962</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a5e94c626a547114bc50ad15269e0b561">free_check_result_list</a>(<span class="keywordtype">void</span>){
<a name="l02963"></a>02963         <a class="code" href="structcheck__result__struct.html">check_result</a> *this_cr=NULL;
<a name="l02964"></a>02964         <a class="code" href="structcheck__result__struct.html">check_result</a> *next_cr=NULL;
<a name="l02965"></a>02965 
<a name="l02966"></a>02966         <span class="keywordflow">for</span>(this_cr=check_result_list;this_cr!=NULL;this_cr=next_cr){
<a name="l02967"></a>02967                 next_cr=this_cr-&gt;<a class="code" href="structcheck__result__struct.html#a2d3d97c7d3e976d0cab7f9dd7305a69d">next</a>;
<a name="l02968"></a>02968                 <a class="code" href="base_2utils_8c.html#a36701093a323ae768707b7a025a13e01">free_check_result</a>(this_cr);
<a name="l02969"></a>02969                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(this_cr);
<a name="l02970"></a>02970                 }
<a name="l02971"></a>02971 
<a name="l02972"></a>02972         check_result_list=NULL;
<a name="l02973"></a>02973 
<a name="l02974"></a>02974         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l02975"></a>02975         }
<a name="l02976"></a>02976 
<a name="l02977"></a>02977 
<a name="l02978"></a>02978 
<a name="l02979"></a>02979 
<a name="l02980"></a>02980 <span class="comment">/* frees memory associated with a host/service check result */</span>
<a name="l02981"></a><a class="code" href="icinga_8h.html#aa064fd7ad88b2658ccfb460bd386a8dc">02981</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a36701093a323ae768707b7a025a13e01">free_check_result</a>(<a class="code" href="structcheck__result__struct.html">check_result</a> *info){
<a name="l02982"></a>02982 
<a name="l02983"></a>02983         <span class="keywordflow">if</span>(info==NULL)
<a name="l02984"></a>02984                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l02985"></a>02985 
<a name="l02986"></a>02986         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(info-&gt;<a class="code" href="structcheck__result__struct.html#a8e0609d9dd4bf77156c9e967ab8c8924">host_name</a>);
<a name="l02987"></a>02987         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(info-&gt;<a class="code" href="structcheck__result__struct.html#a3cd7e3c42f1bce1761e6c84b76588877">service_description</a>);
<a name="l02988"></a>02988         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(info-&gt;<a class="code" href="structcheck__result__struct.html#a1ef7b671552d6ed92421a522c4127bf6">output_file</a>);
<a name="l02989"></a>02989         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(info-&gt;<a class="code" href="structcheck__result__struct.html#aabb1b6da0b348c809c7139c5e32938e0">output</a>);
<a name="l02990"></a>02990 
<a name="l02991"></a>02991         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l02992"></a>02992         }
<a name="l02993"></a>02993 
<a name="l02994"></a>02994 
<a name="l02995"></a>02995 
<a name="l02996"></a>02996 <span class="comment">/* parse raw plugin output and return: short and long output, perf data */</span>
<a name="l02997"></a><a class="code" href="icinga_8h.html#ad939f3c30b5503bfb99d0f9aeed978a1">02997</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a3899c46155b515e207829a7bf127700c">parse_check_output</a>(<span class="keywordtype">char</span> *buf, <span class="keywordtype">char</span> **short_output, <span class="keywordtype">char</span> **long_output, <span class="keywordtype">char</span> **perf_data, <span class="keywordtype">int</span> escape_newlines_please, <span class="keywordtype">int</span> newlines_are_escaped){
<a name="l02998"></a>02998         <span class="keywordtype">int</span> current_line=0;
<a name="l02999"></a>02999         <span class="keywordtype">int</span> found_newline=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03000"></a>03000         <span class="keywordtype">int</span> eof=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03001"></a>03001         <span class="keywordtype">int</span> used_buf=0;
<a name="l03002"></a>03002         <span class="keywordtype">int</span> dbuf_chunk=1024;
<a name="l03003"></a>03003         <a class="code" href="structdbuf__struct.html">dbuf</a> db1;
<a name="l03004"></a>03004         <a class="code" href="structdbuf__struct.html">dbuf</a> db2;
<a name="l03005"></a>03005         <span class="keywordtype">char</span> *ptr=NULL;
<a name="l03006"></a>03006         <span class="keywordtype">int</span> in_perf_data=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03007"></a>03007         <span class="keywordtype">char</span> *tempbuf=NULL;
<a name="l03008"></a>03008         <span class="keyword">register</span> <span class="keywordtype">int</span> x=0;
<a name="l03009"></a>03009         <span class="keyword">register</span> <span class="keywordtype">int</span> y=0;
<a name="l03010"></a>03010 
<a name="l03011"></a>03011         <span class="comment">/* initialize values */</span>
<a name="l03012"></a>03012         <span class="keywordflow">if</span>(short_output)
<a name="l03013"></a>03013                 *short_output=NULL;
<a name="l03014"></a>03014         <span class="keywordflow">if</span>(long_output)
<a name="l03015"></a>03015                 *long_output=NULL;
<a name="l03016"></a>03016         <span class="keywordflow">if</span>(perf_data)
<a name="l03017"></a>03017                 *perf_data=NULL;
<a name="l03018"></a>03018 
<a name="l03019"></a>03019         <span class="comment">/* nothing to do */</span>
<a name="l03020"></a>03020         <span class="keywordflow">if</span>(buf==NULL || !strcmp(buf,<span class="stringliteral">&quot;&quot;</span>))
<a name="l03021"></a>03021                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03022"></a>03022 
<a name="l03023"></a>03023         used_buf=strlen(buf)+1;
<a name="l03024"></a>03024 
<a name="l03025"></a>03025         <span class="comment">/* initialize dynamic buffers (1KB chunk size) */</span>
<a name="l03026"></a>03026         <a class="code" href="base_2utils_8c.html#aa18c99ae8f740d8ab59ef720dbbde1ad">dbuf_init</a>(&amp;db1,dbuf_chunk);
<a name="l03027"></a>03027         <a class="code" href="base_2utils_8c.html#aa18c99ae8f740d8ab59ef720dbbde1ad">dbuf_init</a>(&amp;db2,dbuf_chunk);
<a name="l03028"></a>03028 
<a name="l03029"></a>03029         <span class="comment">/* unescape newlines and escaped backslashes first */</span>
<a name="l03030"></a>03030         <span class="keywordflow">if</span>(newlines_are_escaped==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l03031"></a>03031                 <span class="keywordflow">for</span>(x=0,y=0;buf[x]!=<span class="stringliteral">&#39;\x0&#39;</span>;x++){
<a name="l03032"></a>03032                         <span class="keywordflow">if</span>(buf[x]==<span class="charliteral">&#39;\\&#39;</span> &amp;&amp; buf[x+1]==<span class="charliteral">&#39;\\&#39;</span>){
<a name="l03033"></a>03033                                 x++;
<a name="l03034"></a>03034                                 buf[y++]=buf[x];
<a name="l03035"></a>03035                                 }
<a name="l03036"></a>03036                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(buf[x]==<span class="charliteral">&#39;\\&#39;</span> &amp;&amp; buf[x+1]==<span class="charliteral">&#39;n&#39;</span>){
<a name="l03037"></a>03037                                 x++;
<a name="l03038"></a>03038                                 buf[y++]=<span class="charliteral">&#39;\n&#39;</span>;
<a name="l03039"></a>03039                                 }
<a name="l03040"></a>03040                         <span class="keywordflow">else</span>
<a name="l03041"></a>03041                                 buf[y++]=buf[x];
<a name="l03042"></a>03042                         }
<a name="l03043"></a>03043                 buf[y]=<span class="stringliteral">&#39;\x0&#39;</span>;
<a name="l03044"></a>03044                 }
<a name="l03045"></a>03045 
<a name="l03046"></a>03046         <span class="comment">/* process each line of input */</span>
<a name="l03047"></a>03047         <span class="keywordflow">for</span>(x=0;eof==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;x++){
<a name="l03048"></a>03048 
<a name="l03049"></a>03049                 <span class="comment">/* we found the end of a line */</span>
<a name="l03050"></a>03050                 <span class="keywordflow">if</span>(buf[x]==<span class="charliteral">&#39;\n&#39;</span>)
<a name="l03051"></a>03051                         found_newline=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03052"></a>03052                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(buf[x]==<span class="charliteral">&#39;\\&#39;</span> &amp;&amp; buf[x+1]==<span class="charliteral">&#39;n&#39;</span> &amp;&amp; newlines_are_escaped==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l03053"></a>03053                         found_newline=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03054"></a>03054                         buf[x]=<span class="stringliteral">&#39;\x0&#39;</span>;
<a name="l03055"></a>03055                         x++;
<a name="l03056"></a>03056                         }
<a name="l03057"></a>03057                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(buf[x]==<span class="stringliteral">&#39;\x0&#39;</span>){
<a name="l03058"></a>03058                         found_newline=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03059"></a>03059                         eof=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03060"></a>03060                         }
<a name="l03061"></a>03061                 <span class="keywordflow">else</span>
<a name="l03062"></a>03062                         found_newline=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03063"></a>03063 
<a name="l03064"></a>03064                 <span class="keywordflow">if</span>(found_newline==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l03065"></a>03065 
<a name="l03066"></a>03066                         current_line++;
<a name="l03067"></a>03067 
<a name="l03068"></a>03068                         <span class="comment">/* handle this line of input */</span>
<a name="l03069"></a>03069                         buf[x]=<span class="stringliteral">&#39;\x0&#39;</span>;
<a name="l03070"></a>03070                         <span class="keywordflow">if</span>((tempbuf=(<span class="keywordtype">char</span> *)strdup(buf))){
<a name="l03071"></a>03071 
<a name="l03072"></a>03072                                 <span class="comment">/* first line contains short plugin output and optional perf data */</span>
<a name="l03073"></a>03073                                 <span class="keywordflow">if</span>(current_line==1){
<a name="l03074"></a>03074 
<a name="l03075"></a>03075                                         <span class="comment">/* get the short plugin output */</span>
<a name="l03076"></a>03076                                         <span class="keywordflow">if</span>((ptr=strtok(tempbuf,<span class="stringliteral">&quot;|&quot;</span>))){
<a name="l03077"></a>03077                                                 <span class="keywordflow">if</span>(short_output)
<a name="l03078"></a>03078                                                         *short_output=(<span class="keywordtype">char</span> *)strdup(ptr);
<a name="l03079"></a>03079 
<a name="l03080"></a>03080                                                 <span class="comment">/* get the optional perf data */</span>
<a name="l03081"></a>03081                                                 <span class="keywordflow">if</span>((ptr=strtok(NULL,<span class="stringliteral">&quot;\n&quot;</span>)))
<a name="l03082"></a>03082                                                         <a class="code" href="base_2utils_8c.html#a302c0b1965465017578bba02a6d9e6c9">dbuf_strcat</a>(&amp;db2,ptr);
<a name="l03083"></a>03083                                                 }
<a name="l03084"></a>03084                                         }
<a name="l03085"></a>03085 
<a name="l03086"></a>03086                                 <span class="comment">/* additional lines contain long plugin output and optional perf data */</span>
<a name="l03087"></a>03087                                 <span class="keywordflow">else</span>{
<a name="l03088"></a>03088 
<a name="l03089"></a>03089                                         <span class="comment">/* rest of the output is perf data */</span>
<a name="l03090"></a>03090                                         <span class="keywordflow">if</span>(in_perf_data==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l03091"></a>03091                                                 <a class="code" href="base_2utils_8c.html#a302c0b1965465017578bba02a6d9e6c9">dbuf_strcat</a>(&amp;db2,tempbuf);
<a name="l03092"></a>03092                                                 <a class="code" href="base_2utils_8c.html#a302c0b1965465017578bba02a6d9e6c9">dbuf_strcat</a>(&amp;db2,<span class="stringliteral">&quot; &quot;</span>);
<a name="l03093"></a>03093                                                 }
<a name="l03094"></a>03094 
<a name="l03095"></a>03095                                         <span class="comment">/* we&#39;re still in long output */</span>
<a name="l03096"></a>03096                                         <span class="keywordflow">else</span>{
<a name="l03097"></a>03097 
<a name="l03098"></a>03098                                                 <span class="comment">/* perf data separator has been found */</span>
<a name="l03099"></a>03099                                                 <span class="keywordflow">if</span>(strstr(tempbuf,<span class="stringliteral">&quot;|&quot;</span>)){
<a name="l03100"></a>03100 
<a name="l03101"></a>03101                                                         <span class="comment">/* NOTE: strtok() causes problems if first character of tempbuf=&#39;|&#39;, so use my_strtok() instead */</span>
<a name="l03102"></a>03102                                                         <span class="comment">/* get the remaining long plugin output */</span>
<a name="l03103"></a>03103                                                         <span class="keywordflow">if</span>((ptr=<a class="code" href="shared_8c.html#a3cb00755a99d761debc38b7252aa263d">my_strtok</a>(tempbuf,<span class="stringliteral">&quot;|&quot;</span>))){
<a name="l03104"></a>03104 
<a name="l03105"></a>03105                                                                 <span class="keywordflow">if</span>(current_line&gt;2)
<a name="l03106"></a>03106                                                                         <a class="code" href="base_2utils_8c.html#a302c0b1965465017578bba02a6d9e6c9">dbuf_strcat</a>(&amp;db1,<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l03107"></a>03107                                                                 <a class="code" href="base_2utils_8c.html#a302c0b1965465017578bba02a6d9e6c9">dbuf_strcat</a>(&amp;db1,ptr);
<a name="l03108"></a>03108 
<a name="l03109"></a>03109                                                                 <span class="comment">/* get the perf data */</span>
<a name="l03110"></a>03110                                                                 <span class="keywordflow">if</span>((ptr=<a class="code" href="shared_8c.html#a3cb00755a99d761debc38b7252aa263d">my_strtok</a>(NULL,<span class="stringliteral">&quot;\n&quot;</span>))){
<a name="l03111"></a>03111                                                                         <a class="code" href="base_2utils_8c.html#a302c0b1965465017578bba02a6d9e6c9">dbuf_strcat</a>(&amp;db2,ptr);
<a name="l03112"></a>03112                                                                         <a class="code" href="base_2utils_8c.html#a302c0b1965465017578bba02a6d9e6c9">dbuf_strcat</a>(&amp;db2,<span class="stringliteral">&quot; &quot;</span>);
<a name="l03113"></a>03113                                                                         }
<a name="l03114"></a>03114                                                                 }
<a name="l03115"></a>03115 
<a name="l03116"></a>03116                                                         <span class="comment">/* set the perf data flag */</span>
<a name="l03117"></a>03117                                                         in_perf_data=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03118"></a>03118                                                         }
<a name="l03119"></a>03119 
<a name="l03120"></a>03120                                                 <span class="comment">/* just long output */</span>
<a name="l03121"></a>03121                                                 <span class="keywordflow">else</span>{
<a name="l03122"></a>03122                                                         <span class="keywordflow">if</span>(current_line&gt;2)
<a name="l03123"></a>03123                                                                 <a class="code" href="base_2utils_8c.html#a302c0b1965465017578bba02a6d9e6c9">dbuf_strcat</a>(&amp;db1,<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l03124"></a>03124                                                         <a class="code" href="base_2utils_8c.html#a302c0b1965465017578bba02a6d9e6c9">dbuf_strcat</a>(&amp;db1,tempbuf);
<a name="l03125"></a>03125                                                         }
<a name="l03126"></a>03126                                                 }
<a name="l03127"></a>03127                                         }
<a name="l03128"></a>03128 
<a name="l03129"></a>03129                                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(tempbuf);
<a name="l03130"></a>03130                                 tempbuf=NULL;
<a name="l03131"></a>03131                                 }
<a name="l03132"></a>03132 
<a name="l03133"></a>03133 
<a name="l03134"></a>03134                         <span class="comment">/* shift data back to front of buffer and adjust counters */</span>
<a name="l03135"></a>03135                         memmove((<span class="keywordtype">void</span> *)&amp;buf[0],(<span class="keywordtype">void</span> *)&amp;buf[x+1],(<span class="keywordtype">size_t</span>)((<span class="keywordtype">int</span>)used_buf-x-1));
<a name="l03136"></a>03136                         used_buf-=(x+1);
<a name="l03137"></a>03137                         buf[used_buf]=<span class="stringliteral">&#39;\x0&#39;</span>;
<a name="l03138"></a>03138                         x=-1;
<a name="l03139"></a>03139                         }
<a name="l03140"></a>03140                 }
<a name="l03141"></a>03141 
<a name="l03142"></a>03142         <span class="comment">/* save long output */</span>
<a name="l03143"></a>03143         <span class="keywordflow">if</span>(long_output &amp;&amp; (db1.<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a> &amp;&amp; strcmp(db1.<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>,<span class="stringliteral">&quot;&quot;</span>))){
<a name="l03144"></a>03144 
<a name="l03145"></a>03145                 <span class="keywordflow">if</span>(escape_newlines_please==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l03146"></a>03146                         *long_output=(<span class="keywordtype">char</span> *)strdup(db1.<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>);
<a name="l03147"></a>03147 
<a name="l03148"></a>03148                 <span class="keywordflow">else</span>{
<a name="l03149"></a>03149 
<a name="l03150"></a>03150                         <span class="comment">/* escape newlines (and backslashes) in long output */</span>
<a name="l03151"></a>03151                         <span class="keywordflow">if</span>((tempbuf=(<span class="keywordtype">char</span> *)malloc((strlen(db1.<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>)*2)+1))){
<a name="l03152"></a>03152 
<a name="l03153"></a>03153                                 <span class="keywordflow">for</span>(x=0,y=0;db1.<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>[x]!=<span class="stringliteral">&#39;\x0&#39;</span>;x++){
<a name="l03154"></a>03154 
<a name="l03155"></a>03155                                         <span class="keywordflow">if</span>(db1.<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>[x]==<span class="charliteral">&#39;\n&#39;</span>){
<a name="l03156"></a>03156                                                 tempbuf[y++]=<span class="charliteral">&#39;\\&#39;</span>;
<a name="l03157"></a>03157                                                 tempbuf[y++]=<span class="charliteral">&#39;n&#39;</span>;
<a name="l03158"></a>03158                                                 }
<a name="l03159"></a>03159                                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(db1.<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>[x]==<span class="charliteral">&#39;\\&#39;</span>){
<a name="l03160"></a>03160                                                 tempbuf[y++]=<span class="charliteral">&#39;\\&#39;</span>;
<a name="l03161"></a>03161                                                 tempbuf[y++]=<span class="charliteral">&#39;\\&#39;</span>;
<a name="l03162"></a>03162                                                 }
<a name="l03163"></a>03163                                         <span class="keywordflow">else</span>
<a name="l03164"></a>03164                                                 tempbuf[y++]=db1.<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>[x];
<a name="l03165"></a>03165                                         }
<a name="l03166"></a>03166 
<a name="l03167"></a>03167                                 tempbuf[y]=<span class="stringliteral">&#39;\x0&#39;</span>;
<a name="l03168"></a>03168                                 *long_output=(<span class="keywordtype">char</span> *)strdup(tempbuf);
<a name="l03169"></a>03169                                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(tempbuf);
<a name="l03170"></a>03170                                 }
<a name="l03171"></a>03171                         }
<a name="l03172"></a>03172                 }
<a name="l03173"></a>03173 
<a name="l03174"></a>03174         <span class="comment">/* save perf data */</span>
<a name="l03175"></a>03175         <span class="keywordflow">if</span>(perf_data &amp;&amp; (db2.<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a> &amp;&amp; strcmp(db2.<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>,<span class="stringliteral">&quot;&quot;</span>)))
<a name="l03176"></a>03176                 *perf_data=(<span class="keywordtype">char</span> *)strdup(db2.<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>);
<a name="l03177"></a>03177 
<a name="l03178"></a>03178         <span class="comment">/* strip short output and perf data */</span>
<a name="l03179"></a>03179         <span class="keywordflow">if</span>(short_output)
<a name="l03180"></a>03180                 <a class="code" href="icingastats_8c.html#a44ed939e710ce4674954d98865b42ec0">strip</a>(*short_output);
<a name="l03181"></a>03181         <span class="keywordflow">if</span>(perf_data)
<a name="l03182"></a>03182                 <a class="code" href="icingastats_8c.html#a44ed939e710ce4674954d98865b42ec0">strip</a>(*perf_data);
<a name="l03183"></a>03183 
<a name="l03184"></a>03184         <span class="comment">/* free dynamic buffers */</span>
<a name="l03185"></a>03185         <a class="code" href="base_2utils_8c.html#ad793f77d0d1041d670ff9bee3a5cda5d">dbuf_free</a>(&amp;db1);
<a name="l03186"></a>03186         <a class="code" href="base_2utils_8c.html#ad793f77d0d1041d670ff9bee3a5cda5d">dbuf_free</a>(&amp;db2);
<a name="l03187"></a>03187 
<a name="l03188"></a>03188         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03189"></a>03189         }
<a name="l03190"></a>03190 
<a name="l03191"></a>03191 
<a name="l03192"></a>03192 
<a name="l03193"></a>03193 <span class="comment">/* creates external command file as a named pipe (FIFO) and opens it for reading (non-blocked mode) */</span>
<a name="l03194"></a><a class="code" href="icinga_8h.html#a811af233e8723896b522cfe24223d4c3">03194</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a811af233e8723896b522cfe24223d4c3">open_command_file</a>(<span class="keywordtype">void</span>){
<a name="l03195"></a>03195         <span class="keyword">struct </span>stat st;
<a name="l03196"></a>03196         <span class="keywordtype">int</span> result=0;
<a name="l03197"></a>03197 
<a name="l03198"></a>03198         <span class="comment">/* if we&#39;re not checking external commands, don&#39;t do anything */</span>
<a name="l03199"></a>03199         <span class="keywordflow">if</span>(<a class="code" href="commands_8c.html#abf64fe29cddb0d890bbece7d4d970c18">check_external_commands</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l03200"></a>03200                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03201"></a>03201 
<a name="l03202"></a>03202         <span class="comment">/* the command file was already created */</span>
<a name="l03203"></a>03203         <span class="keywordflow">if</span>(<a class="code" href="icinga_8c.html#a3416bf570587e753da5b8da11d1f8f5c">command_file_created</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l03204"></a>03204                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03205"></a>03205 
<a name="l03206"></a>03206         <span class="comment">/* reset umask (group needs write permissions) */</span>
<a name="l03207"></a>03207         umask(S_IWOTH);
<a name="l03208"></a>03208 
<a name="l03209"></a>03209         <span class="comment">/* use existing FIFO if possible */</span>
<a name="l03210"></a>03210         <span class="keywordflow">if</span>(!(stat(<a class="code" href="commands_8c.html#ad6bb81fae52e357701eadd493eca7902">command_file</a>,&amp;st)!=-1 &amp;&amp; (st.st_mode &amp; S_IFIFO))){
<a name="l03211"></a>03211 
<a name="l03212"></a>03212                 <span class="comment">/* create the external command file as a named pipe (FIFO) */</span>
<a name="l03213"></a>03213                 <span class="keywordflow">if</span>((result=mkfifo(<a class="code" href="commands_8c.html#ad6bb81fae52e357701eadd493eca7902">command_file</a>,S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP))!=0){
<a name="l03214"></a>03214 
<a name="l03215"></a>03215                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Error: Could not create external command file &#39;%s&#39; as named pipe: (%d) -&gt; %s.  If this file already exists and you are sure that another copy of %s is not running, you should delete this file.\n&quot;</span>, <a class="code" href="commands_8c.html#ad6bb81fae52e357701eadd493eca7902">command_file</a>, <a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, strerror(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>), <a class="code" href="include_2common_8h.html#a3b6a35b8be8405a9db72cc5dea97954b">PROGRAM_NAME</a>);
<a name="l03216"></a>03216                         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03217"></a>03217                         }
<a name="l03218"></a>03218                 }
<a name="l03219"></a>03219 
<a name="l03220"></a>03220         <span class="comment">/* open the command file for reading (non-blocked) - O_TRUNC flag cannot be used due to errors on some systems */</span>
<a name="l03221"></a>03221         <span class="comment">/* NOTE: file must be opened read-write for poll() to work */</span>
<a name="l03222"></a>03222         <span class="keywordflow">if</span>((<a class="code" href="commands_8c.html#a8d1be59b1a087eaeb87f6e4774cb499a">command_file_fd</a>=open(<a class="code" href="commands_8c.html#ad6bb81fae52e357701eadd493eca7902">command_file</a>,O_RDWR | O_NONBLOCK))&lt;0){
<a name="l03223"></a>03223 
<a name="l03224"></a>03224                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Error: Could not open external command file for reading via open(): (%d) -&gt; %s\n&quot;</span>,<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>,strerror(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03225"></a>03225 
<a name="l03226"></a>03226                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03227"></a>03227                 }
<a name="l03228"></a>03228 
<a name="l03229"></a>03229         <span class="comment">/* re-open the FIFO for use with fgets() */</span>
<a name="l03230"></a>03230         <span class="keywordflow">if</span>((<a class="code" href="commands_8c.html#a67e68b43d7661b866f04f4609dd1decf">command_file_fp</a>=(FILE *)fdopen(<a class="code" href="commands_8c.html#a8d1be59b1a087eaeb87f6e4774cb499a">command_file_fd</a>,<span class="stringliteral">&quot;r&quot;</span>))==NULL){
<a name="l03231"></a>03231 
<a name="l03232"></a>03232                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Error: Could not open external command file for reading via fdopen(): (%d) -&gt; %s\n&quot;</span>,<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>,strerror(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03233"></a>03233 
<a name="l03234"></a>03234                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03235"></a>03235                 }
<a name="l03236"></a>03236 
<a name="l03237"></a>03237         <span class="comment">/* initialize worker thread */</span>
<a name="l03238"></a>03238         <span class="keywordflow">if</span>(<a class="code" href="base_2utils_8c.html#af162bb05174b7dfa3e36b4c4cc8b5693">init_command_file_worker_thread</a>()==<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>){
<a name="l03239"></a>03239 
<a name="l03240"></a>03240                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Error: Could not initialize command file worker thread.\n&quot;</span>);
<a name="l03241"></a>03241 
<a name="l03242"></a>03242                 <span class="comment">/* close the command file */</span>
<a name="l03243"></a>03243                 fclose(<a class="code" href="commands_8c.html#a67e68b43d7661b866f04f4609dd1decf">command_file_fp</a>);
<a name="l03244"></a>03244 
<a name="l03245"></a>03245                 <span class="comment">/* delete the named pipe */</span>
<a name="l03246"></a>03246                 unlink(<a class="code" href="commands_8c.html#ad6bb81fae52e357701eadd493eca7902">command_file</a>);
<a name="l03247"></a>03247 
<a name="l03248"></a>03248                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03249"></a>03249                 }
<a name="l03250"></a>03250 
<a name="l03251"></a>03251         <span class="comment">/* set a flag to remember we already created the file */</span>
<a name="l03252"></a>03252         <a class="code" href="icinga_8c.html#a3416bf570587e753da5b8da11d1f8f5c">command_file_created</a>=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03253"></a>03253 
<a name="l03254"></a>03254         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03255"></a>03255         }
<a name="l03256"></a>03256 
<a name="l03257"></a>03257 
<a name="l03258"></a>03258 <span class="comment">/* closes the external command file FIFO and deletes it */</span>
<a name="l03259"></a><a class="code" href="icinga_8h.html#a5e15280db8f3a81c3d955260965899a0">03259</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a5e15280db8f3a81c3d955260965899a0">close_command_file</a>(<span class="keywordtype">void</span>){
<a name="l03260"></a>03260 
<a name="l03261"></a>03261         <span class="comment">/* if we&#39;re not checking external commands, don&#39;t do anything */</span>
<a name="l03262"></a>03262         <span class="keywordflow">if</span>(<a class="code" href="commands_8c.html#abf64fe29cddb0d890bbece7d4d970c18">check_external_commands</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l03263"></a>03263                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03264"></a>03264 
<a name="l03265"></a>03265         <span class="comment">/* the command file wasn&#39;t created or was already cleaned up */</span>
<a name="l03266"></a>03266         <span class="keywordflow">if</span>(<a class="code" href="icinga_8c.html#a3416bf570587e753da5b8da11d1f8f5c">command_file_created</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l03267"></a>03267                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03268"></a>03268 
<a name="l03269"></a>03269         <span class="comment">/* reset our flag */</span>
<a name="l03270"></a>03270         <a class="code" href="icinga_8c.html#a3416bf570587e753da5b8da11d1f8f5c">command_file_created</a>=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03271"></a>03271 
<a name="l03272"></a>03272         <span class="comment">/* close the command file */</span>
<a name="l03273"></a>03273         fclose(<a class="code" href="commands_8c.html#a67e68b43d7661b866f04f4609dd1decf">command_file_fp</a>);
<a name="l03274"></a>03274 
<a name="l03275"></a>03275         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03276"></a>03276         }
<a name="l03277"></a>03277 
<a name="l03278"></a>03278 
<a name="l03279"></a>03279 
<a name="l03280"></a>03280 
<a name="l03281"></a>03281 <span class="comment">/******************************************************************/</span>
<a name="l03282"></a>03282 <span class="comment">/************************ STRING FUNCTIONS ************************/</span>
<a name="l03283"></a>03283 <span class="comment">/******************************************************************/</span>
<a name="l03284"></a>03284 
<a name="l03285"></a>03285 <span class="comment">/* gets the next string from a buffer in memory - strings are terminated by newlines, which are removed */</span>
<a name="l03286"></a><a class="code" href="icinga_8h.html#a4d121e7d9d18f801615e786fa381a4db">03286</a> <span class="keywordtype">char</span> *<a class="code" href="base_2utils_8c.html#a4d121e7d9d18f801615e786fa381a4db">get_next_string_from_buf</a>(<span class="keywordtype">char</span> *buf, <span class="keywordtype">int</span> *start_index, <span class="keywordtype">int</span> bufsize){
<a name="l03287"></a>03287         <span class="keywordtype">char</span> *sptr=NULL;
<a name="l03288"></a>03288         <span class="keywordtype">char</span> *nl=<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l03289"></a>03289         <span class="keywordtype">int</span> x;
<a name="l03290"></a>03290 
<a name="l03291"></a>03291         <span class="keywordflow">if</span>(buf==NULL || start_index==NULL)
<a name="l03292"></a>03292                 <span class="keywordflow">return</span> NULL;
<a name="l03293"></a>03293         <span class="keywordflow">if</span>(bufsize&lt;0)
<a name="l03294"></a>03294                 <span class="keywordflow">return</span> NULL;
<a name="l03295"></a>03295         <span class="keywordflow">if</span>(*start_index &gt;= (bufsize-1))
<a name="l03296"></a>03296                 <span class="keywordflow">return</span> NULL;
<a name="l03297"></a>03297 
<a name="l03298"></a>03298         sptr=buf+*start_index;
<a name="l03299"></a>03299 
<a name="l03300"></a>03300         <span class="comment">/* end of buffer */</span>
<a name="l03301"></a>03301         <span class="keywordflow">if</span>(sptr[0]==<span class="stringliteral">&#39;\x0&#39;</span>)
<a name="l03302"></a>03302                 <span class="keywordflow">return</span> NULL;
<a name="l03303"></a>03303 
<a name="l03304"></a>03304         x=strcspn(sptr,nl);
<a name="l03305"></a>03305         sptr[x]=<span class="stringliteral">&#39;\x0&#39;</span>;
<a name="l03306"></a>03306 
<a name="l03307"></a>03307         *start_index+=x+1;
<a name="l03308"></a>03308 
<a name="l03309"></a>03309         <span class="keywordflow">return</span> sptr;
<a name="l03310"></a>03310         }
<a name="l03311"></a>03311 
<a name="l03312"></a>03312 
<a name="l03313"></a>03313 
<a name="l03314"></a>03314 <span class="comment">/* determines whether or not an object name (host, service, etc) contains illegal characters */</span>
<a name="l03315"></a><a class="code" href="icinga_8h.html#a18f32c04df364bf0b429604a3b8d7f6f">03315</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a4c150fb3728c7b4887cc64bb222315e0">contains_illegal_object_chars</a>(<span class="keywordtype">char</span> *name){
<a name="l03316"></a>03316         <span class="keyword">register</span> <span class="keywordtype">int</span> x=0;
<a name="l03317"></a>03317         <span class="keyword">register</span> <span class="keywordtype">int</span> y=0;
<a name="l03318"></a>03318         <span class="keyword">register</span> <span class="keywordtype">int</span> ch=0;
<a name="l03319"></a>03319 
<a name="l03320"></a>03320         <span class="keywordflow">if</span>(name==NULL)
<a name="l03321"></a>03321                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03322"></a>03322 
<a name="l03323"></a>03323         x=(int)strlen(name)-1;
<a name="l03324"></a>03324 
<a name="l03325"></a>03325         <span class="keywordflow">for</span>(;x&gt;=0;x--){
<a name="l03326"></a>03326 
<a name="l03327"></a>03327                 ch=(int)name[x];
<a name="l03328"></a>03328 
<a name="l03329"></a>03329                 <span class="comment">/* illegal user-specified characters */</span>
<a name="l03330"></a>03330                 <span class="keywordflow">if</span>(<a class="code" href="base_2config_8c.html#a21ee8da3605317fd63a1b2dca3f3fd22">illegal_object_chars</a>!=NULL)
<a name="l03331"></a>03331                         <span class="keywordflow">for</span>(y=0;<a class="code" href="base_2config_8c.html#a21ee8da3605317fd63a1b2dca3f3fd22">illegal_object_chars</a>[y];y++)
<a name="l03332"></a>03332                                 <span class="keywordflow">if</span>(name[x]==<a class="code" href="base_2config_8c.html#a21ee8da3605317fd63a1b2dca3f3fd22">illegal_object_chars</a>[y])
<a name="l03333"></a>03333                                         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03334"></a>03334                 }
<a name="l03335"></a>03335 
<a name="l03336"></a>03336         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03337"></a>03337         }
<a name="l03338"></a>03338 
<a name="l03339"></a>03339 
<a name="l03340"></a>03340 <span class="comment">/* escapes newlines in a string */</span>
<a name="l03341"></a><a class="code" href="icinga_8h.html#a5ac38a2954cefcce92cfbae02e883daf">03341</a> <span class="keywordtype">char</span> *<a class="code" href="base_2utils_8c.html#a7122ec70de7a5439b8360b86a97071b0">escape_newlines</a>(<span class="keywordtype">char</span> *rawbuf){
<a name="l03342"></a>03342         <span class="keywordtype">char</span> *newbuf=NULL;
<a name="l03343"></a>03343         <span class="keyword">register</span> <span class="keywordtype">int</span> x,y;
<a name="l03344"></a>03344 
<a name="l03345"></a>03345         <span class="keywordflow">if</span>(rawbuf==NULL)
<a name="l03346"></a>03346                 <span class="keywordflow">return</span> NULL;
<a name="l03347"></a>03347 
<a name="l03348"></a>03348         <span class="comment">/* allocate enough memory to escape all chars if necessary */</span>
<a name="l03349"></a>03349         <span class="keywordflow">if</span>((newbuf=malloc((strlen(rawbuf)*2)+1))==NULL)
<a name="l03350"></a>03350                 <span class="keywordflow">return</span> NULL;
<a name="l03351"></a>03351 
<a name="l03352"></a>03352         <span class="keywordflow">for</span>(x=0,y=0;rawbuf[x]!=(char)<span class="stringliteral">&#39;\x0&#39;</span>;x++){
<a name="l03353"></a>03353 
<a name="l03354"></a>03354                 <span class="comment">/* escape backslashes */</span>
<a name="l03355"></a>03355                 <span class="keywordflow">if</span>(rawbuf[x]==<span class="charliteral">&#39;\\&#39;</span>){
<a name="l03356"></a>03356                         newbuf[y++]=<span class="charliteral">&#39;\\&#39;</span>;
<a name="l03357"></a>03357                         newbuf[y++]=<span class="charliteral">&#39;\\&#39;</span>;
<a name="l03358"></a>03358                         }
<a name="l03359"></a>03359 
<a name="l03360"></a>03360                 <span class="comment">/* escape newlines */</span>
<a name="l03361"></a>03361                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rawbuf[x]==<span class="charliteral">&#39;\n&#39;</span>){
<a name="l03362"></a>03362                         newbuf[y++]=<span class="charliteral">&#39;\\&#39;</span>;
<a name="l03363"></a>03363                         newbuf[y++]=<span class="charliteral">&#39;n&#39;</span>;
<a name="l03364"></a>03364                         }
<a name="l03365"></a>03365 
<a name="l03366"></a>03366                 <span class="keywordflow">else</span>
<a name="l03367"></a>03367                         newbuf[y++]=rawbuf[x];
<a name="l03368"></a>03368                 }
<a name="l03369"></a>03369         newbuf[y]=<span class="stringliteral">&#39;\x0&#39;</span>;
<a name="l03370"></a>03370 
<a name="l03371"></a>03371         <span class="keywordflow">return</span> newbuf;
<a name="l03372"></a>03372         }
<a name="l03373"></a>03373 
<a name="l03374"></a>03374 
<a name="l03375"></a>03375 <span class="comment">/* compares strings */</span>
<a name="l03376"></a><a class="code" href="icinga_8h.html#a95e3bd3ce2d43728968ecef4c5b1c3c5">03376</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a93ccc39494aa0f291d6c4a117be0bfff">compare_strings</a>(<span class="keywordtype">char</span> *val1a, <span class="keywordtype">char</span> *val2a){
<a name="l03377"></a>03377 
<a name="l03378"></a>03378         <span class="comment">/* use the compare_hashdata() function */</span>
<a name="l03379"></a>03379         <span class="keywordflow">return</span> <a class="code" href="shared_8c.html#a74ee2de3b9d744e9f42dafb712b17907">compare_hashdata</a>(val1a,NULL,val2a,NULL);
<a name="l03380"></a>03380         }
<a name="l03381"></a>03381 
<a name="l03382"></a>03382 
<a name="l03383"></a>03383 <span class="comment">/******************************************************************/</span>
<a name="l03384"></a>03384 <span class="comment">/************************* FILE FUNCTIONS *************************/</span>
<a name="l03385"></a>03385 <span class="comment">/******************************************************************/</span>
<a name="l03386"></a>03386 
<a name="l03387"></a>03387 <span class="comment">/* renames a file - works across filesystems (Mike Wiacek) */</span>
<a name="l03388"></a><a class="code" href="utils_8h.html#aa8ca51e8e01312e5493641269adadf62">03388</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#aa23bc32b41818196b62048be4ee1803e">my_rename</a>(<span class="keywordtype">char</span> *source, <span class="keywordtype">char</span> *dest){
<a name="l03389"></a>03389         <span class="keywordtype">int</span> rename_result=0;
<a name="l03390"></a>03390 
<a name="l03391"></a>03391 
<a name="l03392"></a>03392         <span class="comment">/* make sure we have something */</span>
<a name="l03393"></a>03393         <span class="keywordflow">if</span>(source==NULL || dest==NULL)
<a name="l03394"></a>03394                 <span class="keywordflow">return</span> -1;
<a name="l03395"></a>03395 
<a name="l03396"></a>03396         <span class="comment">/* first see if we can rename file with standard function */</span>
<a name="l03397"></a>03397         rename_result=rename(source,dest);
<a name="l03398"></a>03398 
<a name="l03399"></a>03399         <span class="comment">/* handle any errors... */</span>
<a name="l03400"></a>03400         <span class="keywordflow">if</span>(rename_result==-1){
<a name="l03401"></a>03401 
<a name="l03402"></a>03402                 <span class="comment">/* an error occurred because the source and dest files are on different filesystems */</span>
<a name="l03403"></a>03403                 <span class="keywordflow">if</span>(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>==EXDEV){
<a name="l03404"></a>03404 
<a name="l03405"></a>03405                         <span class="comment">/* try copying the file */</span>
<a name="l03406"></a>03406                         <span class="keywordflow">if</span>(<a class="code" href="base_2utils_8c.html#ac6470eb99f0ae464c12f8a4c18baff28">my_fcopy</a>(source,dest)==<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>){
<a name="l03407"></a>03407                                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Error: Unable to rename file &#39;%s&#39; to &#39;%s&#39;: %s\n&quot;</span>,source,dest,strerror(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03408"></a>03408                                 <span class="keywordflow">return</span> -1;
<a name="l03409"></a>03409                                 }
<a name="l03410"></a>03410 
<a name="l03411"></a>03411                         <span class="comment">/* delete the original file */</span>
<a name="l03412"></a>03412                         unlink(source);
<a name="l03413"></a>03413 
<a name="l03414"></a>03414                         <span class="comment">/* reset result since we successfully copied file */</span>
<a name="l03415"></a>03415                         rename_result=0;
<a name="l03416"></a>03416                         }
<a name="l03417"></a>03417 
<a name="l03418"></a>03418                 <span class="comment">/* some other error occurred */</span>
<a name="l03419"></a>03419                 <span class="keywordflow">else</span>{
<a name="l03420"></a>03420                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Error: Unable to rename file &#39;%s&#39; to &#39;%s&#39;: %s\n&quot;</span>,source,dest,strerror(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03421"></a>03421                         <span class="keywordflow">return</span> rename_result;
<a name="l03422"></a>03422                         }
<a name="l03423"></a>03423                 }
<a name="l03424"></a>03424 
<a name="l03425"></a>03425         <span class="keywordflow">return</span> rename_result;
<a name="l03426"></a>03426         }
<a name="l03427"></a>03427 
<a name="l03428"></a>03428 <span class="comment">/*</span>
<a name="l03429"></a>03429 <span class="comment"> * copy a file from the path at source to the already opened</span>
<a name="l03430"></a>03430 <span class="comment"> * destination file dest.</span>
<a name="l03431"></a>03431 <span class="comment"> * This is handy when creating tempfiles with mkstemp()</span>
<a name="l03432"></a>03432 <span class="comment"> */</span>
<a name="l03433"></a><a class="code" href="icinga_8h.html#a0033bee26a50d3578d129925df7c4a02">03433</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a624fd36cef664802edc5acaabfd05e71">my_fdcopy</a>(<span class="keywordtype">char</span> *source, <span class="keywordtype">char</span> *dest, <span class="keywordtype">int</span> dest_fd){
<a name="l03434"></a>03434         <span class="keywordtype">int</span> source_fd, rd_result = 0, wr_result = 0;
<a name="l03435"></a>03435         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> tot_written = 0, tot_read = 0, buf_size = 0;
<a name="l03436"></a>03436         <span class="keyword">struct </span>stat st;
<a name="l03437"></a>03437         <span class="keywordtype">char</span> *buf;
<a name="l03438"></a>03438 
<a name="l03439"></a>03439         <span class="comment">/* open source file for reading */</span>
<a name="l03440"></a>03440         <span class="keywordflow">if</span>((source_fd=open(source,O_RDONLY,0644)) &lt; 0){
<a name="l03441"></a>03441                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Error: Unable to open file &#39;%s&#39; for reading: %s\n&quot;</span>,source,strerror(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03442"></a>03442                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03443"></a>03443         }
<a name="l03444"></a>03444 
<a name="l03445"></a>03445         <span class="comment">/*</span>
<a name="l03446"></a>03446 <span class="comment">         * find out how large the source-file is so we can be sure</span>
<a name="l03447"></a>03447 <span class="comment">         * we&#39;ve written all of it</span>
<a name="l03448"></a>03448 <span class="comment">         */</span>
<a name="l03449"></a>03449         <span class="keywordflow">if</span> (fstat(source_fd, &amp;st) &lt; 0) {
<a name="l03450"></a>03450                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Error: Unable to stat source file &#39;%s&#39; for my_fcopy(): %s\n&quot;</span>, source, strerror(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03451"></a>03451                 close(source_fd);
<a name="l03452"></a>03452                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03453"></a>03453         }
<a name="l03454"></a>03454 
<a name="l03455"></a>03455         <span class="comment">/*</span>
<a name="l03456"></a>03456 <span class="comment">         * If the file is huge, read it and write it in chunks.</span>
<a name="l03457"></a>03457 <span class="comment">         * This value (128K) is the result of &quot;pick-one-at-random&quot;</span>
<a name="l03458"></a>03458 <span class="comment">         * with some minimal testing and may not be optimal for all</span>
<a name="l03459"></a>03459 <span class="comment">         * hardware setups, but it should work ok for most. It&#39;s</span>
<a name="l03460"></a>03460 <span class="comment">         * faster than 1K buffers and 1M buffers, so change at your</span>
<a name="l03461"></a>03461 <span class="comment">         * own peril. Note that it&#39;s useful to make it fit in the L2</span>
<a name="l03462"></a>03462 <span class="comment">         * cache, so larger isn&#39;t necessarily better.</span>
<a name="l03463"></a>03463 <span class="comment">         */</span>
<a name="l03464"></a>03464         buf_size = st.st_size &gt; 128 &lt;&lt; 10 ? 128 &lt;&lt; 10 : st.st_size;
<a name="l03465"></a>03465         buf = malloc(buf_size);
<a name="l03466"></a>03466         <span class="keywordflow">if</span> (!buf) {
<a name="l03467"></a>03467                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Error: Unable to malloc(%lu) bytes: %s\n&quot;</span>, buf_size, strerror(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03468"></a>03468                 close(source_fd);
<a name="l03469"></a>03469                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03470"></a>03470         }
<a name="l03471"></a>03471         <span class="comment">/* most of the times, this loop will be gone through once */</span>
<a name="l03472"></a>03472         <span class="keywordflow">while</span> (tot_written &lt; st.st_size) {
<a name="l03473"></a>03473                 <span class="keywordtype">int</span> loop_wr = 0;
<a name="l03474"></a>03474 
<a name="l03475"></a>03475                 rd_result = read(source_fd, buf, buf_size);
<a name="l03476"></a>03476                 <span class="keywordflow">if</span> (rd_result &lt; 0) {
<a name="l03477"></a>03477                         <span class="keywordflow">if</span> (<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EAGAIN || <a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EINTR)
<a name="l03478"></a>03478                                 <span class="keywordflow">continue</span>;
<a name="l03479"></a>03479                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Error: my_fcopy() failed to read from &#39;%s&#39;: %s\n&quot;</span>, source, strerror(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03480"></a>03480                         <span class="keywordflow">break</span>;
<a name="l03481"></a>03481                 }
<a name="l03482"></a>03482                 tot_read += rd_result;
<a name="l03483"></a>03483 
<a name="l03484"></a>03484                 <span class="keywordflow">while</span> (loop_wr &lt; rd_result) {
<a name="l03485"></a>03485                         wr_result = write(dest_fd, buf + loop_wr, rd_result - loop_wr);
<a name="l03486"></a>03486 
<a name="l03487"></a>03487                         <span class="keywordflow">if</span> (wr_result &lt; 0) {
<a name="l03488"></a>03488                                 <span class="keywordflow">if</span> (<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EAGAIN || <a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EINTR)
<a name="l03489"></a>03489                                         <span class="keywordflow">continue</span>;
<a name="l03490"></a>03490                                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Error: my_fcopy() failed to write to &#39;%s&#39;: %s\n&quot;</span>, dest, strerror(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03491"></a>03491                                 <span class="keywordflow">break</span>;
<a name="l03492"></a>03492                         }
<a name="l03493"></a>03493                         loop_wr += wr_result;
<a name="l03494"></a>03494                 }
<a name="l03495"></a>03495                 <span class="keywordflow">if</span> (wr_result &lt; 0)
<a name="l03496"></a>03496                         <span class="keywordflow">break</span>;
<a name="l03497"></a>03497                 tot_written += loop_wr;
<a name="l03498"></a>03498         }
<a name="l03499"></a>03499 
<a name="l03500"></a>03500         <span class="comment">/*</span>
<a name="l03501"></a>03501 <span class="comment">         * clean up irregardless of how things went. dest_fd comes from</span>
<a name="l03502"></a>03502 <span class="comment">         * our caller, so we mustn&#39;t close it.</span>
<a name="l03503"></a>03503 <span class="comment">         */</span>
<a name="l03504"></a>03504         close(source_fd);
<a name="l03505"></a>03505         free(buf);
<a name="l03506"></a>03506 
<a name="l03507"></a>03507         <span class="keywordflow">if</span> (rd_result &lt; 0 || wr_result &lt; 0) {
<a name="l03508"></a>03508                 <span class="comment">/* don&#39;t leave half-written files around */</span>
<a name="l03509"></a>03509                 unlink(dest);
<a name="l03510"></a>03510                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03511"></a>03511         }
<a name="l03512"></a>03512 
<a name="l03513"></a>03513         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03514"></a>03514 }
<a name="l03515"></a>03515 
<a name="l03516"></a>03516 
<a name="l03517"></a>03517 <span class="comment">/* copies a file */</span>
<a name="l03518"></a><a class="code" href="icinga_8h.html#ad057c4bc067a70e590657eca0c7ee9e3">03518</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#ac6470eb99f0ae464c12f8a4c18baff28">my_fcopy</a>(<span class="keywordtype">char</span> *source, <span class="keywordtype">char</span> *dest){
<a name="l03519"></a>03519         <span class="keywordtype">int</span> dest_fd, result;
<a name="l03520"></a>03520 
<a name="l03521"></a>03521         <span class="comment">/* make sure we have something */</span>
<a name="l03522"></a>03522         <span class="keywordflow">if</span>(source==NULL || dest==NULL)
<a name="l03523"></a>03523                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03524"></a>03524 
<a name="l03525"></a>03525         <span class="comment">/* unlink destination file first (not doing so can cause problems on network file systems like CIFS) */</span>
<a name="l03526"></a>03526         unlink(dest);
<a name="l03527"></a>03527 
<a name="l03528"></a>03528         <span class="comment">/* open destination file for writing */</span>
<a name="l03529"></a>03529         <span class="keywordflow">if</span>((dest_fd=open(dest,O_WRONLY|O_TRUNC|O_CREAT|O_APPEND,0644)) &lt; 0){
<a name="l03530"></a>03530                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Error: Unable to open file &#39;%s&#39; for writing: %s\n&quot;</span>,dest,strerror(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03531"></a>03531                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03532"></a>03532         }
<a name="l03533"></a>03533 
<a name="l03534"></a>03534         result = <a class="code" href="base_2utils_8c.html#a624fd36cef664802edc5acaabfd05e71">my_fdcopy</a>(source, dest, dest_fd);
<a name="l03535"></a>03535         close(dest_fd);
<a name="l03536"></a>03536         <span class="keywordflow">return</span> result;
<a name="l03537"></a>03537 }
<a name="l03538"></a>03538 
<a name="l03539"></a>03539 
<a name="l03540"></a>03540 <span class="comment">/******************************************************************/</span>
<a name="l03541"></a>03541 <span class="comment">/******************** DYNAMIC BUFFER FUNCTIONS ********************/</span>
<a name="l03542"></a>03542 <span class="comment">/******************************************************************/</span>
<a name="l03543"></a>03543 
<a name="l03544"></a>03544 <span class="comment">/* initializes a dynamic buffer */</span>
<a name="l03545"></a><a class="code" href="icinga_8h.html#a1a44ca058a08a94034572d6621431633">03545</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#aa18c99ae8f740d8ab59ef720dbbde1ad">dbuf_init</a>(<a class="code" href="structdbuf__struct.html">dbuf</a> *db, <span class="keywordtype">int</span> chunk_size){
<a name="l03546"></a>03546 
<a name="l03547"></a>03547         <span class="keywordflow">if</span>(db==NULL)
<a name="l03548"></a>03548                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03549"></a>03549 
<a name="l03550"></a>03550         db-&gt;<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>=NULL;
<a name="l03551"></a>03551         db-&gt;<a class="code" href="structdbuf__struct.html#ac2b15cba41a30919bd74676dc3a40840">used_size</a>=0L;
<a name="l03552"></a>03552         db-&gt;<a class="code" href="structdbuf__struct.html#a8ed6df51add1e6c5ac8fcf58bfe2cfbc">allocated_size</a>=0L;
<a name="l03553"></a>03553         db-&gt;<a class="code" href="structdbuf__struct.html#a136bfc22df393af36d8f874c16438d5d">chunk_size</a>=chunk_size;
<a name="l03554"></a>03554 
<a name="l03555"></a>03555         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03556"></a>03556         }
<a name="l03557"></a>03557 
<a name="l03558"></a>03558 
<a name="l03559"></a>03559 <span class="comment">/* frees a dynamic buffer */</span>
<a name="l03560"></a><a class="code" href="icinga_8h.html#a6590fcf33d2f1cc2d239f5469a932455">03560</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#ad793f77d0d1041d670ff9bee3a5cda5d">dbuf_free</a>(<a class="code" href="structdbuf__struct.html">dbuf</a> *db){
<a name="l03561"></a>03561 
<a name="l03562"></a>03562         <span class="keywordflow">if</span>(db==NULL)
<a name="l03563"></a>03563                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03564"></a>03564 
<a name="l03565"></a>03565         <span class="keywordflow">if</span>(db-&gt;<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>!=NULL)
<a name="l03566"></a>03566                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(db-&gt;<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>);
<a name="l03567"></a>03567         db-&gt;<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>=NULL;
<a name="l03568"></a>03568         db-&gt;<a class="code" href="structdbuf__struct.html#ac2b15cba41a30919bd74676dc3a40840">used_size</a>=0L;
<a name="l03569"></a>03569         db-&gt;<a class="code" href="structdbuf__struct.html#a8ed6df51add1e6c5ac8fcf58bfe2cfbc">allocated_size</a>=0L;
<a name="l03570"></a>03570 
<a name="l03571"></a>03571         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03572"></a>03572         }
<a name="l03573"></a>03573 
<a name="l03574"></a>03574 
<a name="l03575"></a>03575 <span class="comment">/* dynamically expands a string */</span>
<a name="l03576"></a><a class="code" href="icinga_8h.html#ae02f5c12cab1eb44ac7129df6bfd2b14">03576</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a302c0b1965465017578bba02a6d9e6c9">dbuf_strcat</a>(<a class="code" href="structdbuf__struct.html">dbuf</a> *db, <span class="keywordtype">char</span> *buf){
<a name="l03577"></a>03577         <span class="keywordtype">char</span> *newbuf=NULL;
<a name="l03578"></a>03578         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> buflen=0L;
<a name="l03579"></a>03579         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> new_size=0L;
<a name="l03580"></a>03580         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> memory_needed=0L;
<a name="l03581"></a>03581 
<a name="l03582"></a>03582         <span class="keywordflow">if</span>(db==NULL || buf==NULL)
<a name="l03583"></a>03583                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03584"></a>03584 
<a name="l03585"></a>03585         <span class="comment">/* how much memory should we allocate (if any)? */</span>
<a name="l03586"></a>03586         buflen=strlen(buf);
<a name="l03587"></a>03587         new_size=db-&gt;<a class="code" href="structdbuf__struct.html#ac2b15cba41a30919bd74676dc3a40840">used_size</a>+buflen+1;
<a name="l03588"></a>03588 
<a name="l03589"></a>03589         <span class="comment">/* we need more memory */</span>
<a name="l03590"></a>03590         <span class="keywordflow">if</span>(db-&gt;<a class="code" href="structdbuf__struct.html#a8ed6df51add1e6c5ac8fcf58bfe2cfbc">allocated_size</a>&lt;new_size){
<a name="l03591"></a>03591 
<a name="l03592"></a>03592                 memory_needed=((ceil(new_size/db-&gt;<a class="code" href="structdbuf__struct.html#a136bfc22df393af36d8f874c16438d5d">chunk_size</a>)+1)*db-&gt;<a class="code" href="structdbuf__struct.html#a136bfc22df393af36d8f874c16438d5d">chunk_size</a>);
<a name="l03593"></a>03593 
<a name="l03594"></a>03594                 <span class="comment">/* allocate memory to store old and new string */</span>
<a name="l03595"></a>03595                 <span class="keywordflow">if</span>((newbuf=(<span class="keywordtype">char</span> *)realloc((<span class="keywordtype">void</span> *)db-&gt;<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>,(<span class="keywordtype">size_t</span>)memory_needed))==NULL)
<a name="l03596"></a>03596                         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03597"></a>03597 
<a name="l03598"></a>03598                 <span class="comment">/* update buffer pointer */</span>
<a name="l03599"></a>03599                 db-&gt;<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>=newbuf;
<a name="l03600"></a>03600 
<a name="l03601"></a>03601                 <span class="comment">/* update allocated size */</span>
<a name="l03602"></a>03602                 db-&gt;<a class="code" href="structdbuf__struct.html#a8ed6df51add1e6c5ac8fcf58bfe2cfbc">allocated_size</a>=memory_needed;
<a name="l03603"></a>03603 
<a name="l03604"></a>03604                 <span class="comment">/* terminate buffer */</span>
<a name="l03605"></a>03605                 db-&gt;<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>[db-&gt;<a class="code" href="structdbuf__struct.html#ac2b15cba41a30919bd74676dc3a40840">used_size</a>]=<span class="stringliteral">&#39;\x0&#39;</span>;
<a name="l03606"></a>03606                 }
<a name="l03607"></a>03607 
<a name="l03608"></a>03608         <span class="comment">/* append the new string */</span>
<a name="l03609"></a>03609         strcat(db-&gt;<a class="code" href="structdbuf__struct.html#a7e54dcd673bfadefcbd09f1087172808">buf</a>,buf);
<a name="l03610"></a>03610 
<a name="l03611"></a>03611         <span class="comment">/* update size allocated */</span>
<a name="l03612"></a>03612         db-&gt;<a class="code" href="structdbuf__struct.html#ac2b15cba41a30919bd74676dc3a40840">used_size</a>+=buflen;
<a name="l03613"></a>03613 
<a name="l03614"></a>03614         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03615"></a>03615         }
<a name="l03616"></a>03616 
<a name="l03617"></a>03617 
<a name="l03618"></a>03618 
<a name="l03619"></a>03619 <span class="comment">/******************************************************************/</span>
<a name="l03620"></a>03620 <span class="comment">/******************** EMBEDDED PERL FUNCTIONS *********************/</span>
<a name="l03621"></a>03621 <span class="comment">/******************************************************************/</span>
<a name="l03622"></a>03622 
<a name="l03623"></a>03623 <span class="comment">/* initializes embedded perl interpreter */</span>
<a name="l03624"></a><a class="code" href="icinga_8h.html#a179b5c95b377aa279aa721f10509d1c4">03624</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#ab4c204e0936d72a870db17dac199f631">init_embedded_perl</a>(<span class="keywordtype">char</span> **env){
<a name="l03625"></a>03625 <span class="preprocessor">#ifdef EMBEDDEDPERL</span>
<a name="l03626"></a>03626 <span class="preprocessor"></span>        <span class="keywordtype">char</span> **embedding=NULL;
<a name="l03627"></a>03627         <span class="keywordtype">int</span> exitstatus=0;
<a name="l03628"></a>03628         <span class="keywordtype">int</span> argc=2;
<a name="l03629"></a>03629         <span class="keyword">struct </span>stat stat_buf;
<a name="l03630"></a>03630 
<a name="l03631"></a>03631         <span class="comment">/* make sure the P1 file exists... */</span>
<a name="l03632"></a>03632         <span class="keywordflow">if</span>(<a class="code" href="base_2config_8c.html#a86d006b27636dbe3bc7a35c71883f7c4">p1_file</a>==NULL || stat(<a class="code" href="base_2config_8c.html#a86d006b27636dbe3bc7a35c71883f7c4">p1_file</a>,&amp;stat_buf)!=0){
<a name="l03633"></a>03633 
<a name="l03634"></a>03634                 use_embedded_perl=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03635"></a>03635 
<a name="l03636"></a>03636                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Error: p1.pl file required for embedded Perl interpreter is missing!\n&quot;</span>);
<a name="l03637"></a>03637                 }
<a name="l03638"></a>03638 
<a name="l03639"></a>03639         <span class="keywordflow">else</span>{
<a name="l03640"></a>03640 
<a name="l03641"></a>03641                 embedding=malloc(2*<span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *));
<a name="l03642"></a>03642                 <span class="keywordflow">if</span>(embedding==NULL)
<a name="l03643"></a>03643                         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03644"></a>03644                 *embedding=strdup(<span class="stringliteral">&quot;&quot;</span>);
<a name="l03645"></a>03645                 *(embedding+1)=strdup(<a class="code" href="base_2config_8c.html#a86d006b27636dbe3bc7a35c71883f7c4">p1_file</a>);
<a name="l03646"></a>03646 
<a name="l03647"></a>03647                 use_embedded_perl=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03648"></a>03648 
<a name="l03649"></a>03649                 PERL_SYS_INIT3(&amp;argc,&amp;embedding,&amp;env);
<a name="l03650"></a>03650 
<a name="l03651"></a>03651                 <span class="keywordflow">if</span>((my_perl=perl_alloc())==NULL){
<a name="l03652"></a>03652                         use_embedded_perl=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03653"></a>03653                         <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Error: Could not allocate memory for embedded Perl interpreter!\n&quot;</span>);
<a name="l03654"></a>03654                         }
<a name="l03655"></a>03655                 }
<a name="l03656"></a>03656 
<a name="l03657"></a>03657         <span class="comment">/* a fatal error occurred... */</span>
<a name="l03658"></a>03658         <span class="keywordflow">if</span>(use_embedded_perl==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l03659"></a>03659 
<a name="l03660"></a>03660                 <a class="code" href="logging_8c.html#aa9aa4f91f0251a0461bf4c5de0b2be84">logit</a>(<a class="code" href="logging_8h.html#a22cc13d1c001b95c6c68386fe98d5b17">NSLOG_PROCESS_INFO</a> | <a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a>,<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>,<span class="stringliteral">&quot;Bailing out due to errors encountered while initializing the embedded Perl interpreter. (PID=%d)\n&quot;</span>,(<span class="keywordtype">int</span>)getpid());
<a name="l03661"></a>03661 
<a name="l03662"></a>03662                 <a class="code" href="base_2utils_8c.html#aeb94fbd457627182ceee7e505f432541">cleanup</a>();
<a name="l03663"></a>03663                 exit(<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>);
<a name="l03664"></a>03664                 }
<a name="l03665"></a>03665 
<a name="l03666"></a>03666         perl_construct(my_perl);
<a name="l03667"></a>03667         exitstatus=perl_parse(my_perl,<a class="code" href="contrib_2epn__icinga_8h.html#aef2aaaf14e8068187ff78ff55ba32043">xs_init</a>,2,(<span class="keywordtype">char</span> **)embedding,env);
<a name="l03668"></a>03668         <span class="keywordflow">if</span>(!exitstatus)
<a name="l03669"></a>03669                 exitstatus=perl_run(my_perl);
<a name="l03670"></a>03670 
<a name="l03671"></a>03671 <span class="preprocessor">#endif</span>
<a name="l03672"></a>03672 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03673"></a>03673         }
<a name="l03674"></a>03674 
<a name="l03675"></a>03675 
<a name="l03676"></a>03676 <span class="comment">/* closes embedded perl interpreter */</span>
<a name="l03677"></a><a class="code" href="icinga_8h.html#a5d9488da9bffb927386511722a9f9088">03677</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a5d9488da9bffb927386511722a9f9088">deinit_embedded_perl</a>(<span class="keywordtype">void</span>){
<a name="l03678"></a>03678 <span class="preprocessor">#ifdef EMBEDDEDPERL</span>
<a name="l03679"></a>03679 <span class="preprocessor"></span>
<a name="l03680"></a>03680         PL_perl_destruct_level=0;
<a name="l03681"></a>03681         perl_destruct(my_perl);
<a name="l03682"></a>03682         perl_free(my_perl);
<a name="l03683"></a>03683         PERL_SYS_TERM();
<a name="l03684"></a>03684 
<a name="l03685"></a>03685 <span class="preprocessor">#endif</span>
<a name="l03686"></a>03686 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03687"></a>03687         }
<a name="l03688"></a>03688 
<a name="l03689"></a>03689 
<a name="l03690"></a>03690 <span class="comment">/* checks to see if we should run a script using the embedded Perl interpreter */</span>
<a name="l03691"></a><a class="code" href="icinga_8h.html#a531dcd0f82d42a4f351408da69a5fa33">03691</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a93fc2f1f5f573f9812f65e54d8f7ed22">file_uses_embedded_perl</a>(<span class="keywordtype">char</span> *fname){
<a name="l03692"></a>03692         <span class="keywordtype">int</span> use_epn=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03693"></a>03693 <span class="preprocessor">#ifdef EMBEDDEDPERL</span>
<a name="l03694"></a>03694 <span class="preprocessor"></span>        FILE *fp=NULL;
<a name="l03695"></a>03695         <span class="keywordtype">char</span> line1[80]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l03696"></a>03696         <span class="keywordtype">char</span> linen[80]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l03697"></a>03697         <span class="keywordtype">int</span> line=0;
<a name="l03698"></a>03698         <span class="keywordtype">char</span> *ptr=NULL;
<a name="l03699"></a>03699         <span class="keywordtype">int</span> found_epn_directive=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03700"></a>03700 
<a name="l03701"></a>03701         <span class="keywordflow">if</span>(<a class="code" href="base_2config_8c.html#a46fa3066353e093f0726ffb3cf9dd151">enable_embedded_perl</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>){
<a name="l03702"></a>03702 
<a name="l03703"></a>03703                 <span class="comment">/* open the file, check if its a Perl script and see if we can use epn  */</span>
<a name="l03704"></a>03704                 fp=fopen(fname,<span class="stringliteral">&quot;r&quot;</span>);
<a name="l03705"></a>03705                 <span class="keywordflow">if</span>(fp!=NULL){
<a name="l03706"></a>03706 
<a name="l03707"></a>03707                         <span class="comment">/* grab the first line - we should see Perl */</span>
<a name="l03708"></a>03708                         fgets(line1,80,fp);
<a name="l03709"></a>03709 
<a name="l03710"></a>03710                         <span class="comment">/* yep, its a Perl script... */</span>
<a name="l03711"></a>03711                         <span class="keywordflow">if</span>(strstr(line1,<span class="stringliteral">&quot;/bin/perl&quot;</span>)!=NULL){
<a name="l03712"></a>03712 
<a name="l03713"></a>03713                                 <span class="comment">/* epn directives must be found in first ten lines of plugin */</span>
<a name="l03714"></a>03714                                 <span class="keywordflow">for</span>(line=1;line&lt;10;line++){
<a name="l03715"></a>03715 
<a name="l03716"></a>03716                                         <span class="keywordflow">if</span>(fgets(linen,80,fp)){
<a name="l03717"></a>03717 
<a name="l03718"></a>03718                                                 <span class="comment">/* line contains Icinga directives - keep Nagios compatibility */</span>
<a name="l03719"></a>03719                                                 <span class="keywordflow">if</span>(strstr(linen,<span class="stringliteral">&quot;# nagios:&quot;</span>) || strstr(linen,<span class="stringliteral">&quot;# icinga:&quot;</span>)){
<a name="l03720"></a>03720 
<a name="l03721"></a>03721                                                         ptr=strtok(linen,<span class="stringliteral">&quot;:&quot;</span>);
<a name="l03722"></a>03722 
<a name="l03723"></a>03723                                                         <span class="comment">/* process each directive */</span>
<a name="l03724"></a>03724                                                         <span class="keywordflow">for</span>(ptr=strtok(NULL,<span class="stringliteral">&quot;,&quot;</span>);ptr!=NULL;ptr=strtok(NULL,<span class="stringliteral">&quot;,&quot;</span>)){
<a name="l03725"></a>03725 
<a name="l03726"></a>03726                                                                 <a class="code" href="icingastats_8c.html#a44ed939e710ce4674954d98865b42ec0">strip</a>(ptr);
<a name="l03727"></a>03727 
<a name="l03728"></a>03728                                                                 <span class="keywordflow">if</span>(!strcmp(ptr,<span class="stringliteral">&quot;+epn&quot;</span>)){
<a name="l03729"></a>03729                                                                         use_epn=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03730"></a>03730                                                                         found_epn_directive=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03731"></a>03731                                                                         }
<a name="l03732"></a>03732                                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(ptr,<span class="stringliteral">&quot;-epn&quot;</span>)){
<a name="l03733"></a>03733                                                                         use_epn=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03734"></a>03734                                                                         found_epn_directive=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03735"></a>03735                                                                         }
<a name="l03736"></a>03736                                                                 }
<a name="l03737"></a>03737                                                         }
<a name="l03738"></a>03738 
<a name="l03739"></a>03739                                                 <span class="keywordflow">if</span>(found_epn_directive==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l03740"></a>03740                                                         <span class="keywordflow">break</span>;
<a name="l03741"></a>03741                                                 }
<a name="l03742"></a>03742 
<a name="l03743"></a>03743                                         <span class="comment">/* EOF */</span>
<a name="l03744"></a>03744                                         <span class="keywordflow">else</span>
<a name="l03745"></a>03745                                                 <span class="keywordflow">break</span>;
<a name="l03746"></a>03746                                         }
<a name="l03747"></a>03747 
<a name="l03748"></a>03748                                 <span class="comment">/* if the plugin didn&#39;t tell us whether or not to use embedded Perl, use implicit value */</span>
<a name="l03749"></a>03749                                 <span class="keywordflow">if</span>(found_epn_directive==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l03750"></a>03750                                         use_epn=(<a class="code" href="base_2config_8c.html#a422c10fc8a317232590a568d58e0562e">use_embedded_perl_implicitly</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)?<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>:<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03751"></a>03751                                 }
<a name="l03752"></a>03752 
<a name="l03753"></a>03753                         fclose(fp);
<a name="l03754"></a>03754                         }
<a name="l03755"></a>03755                 }
<a name="l03756"></a>03756 <span class="preprocessor">#endif</span>
<a name="l03757"></a>03757 <span class="preprocessor"></span>
<a name="l03758"></a>03758         <span class="keywordflow">return</span> use_epn;
<a name="l03759"></a>03759         }
<a name="l03760"></a>03760 
<a name="l03761"></a>03761 
<a name="l03762"></a>03762 
<a name="l03763"></a>03763 
<a name="l03764"></a>03764 
<a name="l03765"></a>03765 <span class="comment">/******************************************************************/</span>
<a name="l03766"></a>03766 <span class="comment">/************************ THREAD FUNCTIONS ************************/</span>
<a name="l03767"></a>03767 <span class="comment">/******************************************************************/</span>
<a name="l03768"></a>03768 
<a name="l03769"></a>03769 <span class="comment">/* initializes command file worker thread */</span>
<a name="l03770"></a><a class="code" href="icinga_8h.html#af162bb05174b7dfa3e36b4c4cc8b5693">03770</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#af162bb05174b7dfa3e36b4c4cc8b5693">init_command_file_worker_thread</a>(<span class="keywordtype">void</span>){
<a name="l03771"></a>03771         <span class="keywordtype">int</span> result=0;
<a name="l03772"></a>03772         sigset_t newmask;
<a name="l03773"></a>03773 
<a name="l03774"></a>03774         <span class="comment">/* initialize circular buffer */</span>
<a name="l03775"></a>03775         external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#aaf3f0634f22a862b21c61fda0d0c1213">head</a>=0;
<a name="l03776"></a>03776         external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#a70e489007253ad206d589474c46e1596">tail</a>=0;
<a name="l03777"></a>03777         external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#ac168ca6b9e665d6ef845e3417479033d">items</a>=0;
<a name="l03778"></a>03778         external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#a95d2fb293da7cf97b6d18809ef319eb3">high</a>=0;
<a name="l03779"></a>03779         external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#adca8087d3c41e89e947c1f933e242a47">overflow</a>=0L;
<a name="l03780"></a>03780         external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#a28b981304bf47e8faf02730071306658">buffer</a>=(<span class="keywordtype">void</span> **)malloc(<a class="code" href="commands_8c.html#aa9e89558ebe0496997935aca44cc0123">external_command_buffer_slots</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">char</span> **));
<a name="l03781"></a>03781         <span class="keywordflow">if</span>(external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#a28b981304bf47e8faf02730071306658">buffer</a>==NULL)
<a name="l03782"></a>03782                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03783"></a>03783 
<a name="l03784"></a>03784         <span class="comment">/* initialize mutex (only on cold startup) */</span>
<a name="l03785"></a>03785         <span class="keywordflow">if</span>(<a class="code" href="checks_8c.html#aadf2eea990498582cc7dac355c3d7e71">sigrestart</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l03786"></a>03786                 pthread_mutex_init(&amp;external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#a63582bbdb575ffa0fdadf1cccc737b8f">buffer_lock</a>,NULL);
<a name="l03787"></a>03787 
<a name="l03788"></a>03788         <span class="comment">/* new thread should block all signals */</span>
<a name="l03789"></a>03789         sigfillset(&amp;newmask);
<a name="l03790"></a>03790         pthread_sigmask(SIG_BLOCK,&amp;newmask,NULL);
<a name="l03791"></a>03791 
<a name="l03792"></a>03792         <span class="comment">/* create worker thread */</span>
<a name="l03793"></a>03793         result=pthread_create(&amp;<a class="code" href="checks_8c.html#a5c1a9b9ccaf872452bec541a26ab586b">worker_threads</a>[<a class="code" href="icinga_8h.html#ac17ec0c777a32375bf4313ebf4a73350">COMMAND_WORKER_THREAD</a>],NULL,<a class="code" href="base_2utils_8c.html#acd6be7bbbec8c331b78f83a9b30820d4">command_file_worker_thread</a>,NULL);
<a name="l03794"></a>03794 
<a name="l03795"></a>03795         <span class="comment">/* main thread should unblock all signals */</span>
<a name="l03796"></a>03796         pthread_sigmask(SIG_UNBLOCK,&amp;newmask,NULL);
<a name="l03797"></a>03797 
<a name="l03798"></a>03798         <span class="keywordflow">if</span>(result)
<a name="l03799"></a>03799                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l03800"></a>03800 
<a name="l03801"></a>03801         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03802"></a>03802         }
<a name="l03803"></a>03803 
<a name="l03804"></a>03804 
<a name="l03805"></a>03805 <span class="comment">/* shutdown command file worker thread */</span>
<a name="l03806"></a><a class="code" href="icinga_8h.html#a8b6387e8a78646884927fa4aad5b8e5c">03806</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a8b6387e8a78646884927fa4aad5b8e5c">shutdown_command_file_worker_thread</a>(<span class="keywordtype">void</span>){
<a name="l03807"></a>03807         <span class="keywordtype">int</span> result=0;
<a name="l03808"></a>03808 
<a name="l03809"></a>03809         <span class="comment">/* 2010-01-04 AE:</span>
<a name="l03810"></a>03810 <span class="comment">         * calling pthread_cancel(0) will cause segfaults with some</span>
<a name="l03811"></a>03811 <span class="comment">         * thread libraries. It&#39;s possible that will happen if the</span>
<a name="l03812"></a>03812 <span class="comment">         * user has a number of config files larger than the max</span>
<a name="l03813"></a>03813 <span class="comment">         * open file descriptor limit (ulimit -n) and some retarded</span>
<a name="l03814"></a>03814 <span class="comment">         * eventbroker module leaks filedescriptors, since we&#39;ll then</span>
<a name="l03815"></a>03815 <span class="comment">         * enter the cleanup() routine from main() before we&#39;ve</span>
<a name="l03816"></a>03816 <span class="comment">         * spawned any threads.</span>
<a name="l03817"></a>03817 <span class="comment">         */</span>
<a name="l03818"></a>03818         <span class="keywordflow">if</span> (<a class="code" href="checks_8c.html#a5c1a9b9ccaf872452bec541a26ab586b">worker_threads</a>[<a class="code" href="icinga_8h.html#ac17ec0c777a32375bf4313ebf4a73350">COMMAND_WORKER_THREAD</a>]) {
<a name="l03819"></a>03819                 <span class="comment">/* tell the worker thread to exit */</span>
<a name="l03820"></a>03820                 result=pthread_cancel(<a class="code" href="checks_8c.html#a5c1a9b9ccaf872452bec541a26ab586b">worker_threads</a>[COMMAND_WORKER_THREAD]);
<a name="l03821"></a>03821 
<a name="l03822"></a>03822                 <span class="comment">/* wait for the worker thread to exit */</span>
<a name="l03823"></a>03823                 <span class="keywordflow">if</span>(result==0){
<a name="l03824"></a>03824                         result=pthread_join(<a class="code" href="checks_8c.html#a5c1a9b9ccaf872452bec541a26ab586b">worker_threads</a>[COMMAND_WORKER_THREAD],NULL);
<a name="l03825"></a>03825                 }
<a name="l03826"></a>03826 
<a name="l03827"></a>03827                 <span class="comment">/* we&#39;re being called from a fork()&#39;ed child process - can&#39;t cancel thread, so just cleanup memory */</span>
<a name="l03828"></a>03828                 <span class="keywordflow">else</span> {
<a name="l03829"></a>03829                         <a class="code" href="base_2utils_8c.html#a69740a568a43f02bc8a9ca7c4b16327a">cleanup_command_file_worker_thread</a>(NULL);
<a name="l03830"></a>03830                 }
<a name="l03831"></a>03831         }
<a name="l03832"></a>03832 
<a name="l03833"></a>03833         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03834"></a>03834 }
<a name="l03835"></a>03835 
<a name="l03836"></a>03836 
<a name="l03837"></a>03837 <span class="comment">/* clean up resources used by command file worker thread */</span>
<a name="l03838"></a><a class="code" href="icinga_8h.html#a81abb6e5d22acf16a4bb1f372ac93414">03838</a> <span class="keywordtype">void</span> <a class="code" href="base_2utils_8c.html#a69740a568a43f02bc8a9ca7c4b16327a">cleanup_command_file_worker_thread</a>(<span class="keywordtype">void</span> *arg){
<a name="l03839"></a>03839         <span class="keyword">register</span> <span class="keywordtype">int</span> x=0;
<a name="l03840"></a>03840 
<a name="l03841"></a>03841         <span class="comment">/* release memory allocated to circular buffer */</span>
<a name="l03842"></a>03842         <span class="keywordflow">for</span>(x=external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#a70e489007253ad206d589474c46e1596">tail</a>;x!=external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#aaf3f0634f22a862b21c61fda0d0c1213">head</a>;x=(x+1) % <a class="code" href="commands_8c.html#aa9e89558ebe0496997935aca44cc0123">external_command_buffer_slots</a>){
<a name="l03843"></a>03843                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(((<span class="keywordtype">char</span> **)external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#a28b981304bf47e8faf02730071306658">buffer</a>)[x]);
<a name="l03844"></a>03844                 }
<a name="l03845"></a>03845         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#a28b981304bf47e8faf02730071306658">buffer</a>);
<a name="l03846"></a>03846 
<a name="l03847"></a>03847         <span class="keywordflow">return</span>;
<a name="l03848"></a>03848         }
<a name="l03849"></a>03849 
<a name="l03850"></a>03850 
<a name="l03851"></a>03851 
<a name="l03852"></a>03852 <span class="comment">/* worker thread - artificially increases buffer of named pipe */</span>
<a name="l03853"></a><a class="code" href="icinga_8h.html#ae716b575f52edc6d656ac7d113cc354f">03853</a> <span class="keywordtype">void</span> * <a class="code" href="base_2utils_8c.html#acd6be7bbbec8c331b78f83a9b30820d4">command_file_worker_thread</a>(<span class="keywordtype">void</span> *arg){
<a name="l03854"></a>03854         <span class="keywordtype">char</span> input_buffer[<a class="code" href="include_2common_8h.html#a3f77bd41e4daa95db02bcd919bf9a485">MAX_EXTERNAL_COMMAND_LENGTH</a>];
<a name="l03855"></a>03855         <span class="keyword">struct </span>pollfd pfd;
<a name="l03856"></a>03856         <span class="keywordtype">int</span> pollval;
<a name="l03857"></a>03857         <span class="keyword">struct </span>timeval tv;
<a name="l03858"></a>03858         <span class="keywordtype">int</span> buffer_items=0;
<a name="l03859"></a>03859         <span class="keywordtype">int</span> result=0;
<a name="l03860"></a>03860 
<a name="l03861"></a>03861         <span class="comment">/* specify cleanup routine */</span>
<a name="l03862"></a>03862         pthread_cleanup_push(<a class="code" href="base_2utils_8c.html#a69740a568a43f02bc8a9ca7c4b16327a">cleanup_command_file_worker_thread</a>,NULL);
<a name="l03863"></a>03863 
<a name="l03864"></a>03864         <span class="comment">/* set cancellation info */</span>
<a name="l03865"></a>03865         pthread_setcancelstate(PTHREAD_CANCEL_ENABLE,NULL);
<a name="l03866"></a>03866         pthread_setcanceltype(PTHREAD_CANCEL_DEFERRED,NULL);
<a name="l03867"></a>03867 
<a name="l03868"></a>03868         <span class="keywordflow">while</span>(1){
<a name="l03869"></a>03869 
<a name="l03870"></a>03870                 <span class="comment">/* should we shutdown? */</span>
<a name="l03871"></a>03871                 pthread_testcancel();
<a name="l03872"></a>03872 
<a name="l03873"></a>03873                 <span class="comment">/* wait for data to arrive */</span>
<a name="l03874"></a>03874                 <span class="comment">/* select seems to not work, so we have to use poll instead */</span>
<a name="l03875"></a>03875                 <span class="comment">/* 10-15-08 EG check into implementing William&#39;s patch @ http://blog.netways.de/2008/08/15/nagios-unter-mac-os-x-installieren/ */</span>
<a name="l03876"></a>03876                 <span class="comment">/* 10-15-08 EG poll() seems broken on OSX - see Jonathan&#39;s patch a few lines down */</span>
<a name="l03877"></a>03877                 pfd.fd=<a class="code" href="commands_8c.html#a8d1be59b1a087eaeb87f6e4774cb499a">command_file_fd</a>;
<a name="l03878"></a>03878                 pfd.events=POLLIN;
<a name="l03879"></a>03879                 pollval=poll(&amp;pfd,1,500);
<a name="l03880"></a>03880 
<a name="l03881"></a>03881                 <span class="comment">/* loop if no data */</span>
<a name="l03882"></a>03882                 <span class="keywordflow">if</span>(pollval==0)
<a name="l03883"></a>03883                         <span class="keywordflow">continue</span>;
<a name="l03884"></a>03884 
<a name="l03885"></a>03885                 <span class="comment">/* check for errors */</span>
<a name="l03886"></a>03886                 <span class="keywordflow">if</span>(pollval==-1){
<a name="l03887"></a>03887 
<a name="l03888"></a>03888                         <span class="keywordflow">switch</span>(<a class="code" href="base_2utils_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>){
<a name="l03889"></a>03889                         <span class="keywordflow">case</span> EBADF:
<a name="l03890"></a>03890                                 <a class="code" href="logging_8c.html#af1f5b59635809efad3814be56dfd8dd8">write_to_log</a>(<span class="stringliteral">&quot;command_file_worker_thread(): poll(): EBADF&quot;</span>,<a class="code" href="icinga_8c.html#a9abdd763db679f200dcefbfbd3d38dbf">logging_options</a>,NULL);
<a name="l03891"></a>03891                                 <span class="keywordflow">break</span>;
<a name="l03892"></a>03892                         <span class="keywordflow">case</span> ENOMEM:
<a name="l03893"></a>03893                                 <a class="code" href="logging_8c.html#af1f5b59635809efad3814be56dfd8dd8">write_to_log</a>(<span class="stringliteral">&quot;command_file_worker_thread(): poll(): ENOMEM&quot;</span>,<a class="code" href="icinga_8c.html#a9abdd763db679f200dcefbfbd3d38dbf">logging_options</a>,NULL);
<a name="l03894"></a>03894                                 <span class="keywordflow">break</span>;
<a name="l03895"></a>03895                         <span class="keywordflow">case</span> EFAULT:
<a name="l03896"></a>03896                                 <a class="code" href="logging_8c.html#af1f5b59635809efad3814be56dfd8dd8">write_to_log</a>(<span class="stringliteral">&quot;command_file_worker_thread(): poll(): EFAULT&quot;</span>,<a class="code" href="icinga_8c.html#a9abdd763db679f200dcefbfbd3d38dbf">logging_options</a>,NULL);
<a name="l03897"></a>03897                                 <span class="keywordflow">break</span>;
<a name="l03898"></a>03898                         <span class="keywordflow">case</span> EINTR:
<a name="l03899"></a>03899                                 <span class="comment">/* this can happen when running under a debugger like gdb */</span>
<a name="l03900"></a>03900                                 <span class="comment">/*</span>
<a name="l03901"></a>03901 <span class="comment">                                write_to_log(&quot;command_file_worker_thread(): poll(): EINTR (impossible)&quot;,logging_options,NULL);</span>
<a name="l03902"></a>03902 <span class="comment">                                */</span>
<a name="l03903"></a>03903                                 <span class="keywordflow">break</span>;
<a name="l03904"></a>03904                         <span class="keywordflow">default</span>:
<a name="l03905"></a>03905                                 <a class="code" href="logging_8c.html#af1f5b59635809efad3814be56dfd8dd8">write_to_log</a>(<span class="stringliteral">&quot;command_file_worker_thread(): poll(): Unknown errno value.&quot;</span>,<a class="code" href="icinga_8c.html#a9abdd763db679f200dcefbfbd3d38dbf">logging_options</a>,NULL);
<a name="l03906"></a>03906                                 <span class="keywordflow">break</span>;
<a name="l03907"></a>03907                                 }
<a name="l03908"></a>03908 
<a name="l03909"></a>03909                         <span class="keywordflow">continue</span>;
<a name="l03910"></a>03910                         }
<a name="l03911"></a>03911 
<a name="l03912"></a>03912                 <span class="comment">/* should we shutdown? */</span>
<a name="l03913"></a>03913                 pthread_testcancel();
<a name="l03914"></a>03914 
<a name="l03915"></a>03915                 <span class="comment">/* get number of items in the buffer */</span>
<a name="l03916"></a>03916                 pthread_mutex_lock(&amp;external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#a63582bbdb575ffa0fdadf1cccc737b8f">buffer_lock</a>);
<a name="l03917"></a>03917                 buffer_items=external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#ac168ca6b9e665d6ef845e3417479033d">items</a>;
<a name="l03918"></a>03918                 pthread_mutex_unlock(&amp;external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#a63582bbdb575ffa0fdadf1cccc737b8f">buffer_lock</a>);
<a name="l03919"></a>03919 
<a name="l03920"></a>03920 <span class="preprocessor">#ifdef DEBUG_CFWT</span>
<a name="l03921"></a>03921 <span class="preprocessor"></span>                printf(<span class="stringliteral">&quot;(CFWT) BUFFER ITEMS: %d/%d\n&quot;</span>,buffer_items,<a class="code" href="commands_8c.html#aa9e89558ebe0496997935aca44cc0123">external_command_buffer_slots</a>);
<a name="l03922"></a>03922 <span class="preprocessor">#endif</span>
<a name="l03923"></a>03923 <span class="preprocessor"></span>
<a name="l03924"></a>03924                 <span class="comment">/* 10-15-08 Fix for OS X by Jonathan Saggau - see http://www.jonathansaggau.com/blog/2008/09/using_shark_and_custom_dtrace.html */</span>
<a name="l03925"></a>03925                 <span class="comment">/* Not sure if this would have negative effects on other OSes... */</span>
<a name="l03926"></a>03926                 <span class="keywordflow">if</span>(buffer_items==0){
<a name="l03927"></a>03927                         <span class="comment">/* pause a bit so OS X doesn&#39;t go nuts with CPU overload */</span>
<a name="l03928"></a>03928                         tv.tv_sec=0;
<a name="l03929"></a>03929                         tv.tv_usec=500;
<a name="l03930"></a>03930                         select(0,NULL,NULL,NULL,&amp;tv);
<a name="l03931"></a>03931                         }
<a name="l03932"></a>03932 
<a name="l03933"></a>03933                 <span class="comment">/* process all commands in the file (named pipe) if there&#39;s some space in the buffer */</span>
<a name="l03934"></a>03934                 <span class="keywordflow">if</span>(buffer_items&lt;<a class="code" href="commands_8c.html#aa9e89558ebe0496997935aca44cc0123">external_command_buffer_slots</a>){
<a name="l03935"></a>03935 
<a name="l03936"></a>03936                         <span class="comment">/* clear EOF condition from prior run (FreeBSD fix) */</span>
<a name="l03937"></a>03937                         <span class="comment">/* FIXME: use_poll_on_cmd_pipe: Still needed? */</span>
<a name="l03938"></a>03938                         clearerr(<a class="code" href="commands_8c.html#a67e68b43d7661b866f04f4609dd1decf">command_file_fp</a>);
<a name="l03939"></a>03939 
<a name="l03940"></a>03940                         <span class="comment">/* read and process the next command in the file */</span>
<a name="l03941"></a>03941                         <span class="keywordflow">while</span>(fgets(input_buffer,(<span class="keywordtype">int</span>)(<span class="keyword">sizeof</span>(input_buffer)-1),<a class="code" href="commands_8c.html#a67e68b43d7661b866f04f4609dd1decf">command_file_fp</a>)!=NULL){
<a name="l03942"></a>03942 
<a name="l03943"></a>03943 <span class="preprocessor">#ifdef DEBUG_CFWT</span>
<a name="l03944"></a>03944 <span class="preprocessor"></span>                                printf(<span class="stringliteral">&quot;(CFWT) READ: %s&quot;</span>,input_buffer);
<a name="l03945"></a>03945 <span class="preprocessor">#endif</span>
<a name="l03946"></a>03946 <span class="preprocessor"></span>
<a name="l03947"></a>03947                                 <span class="comment">/* submit the external command for processing (retry if buffer is full) */</span>
<a name="l03948"></a>03948                                 <span class="keywordflow">while</span>((result=<a class="code" href="base_2utils_8c.html#afd602df3fd0760f638c347271be09092">submit_external_command</a>(input_buffer,&amp;buffer_items))==<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a> &amp;&amp; buffer_items==<a class="code" href="commands_8c.html#aa9e89558ebe0496997935aca44cc0123">external_command_buffer_slots</a>){
<a name="l03949"></a>03949 
<a name="l03950"></a>03950                                         <span class="comment">/* wait a bit */</span>
<a name="l03951"></a>03951                                         tv.tv_sec=0;
<a name="l03952"></a>03952                                         tv.tv_usec=250000;
<a name="l03953"></a>03953                                         select(0,NULL,NULL,NULL,&amp;tv);
<a name="l03954"></a>03954 
<a name="l03955"></a>03955                                         <span class="comment">/* should we shutdown? */</span>
<a name="l03956"></a>03956                                         pthread_testcancel();
<a name="l03957"></a>03957                                         }
<a name="l03958"></a>03958 
<a name="l03959"></a>03959 <span class="preprocessor">#ifdef DEBUG_CFWT</span>
<a name="l03960"></a>03960 <span class="preprocessor"></span>                                printf(<span class="stringliteral">&quot;(CFWT) RES: %d, BUFFER_ITEMS: %d/%d\n&quot;</span>,result,buffer_items,external_comand_buffer_slots);
<a name="l03961"></a>03961 <span class="preprocessor">#endif</span>
<a name="l03962"></a>03962 <span class="preprocessor"></span>
<a name="l03963"></a>03963                                 <span class="comment">/* bail if the circular buffer is full */</span>
<a name="l03964"></a>03964                                 <span class="keywordflow">if</span>(buffer_items==<a class="code" href="commands_8c.html#aa9e89558ebe0496997935aca44cc0123">external_command_buffer_slots</a>)
<a name="l03965"></a>03965                                         <span class="keywordflow">break</span>;
<a name="l03966"></a>03966 
<a name="l03967"></a>03967                                 <span class="comment">/* should we shutdown? */</span>
<a name="l03968"></a>03968                                 pthread_testcancel();
<a name="l03969"></a>03969                                 }
<a name="l03970"></a>03970                         }
<a name="l03971"></a>03971                 <span class="keywordflow">else</span> {
<a name="l03972"></a>03972                         <span class="comment">/* HB 06-07-2009:</span>
<a name="l03973"></a>03973 <span class="comment">                         * We should wait for the event queuing to catch up some commands</span>
<a name="l03974"></a>03974 <span class="comment">                         * from the buffer if for this atomic run the buffer is filled completely or</span>
<a name="l03975"></a>03975 <span class="comment">                         * is overrun</span>
<a name="l03976"></a>03976 <span class="comment">                          */</span>
<a name="l03977"></a>03977                         <span class="comment">/* wait a bit */</span>
<a name="l03978"></a>03978                         tv.tv_sec=0;
<a name="l03979"></a>03979                         tv.tv_usec=250000;
<a name="l03980"></a>03980                         select(0,NULL,NULL,NULL,&amp;tv);
<a name="l03981"></a>03981 
<a name="l03982"></a>03982                         <span class="comment">/* should we shutdown? */</span>
<a name="l03983"></a>03983                         pthread_testcancel();
<a name="l03984"></a>03984                 }
<a name="l03985"></a>03985                 }
<a name="l03986"></a>03986 
<a name="l03987"></a>03987         <span class="comment">/* removes cleanup handler - this should never be reached */</span>
<a name="l03988"></a>03988         pthread_cleanup_pop(0);
<a name="l03989"></a>03989 
<a name="l03990"></a>03990         <span class="keywordflow">return</span> NULL;
<a name="l03991"></a>03991         }
<a name="l03992"></a>03992 
<a name="l03993"></a>03993 
<a name="l03994"></a>03994 
<a name="l03995"></a>03995 <span class="comment">/* submits an external command for processing */</span>
<a name="l03996"></a><a class="code" href="icinga_8h.html#a7c7461e5c5f6e44ead43c402cf1ff6e5">03996</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#afd602df3fd0760f638c347271be09092">submit_external_command</a>(<span class="keywordtype">char</span> *cmd, <span class="keywordtype">int</span> *buffer_items){
<a name="l03997"></a>03997         <span class="keywordtype">int</span> result=<a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l03998"></a>03998 
<a name="l03999"></a>03999         <span class="keywordflow">if</span>(cmd==NULL || external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#a28b981304bf47e8faf02730071306658">buffer</a>==NULL){
<a name="l04000"></a>04000                 <span class="keywordflow">if</span>(buffer_items!=NULL)
<a name="l04001"></a>04001                         *buffer_items=-1;
<a name="l04002"></a>04002                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l04003"></a>04003                 }
<a name="l04004"></a>04004 
<a name="l04005"></a>04005         <span class="comment">/* obtain a lock for writing to the buffer */</span>
<a name="l04006"></a>04006         pthread_mutex_lock(&amp;external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#a63582bbdb575ffa0fdadf1cccc737b8f">buffer_lock</a>);
<a name="l04007"></a>04007 
<a name="l04008"></a>04008         <span class="keywordflow">if</span>(external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#ac168ca6b9e665d6ef845e3417479033d">items</a>&lt;<a class="code" href="commands_8c.html#aa9e89558ebe0496997935aca44cc0123">external_command_buffer_slots</a>){
<a name="l04009"></a>04009 
<a name="l04010"></a>04010                 <span class="comment">/* save the line in the buffer */</span>
<a name="l04011"></a>04011                 ((<span class="keywordtype">char</span> **)external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#a28b981304bf47e8faf02730071306658">buffer</a>)[external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#aaf3f0634f22a862b21c61fda0d0c1213">head</a>]=(<span class="keywordtype">char</span> *)strdup(cmd);
<a name="l04012"></a>04012 
<a name="l04013"></a>04013                 <span class="comment">/* increment the head counter and items */</span>
<a name="l04014"></a>04014                 external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#aaf3f0634f22a862b21c61fda0d0c1213">head</a>=(external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#aaf3f0634f22a862b21c61fda0d0c1213">head</a> + 1) % <a class="code" href="commands_8c.html#aa9e89558ebe0496997935aca44cc0123">external_command_buffer_slots</a>;
<a name="l04015"></a>04015                 external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#ac168ca6b9e665d6ef845e3417479033d">items</a>++;
<a name="l04016"></a>04016                 <span class="keywordflow">if</span>(external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#ac168ca6b9e665d6ef845e3417479033d">items</a>&gt;external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#a95d2fb293da7cf97b6d18809ef319eb3">high</a>)
<a name="l04017"></a>04017                         external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#a95d2fb293da7cf97b6d18809ef319eb3">high</a>=external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#ac168ca6b9e665d6ef845e3417479033d">items</a>;
<a name="l04018"></a>04018                 }
<a name="l04019"></a>04019 
<a name="l04020"></a>04020         <span class="comment">/* buffer was full */</span>
<a name="l04021"></a>04021         <span class="keywordflow">else</span>
<a name="l04022"></a>04022                 result=<a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l04023"></a>04023 
<a name="l04024"></a>04024         <span class="comment">/* return number of items now in buffer */</span>
<a name="l04025"></a>04025         <span class="keywordflow">if</span>(buffer_items!=NULL)
<a name="l04026"></a>04026                 *buffer_items=external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#ac168ca6b9e665d6ef845e3417479033d">items</a>;
<a name="l04027"></a>04027 
<a name="l04028"></a>04028         <span class="comment">/* release lock on buffer */</span>
<a name="l04029"></a>04029         pthread_mutex_unlock(&amp;external_command_buffer.<a class="code" href="structcircular__buffer__struct.html#a63582bbdb575ffa0fdadf1cccc737b8f">buffer_lock</a>);
<a name="l04030"></a>04030 
<a name="l04031"></a>04031         <span class="keywordflow">return</span> result;
<a name="l04032"></a>04032         }
<a name="l04033"></a>04033 
<a name="l04034"></a>04034 
<a name="l04035"></a>04035 
<a name="l04036"></a>04036 <span class="comment">/* submits a raw external command (without timestamp) for processing */</span>
<a name="l04037"></a><a class="code" href="icinga_8h.html#a43c564ed3733fabdb8a02d0861b8269d">04037</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#ada5ac1f7c7004f7f54cb9dc1acac49a0">submit_raw_external_command</a>(<span class="keywordtype">char</span> *cmd, time_t *ts, <span class="keywordtype">int</span> *buffer_items){
<a name="l04038"></a>04038         <span class="keywordtype">char</span> *newcmd=NULL;
<a name="l04039"></a>04039         <span class="keywordtype">int</span> result=<a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l04040"></a>04040         time_t timestamp;
<a name="l04041"></a>04041 
<a name="l04042"></a>04042         <span class="keywordflow">if</span>(cmd==NULL)
<a name="l04043"></a>04043                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l04044"></a>04044 
<a name="l04045"></a>04045         <span class="comment">/* get the time */</span>
<a name="l04046"></a>04046         <span class="keywordflow">if</span>(ts!=NULL)
<a name="l04047"></a>04047                 timestamp=*ts;
<a name="l04048"></a>04048         <span class="keywordflow">else</span>
<a name="l04049"></a>04049                 time(&amp;timestamp);
<a name="l04050"></a>04050 
<a name="l04051"></a>04051         <span class="comment">/* create the command string */</span>
<a name="l04052"></a>04052         <a class="code" href="checks_8c.html#a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</a>=<a class="code" href="snprintf_8c.html#a28a648dd20504ebc0c03623a28d82c93">asprintf</a>(&amp;newcmd,<span class="stringliteral">&quot;[%lu] %s&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)timestamp,cmd);
<a name="l04053"></a>04053 
<a name="l04054"></a>04054         <span class="comment">/* submit the command */</span>
<a name="l04055"></a>04055         result=<a class="code" href="base_2utils_8c.html#afd602df3fd0760f638c347271be09092">submit_external_command</a>(newcmd,buffer_items);
<a name="l04056"></a>04056 
<a name="l04057"></a>04057         <span class="comment">/* free allocated memory */</span>
<a name="l04058"></a>04058         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(newcmd);
<a name="l04059"></a>04059 
<a name="l04060"></a>04060         <span class="keywordflow">return</span> result;
<a name="l04061"></a>04061         }
<a name="l04062"></a>04062 
<a name="l04063"></a>04063 
<a name="l04064"></a>04064 
<a name="l04065"></a>04065 <span class="comment">/******************************************************************/</span>
<a name="l04066"></a>04066 <span class="comment">/********************** CHECK STATS FUNCTIONS *********************/</span>
<a name="l04067"></a>04067 <span class="comment">/******************************************************************/</span>
<a name="l04068"></a>04068 
<a name="l04069"></a>04069 <span class="comment">/* initialize check statistics data structures */</span>
<a name="l04070"></a><a class="code" href="icinga_8h.html#a8822fb8e42bd6606b333cf8953f38c4e">04070</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a8822fb8e42bd6606b333cf8953f38c4e">init_check_stats</a>(<span class="keywordtype">void</span>){
<a name="l04071"></a>04071         <span class="keywordtype">int</span> x=0;
<a name="l04072"></a>04072         <span class="keywordtype">int</span> y=0;
<a name="l04073"></a>04073 
<a name="l04074"></a>04074         <span class="keywordflow">for</span>(x=0;x&lt;<a class="code" href="include_2common_8h.html#aa7a5f37f784624687d6766812bc99b2e">MAX_CHECK_STATS_TYPES</a>;x++){
<a name="l04075"></a>04075                 check_statistics[x].<a class="code" href="structcheck__stats__struct.html#a3759d5844b9c43224439ce005a6f9407">current_bucket</a>=0;
<a name="l04076"></a>04076                 <span class="keywordflow">for</span>(y=0;y&lt;<a class="code" href="icinga_8h.html#a1cfa49a3f668835a2702df19182ce953">CHECK_STATS_BUCKETS</a>;y++)
<a name="l04077"></a>04077                         check_statistics[x].bucket[y]=0;
<a name="l04078"></a>04078                 check_statistics[x].<a class="code" href="structcheck__stats__struct.html#aefbc37e66ddf7bbee2807845718a5e6f">overflow_bucket</a>=0;
<a name="l04079"></a>04079                 <span class="keywordflow">for</span>(y=0;y&lt;3;y++)
<a name="l04080"></a>04080                         check_statistics[x].minute_stats[y]=0;
<a name="l04081"></a>04081                 check_statistics[x].<a class="code" href="structcheck__stats__struct.html#acfe8db349f620bf876ab49b3ee784860">last_update</a>=(time_t)0L;
<a name="l04082"></a>04082                 }
<a name="l04083"></a>04083 
<a name="l04084"></a>04084         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l04085"></a>04085         }
<a name="l04086"></a>04086 
<a name="l04087"></a>04087 
<a name="l04088"></a>04088 <span class="comment">/* records stats for a given type of check */</span>
<a name="l04089"></a><a class="code" href="icinga_8h.html#a164195ad975f9d55580ad3357598b5a9">04089</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#ac3e9d864e9a2d00cbd2b8f3cf22ea2c1">update_check_stats</a>(<span class="keywordtype">int</span> check_type, time_t check_time){
<a name="l04090"></a>04090         time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>;
<a name="l04091"></a>04091         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> minutes=0L;
<a name="l04092"></a>04092         <span class="keywordtype">int</span> new_current_bucket=0;
<a name="l04093"></a>04093         <span class="keywordtype">int</span> this_bucket=0;
<a name="l04094"></a>04094         <span class="keywordtype">int</span> x=0;
<a name="l04095"></a>04095 
<a name="l04096"></a>04096         <span class="keywordflow">if</span>(check_type&lt;0 || check_type&gt;=<a class="code" href="include_2common_8h.html#aa7a5f37f784624687d6766812bc99b2e">MAX_CHECK_STATS_TYPES</a>)
<a name="l04097"></a>04097                 <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
<a name="l04098"></a>04098 
<a name="l04099"></a>04099         time(&amp;current_time);
<a name="l04100"></a>04100 
<a name="l04101"></a>04101         <span class="keywordflow">if</span>((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)check_time==0L){
<a name="l04102"></a>04102 <span class="preprocessor">#ifdef DEBUG_CHECK_STATS</span>
<a name="l04103"></a>04103 <span class="preprocessor"></span>                printf(<span class="stringliteral">&quot;TYPE[%d] CHECK TIME==0!\n&quot;</span>,check_type);
<a name="l04104"></a>04104 <span class="preprocessor">#endif</span>
<a name="l04105"></a>04105 <span class="preprocessor"></span>                check_time=<a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>;
<a name="l04106"></a>04106                 }
<a name="l04107"></a>04107 
<a name="l04108"></a>04108         <span class="comment">/* do some sanity checks on the age of the stats data before we start... */</span>
<a name="l04109"></a>04109         <span class="comment">/* get the new current bucket number */</span>
<a name="l04110"></a>04110         minutes=((<span class="keywordtype">unsigned</span> long)check_time-(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)<a class="code" href="broker_8c.html#a2b5a4f2875a1a545f44ac2faad7a6b67">program_start</a>) / 60;
<a name="l04111"></a>04111         new_current_bucket=minutes % <a class="code" href="icinga_8h.html#a1cfa49a3f668835a2702df19182ce953">CHECK_STATS_BUCKETS</a>;
<a name="l04112"></a>04112 
<a name="l04113"></a>04113         <span class="comment">/* its been more than 15 minutes since stats were updated, so clear the stats */</span>
<a name="l04114"></a>04114         <span class="keywordflow">if</span>((((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)current_time - (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)check_statistics[check_type].last_update) / 60) &gt; <a class="code" href="icinga_8h.html#a1cfa49a3f668835a2702df19182ce953">CHECK_STATS_BUCKETS</a>){
<a name="l04115"></a>04115                 <span class="keywordflow">for</span>(x=0;x&lt;<a class="code" href="icinga_8h.html#a1cfa49a3f668835a2702df19182ce953">CHECK_STATS_BUCKETS</a>;x++)
<a name="l04116"></a>04116                         check_statistics[check_type].bucket[x]=0;
<a name="l04117"></a>04117                 check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#aefbc37e66ddf7bbee2807845718a5e6f">overflow_bucket</a>=0;
<a name="l04118"></a>04118 <span class="preprocessor">#ifdef DEBUG_CHECK_STATS</span>
<a name="l04119"></a>04119 <span class="preprocessor"></span>                printf(<span class="stringliteral">&quot;CLEARING ALL: TYPE[%d], CURRENT=%lu, LASTUPDATE=%lu\n&quot;</span>,check_type,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)current_time,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)check_statistics[check_type].last_update);
<a name="l04120"></a>04120 <span class="preprocessor">#endif</span>
<a name="l04121"></a>04121 <span class="preprocessor"></span>                }
<a name="l04122"></a>04122 
<a name="l04123"></a>04123         <span class="comment">/* different current bucket number than last time */</span>
<a name="l04124"></a>04124         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(new_current_bucket!=check_statistics[check_type].current_bucket){
<a name="l04125"></a>04125 
<a name="l04126"></a>04126                 <span class="comment">/* clear stats in buckets between last current bucket and new current bucket - stats haven&#39;t been updated in a while */</span>
<a name="l04127"></a>04127                 <span class="keywordflow">for</span>(x=check_statistics[check_type].current_bucket;x&lt;(<a class="code" href="icinga_8h.html#a1cfa49a3f668835a2702df19182ce953">CHECK_STATS_BUCKETS</a> * 2);x++){
<a name="l04128"></a>04128 
<a name="l04129"></a>04129                         this_bucket=(x + <a class="code" href="icinga_8h.html#a1cfa49a3f668835a2702df19182ce953">CHECK_STATS_BUCKETS</a> + 1) % <a class="code" href="icinga_8h.html#a1cfa49a3f668835a2702df19182ce953">CHECK_STATS_BUCKETS</a>;
<a name="l04130"></a>04130 
<a name="l04131"></a>04131                         <span class="keywordflow">if</span>(this_bucket==new_current_bucket)
<a name="l04132"></a>04132                                 <span class="keywordflow">break</span>;
<a name="l04133"></a>04133 
<a name="l04134"></a>04134 <span class="preprocessor">#ifdef DEBUG_CHECK_STATS</span>
<a name="l04135"></a>04135 <span class="preprocessor"></span>                        printf(<span class="stringliteral">&quot;CLEARING BUCKET %d, (NEW=%d, OLD=%d)\n&quot;</span>,this_bucket,new_current_bucket,check_statistics[check_type].current_bucket);
<a name="l04136"></a>04136 <span class="preprocessor">#endif</span>
<a name="l04137"></a>04137 <span class="preprocessor"></span>
<a name="l04138"></a>04138                         <span class="comment">/* clear old bucket value */</span>
<a name="l04139"></a>04139                         check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#afbed0cb44d41343f6103cfd658dd1431">bucket</a>[this_bucket]=0;
<a name="l04140"></a>04140                         }
<a name="l04141"></a>04141 
<a name="l04142"></a>04142                 <span class="comment">/* update the current bucket number, push old value to overflow bucket */</span>
<a name="l04143"></a>04143                 check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#aefbc37e66ddf7bbee2807845718a5e6f">overflow_bucket</a>=check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#afbed0cb44d41343f6103cfd658dd1431">bucket</a>[new_current_bucket];
<a name="l04144"></a>04144                 check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#a3759d5844b9c43224439ce005a6f9407">current_bucket</a>=new_current_bucket;
<a name="l04145"></a>04145                 check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#afbed0cb44d41343f6103cfd658dd1431">bucket</a>[new_current_bucket]=0;
<a name="l04146"></a>04146                 }
<a name="l04147"></a>04147 <span class="preprocessor">#ifdef DEBUG_CHECK_STATS</span>
<a name="l04148"></a>04148 <span class="preprocessor"></span>        <span class="keywordflow">else</span>
<a name="l04149"></a>04149                 printf(<span class="stringliteral">&quot;NO CLEARING NEEDED\n&quot;</span>);
<a name="l04150"></a>04150 <span class="preprocessor">#endif</span>
<a name="l04151"></a>04151 <span class="preprocessor"></span>
<a name="l04152"></a>04152 
<a name="l04153"></a>04153         <span class="comment">/* increment the value of the current bucket */</span>
<a name="l04154"></a>04154         check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#afbed0cb44d41343f6103cfd658dd1431">bucket</a>[new_current_bucket]++;
<a name="l04155"></a>04155 
<a name="l04156"></a>04156 <span class="preprocessor">#ifdef DEBUG_CHECK_STATS</span>
<a name="l04157"></a>04157 <span class="preprocessor"></span>        printf(<span class="stringliteral">&quot;TYPE[%d].BUCKET[%d]=%d\n&quot;</span>,check_type,new_current_bucket,check_statistics[check_type].bucket[new_current_bucket]);
<a name="l04158"></a>04158         printf(<span class="stringliteral">&quot;   &quot;</span>);
<a name="l04159"></a>04159         <span class="keywordflow">for</span>(x=0;x&lt;<a class="code" href="icinga_8h.html#a1cfa49a3f668835a2702df19182ce953">CHECK_STATS_BUCKETS</a>;x++)
<a name="l04160"></a>04160                 printf(<span class="stringliteral">&quot;[%d] &quot;</span>,check_statistics[check_type].bucket[x]);
<a name="l04161"></a>04161         printf(<span class="stringliteral">&quot; (%d)\n&quot;</span>,check_statistics[check_type].overflow_bucket);
<a name="l04162"></a>04162 <span class="preprocessor">#endif</span>
<a name="l04163"></a>04163 <span class="preprocessor"></span>
<a name="l04164"></a>04164         <span class="comment">/* record last update time */</span>
<a name="l04165"></a>04165         check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#acfe8db349f620bf876ab49b3ee784860">last_update</a>=<a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>;
<a name="l04166"></a>04166 
<a name="l04167"></a>04167         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l04168"></a>04168         }
<a name="l04169"></a>04169 
<a name="l04170"></a>04170 
<a name="l04171"></a>04171 <span class="comment">/* generate 1/5/15 minute stats for a given type of check */</span>
<a name="l04172"></a><a class="code" href="icinga_8h.html#a4dd95d901587cbf726aabe703deef39e">04172</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#a4dd95d901587cbf726aabe703deef39e">generate_check_stats</a>(<span class="keywordtype">void</span>){
<a name="l04173"></a>04173         time_t <a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>;
<a name="l04174"></a>04174         <span class="keywordtype">int</span> x=0;
<a name="l04175"></a>04175         <span class="keywordtype">int</span> new_current_bucket=0;
<a name="l04176"></a>04176         <span class="keywordtype">int</span> this_bucket=0;
<a name="l04177"></a>04177         <span class="keywordtype">int</span> last_bucket=0;
<a name="l04178"></a>04178         <span class="keywordtype">int</span> this_bucket_value=0;
<a name="l04179"></a>04179         <span class="keywordtype">int</span> last_bucket_value=0;
<a name="l04180"></a>04180         <span class="keywordtype">int</span> bucket_value=0;
<a name="l04181"></a>04181         <span class="keywordtype">int</span> seconds=0;
<a name="l04182"></a>04182         <span class="keywordtype">int</span> minutes=0;
<a name="l04183"></a>04183         <span class="keywordtype">int</span> check_type=0;
<a name="l04184"></a>04184         <span class="keywordtype">float</span> this_bucket_weight=0.0;
<a name="l04185"></a>04185         <span class="keywordtype">float</span> last_bucket_weight=0.0;
<a name="l04186"></a>04186         <span class="keywordtype">int</span> left_value=0;
<a name="l04187"></a>04187         <span class="keywordtype">int</span> right_value=0;
<a name="l04188"></a>04188 
<a name="l04189"></a>04189 
<a name="l04190"></a>04190         time(&amp;current_time);
<a name="l04191"></a>04191 
<a name="l04192"></a>04192         <span class="comment">/* do some sanity checks on the age of the stats data before we start... */</span>
<a name="l04193"></a>04193         <span class="comment">/* get the new current bucket number */</span>
<a name="l04194"></a>04194         minutes=((<span class="keywordtype">unsigned</span> long)current_time-(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)<a class="code" href="broker_8c.html#a2b5a4f2875a1a545f44ac2faad7a6b67">program_start</a>) / 60;
<a name="l04195"></a>04195         new_current_bucket=minutes % <a class="code" href="icinga_8h.html#a1cfa49a3f668835a2702df19182ce953">CHECK_STATS_BUCKETS</a>;
<a name="l04196"></a>04196         <span class="keywordflow">for</span>(check_type=0;check_type&lt;<a class="code" href="include_2common_8h.html#aa7a5f37f784624687d6766812bc99b2e">MAX_CHECK_STATS_TYPES</a>;check_type++){
<a name="l04197"></a>04197 
<a name="l04198"></a>04198                 <span class="comment">/* its been more than 15 minutes since stats were updated, so clear the stats */</span>
<a name="l04199"></a>04199                 <span class="keywordflow">if</span>((((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)current_time - (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)check_statistics[check_type].last_update) / 60) &gt; <a class="code" href="icinga_8h.html#a1cfa49a3f668835a2702df19182ce953">CHECK_STATS_BUCKETS</a>){
<a name="l04200"></a>04200                         <span class="keywordflow">for</span>(x=0;x&lt;<a class="code" href="icinga_8h.html#a1cfa49a3f668835a2702df19182ce953">CHECK_STATS_BUCKETS</a>;x++)
<a name="l04201"></a>04201                                 check_statistics[check_type].bucket[x]=0;
<a name="l04202"></a>04202                         check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#aefbc37e66ddf7bbee2807845718a5e6f">overflow_bucket</a>=0;
<a name="l04203"></a>04203 <span class="preprocessor">#ifdef DEBUG_CHECK_STATS</span>
<a name="l04204"></a>04204 <span class="preprocessor"></span>                        printf(<span class="stringliteral">&quot;GEN CLEARING ALL: TYPE[%d], CURRENT=%lu, LASTUPDATE=%lu\n&quot;</span>,check_type,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)current_time,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)check_statistics[check_type].last_update);
<a name="l04205"></a>04205 <span class="preprocessor">#endif</span>
<a name="l04206"></a>04206 <span class="preprocessor"></span>                        }
<a name="l04207"></a>04207 
<a name="l04208"></a>04208                 <span class="comment">/* different current bucket number than last time */</span>
<a name="l04209"></a>04209                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(new_current_bucket!=check_statistics[check_type].current_bucket){
<a name="l04210"></a>04210 
<a name="l04211"></a>04211                         <span class="comment">/* clear stats in buckets between last current bucket and new current bucket - stats haven&#39;t been updated in a while */</span>
<a name="l04212"></a>04212                         <span class="keywordflow">for</span>(x=check_statistics[check_type].current_bucket;x&lt;(<a class="code" href="icinga_8h.html#a1cfa49a3f668835a2702df19182ce953">CHECK_STATS_BUCKETS</a>*2);x++){
<a name="l04213"></a>04213 
<a name="l04214"></a>04214                                 this_bucket=(x + <a class="code" href="icinga_8h.html#a1cfa49a3f668835a2702df19182ce953">CHECK_STATS_BUCKETS</a> + 1) % <a class="code" href="icinga_8h.html#a1cfa49a3f668835a2702df19182ce953">CHECK_STATS_BUCKETS</a>;
<a name="l04215"></a>04215 
<a name="l04216"></a>04216                                 <span class="keywordflow">if</span>(this_bucket==new_current_bucket)
<a name="l04217"></a>04217                                         <span class="keywordflow">break</span>;
<a name="l04218"></a>04218 
<a name="l04219"></a>04219 <span class="preprocessor">#ifdef DEBUG_CHECK_STATS</span>
<a name="l04220"></a>04220 <span class="preprocessor"></span>                                printf(<span class="stringliteral">&quot;GEN CLEARING BUCKET %d, (NEW=%d, OLD=%d), CURRENT=%lu, LASTUPDATE=%lu\n&quot;</span>,this_bucket,new_current_bucket,check_statistics[check_type].current_bucket,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)current_time,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)check_statistics[check_type].last_update);
<a name="l04221"></a>04221 <span class="preprocessor">#endif</span>
<a name="l04222"></a>04222 <span class="preprocessor"></span>
<a name="l04223"></a>04223                                 <span class="comment">/* clear old bucket value */</span>
<a name="l04224"></a>04224                                 check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#afbed0cb44d41343f6103cfd658dd1431">bucket</a>[this_bucket]=0;
<a name="l04225"></a>04225                                 }
<a name="l04226"></a>04226 
<a name="l04227"></a>04227                         <span class="comment">/* update the current bucket number, push old value to overflow bucket */</span>
<a name="l04228"></a>04228                         check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#aefbc37e66ddf7bbee2807845718a5e6f">overflow_bucket</a>=check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#afbed0cb44d41343f6103cfd658dd1431">bucket</a>[new_current_bucket];
<a name="l04229"></a>04229                         check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#a3759d5844b9c43224439ce005a6f9407">current_bucket</a>=new_current_bucket;
<a name="l04230"></a>04230                         check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#afbed0cb44d41343f6103cfd658dd1431">bucket</a>[new_current_bucket]=0;
<a name="l04231"></a>04231                         }
<a name="l04232"></a>04232 <span class="preprocessor">#ifdef DEBUG_CHECK_STATS</span>
<a name="l04233"></a>04233 <span class="preprocessor"></span>                <span class="keywordflow">else</span>
<a name="l04234"></a>04234                         printf(<span class="stringliteral">&quot;GEN NO CLEARING NEEDED: TYPE[%d], CURRENT=%lu, LASTUPDATE=%lu\n&quot;</span>,check_type,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)current_time,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)check_statistics[check_type].last_update);
<a name="l04235"></a>04235 <span class="preprocessor">#endif</span>
<a name="l04236"></a>04236 <span class="preprocessor"></span>
<a name="l04237"></a>04237                 <span class="comment">/* update last check time */</span>
<a name="l04238"></a>04238                 check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#acfe8db349f620bf876ab49b3ee784860">last_update</a>=<a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>;
<a name="l04239"></a>04239                 }
<a name="l04240"></a>04240 
<a name="l04241"></a>04241         <span class="comment">/* determine weights to use for this/last buckets */</span>
<a name="l04242"></a>04242         seconds=((<span class="keywordtype">unsigned</span> long)current_time-(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)<a class="code" href="broker_8c.html#a2b5a4f2875a1a545f44ac2faad7a6b67">program_start</a>) % 60;
<a name="l04243"></a>04243         this_bucket_weight=(seconds/60.0);
<a name="l04244"></a>04244         last_bucket_weight=((60-seconds)/60.0);
<a name="l04245"></a>04245 
<a name="l04246"></a>04246         <span class="comment">/* update statistics for all check types */</span>
<a name="l04247"></a>04247         <span class="keywordflow">for</span>(check_type=0;check_type&lt;<a class="code" href="include_2common_8h.html#aa7a5f37f784624687d6766812bc99b2e">MAX_CHECK_STATS_TYPES</a>;check_type++){
<a name="l04248"></a>04248 
<a name="l04249"></a>04249                 <span class="comment">/* clear the old statistics */</span>
<a name="l04250"></a>04250                 <span class="keywordflow">for</span>(x=0;x&lt;3;x++)
<a name="l04251"></a>04251                         check_statistics[check_type].minute_stats[x]=0;
<a name="l04252"></a>04252 
<a name="l04253"></a>04253                 <span class="comment">/* loop through each bucket */</span>
<a name="l04254"></a>04254                 <span class="keywordflow">for</span>(x=0;x&lt;<a class="code" href="icinga_8h.html#a1cfa49a3f668835a2702df19182ce953">CHECK_STATS_BUCKETS</a>;x++){
<a name="l04255"></a>04255 
<a name="l04256"></a>04256                         <span class="comment">/* which buckets should we use for this/last bucket? */</span>
<a name="l04257"></a>04257                         this_bucket=(check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#a3759d5844b9c43224439ce005a6f9407">current_bucket</a> + CHECK_STATS_BUCKETS - x) % CHECK_STATS_BUCKETS;
<a name="l04258"></a>04258                         last_bucket=(this_bucket + CHECK_STATS_BUCKETS - 1) % CHECK_STATS_BUCKETS;
<a name="l04259"></a>04259 
<a name="l04260"></a>04260                         <span class="comment">/* raw/unweighted value for this bucket */</span>
<a name="l04261"></a>04261                         this_bucket_value=check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#afbed0cb44d41343f6103cfd658dd1431">bucket</a>[this_bucket];
<a name="l04262"></a>04262 
<a name="l04263"></a>04263                         <span class="comment">/* raw/unweighted value for last bucket - use overflow bucket if last bucket is current bucket */</span>
<a name="l04264"></a>04264                         <span class="keywordflow">if</span>(last_bucket==check_statistics[check_type].current_bucket)
<a name="l04265"></a>04265                                 last_bucket_value=check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#aefbc37e66ddf7bbee2807845718a5e6f">overflow_bucket</a>;
<a name="l04266"></a>04266                         <span class="keywordflow">else</span>
<a name="l04267"></a>04267                                 last_bucket_value=check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#afbed0cb44d41343f6103cfd658dd1431">bucket</a>[last_bucket];
<a name="l04268"></a>04268 
<a name="l04269"></a>04269                         <span class="comment">/* determine value by weighting this/last buckets... */</span>
<a name="l04270"></a>04270                         <span class="comment">/* if this is the current bucket, use its full value + weighted % of last bucket */</span>
<a name="l04271"></a>04271                         <span class="keywordflow">if</span>(x==0){
<a name="l04272"></a>04272                                 right_value=this_bucket_value;
<a name="l04273"></a>04273                                 left_value=(int)floor(last_bucket_value * last_bucket_weight);
<a name="l04274"></a>04274                                 bucket_value=(int)(this_bucket_value + floor(last_bucket_value * last_bucket_weight));
<a name="l04275"></a>04275                                 }
<a name="l04276"></a>04276                         <span class="comment">/* otherwise use weighted % of this and last bucket */</span>
<a name="l04277"></a>04277                         <span class="keywordflow">else</span>{
<a name="l04278"></a>04278                                 right_value=(int)ceil(this_bucket_value * this_bucket_weight);
<a name="l04279"></a>04279                                 left_value=(int)floor(last_bucket_value * last_bucket_weight);
<a name="l04280"></a>04280                                 bucket_value=(int)(ceil(this_bucket_value * this_bucket_weight) + floor(last_bucket_value * last_bucket_weight));
<a name="l04281"></a>04281                                 }
<a name="l04282"></a>04282 
<a name="l04283"></a>04283                         <span class="comment">/* 1 minute stats */</span>
<a name="l04284"></a>04284                         <span class="keywordflow">if</span>(x==0)
<a name="l04285"></a>04285                                 check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#aee27c8b499cce834ae70644d887bcd2a">minute_stats</a>[0]=bucket_value;
<a name="l04286"></a>04286 
<a name="l04287"></a>04287                         <span class="comment">/* 5 minute stats */</span>
<a name="l04288"></a>04288                         <span class="keywordflow">if</span>(x&lt;5)
<a name="l04289"></a>04289                                 check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#aee27c8b499cce834ae70644d887bcd2a">minute_stats</a>[1]+=bucket_value;
<a name="l04290"></a>04290 
<a name="l04291"></a>04291                         <span class="comment">/* 15 minute stats */</span>
<a name="l04292"></a>04292                         <span class="keywordflow">if</span>(x&lt;15)
<a name="l04293"></a>04293                                 check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#aee27c8b499cce834ae70644d887bcd2a">minute_stats</a>[2]+=bucket_value;
<a name="l04294"></a>04294 
<a name="l04295"></a>04295 <span class="preprocessor">#ifdef DEBUG_CHECK_STATS2</span>
<a name="l04296"></a>04296 <span class="preprocessor"></span>                        printf(<span class="stringliteral">&quot;X=%d, THIS[%d]=%d, LAST[%d]=%d, 1/5/15=%d,%d,%d  L=%d R=%d\n&quot;</span>,x,this_bucket,this_bucket_value,last_bucket,last_bucket_value,check_statistics[check_type].minute_stats[0],check_statistics[check_type].minute_stats[1],check_statistics[check_type].minute_stats[2],left_value,right_value);
<a name="l04297"></a>04297 <span class="preprocessor">#endif</span>
<a name="l04298"></a>04298 <span class="preprocessor"></span>                        <span class="comment">/* record last update time */</span>
<a name="l04299"></a>04299                         check_statistics[check_type].<a class="code" href="structcheck__stats__struct.html#acfe8db349f620bf876ab49b3ee784860">last_update</a>=<a class="code" href="status_8c.html#ab1938d5563a4d7b5ef9b9f74a685508b">current_time</a>;
<a name="l04300"></a>04300                         }
<a name="l04301"></a>04301 
<a name="l04302"></a>04302 <span class="preprocessor">#ifdef DEBUG_CHECK_STATS</span>
<a name="l04303"></a>04303 <span class="preprocessor"></span>                printf(<span class="stringliteral">&quot;TYPE[%d]   1/5/15 = %d, %d, %d (seconds=%d, this_weight=%f, last_weight=%f)\n&quot;</span>,check_type,check_statistics[check_type].minute_stats[0],check_statistics[check_type].minute_stats[1],check_statistics[check_type].minute_stats[2],seconds,this_bucket_weight,last_bucket_weight);
<a name="l04304"></a>04304 <span class="preprocessor">#endif</span>
<a name="l04305"></a>04305 <span class="preprocessor"></span>                }
<a name="l04306"></a>04306 
<a name="l04307"></a>04307         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l04308"></a>04308         }
<a name="l04309"></a>04309 
<a name="l04310"></a>04310 
<a name="l04311"></a>04311 <span class="comment">/******************************************************************/</span>
<a name="l04312"></a>04312 <span class="comment">/************************* MISC FUNCTIONS *************************/</span>
<a name="l04313"></a>04313 <span class="comment">/******************************************************************/</span>
<a name="l04314"></a>04314 
<a name="l04315"></a>04315 <span class="comment">/* returns Icinga version */</span>
<a name="l04316"></a><a class="code" href="icinga_8h.html#ade8ccff1909f57e46466b88c3c3b2049">04316</a> <span class="keywordtype">char</span> *<a class="code" href="base_2utils_8c.html#ade8ccff1909f57e46466b88c3c3b2049">get_program_version</a>(<span class="keywordtype">void</span>){
<a name="l04317"></a>04317 
<a name="l04318"></a>04318         <span class="keywordflow">return</span> (<span class="keywordtype">char</span> *)<a class="code" href="include_2common_8h.html#a2f10abd650e471fae2d7e8c63d41206a">PROGRAM_VERSION</a>;
<a name="l04319"></a>04319         }
<a name="l04320"></a>04320 
<a name="l04321"></a>04321 
<a name="l04322"></a>04322 <span class="comment">/* returns Icinga modification date */</span>
<a name="l04323"></a><a class="code" href="icinga_8h.html#aef14f091b53abfe102f4cd000b848294">04323</a> <span class="keywordtype">char</span> *<a class="code" href="base_2utils_8c.html#aef14f091b53abfe102f4cd000b848294">get_program_modification_date</a>(<span class="keywordtype">void</span>){
<a name="l04324"></a>04324 
<a name="l04325"></a>04325         <span class="keywordflow">return</span> (<span class="keywordtype">char</span> *)<a class="code" href="include_2common_8h.html#a8ecb9b224327942e4a81a43d05b0f36e">PROGRAM_MODIFICATION_DATE</a>;
<a name="l04326"></a>04326         }
<a name="l04327"></a>04327 
<a name="l04328"></a><a class="code" href="icinga_8h.html#a3f6b6392805dafc9b02570d4adcf51f6">04328</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#aed22a9c033532de4a6b649d24d8705b8">has_shell_metachars</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *s){
<a name="l04329"></a>04329         <span class="keywordflow">if</span> (strpbrk(s,<span class="stringliteral">&quot;!$^&amp;*()~[]\\|{};&lt;&gt;?&#39;\&quot;&quot;</span>))
<a name="l04330"></a>04330                 <span class="keywordflow">return</span> 1;
<a name="l04331"></a>04331         <span class="keywordflow">else</span>
<a name="l04332"></a>04332                 <span class="keywordflow">return</span> 0;
<a name="l04333"></a>04333 }
<a name="l04334"></a>04334 
<a name="l04335"></a>04335 
<a name="l04336"></a>04336 <span class="comment">/******************************************************************/</span>
<a name="l04337"></a>04337 <span class="comment">/*********************** CLEANUP FUNCTIONS ************************/</span>
<a name="l04338"></a>04338 <span class="comment">/******************************************************************/</span>
<a name="l04339"></a>04339 
<a name="l04340"></a>04340 <span class="comment">/* do some cleanup before we exit */</span>
<a name="l04341"></a><a class="code" href="icinga_8h.html#aeb94fbd457627182ceee7e505f432541">04341</a> <span class="keywordtype">void</span> <a class="code" href="base_2utils_8c.html#aeb94fbd457627182ceee7e505f432541">cleanup</a>(<span class="keywordtype">void</span>){
<a name="l04342"></a>04342 
<a name="l04343"></a>04343 <span class="preprocessor">#ifdef USE_EVENT_BROKER</span>
<a name="l04344"></a>04344 <span class="preprocessor"></span>        <span class="comment">/* unload modules */</span>
<a name="l04345"></a>04345         <span class="keywordflow">if</span>(<a class="code" href="base_2config_8c.html#a9c463c3c30ed1c48affd9a99a07c6302">test_scheduling</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> &amp;&amp; <a class="code" href="base_2config_8c.html#a041664757d19a243c37d44f2a7f5b833">verify_config</a>==<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>){
<a name="l04346"></a>04346                 <a class="code" href="nebmods_8h.html#aa351bd993e1a94631b29a0296d667e5c">neb_free_callback_list</a>();
<a name="l04347"></a>04347                 <a class="code" href="nebmods_8h.html#aac1b1f9bd266185d0ab10eb818567879">neb_unload_all_modules</a>(<a class="code" href="nebmodules_8h.html#a73a9d217a373648b15965e1a54c6923e">NEBMODULE_FORCE_UNLOAD</a>,(<a class="code" href="checks_8c.html#a2b5f7762caad7a548645f2d9c4cdee47">sigshutdown</a>==<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)?<a class="code" href="nebmodules_8h.html#ae6367105187f4bef161a229eafa8c96a">NEBMODULE_NEB_SHUTDOWN</a>:<a class="code" href="nebmodules_8h.html#ace2746f0691b85103ffeeb841e358767">NEBMODULE_NEB_RESTART</a>);
<a name="l04348"></a>04348                 <a class="code" href="nebmods_8h.html#a8f9182eb1118f06658a999bb212b0c09">neb_free_module_list</a>();
<a name="l04349"></a>04349                 <a class="code" href="nebmods_8h.html#a1fb935065d971fbcaef01cabfa5a932b">neb_deinit_modules</a>();
<a name="l04350"></a>04350                 }
<a name="l04351"></a>04351 <span class="preprocessor">#endif</span>
<a name="l04352"></a>04352 <span class="preprocessor"></span>
<a name="l04353"></a>04353         <span class="comment">/* free all allocated memory - including macros */</span>
<a name="l04354"></a>04354         <a class="code" href="base_2utils_8c.html#ae49e5228711e021ca4ea8da8e4d2f447">free_memory</a>(<a class="code" href="macros_8c.html#ab140ad54ce6173c73864a7b1da8c68fe">get_global_macros</a>());
<a name="l04355"></a>04355 
<a name="l04356"></a>04356         <span class="keywordflow">return</span>;
<a name="l04357"></a>04357         }
<a name="l04358"></a>04358 
<a name="l04359"></a>04359 
<a name="l04360"></a>04360 <span class="comment">/* free the memory allocated to the linked lists */</span>
<a name="l04361"></a><a class="code" href="icinga_8h.html#ae49e5228711e021ca4ea8da8e4d2f447">04361</a> <span class="keywordtype">void</span> <a class="code" href="base_2utils_8c.html#ae49e5228711e021ca4ea8da8e4d2f447">free_memory</a>(<a class="code" href="structicinga__macros.html">icinga_macros</a> *mac){
<a name="l04362"></a>04362         <a class="code" href="structtimed__event__struct.html">timed_event</a> *this_event=NULL;
<a name="l04363"></a>04363         <a class="code" href="structtimed__event__struct.html">timed_event</a> *next_event=NULL;
<a name="l04364"></a>04364 
<a name="l04365"></a>04365         <span class="comment">/* free all allocated memory for the object definitions */</span>
<a name="l04366"></a>04366         <a class="code" href="objects_8c.html#af2ba8f99f76463ff1dff5c1571117f07">free_object_data</a>();
<a name="l04367"></a>04367 
<a name="l04368"></a>04368         <span class="comment">/* free memory allocated to comments */</span>
<a name="l04369"></a>04369         <a class="code" href="comments_8c.html#a37577a9b0b1fdb420bd5a2a84f0995f7">free_comment_data</a>();
<a name="l04370"></a>04370 
<a name="l04371"></a>04371         <span class="comment">/* free check result list */</span>
<a name="l04372"></a>04372         <a class="code" href="base_2utils_8c.html#a5e94c626a547114bc50ad15269e0b561">free_check_result_list</a>();
<a name="l04373"></a>04373 
<a name="l04374"></a>04374         <span class="comment">/* free memory for the high priority event list */</span>
<a name="l04375"></a>04375         this_event=<a class="code" href="events_8c.html#aa5e8cad8fba97edbd96b5464e32cc752">event_list_high</a>;
<a name="l04376"></a>04376         <span class="keywordflow">while</span>(this_event!=NULL){
<a name="l04377"></a>04377                 next_event=this_event-&gt;<a class="code" href="structtimed__event__struct.html#a8a7e9def5bccc2d9df958f027d62e5a9">next</a>;
<a name="l04378"></a>04378                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(this_event);
<a name="l04379"></a>04379                 this_event=next_event;
<a name="l04380"></a>04380                 }
<a name="l04381"></a>04381 
<a name="l04382"></a>04382         <span class="comment">/* reset the event pointer */</span>
<a name="l04383"></a>04383         event_list_high=NULL;
<a name="l04384"></a>04384 
<a name="l04385"></a>04385         <span class="comment">/* free memory for the low priority event list */</span>
<a name="l04386"></a>04386         this_event=<a class="code" href="checks_8c.html#a5fc3341e76625e95ab611a9f9237b839">event_list_low</a>;
<a name="l04387"></a>04387         <span class="keywordflow">while</span>(this_event!=NULL){
<a name="l04388"></a>04388                 next_event=this_event-&gt;<a class="code" href="structtimed__event__struct.html#a8a7e9def5bccc2d9df958f027d62e5a9">next</a>;
<a name="l04389"></a>04389                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(this_event);
<a name="l04390"></a>04390                 this_event=next_event;
<a name="l04391"></a>04391                 }
<a name="l04392"></a>04392 
<a name="l04393"></a>04393         <span class="comment">/* reset the event pointer */</span>
<a name="l04394"></a>04394         event_list_low=NULL;
<a name="l04395"></a>04395 
<a name="l04396"></a>04396         <span class="comment">/* free memory for global event handlers */</span>
<a name="l04397"></a>04397         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(<a class="code" href="broker_8c.html#a2cd88e2da654d6d1d2c52e79d0174109">global_host_event_handler</a>);
<a name="l04398"></a>04398         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(<a class="code" href="broker_8c.html#a0073f89db72fa9c3474b5a1327382784">global_service_event_handler</a>);
<a name="l04399"></a>04399 
<a name="l04400"></a>04400         <span class="comment">/* free any notification list that may have been overlooked */</span>
<a name="l04401"></a>04401         <a class="code" href="base_2utils_8c.html#a9223b768ca14c73cb9a24dac17b796c2">free_notification_list</a>();
<a name="l04402"></a>04402 
<a name="l04403"></a>04403         <span class="comment">/* free obsessive compulsive commands */</span>
<a name="l04404"></a>04404         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(<a class="code" href="base_2config_8c.html#a00f19e2546f0f60b11d12685571c3184">ocsp_command</a>);
<a name="l04405"></a>04405         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(<a class="code" href="base_2config_8c.html#a2941a8b9d15b20828dbc065543e6854a">ochp_command</a>);
<a name="l04406"></a>04406 
<a name="l04407"></a>04407         <span class="comment">/*</span>
<a name="l04408"></a>04408 <span class="comment">         * free memory associated with macros.</span>
<a name="l04409"></a>04409 <span class="comment">         * It&#39;s ok to only free the volatile ones, as the non-volatile</span>
<a name="l04410"></a>04410 <span class="comment">         * are always free()&#39;d before assignment if they&#39;re set.</span>
<a name="l04411"></a>04411 <span class="comment">         * Doing a full free of them here means we&#39;ll wipe the constant</span>
<a name="l04412"></a>04412 <span class="comment">         * macros when we get a reload or restart request through the</span>
<a name="l04413"></a>04413 <span class="comment">         * command pipe, or when we receive a SIGHUP.</span>
<a name="l04414"></a>04414 <span class="comment">         */</span>
<a name="l04415"></a>04415         <a class="code" href="macros_8c.html#a447a756f699af137cdd85eb4caa4d0e5">clear_volatile_macros_r</a>(mac);
<a name="l04416"></a>04416 
<a name="l04417"></a>04417         <a class="code" href="macros_8c.html#a7ba8bfba8bf2a699ddd337be341d18fe">free_macrox_names</a>();
<a name="l04418"></a>04418 
<a name="l04419"></a>04419         <span class="comment">/* free illegal char strings */</span>
<a name="l04420"></a>04420         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(<a class="code" href="base_2config_8c.html#a21ee8da3605317fd63a1b2dca3f3fd22">illegal_object_chars</a>);
<a name="l04421"></a>04421         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(<a class="code" href="base_2config_8c.html#a3ed671a447fc4befbc9264eec6a929bf">illegal_output_chars</a>);
<a name="l04422"></a>04422 
<a name="l04423"></a>04423         <span class="comment">/* free Icinga user and group */</span>
<a name="l04424"></a>04424         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(<a class="code" href="base_2config_8c.html#a05cfb9b76ef2434c8e0ccf88207999a6">nagios_user</a>);
<a name="l04425"></a>04425         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(<a class="code" href="base_2config_8c.html#a18f68ce260b08820f7b519437e84beb4">nagios_group</a>);
<a name="l04426"></a>04426 
<a name="l04427"></a>04427         <span class="comment">/* free file/path variables */</span>
<a name="l04428"></a>04428         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(<a class="code" href="commands_8c.html#abb31cd37c986dc4fd87305ea83516af1">log_file</a>);
<a name="l04429"></a>04429         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(<a class="code" href="base_2config_8c.html#a4dd633413e09f17ee505abe8699254da">debug_file</a>);
<a name="l04430"></a>04430         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(<a class="code" href="checks_8c.html#af9f03269d81f06c6a86926e77620eed4">temp_file</a>);
<a name="l04431"></a>04431         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(<a class="code" href="checks_8c.html#ac633a7a52422f2b1d56ed02a56dc8fcf">temp_path</a>);
<a name="l04432"></a>04432         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(<a class="code" href="checks_8c.html#a3964b0cff6f7740b1f35a62ba0ef0d6a">check_result_path</a>);
<a name="l04433"></a>04433         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(<a class="code" href="commands_8c.html#ad6bb81fae52e357701eadd493eca7902">command_file</a>);
<a name="l04434"></a>04434         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(<a class="code" href="base_2config_8c.html#a55d7cb41b1bacf3965ecc3592b0502fa">lock_file</a>);
<a name="l04435"></a>04435         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(<a class="code" href="base_2config_8c.html#a586e23a923f9be00036075adc1134a3a">auth_file</a>);
<a name="l04436"></a>04436         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(<a class="code" href="base_2config_8c.html#a86d006b27636dbe3bc7a35c71883f7c4">p1_file</a>);
<a name="l04437"></a>04437         <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(<a class="code" href="base_2config_8c.html#a0cc0c09d24937cc9202b164b490bc8ef">log_archive_path</a>);
<a name="l04438"></a>04438 
<a name="l04439"></a>04439         <span class="keywordflow">return</span>;
<a name="l04440"></a>04440 }
<a name="l04441"></a>04441 
<a name="l04442"></a>04442 
<a name="l04443"></a>04443 <span class="comment">/* free a notification list that was created */</span>
<a name="l04444"></a><a class="code" href="icinga_8h.html#a9223b768ca14c73cb9a24dac17b796c2">04444</a> <span class="keywordtype">void</span> <a class="code" href="base_2utils_8c.html#a9223b768ca14c73cb9a24dac17b796c2">free_notification_list</a>(<span class="keywordtype">void</span>){
<a name="l04445"></a>04445         <a class="code" href="structnotify__list__struct.html">notification</a> *temp_notification=NULL;
<a name="l04446"></a>04446         <a class="code" href="structnotify__list__struct.html">notification</a> *next_notification=NULL;
<a name="l04447"></a>04447 
<a name="l04448"></a>04448         temp_notification=<a class="code" href="base_2config_8c.html#a78c463e6f4c8735520d6819b2aa21a5b">notification_list</a>;
<a name="l04449"></a>04449         <span class="keywordflow">while</span>(temp_notification!=NULL){
<a name="l04450"></a>04450                 next_notification=temp_notification-&gt;<a class="code" href="structnotify__list__struct.html#a9c1dd87d1331ed6ee43958fad3a36ae2">next</a>;
<a name="l04451"></a>04451                 <a class="code" href="include_2common_8h.html#a9b12a99aae3efc49af9be50afc17b526">my_free</a>(temp_notification);
<a name="l04452"></a>04452                 temp_notification=next_notification;
<a name="l04453"></a>04453                 }
<a name="l04454"></a>04454 
<a name="l04455"></a>04455         <span class="comment">/* reset notification list pointer */</span>
<a name="l04456"></a>04456         notification_list=NULL;
<a name="l04457"></a>04457 
<a name="l04458"></a>04458         <span class="keywordflow">return</span>;
<a name="l04459"></a>04459         }
<a name="l04460"></a>04460 
<a name="l04461"></a>04461 
<a name="l04462"></a>04462 <span class="comment">/* reset all system-wide variables, so when we&#39;ve receive a SIGHUP we can restart cleanly */</span>
<a name="l04463"></a><a class="code" href="icinga_8h.html#ae40e82b5d069d689fdbae2f35970d0a7">04463</a> <span class="keywordtype">int</span> <a class="code" href="base_2utils_8c.html#ae40e82b5d069d689fdbae2f35970d0a7">reset_variables</a>(<span class="keywordtype">void</span>){
<a name="l04464"></a>04464 
<a name="l04465"></a>04465         <a class="code" href="commands_8c.html#abb31cd37c986dc4fd87305ea83516af1">log_file</a>=(<span class="keywordtype">char</span> *)strdup(<a class="code" href="locations_8h.html#a2ecbb6b97620287d0a619efd366a2b46">DEFAULT_LOG_FILE</a>);
<a name="l04466"></a>04466         <a class="code" href="checks_8c.html#af9f03269d81f06c6a86926e77620eed4">temp_file</a>=(<span class="keywordtype">char</span> *)strdup(<a class="code" href="locations_8h.html#ac32c047c43e71b12eb9f98e31e134724">DEFAULT_TEMP_FILE</a>);
<a name="l04467"></a>04467         <a class="code" href="checks_8c.html#ac633a7a52422f2b1d56ed02a56dc8fcf">temp_path</a>=(<span class="keywordtype">char</span> *)strdup(<a class="code" href="locations_8h.html#a05c6c6573b136c04627b886ad752d099">DEFAULT_TEMP_PATH</a>);
<a name="l04468"></a>04468         <a class="code" href="checks_8c.html#a3964b0cff6f7740b1f35a62ba0ef0d6a">check_result_path</a>=(<span class="keywordtype">char</span> *)strdup(<a class="code" href="locations_8h.html#a804e2342f97ca9231262175af992d054">DEFAULT_CHECK_RESULT_PATH</a>);
<a name="l04469"></a>04469         <a class="code" href="commands_8c.html#ad6bb81fae52e357701eadd493eca7902">command_file</a>=(<span class="keywordtype">char</span> *)strdup(<a class="code" href="locations_8h.html#a084ad234a008fefd04a08018fc86cc20">DEFAULT_COMMAND_FILE</a>);
<a name="l04470"></a>04470         <a class="code" href="base_2config_8c.html#a55d7cb41b1bacf3965ecc3592b0502fa">lock_file</a>=(<span class="keywordtype">char</span> *)strdup(<a class="code" href="locations_8h.html#ae83c4d08cd4d4358abb77e7d3ef98acd">DEFAULT_LOCK_FILE</a>);
<a name="l04471"></a>04471         <a class="code" href="base_2config_8c.html#a586e23a923f9be00036075adc1134a3a">auth_file</a>=(<span class="keywordtype">char</span> *)strdup(<a class="code" href="locations_8h.html#a68eff085f45f235362c053aef189b259">DEFAULT_AUTH_FILE</a>);
<a name="l04472"></a>04472         <a class="code" href="base_2config_8c.html#a86d006b27636dbe3bc7a35c71883f7c4">p1_file</a>=(<span class="keywordtype">char</span> *)strdup(<a class="code" href="locations_8h.html#aef2380bef4389e60cef6629713f3f708">DEFAULT_P1_FILE</a>);
<a name="l04473"></a>04473         <a class="code" href="base_2config_8c.html#a0cc0c09d24937cc9202b164b490bc8ef">log_archive_path</a>=(<span class="keywordtype">char</span> *)strdup(<a class="code" href="locations_8h.html#a69da112621f4ff1733ff4f8b4a8ae329">DEFAULT_LOG_ARCHIVE_PATH</a>);
<a name="l04474"></a>04474         <a class="code" href="base_2config_8c.html#a4dd633413e09f17ee505abe8699254da">debug_file</a>=(<span class="keywordtype">char</span> *)strdup(<a class="code" href="locations_8h.html#a9744cc6ab8ae8c870f69cb72172d3d9c">DEFAULT_DEBUG_FILE</a>);
<a name="l04475"></a>04475 
<a name="l04476"></a>04476         <a class="code" href="base_2config_8c.html#a05cfb9b76ef2434c8e0ccf88207999a6">nagios_user</a>=(<span class="keywordtype">char</span> *)strdup(<a class="code" href="config_8h.html#a70c066f781c7a7eaf4c9ab27e891a96c">DEFAULT_ICINGA_USER</a>);
<a name="l04477"></a>04477         <a class="code" href="base_2config_8c.html#a18f68ce260b08820f7b519437e84beb4">nagios_group</a>=(<span class="keywordtype">char</span> *)strdup(<a class="code" href="config_8h.html#a7beff9f285f24eb92c2f027776a2a353">DEFAULT_ICINGA_GROUP</a>);
<a name="l04478"></a>04478 
<a name="l04479"></a>04479         <a class="code" href="base_2config_8c.html#acd4edfa8f0c276d1b2913c64811d43b3">use_regexp_matches</a>=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04480"></a>04480         <a class="code" href="base_2config_8c.html#a079c14ca692b31d9a5144cdde9135cff">use_true_regexp_matching</a>=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04481"></a>04481 
<a name="l04482"></a>04482         <a class="code" href="base_2config_8c.html#a39fad10c86b64c04422ec7edec0c100d">use_daemon_log</a>=<a class="code" href="icinga_8h.html#a5263d5e5844688c18f9df61a45aac094">DEFAULT_USE_DAEMON_LOG</a>;
<a name="l04483"></a>04483 
<a name="l04484"></a>04484         <a class="code" href="base_2config_8c.html#ac41cf9c7984d80be911c60382a68cc7f">use_syslog</a>=<a class="code" href="icinga_8h.html#a2738a1370f37cbaaa5e97be6b6679f2b">DEFAULT_USE_SYSLOG</a>;
<a name="l04485"></a>04485         <a class="code" href="base_2config_8c.html#ab88ce77c4fc0820877f3391c14255cf4">use_syslog_local_facility</a>=<a class="code" href="icinga_8h.html#a5dbf9d40b49e19ee57474401ee7e9b63">DEFAULT_USE_SYSLOG_LOCAL_FACILITY</a>;
<a name="l04486"></a>04486         <a class="code" href="base_2config_8c.html#a2da308fe577e0436d8bb3244d7ab3554">syslog_local_facility</a>=<a class="code" href="icinga_8h.html#a7eeb339ca90068aa788e3efe13acce07">DEFAULT_SYSLOG_LOCAL_FACILITY</a>;
<a name="l04487"></a>04487         <a class="code" href="base_2config_8c.html#a8c026debf41f215571837376d674b64e">log_service_retries</a>=<a class="code" href="icinga_8h.html#a6f525acd8d7b1f2bf138b7416ae2fad1">DEFAULT_LOG_SERVICE_RETRIES</a>;
<a name="l04488"></a>04488         <a class="code" href="base_2config_8c.html#a3d94f59d8f5b223150321cc970e4ee95">log_host_retries</a>=<a class="code" href="icinga_8h.html#a49010b8c2f1f69f7eeb2e731d3a12e42">DEFAULT_LOG_HOST_RETRIES</a>;
<a name="l04489"></a>04489         <a class="code" href="checks_8c.html#a978adb7bd99819db24cb71610e211201">log_initial_states</a>=<a class="code" href="icinga_8h.html#a0a2e7fc32b563ccd41d18b2835c76f72">DEFAULT_LOG_INITIAL_STATES</a>;
<a name="l04490"></a>04490 
<a name="l04491"></a>04491         <a class="code" href="base_2config_8c.html#a721e6c51d8206e96123fe584be655b10">log_notifications</a>=<a class="code" href="icinga_8h.html#a463cc659b8cf38144b6e24b697dc48ab">DEFAULT_NOTIFICATION_LOGGING</a>;
<a name="l04492"></a>04492         <a class="code" href="base_2config_8c.html#a259fec0a0e05601985b40c88ecf1da1c">log_event_handlers</a>=<a class="code" href="icinga_8h.html#af3005ee0dd0296a42e8aa359a6c7486f">DEFAULT_LOG_EVENT_HANDLERS</a>;
<a name="l04493"></a>04493         <a class="code" href="commands_8c.html#a4fd5c348c6bd19b33d05d97d921e8f44">log_external_commands</a>=<a class="code" href="icinga_8h.html#a1603573a13280642ddd801a58a21803f">DEFAULT_LOG_EXTERNAL_COMMANDS</a>;
<a name="l04494"></a>04494         <a class="code" href="commands_8c.html#ad0b68c2d5394aea2ad23c94641936dc1">log_external_commands_user</a>=<a class="code" href="icinga_8h.html#a5af5d8078d573bf02bc8fbf097870a8e">DEFAULT_LOG_EXTERNAL_COMMANDS_USER</a>;
<a name="l04495"></a>04495         <a class="code" href="checks_8c.html#a5e7d59bfd5de9be3ca0ab421999029ef">log_passive_checks</a>=<a class="code" href="icinga_8h.html#a7a3c2ad905e2a55ee9948023f792cd50">DEFAULT_LOG_PASSIVE_CHECKS</a>;
<a name="l04496"></a>04496 
<a name="l04497"></a>04497         <a class="code" href="icinga_8c.html#a9abdd763db679f200dcefbfbd3d38dbf">logging_options</a>=<a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a> | <a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a> | <a class="code" href="logging_8h.html#a212443889ead5b70a8b2100040d7e786">NSLOG_VERIFICATION_ERROR</a> | <a class="code" href="logging_8h.html#a92065340c44189598c46f65e43614750">NSLOG_VERIFICATION_WARNING</a> | <a class="code" href="logging_8h.html#a7eeb3698af991d137e2fdcda7b9e41a4">NSLOG_CONFIG_ERROR</a> | <a class="code" href="logging_8h.html#ac877681275faddb76ce603b2a3fd7fe9">NSLOG_CONFIG_WARNING</a> | <a class="code" href="logging_8h.html#a22cc13d1c001b95c6c68386fe98d5b17">NSLOG_PROCESS_INFO</a> | <a class="code" href="logging_8h.html#aefd605c6dd9f6db595d106751124087b">NSLOG_HOST_NOTIFICATION</a> | <a class="code" href="logging_8h.html#aa2a5e296213a1bf14c9ac99ca07ab3af">NSLOG_SERVICE_NOTIFICATION</a> | <a class="code" href="logging_8h.html#a7920ec27b9542287c568e2d2fa316b04">NSLOG_EVENT_HANDLER</a> | <a class="code" href="logging_8h.html#a722c236769cd93a428693bb5c6c1b9b1">NSLOG_EXTERNAL_COMMAND</a> | <a class="code" href="logging_8h.html#aae0d009469c891e6beb069d38efa7a4f">NSLOG_PASSIVE_CHECK</a> | <a class="code" href="logging_8h.html#a1c6ff767d8079391198bcac2e886cae5">NSLOG_HOST_UP</a> | <a class="code" href="logging_8h.html#a21e96bd2a74d21fcc6493646b097fbcd">NSLOG_HOST_DOWN</a> | <a class="code" href="logging_8h.html#a4e7f60c0c0615a4bf80312b584af205d">NSLOG_HOST_UNREACHABLE</a> | <a class="code" href="logging_8h.html#aadf96ffe87162db218fb438549ebcbfc">NSLOG_SERVICE_OK</a> | <a class="code" href="logging_8h.html#a56ee0a2ac663ae96cb1358fee8ab7e2c">NSLOG_SERVICE_WARNING</a> | <a class="code" href="logging_8h.html#a80c60011ffe63d7618a6ab9415d6dc6b">NSLOG_SERVICE_UNKNOWN</a> | <a class="code" href="logging_8h.html#ab7e595974d77a3732088d7d20ebbbce0">NSLOG_SERVICE_CRITICAL</a> | <a class="code" href="logging_8h.html#aea5b3acdc5c306a9e6b9f3e5525f0ca6">NSLOG_INFO_MESSAGE</a>;
<a name="l04498"></a>04498 
<a name="l04499"></a>04499         <a class="code" href="icinga_8c.html#aba97413828a24299cdaebd42dc6a60bb">syslog_options</a>=<a class="code" href="logging_8h.html#a2c8074e3a23c3a04f25029ba2bcdc7fe">NSLOG_RUNTIME_ERROR</a> | <a class="code" href="logging_8h.html#a1c4d11ffaa2f6643a07230bcfa244368">NSLOG_RUNTIME_WARNING</a> | <a class="code" href="logging_8h.html#a212443889ead5b70a8b2100040d7e786">NSLOG_VERIFICATION_ERROR</a> | <a class="code" href="logging_8h.html#a92065340c44189598c46f65e43614750">NSLOG_VERIFICATION_WARNING</a> | <a class="code" href="logging_8h.html#a7eeb3698af991d137e2fdcda7b9e41a4">NSLOG_CONFIG_ERROR</a> | <a class="code" href="logging_8h.html#ac877681275faddb76ce603b2a3fd7fe9">NSLOG_CONFIG_WARNING</a> | <a class="code" href="logging_8h.html#a22cc13d1c001b95c6c68386fe98d5b17">NSLOG_PROCESS_INFO</a> | <a class="code" href="logging_8h.html#aefd605c6dd9f6db595d106751124087b">NSLOG_HOST_NOTIFICATION</a> | <a class="code" href="logging_8h.html#aa2a5e296213a1bf14c9ac99ca07ab3af">NSLOG_SERVICE_NOTIFICATION</a> | <a class="code" href="logging_8h.html#a7920ec27b9542287c568e2d2fa316b04">NSLOG_EVENT_HANDLER</a> | <a class="code" href="logging_8h.html#a722c236769cd93a428693bb5c6c1b9b1">NSLOG_EXTERNAL_COMMAND</a> | <a class="code" href="logging_8h.html#aae0d009469c891e6beb069d38efa7a4f">NSLOG_PASSIVE_CHECK</a> | <a class="code" href="logging_8h.html#a1c6ff767d8079391198bcac2e886cae5">NSLOG_HOST_UP</a> | <a class="code" href="logging_8h.html#a21e96bd2a74d21fcc6493646b097fbcd">NSLOG_HOST_DOWN</a> | <a class="code" href="logging_8h.html#a4e7f60c0c0615a4bf80312b584af205d">NSLOG_HOST_UNREACHABLE</a> | <a class="code" href="logging_8h.html#aadf96ffe87162db218fb438549ebcbfc">NSLOG_SERVICE_OK</a> | <a class="code" href="logging_8h.html#a56ee0a2ac663ae96cb1358fee8ab7e2c">NSLOG_SERVICE_WARNING</a> | <a class="code" href="logging_8h.html#a80c60011ffe63d7618a6ab9415d6dc6b">NSLOG_SERVICE_UNKNOWN</a> | <a class="code" href="logging_8h.html#ab7e595974d77a3732088d7d20ebbbce0">NSLOG_SERVICE_CRITICAL</a> | <a class="code" href="logging_8h.html#aea5b3acdc5c306a9e6b9f3e5525f0ca6">NSLOG_INFO_MESSAGE</a>;
<a name="l04500"></a>04500 
<a name="l04501"></a>04501         <a class="code" href="checks_8c.html#aae037924192ae115d84c3aa5c42502db">service_check_timeout</a>=<a class="code" href="icinga_8h.html#a3ddc55c57bd34c6410ac2498a190071d">DEFAULT_SERVICE_CHECK_TIMEOUT</a>;
<a name="l04502"></a>04502         <a class="code" href="checks_8c.html#a57a8709265e39d9953db6dd65bfc0796">host_check_timeout</a>=<a class="code" href="icinga_8h.html#a282903df0c0002dd4f5dbd2624eb9b63">DEFAULT_HOST_CHECK_TIMEOUT</a>;
<a name="l04503"></a>04503         <a class="code" href="base_2config_8c.html#acf7e0ac7c504daebb951029d2595dfc3">event_handler_timeout</a>=<a class="code" href="icinga_8h.html#a68205dcdda9e32da848f862cab0407ec">DEFAULT_EVENT_HANDLER_TIMEOUT</a>;
<a name="l04504"></a>04504         <a class="code" href="base_2config_8c.html#ae8619a981efc4b705bce98f0b6eccd54">notification_timeout</a>=<a class="code" href="icinga_8h.html#a6b5ac6cf75a887ae229822b18734f402">DEFAULT_NOTIFICATION_TIMEOUT</a>;
<a name="l04505"></a>04505         <a class="code" href="base_2config_8c.html#a6637dcc9d4238294cbb0cc87702ffee8">ocsp_timeout</a>=<a class="code" href="icinga_8h.html#ada8b22658c3c3fd33e3404f6b07f8d99">DEFAULT_OCSP_TIMEOUT</a>;
<a name="l04506"></a>04506         <a class="code" href="base_2config_8c.html#ad8fd89e4c976ac03482bb7133b71a030">ochp_timeout</a>=<a class="code" href="icinga_8h.html#a166c9d87baaddd7a9f949a245d4621d1">DEFAULT_OCHP_TIMEOUT</a>;
<a name="l04507"></a>04507 
<a name="l04508"></a>04508         <a class="code" href="base_2config_8c.html#a922b1acd3bbab55cc1a1fba869a52cf3">sleep_time</a>=<a class="code" href="icinga_8h.html#a2acb9229ec569e091a13ab26bacf5c6b">DEFAULT_SLEEP_TIME</a>;
<a name="l04509"></a>04509         <a class="code" href="checks_8c.html#a8847f14f41ae11b1333c040051efbe9b">interval_length</a>=<a class="code" href="icinga_8h.html#a99634e187d267c88f565b9c9a5b46ce3">DEFAULT_INTERVAL_LENGTH</a>;
<a name="l04510"></a>04510         <a class="code" href="base_2config_8c.html#acd946f8db9b1c8bb876f807958a67158">service_inter_check_delay_method</a>=<a class="code" href="icinga_8h.html#a3dfb955ec833e475043a276f96ab467c">ICD_SMART</a>;
<a name="l04511"></a>04511         <a class="code" href="base_2config_8c.html#a4a5e0c1bc20f9b50c89e9a45a6b7dd32">host_inter_check_delay_method</a>=<a class="code" href="icinga_8h.html#a3dfb955ec833e475043a276f96ab467c">ICD_SMART</a>;
<a name="l04512"></a>04512         <a class="code" href="base_2config_8c.html#ae51089c18962e9d01b6d86beb51d3a86">service_interleave_factor_method</a>=<a class="code" href="icinga_8h.html#ab87a22c4a28d339e50f7565969674f01">ILF_SMART</a>;
<a name="l04513"></a>04513         <a class="code" href="checks_8c.html#a13c7e7d13d812c96e312c5f7ee893a66">max_service_check_spread</a>=<a class="code" href="icinga_8h.html#a1a5bbf01e1e6d463499fcf6460ca611d">DEFAULT_SERVICE_CHECK_SPREAD</a>;
<a name="l04514"></a>04514         <a class="code" href="checks_8c.html#a6c91e39bfb52d983e8a77a70698f147e">max_host_check_spread</a>=<a class="code" href="icinga_8h.html#a4d89450467b9cc827d14f13330ddd1c5">DEFAULT_HOST_CHECK_SPREAD</a>;
<a name="l04515"></a>04515 
<a name="l04516"></a>04516         <a class="code" href="checks_8c.html#a8f8fcb1a4bb32b1c5fa753ac9cb48578">use_aggressive_host_checking</a>=<a class="code" href="icinga_8h.html#a08686f5dcf3866b27af311772f5cacf2">DEFAULT_AGGRESSIVE_HOST_CHECKING</a>;
<a name="l04517"></a>04517         <a class="code" href="checks_8c.html#a55fd26f1da3fea26b41e92a035472ea2">cached_host_check_horizon</a>=<a class="code" href="icinga_8h.html#afdf74f35c97ac8bbf231a45d20ae6dca">DEFAULT_CACHED_HOST_CHECK_HORIZON</a>;
<a name="l04518"></a>04518         <a class="code" href="checks_8c.html#a63020ec01859a9c631414e69dd951b5d">cached_service_check_horizon</a>=<a class="code" href="icinga_8h.html#acb982f4c1818c267dd5f82eb31d61670">DEFAULT_CACHED_SERVICE_CHECK_HORIZON</a>;
<a name="l04519"></a>04519         <a class="code" href="checks_8c.html#ad658f0152df44d67fd5fe012fc1faf3f">enable_predictive_host_dependency_checks</a>=<a class="code" href="icinga_8h.html#ae21e76772bc06053bd6adcf41138e91d">DEFAULT_ENABLE_PREDICTIVE_HOST_DEPENDENCY_CHECKS</a>;
<a name="l04520"></a>04520         <a class="code" href="checks_8c.html#afb630146760296e213a019a7f14f48f3">enable_predictive_service_dependency_checks</a>=<a class="code" href="icinga_8h.html#add4c37ca24b66e7caf8911bfd5f94d70">DEFAULT_ENABLE_PREDICTIVE_SERVICE_DEPENDENCY_CHECKS</a>;
<a name="l04521"></a>04521 
<a name="l04522"></a>04522         <a class="code" href="checks_8c.html#a7c9ecd6259817de56ca91f1adaaea842">soft_state_dependencies</a>=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04523"></a>04523 
<a name="l04524"></a>04524         <a class="code" href="base_2config_8c.html#a66929a60ac22bcaaa279ded5c2c6eb9a">retain_state_information</a>=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04525"></a>04525         <a class="code" href="base_2config_8c.html#a1043c5f5292784386c9aab188c743c5a">retention_update_interval</a>=<a class="code" href="icinga_8h.html#a80686ddfc4458cf9d70fb83b5e0355be">DEFAULT_RETENTION_UPDATE_INTERVAL</a>;
<a name="l04526"></a>04526         <a class="code" href="base_2config_8c.html#aced0c5bbed1bb4b772f105b4f2988bb6">use_retained_program_state</a>=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04527"></a>04527         <a class="code" href="base_2config_8c.html#a1eaa6a870e346de62067378dc1d6137d">use_retained_scheduling_info</a>=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04528"></a>04528         <a class="code" href="base_2config_8c.html#a2a4d71e3630882927484ec3b5c060729">retention_scheduling_horizon</a>=<a class="code" href="icinga_8h.html#a28bcf1b1f4a9de9b3c8487d9e1d7206d">DEFAULT_RETENTION_SCHEDULING_HORIZON</a>;
<a name="l04529"></a>04529         <a class="code" href="broker_8c.html#a786e354f5a91ca30fe28ede97505e181">modified_host_process_attributes</a>=<a class="code" href="include_2common_8h.html#ae8fbea4e11e41dd7254fa0938f78e23a">MODATTR_NONE</a>;
<a name="l04530"></a>04530         <a class="code" href="broker_8c.html#aa128280b704d982e64c50a9427cf5f71">modified_service_process_attributes</a>=<a class="code" href="include_2common_8h.html#ae8fbea4e11e41dd7254fa0938f78e23a">MODATTR_NONE</a>;
<a name="l04531"></a>04531         <a class="code" href="base_2config_8c.html#a899e484813a8be290aa2f240a1209748">retained_host_attribute_mask</a>=0L;
<a name="l04532"></a>04532         <a class="code" href="base_2config_8c.html#a226294b0bafb951e4895f0e030ea92b4">retained_service_attribute_mask</a>=0L;
<a name="l04533"></a>04533         <a class="code" href="base_2config_8c.html#a9cf78112bcff73f4ac5913a2a6a2fee4">retained_process_host_attribute_mask</a>=0L;
<a name="l04534"></a>04534         <a class="code" href="base_2config_8c.html#a3942846d40cc9545a1d0f042733e0943">retained_process_service_attribute_mask</a>=0L;
<a name="l04535"></a>04535         <a class="code" href="base_2config_8c.html#a99d719730540007a974ab1aaa84074b4">retained_contact_host_attribute_mask</a>=0L;
<a name="l04536"></a>04536         <a class="code" href="base_2config_8c.html#ab7d4cf16bedd8d688e2a49d99364fbb8">retained_contact_service_attribute_mask</a>=0L;
<a name="l04537"></a>04537 
<a name="l04538"></a>04538         <a class="code" href="checks_8c.html#a7efed83b6f6698f73e4ede444065917c">command_check_interval</a>=<a class="code" href="icinga_8h.html#a96d498191672010172f75cd6409b4052">DEFAULT_COMMAND_CHECK_INTERVAL</a>;
<a name="l04539"></a>04539         <a class="code" href="checks_8c.html#af5316c1b7ca4d4261fb4edc45cafcca2">check_reaper_interval</a>=<a class="code" href="icinga_8h.html#ab6f107fd346e248f8c561926ef80f9fa">DEFAULT_CHECK_REAPER_INTERVAL</a>;
<a name="l04540"></a>04540         <a class="code" href="checks_8c.html#aec4c41d4a0f2abb5ccb88695fa1a7afd">max_check_reaper_time</a>=<a class="code" href="icinga_8h.html#a88ebe8d4206b4a6e9414c6e2708892a1">DEFAULT_MAX_REAPER_TIME</a>;
<a name="l04541"></a>04541         <a class="code" href="base_2config_8c.html#a339144b840e81ab177c4c80178da7470">max_check_result_file_age</a>=<a class="code" href="icinga_8h.html#a53916a704d0ba8180afc33897e69aa02">DEFAULT_MAX_CHECK_RESULT_AGE</a>;
<a name="l04542"></a>04542         <a class="code" href="base_2config_8c.html#abab6f0cb75ffb3f8314a91eb45daff73">service_freshness_check_interval</a>=<a class="code" href="icinga_8h.html#a81fda84a5d702fcc3fed186c6aaac151">DEFAULT_FRESHNESS_CHECK_INTERVAL</a>;
<a name="l04543"></a>04543         <a class="code" href="base_2config_8c.html#ad3e63ef3ddf9da6b5129e4af48050e57">host_freshness_check_interval</a>=<a class="code" href="icinga_8h.html#a81fda84a5d702fcc3fed186c6aaac151">DEFAULT_FRESHNESS_CHECK_INTERVAL</a>;
<a name="l04544"></a>04544         <a class="code" href="base_2config_8c.html#a44cbf83f13ce339bea20c45e1b6ddef4">auto_rescheduling_interval</a>=<a class="code" href="icinga_8h.html#a7bbd3ba9e616fccce3365651be304479">DEFAULT_AUTO_RESCHEDULING_INTERVAL</a>;
<a name="l04545"></a>04545         <a class="code" href="base_2config_8c.html#a7faf812fb9197efcc5f55b028269fc15">auto_rescheduling_window</a>=<a class="code" href="icinga_8h.html#a48e0e58797aebf7d3b0d25cd77942566">DEFAULT_AUTO_RESCHEDULING_WINDOW</a>;
<a name="l04546"></a>04546 
<a name="l04547"></a>04547         <a class="code" href="commands_8c.html#abf64fe29cddb0d890bbece7d4d970c18">check_external_commands</a>=<a class="code" href="icinga_8h.html#a8653235dc43fffe9cf5252546437ab92">DEFAULT_CHECK_EXTERNAL_COMMANDS</a>;
<a name="l04548"></a>04548         <a class="code" href="base_2config_8c.html#a3e061975c062d8fa45e1da8f605b1f1b">check_orphaned_services</a>=<a class="code" href="icinga_8h.html#acb3744f9e7874aba35c8c0e3ba4191a7">DEFAULT_CHECK_ORPHANED_SERVICES</a>;
<a name="l04549"></a>04549         <a class="code" href="base_2config_8c.html#a168ff4c02e76f18767e941ecc2d3279c">check_orphaned_hosts</a>=<a class="code" href="icinga_8h.html#a7f0c199390e8e5479bb9fc8ab89b728b">DEFAULT_CHECK_ORPHANED_HOSTS</a>;
<a name="l04550"></a>04550         <a class="code" href="checks_8c.html#a2361e9b42a0ea220db317dff75dc9dc0">check_service_freshness</a>=<a class="code" href="icinga_8h.html#aeaf3a5046b5d20873dd0f0fcc8866447">DEFAULT_CHECK_SERVICE_FRESHNESS</a>;
<a name="l04551"></a>04551         <a class="code" href="checks_8c.html#a4f92c0b0b8d9f56191bcdf5dc5a706b2">check_host_freshness</a>=<a class="code" href="icinga_8h.html#a80daa6fe7f87904ca43f4411c95ac6b4">DEFAULT_CHECK_HOST_FRESHNESS</a>;
<a name="l04552"></a>04552         <a class="code" href="base_2config_8c.html#a92449527b62f5217e54424e9180a90d2">auto_reschedule_checks</a>=<a class="code" href="icinga_8h.html#a571ff24db2c4066997a0322efe329e94">DEFAULT_AUTO_RESCHEDULE_CHECKS</a>;
<a name="l04553"></a>04553 
<a name="l04554"></a>04554         <a class="code" href="base_2config_8c.html#ab994c46c876a9f9f338e28c170dd3e4e">log_rotation_method</a>=<a class="code" href="include_2common_8h.html#a22bcdf7bd0cb55f723ebe1b61e56d0f2">LOG_ROTATION_NONE</a>;
<a name="l04555"></a>04555 
<a name="l04556"></a>04556         <a class="code" href="broker_8c.html#aeb85ffd1c5c7f91fe9ccb3e4f58584a2">last_command_check</a>=0L;
<a name="l04557"></a>04557         <a class="code" href="commands_8c.html#a3345a3ba93555dc1bd4405d8a9db19e8">last_command_status_update</a>=0L;
<a name="l04558"></a>04558         <a class="code" href="broker_8c.html#aa087a80bdb1191f94e86f0a83d5c2eed">last_log_rotation</a>=0L;
<a name="l04559"></a>04559 
<a name="l04560"></a>04560         <a class="code" href="base_2config_8c.html#a46b9282388870ec482000ee3834f847d">max_parallel_service_checks</a>=<a class="code" href="icinga_8h.html#a5b623db4a3c6068b7b9f7542035b901b">DEFAULT_MAX_PARALLEL_SERVICE_CHECKS</a>;
<a name="l04561"></a>04561         <a class="code" href="checks_8c.html#a01f1a65871aff67ece2c26f543691083">currently_running_service_checks</a>=0;
<a name="l04562"></a>04562 
<a name="l04563"></a>04563         <a class="code" href="broker_8c.html#aeab76c66fa95f6b3a22143bade01cbe9">enable_notifications</a>=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04564"></a>04564         <a class="code" href="broker_8c.html#ab7c771c65ac24bc0d04ddae988128f8a">execute_service_checks</a>=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04565"></a>04565         <a class="code" href="broker_8c.html#ac2cfe61062d4e6db6236a829ee16864a">accept_passive_service_checks</a>=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04566"></a>04566         <a class="code" href="broker_8c.html#af4ed1772a5decb43a2711b6d560a0737">execute_host_checks</a>=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04567"></a>04567         <a class="code" href="broker_8c.html#ac2cfe61062d4e6db6236a829ee16864a">accept_passive_service_checks</a>=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04568"></a>04568         <a class="code" href="broker_8c.html#adf8bd6fb1b3fc3cf7750d887773feace">enable_event_handlers</a>=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04569"></a>04569         <a class="code" href="broker_8c.html#a03e994eebc8f1e065991e7f8994a7059">obsess_over_services</a>=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04570"></a>04570         <a class="code" href="broker_8c.html#a879982dc6cb9e3e1e23c49eba4f7bc12">obsess_over_hosts</a>=<a class="code" href="include_2common_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04571"></a>04571         <a class="code" href="broker_8c.html#ad9af8e808ce1df2c763d260502b58e4c">enable_failure_prediction</a>=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04572"></a>04572 
<a name="l04573"></a>04573         <a class="code" href="icinga_8c.html#a7c6764a5ab4c86e19f5c6727b9ee974d">next_comment_id</a>=0L;  <span class="comment">/* comment and downtime id get initialized to nonzero elsewhere */</span>
<a name="l04574"></a>04574         <a class="code" href="icinga_8c.html#ac1079538ca861064140e0c8daa032ace">next_downtime_id</a>=0L;
<a name="l04575"></a>04575         <a class="code" href="checks_8c.html#a75ecfdc2a9af9431daf6d862bc9ab9cc">next_event_id</a>=1;
<a name="l04576"></a>04576         <a class="code" href="icinga_8c.html#a220de5d08cd9e05a26be2549fce2a638">next_notification_id</a>=1;
<a name="l04577"></a>04577 
<a name="l04578"></a>04578         <a class="code" href="broker_8c.html#a9586ccf6845ee26a92ae931feb52a467">aggregate_status_updates</a>=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04579"></a>04579         <a class="code" href="base_2config_8c.html#a0bf1c35db9cc1c250c958f12db3373b8">status_update_interval</a>=<a class="code" href="icinga_8h.html#a16cb2fefbe705ad2f07ccb15bec00b51">DEFAULT_STATUS_UPDATE_INTERVAL</a>;
<a name="l04580"></a>04580 
<a name="l04581"></a>04581         <a class="code" href="broker_8c.html#a6dd9e21f0c5cd86be9c0bb8575387430">event_broker_options</a>=<a class="code" href="broker_8h.html#a6aa8d080e26ec5698c514b2ed46a3d34">BROKER_NOTHING</a>;
<a name="l04582"></a>04582 
<a name="l04583"></a>04583         <a class="code" href="base_2config_8c.html#a4dbfc5ebd719a4bca93b043f39a5750a">time_change_threshold</a>=<a class="code" href="icinga_8h.html#a841899e26d5f960989322021de9202c0">DEFAULT_TIME_CHANGE_THRESHOLD</a>;
<a name="l04584"></a>04584 
<a name="l04585"></a>04585         <a class="code" href="broker_8c.html#a2dff02e57dcb9656ac523b8f6d548ee4">enable_flap_detection</a>=<a class="code" href="icinga_8h.html#a0c03e3af117e482574b08c74263fadf9">DEFAULT_ENABLE_FLAP_DETECTION</a>;
<a name="l04586"></a>04586         <a class="code" href="base_2config_8c.html#a14a94d5f46c0a28d726d9413a26fca28">low_service_flap_threshold</a>=<a class="code" href="icinga_8h.html#a627a467f917a5d3826a92a74ba77e62f">DEFAULT_LOW_SERVICE_FLAP_THRESHOLD</a>;
<a name="l04587"></a>04587         <a class="code" href="base_2config_8c.html#aaff51075d28f9df1c11fbc396b947652">high_service_flap_threshold</a>=<a class="code" href="icinga_8h.html#ab24bbbc61ee2394381ed55e8e156a58a">DEFAULT_HIGH_SERVICE_FLAP_THRESHOLD</a>;
<a name="l04588"></a>04588         <a class="code" href="base_2config_8c.html#aa9db7a3c64eac4aac4f7631a0472c63c">low_host_flap_threshold</a>=<a class="code" href="icinga_8h.html#aa2176cdc7e3c3ebb0da484771e142e22">DEFAULT_LOW_HOST_FLAP_THRESHOLD</a>;
<a name="l04589"></a>04589         <a class="code" href="base_2config_8c.html#a1d9ea93bade3c2b490b2270823eec560">high_host_flap_threshold</a>=<a class="code" href="icinga_8h.html#aa9a0a33f25a69af486f804441838b79f">DEFAULT_HIGH_HOST_FLAP_THRESHOLD</a>;
<a name="l04590"></a>04590 
<a name="l04591"></a>04591         <a class="code" href="broker_8c.html#a3cef48503f834db51896cd2262c4ddbd">process_performance_data</a>=<a class="code" href="icinga_8h.html#a5e3fb0a59c4af70847abd8d9b68c3984">DEFAULT_PROCESS_PERFORMANCE_DATA</a>;
<a name="l04592"></a>04592 
<a name="l04593"></a>04593         <a class="code" href="checks_8c.html#aeef0f20f58de2ac8a2db469fdc767b6f">translate_passive_host_checks</a>=<a class="code" href="icinga_8h.html#a149a58156300d91c01865ebb14a47cf6">DEFAULT_TRANSLATE_PASSIVE_HOST_CHECKS</a>;
<a name="l04594"></a>04594         <a class="code" href="checks_8c.html#a90011bddac350082a4ab3b13758afcbe">passive_host_checks_are_soft</a>=<a class="code" href="icinga_8h.html#ace9a965f9d006b38d574caeaa63f6804">DEFAULT_PASSIVE_HOST_CHECKS_SOFT</a>;
<a name="l04595"></a>04595 
<a name="l04596"></a>04596         <a class="code" href="checks_8c.html#af7ebc1e3e652fbcaed250840df2ccba2">use_large_installation_tweaks</a>=<a class="code" href="icinga_8h.html#a08503127e7b3bda4aaf1596be92b7239">DEFAULT_USE_LARGE_INSTALLATION_TWEAKS</a>;
<a name="l04597"></a>04597         <a class="code" href="base_2config_8c.html#a11317c78b1d2431ae9b6ac57a40e3095">enable_environment_macros</a>=<a class="code" href="include_2common_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04598"></a>04598         <a class="code" href="checks_8c.html#a73881c51ba02b6ea241ab71a8e2c354c">free_child_process_memory</a>=-1;
<a name="l04599"></a>04599         <a class="code" href="checks_8c.html#a2976ddc6ad4325c074912d0f61bb0184">child_processes_fork_twice</a>=-1;
<a name="l04600"></a>04600 
<a name="l04601"></a>04601         <a class="code" href="checks_8c.html#ab5dcf3b2f001760548fd0d0fab5c2cd7">additional_freshness_latency</a>=<a class="code" href="icinga_8h.html#ae0cb7d1669e03d6cd567ac553022547e">DEFAULT_ADDITIONAL_FRESHNESS_LATENCY</a>;
<a name="l04602"></a>04602 
<a name="l04603"></a>04603         <a class="code" href="base_2config_8c.html#a46fa3066353e093f0726ffb3cf9dd151">enable_embedded_perl</a>=<a class="code" href="icinga_8h.html#aa84e93dcb432b4e57d1d49618cd4f6a8">DEFAULT_ENABLE_EMBEDDED_PERL</a>;
<a name="l04604"></a>04604         <a class="code" href="base_2config_8c.html#a422c10fc8a317232590a568d58e0562e">use_embedded_perl_implicitly</a>=<a class="code" href="icinga_8h.html#a2eb0997aaad25f6a91a26f6acf0c53ec">DEFAULT_USE_EMBEDDED_PERL_IMPLICITLY</a>;
<a name="l04605"></a>04605 
<a name="l04606"></a>04606         <a class="code" href="checks_8c.html#ae96ccc43c200c07e833891d2b6ca8bba">stalking_event_handlers_for_hosts</a>=<a class="code" href="icinga_8h.html#a72519fb988562bb021ca6c0a48cbae78">DEFAULT_STALKING_EVENT_HANDLERS_FOR_HOSTS</a>;
<a name="l04607"></a>04607         <a class="code" href="checks_8c.html#a4113366f27b640f3e76ecef1b7ba9809">stalking_event_handlers_for_services</a>=<a class="code" href="icinga_8h.html#ac06ec6e7cc0415f5731b193b1321a380">DEFAULT_STALKING_EVENT_HANDLERS_FOR_SERVICES</a>;
<a name="l04608"></a>04608 
<a name="l04609"></a>04609         <a class="code" href="commands_8c.html#aa9e89558ebe0496997935aca44cc0123">external_command_buffer_slots</a>=<a class="code" href="icinga_8h.html#ac334e31a6c3b1182e60b74905288f7b3">DEFAULT_EXTERNAL_COMMAND_BUFFER_SLOTS</a>;
<a name="l04610"></a>04610 
<a name="l04611"></a>04611         <a class="code" href="base_2config_8c.html#a6a7850ecbb72e1e42b73aefa00562183">debug_level</a>=<a class="code" href="icinga_8h.html#a18da678808a23365d00c58cdae11e29e">DEFAULT_DEBUG_LEVEL</a>;
<a name="l04612"></a>04612         <a class="code" href="base_2config_8c.html#a34a87268f6423660b89263430f5f776c">debug_verbosity</a>=<a class="code" href="icinga_8h.html#a58eafed6db11bb59dd14a48d27f1c350">DEFAULT_DEBUG_VERBOSITY</a>;
<a name="l04613"></a>04613         <a class="code" href="checks_8c.html#ac919486c0bf77cab5e1ec2f0aba1803f">max_debug_file_size</a>=<a class="code" href="icinga_8h.html#a1b4a7d421150633227ab66a5f09a2a18">DEFAULT_MAX_DEBUG_FILE_SIZE</a>;
<a name="l04614"></a>04614 
<a name="l04615"></a>04615         <a class="code" href="base_2config_8c.html#a724a2263d444550e456b32059ab08c00">date_format</a>=<a class="code" href="include_2common_8h.html#a323051ab0cb9928ee59692e3e23040d4">DATE_FORMAT_US</a>;
<a name="l04616"></a>04616 
<a name="l04617"></a>04617         <span class="comment">/* initialize macros */</span>
<a name="l04618"></a>04618         <a class="code" href="macros_8c.html#a7f020cedfb59ea31b37eb4b52a12934c">init_macros</a>();
<a name="l04619"></a>04619 
<a name="l04620"></a>04620         <a class="code" href="broker_8c.html#a2cd88e2da654d6d1d2c52e79d0174109">global_host_event_handler</a>=NULL;
<a name="l04621"></a>04621         <a class="code" href="broker_8c.html#a0073f89db72fa9c3474b5a1327382784">global_service_event_handler</a>=NULL;
<a name="l04622"></a>04622         global_host_event_handler_ptr=NULL;
<a name="l04623"></a>04623         global_service_event_handler_ptr=NULL;
<a name="l04624"></a>04624 
<a name="l04625"></a>04625         <a class="code" href="base_2config_8c.html#a00f19e2546f0f60b11d12685571c3184">ocsp_command</a>=NULL;
<a name="l04626"></a>04626         <a class="code" href="base_2config_8c.html#a2941a8b9d15b20828dbc065543e6854a">ochp_command</a>=NULL;
<a name="l04627"></a>04627         ocsp_command_ptr=NULL;
<a name="l04628"></a>04628         ochp_command_ptr=NULL;
<a name="l04629"></a>04629 
<a name="l04630"></a>04630         <span class="comment">/* reset umask */</span>
<a name="l04631"></a>04631         umask(S_IWGRP|S_IWOTH);
<a name="l04632"></a>04632 
<a name="l04633"></a>04633         <span class="keywordflow">return</span> <a class="code" href="include_2common_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l04634"></a>04634         }
<a name="l04635"></a>04635 
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="base_2utils_8c.html">utils.c</a>      </li>
      <li class="footer">Generated on Tue May 3 2011 22:33:38 for Icinga-core by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


</body>
</html>
